var Zh=Object.defineProperty;var wu=e=>{throw TypeError(e)};var em=(e,t,r)=>t in e?Zh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var Ra=(e,t,r)=>em(e,typeof t!="symbol"?t+"":t,r),_u=(e,t,r)=>t.has(e)||wu("Cannot "+r);var z=(e,t,r)=>(_u(e,t,"read from private field"),r?r.call(e):t.get(e)),Le=(e,t,r)=>t.has(e)?wu("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),Te=(e,t,r,n)=>(_u(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);function Si(e){"@babel/helpers - typeof";return Si=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Si(e)}function tm(e,t){if(Si(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(Si(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function rm(e){var t=tm(e,"string");return Si(t)=="symbol"?t:t+""}function nm(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,rm(n.key),n)}}function Lr(e,t,r){return t&&nm(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function im(e){return e[e.length-1]}function ic(e){return Array.isArray(e)?e.slice(0):[e]}function am(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Ga(e){return Array.isArray(e)}function cs(e,t){var r=0,n=-1;for(var i of e){n=n+1;var o=t(i,n);if(o)r=r+1;else break}return r}function cn(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var i=0;i<r;++i)e[n+i]=t[i]}}function om(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Rr(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function ar(e,t){var r=t?Rr(t._rev)+1:1;return r+"-"+e}function sm(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var i=n,o=0;o<r;++o){var c=t[o];if(i=i[c],typeof i>"u")return i}return i}}function Ie(e){return Object.assign({},e)}function cm(e){return Object.keys(e)[0]}function Ya(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,i)=>typeof n=="string"&&typeof i=="string"?n.localeCompare(i):typeof n=="object"?1:-1).map(n=>Ya(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,i)=>n.localeCompare(i)).forEach(n=>{r[n]=Ya(e[n],t)}),r}return e}function Ps(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=Ps(e[r]);return t}var n={};for(var i in e)n[i]=Ps(e[i]);return n}var tt=Ps;function tr(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var ac=1;function Qn(){return{lwt:ac}}function Lt(){return""}function um(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function lm(e,t,r){if(t.length!==r.length)return!1;for(var n=0,i=t.length;n<i;){var o=t[n],c=r[n];if(n++,o._rev!==c._rev||o[e]!==c[e])return!1}return!0}async function fm(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),i=>("00"+i.toString(16)).slice(-2)).join("");return n}var jl=fm;function dm(){return new Promise(e=>setTimeout(e,0))}function hm(e=0){return new Promise(t=>setTimeout(t,e))}function mm(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var pm=Promise.resolve(!0),or=Promise.resolve(!1),oc=Promise.resolve(null),It=Promise.resolve();function fo(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):hm(0)}var us=It;function vm(e=void 0){return us=us.then(()=>fo(e)),us}function ym(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var gm=/\./g,Eu="abcdefghijklmnopqrstuvwxyz";function Ui(e=10){for(var t="",r=0;r<e;r++)t+=Eu.charAt(Math.floor(Math.random()*Eu.length));return t}function ql(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function mi(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function xi(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!xi(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var i=Object.keys(e);if(r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var o=i[n];if(!xi(e[o],t[o]))return!1}return!0}return e!==e&&t!==t}var Rs=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},ls=new Set(["__proto__","prototype","constructor"]),bm=new Set("0123456789");function Fl(e){var t=[],r="",n="start",i=!1;for(var o of e)switch(o){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");i&&(r+=o),n="property",i=!i;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(i){i=!1,r+=o;break}if(ls.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(i){i=!1,r+=o;break}if(n==="property"){if(ls.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!bm.has(o))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),i&&(i=!1,r+="\\"),r+=o}}switch(i&&(r+="\\"),n){case"property":{if(ls.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function Kl(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function wm(e,t){if(Kl(e,t))throw new Error("Cannot use string index")}function Mr(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!Rs(e)||typeof t!="string")return r===void 0?e:r;var n=Fl(t);if(n.length===0)return r;for(var i=0;i<n.length;i++){var o=n[i];if(Kl(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function Hl(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!Rs(e)||typeof t!="string")return e;for(var n=e,i=Fl(t),o=0;o<i.length;o++){var c=i[o];wm(e,c),o===i.length-1?e[c]=r:Rs(e[c])||(e[c]=typeof i[o+1]=="number"?[]:{}),e=e[c]}return n}function Bn(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function Tt(e,t,r,n){var i=e.get(t);return typeof i>"u"&&(i=r(),e.set(t,i)),i}function we(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=ql(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function _m(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var fs=0;function mt(){var e=Date.now();e=e+.01,e<=fs&&(e=fs+.01);var t=parseFloat(e.toFixed(2));return fs=t,t}function oe(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var Wi={bufferSize:1,refCount:!0},Ul="16.11.0",ds={},Em="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",Su=16,hs=or,xu=!1;async function Wl(){return xu||(xu=!0,hs=(async()=>!!(ds.premium&&typeof ds.premium=="string"&&await jl(ds.premium)===Em))()),hs}function ki(e,t){return ki=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},ki(e,t)}function sc(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ki(e,t)}function Ms(e){return Ms=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Ms(e)}function Sm(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function zl(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(zl=function(){return!!e})()}function xm(e,t,r){if(zl())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&ki(i,r.prototype),i}function Ja(e){var t=typeof Map=="function"?new Map:void 0;return Ja=function(n){if(n===null||!Sm(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,i)}function i(){return xm(n,arguments,Ms(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),ki(i,n)},Ja(e)}var ye={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return`
        RxDB Error-Code: `+e+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function km(e){var t="";return Object.keys(e).length===0||(t+="-".repeat(20)+`
`,t+=`Parameters:
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(i=>JSON.stringify(i,Object.getOwnPropertyNames(i))):n=JSON.stringify(e[r],function(i,o){return o===void 0?null:o},2)}catch{}return r+": "+n}).join(`
`),t+=`
`),t}function Vl(e,t,r){return`
`+e+`
`+km(r)}var Im=function(e){function t(n,i,o={}){var c,l=Vl(i,n,o);return c=e.call(this,l)||this,c.code=n,c.message=l,c.url=cc(n),c.parameters=o,c.rxdb=!0,c}sc(t,e);var r=t.prototype;return r.toString=function(){return this.message},Lr(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(Ja(Error)),Dm=function(e){function t(n,i,o={}){var c,l=Vl(i,n,o);return c=e.call(this,l)||this,c.code=n,c.message=l,c.url=cc(n),c.parameters=o,c.rxdb=!0,c}sc(t,e);var r=t.prototype;return r.toString=function(){return this.message},Lr(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])}(Ja(TypeError));function cc(e){return"https://rxdb.info/errors.html?console=errors#"+e}function Ql(e){return`
Find out more about this error here: `+cc(e)+` 
`}function Y(e,t){return new Im(e,ye.tunnelErrorMessage(e)+Ql(e),t)}function xt(e,t){return new Dm(e,ye.tunnelErrorMessage(e)+Ql(e),t)}function ho(e){return e&&e.status===409?e:!1}var Cm={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function Gl(e){return Y("COL20",{name:Cm[e.status],document:e.documentId,writeError:e})}var Ii={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function at(e,t){Ii[e].length>0&&Ii[e].forEach(r=>r(t))}async function zi(e,t){for(var r of Ii[e])await r(t)}function Nn(e,t){var r=t;r=r.replace(gm,".properties."),r="properties."+r,r=mi(r);var n=Mr(e,r);return n}function Om(e,t,r){if(typeof t.primaryKey=="string")return r;var n=dn(t,r),i=r[e];if(i&&i!==n)throw Y("DOC19",{args:{documentData:r,existingPrimary:i,newPrimary:n},schema:t});return r[e]=n,r}function pt(e){return typeof e=="string"?e:e.key}function Pm(e){var t=pt(e.primaryKey),r=Nn(e,t);return oe(r.maxLength)}function dn(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var i=Mr(t,n);if(typeof i>"u")throw Y("DOC18",{args:{field:n,documentData:t}});return i}).join(r.separator)}function Rm(e){var t=Ya(e,!0);return t}function Mm(e){return["_deleted",e]}function mo(e){e=Ie(e);var t=pt(e.primaryKey);e.properties=Ie(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=Lm,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=Yl(e);cn(e.required,r),e.required=e.required.filter(o=>!o.includes(".")).filter((o,c,l)=>l.indexOf(o)===c),e.version=e.version||0;var n=e.indexes.map(o=>{var c=Ga(o)?o.slice(0):[o];return c.includes(t)||c.push(t),c[0]!=="_deleted"&&c.unshift("_deleted"),c});n.length===0&&n.push(Mm(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(o=>{n.push(o)});var i=new Set;return n.filter(o=>{var c=o.join(",");return i.has(c)?!1:(i.add(c),!0)}),e.indexes=n,e}var Lm={type:"object",properties:{lwt:{type:"number",minimum:ac,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Yl(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=pt(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function Tm(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var i=r[n];(!Object.prototype.hasOwnProperty.call(t,i)||typeof t[i]>"u")&&(t[i]=e.defaultValues[i])}return t}var Jl=function(){function e(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=$m(this.jsonSchema),this.primaryPath=pt(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw Y("SC39",{schema:r});this.finalFields=Yl(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,i){this.finalFields.forEach(o=>{if(!xi(n[o],i[o]))throw Y("DOC9",{dataBefore:n,dataAfter:i,fieldName:o,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},i=Nn(this.jsonSchema,"");return Object.keys(i).forEach(o=>{var c=o;n.__defineGetter__(o,function(){if(!(!this.get||typeof this.get!="function")){var l=this.get(c);return l}}),Object.defineProperty(n,o+"$",{get:function(){return this.get$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"$$",{get:function(){return this.get$$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"_",{get:function(){return this.populate(c)},enumerable:!1,configurable:!1})}),tr(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return dn(this.jsonSchema,n)},Lr(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,i])=>r[n]=i.default),tr(this,"defaultValues",r)}},{key:"hash",get:function(){return tr(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])}();function $m(e){return(e.indexes||[]).map(t=>Ga(t)?t:[t])}function Am(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function Bm(e,t,r=!0){r&&at("preCreateRxSchema",e);var n=mo(e);n=Rm(n),ye.deepFreezeWhenDevMode(n);var i=new Jl(n,t);return at("createRxSchema",i),i}function Fe(e){return typeof e=="function"}function Nm(e){return Fe(e==null?void 0:e.lift)}function Ut(e){return function(t){if(Nm(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var Ls=function(e,t){return Ls=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},Ls(e,t)};function hn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Ls(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function jm(e,t,r,n){function i(o){return o instanceof r?o:new r(function(c){c(o)})}return new(r||(r=Promise))(function(o,c){function l(m){try{v(n.next(m))}catch(y){c(y)}}function d(m){try{v(n.throw(m))}catch(y){c(y)}}function v(m){m.done?o(m.value):i(m.value).then(l,d)}v((n=n.apply(e,t||[])).next())})}function Xl(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=l(0),c.throw=l(1),c.return=l(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(v){return function(m){return d([v,m])}}function d(v){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,v[0]&&(r=0)),r;)try{if(n=1,i&&(o=v[0]&2?i.return:v[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,v[1])).done)return o;switch(i=0,o&&(v=[v[0]&2,o.value]),v[0]){case 0:case 1:o=v;break;case 4:return r.label++,{value:v[1],done:!1};case 5:r.label++,i=v[1],v=[0];continue;case 7:v=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(v[0]===6||v[0]===2)){r=0;continue}if(v[0]===3&&(!o||v[1]>o[0]&&v[1]<o[3])){r.label=v[1];break}if(v[0]===6&&r.label<o[1]){r.label=o[1],o=v;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(v);break}o[2]&&r.ops.pop(),r.trys.pop();continue}v=t.call(e,r)}catch(m){v=[6,m],i=0}finally{n=o=0}if(v[0]&5)throw v[1];return{value:v[0]?v[1]:void 0,done:!0}}}function jn(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function un(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,o=[],c;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(l){c={error:l}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return o}function ln(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}function In(e){return this instanceof In?(this.v=e,this):new In(e)}function qm(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,o=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),l("next"),l("throw"),l("return",c),i[Symbol.asyncIterator]=function(){return this},i;function c(S){return function(w){return Promise.resolve(w).then(S,y)}}function l(S,w){n[S]&&(i[S]=function(P){return new Promise(function(A,N){o.push([S,P,A,N])>1||d(S,P)})},w&&(i[S]=w(i[S])))}function d(S,w){try{v(n[S](w))}catch(P){E(o[0][3],P)}}function v(S){S.value instanceof In?Promise.resolve(S.value.v).then(m,y):E(o[0][2],S)}function m(S){d("next",S)}function y(S){d("throw",S)}function E(S,w){S(w),o.shift(),o.length&&d(o[0][0],o[0][1])}}function Fm(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof jn=="function"?jn(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(o){r[o]=e[o]&&function(c){return new Promise(function(l,d){c=e[o](c),i(l,d,c.done,c.value)})}}function i(o,c,l,d){Promise.resolve(d).then(function(v){o({value:v,done:l})},c)}}var Zl=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function ef(e){return Fe(e==null?void 0:e.then)}function uc(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var ms=uc(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function Ts(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var po=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,i,o;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var l=jn(c),d=l.next();!d.done;d=l.next()){var v=d.value;v.remove(this)}}catch(P){t={error:P}}finally{try{d&&!d.done&&(r=l.return)&&r.call(l)}finally{if(t)throw t.error}}else c.remove(this);var m=this.initialTeardown;if(Fe(m))try{m()}catch(P){o=P instanceof ms?P.errors:[P]}var y=this._finalizers;if(y){this._finalizers=null;try{for(var E=jn(y),S=E.next();!S.done;S=E.next()){var w=S.value;try{ku(w)}catch(P){o=o??[],P instanceof ms?o=ln(ln([],un(o)),un(P.errors)):o.push(P)}}}catch(P){n={error:P}}finally{try{S&&!S.done&&(i=E.return)&&i.call(E)}finally{if(n)throw n.error}}}if(o)throw new ms(o)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)ku(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&Ts(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&Ts(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),tf=po.EMPTY;function rf(e){return e instanceof po||e&&"closed"in e&&Fe(e.remove)&&Fe(e.add)&&Fe(e.unsubscribe)}function ku(e){Fe(e)?e():e.unsubscribe()}var Km={Promise:void 0},Hm={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,ln([e,t],un(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function nf(e){Hm.setTimeout(function(){throw e})}function Iu(){}function Na(e){e()}var lc=function(e){hn(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,rf(r)&&r.add(n)):n.destination=zm,n}return t.create=function(r,n,i){return new qn(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(po),Um=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){Ma(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){Ma(n)}else Ma(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){Ma(r)}},e}(),qn=function(e){hn(t,e);function t(r,n,i){var o=e.call(this)||this,c;return Fe(r)||!r?c={next:r??void 0,error:n??void 0,complete:i??void 0}:c=r,o.destination=new Um(c),o}return t}(lc);function Ma(e){nf(e)}function Wm(e){throw e}var zm={closed:!0,next:Iu,error:Wm,complete:Iu},fc=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Vi(e){return e}function Vm(e){return e.length===0?Vi:e.length===1?e[0]:function(r){return e.reduce(function(n,i){return i(n)},r)}}var dt=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var i=this,o=Gm(t)?t:new qn(t,r,n);return Na(function(){var c=i,l=c.operator,d=c.source;o.add(l?l.call(o,d):d?i._subscribe(o):i._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=Du(r),new r(function(i,o){var c=new qn({next:function(l){try{t(l)}catch(d){o(d),c.unsubscribe()}},error:o,complete:i});n.subscribe(c)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[fc]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Vm(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=Du(t),new t(function(n,i){var o;r.subscribe(function(c){return o=c},function(c){return i(c)},function(){return n(o)})})},e.create=function(t){return new e(t)},e}();function Du(e){var t;return(t=e??Km.Promise)!==null&&t!==void 0?t:Promise}function Qm(e){return e&&Fe(e.next)&&Fe(e.error)&&Fe(e.complete)}function Gm(e){return e&&e instanceof lc||Qm(e)&&rf(e)}function af(e){return Fe(e[fc])}function of(e){return Symbol.asyncIterator&&Fe(e==null?void 0:e[Symbol.asyncIterator])}function sf(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Ym(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var cf=Ym();function uf(e){return Fe(e==null?void 0:e[cf])}function lf(e){return qm(this,arguments,function(){var r,n,i,o;return Xl(this,function(c){switch(c.label){case 0:r=e.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,In(r.read())];case 3:return n=c.sent(),i=n.value,o=n.done,o?[4,In(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,In(i)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function ff(e){return Fe(e==null?void 0:e.getReader)}function lr(e){if(e instanceof dt)return e;if(e!=null){if(af(e))return Jm(e);if(Zl(e))return Xm(e);if(ef(e))return Zm(e);if(of(e))return df(e);if(uf(e))return ep(e);if(ff(e))return tp(e)}throw sf(e)}function Jm(e){return new dt(function(t){var r=e[fc]();if(Fe(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Xm(e){return new dt(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function Zm(e){return new dt(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,nf)})}function ep(e){return new dt(function(t){var r,n;try{for(var i=jn(e),o=i.next();!o.done;o=i.next()){var c=o.value;if(t.next(c),t.closed)return}}catch(l){r={error:l}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}t.complete()})}function df(e){return new dt(function(t){rp(e,t).catch(function(r){return t.error(r)})})}function tp(e){return df(lf(e))}function rp(e,t){var r,n,i,o;return jm(this,void 0,void 0,function(){var c,l;return Xl(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),r=Fm(e),d.label=1;case 1:return[4,r.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(c=n.value,t.next(c),t.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=d.sent(),i={error:l},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(o=r.return)?[4,o.call(r)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function sr(e,t,r,n,i){return new np(e,t,r,n,i)}var np=function(e){hn(t,e);function t(r,n,i,o,c,l){var d=e.call(this,r)||this;return d.onFinalize=c,d.shouldUnsubscribe=l,d._next=n?function(v){try{n(v)}catch(m){r.error(m)}}:e.prototype._next,d._error=o?function(v){try{o(v)}catch(m){r.error(m)}finally{this.unsubscribe()}}:e.prototype._error,d._complete=i?function(){try{i()}catch(v){r.error(v)}finally{this.unsubscribe()}}:e.prototype._complete,d}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(lc),hf={now:function(){return(hf.delegate||Date).now()},delegate:void 0};function ip(e){return e&&Fe(e.schedule)}function dc(e){return e[e.length-1]}function ap(e){return Fe(dc(e))?e.pop():void 0}function Qi(e){return ip(dc(e))?e.pop():void 0}function mf(e,t){return typeof dc(e)=="number"?e.pop():t}function Pr(e,t,r,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var o=t.schedule(function(){r(),i?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(o),!i)return o}var op=Array.isArray,sp=Object.getPrototypeOf,cp=Object.prototype,up=Object.keys;function lp(e){if(e.length===1){var t=e[0];if(op(t))return{args:t,keys:null};if(fp(t)){var r=up(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function fp(e){return e&&typeof e=="object"&&sp(e)===cp}function pf(e,t){return t===void 0&&(t=0),Ut(function(r,n){r.subscribe(sr(n,function(i){return Pr(n,e,function(){return n.next(i)},t)},function(){return Pr(n,e,function(){return n.complete()},t)},function(i){return Pr(n,e,function(){return n.error(i)},t)}))})}function vf(e,t){return t===void 0&&(t=0),Ut(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function dp(e,t){return lr(e).pipe(vf(t),pf(t))}function hp(e,t){return lr(e).pipe(vf(t),pf(t))}function mp(e,t){return new dt(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function pp(e,t){return new dt(function(r){var n;return Pr(r,t,function(){n=e[cf](),Pr(r,t,function(){var i,o,c;try{i=n.next(),o=i.value,c=i.done}catch(l){r.error(l);return}c?r.complete():r.next(o)},0,!0)}),function(){return Fe(n==null?void 0:n.return)&&n.return()}})}function yf(e,t){if(!e)throw new Error("Iterable cannot be null");return new dt(function(r){Pr(r,t,function(){var n=e[Symbol.asyncIterator]();Pr(r,t,function(){n.next().then(function(i){i.done?r.complete():r.next(i.value)})},0,!0)})})}function vp(e,t){return yf(lf(e),t)}function yp(e,t){if(e!=null){if(af(e))return dp(e,t);if(Zl(e))return mp(e,t);if(ef(e))return hp(e,t);if(of(e))return yf(e,t);if(uf(e))return pp(e,t);if(ff(e))return vp(e,t)}throw sf(e)}function Gi(e,t){return t?yp(e,t):lr(e)}function $e(e,t){return Ut(function(r,n){var i=0;r.subscribe(sr(n,function(o){n.next(e.call(t,o,i++))}))})}var gp=Array.isArray;function bp(e,t){return gp(t)?e.apply(void 0,ln([],un(t))):e(t)}function wp(e){return $e(function(t){return bp(e,t)})}function _p(e,t){return e.reduce(function(r,n,i){return r[n]=t[i],r},{})}function Ep(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Qi(e),n=ap(e),i=lp(e),o=i.args,c=i.keys;if(o.length===0)return Gi([],r);var l=new dt(Sp(o,r,c?function(d){return _p(c,d)}:Vi));return n?l.pipe(wp(n)):l}function Sp(e,t,r){return r===void 0&&(r=Vi),function(n){Cu(t,function(){for(var i=e.length,o=new Array(i),c=i,l=i,d=function(m){Cu(t,function(){var y=Gi(e[m],t),E=!1;y.subscribe(sr(n,function(S){o[m]=S,E||(E=!0,l--),l||n.next(r(o.slice()))},function(){--c||n.complete()}))},n)},v=0;v<i;v++)d(v)},n)}}function Cu(e,t,r){e?Pr(r,e,t):t()}function xp(e,t,r,n,i,o,c,l){var d=[],v=0,m=0,y=!1,E=function(){y&&!d.length&&!v&&t.complete()},S=function(P){return v<n?w(P):d.push(P)},w=function(P){v++;var A=!1;lr(r(P,m++)).subscribe(sr(t,function(N){t.next(N)},function(){A=!0},void 0,function(){if(A)try{v--;for(var N=function(){var H=d.shift();c||w(H)};d.length&&v<n;)N();E()}catch(H){t.error(H)}}))};return e.subscribe(sr(t,S,function(){y=!0,E()})),function(){}}function cr(e,t,r){return r===void 0&&(r=1/0),Fe(t)?cr(function(n,i){return $e(function(o,c){return t(n,o,i,c)})(lr(e(n,i)))},r):(typeof t=="number"&&(r=t),Ut(function(n,i){return xp(n,i,e,r)}))}function hc(e){return e===void 0&&(e=1/0),cr(Vi,e)}function kp(){return hc(1)}var Ip=uc(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Dt=function(e){hn(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new Ou(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new Ip},t.prototype.next=function(r){var n=this;Na(function(){var i,o;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var c=jn(n.currentObservers),l=c.next();!l.done;l=c.next()){var d=l.value;d.next(r)}}catch(v){i={error:v}}finally{try{l&&!l.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}}})},t.prototype.error=function(r){var n=this;Na(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var i=n.observers;i.length;)i.shift().error(r)}})},t.prototype.complete=function(){var r=this;Na(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,i=this,o=i.hasError,c=i.isStopped,l=i.observers;return o||c?tf:(this.currentObservers=null,l.push(r),new po(function(){n.currentObservers=null,Ts(l,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,i=n.hasError,o=n.thrownError,c=n.isStopped;i?r.error(o):c&&r.complete()},t.prototype.asObservable=function(){var r=new dt;return r.source=this,r},t.create=function(r,n){return new Ou(r,n)},t}(dt),Ou=function(e){hn(t,e);function t(r,n){var i=e.call(this)||this;return i.destination=r,i.source=n,i}return t.prototype.next=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.next)===null||i===void 0||i.call(n,r)},t.prototype.error=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.error)===null||i===void 0||i.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,i;return(i=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&i!==void 0?i:tf},t}(Dt);function Pu(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return kp()(Gi(e,Qi(e)))}var Dp=new dt(function(e){return e.complete()});function Di(e,t){return t===void 0&&(t=Vi),e=e??Cp,Ut(function(r,n){var i,o=!0;r.subscribe(sr(n,function(c){var l=t(c);(o||!e(i,l))&&(o=!1,i=l,n.next(c))}))})}function Cp(e,t){return e===t}function _e(e,t){return Ut(function(r,n){var i=0;r.subscribe(sr(n,function(o){return e.call(t,o,i++)&&n.next(o)}))})}var Op=uc(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function Pp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Qi(e),n=mf(e,1/0);return Ut(function(i,o){hc(n)(Gi(ln([i],un(e)),r)).subscribe(o)})}function Rp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Pp.apply(void 0,ln([],un(e)))}var _r=function(e){hn(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,i=r.thrownError,o=r._value;if(n)throw i;return this._throwIfClosed(),o},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(Dt),Mp=function(e){hn(t,e);function t(r,n,i){r===void 0&&(r=1/0),n===void 0&&(n=1/0),i===void 0&&(i=hf);var o=e.call(this)||this;return o._bufferSize=r,o._windowTime=n,o._timestampProvider=i,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=n===1/0,o._bufferSize=Math.max(1,r),o._windowTime=Math.max(1,n),o}return t.prototype.next=function(r){var n=this,i=n.isStopped,o=n._buffer,c=n._infiniteTimeWindow,l=n._timestampProvider,d=n._windowTime;i||(o.push(r),!c&&o.push(l.now()+d)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),i=this,o=i._infiniteTimeWindow,c=i._buffer,l=c.slice(),d=0;d<l.length&&!r.closed;d+=o?1:2)r.next(l[d]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,i=r._timestampProvider,o=r._buffer,c=r._infiniteTimeWindow,l=(c?1:2)*n;if(n<1/0&&l<o.length&&o.splice(0,o.length-l),!c){for(var d=i.now(),v=0,m=1;m<o.length&&o[m]<=d;m+=2)v=m;v&&o.splice(0,v+1)}},t}(Dt);function Lp(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new Dt}:t,n=e.resetOnError,i=n===void 0?!0:n,o=e.resetOnComplete,c=o===void 0?!0:o,l=e.resetOnRefCountZero,d=l===void 0?!0:l;return function(v){var m,y,E,S=0,w=!1,P=!1,A=function(){y==null||y.unsubscribe(),y=void 0},N=function(){A(),m=E=void 0,w=P=!1},H=function(){var Q=m;N(),Q==null||Q.unsubscribe()};return Ut(function(Q,se){S++,!P&&!w&&A();var te=E=E??r();se.add(function(){S--,S===0&&!P&&!w&&(y=ps(H,d))}),te.subscribe(se),!m&&S>0&&(m=new qn({next:function(X){return te.next(X)},error:function(X){P=!0,A(),y=ps(N,i,X),te.error(X)},complete:function(){w=!0,A(),y=ps(N,c),te.complete()}}),lr(Q).subscribe(m))})(v)}}function ps(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var i=new qn({next:function(){i.unsubscribe(),e()}});return lr(t.apply(void 0,ln([],un(r)))).subscribe(i)}}function Yi(e,t,r){var n,i,o,c,l=!1;return e&&typeof e=="object"?(n=e.bufferSize,c=n===void 0?1/0:n,i=e.windowTime,t=i===void 0?1/0:i,o=e.refCount,l=o===void 0?!1:o,r=e.scheduler):c=e??1/0,Lp({connector:function(){return new Mp(c,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:l})}function Ji(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Qi(e);return Ut(function(n,i){(r?Pu(e,n,r):Pu(e,n)).subscribe(i)})}function Tp(e,t){return Ut(function(r,n){var i=null,o=0,c=!1,l=function(){return c&&!i&&n.complete()};r.subscribe(sr(n,function(d){i==null||i.unsubscribe();var v=0,m=o++;lr(e(d,m)).subscribe(i=sr(n,function(y){return n.next(t?t(d,y,m,v++):y)},function(){i=null,l()}))},function(){c=!0,l()}))})}function gf(e){return e.documentData?e.documentData:e.previousDocumentData}function $p(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:ye.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var Ap=new Map;function bf(e){return Tt(Ap,e,()=>{for(var t=new Array(e.events.length),r=e.events,n=e.collectionName,i=e.isLocal,o=ye.deepFreezeWhenDevMode,c=0;c<r.length;c++){var l=r[c];t[c]={documentId:l.documentId,collectionName:n,isLocal:i,operation:l.operation,documentData:o(l.documentData),previousDocumentData:o(l.previousDocumentData)}}return t})}function rn(e,t){return new Promise(function(r,n){var i=new qn({next:function(o){r(o),i.unsubscribe()},error:n,complete:function(){n(new Op)}});e.subscribe(i)})}function Bp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Qi(e),n=mf(e,1/0),i=e;return i.length?i.length===1?lr(i[0]):hc(n)(Gi(i,r)):Dp}var Dn="￿",Cn=Number.MIN_SAFE_INTEGER;function Np(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var i=!!t.sort.find(m=>Object.values(m)[0]==="desc"),o=new Set;Object.keys(r).forEach(m=>{var y=Nn(e,m);y&&y.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[m],"$eq")&&o.add(m)});var c=t.sort.map(m=>Object.keys(m)[0]),l=c.filter(m=>!o.has(m)).join(","),d=-1,v;if(n.forEach(m=>{var y=!0,E=!0,S=m.map(H=>{var Q=r[H],se=Q?Object.keys(Q):[],te={};if(!Q||!se.length){var X=E?Cn:Dn;te={startKey:X,endKey:y?Dn:Cn,inclusiveStart:!0,inclusiveEnd:!0}}else se.forEach(ee=>{if(mc.has(ee)){var me=Q[ee],be=Kp(ee,me);te=Object.assign(te,be)}});return typeof te.startKey>"u"&&(te.startKey=Cn),typeof te.endKey>"u"&&(te.endKey=Dn),typeof te.inclusiveStart>"u"&&(te.inclusiveStart=!0),typeof te.inclusiveEnd>"u"&&(te.inclusiveEnd=!0),E&&!te.inclusiveStart&&(E=!1),y&&!te.inclusiveEnd&&(y=!1),te}),w=S.map(H=>H.startKey),P=S.map(H=>H.endKey),A={index:m,startKeys:w,endKeys:P,inclusiveEnd:y,inclusiveStart:E,sortSatisfiedByIndex:!i&&l===m.filter(H=>!o.has(H)).join(","),selectorSatisfiedByIndex:Fp(m,t.selector,w,P)},N=Hp(e,t,A);(N>=d||t.index)&&(d=N,v=A)}),!v)throw Y("SNH",{query:t});return v}var mc=new Set(["$eq","$gt","$gte","$lt","$lte"]),jp=new Set(["$eq","$gt","$gte"]),qp=new Set(["$eq","$lt","$lte"]);function Fp(e,t,r,n){var i=Object.entries(t),o=i.find(([ee,me])=>{if(!e.includes(ee))return!0;var be=Object.entries(me).find(([Be,De])=>!mc.has(Be));return be});if(o||t.$and||t.$or)return!1;var c=[],l=new Set;for(var[d,v]of Object.entries(t)){if(!e.includes(d))return!1;var m=Object.keys(v).filter(ee=>jp.has(ee));if(m.length>1)return!1;var y=m[0];if(y&&l.add(d),y!=="$eq"){if(c.length>0)return!1;c.push(y)}}var E=[],S=new Set;for(var[w,P]of Object.entries(t)){if(!e.includes(w))return!1;var A=Object.keys(P).filter(ee=>qp.has(ee));if(A.length>1)return!1;var N=A[0];if(N&&S.add(w),N!=="$eq"){if(E.length>0)return!1;E.push(N)}}var H=0;for(var Q of e){for(var se of[l,S]){if(!se.has(Q)&&se.size>0)return!1;se.delete(Q)}var te=r[H],X=n[H];if(te!==X&&l.size>0&&S.size>0)return!1;H++}return!0}function Kp(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function Hp(e,t,r){var n=0,i=m=>{m>0&&(n=n+m)},o=10,c=cs(r.startKeys,m=>m!==Cn&&m!==Dn);i(c*o);var l=cs(r.startKeys,m=>m!==Dn&&m!==Cn);i(l*o);var d=cs(r.startKeys,(m,y)=>m===r.endKeys[y]);i(d*o*1.5);var v=r.sortSatisfiedByIndex?5:0;return i(v),n}class Xi extends Error{}const Ci=Symbol("missing"),wf=Object.freeze(new Error("mingo: cycle detected while processing object/array")),Zi=e=>{const t=ja(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},Dr=e=>typeof e!="object"&&typeof e!="function"||e===null,_f=e=>Dr(e)||Fn(e)||rr(e),Ef={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},Ot=(e,t)=>{e===Ci&&(e=void 0),t===Ci&&(t=void 0);const[r,n]=[e,t].map(i=>Ef[Pi(i)]||0);return r!==n?r-n:Mt(e,t)?0:e<t?-1:e>t?1:0};var qi,Yt,Zr;const jc=class jc extends Map{constructor(){super();Le(this,qi,Zi);Le(this,Yt,new Map);Le(this,Zr,r=>{const n=z(this,qi).call(this,r);return[(z(this,Yt).get(n)||[]).find(i=>Mt(i,r)),n]})}static init(r){const n=new jc;return r&&Te(n,qi,r),n}clear(){super.clear(),z(this,Yt).clear()}delete(r){if(Dr(r))return super.delete(r);const[n,i]=z(this,Zr).call(this,r);return super.delete(n)?(z(this,Yt).set(i,z(this,Yt).get(i).filter(o=>!Mt(o,n))),!0):!1}get(r){if(Dr(r))return super.get(r);const[n,i]=z(this,Zr).call(this,r);return super.get(n)}has(r){if(Dr(r))return super.has(r);const[n,i]=z(this,Zr).call(this,r);return super.has(n)}set(r,n){if(Dr(r))return super.set(r,n);const[i,o]=z(this,Zr).call(this,r);if(super.has(i))super.set(i,n);else{super.set(r,n);const c=z(this,Yt).get(o)||[];c.push(r),z(this,Yt).set(o,c)}return this}get size(){return super.size}};qi=new WeakMap,Yt=new WeakMap,Zr=new WeakMap;let Oi=jc;function ge(e,t){if(!e)throw new Xi(t)}const Up=Object.keys(Ef).reduce((e,t)=>(e["[object "+t[0].toUpperCase()+t.substring(1)+"]"]=t,e),{});function Pi(e){var r,n;const t=Object.prototype.toString.call(e);return t==="[object Object]"?((n=(r=e==null?void 0:e.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":Up[t]||t.substring(8,t.length-1).toLowerCase()}const On=e=>typeof e=="boolean",$t=e=>typeof e=="string",Wp=e=>typeof e=="symbol",ze=e=>!isNaN(e)&&typeof e=="number",fe=Array.isArray;function Ae(e){if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&Pi(e)==="object"}const Sf=e=>!Dr(e),Fn=e=>e instanceof Date,rr=e=>e instanceof RegExp,vo=e=>typeof e=="function",ht=e=>e==null,Kn=(e,t=!0)=>!!e||t&&e==="",pc=e=>ht(e)||$t(e)&&!e||fe(e)&&e.length===0||Ae(e)&&Object.keys(e).length===0,Gn=e=>fe(e)?e:[e],At=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),zp=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),Hn=(e,t)=>{if(ht(e)||On(e)||ze(e)||$t(e))return e;if(Fn(e))return new Date(e);if(rr(e))return new RegExp(e);if(zp(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw wf;t.add(e);try{if(fe(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=Hn(e[n],t);return r}if(Ae(e)){const r={};for(const n of Object.keys(e))r[n]=Hn(e[n],t);return r}}finally{t.delete(e)}return e},Ru=e=>e===Ci;function $s(e,t){if(Ru(e)||ht(e))return t;if(Ru(t)||ht(t))return e;if(Dr(e)||Dr(t))return t;fe(e)&&fe(t)&&ge(e.length===t.length,"arrays must be of equal length to merge.");for(const r of Object.keys(t))e[r]=$s(e[r],t[r]);return e}function xf(e,t=Zi){const r=[Oi.init(t),Oi.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(i=>{r[0].has(i)&&r[1].set(i,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function kf(e,t=1){const r=new Array;function n(i,o){for(let c=0,l=i.length;c<l;c++)fe(i[c])&&(o>0||o<0)?n(i[c],Math.max(-1,o-1)):r.push(i[c])}return n(e,t),r}function Vp(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}function If(e){for(;e;){if(Object.getOwnPropertyNames(e).includes("toString"))return e.toString!==Object.prototype.toString;e=Object.getPrototypeOf(e)}return!1}function Mt(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object"||e.constructor!==t.constructor)return!1;if(e instanceof Date)return+e==+t;if(e instanceof RegExp)return e.toString()===t.toString();const r=e.constructor;if(r===Array||r===Object){const n=Object.keys(e).sort(),i=Object.keys(t).sort();if(n.length!==i.length)return!1;for(let o=0,c=n[o];o<n.length;c=n[++o])if(c!==i[o]||!Mt(e[c],t[c]))return!1;return!0}return If(e)&&e.toString()===t.toString()}function Qp(e,t=Zi){const r=Oi.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}const ja=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";if($t(e)||ze(e)||On(e))return JSON.stringify(e);if(Fn(e))return e.toISOString();if(rr(e)||Wp(e)||vo(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw wf;try{if(t.add(e),fe(e))return"["+e.map(n=>ja(n,t)).join(",")+"]";if(Ae(e))return"{"+Object.keys(e).sort().map(i=>`${i}:${ja(e[i],t)}`).join()+"}";const r=If(e)?e.toString():ja(Vp(e),t);return Pi(e)+"("+r+")"}finally{t.delete(e)}};function Gp(e,t){return ht(e)?null:(t=t||Zi,t(e))}function Yp(e,t,r=Zi){if(e.length<1)return new Map;const n=new Map,i=new Map;for(let o=0;o<e.length;o++){const c=e[o],l=t(c,o),d=Gp(l,r);if(d===null)i.has(null)?i.get(null).push(c):i.set(null,[c]);else{const v=n.has(d)?n.get(d).find(m=>Mt(m,l)):null;ht(v)?(i.set(l,[c]),n.has(d)?n.get(d).push(l):n.set(d,[l])):i.get(v).push(c)}}return i}function As(e,t){return Sf(e)?e[t]:void 0}function Jp(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function Ht(e,t,r){let n=0;function i(c,l){let d=c;for(let v=0;v<l.length;v++){const m=l[v];if(/^\d+$/.exec(m)===null&&fe(d)){if(v===0&&n>0)break;n+=1;const E=l.slice(v);d=d.reduce((S,w)=>{const P=i(w,E);return P!==void 0&&S.push(P),S},[]);break}else d=As(d,m);if(d===void 0)break}return d}const o=_f(e)?e:i(e,t.split("."));return fe(o)&&(r!=null&&r.unwrapArray)?Jp(o,n):o}function yi(e,t,r){const n=t.indexOf("."),i=n==-1?t:t.substring(0,n),o=t.substring(n+1),c=n!=-1;if(fe(e)){const v=/^\d+$/.test(i),m=v&&(r!=null&&r.preserveIndex)?[...e]:[];if(v){const y=parseInt(i);let E=As(e,y);c&&(E=yi(E,o,r)),r!=null&&r.preserveIndex?m[y]=E:m.push(E)}else for(const y of e){const E=yi(y,t,r);r!=null&&r.preserveMissing?m.push(E??Ci):(E!=null||r!=null&&r.preserveIndex)&&m.push(E)}return m}const l=r!=null&&r.preserveKeys?{...e}:{};let d=As(e,i);if(c&&(d=yi(d,o,r)),d!==void 0)return l[i]=d,l}function Bs(e){if(fe(e))for(let t=e.length-1;t>=0;t--)e[t]===Ci?e.splice(t,1):Bs(e[t]);else if(Ae(e))for(const t in e)At(e,t)&&Bs(e[t])}const Mu=/^\d+$/;function Ri(e,t,r,n){const i=t.split("."),o=i[0],c=i.slice(1).join(".");if(i.length===1)(Ae(e)||fe(e)&&Mu.test(o))&&r(e,o);else{n!=null&&n.buildGraph&&ht(e[o])&&(e[o]={});const l=e[o];if(!l)return;const d=!!(i.length>1&&Mu.test(i[1]));fe(l)&&(n!=null&&n.descendArray)&&!d?l.forEach(v=>Ri(v,c,r,n)):Ri(l,c,r,n)}}function Xp(e,t,r){Ri(e,t,(n,i)=>{n[i]=vo(r)?r(n[i]):r},{buildGraph:!0})}function Lu(e,t,r){Ri(e,t,(n,i)=>{if(fe(n)){if(/^\d+$/.test(i))n.splice(parseInt(i),1);else if(r&&r.descendArray)for(const o of n)Ae(o)&&delete o[i]}else Ae(n)&&delete n[i]},r)}const Zp=/^\$[a-zA-Z0-9_]+$/;function Tr(e){return Zp.test(e)}function Df(e){if(_f(e))return rr(e)?{$regex:e}:{$eq:e};if(Sf(e)){if(!Object.keys(e).some(Tr))return{$eq:e};if(At(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var Ns=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(Ns||{}),We,Fi,Jt;const Ei=class Ei{constructor(t,r,n){Le(this,We);Le(this,Fi);Le(this,Jt);Te(this,We,t),this.update(r,n)}static init(t,r,n){var i;return t instanceof Ei?new Ei(z(t,We),t.root??r,{...z(t,Jt),...n,variables:Object.assign({},(i=z(t,Jt))==null?void 0:i.variables,n==null?void 0:n.variables)}):new Ei(t,r,n)}update(t,r){var i;Te(this,Fi,t);const n=Object.assign({},(i=z(this,Jt))==null?void 0:i.variables,r==null?void 0:r.variables);return Object.keys(n).length?Te(this,Jt,{...r,variables:n}):Te(this,Jt,r??{}),this}getOptions(){return Object.freeze({...z(this,We),context:fn.from(z(this,We).context)})}get root(){return z(this,Fi)}get local(){return z(this,Jt)}get idKey(){return z(this,We).idKey}get collation(){var t;return(t=z(this,We))==null?void 0:t.collation}get processingMode(){var t;return((t=z(this,We))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=z(this,We))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=z(this,We))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=z(this,We))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=z(this,We))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=z(this,We))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=z(this,We))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=z(this,We))==null?void 0:t.variables}get context(){var t;return(t=z(this,We))==null?void 0:t.context}};We=new WeakMap,Fi=new WeakMap,Jt=new WeakMap;let Mi=Ei;function Cf(e){return e instanceof Mi?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:e!=null&&e.context?fn.from(e==null?void 0:e.context):fn.init()})}var js=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(js||{}),xr;const lo=class lo{constructor(){Le(this,xr,new Map)}static init(){return new lo}static from(t){const r=lo.init();return ht(t)||z(t,xr).forEach((n,i)=>r.addOperators(i,n)),r}addOperators(t,r){z(this,xr).has(t)||z(this,xr).set(t,{});for(const[n,i]of Object.entries(r))this.getOperator(t,n)||(z(this,xr).get(t)[n]=i);return this}getOperator(t,r){return(z(this,xr).get(t)??{})[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};xr=new WeakMap;let fn=lo;const Gr=fn.init();function Tu(e,t){for(const[r,n]of Object.entries(t)){ge(vo(n)&&Tr(r),`'${r}' is not a valid operator`);const i=Li(e,r,null);ge(!i||n===i,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":Gr.addAccumulatorOps(t);break;case"expression":Gr.addExpressionOps(t);break;case"pipeline":Gr.addPipelineOps(t);break;case"projection":Gr.addProjectionOps(t);break;case"query":Gr.addQueryOps(t);break;case"window":Gr.addWindowOps(t);break}}function Li(e,t,r){const{context:n,useGlobalContext:i}=r||{},o=n?n.getOperator(e,t):null;return!o&&i?Gr.getOperator(e,t):o}function kt(e,t,r,n){const i=Mi.init(n,e);return r&&Tr(r)?Of(e,t,r,i):Xa(e,t,i)}const ev=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Xa(e,t,r){var n;if($t(t)&&t.length>0&&t[0]==="$"){if(tv.includes(t))return t;let i=r.root;const o=t.split(".");if(ev.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":i=e;break;case"$$REMOVE":i=void 0;break;case"$$NOW":i=new Date;break}t=t.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){i=Object.assign({},r.variables,{this:e},(n=r==null?void 0:r.local)==null?void 0:n.variables);const c=o[0].slice(2);ge(At(i,c),`Use of undefined variable: ${c}`),t=t.slice(2)}else t=t.slice(1);return t===""?i:Ht(i,t)}if(fe(t))return t.map(i=>Xa(e,i,r));if(Ae(t)){const i={},o=Object.entries(t);for(const[c,l]of o){if(Tr(c))return ge(o.length==1,"expression must have single operator."),Of(e,l,c,r);i[c]=Xa(e,l,r)}return i}return t}function Of(e,t,r,n){const i=Li("expression",r,n);if(i)return i(e,t,n);const o=Li("accumulator",r,n);return ge(!!o,`accumulator '${r}' is not registered.`),fe(e)||(e=Xa(e,t,n),t=null),ge(fe(e),`arguments must resolve to array for ${r}.`),o(e,t,n)}const tv=["$$KEEP","$$PRUNE","$$DESCEND"];function Ti(e){return e instanceof $u?e:new $u(e)}function rv(...e){let t=0;return Ti(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function nv(e){return!!e&&typeof e=="object"&&(e==null?void 0:e.next)instanceof Function}function iv(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const qs=new Error;function av(e,t,r){let n=!1,i=-1,o=0;return function(c){try{e:for(;!n;){let l=e();i++;let d=-1;const v=t.length;let m=!1;for(;++d<v;){const y=t[d];switch(y.action){case 0:l=y.func(l,i);break;case 1:if(!y.func(l,i))continue e;break;case 2:--y.count,y.count||(m=!0);break;case 3:--y.count,y.count||iv(t,d);continue e;default:break e}}if(n=m,c)r[o++]=l;else return{value:l,done:!1}}}catch(l){if(l!==qs)throw l}return n=!0,{done:n}}}var en,Ln,Tn,Nl;let $u=(Nl=class{constructor(t){Le(this,en);Le(this,Ln);Le(this,Tn);Te(this,en,[]),Te(this,Ln,[]),this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),nv(t)){const n=t;r=()=>{const i=n.next();if(i.done)throw qs;return i.value}}else if(fe(t)){const n=t,i=n.length;let o=0;r=()=>{if(o<i)return n[o++];throw qs}}else if(!(t instanceof Function))throw new Xi("Lazy must be initialized with an array, generator, or function.");Te(this,Tn,av(r,z(this,en),z(this,Ln)))}push(t,r){return typeof r=="function"?z(this,en).push({action:t,func:r}):typeof r=="number"&&z(this,en).push({action:t,count:r}),this}next(){return z(this,Tn).call(this)}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return Ti(()=>(n||(n=Ti(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=z(this,Tn).call(this,!0).done),z(this,Ln)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}},en=new WeakMap,Ln=new WeakMap,Tn=new WeakMap,Nl);const ov=(e,t,r)=>e.take(t),Pf=(e,t,r)=>pc(t)?e:(Mf(t,r),e.map(Rf(t,Mi.init(r))));function Rf(e,t,r=!0){const n=t.idKey,i=Object.keys(e),o=new Array,c=new Array,l={};for(const S of i){const w=e[S];if(ze(w)||On(w))w?c.push(S):o.push(S);else if(fe(w))l[S]=P=>w.map(A=>kt(P,A,null,t.update(P))??null);else if(Ae(w)){const P=Object.keys(w),A=P.length==1?P[0]:"",N=Li("projection",A,t);N?A==="$slice"&&!Gn(w[A]).every(ze)?l[S]=Q=>kt(Q,w,S,t.update(Q)):l[S]=Q=>N(Q,w[A],S,t.update(Q)):Tr(A)?l[S]=H=>kt(H,w[A],A,t):(Mf(w,t),l[S]=H=>{if(!At(H,S))return kt(H,w,null,t);r&&t.update(H);const Q=Ht(H,S),se=Rf(w,t,!1);return fe(Q)?Q.map(se):Ae(Q)?se(Q):se(H)})}else l[S]=$t(w)&&w[0]==="$"?P=>kt(P,w,S,t):P=>w}const d=Object.keys(l),v=o.includes(n);if(r&&v&&o.length===1&&!c.length&&!d.length)return S=>{const w={...S};return delete w[n],w};const y=r&&!v&&!c.includes(n),E={preserveMissing:!0};return S=>{const w={};if(o.length&&!c.length){$s(w,S);for(const P of o)Lu(w,P,{descendArray:!0})}for(const P of c){const A=yi(S,P,E)??{};$s(w,A)}c.length&&Bs(w);for(const P of d){const A=l[P](S);A===void 0?Lu(w,P,{descendArray:!0}):Xp(w,P,A)}return y&&At(S,n)&&(w[n]=Ht(S,n)),w}}function Mf(e,t){let r=!1,n=!1;for(const[i,o]of Object.entries(e))ge(!i.startsWith("$"),"Field names may not start with '$'."),ge(!i.endsWith(".$"),"Positional projection operator '$' is not supported."),i!==(t==null?void 0:t.idKey)&&(o===0||o===!1?r=!0:(o===1||o===!0)&&(n=!0),ge(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const sv=(e,t,r)=>e.drop(t),Lf=(e,t,r)=>{if(pc(t)||!Ae(t))return e;let n=Ot;const i=r.collation;return Ae(i)&&$t(i.locale)&&(n=uv(i)),e.transform(o=>{const c=Object.keys(t);for(const l of c.reverse()){const d=Yp(o,y=>Ht(y,l),r.hashFunction),v=Array.from(d.keys()).sort(n);t[l]===-1&&v.reverse();let m=0;for(const y of v)for(const E of d.get(y))o[m++]=E;ge(m==o.length,"bug: counter must match collection size.")}return o})},cv={1:"base",2:"accent",3:"variant"};function uv(e){const t={sensitivity:cv[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,i)=>{if(!$t(n)||!$t(i))return Ot(n,i);const o=r.compare(n,i);return o<0?-1:o>0?1:0}}const lv={$sort:Lf,$skip:sv,$limit:ov};var Ki,Hi,$n,Xt,kr,lt,Zt;class fv{constructor(t,r,n,i){Le(this,Ki);Le(this,Hi);Le(this,$n);Le(this,Xt);Le(this,kr,{});Le(this,lt,null);Le(this,Zt,[]);Te(this,Ki,t),Te(this,Hi,r),Te(this,$n,n),Te(this,Xt,i)}fetch(){if(z(this,lt))return z(this,lt);Te(this,lt,Ti(z(this,Ki)).filter(z(this,Hi)));const t=z(this,Xt).processingMode;t&Ns.CLONE_INPUT&&z(this,lt).map(Hn);for(const r of["$sort","$skip","$limit"])At(z(this,kr),r)&&Te(this,lt,lv[r](z(this,lt),z(this,kr)[r],z(this,Xt)));return Object.keys(z(this,$n)).length&&Te(this,lt,Pf(z(this,lt),z(this,$n),z(this,Xt))),t&Ns.CLONE_OUTPUT&&z(this,lt).map(Hn),z(this,lt)}fetchAll(){const t=Ti([...z(this,Zt)]);return Te(this,Zt,[]),rv(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return z(this,kr).$skip=t,this}limit(t){return z(this,kr).$limit=t,this}sort(t){return z(this,kr).$sort=t,this}collation(t){return Te(this,Xt,{...z(this,Xt),collation:t}),this}next(){if(z(this,Zt).length>0)return z(this,Zt).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(z(this,Zt).length>0)return!0;const t=this.fetch().next();return t.done?!1:(z(this,Zt).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}Ki=new WeakMap,Hi=new WeakMap,$n=new WeakMap,Xt=new WeakMap,kr=new WeakMap,lt=new WeakMap,Zt=new WeakMap;const dv=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));var An,Ir,tn;class $r{constructor(t,r){Le(this,An);Le(this,Ir);Le(this,tn);Te(this,tn,Hn(t)),Te(this,Ir,Cf(r)),Te(this,An,[]),this.compile()}compile(){ge(Ae(z(this,tn)),`query criteria must be an object: ${JSON.stringify(z(this,tn))}`);const t={};for(const[r,n]of Object.entries(z(this,tn))){if(r==="$where")ge(z(this,Ir).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(dv.has(r))this.processOperator(r,r,n);else{ge(!Tr(r),`unknown top level operator: ${r}`);for(const[i,o]of Object.entries(Df(n)))this.processOperator(r,i,o)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const i=Li("query",r,z(this,Ir));ge(!!i,`unknown query operator ${r}`),z(this,An).push(i(t,n,z(this,Ir)))}test(t){return z(this,An).every(r=>r(t))}find(t,r){return new fv(t,n=>this.test(n),r||{},z(this,Ir))}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}An=new WeakMap,Ir=new WeakMap,tn=new WeakMap;const hv=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(hv);function rt(e){return(r,n,i)=>{const o={unwrapArray:!0},c=Math.max(1,r.split(".").length-1);return l=>{const d=Ht(l,r,o);return e(d,n,{...i,depth:c})}}}function Yn(e){return(t,r,n)=>{const i=kt(t,r,null,n);return e(...i)}}function vc(e,t,r){return Mt(e,t)||ht(e)&&ht(t)?!0:fe(e)?e.some(n=>Mt(n,t))||kf(e,r==null?void 0:r.depth).some(n=>Mt(n,t)):!1}function Tf(e,t,r){return!vc(e,t,r)}function $f(e,t,r){return ht(e)?t.some(n=>n===null):xf([Gn(e),t],r==null?void 0:r.hashFunction).length>0}function mv(e,t,r){return!$f(e,t,r)}function Af(e,t,r){return yo(e,t,(n,i)=>Ot(n,i)<0)}function Bf(e,t,r){return yo(e,t,(n,i)=>Ot(n,i)<=0)}function Nf(e,t,r){return yo(e,t,(n,i)=>Ot(n,i)>0)}function jf(e,t,r){return yo(e,t,(n,i)=>Ot(n,i)>=0)}function pv(e,t,r){return Gn(e).some(n=>t.length===2&&n%t[0]===t[1])}function vv(e,t,r){const n=Gn(e),i=o=>$t(o)&&Kn(t.exec(o),r==null?void 0:r.useStrictMode);return n.some(i)||kf(n,1).some(i)}function yv(e,t,r){if(!fe(e)||!fe(t)||!e.length||!t.length)return!1;let n=!0;for(const i of t){if(!n)break;Ae(i)&&Object.keys(i).includes("$elemMatch")?n=qf(e,i.$elemMatch,r):rr(i)?n=e.some(o=>typeof o=="string"&&i.test(o)):n=e.some(o=>Mt(i,o))}return n}function gv(e,t,r){return Array.isArray(e)&&e.length===t}function bv(e){return Tr(e)&&["$and","$or","$nor"].indexOf(e)===-1}function qf(e,t,r){if(fe(e)&&!pc(e)){let n=c=>c,i=t;Object.keys(t).every(bv)&&(i={temp:t},n=c=>({temp:c}));const o=new $r(i,r);for(let c=0,l=e.length;c<l;c++)if(o.test(n(e[c])))return!0}return!1}const Au=e=>e===null,wv={array:fe,boolean:On,bool:On,date:Fn,number:ze,int:ze,long:ze,double:ze,decimal:ze,null:Au,object:Ae,regexp:rr,regex:rr,string:$t,undefined:ht,function:e=>{throw new Xi("unsupported type key `function`.")},1:ze,2:$t,3:Ae,4:fe,6:ht,8:On,9:Fn,10:Au,11:rr,16:ze,18:ze,19:ze};function Bu(e,t,r){const n=wv[t];return n?n(e):!1}function _v(e,t,r){return fe(t)?t.findIndex(n=>Bu(e,n))>=0:Bu(e,t)}function yo(e,t,r){return Gn(e).some(n=>Pi(n)===Pi(t)&&r(n,t))}const Ev=(e,t,r)=>{const n=kt(e,t,null,r);return Kn(n,r.useStrictMode)&&n.every(i=>Kn(i,r.useStrictMode))},Sv=(e,t,r)=>{const n=Gn(t);return n.length==0?!1:(ge(n.length==1,"Expression $not takes exactly 1 argument"),!kt(e,n[0],null,r))},xv=(e,t,r)=>{const n=kt(e,t,null,r),i=r.useStrictMode;return Kn(n,i)&&n.some(o=>Kn(o,i))},kv=Object.freeze(Object.defineProperty({__proto__:null,$and:Ev,$not:Sv,$or:xv},Symbol.toStringTag,{value:"Module"})),Iv=(e,t,r)=>{const n=kt(e,t,null,r);return ge(fe(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),Ot(n[0],n[1])},Dv=Yn(vc),Cv=Yn(Nf),Ov=Yn(jf),Pv=Yn(Af),Rv=Yn(Bf),Mv=Yn(Tf),Lv=Object.freeze(Object.defineProperty({__proto__:null,$cmp:Iv,$eq:Dv,$gt:Cv,$gte:Ov,$lt:Pv,$lte:Rv,$ne:Mv},Symbol.toStringTag,{value:"Module"})),Nu=(e,t)=>{const r={};return e.split("").forEach((n,i)=>r[n]=t*(i+1)),r};({...Nu("ABCDEFGHIKLM",1),...Nu("NOPQRSTUVWXY",-1)});const ju={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function vt(e,t=ju){const r=Object.assign({},ju,t),n=new Set(Object.keys(r));return(i,o,c)=>{const l=kt(i,o,null,c);if(n.has(`${l}`)){const d=r[`${l}`];if(d instanceof Error)throw new Xi(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return d}return e(l)}}vt(Math.acos,{Infinity:1/0,0:new Error});vt(Math.acosh,{Infinity:1/0,0:new Error});vt(Math.asin);vt(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});vt(Math.atan);vt(Math.atanh,{1:1/0,"-1":-1/0});vt(Math.cos);vt(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const Tv=Math.PI/180;vt(e=>e*Tv,{Infinity:1/0,"-Infinity":1/0});const $v=180/Math.PI;vt(e=>e*$v,{Infinity:1/0,"-Infinity":-1/0});vt(Math.sin);vt(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});vt(Math.tan);const Ff=(e,t,r)=>{ge(fe(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(i=>new $r(i,r));return i=>n.every(o=>o.test(i))},yc=(e,t,r)=>{ge(fe(t),"Invalid expression. $or expects value to be an Array");const n=t.map(i=>new $r(i,r));return i=>n.some(o=>o.test(i))},Kf=(e,t,r)=>{ge(fe(t),"Invalid expression. $nor expects value to be an array.");const n=yc("$or",t,r);return i=>!n(i)},Hf=(e,t,r)=>{const n={};n[e]=Df(t);const i=new $r(n,r);return o=>!i.test(o)},Uf=rt(vc),Wf=rt(Nf),zf=rt(jf),Vf=rt($f),Qf=rt(Af),Gf=rt(Bf),Yf=rt(Tf),Jf=rt(mv);function Av(e,t,r){return n=>kt(n,t,null,r)}function Bv(e,t,r){if(!(r!=null&&r.jsonSchemaValidator))throw new Xi("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return i=>n(i)}const Xf=rt(pv),Zf=rt(vv);function Nv(e,t,r){ge(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return ge(vo(n),"$where only accepts a Function object"),i=>Kn(n.call(i),r==null?void 0:r.useStrictMode)}const jv=rt(yv),ed=rt(qf),td=rt(gv),rd=(e,t,r)=>{const n=e.includes("."),i=!!t;return!n||e.match(/\.\d+$/)?o=>Ht(o,e)!==void 0===i:o=>{const c=yi(o,e,{preserveIndex:!0}),l=Ht(c,e.substring(0,e.lastIndexOf(".")));return fe(l)?l.some(d=>d!==void 0)===i:l!==void 0===i}},nd=rt(_v);var qu=!1;function qv(e){return qu||(Tu(js.PIPELINE,{$sort:Lf,$project:Pf}),Tu(js.QUERY,{$and:Ff,$eq:Uf,$elemMatch:ed,$exists:rd,$gt:Wf,$gte:zf,$in:Vf,$lt:Qf,$lte:Gf,$ne:Yf,$nin:Jf,$mod:Xf,$nor:Kf,$not:Hf,$or:yc,$regex:Zf,$size:td,$type:nd}),qu=!0),new $r(e)}function Pn(e,t){var r=pt(e.primaryKey);t=Ie(t);var n=tt(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([y,E])=>{(typeof E!="object"||E===null)&&(n.selector[y]={$eq:E})})):n.selector={},n.index){var i=ic(n.index);i.includes(r)||i.push(r),n.index=i}if(n.sort){var m=n.sort.find(y=>cm(y)===r);m||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(y=>({[y]:"asc"}));else{if(e.indexes){var o=new Set;Object.entries(n.selector).forEach(([y,E])=>{var S=!1;typeof E=="object"&&E!==null?S=!!Object.keys(E).find(w=>mc.has(w)):S=!0,S&&o.add(y)});var c=-1,l;e.indexes.forEach(y=>{var E=Ga(y)?y:[y],S=E.findIndex(w=>!o.has(w));S>0&&S>c&&(c=S,l=E)}),l&&(n.sort=l.map(y=>({[y]:"asc"})))}if(!n.sort)if(e.indexes&&e.indexes.length>0){var d=e.indexes[0],v=Ga(d)?d:[d];n.sort=v.map(y=>({[y]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function id(e,t){if(!t.sort)throw Y("SNH",{query:t});var r=[];t.sort.forEach(i=>{var o=Object.keys(i)[0],c=Object.values(i)[0];r.push({key:o,direction:c,getValueFn:sm(o)})});var n=(i,o)=>{for(var c=0;c<r.length;++c){var l=r[c],d=l.getValueFn(i),v=l.getValueFn(o);if(d!==v){var m=l.direction==="asc"?Ot(d,v):Ot(v,d);return m}}};return n}function gc(e,t){if(!t.sort)throw Y("SNH",{query:t});var r=qv(t.selector),n=i=>r.test(i);return n}async function _n(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(i=>t(i)));if(r instanceof Map)return Promise.all([...r.values()].map(i=>t(i)));var n=await t(r);return n}function go(e,t){if(!t.sort)throw Y("SNH",{query:t});var r=Np(e,t);return{query:t,queryPlan:r}}var Fv="_rxdb_internal";async function ea(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function $i(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var i=n.error[0];throw i}else{var o=pt(e.schema.primaryKey),c=Pt(o,[t],n),l=c[0];return l}}function Kv(e,t){var r=ea(e,t),n=e.changeStream().pipe($e(i=>i.events.find(o=>o.documentId===t)),_e(i=>!!i),$e(i=>Promise.resolve(oe(i).documentData)),Ji(r),Tp(i=>i),_e(i=>!!i));return n}function Ai(e){return Object.assign({},...e)}function Za(e,t,r,n){if(n)throw n.status===409?Y("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?Y("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function Hv(e,t,r,n,i,o,c){for(var l=!!e.schema.attachments,d=[],v=[],m=[],y=Ui(10),E={id:y,events:[],checkpoint:null,context:i},S=E.events,w=[],P=[],A=[],N=r.size>0,H,Q=n.length,se=function(){var X=n[te],ee=X.document,me=X.previous,be=ee[t],Be=ee._deleted,De=me&&me._deleted,le=void 0;N&&(le=r.get(be));var Ee;if(le){var st=le._rev;if(!me||me&&st!==me._rev){var zt={isError:!0,status:409,documentId:be,writeRow:X,documentInDb:le};return m.push(zt),1}var Pe=l?vs(X):X;l&&(Be?me&&Object.keys(me._attachments).forEach(de=>{P.push({documentId:be,attachmentId:de,digest:oe(me)._attachments[de].digest})}):(Object.entries(ee._attachments).find(([de,Ke])=>{var gt=me?me._attachments[de]:void 0;return!gt&&!Ke.data&&(Ee={documentId:be,documentInDb:le,isError:!0,status:510,writeRow:X,attachmentId:de}),!0}),Ee||Object.entries(ee._attachments).forEach(([de,Ke])=>{var gt=me?me._attachments[de]:void 0;if(!gt)w.push({documentId:be,attachmentId:de,attachmentData:Ke,digest:Ke.digest});else{var fr=Pe.document._attachments[de].digest;Ke.data&&gt.digest!==fr&&A.push({documentId:be,attachmentId:de,attachmentData:Ke,digest:Ke.digest})}}))),Ee?m.push(Ee):(l?v.push(vs(Pe)):v.push(Pe),H=Pe);var Xe=null,re=null,xe=null;if(De&&!Be)xe="INSERT",Xe=l?Ft(ee):ee;else if(me&&!De&&!Be)xe="UPDATE",Xe=l?Ft(ee):ee,re=me;else if(Be)xe="DELETE",Xe=oe(ee),re=me;else throw Y("SNH",{args:{writeRow:X}});var Ve={documentId:be,documentData:Xe,previousDocumentData:re,operation:xe};S.push(Ve)}else{var Ne=!!Be;if(l&&Object.entries(ee._attachments).forEach(([de,Ke])=>{Ke.data?w.push({documentId:be,attachmentId:de,attachmentData:Ke,digest:Ke.digest}):(Ee={documentId:be,isError:!0,status:510,writeRow:X,attachmentId:de},m.push(Ee))}),Ee||(l?d.push(vs(X)):d.push(X),H=X),!Ne){var Ce={documentId:be,operation:"INSERT",documentData:l?Ft(ee):ee,previousDocumentData:l&&me?Ft(me):me};S.push(Ce)}}},te=0;te<Q;te++)se();return{bulkInsertDocs:d,bulkUpdateDocs:v,newestRow:H,errors:m,eventBulk:E,attachmentsAdd:w,attachmentsRemove:P,attachmentsUpdate:A}}function vs(e){return{previous:e.previous,document:Ft(e.document)}}function Uv(e){return atob(e).length}function Wv(e){var t=e.data;if(!t)return e;var r={length:Uv(t),digest:e.digest,type:e.type};return r}function Ft(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=Ie(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=Wv(n)}),t}function ta(e){return Object.assign({},e,{_meta:Ie(e._meta)})}function bc(e,t,r){ye.deepFreezeWhenDevMode(r);var n=pt(t.schema.primaryKey),i={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,async bulkWrite(o,c){for(var l=e.token,d=new Array(o.length),v=mt(),m=0;m<o.length;m++){var y=o[m],E=ta(y.document);E._meta.lwt=v;var S=y.previous;E._rev=ar(l,S),d[m]={document:E,previous:S}}at("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:d});var w=await e.lockedRun(()=>t.bulkWrite(d,c)),P={error:[]};od.set(P,d);var A=w.error.length===0?[]:w.error.filter(X=>X.status===409&&!X.writeRow.previous&&!X.writeRow.document._deleted&&oe(X.documentInDb)._deleted?!0:(P.error.push(X),!1));if(A.length>0){var N=new Set,H=A.map(X=>(N.add(X.documentId),{previous:X.documentInDb,document:Object.assign({},X.writeRow.document,{_rev:ar(e.token,X.documentInDb)})})),Q=await e.lockedRun(()=>t.bulkWrite(H,c));cn(P.error,Q.error);var se=Pt(n,d,P,N),te=Pt(n,H,Q);return cn(se,te),P}return P},query(o){return e.lockedRun(()=>t.query(o))},count(o){return e.lockedRun(()=>t.count(o))},findDocumentsById(o,c){return e.lockedRun(()=>t.findDocumentsById(o,c))},getAttachmentData(o,c,l){return e.lockedRun(()=>t.getAttachmentData(o,c,l))},getChangedDocumentsSince:t.getChangedDocumentsSince?(o,c)=>e.lockedRun(()=>t.getChangedDocumentsSince(oe(o),c)):void 0,cleanup(o){return e.lockedRun(()=>t.cleanup(o))},remove(){return e.storageInstances.delete(i),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(i),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()}};return e.storageInstances.add(i),i}function zv(e){if(e.schema.keyCompression)throw Y("UT5",{args:{params:e}});if(Fs(e.schema))throw Y("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw Y("UT7",{args:{params:e}})}function Fs(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function Vv(e,t,r){var n=pt(e.schema.primaryKey),i=r?r.lwt:ac,o=r?r.id:"";return Pn(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:i}},{"_meta.lwt":{$eq:i},[n]:{$gt:r?o:""}}],"_meta.lwt":{$gte:i}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function ad(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=pt(e.schema.primaryKey),i=go(e.schema,Vv(e,t,r)),o=await e.query(i),c=o.documents,l=im(c);return{documents:c,checkpoint:l?{id:l[n],lwt:l._meta.lwt}:r||{id:"",lwt:0}}}var od=new WeakMap,Qv=new WeakMap;function Pt(e,t,r,n){return Tt(Qv,r,()=>{var i=[],o=od.get(r);if(o||(o=t),r.error.length>0||n){for(var c=n||new Set,l=0;l<r.error.length;l++){var d=r.error[l];c.add(d.documentId)}for(var v=0;v<o.length;v++){var m=o[v].document;c.has(m[e])||i.push(Ft(m))}}else{i.length=t.length-r.error.length;for(var y=0;y<o.length;y++){var E=o[y].document;i[y]=Ft(E)}}return i})}var sd=function(){function e(r,n,i,o){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=i,this.postWrite=o}var t=e.prototype;return t.addWrite=function(n,i){var o=n[this.primaryPath],c=Tt(this.queueByDocId,o,()=>[]),l=new Promise((d,v)=>{var m={lastKnownDocumentState:n,modifier:i,resolve:d,reject:v};oe(c).push(m),this.triggerRun()});return l},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],i=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(i.entries()).map(async([c,l])=>{var d=Gv(l.map(y=>y.lastKnownDocumentState)),v=d;for(var m of l)try{v=await m.modifier(tt(v))}catch(y){m.reject(y),m.reject=()=>{},m.resolve=()=>{}}try{await this.preWrite(v,d)}catch(y){l.forEach(E=>E.reject(y));return}n.push({previous:d,document:v})}));var o=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(Pt(this.primaryPath,n,o).map(c=>{var l=c[this.primaryPath];this.postWrite(c);var d=Bn(i,l);d.forEach(v=>v.resolve(c))})),o.error.forEach(c=>{var l=c.documentId,d=Bn(i,l),v=ho(c);if(v){var m=Tt(this.queueByDocId,l,()=>[]);d.reverse().forEach(E=>{E.lastKnownDocumentState=oe(v.documentInDb),oe(m).unshift(E)})}else{var y=Gl(c);d.forEach(E=>E.reject(y))}}),this.isRunning=!1,this.triggerRun()}},e}();function Fu(e){var t=async r=>{var n=um(r);n._deleted=r._deleted;var i=await e(n),o=Object.assign({},i,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof i._deleted<"u"?i._deleted:r._deleted});return typeof o._deleted>"u"&&(o._deleted=!1),o};return t}function Gv(e){var t=e[0],r=Rr(t._rev);return e.forEach(n=>{var i=Rr(n._rev);i>r&&(t=n,r=i)}),t}var bo={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe($e(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,t=this.primary;return e.collection.eventBulks$.pipe(_e(r=>!r.isLocal),$e(r=>r.events.find(n=>n.documentId===t)),_e(r=>!!r),$e(r=>gf(oe(r))),Ji(e.collection._docCache.getLatestDocumentData(t)),Di((r,n)=>r._rev===n._rev),$e(r=>this.collection._docCache.getCachedRxDocument(r)),Yi(Wi))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(ye.isDevMode()){if(e.includes(".item."))throw Y("DOC1",{path:e});if(e===this.primaryPath)throw Y("DOC2");if(this.collection.schema.finalFields.includes(e))throw Y("DOC3",{path:e});var t=Nn(this.collection.schema.jsonSchema,e);if(!t)throw Y("DOC4",{path:e})}return this.$.pipe($e(r=>Mr(r,e)),Di())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=Nn(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return oc;if(!t)throw Y("DOC5",{path:e});if(!t.ref)throw Y("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw Y("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(i=>{var o=i.values();return Array.from(o)}):n.findOne(r).exec()},get(e){return ld(this,e)},toJSON(e=!1){if(e)return ye.deepFreezeWhenDevMode(this._data);var t=Ie(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,ye.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return tt(this.toJSON(e))},update(e){throw we("update")},incrementalUpdate(e){throw we("update")},updateCRDT(e){throw we("crdt")},putAttachment(){throw we("attachments")},getAttachment(){throw we("attachments")},allAttachments(){throw we("attachments")},get allAttachments$(){throw we("attachments")},async modify(e,t){var r=this._data,n=await Fu(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,Fu(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=tt(t);return Object.entries(e).forEach(([n,i])=>{r[n]=i}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=Ie(e),this._data._deleted)throw Y("DOC11",{id:this.primary,document:this});await ud(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),i=n.error[0];return Za(this.collection,this.primary,e,i),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(Pt(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(Y("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var t=e.error[0];Za(this.collection,this.primary,this._data,t)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw Y("DOC14")}};function cd(e=bo){var t=function(n,i){this.collection=n,this._data=i,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function Yv(e,t,r){var n=new e(t,r);return at("createRxDocument",n),n}function ud(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),ye.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function ld(e,t){return Tt(e._propertyCache,t,()=>{var r=Mr(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return ye.deepFreezeWhenDevMode(r);var n=new Proxy(Ie(r),{get(i,o){if(typeof o!="string")return i[o];var c=o.charAt(o.length-1);if(c==="$")if(o.endsWith("$$")){var l=o.slice(0,-2);return e.get$$(mi(t+"."+l))}else{var d=o.slice(0,-1);return e.get$(mi(t+"."+d))}else if(c==="_"){var v=o.slice(0,-1);return e.populate(mi(t+"."+v))}else{var m=i[o];return typeof m=="number"||typeof m=="string"||typeof m=="boolean"?m:ld(e,mi(t+"."+o))}}});return n})}function wc(e){return e[e.length-1]}function Jv(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function Ku(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!Jv(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let i=0;i<n.length;i++){const o=n[i];if(Xv(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function Xv(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const fd=e=>!!e.queryParams.limit,Zv=e=>e.queryParams.limit===1,ey=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),ty=e=>e.changeEvent.operation==="DELETE",ry=e=>e.changeEvent.operation==="INSERT",ny=e=>e.changeEvent.operation==="UPDATE",iy=e=>fd(e)&&e.previousResults.length>=e.queryParams.limit,ay=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let i=0;i<t.length;i++){const o=t[i],c=Ku(r,o),l=Ku(n,o);if(c!==l)return!0}return!1},oy=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===t)return!0;return!1}},sy=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},cy=e=>{const t=wc(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},uy=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},ly=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=wc(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},fy=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},dy=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=wc(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},hy=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},my=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},py=e=>e.previousResults.length===0,vy={0:ry,1:ny,2:ty,3:fd,4:Zv,5:ey,6:py,7:iy,8:sy,9:cy,10:ay,11:oy,12:uy,13:ly,14:fy,15:dy,16:hy,17:my};function yy(e,t,r,n){var i=e.length,o=i-1,c=0;if(i===0)return e.push(t),0;for(var l;n<=o;)c=n+(o-n>>1),l=e[c],r(l,t)<=0?n=c+1:o=c-1;return r(l,t)<=0&&c++,e.splice(c,0,t),c}const gy=e=>{},_c=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Ec=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Sc=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},xc=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},by=e=>{Sc(e),Ec(e)},wy=e=>{xc(e),_c(e)},_y=e=>{Sc(e),_c(e)},Ey=e=>{xc(e),Ec(e)},dd=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},Sy=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===e.changeEvent.id){n[i]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},xy=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},hd=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(i=>i[e.queryParams.primaryKey]===t))return;yy(e.previousResults,r,e.queryParams.sortComparator,0)},ky=e=>{dd(e),hd(e)},Iy=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},Dy=e=>{throw new Error("Action unknownAction should never be called")},Cy=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],Oy={doNothing:gy,insertFirst:_c,insertLast:Ec,removeFirstItem:Sc,removeLastItem:xc,removeFirstInsertLast:by,removeLastInsertFirst:wy,removeFirstInsertFirst:_y,removeLastInsertLast:Ey,removeExisting:dd,replaceExisting:Sy,alwaysWrong:xy,insertAtSortPosition:hd,removeExistingAndInsertAtSortPosition:ky,runFullQueryAgain:Iy,unknownAction:Dy},Py=40;function ys(e){return e.charCodeAt(0)-Py}function Ry(e){return e?"1":"0"}function Hu(e,t){const r=[];for(let n=0,i=e.length;n<i;n+=t)r.push(e.substring(n,n+t));return r}function My(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,i=e.substring(2,n),o=Hu(i,2);for(let P=0;P<o.length;P++){const A=o[P],N=A.charAt(0),H=ys(A.charAt(1));t.set(N,H)}const c=e.substring(n,e.length-3),l=Hu(c,4);for(let P=0;P<l.length;P++){const A=l[P],N=A.charAt(0),H=A.charAt(1),Q=A.charAt(2),se=ys(A.charAt(3));if(!t.has(H))throw new Error("missing node with id "+H);if(!t.has(Q))throw new Error("missing node with id "+Q);const te=t.get(H),X=t.get(Q),ee={l:se,0:te,1:X};t.set(N,ee)}const d=e.slice(-3),v=d.charAt(0),m=d.charAt(1),y=ys(d.charAt(2)),E=t.get(v),S=t.get(m);return{l:y,0:E,1:S}}function Ly(e,t,r){let n=e,i=e.l;for(;;){const o=t[i](r),c=Ry(o);if(n=n[c],typeof n=="number"||typeof n=="string")return n;i=n.l}}const Ty="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9¡bf9¢bq9£cg9¤ck9¥cn9¦nd9§np9¨nq9©nf9ªng9«nm9¬nk9­mr9®ms9¯mt9°mj9±mk9²ml9³mn9´mc8µ³{8¶¯}8·°¤8¸³§8¹mn8º³«8»³m8¼m´4½z²4¾³w4¿zµ4À¯¶4Á°·4Â³º4Ã³¸4Äm¹4Åv¤7Æyn7ÇÀÁ7È~7É¥¤7ÊÃÄ7Ë¨n7Ìº¹7Í­°7Î®m7Ï¯°7Ð±m7Ñ³m7Ò¼m5ÓÄm5Ô¹m5Õ½°5Ö¾m5×¿°5ØÇÏ5ÙÂm5ÚÊÑ5Û±m5Üºm5ÝÌÑ5ÞÕÍ2ß|2à¡u2á£Å2âÖÎ2ã¦Æ2ä©x2åªÆ2æ×Ø2ç|È2è¡¢2é£É2ê¤¥2ëÙÚ2ì¦Ë2í©n2îªn2ïÛÐ2ðÜÝ2ñ¬n2òÒÓ/óan/ôbn/õcn/öÞâ/÷ßã/øàä/ùáå/úæë/ûçì/üèí/ýéî/þÍÎ/ÿÏÑ/ĀòÔ,ācn,Ăöï,ă¤ñ,Ąúð,ąêñ,ĆþÐ,ćÿÑ,Ĉac0ĉbc0Ċóõ0ċôā0Čßá0čà¤0Ďçé0ďèê0Đ÷ù0đøă0Ēûý0ēüą0ĔmÒ-ĕmĀ-ĖÞæ-ėČĎ-Ęčď-ęĂĄ-ĚĐĒ-ěđē-Ĝ²»-ĝÍÏ-ĞĆć-ğ²³-ĠĔĈ3ġĕĊ3ĢĖė3ģęĚ3ĤĢĝ(ĥĜğ(ĦģĞ(ħĠġ+Ĩĉċ+ĩĤĦ+ĪĘě+īħĨ1ĬĩĪ1ĭĬī*Įĥm*ĭĮ.";let gs;function $y(){return gs||(gs=My(Ty)),gs}const Ay=e=>Ly($y(),vy,e);function By(e){const t=Ay(e);return Cy[t]}function Ny(e,t,r,n,i){const o=Oy[e];return o({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:i}),n}function jy(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var qy=new WeakMap;function Fy(e){return Tt(qy,e,()=>{var t=e.collection,r=Pn(t.storageInstance.schema,tt(e.mangoQuery)),n=t.schema.primaryPath,i=id(t.schema.jsonSchema,r),o=(v,m)=>{var y={docA:v,docB:m};return i(y.docA,y.docB)},c=gc(t.schema.jsonSchema,r),l=v=>{var m={doc:v};return c(m.doc)},d={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:jy(n,r),sortComparator:o,queryMatcher:l};return d})}function Ky(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=Fy(e),n=oe(e._result).docsData.slice(0),i=oe(e._result).docsDataMap,o=!1,c=[],l=0;l<t.length;l++){var d=t[l],v=$p(d);v&&c.push(v)}var m=c.find(y=>{var E={queryParams:r,changeEvent:y,previousResults:n,keyDocumentMap:i},S=By(E);if(S==="runFullQueryAgain")return!0;if(S!=="doNothing")return o=!0,Ny(S,r,y,n,i),!1});return m?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:o,newResults:n}}var Hy=function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var i=n.toString(),o=Tt(this._map,i,()=>n);return o},e}();function Uy(){return new Hy}function Uu(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function Wy(e){return e.refCount$.observers.length}var zy=100,Vy=30*1e3,Qy=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var i=mt()-t,o=[],c=Array.from(n._map.values());for(var l of c)if(!(Wy(l)>0)){if(l._lastEnsureEqual===0&&l._creationTime<i){Uu(n,l);continue}o.push(l)}var d=o.length-e;if(!(d<=0)){var v=o.sort((y,E)=>y._lastEnsureEqual-E._lastEnsureEqual),m=v.slice(0,d);m.forEach(y=>Uu(n,y))}}},md=Qy(zy,Vy),bs=new WeakSet;function Gy(e){bs.has(e)||(bs.add(e),dm().then(()=>vm(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),bs.delete(e)}))}var pd=function(){function e(r,n,i){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(o=>{var c=o.docId,l=this.cacheItemByDocId.get(c);l&&(l[0].delete(o.revisionHeight),l[0].size===0&&this.cacheItemByDocId.delete(c))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=i,n.subscribe(o=>{this.tasks.add(()=>{for(var c=this.cacheItemByDocId,l=0;l<o.length;l++){var d=o[l],v=c.get(d.documentId);if(v){var m=d.documentData;m||(m=d.previousDocumentData),v[1]=m}}}),this.tasks.size<=1&&fo().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var i=Bn(this.cacheItemByDocId,n);return i[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var i=this.cacheItemByDocId.get(n);if(i)return i[1]},Lr(e,[{key:"getCachedRxDocuments",get:function(){var r=Wu(this);return tr(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=Wu(this);return tr(this,"getCachedRxDocument",n=>r([n])[0])}}])}();function Wu(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,i=ye.deepFreezeWhenDevMode,o=e.documentCreator,c=l=>{for(var d=new Array(l.length),v=[],m=0;m<l.length;m++){var y=l[m],E=y[t],S=Rr(y._rev),w=void 0,P=void 0,A=r.get(E);A?(w=A[0],P=w.get(S)):(w=new Map,A=[w,y],r.set(E,A));var N=P?P.deref():void 0;N||(y=i(y),N=o(y),w.set(S,Jy(N)),n&&v.push(N)),d[m]=N}return v.length>0&&n&&(e.tasks.add(()=>{for(var H=0;H<v.length;H++){var Q=v[H];n.register(Q,{docId:Q.primary,revisionHeight:Rr(Q.revision)})}}),e.tasks.size<=1&&fo().then(()=>{e.processTasks()})),d};return c}function Ks(e,t){var r=e.getCachedRxDocuments;return r(t)}var Yy=typeof WeakRef=="function",Jy=Yy?Xy:Zy;function Xy(e){return new WeakRef(e)}function Zy(e){return{deref(){return e}}}var zu=function(){function e(r,n,i){this.time=mt(),this.query=r,this.count=i,this.documents=Ks(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var i=this.query.op;if(i==="count")return this.count;if(i==="findOne"){var o=this.documents.length===0?null:this.documents[0];if(!o&&n)throw Y("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:i});return o}else return i==="findByIds"?this.docsMap:this.documents.slice(0)},Lr(e,[{key:"docsData",get:function(){return tr(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),tr(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,i=0;i<n.length;i++){var o=n[i];r.set(o.primary,o)}return tr(this,"docsMap",r)}}])}(),eg=0,tg=function(){return++eg},vd=function(){function e(r,n,i,o={}){this.id=tg(),this._execOverDatabaseCount=0,this._creationTime=mt(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new _r(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=or,this.op=r,this.mangoQuery=n,this.collection=i,this.other=o,n||(this.mangoQuery=qa()),this.isFindOneByIdQuery=ag(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw Y("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new zu(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var i=new zu(this,n,n.length);this._result=i},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var n=this.getPreparedQuery(),i=await this.collection.storageInstance.count(n);if(i.mode==="slow"&&!this.collection.database.allowSlowCount)throw Y("QU14",{collection:this.collection,queryObj:this.mangoQuery});return i.count}if(this.op==="findByIds"){var o=oe(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,c=new Map,l=[];if(o.forEach(m=>{var y=this.collection._docCache.getLatestDocumentDataIfExists(m);if(y){if(!y._deleted){var E=this.collection._docCache.getCachedRxDocument(y);c.set(m,E)}}else l.push(m)}),l.length>0){var d=await this.collection.storageInstance.findDocumentsById(l,!1);d.forEach(m=>{var y=this.collection._docCache.getCachedRxDocument(m);c.set(y.primary,y)})}return c}var v=ig(this);return v.then(m=>m)},t.exec=async function(n){if(n&&this.op!=="findOne")throw Y("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await Vu(this);var i=oe(this._result);return i.getValue(n)},t.toString=function(){var n=Ya({op:this.op,query:Pn(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),i=JSON.stringify(n);return this.toString=()=>i,i},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:Pn(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),at("prePrepareQuery",n);var i=go(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>i,i},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=async function(){var n=await this.exec();if(Array.isArray(n)){var i=await this.collection.bulkRemove(n);if(i.error.length>0)throw Gl(i.error[0]);return i.success}else return n.remove()},t.incrementalRemove=function(){return _n(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw we("update")},t.patch=function(n){return _n(this.asRxQuery,i=>i.patch(n))},t.incrementalPatch=function(n){return _n(this.asRxQuery,i=>i.incrementalPatch(n))},t.modify=function(n){return _n(this.asRxQuery,i=>i.modify(n))},t.incrementalModify=function(n){return _n(this.asRxQuery,i=>i.incrementalModify(n))},t.where=function(n){throw we("query-builder")},t.sort=function(n){throw we("query-builder")},t.skip=function(n){throw we("query-builder")},t.limit=function(n){throw we("query-builder")},Lr(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(_e(n=>!n.isLocal),Ji(null),cr(()=>Vu(this)),$e(()=>this._result),Yi(Wi),Di((n,i)=>!!(n&&n.time===oe(i).time)),_e(n=>!!n),$e(n=>oe(n).getValue()));this._$=Bp(r,this.refCount$.pipe(_e(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=Pn(this.collection.schema.jsonSchema,this.mangoQuery);return tr(this,"queryMatcher",gc(r,n))}},{key:"asRxQuery",get:function(){return this}}])}();function qa(){return{selector:{}}}function rg(e){return e.collection._queryCache.getByQuery(e)}function En(e,t,r,n){at("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var i=new vd(e,t,r,n);return i=rg(i),Gy(r),i}function yd(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function Vu(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.closed||yd(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>ng(e)),e._ensureEqualQueue)}function ng(e){if(e._lastEnsureEqual=mt(),e.collection.database.closed||yd(e))return or;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var i=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var o=oe(e._result).count,c=o;i.forEach(d=>{var v=d.previousDocumentData&&e.doesDocumentDataMatch(d.previousDocumentData),m=e.doesDocumentDataMatch(d.documentData);!v&&m&&c++,v&&!m&&c--}),c!==o&&(t=!0,e._setResultData(c))}else{var l=Ky(e,i);l.runFullQueryAgain?r=!0:l.changed&&(t=!0,e._setResultData(l.newResults))}}}return r?e._execOverDatabase().then(d=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof d=="number"?((!e._result||d!==e._result.count)&&(t=!0,e._setResultData(d)),t):((!e._result||!lm(e.collection.schema.primaryPath,d,e._result.docsData))&&(t=!0,e._setResultData(d)),t))):Promise.resolve(t)}async function ig(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(m=>{var y=e.collection._docCache.getLatestDocumentDataIfExists(m);return y?(y._deleted||t.push(y),!1):!0}),n.length>0){var i=await r.storageInstance.findDocumentsById(n,!1);cn(t,i)}}else{var o=e.isFindOneByIdQuery,c=e.collection._docCache.getLatestDocumentDataIfExists(o);if(!c){var l=await r.storageInstance.findDocumentsById([o],!1);l[0]&&(c=l[0])}c&&!c._deleted&&t.push(c)}else{var d=e.getPreparedQuery(),v=await r.storageInstance.query(d);t=v.documents}return t}function ag(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var nn="collection",kc="storage-token",Fa="rx-migration-status",og="rx-pipeline-checkpoint",sg="RxInternalDocument",Ic=mo({version:0,title:sg,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[nn,kc,Fa,og,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function Un(e,t){return dn(Ic,{key:e,context:t})}async function gd(e){var t=go(e.schema,{selector:{context:nn,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var bd="storageToken",cg=Un(bd,kc);async function ug(e){var t=Ui(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:cg,context:kc,key:bd,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:Qn(),_rev:Lt(),_attachments:{}},i=[{document:n}],o=await e.internalStore.bulkWrite(i,"internal-add-storage-token");if(!o.error[0])return Pt("id",i,o)[0];var c=oe(o.error[0]);if(c.isError&&ho(c)){var l=c;if(!lg(l.documentInDb.data.rxdbVersion,e.rxdbVersion))throw Y("DM5",{args:{database:e.name,databaseStateVersion:l.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==l.documentInDb.data.passwordHash)throw Y("DB1",{passwordHash:r,existingPasswordHash:l.documentInDb.data.passwordHash});var d=l.documentInDb;return oe(d)}throw c}function lg(e,t){if(!e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r==="15"&&n==="16"?!0:r===n}async function fg(e,t,r){if(e.schema.version!==r.version)throw Y("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=Hs(e.name,e.schema.jsonSchema),i=Un(n,nn);;){var o=await ea(e.database.internalStore,i),c=tt(oe(o)),l=c.data.connectedStorages.find(d=>d.collectionName===t&&d.schema.version===r.version);if(l)return;c.data.connectedStorages.push({collectionName:t,schema:r});try{await $i(e.database.internalStore,{previous:oe(o),document:c},"add-connected-storage-to-collection")}catch(d){if(!ho(d))throw d}}}function Hs(e,t){return e+"-"+t.version}function La(e,t){return t=Ie(t),t=Tm(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=Om(e.primaryPath,e.jsonSchema,t)),t._meta=Qn(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=Lt()),t}async function dg(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function wd(e,t,r,n,i,o,c,l){var d=await gd(t),v=d.filter(S=>S.data.name===i),m=[];v.forEach(S=>{m.push({collectionName:S.data.name,schema:S.data.schema,isCollection:!0}),S.data.connectedStorages.forEach(w=>m.push({collectionName:w.collectionName,isCollection:!1,schema:w.schema}))});var y=new Set;if(m=m.filter(S=>{var w=S.collectionName+"||"+S.schema.version;return y.has(w)?!1:(y.add(w),!0)}),await Promise.all(m.map(async S=>{var w=await e.createStorageInstance({collectionName:S.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:o,options:{},schema:S.schema,password:c,devMode:ye.isDevMode()});await w.remove(),S.isCollection&&await zi("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:i})})),l){var E=v.map(S=>{var w=ta(S);return w._deleted=!0,w._meta.lwt=mt(),w._rev=ar(r,S),{previous:S,document:w}});await t.bulkWrite(E,"rx-database-remove-collection-all")}}function wt(e){if(e.closed)throw Y("COL21",{collection:e.name,version:e.schema.version})}var hg=function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(_e(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&fo().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t._handleChangeEvents=function(n){var i=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(cn(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var o=i+1,c=this.eventCounterMap,l=0;l<n.length;l++){var d=n[l];c.set(d,o+l)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var i=this.buffer[0],o=this.eventCounterMap.get(i);if(n<o)return null;var c=n-o;return c},t.getFrom=function(n){this.processTasks();var i=[],o=this.getArrayIndexByPointer(n);if(o===null)return null;for(;;){var c=this.buffer[o];if(o++,c)i.push(c);else return i}},t.runFrom=function(n,i){this.processTasks();var o=this.getFrom(n);if(o===null)throw new Error("out of bounds");o.forEach(c=>i(c))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.close=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e}();function mg(e){return new hg(e)}var pg=new WeakMap;function vg(e){var t=e.schema.getDocumentPrototype(),r=bg(e),n=bo,i={};return[t,r,n].forEach(o=>{var c=Object.getOwnPropertyNames(o);c.forEach(l=>{var d=Object.getOwnPropertyDescriptor(o,l),v=!0;(l.startsWith("_")||l.endsWith("_")||l.startsWith("$")||l.endsWith("$"))&&(v=!1),typeof d.value=="function"?Object.defineProperty(i,l,{get(){return d.value.bind(this)},enumerable:v,configurable:!1}):(d.enumerable=v,d.configurable=!1,d.writable&&(d.writable=!1),Object.defineProperty(i,l,d))})}),i}function yg(e){return Tt(pg,e,()=>cd(vg(e)))}function gg(e,t,r){var n=Yv(t,e,ye.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),at("postCreateRxDocument",n),n}function bg(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}var eo={isEqual(e,t){return xi(Ft(e),Ft(t))},resolve(e){return e.realMasterState}},_d=["pre","post"],Ed=["insert","save","remove","create"],Qu=!1,Sn=new Set,Sd=function(){function e(r,n,i,o,c={},l={},d={},v={},m={},y=md,E={},S=eo){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=Uy(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=i,this.internalStorageInstance=o,this.instanceCreationOptions=c,this.migrationStrategies=l,this.methods=d,this.attachments=v,this.options=m,this.cacheReplacementPolicy=y,this.statics=E,this.conflictHandler=S,wg(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(_e(w=>w.collectionName===this.name))),this.database&&Sn.add(this)}var t=e.prototype;return t.prepare=async function(){if(!await Wl()){for(var n=0;n<10&&Sn.size>Su;)n++,await this.promiseWait(30);if(Sn.size>Su)throw Y("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(Sn.values()).map(d=>({db:d.database?d.database.name:"",c:d.name}))}})}this.storageInstance=bc(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new sd(this.storageInstance,this.schema.primaryPath,(d,v)=>ud(this,d,v),d=>this._runHooks("post","save",d)),this.$=this.eventBulks$.pipe(cr(d=>bf(d))),this.checkpoint$=this.eventBulks$.pipe($e(d=>d.checkpoint)),this._changeEventBuffer=mg(this.asRxCollection);var i;this._docCache=new pd(this.schema.primaryPath,this.eventBulks$.pipe(_e(d=>!d.isLocal),$e(d=>d.events)),d=>(i||(i=yg(this.asRxCollection)),gg(this.asRxCollection,i,d)));var o=this.database.internalStore.changeStream().pipe(_e(d=>{var v=this.name+"-"+this.schema.version,m=d.events.find(y=>y.documentData.context==="collection"&&y.documentData.key===v&&y.operation==="DELETE");return!!m})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(d=>d()))});this._subs.push(o);var c=await this.database.storageToken,l=this.storageInstance.changeStream().subscribe(d=>{var v={id:d.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:c,events:d.events,databaseToken:this.database.token,checkpoint:d.checkpoint,context:d.context};this.database.$emit(v)});return this._subs.push(l),It},t.cleanup=function(n){throw wt(this),we("cleanup")},t.migrationNeeded=function(){throw we("migration-schema")},t.getMigrationState=function(){throw we("migration-schema")},t.startMigration=function(n=10){return wt(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){wt(this);var i=await this.bulkInsert([n]),o=i.error[0];Za(this,n[this.schema.primaryPath],n,o);var c=oe(i.success[0]);return c},t.insertIfNotExists=async function(n){var i=await this.bulkInsert([n]);if(i.error.length>0){var o=i.error[0];if(o.status===409){var c=o.documentInDb;return Ks(this._docCache,[c])[0]}else throw o}return i.success[0]},t.bulkInsert=async function(n){if(wt(this),n.length===0)return{success:[],error:[]};var i=this.schema.primaryPath,o=new Set,c;if(this.hasHooks("pre","insert"))c=await Promise.all(n.map(A=>{var N=La(this.schema,A);return this._runHooks("pre","insert",N).then(()=>(o.add(N[i]),{document:N}))}));else{c=new Array(n.length);for(var l=this.schema,d=0;d<n.length;d++){var v=n[d],m=La(l,v);o.add(m[i]),c[d]={document:m}}}if(o.size!==n.length)throw Y("COL22",{collection:this.name,args:{documents:n}});var y=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-insert"),E,S=this,w={get success(){if(!E){var A=Pt(S.schema.primaryPath,c,y);E=Ks(S._docCache,A)}return E},error:y.error};if(this.hasHooks("post","insert")){var P=new Map;c.forEach(A=>{var N=A.document;P.set(N[i],N)}),await Promise.all(w.success.map(A=>this._runHooks("post","insert",P.get(A.primary),A)))}return w},t.bulkRemove=async function(n){wt(this);var i=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var o;typeof n[0]=="string"?o=await this.findByIds(n).exec():(o=new Map,n.forEach(S=>o.set(S.primary,S)));var c=[],l=new Map;Array.from(o.values()).forEach(S=>{var w=S.toMutableJSON(!0);c.push(w),l.set(S.primary,w)}),await Promise.all(c.map(S=>{var w=S[this.schema.primaryPath];return this._runHooks("pre","remove",S,o.get(w))}));var d=c.map(S=>{var w=Ie(S);return w._deleted=!0,{previous:S,document:w}}),v=await this.storageInstance.bulkWrite(d,"rx-collection-bulk-remove"),m=Pt(this.schema.primaryPath,d,v),y=[],E=m.map(S=>{var w=S[i],P=this._docCache.getCachedRxDocument(S);return y.push(P),w});return await Promise.all(E.map(S=>this._runHooks("post","remove",l.get(S),o.get(S)))),{success:y,error:v.error}},t.bulkUpsert=async function(n){wt(this);var i=[],o=new Map;n.forEach(v=>{var m=La(this.schema,v),y=m[this.schema.primaryPath];if(!y)throw Y("COL3",{primaryPath:this.schema.primaryPath,data:m,schema:this.schema.jsonSchema});o.set(y,m),i.push(m)});var c=await this.bulkInsert(i),l=c.success.slice(0),d=[];return await Promise.all(c.error.map(async v=>{if(v.status!==409)d.push(v);else{var m=v.documentId,y=Bn(o,m),E=oe(v.documentInDb),S=this._docCache.getCachedRxDocuments([E])[0],w=await S.incrementalModify(()=>y);l.push(w)}})),{error:d,success:l}},t.upsert=async function(n){wt(this);var i=await this.bulkUpsert([n]);return Za(this.asRxCollection,n[this.schema.primaryPath],n,i.error[0]),i.success[0]},t.incrementalUpsert=function(n){wt(this);var i=La(this.schema,n),o=i[this.schema.primaryPath];if(!o)throw Y("COL4",{data:n});var c=this._incrementalUpsertQueues.get(o);return c||(c=It),c=c.then(()=>Eg(this,o,i)).then(l=>l.inserted?l.doc:_g(l.doc,i)),this._incrementalUpsertQueues.set(o,c),c},t.find=function(n){wt(this),at("prePrepareRxQuery",{op:"find",queryObj:n,collection:this}),n||(n=qa());var i=En("find",n,this);return i},t.findOne=function(n){wt(this),at("prePrepareRxQuery",{op:"findOne",queryObj:n,collection:this});var i;if(typeof n=="string")i=En("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=qa()),n.limit)throw Y("QU6");n=Ie(n),n.limit=1,i=En("findOne",n,this)}return i},t.count=function(n){wt(this),n||(n=qa());var i=En("count",n,this);return i},t.findByIds=function(n){wt(this);var i={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},o=En("findByIds",i,this);return o},t.exportJSON=function(){throw we("json-dump")},t.importJSON=function(n){throw we("json-dump")},t.insertCRDT=function(n){throw we("crdt")},t.addPipeline=function(n){throw we("pipeline")},t.addHook=function(n,i,o,c=!1){if(typeof o!="function")throw xt("COL7",{key:i,when:n});if(!_d.includes(n))throw xt("COL8",{key:i,when:n});if(!Ed.includes(i))throw Y("COL9",{key:i});if(n==="post"&&i==="create"&&c===!0)throw Y("COL10",{when:n,key:i,parallel:c});var l=o.bind(this),d=c?"parallel":"series";this.hooks[i]=this.hooks[i]||{},this.hooks[i][n]=this.hooks[i][n]||{series:[],parallel:[]},this.hooks[i][n][d].push(l)},t.getHooks=function(n,i){return!this.hooks[i]||!this.hooks[i][n]?{series:[],parallel:[]}:this.hooks[i][n]},t.hasHooks=function(n,i){if(!this.hooks[i]||!this.hooks[i][n])return!1;var o=this.getHooks(n,i);return o?o.series.length>0||o.parallel.length>0:!1},t._runHooks=function(n,i,o,c){var l=this.getHooks(n,i);if(!l)return It;var d=l.series.map(v=>()=>v(o,c));return ym(d).then(()=>Promise.all(l.parallel.map(v=>v(o,c))))},t._runHooksSync=function(n,i,o,c){if(this.hasHooks(n,i)){var l=this.getHooks(n,i);l&&l.series.forEach(d=>d(o,c))}},t.promiseWait=function(n){var i=new Promise(o=>{var c=setTimeout(()=>{this.timeouts.delete(c),o()},n);this.timeouts.add(c)});return i},t.close=async function(){return this.closed?or:(Sn.delete(this),await Promise.all(this.onClose.map(n=>n())),this.closed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],zi("postCloseRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(n=>n())),await wd(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},Lr(e,[{key:"insert$",get:function(){return this.$.pipe(_e(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(_e(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(_e(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])}();function wg(e){if(!Qu){Qu=!0;var t=Object.getPrototypeOf(e);Ed.forEach(r=>{_d.map(n=>{var i=n+ql(r);t[i]=function(o,c){return this.addHook(n,r,o,c)}})})}}function _g(e,t){return e.incrementalModify(r=>t)}function Eg(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(i=>i?{doc:i,inserted:!1}:e.insert(r).then(o=>({doc:o,inserted:!0})))}function Sg({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:i={},autoMigrate:o=!0,statics:c={},methods:l={},attachments:d={},options:v={},localDocuments:m=!1,cacheReplacementPolicy:y=md,conflictHandler:E=eo}){var S={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:ye.isDevMode()};return at("preCreateRxStorageInstance",S),dg(e,S).then(w=>{var P=new Sd(e,t,r,w,n,i,l,d,v,y,c,E);return P.prepare().then(()=>{Object.entries(c).forEach(([N,H])=>{Object.defineProperty(P,N,{get:()=>H.bind(P)})});var A=It;return o&&P.schema.version!==0&&(A=P.migratePromise()),A}).then(()=>(at("createRxCollection",{collection:P,creator:{name:t,schema:r,storageInstance:w,instanceCreationOptions:n,migrationStrategies:i,methods:l,attachments:d,options:v,cacheReplacementPolicy:y,localDocuments:m,statics:c}}),P)).catch(A=>(Sn.delete(P),w.close().then(()=>Promise.reject(A))))})}var xd=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};xd.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,Us(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(i){throw this.unlock(),i}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(i){return r.unlock(),i}).catch(function(i){throw r.unlock(),i})},requestIdlePromise:function(t){var r=this;t=t||{};var n,i=new Promise(function(l){return n=l}),o=function(){ws(r,i),n()};if(i._manRes=o,t.timeout){var c=setTimeout(function(){i._manRes()},t.timeout);i._timeoutObj=c}return this._iC.add(i),Us(this),i},cancelIdlePromise:function(t){ws(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,i=this.requestIdlePromise(r);return this._hPM.set(n,i),this._pHM.set(i,n),i.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return ws(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function xg(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return Us(e)},0)}}function ws(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function Us(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}xg(e),e._tryIR=!1},0)},0))}class Dc{constructor(t){Ra(this,"ttl");Ra(this,"map",new Map);Ra(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,kd()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,kg(this)},0))}clear(){this.map.clear()}}function kg(e){const t=kd()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const i=n[0];if(n[1]<t)e.map.delete(i);else return}}function kd(){return Date.now()}var Ws=new Set,Gu=new Map,Cc=function(){function e(r,n,i,o,c,l,d=!1,v={},m,y,E,S,w,P){this.idleQueue=new xd,this.rxdbVersion=Ul,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new Dt,this.closePromise=null,this.observable$=this.eventBulks$.pipe(cr(A=>bf(A))),this.storageToken=or,this.storageTokenDocument=or,this.emittedEventBulkIds=new Dc(60*1e3),this.name=r,this.token=n,this.storage=i,this.instanceCreationOptions=o,this.password=c,this.multiInstance=l,this.eventReduce=d,this.options=v,this.internalStore=m,this.hashFunction=y,this.cleanupPolicy=E,this.allowSlowCount=S,this.reactivity=w,this.onClosed=P,this.name!=="pseudoInstance"&&(this.internalStore=bc(this.asRxDatabase,m,Ic),this.storageTokenDocument=ug(this.asRxDatabase).catch(A=>this.startupErrors.push(A)),this.storageToken=this.storageTokenDocument.then(A=>A.data.token).catch(A=>this.startupErrors.push(A)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw Y("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,i){var o=await ea(this.internalStore,Un(Hs(n,i),nn));if(!o)throw Y("SNH",{name:n,schema:i});var c=ta(o);c._deleted=!0,await this.internalStore.bulkWrite([{document:c,previous:o}],"rx-database-remove-collection")},t.addCollections=async function(n){var i={},o={},c=[],l={};await Promise.all(Object.entries(n).map(async([m,y])=>{var E=m,S=y.schema;i[E]=S;var w=Bm(S,this.hashFunction);if(o[E]=w,this.collections[m])throw Y("DB3",{name:m});var P=Hs(m,S),A={id:Un(P,nn),key:P,context:nn,data:{name:E,schemaHash:await w.hash,schema:w.jsonSchema,version:w.version,connectedStorages:[]},_deleted:!1,_meta:Qn(),_rev:Lt(),_attachments:{}};c.push({document:A});var N=Object.assign({},y,{name:E,schema:w,database:this}),H=Ie(y);H.database=this,H.name=m,at("preCreateRxCollection",H),N.conflictHandler=H.conflictHandler,l[E]=N}));var d=await this.internalStore.bulkWrite(c,"rx-database-add-collection");await Pg(this),await Promise.all(d.error.map(async m=>{if(m.status!==409)throw Y("DB12",{database:this.name,writeError:m});var y=oe(m.documentInDb),E=y.data.name,S=o[E];if(y.data.schemaHash!==await S.hash)throw Y("DB6",{database:this.name,collection:E,previousSchemaHash:y.data.schemaHash,schemaHash:await S.hash,previousSchema:y.data.schema,schema:oe(i[E])})}));var v={};return await Promise.all(Object.keys(n).map(async m=>{var y=l[m],E=await Sg(y);v[m]=E,this.collections[m]=E,this[m]||Object.defineProperty(this,m,{get:()=>this.collections[m]})})),v},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw we("json-dump")},t.addState=function(n){throw we("state")},t.importJSON=function(n){throw we("json-dump")},t.backup=function(n){throw we("backup")},t.leaderElector=function(){throw we("leader-election")},t.isLeader=function(){throw we("leader-election")},t.waitForLeadership=function(){throw we("leader-election")},t.migrationStates=function(){throw we("migration-schema")},t.close=function(){if(this.closePromise)return this.closePromise;var{promise:n,resolve:i}=Id(),o=c=>{this.onClosed&&this.onClosed(),this.closed=!0,i(c)};return this.closePromise=n,(async()=>{if(await zi("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(c=>c.unsubscribe()),this.name==="pseudoInstance"){o(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(c=>c()))).then(()=>Promise.all(Object.keys(this.collections).map(c=>this.collections[c]).map(c=>c.close()))).then(()=>this.internalStore.close()).then(()=>o(!0))})(),n},t.remove=function(){return this.close().then(()=>Cg(this.name,this.storage,this.multiInstance,this.password))},Lr(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])}();function Ig(e,t){if(Ws.has(Dd(e,t)))throw Y("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function Id(){var e,t,r=new Promise((n,i)=>{e=n,t=i});return{promise:r,resolve:e,reject:t}}function Dd(e,t){return t.name+"|"+e}async function Cd(e,t,r,n,i,o){var c=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:Fv,schema:Ic,options:n,multiInstance:i,password:o,devMode:ye.isDevMode()});return c}function Dg({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i=!0,eventReduce:o=!0,ignoreDuplicate:c=!1,options:l={},cleanupPolicy:d,closeDuplicates:v=!1,allowSlowCount:m=!1,localDocuments:y=!1,hashFunction:E=jl,reactivity:S}){at("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:l,localDocuments:y});var w=Dd(r,e),P=Gu.get(w)||new Set,A=Id(),N=Array.from(P),H=()=>{P.delete(A.promise),Ws.delete(w)};return P.add(A.promise),Gu.set(w,P),(async()=>{if(v&&await Promise.all(N.map(X=>X.catch(()=>null).then(ee=>ee&&ee.close()))),c){if(!ye.isDevMode())throw Y("DB9",{database:r})}else Ig(r,e);Ws.add(w);var Q=Ui(10),se=await Cd(Q,e,r,t,i,n),te=new Cc(r,Q,e,t,n,i,o,l,se,E,d,m,S,H);return await zi("createRxDatabase",{database:te,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:l,localDocuments:y}}),te})().then(Q=>{A.resolve(Q)}).catch(Q=>{A.reject(Q),H()}),A.promise}async function Cg(e,t,r=!0,n){var i=Ui(10),o=await Cd(i,t,e,{},r,n),c=await gd(o),l=new Set;c.forEach(v=>l.add(v.data.name));var d=Array.from(l);return await Promise.all(d.map(v=>wd(t,o,i,e,v,r,n))),await zi("postRemoveRxDatabase",{databaseName:e,storage:t}),await o.remove(),d}function Og(e){return e instanceof Cc}async function Pg(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var Rg={RxSchema:Jl.prototype,RxDocument:bo,RxQuery:vd.prototype,RxCollection:Sd.prototype,RxDatabase:Cc.prototype},_s=new Set,Yu=new Set;function Ka(e){if(at("preAddRxPlugin",{plugin:e,plugins:_s}),!_s.has(e)){{if(Yu.has(e.name))throw Y("PL3",{name:e.name,plugin:e});_s.add(e),Yu.add(e.name)}if(!e.rxdb)throw xt("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(Rg[t])),e.overwritable&&Object.assign(ye,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&Ii[t].push(r.after),r.before&&Ii[t].unshift(r.before)})}}async function to(e,t){var r=dn(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),i=n[0];if(e.lastCheckpointDoc[t]=i,i)return i.checkpointData}async function ro(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var i={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:Qn(),_rev:Lt()};for(i.id=dn(e.input.metaInstance.schema,i);!e.events.canceled.getValue();){if(n&&(i.checkpointData=Ai([n.checkpointData,i.checkpointData])),i._meta.lwt=mt(),i._rev=ar(await e.checkpointKey,n),e.events.canceled.getValue())return;var o=[{previous:n,document:i}],c=await e.input.metaInstance.bulkWrite(o,"replication-set-checkpoint"),l=Pt(e.primaryPath,o,c)[0];if(l){e.lastCheckpointDoc[t]=l;return}else{var d=c.error[0];if(d.status!==409)throw d;n=oe(d.documentInDb),i._rev=ar(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function Mg(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function Ju(e,t,r,n,i){var o=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},i?i._meta:{},{lwt:mt()}),_rev:r?n._rev:Lt()});return o._rev||(o._rev=ar(e,i)),o}function Er(e,t,r){var n=Ie(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function zs(e,t){return e.hasAttachments?t.map(r=>{var n=tt(r.document);return n.docData=Ft(n.docData),{document:n,previous:r.previous}}):t}function Vs(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Ha="RxReplicationProtocolMetaData";function Xu(e,t){var r=Pm(e),n={title:Ha,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var i=mo(n);return i}function Od(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=dn(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(i=>{n[i.itemId]={docData:i.docData,metaDocument:i}}),n})}async function no(e,t,r,n){var i=t[e.primaryPath],o=r?ta(r):{id:"",isCheckpoint:"0",itemId:i,docData:t,_attachments:{},_deleted:!1,_rev:Lt(),_meta:{lwt:0}};o.docData=t,n&&(o.isResolvedConflict=n),o._meta.lwt=mt(),o.id=dn(e.input.metaInstance.schema,o),o._rev=ar(await e.checkpointKey,r);var c={previous:r,document:o};return c}async function Lg(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await to(e,"down");t||await ro(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,i=0,o=[];function c(w){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var P={time:i++,task:w};o.push(P),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var A=[];o.length>0;){e.events.active.down.next(!0);var N=oe(o.shift());if(!(N.time<d)){if(N.task==="RESYNC")if(A.length===0){A.push(N.task);break}else break;A.push(N.task)}}if(A.length!==0)return A[0]==="RESYNC"?v():m(A)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(c("RESYNC"),!e.events.canceled.getValue()){var l=n.masterChangeStream$.pipe(cr(async w=>(await rn(e.events.active.up.pipe(_e(P=>!P))),w))).subscribe(w=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,c(w)});rn(e.events.canceled.pipe(_e(w=>!!w))).then(()=>l.unsubscribe())}var d=-1;async function v(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>to(e,"down"));for(var w=await e.checkpointQueue,P=[];!e.events.canceled.getValue();){d=i++;var A=await n.masterChangesSince(w,e.input.pullBatchSize);if(A.documents.length===0||(w=Ai([w,A.checkpoint]),P.push(S(A.documents,w)),A.documents.length<e.input.pullBatchSize))break}await Promise.all(P)}}function m(w){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var P=[],A=null;return w.forEach(N=>{if(N==="RESYNC")throw new Error("SNH");cn(P,N.documents),A=Ai([A,N.checkpoint])}),S(P,oe(A))}var y=It,E={docs:{}};function S(w,P){var A=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,w.forEach(N=>{var H=N[A];E.docs[H]=N}),E.checkpoint=P,y=y.then(()=>{var N=E.docs;E.docs={};var H=E.checkpoint,Q=Object.keys(N);if(e.events.canceled.getValue()||Q.length===0)return It;var se=[],te={},X={},ee=[];return Promise.all([e.input.forkInstance.findDocumentsById(Q,!0),Od(e,Q)]).then(([me,be])=>{var Be=new Map;return me.forEach(De=>Be.set(De[A],De)),Promise.all(Q.map(async De=>{var le=Be.get(De),Ee=le?Er(le,e.hasAttachments,!1):void 0,Ne=N[De],Ce=be[De];Ce&&le&&Ce.metaDocument.isResolvedConflict===le._rev&&await e.streamQueue.up;var st=!Ce||!Ee?!1:e.input.conflictHandler.isEqual(Ce.docData,Ee,"downstream-check-if-equal-0");if(!st&&Ce&&Ce.docData._rev&&le&&le._meta[e.input.identifier]&&Rr(le._rev)===le._meta[e.input.identifier]&&(st=!0),le&&Ce&&st===!1||le&&!Ce)return It;var zt=Ee?e.input.conflictHandler.isEqual(Ne,Ee,"downstream-check-if-equal-1"):!1;if(Ee&&zt)return(!Ce||st===!1)&&ee.push(await no(e,Ee,Ce?Ce.metaDocument:void 0)),It;var Pe=Object.assign({},Ne,le?{_meta:Ie(le._meta),_attachments:e.hasAttachments&&Ne._attachments?Ne._attachments:{},_rev:Lt()}:{_meta:{lwt:mt()},_rev:Lt(),_attachments:e.hasAttachments&&Ne._attachments?Ne._attachments:{}});if(Ne._rev){var Xe=le?Rr(le._rev)+1:1;Pe._meta[e.input.identifier]=Xe,e.input.keepMeta&&(Pe._rev=Ne._rev)}e.input.keepMeta&&Ne._meta&&(Pe._meta=Ne._meta);var re={previous:le,document:Pe};re.document._rev=re.document._rev?re.document._rev:ar(r,re.previous),se.push(re),te[De]=re,X[De]=await no(e,Ne,Ce?Ce.metaDocument:void 0)}))}).then(async()=>{if(se.length>0)return e.input.forkInstance.bulkWrite(se,await e.downstreamBulkWriteFlag).then(me=>{var be=Pt(e.primaryPath,se,me);be.forEach(De=>{var le=De[A];e.events.processed.down.next(te[le]),ee.push(X[le])});var Be;if(me.error.forEach(De=>{if(De.status!==409){var le=Y("RC_PULL",{writeError:De});e.events.error.next(le),Be=le}}),Be)throw Be})}).then(()=>{if(ee.length>0)return e.input.metaInstance.bulkWrite(zs(e,ee),"replication-down-write-meta").then(me=>{me.error.forEach(be=>{e.events.error.next(Y("RC_PULL",{id:be.documentId,writeError:be}))})})}).then(()=>{ro(e,"down",H)})}).catch(N=>e.events.error.next(N)),y}}async function Tg(e,t,r){var n=e.input.conflictHandler,i=n.isEqual(t.realMasterState,t.newDocumentState,"replication-resolve-conflict");if(!i){var o=await n.resolve(t,"replication-resolve-conflict"),c=Object.assign({},o,{_meta:Ie(r._meta),_rev:Lt(),_attachments:Ie(r._attachments)});return c._meta.lwt=mt(),c._rev=ar(await e.checkpointKey,r),c}}async function Qs(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var i=r[e],o=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([c,l])=>{if((!o.has(c)||n&&oe(n._attachments)[c].digest!==l.digest)&&!l.data){var d=await t.getAttachmentData(i,c,l.digest);l.data=d}})),r}async function $g(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await to(e,"up");t||await ro(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>m().then(()=>y()));var n=0,i=-1,o=[],c=or,l={docs:{}},d=e.input.forkInstance.changeStream().subscribe(S=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,o.push({task:S,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>y()):y()}),v=r.masterChangeStream$.pipe(_e(S=>S==="RESYNC")).subscribe(()=>{o.push({task:"RESYNC",time:n++}),y()});rn(e.events.canceled.pipe(_e(S=>!!S))).then(()=>{d.unsubscribe(),v.unsubscribe()});async function m(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>to(e,"up"));for(var S=await e.checkpointQueue,w=new Set,P=async function(){i=n++,w.size>3&&await Promise.race(Array.from(w));var H=await ad(e.input.forkInstance,e.input.pushBatchSize,S);if(H.documents.length===0)return 1;S=Ai([S,H.checkpoint]);var Q=E(H.documents,oe(S));w.add(Q),Q.catch().then(()=>w.delete(Q))};!e.events.canceled.getValue()&&!await P(););var A=await Promise.all(w),N=A.find(H=>!!H);N?await m():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function y(){if(e.events.canceled.getValue()||o.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var S=[],w={};o.length>0;){var P=oe(o.shift());if(!(P.time<i)){if(P.task==="RESYNC"){e.events.active.up.next(!1),await m();return}P.task.context!==await e.downstreamBulkWriteFlag&&cn(S,P.task.events.map(A=>A.documentData)),w=Ai([w,P.task.checkpoint])}}if(await E(S,w),o.length===0)e.events.active.up.next(!1);else return y()})}function E(S,w){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,S.forEach(P=>{var A=P[e.primaryPath];l.docs[A]=P}),l.checkpoint=w,c=c.then(async()=>{if(e.events.canceled.getValue())return!1;var P=l.docs;l.docs={};var A=l.checkpoint,N=Object.keys(P);function H(){return ro(e,"up",A)}if(N.length===0)return H(),!1;var Q=await Od(e,N),se={},te=[],X={},ee={};if(await Promise.all(N.map(async re=>{var xe=P[re];ee[re]=xe;var Ve=Er(xe,e.hasAttachments,!!e.input.keepMeta),de=Q[re];de&&de.metaDocument.isResolvedConflict!==xe._rev&&e.input.conflictHandler.isEqual(de.docData,Ve,"upstream-check-if-equal")||de&&de.docData._rev&&Rr(xe._rev)===xe._meta[e.input.identifier]||(te.push(re),se[re]={assumedMasterState:de?de.docData:void 0,newDocumentState:Ve},X[re]=await no(e,Ve,de?de.metaDocument:void 0))})),te.length===0)return H(),!1;var me=Object.values(se),be=new Set,Be={},De=am(me,e.input.pushBatchSize);await Promise.all(De.map(async re=>{e.hasAttachments&&await Promise.all(re.map(async Ve=>{Ve.newDocumentState=await Qs(e.primaryPath,e.input.forkInstance,tt(Ve.newDocumentState),Ve.assumedMasterState)}));var xe=await r.masterWrite(re);xe.forEach(Ve=>{var de=Ve[e.primaryPath];be.add(de),Be[de]=Ve})}));var le=[];if(te.forEach(re=>{be.has(re)||(e.events.processed.up.next(se[re]),le.push(X[re]))}),e.events.canceled.getValue())return!1;le.length>0&&await e.input.metaInstance.bulkWrite(zs(e,le),"replication-up-write-meta");var Ee=!1;if(be.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var Ne=[],Ce={};if(await Promise.all(Object.entries(Be).map(([re,xe])=>{var Ve=se[re],de={newDocumentState:Ve.newDocumentState,assumedMasterState:Ve.assumedMasterState,realMasterState:xe};return Tg(e,de,ee[re]).then(async Ke=>{if(Ke){e.events.resolvedConflicts.next({input:de,output:Ke}),Ne.push({previous:ee[re],document:Ke});var gt=Q[re];Ce[re]=await no(e,oe(xe),gt?gt.metaDocument:void 0,Ke._rev)}})})),Ne.length>0){Ee=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var st=await e.input.forkInstance.bulkWrite(Ne,"replication-up-write-conflict"),zt;if(st.error.forEach(re=>{if(re.status!==409){var xe=Y("RC_PUSH",{writeError:re});e.events.error.next(xe),zt=xe}}),zt)throw zt;var Pe=[],Xe=Pt(e.primaryPath,Ne,st);Xe.forEach(re=>{var xe=re[e.primaryPath];Pe.push(Ce[xe])}),Pe.length>0&&await e.input.metaInstance.bulkWrite(zs(e,Pe),"replication-up-write-conflict-meta")}}return H(),Ee}).catch(P=>(e.events.error.next(P),!1)),c}}function Ag(e){e=Ie(e),e.forkInstance=Vs(e.forkInstance),e.metaInstance=Vs(e.metaInstance);var t=Mg(e),r={primaryPath:pt(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new _r(!1),paused:new _r(!1),active:{down:new _r(!0),up:new _r(!0)},processed:{down:new Dt,up:new Dt},resolvedConflicts:new Dt,error:new Dt},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new _r(!1),up:new _r(!1)},streamQueue:{down:It,up:It},checkpointQueue:It,lastCheckpointDoc:{}};return Lg(r),$g(r),r}function Bg(e){return rn(Ep([e.firstSyncDone.down.pipe(_e(t=>!!t)),e.firstSyncDone.up.pipe(_e(t=>!!t))])).then(()=>{})}function Ng(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function jg(e,t,r,n=!1){e=Vs(e);var i=!!e.schema.attachments,o=pt(e.schema.primaryKey),c={masterChangeStream$:e.changeStream().pipe(cr(async l=>{var d={checkpoint:l.checkpoint,documents:await Promise.all(l.events.map(async v=>{var m=Er(v.documentData,i,n);return i&&(m=await Qs(o,e,tt(m),void 0)),m}))};return d})),masterChangesSince(l,d){return ad(e,d,l).then(async v=>({checkpoint:v.documents.length>0?v.checkpoint:l,documents:await Promise.all(v.documents.map(async m=>{var y=Er(m,i,n);return i&&(y=await Qs(o,e,tt(y),void 0)),y}))}))},async masterWrite(l){var d={};l.forEach(P=>{var A=P.newDocumentState[o];d[A]=P});var v=Object.keys(d),m=await e.findDocumentsById(v,!0),y=new Map;m.forEach(P=>y.set(P[o],P));var E=[],S=[];if(await Promise.all(Object.entries(d).map(([P,A])=>{var N=y.get(P);N?N&&!A.assumedMasterState?E.push(Er(N,i,n)):t.isEqual(Er(N,i,n),oe(A.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?S.push({previous:N,document:Ju(r,i,n,A.newDocumentState,N)}):E.push(Er(N,i,n)):S.push({document:Ju(r,i,n,A.newDocumentState)})})),S.length>0){var w=await e.bulkWrite(S,"replication-master-write");w.error.forEach(P=>{if(P.status!==409)throw Y("SNH",{name:"non conflict error",error:P});E.push(Er(oe(P.documentInDb),i,n))})}return E}};return c}async function qg(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}function Fg(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var Kg=Promise.resolve(!0),nr=Promise.resolve();function Yr(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function Hg(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function ra(){return Math.random().toString(36).substring(2)}var Es=0;function na(){var e=Date.now()*1e3;return e<=Es&&(e=Es+1),Es=e,e}function Ug(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var Wg=na,zg="native";function Vg(e){var t={time:na(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function Qg(e){e.bc.close(),e.subFns=[]}function Gg(e,t){try{return e.bc.postMessage(t,!1),nr}catch(r){return Promise.reject(r)}}function Yg(e,t){e.messagesCallback=t}function Jg(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Xg(){return 150}var Zg={create:Vg,close:Qg,onMessage:Yg,postMessage:Gg,canBeUsed:Jg,type:zg,averageResponseTime:Xg,microSeconds:Wg};function Oc(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var eb=na,tb="pubkey.broadcast-channel-0-",ur="messages",wo={durability:"relaxed"},rb="idb";function Pd(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function Pc(e){e.commit&&e.commit()}function nb(e){var t=Pd(),r=tb+e,n=t.open(r);return n.onupgradeneeded=function(i){var o=i.target.result;o.createObjectStore(ur,{keyPath:"id",autoIncrement:!0})},new Promise(function(i,o){n.onerror=function(c){return o(c)},n.onsuccess=function(){i(n.result)}})}function ib(e,t,r){var n=Date.now(),i={uuid:t,time:n,data:r},o=e.transaction([ur],"readwrite",wo);return new Promise(function(c,l){o.oncomplete=function(){return c()},o.onerror=function(v){return l(v)};var d=o.objectStore(ur);d.add(i),Pc(o)})}function ab(e,t){var r=e.transaction(ur,"readonly",wo),n=r.objectStore(ur),i=[],o=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var c=n.getAll(o);return new Promise(function(d,v){c.onerror=function(m){return v(m)},c.onsuccess=function(m){d(m.target.result)}})}function l(){try{return o=IDBKeyRange.bound(t+1,1/0),n.openCursor(o)}catch{return n.openCursor()}}return new Promise(function(d,v){var m=l();m.onerror=function(y){return v(y)},m.onsuccess=function(y){var E=y.target.result;E?E.value.id<t+1?E.continue(t+1):(i.push(E.value),E.continue()):(Pc(r),d(i))}})}function ob(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(ur,"readwrite",wo),n=r.objectStore(ur);return Promise.all(t.map(function(i){var o=n.delete(i);return new Promise(function(c){o.onsuccess=function(){return c()}})}))}function sb(e,t){var r=Date.now()-t,n=e.transaction(ur,"readonly",wo),i=n.objectStore(ur),o=[];return new Promise(function(c){i.openCursor().onsuccess=function(l){var d=l.target.result;if(d){var v=d.value;v.time<r?(o.push(v),d.continue()):(Pc(n),c(o))}else c(o)}})}function cb(e){return sb(e.db,e.options.idb.ttl).then(function(t){return ob(e,t.map(function(r){return r.id}))})}function ub(e,t){return t=Oc(t),nb(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:ra(),eMIs:new Dc(t.idb.ttl*2),writeBlockPromise:nr,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},Rd(n),n})}function Rd(e){e.closed||Md(e).then(function(){return Yr(e.options.idb.fallbackInterval)}).then(function(){return Rd(e)})}function lb(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function Md(e){return e.closed||!e.messagesCallback?nr:ab(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return lb(n,e)}).sort(function(n,i){return n.time-i.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),nr})}function fb(e){e.closed=!0,e.db.close()}function db(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return ib(e.db,e.uuid,t)}).then(function(){Hg(0,10)===0&&cb(e)}),e.writeBlockPromise}function hb(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,Md(e)}function mb(){return!!Pd()}function pb(e){return e.idb.fallbackInterval*2}var vb={create:ub,close:fb,onMessage:hb,postMessage:db,canBeUsed:mb,type:rb,averageResponseTime:pb,microSeconds:eb},yb=na,gb="pubkey.broadcastChannel-",bb="localstorage";function Ld(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function Td(e){return gb+e}function wb(e,t){return new Promise(function(r){Yr().then(function(){var n=Td(e.channelName),i={token:ra(),time:Date.now(),data:t,uuid:e.uuid},o=JSON.stringify(i);Ld().setItem(n,o);var c=document.createEvent("Event");c.initEvent("storage",!0,!0),c.key=n,c.newValue=o,window.dispatchEvent(c),r()})})}function _b(e,t){var r=Td(e),n=function(o){o.key===r&&t(JSON.parse(o.newValue))};return window.addEventListener("storage",n),n}function Eb(e){window.removeEventListener("storage",e)}function Sb(e,t){if(t=Oc(t),!$d())throw new Error("BroadcastChannel: localstorage cannot be used");var r=ra(),n=new Dc(t.localstorage.removeTimeout),i={channelName:e,uuid:r,eMIs:n};return i.listener=_b(e,function(o){i.messagesCallback&&o.uuid!==r&&(!o.token||n.has(o.token)||o.data.time&&o.data.time<i.messagesCallbackTime||(n.add(o.token),i.messagesCallback(o.data)))}),i}function xb(e){Eb(e.listener)}function kb(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function $d(){var e=Ld();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function Ib(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var Db={create:Sb,close:xb,onMessage:kb,postMessage:wb,canBeUsed:$d,type:bb,averageResponseTime:Ib,microSeconds:yb},Ad=na,Cb="simulate",Rc=new Set;function Ob(e){var t={time:Ad(),name:e,messagesCallback:null};return Rc.add(t),t}function Pb(e){Rc.delete(e)}var Bd=5;function Rb(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(Rc);n.forEach(function(i){i.name===e.name&&i!==e&&i.messagesCallback&&i.time<t.time&&i.messagesCallback(t)}),r()},Bd)})}function Mb(e,t){e.messagesCallback=t}function Lb(){return!0}function Tb(){return Bd}var $b={create:Ob,close:Pb,onMessage:Mb,postMessage:Rb,canBeUsed:Lb,type:Cb,averageResponseTime:Tb,microSeconds:Ad},Zu=[Zg,vb,Db];function Ab(e){var t=[].concat(e.methods,Zu).filter(Boolean);if(e.type){if(e.type==="simulate")return $b;var r=t.find(function(i){return i.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(i){return i.type!=="idb"}));var n=t.find(function(i){return i.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(Zu.map(function(i){return i.type})))}var Nd=new Set,Bb=0,_o=function(t,r){this.id=Bb++,Nd.add(this),this.name=t,this.options=Oc(r),this.method=Ab(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,Nb(this)};_o._pubkey=!0;_o.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return el(this,"message",t)},postInternal:function(t){return el(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};rl(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,tl(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),i={time:n,fn:r};tl(this,t,i)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(i){return i.fn===r});rl(this,t,n)},close:function(){var t=this;if(!this.closed){Nd.delete(this),this.closed=!0;var r=this._prepP?this._prepP:nr;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function el(e,t,r){var n=e.method.microSeconds(),i={time:n,type:t,data:r},o=e._prepP?e._prepP:nr;return o.then(function(){var c=e.method.postMessage(e._state,i);return e._uMP.add(c),c.catch().then(function(){return e._uMP.delete(c)}),c})}function Nb(e){var t=e.method.create(e.name,e.options);Fg(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function jd(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function tl(e,t,r){e._addEL[t].push(r),jb(e)}function rl(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),qb(e)}function jb(e){if(!e._iL&&jd(e)){var t=function(i){e._addEL[i.type].forEach(function(o){i.time>=o.time&&o.fn(i.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function qb(e){if(e._iL&&!jd(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function Fb(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function Kb(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var Hb=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",Ub=Hb?Kb:Fb,gi=new Set,nl=!1;function Wb(){nl||(nl=!0,Ub(Vb))}function zb(e){if(Wb(),typeof e!="function")throw new Error("Listener is no function");gi.add(e);var t={remove:function(){return gi.delete(e)},run:function(){return gi.delete(e),e()}};return t}function Vb(){var e=[];return gi.forEach(function(t){e.push(t()),gi.delete(t)}),Promise.all(e)}function an(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function qd(e){e.isLeader=!0,e._hasLeader=!0;var t=zb(function(){return e.die()});e._unl.push(t);var r=function(i){i.context==="leader"&&i.action==="apply"&&an(e,"tell"),i.context==="leader"&&i.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),an(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),an(e,"tell")}var Fd=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=ra(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};Fd.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(i){return i.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,i){t._wKMC.res=n,t._wKMC.rej=i});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,qd(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),an(this,"death")}};var Kd=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=ra(),this._aplQ=nr,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=function(c){c.context==="leader"&&(c.action==="death"&&(n._hasLeader=!1),c.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};Kd.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return Yr(0,!0);if(this.isDead)return Yr(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return Kg;var o=!1,c,l=new Promise(function(m){c=function(){o=!0,m()}}),d=function(y){y.context==="leader"&&y.token!=r.token&&(y.action==="apply"&&y.token>r.token&&c(),y.action==="tell"&&(c(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",d);var v=t?r._options.responseTime*4:r._options.responseTime;return an(r,"apply").then(function(){return Promise.race([Yr(v),l.then(function(){return Promise.reject(new Error)})])}).then(function(){return an(r,"apply")}).then(function(){return Promise.race([Yr(v),l.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",d),o?!1:qd(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=Qb(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,an(this,"death")}};function Qb(e){return e.isLeader?nr:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",o),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var i=function(){return Yr(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():i()})})};i();var o=function(l){l.context==="leader"&&l.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)})}function Gb(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function Yb(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=Gb(t,e);var r=Ug()?new Fd(e,t):new Kd(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var io=new Map;function Jb(e,t,r,n){var i=io.get(t);return i||(i={bc:new _o(["RxDB:",e,r].join("|")),refs:new Set},io.set(t,i)),i.refs.add(n),i.bc}function il(e,t){var r=io.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return io.delete(e),r.bc.close()}function Xb(e,t,r,n){if(t.multiInstance){var i=Jb(e,t.databaseInstanceToken,r.databaseName,r),o=new Dt,c=E=>{E.storageName===e&&E.databaseName===t.databaseName&&E.collectionName===t.collectionName&&E.version===t.schema.version&&o.next(E.eventBulk)};i.addEventListener("message",c);var l=r.changeStream(),d=!1,v=l.subscribe(E=>{d||i.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:E})});r.changeStream=function(){return o.asObservable().pipe(Rp(l))};var m=r.close.bind(r);r.close=async function(){return d=!0,v.unsubscribe(),i.removeEventListener("message",c),await il(t.databaseInstanceToken,r),m()};var y=r.remove.bind(r);r.remove=async function(){return d=!0,v.unsubscribe(),i.removeEventListener("message",c),await il(t.databaseInstanceToken,r),y()}}}var Zb=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ew(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ua={exports:{}},tw=Ua.exports,al;function rw(){return al||(al=1,function(e,t){(function(r,n){e.exports=n()})(tw,function(){var r=function(a,s){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(u[h]=f[h])})(a,s)},n=function(){return(n=Object.assign||function(a){for(var s,u=1,f=arguments.length;u<f;u++)for(var h in s=arguments[u])Object.prototype.hasOwnProperty.call(s,h)&&(a[h]=s[h]);return a}).apply(this,arguments)};function i(a,s,u){for(var f,h=0,p=s.length;h<p;h++)!f&&h in s||((f=f||Array.prototype.slice.call(s,0,h))[h]=s[h]);return a.concat(f||Array.prototype.slice.call(s))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Zb,c=Object.keys,l=Array.isArray;function d(a,s){return typeof s!="object"||c(s).forEach(function(u){a[u]=s[u]}),a}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var v=Object.getPrototypeOf,m={}.hasOwnProperty;function y(a,s){return m.call(a,s)}function E(a,s){typeof s=="function"&&(s=s(v(a))),(typeof Reflect>"u"?c:Reflect.ownKeys)(s).forEach(function(u){w(a,u,s[u])})}var S=Object.defineProperty;function w(a,s,u,f){S(a,s,d(u&&y(u,"get")&&typeof u.get=="function"?{get:u.get,set:u.set,configurable:!0}:{value:u,configurable:!0,writable:!0},f))}function P(a){return{from:function(s){return a.prototype=Object.create(s.prototype),w(a.prototype,"constructor",a),{extend:E.bind(null,a.prototype)}}}}var A=Object.getOwnPropertyDescriptor,N=[].slice;function H(a,s,u){return N.call(a,s,u)}function Q(a,s){return s(a)}function se(a){if(!a)throw new Error("Assertion Failed")}function te(a){o.setImmediate?setImmediate(a):setTimeout(a,0)}function X(a,s){if(typeof s=="string"&&y(a,s))return a[s];if(!s)return a;if(typeof s!="string"){for(var u=[],f=0,h=s.length;f<h;++f){var p=X(a,s[f]);u.push(p)}return u}var g=s.indexOf(".");if(g!==-1){var b=a[s.substr(0,g)];return b==null?void 0:X(b,s.substr(g+1))}}function ee(a,s,u){if(a&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof s!="string"&&"length"in s){se(typeof u!="string"&&"length"in u);for(var f=0,h=s.length;f<h;++f)ee(a,s[f],u[f])}else{var p,g,b=s.indexOf(".");b!==-1?(p=s.substr(0,b),(g=s.substr(b+1))===""?u===void 0?l(a)&&!isNaN(parseInt(p))?a.splice(p,1):delete a[p]:a[p]=u:ee(b=!(b=a[p])||!y(a,p)?a[p]={}:b,g,u)):u===void 0?l(a)&&!isNaN(parseInt(s))?a.splice(s,1):delete a[s]:a[s]=u}}function me(a){var s,u={};for(s in a)y(a,s)&&(u[s]=a[s]);return u}var be=[].concat;function Be(a){return be.apply([],a)}var Qt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Be([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(s){return s+a+"Array"})}))).filter(function(a){return o[a]}),De=new Set(Qt.map(function(a){return o[a]})),le=null;function Ee(a){return le=new WeakMap,a=function s(u){if(!u||typeof u!="object")return u;var f=le.get(u);if(f)return f;if(l(u)){f=[],le.set(u,f);for(var h=0,p=u.length;h<p;++h)f.push(s(u[h]))}else if(De.has(u.constructor))f=u;else{var g,b=v(u);for(g in f=b===Object.prototype?{}:Object.create(b),le.set(u,f),u)y(u,g)&&(f[g]=s(u[g]))}return f}(a),le=null,a}var Ne={}.toString;function Ce(a){return Ne.call(a).slice(8,-1)}var st=typeof Symbol<"u"?Symbol.iterator:"@@iterator",zt=typeof st=="symbol"?function(a){var s;return a!=null&&(s=a[st])&&s.apply(a)}:function(){return null};function Pe(a,s){return s=a.indexOf(s),0<=s&&a.splice(s,1),0<=s}var Xe={};function re(a){var s,u,f,h;if(arguments.length===1){if(l(a))return a.slice();if(this===Xe&&typeof a=="string")return[a];if(h=zt(a)){for(u=[];!(f=h.next()).done;)u.push(f.value);return u}if(a==null)return[a];if(typeof(s=a.length)!="number")return[a];for(u=new Array(s);s--;)u[s]=a[s];return u}for(s=arguments.length,u=new Array(s);s--;)u[s]=arguments[s];return u}var xe=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},ei=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],bt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ei),Ve={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function de(a,s){this.name=a,this.message=s}function Ke(a,s){return a+". Errors: "+Object.keys(s).map(function(u){return s[u].toString()}).filter(function(u,f,h){return h.indexOf(u)===f}).join(`
`)}function gt(a,s,u,f){this.failures=s,this.failedKeys=f,this.successCount=u,this.message=Ke(a,s)}function fr(a,s){this.name="BulkError",this.failures=Object.keys(s).map(function(u){return s[u]}),this.failuresByPos=s,this.message=Ke(a,this.failures)}P(de).from(Error).extend({toString:function(){return this.name+": "+this.message}}),P(gt).from(de),P(fr).from(de);var ko=bt.reduce(function(a,s){return a[s]=s+"Error",a},{}),Eh=de,Z=bt.reduce(function(a,s){var u=s+"Error";function f(h,p){this.name=u,h?typeof h=="string"?(this.message="".concat(h).concat(p?`
 `+p:""),this.inner=p||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=Ve[s]||u,this.inner=null)}return P(f).from(Eh),a[s]=f,a},{});Z.Syntax=SyntaxError,Z.Type=TypeError,Z.Range=RangeError;var qc=ei.reduce(function(a,s){return a[s+"Error"]=Z[s],a},{}),ia=bt.reduce(function(a,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(a[s+"Error"]=Z[s]),a},{});function ve(){}function Xn(a){return a}function Sh(a,s){return a==null||a===Xn?s:function(u){return s(a(u))}}function Ar(a,s){return function(){a.apply(this,arguments),s.apply(this,arguments)}}function xh(a,s){return a===ve?s:function(){var u=a.apply(this,arguments);u!==void 0&&(arguments[0]=u);var f=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var p=s.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?Ar(f,this.onsuccess):f),h&&(this.onerror=this.onerror?Ar(h,this.onerror):h),p!==void 0?p:u}}function kh(a,s){return a===ve?s:function(){a.apply(this,arguments);var u=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?Ar(u,this.onsuccess):u),f&&(this.onerror=this.onerror?Ar(f,this.onerror):f)}}function Ih(a,s){return a===ve?s:function(u){var f=a.apply(this,arguments);d(u,f);var h=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,u=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?Ar(h,this.onsuccess):h),p&&(this.onerror=this.onerror?Ar(p,this.onerror):p),f===void 0?u===void 0?void 0:u:d(f,u)}}function Dh(a,s){return a===ve?s:function(){return s.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function Io(a,s){return a===ve?s:function(){var u=a.apply(this,arguments);if(u&&typeof u.then=="function"){for(var f=this,h=arguments.length,p=new Array(h);h--;)p[h]=arguments[h];return u.then(function(){return s.apply(f,p)})}return s.apply(this,arguments)}}ia.ModifyError=gt,ia.DexieError=de,ia.BulkError=fr;var Bt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Fc(a){Bt=a}var Zn={},Kc=100,Qt=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,v(a),a];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,v(s),a]}(),ei=Qt[0],bt=Qt[1],Qt=Qt[2],bt=bt&&bt.then,Br=ei&&ei.constructor,Do=!!Qt,ti=function(a,s){ri.push([a,s]),aa&&(queueMicrotask(Oh),aa=!1)},Co=!0,aa=!0,Nr=[],oa=[],Oo=Xn,dr={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:ve,pgp:!1,env:{},finalize:ve},J=dr,ri=[],jr=0,sa=[];function V(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=J;if(typeof a!="function"){if(a!==Zn)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Ro(this,this._value))}this._state=null,this._value=null,++s.ref,function u(f,h){try{h(function(p){if(f._state===null){if(p===f)throw new TypeError("A promise cannot be resolved with itself.");var g=f._lib&&mn();p&&typeof p.then=="function"?u(f,function(b,x){p instanceof V?p._then(b,x):p.then(b,x)}):(f._state=!0,f._value=p,Uc(f)),g&&pn()}},Ro.bind(null,f))}catch(p){Ro(f,p)}}(this,a)}var Po={get:function(){var a=J,s=fa;function u(f,h){var p=this,g=!a.global&&(a!==J||s!==fa),b=g&&!mr(),x=new V(function(I,O){Mo(p,new Hc(zc(f,a,g,b),zc(h,a,g,b),I,O,a))});return this._consoleTask&&(x._consoleTask=this._consoleTask),x}return u.prototype=Zn,u},set:function(a){w(this,"then",a&&a.prototype===Zn?Po:{get:function(){return a},set:Po.set})}};function Hc(a,s,u,f,h){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof s=="function"?s:null,this.resolve=u,this.reject=f,this.psd=h}function Ro(a,s){var u,f;oa.push(s),a._state===null&&(u=a._lib&&mn(),s=Oo(s),a._state=!1,a._value=s,f=a,Nr.some(function(h){return h._value===f._value})||Nr.push(f),Uc(a),u&&pn())}function Uc(a){var s=a._listeners;a._listeners=[];for(var u=0,f=s.length;u<f;++u)Mo(a,s[u]);var h=a._PSD;--h.ref||h.finalize(),jr===0&&(++jr,ti(function(){--jr==0&&Lo()},[]))}function Mo(a,s){if(a._state!==null){var u=a._state?s.onFulfilled:s.onRejected;if(u===null)return(a._state?s.resolve:s.reject)(a._value);++s.psd.ref,++jr,ti(Ch,[u,a,s])}else a._listeners.push(s)}function Ch(a,s,u){try{var f,h=s._value;!s._state&&oa.length&&(oa=[]),f=Bt&&s._consoleTask?s._consoleTask.run(function(){return a(h)}):a(h),s._state||oa.indexOf(h)!==-1||function(p){for(var g=Nr.length;g;)if(Nr[--g]._value===p._value)return Nr.splice(g,1)}(s),u.resolve(f)}catch(p){u.reject(p)}finally{--jr==0&&Lo(),--u.psd.ref||u.psd.finalize()}}function Oh(){qr(dr,function(){mn()&&pn()})}function mn(){var a=Co;return aa=Co=!1,a}function pn(){var a,s,u;do for(;0<ri.length;)for(a=ri,ri=[],u=a.length,s=0;s<u;++s){var f=a[s];f[0].apply(null,f[1])}while(0<ri.length);aa=Co=!0}function Lo(){var a=Nr;Nr=[],a.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var s=sa.slice(0),u=s.length;u;)s[--u]()}function ca(a){return new V(Zn,!1,a)}function ke(a,s){var u=J;return function(){var f=mn(),h=J;try{return pr(u,!0),a.apply(this,arguments)}catch(p){s&&s(p)}finally{pr(h,!1),f&&pn()}}}E(V.prototype,{then:Po,_then:function(a,s){Mo(this,new Hc(null,null,a,s,J))},catch:function(a){if(arguments.length===1)return this.then(null,a);var s=a,u=arguments[1];return typeof s=="function"?this.then(null,function(f){return(f instanceof s?u:ca)(f)}):this.then(null,function(f){return(f&&f.name===s?u:ca)(f)})},finally:function(a){return this.then(function(s){return V.resolve(a()).then(function(){return s})},function(s){return V.resolve(a()).then(function(){return ca(s)})})},timeout:function(a,s){var u=this;return a<1/0?new V(function(f,h){var p=setTimeout(function(){return h(new Z.Timeout(s))},a);u.then(f,h).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&w(V.prototype,Symbol.toStringTag,"Dexie.Promise"),dr.env=Wc(),E(V,{all:function(){var a=re.apply(null,arguments).map(da);return new V(function(s,u){a.length===0&&s([]);var f=a.length;a.forEach(function(h,p){return V.resolve(h).then(function(g){a[p]=g,--f||s(a)},u)})})},resolve:function(a){return a instanceof V?a:a&&typeof a.then=="function"?new V(function(s,u){a.then(s,u)}):new V(Zn,!0,a)},reject:ca,race:function(){var a=re.apply(null,arguments).map(da);return new V(function(s,u){a.map(function(f){return V.resolve(f).then(s,u)})})},PSD:{get:function(){return J},set:function(a){return J=a}},totalEchoes:{get:function(){return fa}},newPSD:hr,usePSD:qr,scheduler:{get:function(){return ti},set:function(a){ti=a}},rejectionMapper:{get:function(){return Oo},set:function(a){Oo=a}},follow:function(a,s){return new V(function(u,f){return hr(function(h,p){var g=J;g.unhandleds=[],g.onunhandled=p,g.finalize=Ar(function(){var b,x=this;b=function(){x.unhandleds.length===0?h():p(x.unhandleds[0])},sa.push(function I(){b(),sa.splice(sa.indexOf(I),1)}),++jr,ti(function(){--jr==0&&Lo()},[])},g.finalize),a()},s,u,f)})}}),Br&&(Br.allSettled&&w(V,"allSettled",function(){var a=re.apply(null,arguments).map(da);return new V(function(s){a.length===0&&s([]);var u=a.length,f=new Array(u);a.forEach(function(h,p){return V.resolve(h).then(function(g){return f[p]={status:"fulfilled",value:g}},function(g){return f[p]={status:"rejected",reason:g}}).then(function(){return--u||s(f)})})})}),Br.any&&typeof AggregateError<"u"&&w(V,"any",function(){var a=re.apply(null,arguments).map(da);return new V(function(s,u){a.length===0&&u(new AggregateError([]));var f=a.length,h=new Array(f);a.forEach(function(p,g){return V.resolve(p).then(function(b){return s(b)},function(b){h[g]=b,--f||u(new AggregateError(h))})})})}),Br.withResolvers&&(V.withResolvers=Br.withResolvers));var He={awaits:0,echoes:0,id:0},Ph=0,ua=[],la=0,fa=0,Rh=0;function hr(a,s,u,f){var h=J,p=Object.create(h);return p.parent=h,p.ref=0,p.global=!1,p.id=++Rh,dr.env,p.env=Do?{Promise:V,PromiseProp:{value:V,configurable:!0,writable:!0},all:V.all,race:V.race,allSettled:V.allSettled,any:V.any,resolve:V.resolve,reject:V.reject}:{},s&&d(p,s),++h.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},f=qr(p,a,u,f),p.ref===0&&p.finalize(),f}function vn(){return He.id||(He.id=++Ph),++He.awaits,He.echoes+=Kc,He.id}function mr(){return!!He.awaits&&(--He.awaits==0&&(He.id=0),He.echoes=He.awaits*Kc,!0)}function da(a){return He.echoes&&a&&a.constructor===Br?(vn(),a.then(function(s){return mr(),s},function(s){return mr(),Re(s)})):a}function Mh(){var a=ua[ua.length-1];ua.pop(),pr(a,!1)}function pr(a,s){var u,f=J;(s?!He.echoes||la++&&a===J:!la||--la&&a===J)||queueMicrotask(s?(function(h){++fa,He.echoes&&--He.echoes!=0||(He.echoes=He.awaits=He.id=0),ua.push(J),pr(h,!0)}).bind(null,a):Mh),a!==J&&(J=a,f===dr&&(dr.env=Wc()),Do&&(u=dr.env.Promise,s=a.env,(f.global||a.global)&&(Object.defineProperty(o,"Promise",s.PromiseProp),u.all=s.all,u.race=s.race,u.resolve=s.resolve,u.reject=s.reject,s.allSettled&&(u.allSettled=s.allSettled),s.any&&(u.any=s.any))))}function Wc(){var a=o.Promise;return Do?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function qr(a,s,u,f,h){var p=J;try{return pr(a,!0),s(u,f,h)}finally{pr(p,!1)}}function zc(a,s,u,f){return typeof a!="function"?a:function(){var h=J;u&&vn(),pr(s,!0);try{return a.apply(this,arguments)}finally{pr(h,!1),f&&queueMicrotask(mr)}}}function To(a){Promise===Br&&He.echoes===0?la===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+bt).indexOf("[native code]")===-1&&(vn=mr=ve);var Re=V.reject,Fr="￿",Vt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Vc="String expected.",yn=[],ha="__dbnames",$o="readonly",Ao="readwrite";function Kr(a,s){return a?s?function(){return a.apply(this,arguments)&&s.apply(this,arguments)}:a:s}var Qc={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function ma(a){return typeof a!="string"||/\./.test(a)?function(s){return s}:function(s){return s[a]===void 0&&a in s&&delete(s=Ee(s))[a],s}}function Gc(){throw Z.Type()}function he(a,s){try{var u=Yc(a),f=Yc(s);if(u!==f)return u==="Array"?1:f==="Array"?-1:u==="binary"?1:f==="binary"?-1:u==="string"?1:f==="string"?-1:u==="Date"?1:f!=="Date"?NaN:-1;switch(u){case"number":case"Date":case"string":return s<a?1:a<s?-1:0;case"binary":return function(h,p){for(var g=h.length,b=p.length,x=g<b?g:b,I=0;I<x;++I)if(h[I]!==p[I])return h[I]<p[I]?-1:1;return g===b?0:g<b?-1:1}(Jc(a),Jc(s));case"Array":return function(h,p){for(var g=h.length,b=p.length,x=g<b?g:b,I=0;I<x;++I){var O=he(h[I],p[I]);if(O!==0)return O}return g===b?0:g<b?-1:1}(a,s)}}catch{}return NaN}function Yc(a){var s=typeof a;return s!="object"?s:ArrayBuffer.isView(a)?"binary":(a=Ce(a),a==="ArrayBuffer"?"binary":a)}function Jc(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}var Xc=(Se.prototype._trans=function(a,s,u){var f=this._tx||J.trans,h=this.name,p=Bt&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function g(I,O,_){if(!_.schema[h])throw new Z.NotFound("Table "+h+" not part of transaction");return s(_.idbtrans,_)}var b=mn();try{var x=f&&f.db._novip===this.db._novip?f===J.trans?f._promise(a,g,u):hr(function(){return f._promise(a,g,u)},{trans:f,transless:J.transless||J}):function I(O,_,M,k){if(O.idbdb&&(O._state.openComplete||J.letThrough||O._vip)){var C=O._createTransaction(_,M,O._dbSchema);try{C.create(),O._state.PR1398_maxLoop=3}catch(R){return R.name===ko.InvalidState&&O.isOpen()&&0<--O._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),O.close({disableAutoOpen:!1}),O.open().then(function(){return I(O,_,M,k)})):Re(R)}return C._promise(_,function(R,D){return hr(function(){return J.trans=C,k(R,D,C)})}).then(function(R){if(_==="readwrite")try{C.idbtrans.commit()}catch{}return _==="readonly"?R:C._completion.then(function(){return R})})}if(O._state.openComplete)return Re(new Z.DatabaseClosed(O._state.dbOpenError));if(!O._state.isBeingOpened){if(!O._state.autoOpen)return Re(new Z.DatabaseClosed);O.open().catch(ve)}return O._state.dbReadyPromise.then(function(){return I(O,_,M,k)})}(this.db,a,[this.name],g);return p&&(x._consoleTask=p,x=x.catch(function(I){return console.trace(I),Re(I)})),x}finally{b&&pn()}},Se.prototype.get=function(a,s){var u=this;return a&&a.constructor===Object?this.where(a).first(s):a==null?Re(new Z.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return u.core.get({trans:f,key:a}).then(function(h){return u.hook.reading.fire(h)})}).then(s)},Se.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(l(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var s=c(a);if(s.length===1)return this.where(s[0]).equals(a[s[0]]);var u=this.schema.indexes.concat(this.schema.primKey).filter(function(b){if(b.compound&&s.every(function(I){return 0<=b.keyPath.indexOf(I)})){for(var x=0;x<s.length;++x)if(s.indexOf(b.keyPath[x])===-1)return!1;return!0}return!1}).sort(function(b,x){return b.keyPath.length-x.keyPath.length})[0];if(u&&this.db._maxKey!==Fr){var p=u.keyPath.slice(0,s.length);return this.where(p).equals(p.map(function(x){return a[x]}))}!u&&Bt&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var f=this.schema.idxByName;function h(b,x){return he(b,x)===0}var g=s.reduce(function(_,x){var I=_[0],O=_[1],_=f[x],M=a[x];return[I||_,I||!_?Kr(O,_&&_.multi?function(k){return k=X(k,x),l(k)&&k.some(function(C){return h(M,C)})}:function(k){return h(M,X(k,x))}):O]},[null,null]),p=g[0],g=g[1];return p?this.where(p.name).equals(a[p.keyPath]).filter(g):u?this.filter(g):this.where(s).equals("")},Se.prototype.filter=function(a){return this.toCollection().and(a)},Se.prototype.count=function(a){return this.toCollection().count(a)},Se.prototype.offset=function(a){return this.toCollection().offset(a)},Se.prototype.limit=function(a){return this.toCollection().limit(a)},Se.prototype.each=function(a){return this.toCollection().each(a)},Se.prototype.toArray=function(a){return this.toCollection().toArray(a)},Se.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Se.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,l(a)?"[".concat(a.join("+"),"]"):a))},Se.prototype.reverse=function(){return this.toCollection().reverse()},Se.prototype.mapToClass=function(a){var s,u=this.db,f=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof Gc&&(function(x,I){if(typeof I!="function"&&I!==null)throw new TypeError("Class extends value "+String(I)+" is not a constructor or null");function O(){this.constructor=x}r(x,I),x.prototype=I===null?Object.create(I):(O.prototype=I.prototype,new O)}(h,s=a),Object.defineProperty(h.prototype,"db",{get:function(){return u},enumerable:!1,configurable:!0}),h.prototype.table=function(){return f},a=h);for(var p=new Set,g=a.prototype;g;g=v(g))Object.getOwnPropertyNames(g).forEach(function(x){return p.add(x)});function b(x){if(!x)return x;var I,O=Object.create(a.prototype);for(I in x)if(!p.has(I))try{O[I]=x[I]}catch{}return O}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=b,this.hook("reading",b),a},Se.prototype.defineClass=function(){return this.mapToClass(function(a){d(this,a)})},Se.prototype.add=function(a,s){var u=this,f=this.schema.primKey,h=f.auto,p=f.keyPath,g=a;return p&&h&&(g=ma(p)(a)),this._trans("readwrite",function(b){return u.core.mutate({trans:b,type:"add",keys:s!=null?[s]:null,values:[g]})}).then(function(b){return b.numFailures?V.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{ee(a,p,b)}catch{}return b})},Se.prototype.update=function(a,s){return typeof a!="object"||l(a)?this.where(":id").equals(a).modify(s):(a=X(a,this.schema.primKey.keyPath),a===void 0?Re(new Z.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(s))},Se.prototype.put=function(a,s){var u=this,f=this.schema.primKey,h=f.auto,p=f.keyPath,g=a;return p&&h&&(g=ma(p)(a)),this._trans("readwrite",function(b){return u.core.mutate({trans:b,type:"put",values:[g],keys:s!=null?[s]:null})}).then(function(b){return b.numFailures?V.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{ee(a,p,b)}catch{}return b})},Se.prototype.delete=function(a){var s=this;return this._trans("readwrite",function(u){return s.core.mutate({trans:u,type:"delete",keys:[a]})}).then(function(u){return u.numFailures?V.reject(u.failures[0]):void 0})},Se.prototype.clear=function(){var a=this;return this._trans("readwrite",function(s){return a.core.mutate({trans:s,type:"deleteRange",range:Qc})}).then(function(s){return s.numFailures?V.reject(s.failures[0]):void 0})},Se.prototype.bulkGet=function(a){var s=this;return this._trans("readonly",function(u){return s.core.getMany({keys:a,trans:u}).then(function(f){return f.map(function(h){return s.hook.reading.fire(h)})})})},Se.prototype.bulkAdd=function(a,s,u){var f=this,h=Array.isArray(s)?s:void 0,p=(u=u||(h?void 0:s))?u.allKeys:void 0;return this._trans("readwrite",function(g){var I=f.schema.primKey,b=I.auto,I=I.keyPath;if(I&&h)throw new Z.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,I=I&&b?a.map(ma(I)):a;return f.core.mutate({trans:g,type:"add",keys:h,values:I,wantResults:p}).then(function(C){var _=C.numFailures,M=C.results,k=C.lastResult,C=C.failures;if(_===0)return p?M:k;throw new fr("".concat(f.name,".bulkAdd(): ").concat(_," of ").concat(x," operations failed"),C)})})},Se.prototype.bulkPut=function(a,s,u){var f=this,h=Array.isArray(s)?s:void 0,p=(u=u||(h?void 0:s))?u.allKeys:void 0;return this._trans("readwrite",function(g){var I=f.schema.primKey,b=I.auto,I=I.keyPath;if(I&&h)throw new Z.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new Z.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,I=I&&b?a.map(ma(I)):a;return f.core.mutate({trans:g,type:"put",keys:h,values:I,wantResults:p}).then(function(C){var _=C.numFailures,M=C.results,k=C.lastResult,C=C.failures;if(_===0)return p?M:k;throw new fr("".concat(f.name,".bulkPut(): ").concat(_," of ").concat(x," operations failed"),C)})})},Se.prototype.bulkUpdate=function(a){var s=this,u=this.core,f=a.map(function(g){return g.key}),h=a.map(function(g){return g.changes}),p=[];return this._trans("readwrite",function(g){return u.getMany({trans:g,keys:f,cache:"clone"}).then(function(b){var x=[],I=[];a.forEach(function(_,M){var k=_.key,C=_.changes,R=b[M];if(R){for(var D=0,L=Object.keys(C);D<L.length;D++){var T=L[D],$=C[T];if(T===s.schema.primKey.keyPath){if(he($,k)!==0)throw new Z.Constraint("Cannot update primary key in bulkUpdate()")}else ee(R,T,$)}p.push(M),x.push(k),I.push(R)}});var O=x.length;return u.mutate({trans:g,type:"put",keys:x,values:I,updates:{keys:f,changeSpecs:h}}).then(function(_){var M=_.numFailures,k=_.failures;if(M===0)return O;for(var C=0,R=Object.keys(k);C<R.length;C++){var D,L=R[C],T=p[Number(L)];T!=null&&(D=k[L],delete k[L],k[T]=D)}throw new fr("".concat(s.name,".bulkUpdate(): ").concat(M," of ").concat(O," operations failed"),k)})})})},Se.prototype.bulkDelete=function(a){var s=this,u=a.length;return this._trans("readwrite",function(f){return s.core.mutate({trans:f,type:"delete",keys:a})}).then(function(g){var h=g.numFailures,p=g.lastResult,g=g.failures;if(h===0)return p;throw new fr("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(u," operations failed"),g)})},Se);function Se(){}function ni(a){function s(g,b){if(b){for(var x=arguments.length,I=new Array(x-1);--x;)I[x-1]=arguments[x];return u[g].subscribe.apply(null,I),a}if(typeof g=="string")return u[g]}var u={};s.addEventType=p;for(var f=1,h=arguments.length;f<h;++f)p(arguments[f]);return s;function p(g,b,x){if(typeof g!="object"){var I;b=b||Dh;var O={subscribers:[],fire:x=x||ve,subscribe:function(_){O.subscribers.indexOf(_)===-1&&(O.subscribers.push(_),O.fire=b(O.fire,_))},unsubscribe:function(_){O.subscribers=O.subscribers.filter(function(M){return M!==_}),O.fire=O.subscribers.reduce(b,x)}};return u[g]=s[g]=O}c(I=g).forEach(function(_){var M=I[_];if(l(M))p(_,I[_][0],I[_][1]);else{if(M!=="asap")throw new Z.InvalidArgument("Invalid event config");var k=p(_,Xn,function(){for(var C=arguments.length,R=new Array(C);C--;)R[C]=arguments[C];k.subscribers.forEach(function(D){te(function(){D.apply(null,R)})})})}})}}function ii(a,s){return P(s).from({prototype:a}),s}function gn(a,s){return!(a.filter||a.algorithm||a.or)&&(s?a.justLimit:!a.replayFilter)}function Bo(a,s){a.filter=Kr(a.filter,s)}function No(a,s,u){var f=a.replayFilter;a.replayFilter=f?function(){return Kr(f(),s())}:s,a.justLimit=u&&!f}function pa(a,s){if(a.isPrimKey)return s.primaryKey;var u=s.getIndexByKeyPath(a.index);if(!u)throw new Z.Schema("KeyPath "+a.index+" on object store "+s.name+" is not indexed");return u}function Zc(a,s,u){var f=pa(a,s.schema);return s.openCursor({trans:u,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:f,range:a.range}})}function va(a,s,u,f){var h=a.replayFilter?Kr(a.filter,a.replayFilter()):a.filter;if(a.or){var p={},g=function(b,x,I){var O,_;h&&!h(x,I,function(M){return x.stop(M)},function(M){return x.fail(M)})||((_=""+(O=x.primaryKey))=="[object ArrayBuffer]"&&(_=""+new Uint8Array(O)),y(p,_)||(p[_]=!0,s(b,x,I)))};return Promise.all([a.or._iterate(g,u),eu(Zc(a,f,u),a.algorithm,g,!a.keysOnly&&a.valueMapper)])}return eu(Zc(a,f,u),Kr(a.algorithm,h),s,!a.keysOnly&&a.valueMapper)}function eu(a,s,u,f){var h=ke(f?function(p,g,b){return u(f(p),g,b)}:u);return a.then(function(p){if(p)return p.start(function(){var g=function(){return p.continue()};s&&!s(p,function(b){return g=b},function(b){p.stop(b),g=ve},function(b){p.fail(b),g=ve})||h(p.value,p,function(b){return g=b}),g()})})}var Qt=Symbol(),ai=(tu.prototype.execute=function(a){if(this.add!==void 0){var s=this.add;if(l(s))return i(i([],l(a)?a:[],!0),s).sort();if(typeof s=="number")return(Number(a)||0)+s;if(typeof s=="bigint")try{return BigInt(a)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(this.remove!==void 0){var u=this.remove;if(l(u))return l(a)?a.filter(function(f){return!u.includes(f)}).sort():[];if(typeof u=="number")return Number(a)-u;if(typeof u=="bigint")try{return BigInt(a)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return s=(s=this.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof a=="string"&&a.startsWith(s)?this.replacePrefix[1]+a.substring(s.length):a},tu);function tu(a){Object.assign(this,a)}var Lh=(pe.prototype._read=function(a,s){var u=this._ctx;return u.error?u.table._trans(null,Re.bind(null,u.error)):u.table._trans("readonly",a).then(s)},pe.prototype._write=function(a){var s=this._ctx;return s.error?s.table._trans(null,Re.bind(null,s.error)):s.table._trans("readwrite",a,"locked")},pe.prototype._addAlgorithm=function(a){var s=this._ctx;s.algorithm=Kr(s.algorithm,a)},pe.prototype._iterate=function(a,s){return va(this._ctx,a,s,this._ctx.table.core)},pe.prototype.clone=function(a){var s=Object.create(this.constructor.prototype),u=Object.create(this._ctx);return a&&d(u,a),s._ctx=u,s},pe.prototype.raw=function(){return this._ctx.valueMapper=null,this},pe.prototype.each=function(a){var s=this._ctx;return this._read(function(u){return va(s,a,u,s.table.core)})},pe.prototype.count=function(a){var s=this;return this._read(function(u){var f=s._ctx,h=f.table.core;if(gn(f,!0))return h.count({trans:u,query:{index:pa(f,h.schema),range:f.range}}).then(function(g){return Math.min(g,f.limit)});var p=0;return va(f,function(){return++p,!1},u,h).then(function(){return p})}).then(a)},pe.prototype.sortBy=function(a,s){var u=a.split(".").reverse(),f=u[0],h=u.length-1;function p(x,I){return I?p(x[u[I]],I-1):x[f]}var g=this._ctx.dir==="next"?1:-1;function b(x,I){return he(p(x,h),p(I,h))*g}return this.toArray(function(x){return x.sort(b)}).then(s)},pe.prototype.toArray=function(a){var s=this;return this._read(function(u){var f=s._ctx;if(f.dir==="next"&&gn(f,!0)&&0<f.limit){var h=f.valueMapper,p=pa(f,f.table.core.schema);return f.table.core.query({trans:u,limit:f.limit,values:!0,query:{index:p,range:f.range}}).then(function(b){return b=b.result,h?b.map(h):b})}var g=[];return va(f,function(b){return g.push(b)},u,f.table.core).then(function(){return g})},a)},pe.prototype.offset=function(a){var s=this._ctx;return a<=0||(s.offset+=a,gn(s)?No(s,function(){var u=a;return function(f,h){return u===0||(u===1?--u:h(function(){f.advance(u),u=0}),!1)}}):No(s,function(){var u=a;return function(){return--u<0}})),this},pe.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),No(this._ctx,function(){var s=a;return function(u,f,h){return--s<=0&&f(h),0<=s}},!0),this},pe.prototype.until=function(a,s){return Bo(this._ctx,function(u,f,h){return!a(u.value)||(f(h),s)}),this},pe.prototype.first=function(a){return this.limit(1).toArray(function(s){return s[0]}).then(a)},pe.prototype.last=function(a){return this.reverse().first(a)},pe.prototype.filter=function(a){var s;return Bo(this._ctx,function(u){return a(u.value)}),(s=this._ctx).isMatch=Kr(s.isMatch,a),this},pe.prototype.and=function(a){return this.filter(a)},pe.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},pe.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},pe.prototype.desc=function(){return this.reverse()},pe.prototype.eachKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(u,f){a(f.key,f)})},pe.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},pe.prototype.eachPrimaryKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(u,f){a(f.primaryKey,f)})},pe.prototype.keys=function(a){var s=this._ctx;s.keysOnly=!s.isMatch;var u=[];return this.each(function(f,h){u.push(h.key)}).then(function(){return u}).then(a)},pe.prototype.primaryKeys=function(a){var s=this._ctx;if(s.dir==="next"&&gn(s,!0)&&0<s.limit)return this._read(function(f){var h=pa(s,s.table.core.schema);return s.table.core.query({trans:f,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(f){return f.result}).then(a);s.keysOnly=!s.isMatch;var u=[];return this.each(function(f,h){u.push(h.primaryKey)}).then(function(){return u}).then(a)},pe.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},pe.prototype.firstKey=function(a){return this.limit(1).keys(function(s){return s[0]}).then(a)},pe.prototype.lastKey=function(a){return this.reverse().firstKey(a)},pe.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var s={};return Bo(this._ctx,function(h){var f=h.primaryKey.toString(),h=y(s,f);return s[f]=!0,!h}),this},pe.prototype.modify=function(a){var s=this,u=this._ctx;return this._write(function(f){var h,p,g;g=typeof a=="function"?a:(h=c(a),p=h.length,function(D){for(var L=!1,T=0;T<p;++T){var $=h[T],B=a[$],j=X(D,$);B instanceof ai?(ee(D,$,B.execute(j)),L=!0):j!==B&&(ee(D,$,B),L=!0)}return L});var b=u.table.core,_=b.schema.primaryKey,x=_.outbound,I=_.extractKey,O=200,_=s.db._options.modifyChunkSize;_&&(O=typeof _=="object"?_[b.name]||_["*"]||200:_);function M(D,$){var T=$.failures,$=$.numFailures;C+=D-$;for(var B=0,j=c(T);B<j.length;B++){var U=j[B];k.push(T[U])}}var k=[],C=0,R=[];return s.clone().primaryKeys().then(function(D){function L($){var B=Math.min(O,D.length-$);return b.getMany({trans:f,keys:D.slice($,$+B),cache:"immutable"}).then(function(j){for(var U=[],q=[],F=x?[]:null,W=[],K=0;K<B;++K){var G=j[K],ae={value:Ee(G),primKey:D[$+K]};g.call(ae,ae.value,ae)!==!1&&(ae.value==null?W.push(D[$+K]):x||he(I(G),I(ae.value))===0?(q.push(ae.value),x&&F.push(D[$+K])):(W.push(D[$+K]),U.push(ae.value)))}return Promise.resolve(0<U.length&&b.mutate({trans:f,type:"add",values:U}).then(function(ce){for(var ue in ce.failures)W.splice(parseInt(ue),1);M(U.length,ce)})).then(function(){return(0<q.length||T&&typeof a=="object")&&b.mutate({trans:f,type:"put",keys:F,values:q,criteria:T,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<$}).then(function(ce){return M(q.length,ce)})}).then(function(){return(0<W.length||T&&a===jo)&&b.mutate({trans:f,type:"delete",keys:W,criteria:T,isAdditionalChunk:0<$}).then(function(ce){return M(W.length,ce)})}).then(function(){return D.length>$+B&&L($+O)})})}var T=gn(u)&&u.limit===1/0&&(typeof a!="function"||a===jo)&&{index:u.index,range:u.range};return L(0).then(function(){if(0<k.length)throw new gt("Error modifying one or more objects",k,C,R);return D.length})})})},pe.prototype.delete=function(){var a=this._ctx,s=a.range;return gn(a)&&(a.isPrimKey||s.type===3)?this._write(function(u){var f=a.table.core.schema.primaryKey,h=s;return a.table.core.count({trans:u,query:{index:f,range:h}}).then(function(p){return a.table.core.mutate({trans:u,type:"deleteRange",range:h}).then(function(g){var b=g.failures;if(g.lastResult,g.results,g=g.numFailures,g)throw new gt("Could not delete some values",Object.keys(b).map(function(x){return b[x]}),p-g);return p-g})})}):this.modify(jo)},pe);function pe(){}var jo=function(a,s){return s.value=null};function Th(a,s){return a<s?-1:a===s?0:1}function $h(a,s){return s<a?-1:a===s?0:1}function ct(a,s,u){return a=a instanceof nu?new a.Collection(a):a,a._ctx.error=new(u||TypeError)(s),a}function bn(a){return new a.Collection(a,function(){return ru("")}).limit(0)}function ya(a,s,u,f){var h,p,g,b,x,I,O,_=u.length;if(!u.every(function(C){return typeof C=="string"}))return ct(a,Vc);function M(C){h=C==="next"?function(D){return D.toUpperCase()}:function(D){return D.toLowerCase()},p=C==="next"?function(D){return D.toLowerCase()}:function(D){return D.toUpperCase()},g=C==="next"?Th:$h;var R=u.map(function(D){return{lower:p(D),upper:h(D)}}).sort(function(D,L){return g(D.lower,L.lower)});b=R.map(function(D){return D.upper}),x=R.map(function(D){return D.lower}),O=(I=C)==="next"?"":f}M("next"),a=new a.Collection(a,function(){return vr(b[0],x[_-1]+f)}),a._ondirectionchange=function(C){M(C)};var k=0;return a._addAlgorithm(function(C,R,D){var L=C.key;if(typeof L!="string")return!1;var T=p(L);if(s(T,x,k))return!0;for(var $=null,B=k;B<_;++B){var j=function(U,q,F,W,K,G){for(var ae=Math.min(U.length,W.length),ce=-1,ue=0;ue<ae;++ue){var ut=q[ue];if(ut!==W[ue])return K(U[ue],F[ue])<0?U.substr(0,ue)+F[ue]+F.substr(ue+1):K(U[ue],W[ue])<0?U.substr(0,ue)+W[ue]+F.substr(ue+1):0<=ce?U.substr(0,ce)+q[ce]+F.substr(ce+1):null;K(U[ue],ut)<0&&(ce=ue)}return ae<W.length&&G==="next"?U+F.substr(U.length):ae<U.length&&G==="prev"?U.substr(0,F.length):ce<0?null:U.substr(0,ce)+W[ce]+F.substr(ce+1)}(L,T,b[B],x[B],g,I);j===null&&$===null?k=B+1:($===null||0<g($,j))&&($=j)}return R($!==null?function(){C.continue($+O)}:D),!1}),a}function vr(a,s,u,f){return{type:2,lower:a,upper:s,lowerOpen:u,upperOpen:f}}function ru(a){return{type:1,lower:a,upper:a}}var nu=(Object.defineProperty(Ue.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ue.prototype.between=function(a,s,u,f){u=u!==!1,f=f===!0;try{return 0<this._cmp(a,s)||this._cmp(a,s)===0&&(u||f)&&(!u||!f)?bn(this):new this.Collection(this,function(){return vr(a,s,!u,!f)})}catch{return ct(this,Vt)}},Ue.prototype.equals=function(a){return a==null?ct(this,Vt):new this.Collection(this,function(){return ru(a)})},Ue.prototype.above=function(a){return a==null?ct(this,Vt):new this.Collection(this,function(){return vr(a,void 0,!0)})},Ue.prototype.aboveOrEqual=function(a){return a==null?ct(this,Vt):new this.Collection(this,function(){return vr(a,void 0,!1)})},Ue.prototype.below=function(a){return a==null?ct(this,Vt):new this.Collection(this,function(){return vr(void 0,a,!1,!0)})},Ue.prototype.belowOrEqual=function(a){return a==null?ct(this,Vt):new this.Collection(this,function(){return vr(void 0,a)})},Ue.prototype.startsWith=function(a){return typeof a!="string"?ct(this,Vc):this.between(a,a+Fr,!0,!0)},Ue.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):ya(this,function(s,u){return s.indexOf(u[0])===0},[a],Fr)},Ue.prototype.equalsIgnoreCase=function(a){return ya(this,function(s,u){return s===u[0]},[a],"")},Ue.prototype.anyOfIgnoreCase=function(){var a=re.apply(Xe,arguments);return a.length===0?bn(this):ya(this,function(s,u){return u.indexOf(s)!==-1},a,"")},Ue.prototype.startsWithAnyOfIgnoreCase=function(){var a=re.apply(Xe,arguments);return a.length===0?bn(this):ya(this,function(s,u){return u.some(function(f){return s.indexOf(f)===0})},a,Fr)},Ue.prototype.anyOf=function(){var a=this,s=re.apply(Xe,arguments),u=this._cmp;try{s.sort(u)}catch{return ct(this,Vt)}if(s.length===0)return bn(this);var f=new this.Collection(this,function(){return vr(s[0],s[s.length-1])});f._ondirectionchange=function(p){u=p==="next"?a._ascending:a._descending,s.sort(u)};var h=0;return f._addAlgorithm(function(p,g,b){for(var x=p.key;0<u(x,s[h]);)if(++h===s.length)return g(b),!1;return u(x,s[h])===0||(g(function(){p.continue(s[h])}),!1)}),f},Ue.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ue.prototype.noneOf=function(){var a=re.apply(Xe,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return ct(this,Vt)}var s=a.reduce(function(u,f){return u?u.concat([[u[u.length-1][1],f]]):[[-1/0,f]]},null);return s.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},Ue.prototype.inAnyRange=function(L,s){var u=this,f=this._cmp,h=this._ascending,p=this._descending,g=this._min,b=this._max;if(L.length===0)return bn(this);if(!L.every(function(T){return T[0]!==void 0&&T[1]!==void 0&&h(T[0],T[1])<=0}))return ct(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",Z.InvalidArgument);var x=!s||s.includeLowers!==!1,I=s&&s.includeUppers===!0,O,_=h;function M(T,$){return _(T[0],$[0])}try{(O=L.reduce(function(T,$){for(var B=0,j=T.length;B<j;++B){var U=T[B];if(f($[0],U[1])<0&&0<f($[1],U[0])){U[0]=g(U[0],$[0]),U[1]=b(U[1],$[1]);break}}return B===j&&T.push($),T},[])).sort(M)}catch{return ct(this,Vt)}var k=0,C=I?function(T){return 0<h(T,O[k][1])}:function(T){return 0<=h(T,O[k][1])},R=x?function(T){return 0<p(T,O[k][0])}:function(T){return 0<=p(T,O[k][0])},D=C,L=new this.Collection(this,function(){return vr(O[0][0],O[O.length-1][1],!x,!I)});return L._ondirectionchange=function(T){_=T==="next"?(D=C,h):(D=R,p),O.sort(M)},L._addAlgorithm(function(T,$,B){for(var j,U=T.key;D(U);)if(++k===O.length)return $(B),!1;return!C(j=U)&&!R(j)||(u._cmp(U,O[k][1])===0||u._cmp(U,O[k][0])===0||$(function(){_===h?T.continue(O[k][0]):T.continue(O[k][1])}),!1)}),L},Ue.prototype.startsWithAnyOf=function(){var a=re.apply(Xe,arguments);return a.every(function(s){return typeof s=="string"})?a.length===0?bn(this):this.inAnyRange(a.map(function(s){return[s,s+Fr]})):ct(this,"startsWithAnyOf() only works with strings")},Ue);function Ue(){}function Nt(a){return ke(function(s){return oi(s),a(s.target.error),!1})}function oi(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var si="storagemutated",qo="x-storagemutated-1",yr=ni(null,si),Ah=(jt.prototype._lock=function(){return se(!J.global),++this._reculock,this._reculock!==1||J.global||(J.lockOwnerFor=this),this},jt.prototype._unlock=function(){if(se(!J.global),--this._reculock==0)for(J.global||(J.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{qr(a[1],a[0])}catch{}}return this},jt.prototype._locked=function(){return this._reculock&&J.lockOwnerFor!==this},jt.prototype.create=function(a){var s=this;if(!this.mode)return this;var u=this.db.idbdb,f=this.db._state.dbOpenError;if(se(!this.idbtrans),!a&&!u)switch(f&&f.name){case"DatabaseClosedError":throw new Z.DatabaseClosed(f);case"MissingAPIError":throw new Z.MissingAPI(f.message,f);default:throw new Z.OpenFailed(f)}if(!this.active)throw new Z.TransactionInactive;return se(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||u).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=ke(function(h){oi(h),s._reject(a.error)}),a.onabort=ke(function(h){oi(h),s.active&&s._reject(new Z.Abort(a.error)),s.active=!1,s.on("abort").fire(h)}),a.oncomplete=ke(function(){s.active=!1,s._resolve(),"mutatedParts"in a&&yr.storagemutated.fire(a.mutatedParts)}),this},jt.prototype._promise=function(a,s,u){var f=this;if(a==="readwrite"&&this.mode!=="readwrite")return Re(new Z.ReadOnly("Transaction is readonly"));if(!this.active)return Re(new Z.TransactionInactive);if(this._locked())return new V(function(p,g){f._blockedFuncs.push([function(){f._promise(a,s,u).then(p,g)},J])});if(u)return hr(function(){var p=new V(function(g,b){f._lock();var x=s(g,b,f);x&&x.then&&x.then(g,b)});return p.finally(function(){return f._unlock()}),p._lib=!0,p});var h=new V(function(p,g){var b=s(p,g,f);b&&b.then&&b.then(p,g)});return h._lib=!0,h},jt.prototype._root=function(){return this.parent?this.parent._root():this},jt.prototype.waitFor=function(a){var s,u=this._root(),f=V.resolve(a);u._waitingFor?u._waitingFor=u._waitingFor.then(function(){return f}):(u._waitingFor=f,u._waitingQueue=[],s=u.idbtrans.objectStore(u.storeNames[0]),function p(){for(++u._spinCount;u._waitingQueue.length;)u._waitingQueue.shift()();u._waitingFor&&(s.get(-1/0).onsuccess=p)}());var h=u._waitingFor;return new V(function(p,g){f.then(function(b){return u._waitingQueue.push(ke(p.bind(null,b)))},function(b){return u._waitingQueue.push(ke(g.bind(null,b)))}).finally(function(){u._waitingFor===h&&(u._waitingFor=null)})})},jt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new Z.Abort))},jt.prototype.table=function(a){var s=this._memoizedTables||(this._memoizedTables={});if(y(s,a))return s[a];var u=this.schema[a];if(!u)throw new Z.NotFound("Table "+a+" not part of transaction");return u=new this.db.Table(a,u,this),u.core=this.db.core.table(a),s[a]=u},jt);function jt(){}function Fo(a,s,u,f,h,p,g){return{name:a,keyPath:s,unique:u,multi:f,auto:h,compound:p,src:(u&&!g?"&":"")+(f?"*":"")+(h?"++":"")+iu(s)}}function iu(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function Ko(a,s,u){return{name:a,primKey:s,indexes:u,mappedClass:null,idxByName:(f=function(h){return[h.name,h]},u.reduce(function(h,p,g){return g=f(p,g),g&&(h[g[0]]=g[1]),h},{}))};var f}var ci=function(a){try{return a.only([[]]),ci=function(){return[[]]},[[]]}catch{return ci=function(){return Fr},Fr}};function Ho(a){return a==null?function(){}:typeof a=="string"?(s=a).split(".").length===1?function(u){return u[s]}:function(u){return X(u,s)}:function(u){return X(u,a)};var s}function au(a){return[].slice.call(a)}var Bh=0;function ui(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function Nh(a,s,x){function f(D){if(D.type===3)return null;if(D.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var k=D.lower,C=D.upper,R=D.lowerOpen,D=D.upperOpen;return k===void 0?C===void 0?null:s.upperBound(C,!!D):C===void 0?s.lowerBound(k,!!R):s.bound(k,C,!!R,!!D)}function h(M){var k,C=M.name;return{name:C,schema:M,mutate:function(R){var D=R.trans,L=R.type,T=R.keys,$=R.values,B=R.range;return new Promise(function(j,U){j=ke(j);var q=D.objectStore(C),F=q.keyPath==null,W=L==="put"||L==="add";if(!W&&L!=="delete"&&L!=="deleteRange")throw new Error("Invalid operation type: "+L);var K,G=(T||$||{length:1}).length;if(T&&$&&T.length!==$.length)throw new Error("Given keys array must have same length as given values array.");if(G===0)return j({numFailures:0,failures:{},results:[],lastResult:void 0});function ae(Ze){++ut,oi(Ze)}var ce=[],ue=[],ut=0;if(L==="deleteRange"){if(B.type===4)return j({numFailures:ut,failures:ue,results:[],lastResult:void 0});B.type===3?ce.push(K=q.clear()):ce.push(K=q.delete(f(B)))}else{var F=W?F?[$,T]:[$,null]:[T,null],ne=F[0],Ye=F[1];if(W)for(var Je=0;Je<G;++Je)ce.push(K=Ye&&Ye[Je]!==void 0?q[L](ne[Je],Ye[Je]):q[L](ne[Je])),K.onerror=ae;else for(Je=0;Je<G;++Je)ce.push(K=q[L](ne[Je])),K.onerror=ae}function Pa(Ze){Ze=Ze.target.result,ce.forEach(function(Wr,ss){return Wr.error!=null&&(ue[ss]=Wr.error)}),j({numFailures:ut,failures:ue,results:L==="delete"?T:ce.map(function(Wr){return Wr.result}),lastResult:Ze})}K.onerror=function(Ze){ae(Ze),Pa(Ze)},K.onsuccess=Pa})},getMany:function(R){var D=R.trans,L=R.keys;return new Promise(function(T,$){T=ke(T);for(var B,j=D.objectStore(C),U=L.length,q=new Array(U),F=0,W=0,K=function(ce){ce=ce.target,q[ce._pos]=ce.result,++W===F&&T(q)},G=Nt($),ae=0;ae<U;++ae)L[ae]!=null&&((B=j.get(L[ae]))._pos=ae,B.onsuccess=K,B.onerror=G,++F);F===0&&T(q)})},get:function(R){var D=R.trans,L=R.key;return new Promise(function(T,$){T=ke(T);var B=D.objectStore(C).get(L);B.onsuccess=function(j){return T(j.target.result)},B.onerror=Nt($)})},query:(k=I,function(R){return new Promise(function(D,L){D=ke(D);var T,$,B,F=R.trans,j=R.values,U=R.limit,K=R.query,q=U===1/0?void 0:U,W=K.index,K=K.range,F=F.objectStore(C),W=W.isPrimaryKey?F:F.index(W.name),K=f(K);if(U===0)return D({result:[]});k?((q=j?W.getAll(K,q):W.getAllKeys(K,q)).onsuccess=function(G){return D({result:G.target.result})},q.onerror=Nt(L)):(T=0,$=!j&&"openKeyCursor"in W?W.openKeyCursor(K):W.openCursor(K),B=[],$.onsuccess=function(G){var ae=$.result;return ae?(B.push(j?ae.value:ae.primaryKey),++T===U?D({result:B}):void ae.continue()):D({result:B})},$.onerror=Nt(L))})}),openCursor:function(R){var D=R.trans,L=R.values,T=R.query,$=R.reverse,B=R.unique;return new Promise(function(j,U){j=ke(j);var W=T.index,q=T.range,F=D.objectStore(C),F=W.isPrimaryKey?F:F.index(W.name),W=$?B?"prevunique":"prev":B?"nextunique":"next",K=!L&&"openKeyCursor"in F?F.openKeyCursor(f(q),W):F.openCursor(f(q),W);K.onerror=Nt(U),K.onsuccess=ke(function(G){var ae,ce,ue,ut,ne=K.result;ne?(ne.___id=++Bh,ne.done=!1,ae=ne.continue.bind(ne),ce=(ce=ne.continuePrimaryKey)&&ce.bind(ne),ue=ne.advance.bind(ne),ut=function(){throw new Error("Cursor not stopped")},ne.trans=D,ne.stop=ne.continue=ne.continuePrimaryKey=ne.advance=function(){throw new Error("Cursor not started")},ne.fail=ke(U),ne.next=function(){var Ye=this,Je=1;return this.start(function(){return Je--?Ye.continue():Ye.stop()}).then(function(){return Ye})},ne.start=function(Ye){function Je(){if(K.result)try{Ye()}catch(Ze){ne.fail(Ze)}else ne.done=!0,ne.start=function(){throw new Error("Cursor behind last entry")},ne.stop()}var Pa=new Promise(function(Ze,Wr){Ze=ke(Ze),K.onerror=Nt(Wr),ne.fail=Wr,ne.stop=function(ss){ne.stop=ne.continue=ne.continuePrimaryKey=ne.advance=ut,Ze(ss)}});return K.onsuccess=ke(function(Ze){K.onsuccess=Je,Je()}),ne.continue=ae,ne.continuePrimaryKey=ce,ne.advance=ue,Je(),Pa},j(ne)):j(null)},U)})},count:function(R){var D=R.query,L=R.trans,T=D.index,$=D.range;return new Promise(function(B,j){var U=L.objectStore(C),q=T.isPrimaryKey?U:U.index(T.name),U=f($),q=U?q.count(U):q.count();q.onsuccess=ke(function(F){return B(F.target.result)}),q.onerror=Nt(j)})}}}var p,g,b,O=(g=x,b=au((p=a).objectStoreNames),{schema:{name:p.name,tables:b.map(function(M){return g.objectStore(M)}).map(function(M){var k=M.keyPath,D=M.autoIncrement,C=l(k),R={},D={name:M.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:k==null,compound:C,keyPath:k,autoIncrement:D,unique:!0,extractKey:Ho(k)},indexes:au(M.indexNames).map(function(L){return M.index(L)}).map(function(B){var T=B.name,$=B.unique,j=B.multiEntry,B=B.keyPath,j={name:T,compound:l(B),keyPath:B,unique:$,multiEntry:j,extractKey:Ho(B)};return R[ui(B)]=j}),getIndexByKeyPath:function(L){return R[ui(L)]}};return R[":id"]=D.primaryKey,k!=null&&(R[ui(k)]=D.primaryKey),D})},hasGetAll:0<b.length&&"getAll"in g.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),x=O.schema,I=O.hasGetAll,O=x.tables.map(h),_={};return O.forEach(function(M){return _[M.name]=M}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(M){if(!_[M])throw new Error("Table '".concat(M,"' not found"));return _[M]},MIN_KEY:-1/0,MAX_KEY:ci(s),schema:x}}function jh(a,s,u,f){var h=u.IDBKeyRange;return u.indexedDB,{dbcore:(f=Nh(s,h,f),a.dbcore.reduce(function(p,g){return g=g.create,n(n({},p),g(p))},f))}}function ga(a,f){var u=f.db,f=jh(a._middlewares,u,a._deps,f);a.core=f.dbcore,a.tables.forEach(function(h){var p=h.name;a.core.schema.tables.some(function(g){return g.name===p})&&(h.core=a.core.table(p),a[p]instanceof a.Table&&(a[p].core=h.core))})}function ba(a,s,u,f){u.forEach(function(h){var p=f[h];s.forEach(function(g){var b=function x(I,O){return A(I,O)||(I=v(I))&&x(I,O)}(g,h);(!b||"value"in b&&b.value===void 0)&&(g===a.Transaction.prototype||g instanceof a.Transaction?w(g,h,{get:function(){return this.table(h)},set:function(x){S(this,h,{value:x,writable:!0,configurable:!0,enumerable:!0})}}):g[h]=new a.Table(h,p))})})}function Uo(a,s){s.forEach(function(u){for(var f in u)u[f]instanceof a.Table&&delete u[f]})}function qh(a,s){return a._cfg.version-s._cfg.version}function Fh(a,s,u,f){var h=a._dbSchema;u.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=Ko("$meta",su("")[0],[]),a._storeNames.push("$meta"));var p=a._createTransaction("readwrite",a._storeNames,h);p.create(u),p._completion.catch(f);var g=p._reject.bind(p),b=J.transless||J;hr(function(){return J.trans=p,J.transless=b,s!==0?(ga(a,u),I=s,((x=p).storeNames.includes("$meta")?x.table("$meta").get("version").then(function(O){return O??I}):V.resolve(I)).then(function(O){return M=O,k=p,C=u,R=[],O=(_=a)._versions,D=_._dbSchema=_a(0,_.idbdb,C),(O=O.filter(function(L){return L._cfg.version>=M})).length!==0?(O.forEach(function(L){R.push(function(){var T=D,$=L._cfg.dbschema;Ea(_,T,C),Ea(_,$,C),D=_._dbSchema=$;var B=Wo(T,$);B.add.forEach(function(W){zo(C,W[0],W[1].primKey,W[1].indexes)}),B.change.forEach(function(W){if(W.recreate)throw new Z.Upgrade("Not yet support for changing primary key");var K=C.objectStore(W.name);W.add.forEach(function(G){return wa(K,G)}),W.change.forEach(function(G){K.deleteIndex(G.name),wa(K,G)}),W.del.forEach(function(G){return K.deleteIndex(G)})});var j=L._cfg.contentUpgrade;if(j&&L._cfg.version>M){ga(_,C),k._memoizedTables={};var U=me($);B.del.forEach(function(W){U[W]=T[W]}),Uo(_,[_.Transaction.prototype]),ba(_,[_.Transaction.prototype],c(U),U),k.schema=U;var q,F=xe(j);return F&&vn(),B=V.follow(function(){var W;(q=j(k))&&F&&(W=mr.bind(null,null),q.then(W,W))}),q&&typeof q.then=="function"?V.resolve(q):B.then(function(){return q})}}),R.push(function(T){var $,B,j=L._cfg.dbschema;$=j,B=T,[].slice.call(B.db.objectStoreNames).forEach(function(U){return $[U]==null&&B.db.deleteObjectStore(U)}),Uo(_,[_.Transaction.prototype]),ba(_,[_.Transaction.prototype],_._storeNames,_._dbSchema),k.schema=_._dbSchema}),R.push(function(T){_.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(_.idbdb.version/10)===L._cfg.version?(_.idbdb.deleteObjectStore("$meta"),delete _._dbSchema.$meta,_._storeNames=_._storeNames.filter(function($){return $!=="$meta"})):T.objectStore("$meta").put(L._cfg.version,"version"))})}),function L(){return R.length?V.resolve(R.shift()(k.idbtrans)).then(L):V.resolve()}().then(function(){ou(D,C)})):V.resolve();var _,M,k,C,R,D}).catch(g)):(c(h).forEach(function(O){zo(u,O,h[O].primKey,h[O].indexes)}),ga(a,u),void V.follow(function(){return a.on.populate.fire(p)}).catch(g));var x,I})}function Kh(a,s){ou(a._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var u=_a(0,a.idbdb,s);Ea(a,a._dbSchema,s);for(var f=0,h=Wo(u,a._dbSchema).change;f<h.length;f++){var p=function(g){if(g.change.length||g.recreate)return console.warn("Unable to patch indexes of table ".concat(g.name," because it has changes on the type of index or primary key.")),{value:void 0};var b=s.objectStore(g.name);g.add.forEach(function(x){Bt&&console.debug("Dexie upgrade patch: Creating missing index ".concat(g.name,".").concat(x.src)),wa(b,x)})}(h[f]);if(typeof p=="object")return p.value}}function Wo(a,s){var u,f={del:[],add:[],change:[]};for(u in a)s[u]||f.del.push(u);for(u in s){var h=a[u],p=s[u];if(h){var g={name:u,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||h.primKey.auto!==p.primKey.auto)g.recreate=!0,f.change.push(g);else{var b=h.idxByName,x=p.idxByName,I=void 0;for(I in b)x[I]||g.del.push(I);for(I in x){var O=b[I],_=x[I];O?O.src!==_.src&&g.change.push(_):g.add.push(_)}(0<g.del.length||0<g.add.length||0<g.change.length)&&f.change.push(g)}}else f.add.push([u,p])}return f}function zo(a,s,u,f){var h=a.db.createObjectStore(s,u.keyPath?{keyPath:u.keyPath,autoIncrement:u.auto}:{autoIncrement:u.auto});return f.forEach(function(p){return wa(h,p)}),h}function ou(a,s){c(a).forEach(function(u){s.db.objectStoreNames.contains(u)||(Bt&&console.debug("Dexie: Creating missing table",u),zo(s,u,a[u].primKey,a[u].indexes))})}function wa(a,s){a.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function _a(a,s,u){var f={};return H(s.objectStoreNames,0).forEach(function(h){for(var p=u.objectStore(h),g=Fo(iu(I=p.keyPath),I||"",!0,!1,!!p.autoIncrement,I&&typeof I!="string",!0),b=[],x=0;x<p.indexNames.length;++x){var O=p.index(p.indexNames[x]),I=O.keyPath,O=Fo(O.name,I,!!O.unique,!!O.multiEntry,!1,I&&typeof I!="string",!1);b.push(O)}f[h]=Ko(h,g,b)}),f}function Ea(a,s,u){for(var f=u.db.objectStoreNames,h=0;h<f.length;++h){var p=f[h],g=u.objectStore(p);a._hasGetAll="getAll"in g;for(var b=0;b<g.indexNames.length;++b){var x=g.indexNames[b],I=g.index(x).keyPath,O=typeof I=="string"?I:"["+H(I).join("+")+"]";!s[p]||(I=s[p].idxByName[O])&&(I.name=x,delete s[p].idxByName[O],s[p].idxByName[x]=I)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function su(a){return a.split(",").map(function(s,u){var f=(s=s.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return Fo(f,h||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),l(h),u===0)})}var Hh=(Sa.prototype._parseStoresSpec=function(a,s){c(a).forEach(function(u){if(a[u]!==null){var f=su(a[u]),h=f.shift();if(h.unique=!0,h.multi)throw new Z.Schema("Primary key cannot be multi-valued");f.forEach(function(p){if(p.auto)throw new Z.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new Z.Schema("Index must have a name and cannot be an empty string")}),s[u]=Ko(u,h,f)}})},Sa.prototype.stores=function(u){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?d(this._cfg.storesSource,u):u;var u=s._versions,f={},h={};return u.forEach(function(p){d(f,p._cfg.storesSource),h=p._cfg.dbschema={},p._parseStoresSpec(f,h)}),s._dbSchema=h,Uo(s,[s._allTables,s,s.Transaction.prototype]),ba(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],c(h),h),s._storeNames=c(h),this},Sa.prototype.upgrade=function(a){return this._cfg.contentUpgrade=Io(this._cfg.contentUpgrade||ve,a),this},Sa);function Sa(){}function Vo(a,s){var u=a._dbNamesDB;return u||(u=a._dbNamesDB=new Gt(ha,{addons:[],indexedDB:a,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),u.table("dbnames")}function Qo(a){return a&&typeof a.databases=="function"}function Go(a){return hr(function(){return J.letThrough=!0,a()})}function Yo(a){return!("from"in a)}var Ge=function(a,s){if(!this){var u=new Ge;return a&&"d"in a&&d(u,a),u}d(this,arguments.length?{d:1,from:a,to:1<arguments.length?s:a}:{d:0})};function li(a,s,u){var f=he(s,u);if(!isNaN(f)){if(0<f)throw RangeError();if(Yo(a))return d(a,{from:s,to:u,d:1});var h=a.l,f=a.r;if(he(u,a.from)<0)return h?li(h,s,u):a.l={from:s,to:u,d:1,l:null,r:null},uu(a);if(0<he(s,a.to))return f?li(f,s,u):a.r={from:s,to:u,d:1,l:null,r:null},uu(a);he(s,a.from)<0&&(a.from=s,a.l=null,a.d=f?f.d+1:1),0<he(u,a.to)&&(a.to=u,a.r=null,a.d=a.l?a.l.d+1:1),u=!a.r,h&&!a.l&&fi(a,h),f&&u&&fi(a,f)}}function fi(a,s){Yo(s)||function u(f,x){var p=x.from,g=x.to,b=x.l,x=x.r;li(f,p,g),b&&u(f,b),x&&u(f,x)}(a,s)}function cu(a,s){var u=xa(s),f=u.next();if(f.done)return!1;for(var h=f.value,p=xa(a),g=p.next(h.from),b=g.value;!f.done&&!g.done;){if(he(b.from,h.to)<=0&&0<=he(b.to,h.from))return!0;he(h.from,b.from)<0?h=(f=u.next(b.from)).value:b=(g=p.next(h.from)).value}return!1}function xa(a){var s=Yo(a)?null:{s:0,n:a};return{next:function(u){for(var f=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,f)for(;s.n.l&&he(u,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!f||he(u,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function uu(a){var s,u,f=(((s=a.r)===null||s===void 0?void 0:s.d)||0)-(((u=a.l)===null||u===void 0?void 0:u.d)||0),h=1<f?"r":f<-1?"l":"";h&&(s=h=="r"?"l":"r",u=n({},a),f=a[h],a.from=f.from,a.to=f.to,a[h]=f[h],u[h]=f[s],(a[s]=u).d=lu(u)),a.d=lu(a)}function lu(u){var s=u.r,u=u.l;return(s?u?Math.max(s.d,u.d):s.d:u?u.d:0)+1}function ka(a,s){return c(s).forEach(function(u){a[u]?fi(a[u],s[u]):a[u]=function f(h){var p,g,b={};for(p in h)y(h,p)&&(g=h[p],b[p]=!g||typeof g!="object"||De.has(g.constructor)?g:f(g));return b}(s[u])}),a}function Jo(a,s){return a.all||s.all||Object.keys(a).some(function(u){return s[u]&&cu(s[u],a[u])})}E(Ge.prototype,((bt={add:function(a){return fi(this,a),this},addKey:function(a){return li(this,a,a),this},addKeys:function(a){var s=this;return a.forEach(function(u){return li(s,u,u)}),this},hasKey:function(a){var s=xa(this).next(a).value;return s&&he(s.from,a)<=0&&0<=he(s.to,a)}})[st]=function(){return xa(this)},bt));var Hr={},Xo={},Zo=!1;function Ia(a){ka(Xo,a),Zo||(Zo=!0,setTimeout(function(){Zo=!1,es(Xo,!(Xo={}))},0))}function es(a,s){s===void 0&&(s=!1);var u=new Set;if(a.all)for(var f=0,h=Object.values(Hr);f<h.length;f++)fu(g=h[f],a,u,s);else for(var p in a){var g,b=/^idb\:\/\/(.*)\/(.*)\//.exec(p);b&&(p=b[1],b=b[2],(g=Hr["idb://".concat(p,"/").concat(b)])&&fu(g,a,u,s))}u.forEach(function(x){return x()})}function fu(a,s,u,f){for(var h=[],p=0,g=Object.entries(a.queries.query);p<g.length;p++){for(var b=g[p],x=b[0],I=[],O=0,_=b[1];O<_.length;O++){var M=_[O];Jo(s,M.obsSet)?M.subscribers.forEach(function(D){return u.add(D)}):f&&I.push(M)}f&&h.push([x,I])}if(f)for(var k=0,C=h;k<C.length;k++){var R=C[k],x=R[0],I=R[1];a.queries.query[x]=I}}function Uh(a){var s=a._state,u=a._deps.indexedDB;if(s.isBeingOpened||a.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?Re(s.dbOpenError):a});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var f=s.openCanceller,h=Math.round(10*a.verno),p=!1;function g(){if(s.openCanceller!==f)throw new Z.DatabaseClosed("db.open() was cancelled")}function b(){return new V(function(M,k){if(g(),!u)throw new Z.MissingAPI;var C=a.name,R=s.autoSchema||!h?u.open(C):u.open(C,h);if(!R)throw new Z.MissingAPI;R.onerror=Nt(k),R.onblocked=ke(a._fireOnBlocked),R.onupgradeneeded=ke(function(D){var L;O=R.transaction,s.autoSchema&&!a._options.allowEmptyDB?(R.onerror=oi,O.abort(),R.result.close(),(L=u.deleteDatabase(C)).onsuccess=L.onerror=ke(function(){k(new Z.NoSuchDatabase("Database ".concat(C," doesnt exist")))})):(O.onerror=Nt(k),D=D.oldVersion>Math.pow(2,62)?0:D.oldVersion,_=D<1,a.idbdb=R.result,p&&Kh(a,O),Fh(a,D/10,O,k))},k),R.onsuccess=ke(function(){O=null;var D,L,T,$,B,j=a.idbdb=R.result,U=H(j.objectStoreNames);if(0<U.length)try{var q=j.transaction(($=U).length===1?$[0]:$,"readonly");if(s.autoSchema)L=j,T=q,(D=a).verno=L.version/10,T=D._dbSchema=_a(0,L,T),D._storeNames=H(L.objectStoreNames,0),ba(D,[D._allTables],c(T),T);else if(Ea(a,a._dbSchema,q),((B=Wo(_a(0,(B=a).idbdb,q),B._dbSchema)).add.length||B.change.some(function(F){return F.add.length||F.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),j.close(),h=j.version+1,p=!0,M(b());ga(a,q)}catch{}yn.push(a),j.onversionchange=ke(function(F){s.vcFired=!0,a.on("versionchange").fire(F)}),j.onclose=ke(function(F){a.on("close").fire(F)}),_&&(B=a._deps,q=C,j=B.indexedDB,B=B.IDBKeyRange,Qo(j)||q===ha||Vo(j,B).put({name:q}).catch(ve)),M()},k)}).catch(function(M){switch(M==null?void 0:M.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),b();break;case"VersionError":if(0<h)return h=0,b()}return V.reject(M)})}var x,I=s.dbReadyResolve,O=null,_=!1;return V.race([f,(typeof navigator>"u"?V.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(M){function k(){return indexedDB.databases().finally(M)}x=setInterval(k,100),k()}).finally(function(){return clearInterval(x)}):Promise.resolve()).then(b)]).then(function(){return g(),s.onReadyBeingFired=[],V.resolve(Go(function(){return a.on.ready.fire(a.vip)})).then(function M(){if(0<s.onReadyBeingFired.length){var k=s.onReadyBeingFired.reduce(Io,ve);return s.onReadyBeingFired=[],V.resolve(Go(function(){return k(a.vip)})).then(M)}})}).finally(function(){s.openCanceller===f&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(M){s.dbOpenError=M;try{O&&O.abort()}catch{}return f===s.openCanceller&&a._close(),Re(M)}).finally(function(){s.openComplete=!0,I()}).then(function(){var M;return _&&(M={},a.tables.forEach(function(k){k.schema.indexes.forEach(function(C){C.name&&(M["idb://".concat(a.name,"/").concat(k.name,"/").concat(C.name)]=new Ge(-1/0,[[[]]]))}),M["idb://".concat(a.name,"/").concat(k.name,"/")]=M["idb://".concat(a.name,"/").concat(k.name,"/:dels")]=new Ge(-1/0,[[[]]])}),yr(si).fire(M),es(M,!0)),a})}function ts(a){function s(p){return a.next(p)}var u=h(s),f=h(function(p){return a.throw(p)});function h(p){return function(x){var b=p(x),x=b.value;return b.done?x:x&&typeof x.then=="function"?x.then(u,f):l(x)?Promise.all(x).then(u,f):u(x)}}return h(s)()}function Da(a,s,u){for(var f=l(a)?a.slice():[a],h=0;h<u;++h)f.push(s);return f}var Wh={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return n(n({},a),{table:function(s){var u=a.table(s),f=u.schema,h={},p=[];function g(_,M,k){var C=ui(_),R=h[C]=h[C]||[],D=_==null?0:typeof _=="string"?1:_.length,L=0<M,L=n(n({},k),{name:L?"".concat(C,"(virtual-from:").concat(k.name,")"):k.name,lowLevelIndex:k,isVirtual:L,keyTail:M,keyLength:D,extractKey:Ho(_),unique:!L&&k.unique});return R.push(L),L.isPrimaryKey||p.push(L),1<D&&g(D===2?_[0]:_.slice(0,D-1),M+1,k),R.sort(function(T,$){return T.keyTail-$.keyTail}),L}s=g(f.primaryKey.keyPath,0,f.primaryKey),h[":id"]=[s];for(var b=0,x=f.indexes;b<x.length;b++){var I=x[b];g(I.keyPath,0,I)}function O(_){var M,k=_.query.index;return k.isVirtual?n(n({},_),{query:{index:k.lowLevelIndex,range:(M=_.query.range,k=k.keyTail,{type:M.type===1?2:M.type,lower:Da(M.lower,M.lowerOpen?a.MAX_KEY:a.MIN_KEY,k),lowerOpen:!0,upper:Da(M.upper,M.upperOpen?a.MIN_KEY:a.MAX_KEY,k),upperOpen:!0})}}):_}return n(n({},u),{schema:n(n({},f),{primaryKey:s,indexes:p,getIndexByKeyPath:function(_){return(_=h[ui(_)])&&_[0]}}),count:function(_){return u.count(O(_))},query:function(_){return u.query(O(_))},openCursor:function(_){var M=_.query.index,k=M.keyTail,C=M.isVirtual,R=M.keyLength;return C?u.openCursor(O(_)).then(function(L){return L&&D(L)}):u.openCursor(_);function D(L){return Object.create(L,{continue:{value:function(T){T!=null?L.continue(Da(T,_.reverse?a.MAX_KEY:a.MIN_KEY,k)):_.unique?L.continue(L.key.slice(0,R).concat(_.reverse?a.MIN_KEY:a.MAX_KEY,k)):L.continue()}},continuePrimaryKey:{value:function(T,$){L.continuePrimaryKey(Da(T,a.MAX_KEY,k),$)}},primaryKey:{get:function(){return L.primaryKey}},key:{get:function(){var T=L.key;return R===1?T[0]:T.slice(0,R)}},value:{get:function(){return L.value}}})}}})}})}};function rs(a,s,u,f){return u=u||{},f=f||"",c(a).forEach(function(h){var p,g,b;y(s,h)?(p=a[h],g=s[h],typeof p=="object"&&typeof g=="object"&&p&&g?(b=Ce(p))!==Ce(g)?u[f+h]=s[h]:b==="Object"?rs(p,g,u,f+h+"."):p!==g&&(u[f+h]=s[h]):p!==g&&(u[f+h]=s[h])):u[f+h]=void 0}),c(s).forEach(function(h){y(a,h)||(u[f+h]=s[h])}),u}function ns(a,s){return s.type==="delete"?s.keys:s.keys||s.values.map(a.extractKey)}var zh={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return n(n({},a),{table:function(s){var u=a.table(s),f=u.schema.primaryKey;return n(n({},u),{mutate:function(h){var p=J.trans,g=p.table(s).hook,b=g.deleting,x=g.creating,I=g.updating;switch(h.type){case"add":if(x.fire===ve)break;return p._promise("readwrite",function(){return O(h)},!0);case"put":if(x.fire===ve&&I.fire===ve)break;return p._promise("readwrite",function(){return O(h)},!0);case"delete":if(b.fire===ve)break;return p._promise("readwrite",function(){return O(h)},!0);case"deleteRange":if(b.fire===ve)break;return p._promise("readwrite",function(){return function _(M,k,C){return u.query({trans:M,values:!1,query:{index:f,range:k},limit:C}).then(function(R){var D=R.result;return O({type:"delete",keys:D,trans:M}).then(function(L){return 0<L.numFailures?Promise.reject(L.failures[0]):D.length<C?{failures:[],numFailures:0,lastResult:void 0}:_(M,n(n({},k),{lower:D[D.length-1],lowerOpen:!0}),C)})})}(h.trans,h.range,1e4)},!0)}return u.mutate(h);function O(_){var M,k,C,R=J.trans,D=_.keys||ns(f,_);if(!D)throw new Error("Keys missing");return(_=_.type==="add"||_.type==="put"?n(n({},_),{keys:D}):n({},_)).type!=="delete"&&(_.values=i([],_.values)),_.keys&&(_.keys=i([],_.keys)),M=u,C=D,((k=_).type==="add"?Promise.resolve([]):M.getMany({trans:k.trans,keys:C,cache:"immutable"})).then(function(L){var T=D.map(function($,B){var j,U,q,F=L[B],W={onerror:null,onsuccess:null};return _.type==="delete"?b.fire.call(W,$,F,R):_.type==="add"||F===void 0?(j=x.fire.call(W,$,_.values[B],R),$==null&&j!=null&&(_.keys[B]=$=j,f.outbound||ee(_.values[B],f.keyPath,$))):(j=rs(F,_.values[B]),(U=I.fire.call(W,j,$,F,R))&&(q=_.values[B],Object.keys(U).forEach(function(K){y(q,K)?q[K]=U[K]:ee(q,K,U[K])}))),W});return u.mutate(_).then(function($){for(var B=$.failures,j=$.results,U=$.numFailures,$=$.lastResult,q=0;q<D.length;++q){var F=(j||D)[q],W=T[q];F==null?W.onerror&&W.onerror(B[q]):W.onsuccess&&W.onsuccess(_.type==="put"&&L[q]?_.values[q]:F)}return{failures:B,results:j,numFailures:U,lastResult:$}}).catch(function($){return T.forEach(function(B){return B.onerror&&B.onerror($)}),Promise.reject($)})})}}})}})}};function du(a,s,u){try{if(!s||s.keys.length<a.length)return null;for(var f=[],h=0,p=0;h<s.keys.length&&p<a.length;++h)he(s.keys[h],a[p])===0&&(f.push(u?Ee(s.values[h]):s.values[h]),++p);return f.length===a.length?f:null}catch{return null}}var Vh={stack:"dbcore",level:-1,create:function(a){return{table:function(s){var u=a.table(s);return n(n({},u),{getMany:function(f){if(!f.cache)return u.getMany(f);var h=du(f.keys,f.trans._cache,f.cache==="clone");return h?V.resolve(h):u.getMany(f).then(function(p){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?Ee(p):p},p})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),u.mutate(f)}})}}}};function hu(a,s){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function mu(a,s){switch(a){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Qh={stack:"dbcore",level:0,name:"Observability",create:function(a){var s=a.schema.name,u=new Ge(a.MIN_KEY,a.MAX_KEY);return n(n({},a),{transaction:function(f,h,p){if(J.subscr&&h!=="readonly")throw new Z.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(J.querier));return a.transaction(f,h,p)},table:function(f){var h=a.table(f),p=h.schema,g=p.primaryKey,_=p.indexes,b=g.extractKey,x=g.outbound,I=g.autoIncrement&&_.filter(function(k){return k.compound&&k.keyPath.includes(g.keyPath)}),O=n(n({},h),{mutate:function(k){function C(K){return K="idb://".concat(s,"/").concat(f,"/").concat(K),$[K]||($[K]=new Ge)}var R,D,L,T=k.trans,$=k.mutatedParts||(k.mutatedParts={}),B=C(""),j=C(":dels"),U=k.type,W=k.type==="deleteRange"?[k.range]:k.type==="delete"?[k.keys]:k.values.length<50?[ns(g,k).filter(function(K){return K}),k.values]:[],q=W[0],F=W[1],W=k.trans._cache;return l(q)?(B.addKeys(q),(W=U==="delete"||q.length===F.length?du(q,W):null)||j.addKeys(q),(W||F)&&(R=C,D=W,L=F,p.indexes.forEach(function(K){var G=R(K.name||"");function ae(ue){return ue!=null?K.extractKey(ue):null}function ce(ue){return K.multiEntry&&l(ue)?ue.forEach(function(ut){return G.addKey(ut)}):G.addKey(ue)}(D||L).forEach(function(ue,Ye){var ne=D&&ae(D[Ye]),Ye=L&&ae(L[Ye]);he(ne,Ye)!==0&&(ne!=null&&ce(ne),Ye!=null&&ce(Ye))})}))):q?(F={from:(F=q.lower)!==null&&F!==void 0?F:a.MIN_KEY,to:(F=q.upper)!==null&&F!==void 0?F:a.MAX_KEY},j.add(F),B.add(F)):(B.add(u),j.add(u),p.indexes.forEach(function(K){return C(K.name).add(u)})),h.mutate(k).then(function(K){return!q||k.type!=="add"&&k.type!=="put"||(B.addKeys(K.results),I&&I.forEach(function(G){for(var ae=k.values.map(function(ne){return G.extractKey(ne)}),ce=G.keyPath.findIndex(function(ne){return ne===g.keyPath}),ue=0,ut=K.results.length;ue<ut;++ue)ae[ue][ce]=K.results[ue];C(G.name).addKeys(ae)})),T.mutatedParts=ka(T.mutatedParts||{},$),K})}}),_=function(C){var R=C.query,C=R.index,R=R.range;return[C,new Ge((C=R.lower)!==null&&C!==void 0?C:a.MIN_KEY,(R=R.upper)!==null&&R!==void 0?R:a.MAX_KEY)]},M={get:function(k){return[g,new Ge(k.key)]},getMany:function(k){return[g,new Ge().addKeys(k.keys)]},count:_,query:_,openCursor:_};return c(M).forEach(function(k){O[k]=function(C){var R=J.subscr,D=!!R,L=hu(J,h)&&mu(k,C)?C.obsSet={}:R;if(D){var T=function(F){return F="idb://".concat(s,"/").concat(f,"/").concat(F),L[F]||(L[F]=new Ge)},$=T(""),B=T(":dels"),R=M[k](C),D=R[0],R=R[1];if((k==="query"&&D.isPrimaryKey&&!C.values?B:T(D.name||"")).add(R),!D.isPrimaryKey){if(k!=="count"){var j=k==="query"&&x&&C.values&&h.query(n(n({},C),{values:!1}));return h[k].apply(this,arguments).then(function(F){if(k==="query"){if(x&&C.values)return j.then(function(ae){return ae=ae.result,$.addKeys(ae),F});var W=C.values?F.result.map(b):F.result;(C.values?$:B).addKeys(W)}else if(k==="openCursor"){var K=F,G=C.values;return K&&Object.create(K,{key:{get:function(){return B.addKey(K.primaryKey),K.key}},primaryKey:{get:function(){var ae=K.primaryKey;return B.addKey(ae),ae}},value:{get:function(){return G&&$.addKey(K.primaryKey),K.value}}})}return F})}B.add(u)}}return h[k].apply(this,arguments)}}),O}})}};function pu(a,s,u){if(u.numFailures===0)return s;if(s.type==="deleteRange")return null;var f=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return u.numFailures===f?null:(s=n({},s),l(s.keys)&&(s.keys=s.keys.filter(function(h,p){return!(p in u.failures)})),"values"in s&&l(s.values)&&(s.values=s.values.filter(function(h,p){return!(p in u.failures)})),s)}function is(a,s){return u=a,((f=s).lower===void 0||(f.lowerOpen?0<he(u,f.lower):0<=he(u,f.lower)))&&(a=a,(s=s).upper===void 0||(s.upperOpen?he(a,s.upper)<0:he(a,s.upper)<=0));var u,f}function vu(a,s,M,f,h,p){if(!M||M.length===0)return a;var g=s.query.index,b=g.multiEntry,x=s.query.range,I=f.schema.primaryKey.extractKey,O=g.extractKey,_=(g.lowLevelIndex||g).extractKey,M=M.reduce(function(k,C){var R=k,D=[];if(C.type==="add"||C.type==="put")for(var L=new Ge,T=C.values.length-1;0<=T;--T){var $,B=C.values[T],j=I(B);L.hasKey(j)||($=O(B),(b&&l($)?$.some(function(K){return is(K,x)}):is($,x))&&(L.addKey(j),D.push(B)))}switch(C.type){case"add":var U=new Ge().addKeys(s.values?k.map(function(G){return I(G)}):k),R=k.concat(s.values?D.filter(function(G){return G=I(G),!U.hasKey(G)&&(U.addKey(G),!0)}):D.map(function(G){return I(G)}).filter(function(G){return!U.hasKey(G)&&(U.addKey(G),!0)}));break;case"put":var q=new Ge().addKeys(C.values.map(function(G){return I(G)}));R=k.filter(function(G){return!q.hasKey(s.values?I(G):G)}).concat(s.values?D:D.map(function(G){return I(G)}));break;case"delete":var F=new Ge().addKeys(C.keys);R=k.filter(function(G){return!F.hasKey(s.values?I(G):G)});break;case"deleteRange":var W=C.range;R=k.filter(function(G){return!is(I(G),W)})}return R},a);return M===a?a:(M.sort(function(k,C){return he(_(k),_(C))||he(I(k),I(C))}),s.limit&&s.limit<1/0&&(M.length>s.limit?M.length=s.limit:a.length===s.limit&&M.length<s.limit&&(h.dirty=!0)),p?Object.freeze(M):M)}function yu(a,s){return he(a.lower,s.lower)===0&&he(a.upper,s.upper)===0&&!!a.lowerOpen==!!s.lowerOpen&&!!a.upperOpen==!!s.upperOpen}function Gh(a,s){return function(u,f,h,p){if(u===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=he(u,f))===0){if(h&&p)return 0;if(h)return 1;if(p)return-1}return f}(a.lower,s.lower,a.lowerOpen,s.lowerOpen)<=0&&0<=function(u,f,h,p){if(u===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=he(u,f))===0){if(h&&p)return 0;if(h)return-1;if(p)return 1}return f}(a.upper,s.upper,a.upperOpen,s.upperOpen)}function Yh(a,s,u,f){a.subscribers.add(u),f.addEventListener("abort",function(){var h,p;a.subscribers.delete(u),a.subscribers.size===0&&(h=a,p=s,setTimeout(function(){h.subscribers.size===0&&Pe(p,h)},3e3))})}var Jh={stack:"dbcore",level:0,name:"Cache",create:function(a){var s=a.schema.name;return n(n({},a),{transaction:function(u,f,h){var p,g,b=a.transaction(u,f,h);return f==="readwrite"&&(g=(p=new AbortController).signal,h=function(x){return function(){if(p.abort(),f==="readwrite"){for(var I=new Set,O=0,_=u;O<_.length;O++){var M=_[O],k=Hr["idb://".concat(s,"/").concat(M)];if(k){var C=a.table(M),R=k.optimisticOps.filter(function(G){return G.trans===b});if(b._explicit&&x&&b.mutatedParts)for(var D=0,L=Object.values(k.queries.query);D<L.length;D++)for(var T=0,$=(U=L[D]).slice();T<$.length;T++)Jo((q=$[T]).obsSet,b.mutatedParts)&&(Pe(U,q),q.subscribers.forEach(function(G){return I.add(G)}));else if(0<R.length){k.optimisticOps=k.optimisticOps.filter(function(G){return G.trans!==b});for(var B=0,j=Object.values(k.queries.query);B<j.length;B++)for(var U,q,F,W=0,K=(U=j[B]).slice();W<K.length;W++)(q=K[W]).res!=null&&b.mutatedParts&&(x&&!q.dirty?(F=Object.isFrozen(q.res),F=vu(q.res,q.req,R,C,q,F),q.dirty?(Pe(U,q),q.subscribers.forEach(function(G){return I.add(G)})):F!==q.res&&(q.res=F,q.promise=V.resolve({result:F}))):(q.dirty&&Pe(U,q),q.subscribers.forEach(function(G){return I.add(G)})))}}}I.forEach(function(G){return G()})}}},b.addEventListener("abort",h(!1),{signal:g}),b.addEventListener("error",h(!1),{signal:g}),b.addEventListener("complete",h(!0),{signal:g})),b},table:function(u){var f=a.table(u),h=f.schema.primaryKey;return n(n({},f),{mutate:function(p){var g=J.trans;if(h.outbound||g.db._options.cache==="disabled"||g.explicit||g.idbtrans.mode!=="readwrite")return f.mutate(p);var b=Hr["idb://".concat(s,"/").concat(u)];return b?(g=f.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||ns(h,p).some(function(x){return x==null}))?(b.optimisticOps.push(p),p.mutatedParts&&Ia(p.mutatedParts),g.then(function(x){0<x.numFailures&&(Pe(b.optimisticOps,p),(x=pu(0,p,x))&&b.optimisticOps.push(x),p.mutatedParts&&Ia(p.mutatedParts))}),g.catch(function(){Pe(b.optimisticOps,p),p.mutatedParts&&Ia(p.mutatedParts)})):g.then(function(x){var I=pu(0,n(n({},p),{values:p.values.map(function(O,_){var M;return x.failures[_]?O:(O=(M=h.keyPath)!==null&&M!==void 0&&M.includes(".")?Ee(O):n({},O),ee(O,h.keyPath,x.results[_]),O)})}),x);b.optimisticOps.push(I),queueMicrotask(function(){return p.mutatedParts&&Ia(p.mutatedParts)})}),g):f.mutate(p)},query:function(p){if(!hu(J,f)||!mu("query",p))return f.query(p);var g=((I=J.trans)===null||I===void 0?void 0:I.db._options.cache)==="immutable",_=J,b=_.requery,x=_.signal,I=function(C,R,D,L){var T=Hr["idb://".concat(C,"/").concat(R)];if(!T)return[];if(!(R=T.queries[D]))return[null,!1,T,null];var $=R[(L.query?L.query.index.name:null)||""];if(!$)return[null,!1,T,null];switch(D){case"query":var B=$.find(function(j){return j.req.limit===L.limit&&j.req.values===L.values&&yu(j.req.query.range,L.query.range)});return B?[B,!0,T,$]:[$.find(function(j){return("limit"in j.req?j.req.limit:1/0)>=L.limit&&(!L.values||j.req.values)&&Gh(j.req.query.range,L.query.range)}),!1,T,$];case"count":return B=$.find(function(j){return yu(j.req.query.range,L.query.range)}),[B,!!B,T,$]}}(s,u,"query",p),O=I[0],_=I[1],M=I[2],k=I[3];return O&&_?O.obsSet=p.obsSet:(_=f.query(p).then(function(C){var R=C.result;if(O&&(O.res=R),g){for(var D=0,L=R.length;D<L;++D)Object.freeze(R[D]);Object.freeze(R)}else C.result=Ee(R);return C}).catch(function(C){return k&&O&&Pe(k,O),Promise.reject(C)}),O={obsSet:p.obsSet,promise:_,subscribers:new Set,type:"query",req:p,dirty:!1},k?k.push(O):(k=[O],(M=M||(Hr["idb://".concat(s,"/").concat(u)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=k)),Yh(O,k,b,x),O.promise.then(function(C){return{result:vu(C.result,p,M==null?void 0:M.optimisticOps,f,O,g)}})}})}})}};function Ca(a,s){return new Proxy(a,{get:function(u,f,h){return f==="db"?s:Reflect.get(u,f,h)}})}var Gt=(Me.prototype.version=function(a){if(isNaN(a)||a<.1)throw new Z.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new Z.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var s=this._versions,u=s.filter(function(f){return f._cfg.version===a})[0];return u||(u=new this.Version(a),s.push(u),s.sort(qh),u.stores({}),this._state.autoSchema=!1,u)},Me.prototype._whenReady=function(a){var s=this;return this.idbdb&&(this._state.openComplete||J.letThrough||this._vip)?a():new V(function(u,f){if(s._state.openComplete)return f(new Z.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void f(new Z.DatabaseClosed);s.open().catch(ve)}s._state.dbReadyPromise.then(u,f)}).then(a)},Me.prototype.use=function(a){var s=a.stack,u=a.create,f=a.level,h=a.name;return h&&this.unuse({stack:s,name:h}),a=this._middlewares[s]||(this._middlewares[s]=[]),a.push({stack:s,create:u,level:f??10,name:h}),a.sort(function(p,g){return p.level-g.level}),this},Me.prototype.unuse=function(a){var s=a.stack,u=a.name,f=a.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return f?h.create!==f:!!u&&h.name!==u})),this},Me.prototype.open=function(){var a=this;return qr(dr,function(){return Uh(a)})},Me.prototype._close=function(){var a=this._state,s=yn.indexOf(this);if(0<=s&&yn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new V(function(u){a.dbReadyResolve=u}),a.openCanceller=new V(function(u,f){a.cancelOpen=f}))},Me.prototype.close=function(u){var s=(u===void 0?{disableAutoOpen:!0}:u).disableAutoOpen,u=this._state;s?(u.isBeingOpened&&u.cancelOpen(new Z.DatabaseClosed),this._close(),u.autoOpen=!1,u.dbOpenError=new Z.DatabaseClosed):(this._close(),u.autoOpen=this._options.autoOpen||u.isBeingOpened,u.openComplete=!1,u.dbOpenError=null)},Me.prototype.delete=function(a){var s=this;a===void 0&&(a={disableAutoOpen:!0});var u=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new V(function(h,p){function g(){s.close(a);var b=s._deps.indexedDB.deleteDatabase(s.name);b.onsuccess=ke(function(){var x,I,O;x=s._deps,I=s.name,O=x.indexedDB,x=x.IDBKeyRange,Qo(O)||I===ha||Vo(O,x).delete(I).catch(ve),h()}),b.onerror=Nt(p),b.onblocked=s._fireOnBlocked}if(u)throw new Z.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(g):g()})},Me.prototype.backendDB=function(){return this.idbdb},Me.prototype.isOpen=function(){return this.idbdb!==null},Me.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},Me.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Me.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Me.prototype,"tables",{get:function(){var a=this;return c(this._allTables).map(function(s){return a._allTables[s]})},enumerable:!1,configurable:!0}),Me.prototype.transaction=function(){var a=(function(s,u,f){var h=arguments.length;if(h<2)throw new Z.InvalidArgument("Too few arguments");for(var p=new Array(h-1);--h;)p[h-1]=arguments[h];return f=p.pop(),[s,Be(p),f]}).apply(this,arguments);return this._transaction.apply(this,a)},Me.prototype._transaction=function(a,s,u){var f=this,h=J.trans;h&&h.db===this&&a.indexOf("!")===-1||(h=null);var p,g,b=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(g=s.map(function(I){if(I=I instanceof f.Table?I.name:I,typeof I!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return I}),a=="r"||a===$o)p=$o;else{if(a!="rw"&&a!=Ao)throw new Z.InvalidArgument("Invalid transaction mode: "+a);p=Ao}if(h){if(h.mode===$o&&p===Ao){if(!b)throw new Z.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&g.forEach(function(I){if(h&&h.storeNames.indexOf(I)===-1){if(!b)throw new Z.SubTransaction("Table "+I+" not included in parent transaction.");h=null}}),b&&h&&!h.active&&(h=null)}}catch(I){return h?h._promise(null,function(O,_){_(I)}):Re(I)}var x=(function I(O,_,M,k,C){return V.resolve().then(function(){var R=J.transless||J,D=O._createTransaction(_,M,O._dbSchema,k);if(D.explicit=!0,R={trans:D,transless:R},k)D.idbtrans=k.idbtrans;else try{D.create(),D.idbtrans._explicit=!0,O._state.PR1398_maxLoop=3}catch($){return $.name===ko.InvalidState&&O.isOpen()&&0<--O._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),O.close({disableAutoOpen:!1}),O.open().then(function(){return I(O,_,M,null,C)})):Re($)}var L,T=xe(C);return T&&vn(),R=V.follow(function(){var $;(L=C.call(D,D))&&(T?($=mr.bind(null,null),L.then($,$)):typeof L.next=="function"&&typeof L.throw=="function"&&(L=ts(L)))},R),(L&&typeof L.then=="function"?V.resolve(L).then(function($){return D.active?$:Re(new Z.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):R.then(function(){return L})).then(function($){return k&&D._resolve(),D._completion.then(function(){return $})}).catch(function($){return D._reject($),Re($)})})}).bind(null,this,p,g,h,u);return h?h._promise(p,x,"lock"):J.trans?qr(J.transless,function(){return f._whenReady(x)}):this._whenReady(x)},Me.prototype.table=function(a){if(!y(this._allTables,a))throw new Z.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},Me);function Me(a,s){var u=this;this._middlewares={},this.verno=0;var f=Me.dependencies;this._options=s=n({addons:Me.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},f=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,p,g,b,x,I={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:ve,dbReadyPromise:null,cancelOpen:ve,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};I.dbReadyPromise=new V(function(_){I.dbReadyResolve=_}),I.openCanceller=new V(function(_,M){I.cancelOpen=M}),this._state=I,this.name=a,this.on=ni(this,"populate","blocked","versionchange","close",{ready:[Io,ve]}),this.on.ready.subscribe=Q(this.on.ready.subscribe,function(_){return function(M,k){Me.vip(function(){var C,R=u._state;R.openComplete?(R.dbOpenError||V.resolve().then(M),k&&_(M)):R.onReadyBeingFired?(R.onReadyBeingFired.push(M),k&&_(M)):(_(M),C=u,k||_(function D(){C.on.ready.unsubscribe(M),C.on.ready.unsubscribe(D)}))})}}),this.Collection=(h=this,ii(Lh.prototype,function(L,D){this.db=h;var k=Qc,C=null;if(D)try{k=D()}catch(T){C=T}var R=L._ctx,D=R.table,L=D.hook.reading.fire;this._ctx={table:D,index:R.index,isPrimKey:!R.index||D.schema.primKey.keyPath&&R.index===D.schema.primKey.name,range:k,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:C,or:R.or,valueMapper:L!==Xn?L:null}})),this.Table=(p=this,ii(Xc.prototype,function(_,M,k){this.db=p,this._tx=k,this.name=_,this.schema=M,this.hook=p._allTables[_]?p._allTables[_].hook:ni(null,{creating:[xh,ve],reading:[Sh,Xn],updating:[Ih,ve],deleting:[kh,ve]})})),this.Transaction=(g=this,ii(Ah.prototype,function(_,M,k,C,R){var D=this;this.db=g,this.mode=_,this.storeNames=M,this.schema=k,this.chromeTransactionDurability=C,this.idbtrans=null,this.on=ni(this,"complete","error","abort"),this.parent=R||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new V(function(L,T){D._resolve=L,D._reject=T}),this._completion.then(function(){D.active=!1,D.on.complete.fire()},function(L){var T=D.active;return D.active=!1,D.on.error.fire(L),D.parent?D.parent._reject(L):T&&D.idbtrans&&D.idbtrans.abort(),Re(L)})})),this.Version=(b=this,ii(Hh.prototype,function(_){this.db=b,this._cfg={version:_,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(x=this,ii(nu.prototype,function(_,M,k){if(this.db=x,this._ctx={table:_,index:M===":id"?null:M,or:k},this._cmp=this._ascending=he,this._descending=function(C,R){return he(R,C)},this._max=function(C,R){return 0<he(C,R)?C:R},this._min=function(C,R){return he(C,R)<0?C:R},this._IDBKeyRange=x._deps.IDBKeyRange,!this._IDBKeyRange)throw new Z.MissingAPI})),this.on("versionchange",function(_){0<_.newVersion?console.warn("Another connection wants to upgrade database '".concat(u.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(u.name,"'. Closing db now to resume the delete request.")),u.close({disableAutoOpen:!1})}),this.on("blocked",function(_){!_.newVersion||_.newVersion<_.oldVersion?console.warn("Dexie.delete('".concat(u.name,"') was blocked")):console.warn("Upgrade '".concat(u.name,"' blocked by other connection holding version ").concat(_.oldVersion/10))}),this._maxKey=ci(s.IDBKeyRange),this._createTransaction=function(_,M,k,C){return new u.Transaction(_,M,k,u._options.chromeTransactionDurability,C)},this._fireOnBlocked=function(_){u.on("blocked").fire(_),yn.filter(function(M){return M.name===u.name&&M!==u&&!M._state.vcFired}).map(function(M){return M.on("versionchange").fire(_)})},this.use(Vh),this.use(Jh),this.use(Qh),this.use(Wh),this.use(zh);var O=new Proxy(this,{get:function(_,M,k){if(M==="_vip")return!0;if(M==="table")return function(R){return Ca(u.table(R),O)};var C=Reflect.get(_,M,k);return C instanceof Xc?Ca(C,O):M==="tables"?C.map(function(R){return Ca(R,O)}):M==="_createTransaction"?function(){return Ca(C.apply(this,arguments),O)}:C}});this.vip=O,f.forEach(function(_){return _(u)})}var Oa,bt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Xh=(as.prototype.subscribe=function(a,s,u){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:s,complete:u})},as.prototype[bt]=function(){return this},as);function as(a){this._subscribe=a}try{Oa={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{Oa={indexedDB:null,IDBKeyRange:null}}function gu(a){var s,u=!1,f=new Xh(function(h){var p=xe(a),g,b=!1,x={},I={},O={get closed(){return b},unsubscribe:function(){b||(b=!0,g&&g.abort(),_&&yr.storagemutated.unsubscribe(k))}};h.start&&h.start(O);var _=!1,M=function(){return To(C)},k=function(R){ka(x,R),Jo(I,x)&&M()},C=function(){var R,D,L;!b&&Oa.indexedDB&&(x={},R={},g&&g.abort(),g=new AbortController,L=function(T){var $=mn();try{p&&vn();var B=hr(a,T);return B=p?B.finally(mr):B}finally{$&&pn()}}(D={subscr:R,signal:g.signal,requery:M,querier:a,trans:null}),Promise.resolve(L).then(function(T){u=!0,s=T,b||D.signal.aborted||(x={},function($){for(var B in $)if(y($,B))return;return 1}(I=R)||_||(yr(si,k),_=!0),To(function(){return!b&&h.next&&h.next(T)}))},function(T){u=!1,["DatabaseClosedError","AbortError"].includes(T==null?void 0:T.name)||b||To(function(){b||h.error&&h.error(T)})}))};return setTimeout(M,0),O});return f.hasValue=function(){return u},f.getValue=function(){return s},f}var Ur=Gt;function os(a){var s=gr;try{gr=!0,yr.storagemutated.fire(a),es(a,!0)}finally{gr=s}}E(Ur,n(n({},ia),{delete:function(a){return new Ur(a,{addons:[]}).delete()},exists:function(a){return new Ur(a,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return s=Ur.dependencies,u=s.indexedDB,s=s.IDBKeyRange,(Qo(u)?Promise.resolve(u.databases()).then(function(f){return f.map(function(h){return h.name}).filter(function(h){return h!==ha})}):Vo(u,s).toCollection().primaryKeys()).then(a)}catch{return Re(new Z.MissingAPI)}var s,u},defineClass:function(){return function(a){d(this,a)}},ignoreTransaction:function(a){return J.trans?qr(J.transless,a):a()},vip:Go,async:function(a){return function(){try{var s=ts(a.apply(this,arguments));return s&&typeof s.then=="function"?s:V.resolve(s)}catch(u){return Re(u)}}},spawn:function(a,s,u){try{var f=ts(a.apply(u,s||[]));return f&&typeof f.then=="function"?f:V.resolve(f)}catch(h){return Re(h)}},currentTransaction:{get:function(){return J.trans||null}},waitFor:function(a,s){return s=V.resolve(typeof a=="function"?Ur.ignoreTransaction(a):a).timeout(s||6e4),J.trans?J.trans.waitFor(s):s},Promise:V,debug:{get:function(){return Bt},set:function(a){Fc(a)}},derive:P,extend:d,props:E,override:Q,Events:ni,on:yr,liveQuery:gu,extendObservabilitySet:ka,getByKeyPath:X,setByKeyPath:ee,delByKeyPath:function(a,s){typeof s=="string"?ee(a,s,void 0):"length"in s&&[].map.call(s,function(u){ee(a,u,void 0)})},shallowClone:me,deepClone:Ee,getObjectDiff:rs,cmp:he,asap:te,minKey:-1/0,addons:[],connections:yn,errnames:ko,dependencies:Oa,cache:Hr,semVer:"4.0.10",version:"4.0.10".split(".").map(function(a){return parseInt(a)}).reduce(function(a,s,u){return a+s/Math.pow(10,2*u)})})),Ur.maxKey=ci(Ur.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(yr(si,function(a){gr||(a=new CustomEvent(qo,{detail:a}),gr=!0,dispatchEvent(a),gr=!1)}),addEventListener(qo,function(a){a=a.detail,gr||os(a)}));var wn,gr=!1,bu=function(){};return typeof BroadcastChannel<"u"&&((bu=function(){(wn=new BroadcastChannel(qo)).onmessage=function(a){return a.data&&os(a.data)}})(),typeof wn.unref=="function"&&wn.unref(),yr(si,function(a){gr||wn.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!Gt.disableBfCache&&a.persisted){Bt&&console.debug("Dexie: handling persisted pagehide"),wn!=null&&wn.close();for(var s=0,u=yn;s<u.length;s++)u[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!Gt.disableBfCache&&a.persisted&&(Bt&&console.debug("Dexie: handling persisted pageshow"),bu(),os({all:new Ge(-1/0,[[]])}))})),V.rejectionMapper=function(a,s){return!a||a instanceof de||a instanceof TypeError||a instanceof SyntaxError||!a.name||!qc[a.name]?a:(s=new qc[a.name](s||a.message,a),"stack"in a&&w(s,"stack",{get:function(){return this.inner.stack}}),s)},Fc(Bt),n(Gt,Object.freeze({__proto__:null,Dexie:Gt,liveQuery:gu,Entity:Gc,cmp:he,PropModSymbol:Qt,PropModification:ai,replacePrefix:function(a,s){return new ai({replacePrefix:[a,s]})},add:function(a){return new ai({add:a})},remove:function(a){return new ai({remove:a})},default:Gt,RangeSet:Ge,mergeRanges:fi,rangesOverlap:cu}),{default:Gt}),Gt})}(Ua)),Ua.exports}var nw=rw();const Gs=ew(nw),ol=Symbol.for("Dexie"),ao=globalThis[ol]||(globalThis[ol]=Gs);if(Gs.semVer!==ao.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Gs.semVer} and ${ao.semVer}`);const{liveQuery:N0,mergeRanges:j0,rangesOverlap:q0,RangeSet:F0,cmp:K0,Entity:H0,PropModSymbol:U0,PropModification:W0,replacePrefix:z0,add:V0,remove:Q0}=ao;var oo="docs",iw="changes",sl="attachments",Hd="dexie",cl=new Map,Wa=new Map;function aw(e,t,r,n){var i="rxdb-dexie-"+e+"--"+n.version+"--"+t,o=Tt(cl,i,()=>{var c=(async()=>{var l=Ie(r);l.autoOpen=!1;var d=new ao(i,l);r.onCreate&&await r.onCreate(d,i);var v={[oo]:cw(n),[iw]:"++sequence, id",[sl]:"id"};return d.version(1).stores(v),await d.open(),{dexieDb:d,dexieTable:d[oo],dexieAttachmentsTable:d[sl],booleanIndexes:uw(n)}})();return cl.set(i,o),Wa.set(o,0),c});return o}async function ow(e){var t=await e,r=Wa.get(e),n=r-1;n===0?(t.dexieDb.close(),Wa.delete(e)):Wa.set(e,n)}var Ys="__";function Jn(e){var t=e.split(".");if(t.length>1)return t.map(n=>Jn(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return Ys+r}else return e}function Ud(e){var t=e.split(".");if(t.length>1)return t.map(n=>Ud(n)).join(".");if(e.startsWith(Ys)){var r=e.substring(Ys.length);return"|"+r}else return e}function sw(e,t){if(!t)return t;var r=Ie(t);return r=Js(r),e.forEach(n=>{var i=Mr(t,n),o=i?"1":"0",c=Jn(n);Hl(r,c,o)}),r}function Wd(e,t){return t&&(t=Ie(t),t=Xs(t),e.forEach(r=>{var n=Mr(t,r),i=n==="1";Hl(t,r,i)}),t)}function Js(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Js(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=Js(n)),t[Jn(r)]=n}),t}}function Xs(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Xs(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=Xs(n)),t[Ud(r)]=n}),t}}function cw(e){var t=[],r=pt(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(o=>{var c=ic(o);t.push(c)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(o=>o.map(c=>Jn(c)));var n=t.map(o=>o.length===1?o[0]:"["+o.join("+")+"]");n=n.filter((o,c,l)=>l.indexOf(o)===c);var i=n.join(", ");return i}async function ul(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(i=>Wd(r.booleanIndexes,i))}function Ta(e,t){return e+"||"+t}function uw(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var i=ic(n);i.forEach(o=>{if(!t.has(o)){t.add(o);var c=Nn(e,o);c.type==="boolean"&&r.push(o)}})}),r.push("_deleted"),om(r)):r}function ll(e){return e===Cn?-1/0:e}function fl(e,t,r){if(e.includes(t)){var n=r===Dn||r===!0?"1":"0";return n}else return r}function zd(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((c,l)=>{var d=t.index[l];return fl(e,d,c)}).map(ll),i=t.endKeys.map((c,l)=>{var d=t.index[l];return fl(e,d,c)}).map(ll),o=r.bound(n,i,!t.inclusiveStart,!t.inclusiveEnd);return o}async function dl(e,t){var r=await e.internals,n=t.query,i=n.skip?n.skip:0,o=n.limit?n.limit:1/0,c=i+o,l=t.queryPlan,d=!1;l.selectorSatisfiedByIndex||(d=gc(e.schema,t.query));var v=zd(r.booleanIndexes,l,r.dexieDb._options.IDBKeyRange),m=l.index,y=[];if(await r.dexieDb.transaction("r",r.dexieTable,async S=>{var w=S.idbtrans,P=w.objectStore(oo),A,N;N="["+m.map(Q=>Jn(Q)).join("+")+"]",A=P.index(N);var H=A.openCursor(v);await new Promise(Q=>{H.onsuccess=function(se){var te=se.target.result;if(te){var X=Wd(r.booleanIndexes,te.value);(!d||d(X))&&y.push(X),l.sortSatisfiedByIndex&&y.length===c?Q():te.continue()}else Q()}})}),!l.sortSatisfiedByIndex){var E=id(e.schema,t.query);y=y.sort(E)}return y=y.slice(i,c),{documents:y}}async function lw(e,t){var r=await e.internals,n=t.queryPlan,i=n.index,o=zd(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),c=-1;return await r.dexieDb.transaction("r",r.dexieTable,async l=>{var d=l.idbtrans,v=d.objectStore(oo),m,y;y="["+i.map(S=>Jn(S)).join("+")+"]",m=v.index(y);var E=m.count(o);c=await new Promise((S,w)=>{E.onsuccess=function(){S(E.result)},E.onerror=P=>w(P)})}),c}var fw=mt(),Ss=!1,dw=function(){function e(r,n,i,o,c,l,d,v){this.changes$=new Dt,this.instanceId=fw++,this.storage=r,this.databaseName=n,this.collectionName=i,this.schema=o,this.internals=c,this.options=l,this.settings=d,this.devMode=v,this.primaryPath=pt(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,i){zr(this),!Ss&&!await Wl()&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium/?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),Ss=!0,n.forEach(m=>{if(!m.document._rev||m.previous&&!m.previous._rev)throw Y("SNH",{args:{row:m}})});var o=await this.internals,c={error:[]};this.devMode&&(n=n.map(m=>{var y=ta(m.document);return{previous:m.previous,document:y}}));var l=n.map(m=>m.document[this.primaryPath]),d;if(await o.dexieDb.transaction("rw",o.dexieTable,o.dexieAttachmentsTable,async()=>{var m=new Map,y=await ul(this.internals,l);y.forEach(w=>{var P=w;return P&&m.set(P[this.primaryPath],P),P}),d=Hv(this,this.primaryPath,m,n,i),c.error=d.errors;var E=[];d.bulkInsertDocs.forEach(w=>{E.push(w.document)}),d.bulkUpdateDocs.forEach(w=>{E.push(w.document)}),E=E.map(w=>sw(o.booleanIndexes,w)),E.length>0&&await o.dexieTable.bulkPut(E);var S=[];d.attachmentsAdd.forEach(w=>{S.push({id:Ta(w.documentId,w.attachmentId),data:w.attachmentData.data})}),d.attachmentsUpdate.forEach(w=>{S.push({id:Ta(w.documentId,w.attachmentId),data:w.attachmentData.data})}),await o.dexieAttachmentsTable.bulkPut(S),await o.dexieAttachmentsTable.bulkDelete(d.attachmentsRemove.map(w=>Ta(w.documentId,w.attachmentId)))}),d=oe(d),d.eventBulk.events.length>0){var v=oe(d.newestRow).document;d.eventBulk.checkpoint={id:v[this.primaryPath],lwt:v._meta.lwt},this.changes$.next(d.eventBulk)}return c},t.findDocumentsById=async function(n,i){zr(this);var o=await this.internals,c=[];return await o.dexieDb.transaction("r",o.dexieTable,async()=>{var l=await ul(this.internals,n);l.forEach(d=>{d&&(!d._deleted||i)&&c.push(d)})}),c},t.query=function(n){return zr(this),dl(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var i=await lw(this,n);return{count:i,mode:"fast"}}else{var o=await dl(this,n);return{count:o.documents.length,mode:"slow"}}},t.changeStream=function(){return zr(this),this.changes$.asObservable()},t.cleanup=async function(n){zr(this);var i=await this.internals;return await i.dexieDb.transaction("rw",i.dexieTable,async()=>{var o=mt()-n,c=await i.dexieTable.where("_meta.lwt").below(o).toArray(),l=[];c.forEach(d=>{d._deleted==="1"&&l.push(d[this.primaryPath])}),await i.dexieTable.bulkDelete(l)}),!0},t.getAttachmentData=async function(n,i,o){zr(this);var c=await this.internals,l=Ta(n,i);return await c.dexieDb.transaction("r",c.dexieAttachmentsTable,async()=>{var d=await c.dexieAttachmentsTable.get(l);if(d)return d.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+i)})},t.remove=async function(){zr(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await ow(this.internals)})(),this.closed)},e}();async function hw(e,t,r){var n=aw(t.databaseName,t.collectionName,r,t.schema),i=new dw(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await Xb(Hd,t,i),Promise.resolve(i)}function zr(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var mw=function(){function e(r){this.name=Hd,this.rxdbVersion=Ul,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){if(zv(n),n.schema.indexes){var i=n.schema.indexes.flat();i.filter(o=>!o.includes(".")).forEach(o=>{if(!n.schema.required||!n.schema.required.includes(o))throw Y("DXE1",{field:o,schema:n.schema})})}return hw(this,n,this.settings)},e}();function pw(e={}){var t=new mw(e);return t}var vw=["__proto__","constructor","prototype"];function pi(e,t){Object.keys(t).forEach(r=>{vw.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:bi(t[r])?pi(e[r],t[r]):e[r]=t[r])})}function bi(e){return e.toString()==="[object Object]"}var Eo=function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var i=this;r.selector&&i.find(r.selector),r.limit&&i.limit(r.limit),r.skip&&i.skip(r.skip),r.sort&&r.sort.forEach(o=>i.sort(o))}}var t=e.prototype;return t.where=function(n,i){if(!arguments.length)return this;var o=typeof arguments[0];if(o==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(o==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw xt("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var i=this._path;return this._conditions[i]=n,this},t.eq=function(n){this._ensurePath("eq");var i=this._path;return this._conditions[i]=n,this},t.or=function(n){var i=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.nor=function(n){var i=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.and=function(n){var i=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.mod=function(n,i){var o,c;arguments.length===1?(this._ensurePath("mod"),o=arguments[0],c=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),o=arguments.slice(),c=this._path):arguments.length===3?(o=arguments.slice(1),c=arguments[0]):(o=arguments[1],c=arguments[0]);var l=this._conditions[c]||(this._conditions[c]={});return l.$mod=o,this},t.exists=function(n,i){var o,c;arguments.length===0?(this._ensurePath("exists"),o=this._path,c=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),o=this._path,c=arguments[0]):(o=arguments[0],c=!0):arguments.length===2&&(o=arguments[0],c=arguments[1]);var l=this._conditions[o]||(this._conditions[o]={});return l.$exists=c,this},t.elemMatch=function(n,i){if(arguments[0]===null)throw xt("MQ2");var o,c,l;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),c=this._path,o=arguments[0];else if(bi(arguments[0]))this._ensurePath("elemMatch"),c=this._path,l=arguments[0];else if(typeof arguments[1]=="function")c=arguments[0],o=arguments[1];else if(arguments[1]&&bi(arguments[1]))c=arguments[0],l=arguments[1];else throw xt("MQ2");o&&(l=new e,o(l),l=l._conditions);var d=this._conditions[c]||(this._conditions[c]={});return d.$elemMatch=l,this},t.sort=function(n){if(!n)return this;var i,o=typeof n;if(Array.isArray(n)){i=n.length;for(var c=0;c<n.length;++c)gw(this.options,n[c][0],n[c][1]);return this}if(arguments.length===1&&o==="string"){n=n.split(/\s+/),i=n.length;for(var l=0;l<i;++l){var d=n[l];if(d){var v=d[0]==="-"?-1:1;v===-1&&(d=d.substring(1)),hl(this.options,d,v)}}return this}if(bi(n)){var m=Object.keys(n);return m.forEach(y=>hl(this.options,y,n[y])),this}throw xt("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!ml(n))throw xt("MQ4",{source:n});return n instanceof e?(n._conditions&&pi(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),pi(this._fields,n._fields)),n.options&&(this.options||(this.options={}),pi(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(pi(this._conditions,n),this)},t.find=function(n){return ml(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw Y("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=yw(this.options.sort)),{query:n,path:this._path}},e}();function yw(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",i={[t]:n};return i})}var Vd=["limit","skip","maxScan","batchSize","comment"];Vd.forEach(function(e){Eo.prototype[e]=function(t){return this.options[e]=t,this}});var Qd=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];Qd.forEach(function(e){Eo.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw Y("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function hl(e,t,r){if(Array.isArray(e.sort))throw xt("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var i=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(i))throw Array.isArray(r)&&(r="["+r+"]"),xt("MQ7",{field:t,value:r});var o=e.sort||(e.sort={}),c=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");o[t]=parseInt(c,10)}function gw(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw xt("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function ml(e){return e instanceof Eo||bi(e)}function bw(e,t){return new Eo(e,t)}var pl="queryBuilderPath";function ww(e,t,r){var n=bw(tt(e.mangoQuery),e.other[pl]);n[t](r);var i=n.toJSON();return En(e.op,i.query,e.collection,{...e.other,[pl]:i.path})}function xs(e,t){e[t]=function(r){if(ye.isDevMode()&&this.op==="findByIds")throw Y("QU17",{collection:this.collection.name,query:this.mangoQuery});return ww(this,t,r)}}var _w={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{xs(e,t)}),Vd.forEach(t=>{xs(e,t)}),Qd.forEach(t=>{xs(e,t)})}}};async function Gd(e){var t=Am(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>Un(n,nn)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function Ew(e,t,r){var n=Ie(r._attachments),i=tt(r),o=i._meta;delete i._meta,i._attachments=n;for(var c=t+1,l=Promise.resolve(i),d=function(){var v=c;l=l.then(m=>Sw(e,v,m)),c++};c<=e.schema.version;)d();return l.then(v=>v===null?oc:(v._meta=o,v))}function Sw(e,t,r){if(r===null)return oc;var n=e.migrationStrategies[t](r,e),i=mm(n);return i}async function Yd(e){if(e.collection.schema.version===0)return or;var t=await Gd(e);return!!t}var xw=200,Jd=new WeakMap;function kw(e){var t=Xd(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function Xd(e){return Tt(Jd,e,()=>new _r([]))}function Iw(e){var t=Jd.get(e);t&&t.complete()}var Dw=function(){function e(r,n,i=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=pm,this.collection=r,this.migrationStrategies=n,this.statusDocKey=i,this.database=r.database,this.oldCollectionMeta=Gd(this),this.mustMigrate=Yd(this),this.statusDocId=Un(this.statusDocKey,Fa),kw(this),this.$=Kv(this.database.internalStore,this.statusDocId).pipe(_e(o=>!!o),$e(o=>oe(o).data),Yi(Wi))}var t=e.prototype;return t.getStatus=function(){return rn(this.$)},t.startMigration=async function(n=xw){var i=await this.mustMigrate;if(i){if(this.started)throw Y("DM1");this.started=!0;var o=void 0;if(this.database.multiInstance){o=new _o(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var c=Yb(o);await c.awaitLeadership()}var l=await this.oldCollectionMeta,d=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:l.data.schema,password:this.database.password,devMode:ye.isDevMode()}),v=await this.getConnectedStorageInstances(),m=await this.countAllDoucments([d].concat(v.map(y=>y.oldStorage)));await this.updateStatus(y=>(y.count.total=m,y));try{await Promise.all(v.map(async y=>{await fg(this.collection,y.newStorage.collectionName,y.newStorage.schema),await this.migrateStorage(y.oldStorage,y.newStorage,n),await y.newStorage.close()})),await this.migrateStorage(d,this.collection.storageInstance.originalStorageInstance,n)}catch(y){await d.close(),await this.updateStatus(E=>(E.status="ERROR",E.error=_m(y),E));return}await $i(this.database.internalStore,{previous:l,document:Object.assign({},l,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(y=>(y.status="DONE",y)),o&&await o.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var i=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var o=await ea(this.database.internalStore,this.statusDocId),c=tt(o);o||(c={id:this.statusDocId,key:this.statusDocKey,context:Fa,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:Qn(),_rev:Lt(),_attachments:{}});var l=oe(c).data;for(var d of i)l=d(l);if(l.count.percent=Math.round(l.count.handled/l.count.total*100),c&&o&&xi(c.data,o.data))break;try{await $i(this.database.internalStore,{previous:o,document:oe(c)},Fa);break}catch(v){if(!ho(v))throw v}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,i,o){var c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:Xu(n.schema,Fs(n.schema)),password:this.database.password,devMode:ye.isDevMode()}),l=jg(i,eo,this.database.token,!0),d=Ag({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async m=>{m=await Promise.all(m.map(async E=>{var S=E.newDocumentState;if(i.schema.title===Ha&&(S=E.newDocumentState.docData,E.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:E.newDocumentState};var w=await Ew(this.collection,n.schema.version,S),P={assumedMasterState:void 0,newDocumentState:i.schema.title===Ha?Object.assign({},E.newDocumentState,{docData:w}):w};return P})),m=m.filter(E=>!!E.newDocumentState);var y=await l.masterWrite(m);return y},masterChangeStream$:new Dt().asObservable()},forkInstance:n,metaInstance:c,pushBatchSize:o,pullBatchSize:0,conflictHandler:eo,hashFunction:this.database.hashFunction}),v=!1;if(d.events.error.subscribe(m=>v=m),d.events.processed.up.subscribe(()=>{this.updateStatus(m=>(m.count.handled=m.count.handled+1,m))}),await Bg(d),await Ng(d),await qg(d),await this.updateStatusQueue,v)throw await c.close(),v;await Promise.all([n.remove(),c.remove()])},t.countAllDoucments=async function(n){var i=0;return await Promise.all(n.map(async o=>{var c=go(o.schema,Pn(o.schema,{selector:{}})),l=await o.count(c);i+=l.count})),i},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,i=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async o=>{if(o.schema.title!==Ha)throw new Error("unknown migration handling for schema");var c=Xu(tt(this.collection.schema.jsonSchema),Fs(o.schema));c.version=this.collection.schema.version;var[l,d]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:ye.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:o.schema,password:this.database.password,collectionName:o.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:ye.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:c,password:this.database.password,collectionName:o.collectionName})]);i.push({oldStorage:l,newStorage:d})}))),i},t.migratePromise=async function(n){this.startMigration(n);var i=await this.mustMigrate;if(!i)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var o=await Promise.race([rn(this.$.pipe(_e(c=>c.status==="DONE"))),rn(this.$.pipe(_e(c=>c.status==="ERROR")))]);if(o.status==="ERROR")throw Y("DM4",{collection:this.collection.name,error:o.error});return o},e}(),Cw=cd(),Ow=function(e){function t(r,n,i){var o;return o=e.call(this,null,n)||this,o.id=r,o.parent=i,o}return sc(t,e),t}(Cw),wi={get isLocal(){return!0},get allAttachments$(){throw Y("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=Bn(Zs,this.parent),r=this.primary;return e.parent.eventBulks$.pipe(_e(n=>!!n.isLocal),$e(n=>n.events.find(i=>i.documentId===r)),_e(n=>!!n),$e(n=>gf(oe(n))),Ji(t.docCache.getLatestDocumentData(this.primary)),Di((n,i)=>n._rev===i._rev),$e(n=>t.docCache.getCachedRxDocument(n)),Yi(Wi))},get $$(){var e=this,t=ks(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=ks(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=Bn(Zs,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw xt("LD2",{objPath:e});var t=Mr(this._data,e);return t=ye.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,ye.isDevMode()){if(e.includes(".item."))throw Y("LD3",{objPath:e});if(e===this.primaryPath)throw Y("LD4")}return this.$.pipe($e(t=>t._data),$e(t=>Mr(t,e)),Di())},get$$(e){var t=ks(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await _i(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await _i(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(i=>{if(i.error[0])throw i.error[0];var o=Pt(this.collection.schema.primaryPath,n,i)[0];e=Ie(e),e._rev=o._rev})},async remove(){var e=await _i(this.parent),t=Ie(this._data);return t._deleted=!0,$i(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},vl=!1,Pw=()=>{if(!vl){vl=!0;var e=bo,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var i=Object.getOwnPropertyDescriptor(wi,n);if(!i){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(wi,n,o)}});var r=n=>()=>{throw Y("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>wi[n]=r(n))}};function Rw(e,t){Pw();var r=new Ow(e.id,e,t);return Object.setPrototypeOf(r,wi),r.prototype=wi,r}function ks(e){var t=e.parent;return Og(t)?t:t.database}var so=new WeakMap,Zs=new WeakMap;function yl(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var i=await Zd(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);i=bc(t,i,eh);var o=new pd("id",t.eventBulks$.pipe(_e(m=>{var y=!1;return(r===""&&!m.collectionName||r!==""&&m.collectionName===r)&&(y=!0),y&&m.isLocal}),$e(m=>m.events)),m=>Rw(m,e)),c=new sd(i,"id",()=>{},()=>{}),l=await t.storageToken,d=i.changeStream().subscribe(m=>{for(var y=new Array(m.events.length),E=m.events,S=e.database?e.name:void 0,w=0;w<E.length;w++){var P=E[w];y[w]={documentId:P.documentId,collectionName:S,isLocal:!0,operation:P.operation,documentData:ye.deepFreezeWhenDevMode(P.documentData),previousDocumentData:ye.deepFreezeWhenDevMode(P.previousDocumentData)}}var A={id:m.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:l,events:y,databaseToken:t.token,checkpoint:m.checkpoint,context:m.context};t.$emit(A)});e._subs.push(d);var v={database:t,parent:e,storageInstance:i,docCache:o,incrementalWriteQueue:c};return Zs.set(e,v),v})();so.set(e,n)}function _i(e){var t=so.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw Y("LD8",{database:r.name,collection:n})}return t}function Zd(e,t,r,n,i,o){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:Mw(n),schema:eh,options:i,multiInstance:o,devMode:ye.isDevMode()})}function gl(e){var t=so.get(e);if(t)return so.delete(e),t.then(r=>r.storageInstance.close())}async function bl(e,t,r){var n=Ui(10),i=await Zd(n,e,t,r,{},!1);await i.remove()}function Mw(e){return"plugin-local-documents-"+e}var eh=mo({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function wl(e,t){var r=await _i(this),n={id:e,data:t,_deleted:!1,_meta:Qn(),_rev:Lt(),_attachments:{}};return $i(r.storageInstance,{document:n},"local-document-insert").then(i=>r.docCache.getCachedRxDocument(i))}function _l(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function El(e){var t=await _i(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):ea(t.storageInstance,e).then(i=>i?t.docCache.getCachedRxDocument(i):null)}function Sl(e){return this.$.pipe(Ji(null),cr(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),cr(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),_e(t=>t.use),$e(t=>t.doc))}var Lw={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=wl,e.upsertLocal=_l,e.getLocal=El,e.getLocal$=Sl},RxDatabase:e=>{e.insertLocal=wl,e.upsertLocal=_l,e.getLocal=El,e.getLocal$=Sl}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&yl(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&yl(e.collection)}},preCloseRxDatabase:{after:e=>gl(e)},postCloseRxCollection:{after:e=>gl(e)},postRemoveRxDatabase:{after:e=>bl(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>bl(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},Tw=new WeakMap,$w={name:"migration-schema",rxdb:!0,init(){Ka(Lw)},hooks:{preCloseRxDatabase:{after:Iw}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return Xd(this).pipe(Yi(Wi))}},RxCollection:e=>{e.getMigrationState=function(){return Tt(Tw,this,()=>new Dw(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?or:Yd(this.getMigrationState())}}}},Aw=$w;const So=e=>rt((t,r,n)=>{let i=0;if(fe(r))for(const o of r)i=i|1<<o;else i=r;return e(t&i,i)}),Bw=So((e,t)=>e==0),Nw=So((e,t)=>e==t),jw=So((e,t)=>e<t),qw=So((e,t)=>e>0),Fw=Object.freeze(Object.defineProperty({__proto__:null,$all:jv,$and:Ff,$bitsAllClear:Bw,$bitsAllSet:Nw,$bitsAnyClear:jw,$bitsAnySet:qw,$elemMatch:ed,$eq:Uf,$exists:rd,$expr:Av,$gt:Wf,$gte:zf,$in:Vf,$jsonSchema:Bv,$lt:Qf,$lte:Gf,$mod:Xf,$ne:Yf,$nin:Jf,$nor:Kf,$not:Hf,$or:yc,$regex:Zf,$size:td,$type:nd,$where:Nv},Symbol.toStringTag,{value:"Module"})),nt={cloneMode:"copy",queryOptions:Cf({context:fn.init().addQueryOps(Fw).addExpressionOps(kv).addExpressionOps(Lv)})},Mc=(e,t)=>{switch(e){case"deep":return Hn(t);case"copy":return Fn(t)?new Date(t):fe(t)?[...t]:Ae(t)?{...t}:rr(t)?new RegExp(t):t;default:return t}},Kw=/^[a-z]+[a-zA-Z0-9]*$/;function th(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),i=e.substring(t+3,r);ge(i===""||Kw.test(i),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const o=e.substring(r+2),[c,l]=o?th(o):[];return[{selector:e,parent:n,child:i||"$",next:c},[i,...l||[]].filter(Boolean)]}const ot=(e,t,r,n,i)=>{const{parent:o,child:c,next:l}=t;if(!c){let v=!1;return Ri(e,o,(y,E)=>v=!!n(y,E)||v,i),v}const d=Ht(e,o);return fe(d)?d.map((v,m)=>r[c]&&!r[c].test({[c]:v})?!1:l?ot(v,l,r,n,i):n(d,m)).some(Boolean):!1};function yt(e,t,r,n){const i=[];for(const[o,c]of Object.entries(e)){const[l,d]=th(o);if(!d.length)n(c,l,{})&&i.push(l.parent);else{const v={};t.forEach(y=>{Object.keys(y).forEach(E=>{d.forEach(S=>{(E===S||E.startsWith(S+"."))&&(v[S]=v[S]||{},Object.assign(v[S],{[E]:y[E]}))})})});const m={};for(const[y,E]of Object.entries(v))m[y]=new $r(E,r.queryOptions);n(c,l,m)&&i.push(l.parent)}}return i}const Hw=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>{const l={$each:[i]};return Ae(i)&&At(i,"$each")&&Object.assign(l,i),ot(e,o,c,(d,v)=>{const m=d[v]||(d[v]=[]);return xf([m,l.$each]).length===l.$each.length?!1:(d[v]=Mc(n.cloneMode,Qp(m.concat(l.$each))),!0)},{buildGraph:!0})}),Uw=new Set(["and","or","xor"]),Ww=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>{const l=Object.keys(i);return ge(l.length===1&&Uw.has(l[0]),`Invalid bit operator '${l[0]}'. Must be one of 'and', 'or', or 'xor'.`),ot(e,o,c,(d,v)=>{let m=d[v];const y=i[l[0]];if(m!==void 0&&!(ze(m)&&ze(y)))return!1;switch(m=m||0,l[0]){case"and":d[v]=m&y;break;case"or":d[v]=m|y;break;case"xor":d[v]=m^y;break}return d[v]!==m},{buildGraph:!0})}),zw=(e,t,r=[],n=nt)=>{const i=Date.now();return yt(t,r,n,(o,c,l)=>ot(e,c,l,(d,v)=>(d[v]=i,!0),{buildGraph:!0}))},Vw=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>{if(!o.child){const l=Ht(e,o.parent);ge(l===void 0||ze(l),"cannot apply $inc to a value of non-numeric type")}return ot(e,o,c,(l,d)=>(l[d]=(l[d]||(l[d]=0))+i,!0),{buildGraph:!0})}),Qw=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>ot(e,o,c,(l,d)=>l[d]!==void 0&&Ot(l[d],i)>-1?!1:(l[d]=i,!0),{buildGraph:!0})),Gw=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>ot(e,o,c,(l,d)=>l[d]!==void 0&&Ot(l[d],i)<1?!1:(l[d]=i,!0),{buildGraph:!0})),Yw=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>ot(e,o,c,(l,d)=>{const v=l[d];return l[d]=l[d]===void 0?0:l[d]*i,l[d]!==v},{buildGraph:!0})),Jw=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>ot(e,o,c,(l,d)=>{const v=l[d];return ge(fe(v),`path '${o.selector}' contains an element of non-array type.`),v.length?(i===-1?v.splice(0,1):v.pop(),!0):!1})),rh=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>{const l=!Ae(i)||Object.keys(i).some(Tr),d=new $r(l?{k:i}:i,n.queryOptions),v=l?m=>d.test({k:m}):m=>d.test(m);return ot(e,o,c,(m,y)=>{const E=m[y],S=new Array;return E.map(P=>{const A=v(P);return A||S.push(P),A}).some(Boolean)?(m[y]=S,!0):!1})}),Xw=(e,t,r=[],n=nt)=>{const i={};return Object.entries(t).forEach(([o,c])=>{i[o]={$in:c}}),rh(e,i,r,n)},Zw=Object.freeze(["$each","$slice","$sort","$position"]),e0=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>{const l={$each:[i]};return Ae(i)&&Zw.some(d=>At(i,d))&&Object.assign(l,i),ot(e,o,c,(d,v)=>{const m=d[v]||(d[v]=[]),y=m.slice(0,l.$slice||m.length),E=m.length,S=ze(l.$position)?l.$position:m.length;if(m.splice(S,0,...Mc(n.cloneMode,l.$each)),l.$sort){const w=Ae(l.$sort)?Object.keys(l.$sort||{}).pop():"",P=w?l.$sort[w]:l.$sort,A=w?N=>Ht(N,w):N=>N;m.sort((N,H)=>P*Ot(A(N),A(H)))}return ze(l.$slice)&&(l.$slice<0?m.splice(0,m.length+l.$slice):m.splice(l.$slice)),E!=m.length||!Mt(y,m)},{descendArray:!0,buildGraph:!0})}),nh=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>ot(e,o,c,(l,d)=>Mt(l[d],i)?!1:(l[d]=Mc(n.cloneMode,i),!0),{buildGraph:!0})),t0=(e,t,r=[],n=nt)=>{const i=[],o=yt(t,r,n,(c,l,d)=>ot(e,l,d,(v,m)=>At(v,m)?(i.push(...nh(e,{[c]:v[m]},r,n)),delete v[m],!0):!1));return Array.from(new Set(o.concat(i)))},r0=(e,t,r=[],n=nt)=>yt(t,r,n,(i,o,c)=>ot(e,o,c,(l,d)=>At(l,d)?(fe(l)?l[d]=null:delete l[d],!0):!1)),xl=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:Hw,$bit:Ww,$currentDate:zw,$inc:Vw,$max:Qw,$min:Gw,$mul:Yw,$pop:Jw,$pull:rh,$pullAll:Xw,$push:e0,$rename:t0,$set:nh,$unset:r0},Symbol.toStringTag,{value:"Module"}));function ih(e){return e=e??nt,(t,r,n=[],i={},o=e)=>{const c=Object.entries(r);ge(c.length===1,"Update expression must contain only one operator.");const[l,d]=c[0];ge(At(xl,l),`Update operator '${l}' is not supported.`);const v=xl[l];return Object.keys(i).length&&!new $r(i,o.queryOptions).test(t)?[]:v(t,d,n,o)}}ih();var Is;function ah(e,t){if(!Is){var r=ih({cloneMode:"none"});Is=(n,i)=>{var o=tt(n);return r(o,i),o}}return Is(e,t)}function n0(e){return this.incrementalModify(t=>{var r=ah(t,e);return r})}function i0(e){var t=this._data,r=ah(t,e);return this._saveData(r,t)}async function a0(e){return _n(this.asRxQuery,t=>t.update(e))}var o0={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=i0,e.incrementalUpdate=n0},RxQuery:e=>{e.update=a0}}};let Ds=null,Oe=null,ec;const Wt=new Promise(e=>{ec=e}),s0={title:"chat history schema",version:2,description:"Stores chat sessions",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100},tabId:{type:"number"},timestamp:{type:"number"},title:{type:"string"},messages:{type:"array",items:{type:"object",properties:{messageId:{type:"string",maxLength:100},sender:{type:"string"},text:{type:"string"},timestamp:{type:"number"},isLoading:{type:"boolean",default:!1}},required:["messageId","sender","text","timestamp"]}},isStarred:{type:"boolean",default:!1}},required:["id","timestamp","messages"],indexes:["timestamp"]},c0={1:function(e){return e.isStarred=e.isStarred||!1,e},2:function(e){return e.messages=e.messages.map((t,r)=>({...t,messageId:`${e.id}-msg-${r}-${Date.now()}`,timestamp:e.timestamp||Date.now(),isLoading:!1})),e.timestamp=e.timestamp||Date.now(),e}},u0=async()=>{console.log("DB: Starting RxDB initialization...");try{Ka(_w),console.log("DB: RxDBQueryBuilderPlugin added."),Ka(Aw),console.log("DB: RxDBMigrationSchemaPlugin added."),Ka(o0),console.log("DB: RxDBUpdatePlugin added.");let e=pw();console.log("DB: Creating RxDB database (tabagentdb)..."),Ds=await Dg({name:"tabagentdb",storage:e}),console.log("DB: RxDB database created successfully:",Ds.name),console.log("DB: Adding chatHistory collection (version 2)...");const t=await Ds.addCollections({chatHistory:{schema:s0,migrationStrategies:c0}});if(console.log("DB: Collections object obtained."),Oe=t.chatHistory,!Oe)throw new Error("DB: chatHistory collection is null or undefined after addCollections");return console.log("DB: chatHistory collection assigned successfully"),ec(!0),console.log("DB: RxDB initialization finished successfully."),!0}catch(e){return console.error("-------------------------------------------"),console.error("DB: HIGH-LEVEL RxDB INITIALIZATION FAILED:",e),console.error("Error Name:",e.name),console.error("Error Message:",e.message),e.code&&console.error("RxDB Error Code:",e.code),e.parameters&&console.error("RxDB Error Parameters:",e.parameters),e.rxdb&&console.error("RxDB Specific Flag:",e.rxdb),console.error("Stack Trace:",e.stack),console.error("-------------------------------------------"),ec(!1),!1}};function Bi(e){return`${e}-msg-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}async function tc(e){console.log("DB: Creating new chat session...");try{if(!await Wt||!Oe)throw new Error("Database not ready");const r=`chat_${Date.now()}`,n=Date.now(),i={...e,messageId:Bi(r),timestamp:n},o={id:r,tabId:null,timestamp:n,title:(i.text||"New Chat").substring(0,40)+"...",messages:[i],isStarred:!1};return console.log("DB: Inserting new chat session:",o),await Oe.insert(o),console.log("DB: New chat session created successfully with ID:",r),r}catch(t){throw console.error("DB: Error creating new chat session:",t),t}}async function Jr(e,t){console.log(`DB: Adding message to chat ID: ${e}`);try{if(!await Wt||!Oe)throw new Error("Database not ready");if(!e||!t)throw new Error("Invalid input: chatId and messageObject are required.");const n=await Oe.findOne(e).exec();if(!n)throw new Error(`Chat session with ID ${e} not found`);const i={...t,messageId:t.messageId||Bi(e),timestamp:t.timestamp||Date.now(),isLoading:t.isLoading===void 0?!1:t.isLoading};return await n.update({$push:{messages:i}}),console.log(`DB: Message added successfully to chat ${e}. New message ID: ${i.messageId}`),i.messageId}catch(r){throw console.error(`DB: Error adding message to chat ${e}:`,r),r}}async function rc(e,t,r){console.log(`DB: Updating message ID: ${t} in chat ID: ${e}`);try{if(!await Wt||!Oe)throw new Error("Database not ready");if(!e||!t||!r)throw new Error("Invalid input: chatId, messageId, and updates are required.");const i=await Oe.findOne(e).exec();if(!i)throw new Error(`Chat session with ID ${e} not found`);await i.incrementalModify(o=>{const c=o.messages.findIndex(l=>l.messageId===t);if(c!==-1){const l=o.messages[c];o.messages[c]={...l,...r,messageId:l.messageId},o.timestamp=Date.now(),console.log(`DB: Message ${t} updated in session ${e}.`)}else console.warn(`DB: Message with ID ${t} not found in chat ${e} for update.`);return o})}catch(n){throw console.error(`DB: Error updating message ${t} in chat ${e}:`,n),n}}async function oh(){console.log("DB: Loading all history from DB...");try{if(!await Wt||!Oe)throw new Error("Chat history database is not initialized");const t=await Oe.find().sort({timestamp:"desc"}).exec();return console.log(`DB: Loaded ${t.length} history entries.`),t.map(r=>r.toJSON())}catch(e){throw console.error("DB: Error loading chat history:",e),e}}async function Wn(e){console.log(`DB: Getting chat session by ID: ${e}`);try{if(!await Wt||!Oe)throw new Error("Database not initialized");const r=await Oe.findOne(e).exec();return r?r.toJSON():(console.warn(`DB: Chat session with ID ${e} not found.`),null)}catch(t){throw console.error(`DB: Error getting chat session ${e}:`,t),t}}async function sh(e){console.log(`DB: Toggling starred status for item ID: ${e}`);try{if(!await Wt||!Oe)throw new Error("Database not initialized");const r=await Oe.findOne(e).exec();if(!r)throw new Error(`History item with ID ${e} not found`);const n=r.get("isStarred")||!1,i=await r.patch({isStarred:!n});return console.log(`DB: Starred status for ${e} toggled to ${!n}`),i.toJSON()}catch(t){throw console.error(`DB: Error toggling starred status for item ${e}:`,t),t}}async function ch(e){console.log(`DB: Deleting history item with ID: ${e}`);try{if(!await Wt||!Oe)throw new Error("Database not initialized");const r=await Oe.findOne(e).exec();if(!r){console.warn(`DB: History item with ID ${e} not found for deletion.`);return}await r.remove(),console.log(`DB: History item ${e} deleted successfully.`)}catch(t){throw console.error(`DB: Error deleting history item ${e}:`,t),t}}async function l0(e,t){console.log(`DB: Renaming history item ID: ${e} to "${t}"`);try{if(!await Wt||!Oe)throw new Error("Database not initialized");const n=await Oe.findOne(e).exec();if(!n)throw new Error(`History item with ID ${e} not found for rename.`);await n.patch({title:t}),console.log(`DB: Item ${e} renamed successfully.`)}catch(r){throw console.error(`DB: Error renaming history item ${e}:`,r),r}}async function uh(e,t){console.log(`DB: Loading history from DB with limit: ${e}, skip: ${t}`);try{if(!await Wt||!Oe)throw new Error("Chat history database is not initialized");const n=await Oe.find().sort({timestamp:"desc"}).skip(t).limit(e).exec();return console.log(`DB: Loaded ${n.length} history entries (page).`),n.map(i=>i.toJSON())}catch(r){throw console.error("DB: Error loading paginated chat history:",r),r}}async function f0(){console.log("DB: Getting total history count...");try{if(!await Wt||!Oe)throw new Error("Chat history database is not initialized");const r=(await Oe.find().exec()).length;return console.log(`DB: Total history count is ${r}.`),r}catch(e){throw console.error("DB: Error getting chat history count:",e),e}}const d0=u0();function h0(){var e;console.log("Discover Page Initialized (Placeholder)"),(e=document.getElementById("page-discover"))==null||e.querySelector("p")}let Xr;function _t(e,t="info",r=4e3){const n=document.getElementById("notification-banner");if(!n){console.error("Notification banner element (#notification-banner) not found in the DOM."),alert(`(${t.toUpperCase()}) ${e}`);return}Xr&&(clearTimeout(Xr),Xr=null),n.textContent=e,n.className="notification visible",t==="error"?n.classList.add("error"):t==="success"?n.classList.add("success"):n.classList.add("info"),r>0&&(Xr=setTimeout(()=>{kl()},r)),n.onclick=kl}function kl(){const e=document.getElementById("notification-banner");e&&e.classList.remove("visible"),Xr&&(clearTimeout(Xr),Xr=null),e&&(e.onclick=null)}let ie,et,Et,$a,Kt,br,Ni,Vr,qe,Qr,za,Rt,Va,xn,qt,er=null,Lc=null,kn=!1,Cr="",Tc=!1,on="root",Ct=[{id:"root",name:"Root"}],zn={},ir={};const m0="1054233721282-tvskc3gdni8v4h2u1k2767a9ngbf4ong.apps.googleusercontent.com";m0.split("-")[0];const $c="application/vnd.google-apps.folder";function sn(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="100",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function p0(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}async function it(e){if(Et){if(console.log(`Home: Rendering chat session ID: ${e}`),Et.innerHTML="",!e){Qa();return}try{const t=await Wn(e);if(!t||!t.messages||t.messages.length===0)console.log(`Home: Session ${e} is empty or not found. Showing welcome.`),Qa();else{console.log(`Home: Rendering ${t.messages.length} messages for session ${e}.`);const r=Et.scrollHeight-Et.clientHeight<=Et.scrollTop+1;t.messages.forEach(n=>lh(n)),Et.scrollTop=Et.scrollHeight}}catch(t){console.error(`Home: Error fetching/rendering chat session ${e}:`,t),sn(`Failed to load chat: ${t.message}`),Qa()}}}const lh=e=>{if(!Et)return;const t=document.createElement("div");t.classList.add("flex","mb-2"),t.id=e.messageId||`msg-fallback-${Date.now()}-${Math.random()}`;const r=document.createElement("div");r.classList.add("rounded-lg","p-2","max-w-xs","lg:max-w-md","break-words"),r.textContent=e.text,e.isLoading?(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-500","dark:text-gray-400","italic","message-loading")):e.sender==="user"?(t.classList.add("justify-end"),r.classList.add("bg-blue-500","text-white")):e.sender==="error"?(t.classList.add("justify-start"),r.classList.add("bg-red-100","dark:bg-red-900","text-red-700","dark:text-red-300")):(t.classList.add("justify-start"),r.classList.add("bg-gray-200","dark:bg-gray-600")),t.appendChild(r),Et.appendChild(t)},Qa=()=>{if(!Et)return;Et.innerHTML="",lh({messageId:"welcome-msg",sender:"ai",text:"Welcome to Tab Agent! Ask me anything or paste a URL to scrape.",isLoading:!1}),ie&&(ie.disabled=!1),et&&(et.disabled=!0),ft()},ft=()=>{if(!ie)return;ie.style.height="auto";const e=150,t=ie.scrollHeight;ie.style.height=`${Math.min(t,e)}px`,et&&(et.disabled=ie.value.trim()===""||ie.disabled)};async function v0(e,t){var o,c;let r=uo(),n=null,i=null;console.log(`Home: Handling URL Scrape Request for URL: ${e}. Active Session: ${r}`);try{const l={sender:"user",text:e,timestamp:Date.now(),isLoading:!1};r?(n=await Jr(r,l),await it(r)):(console.log("Home: No active session, creating new one for URL message."),r=await tc(l),er?er(r):console.error("Home: onSessionCreatedCallback is not defined in handleUrlScrapeRequest!"),await it(r),n=r?(c=(o=await Wn(r))==null?void 0:o.messages[0])==null?void 0:c.messageId:null);const d={messageId:Bi(r),sender:"system",text:`⏳ Scraping ${e}...`,timestamp:Date.now(),isLoading:!0};i=await Jr(r,d),await it(r),ie.value="",ft(),ie.disabled=!0,et.disabled=!0,console.log(`Home: Sending TEMP_SCRAPE_URL request to background. ChatID: ${r}, MessageID: ${i}`),chrome.runtime.sendMessage({type:"TEMP_SCRAPE_URL",url:e,tabId:t,chatId:r,messageId:i})}catch(l){console.error("Home: Error processing URL scrape request:",l),sn(`Error saving/starting scrape: ${l.message}`),i&&r&&rc(r,i,{isLoading:!1,sender:"error",text:`Failed to initiate scrape: ${l.message}`}).then(()=>it(r)).catch(d=>console.error("DB update failed on initial error:",d)),ie.disabled=!1,ft(),et.disabled=ie.value.trim()===""}finally{isSendingMessage=!1}}const y0=/^(https?):\/\/[^\s/$.?#].[^\s]*$/i;function g0(){return new Promise((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError)return t(chrome.runtime.lastError);r&&r.length>0?e(r[0]):e(null)})})}const fh=async e=>{var c;if(isSendingMessage){console.log("Home: Already sending message, preventing double execution.");return}isSendingMessage=!0;const t=ie.value.trim();if(!t||ie.disabled){isSendingMessage=!1;return}let r=uo(),n=null,i=null;if(console.log(`Home: Sending message. Text: "${t}". Active Session: ${r}`),y0.test(t)){try{const l=await g0(),d=l?l.url:null,v=E=>E?E.replace(/\/$/,""):null,m=v(t),y=v(d);if(l&&l.id&&m===y){console.log("URL matches active tab. Sending SCRAPE_ACTIVE_TAB to content script.");const E={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};r?(n=await Jr(r,E),await it(r)):(r=await tc(E),er?er(r):console.error("Home: onSessionCreatedCallback is not defined! (Content Script Path)"),await it(r));const S={messageId:Bi(r),sender:"system",text:`⏳ Scraping active tab: ${t}...`,timestamp:Date.now(),isLoading:!0};i=await Jr(r,S),await it(r),ie.value="",ft(),ie.disabled=!0,et.disabled=!0,chrome.tabs.sendMessage(l.id,{type:"SCRAPE_ACTIVE_TAB"},async w=>{var N,H;let P={isLoading:!1},A=!1;if(chrome.runtime.lastError)console.error("Error sending/receiving SCRAPE_ACTIVE_TAB:",chrome.runtime.lastError.message),P.sender="error",P.text=`Error scraping active tab: ${chrome.runtime.lastError.message}`;else if(w!=null&&w.success)console.log("Received successful scrape from active tab:",w),P.sender="ai",P.text=`Scraped Active Tab: ${w.title||t}

${(w.textContent||w.excerpt||"No text content found.").substring(0,500)}${((N=w.textContent)==null?void 0:N.length)>500||((H=w.excerpt)==null?void 0:H.length)>500?"...":""}`,A=!0;else{const Q=(w==null?void 0:w.error)||"Unknown error from content script.";console.error("Content script reported scrape failure:",Q),P.sender="error",P.text=`Scraping active tab failed: ${Q}`}try{await rc(r,i,P),await it(r)}catch(Q){console.error("Home: DB Error updating content script scrape result:",Q),sn("Failed to save scrape result.")}ie.disabled=!1,ft(),ie.focus()})}else console.log("URL does not match active tab. Using background scrape."),v0(t,e)}catch(l){console.error("Error checking active tab or processing URL:",l),sn(`Error processing URL: ${l.message}`),ie.disabled=!1,ft()}finally{activeTab&&activeTab.id&&inputUrlNormalized===activeTabUrlNormalized||(isSendingMessage=!1)}return}try{const l={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};r?(n=await Jr(r,l),await it(r)):(r=await tc(l),er?er(r):console.error("Home: onSessionCreatedCallback is not defined! (Query Path)"),await it(r));const d={messageId:Bi(r),sender:"ai",text:"Thinking...",timestamp:Date.now(),isLoading:!0};i=await Jr(r,d),await it(r),ie.disabled=!0,et.disabled=!0,ie.value="",ft();const v={type:"query",tabId:e,text:t,model:((c=document.getElementById("model-selector"))==null?void 0:c.value)||"default",chatId:r,messageId:i};console.log("Home: Sending query to background:",v),chrome.runtime.sendMessage(v,m=>{chrome.runtime.lastError?(console.error("Home: Error sending query:",chrome.runtime.lastError.message),rc(r,i,{isLoading:!1,sender:"error",text:`Error: Could not connect. ${chrome.runtime.lastError.message}`}).then(()=>{r===uo()&&it(r)}),ie.disabled=!1,ft(),isSendingMessage=!1):console.log("Home: Query message sent successfully.",m)})}catch(l){console.error("Home: Error processing chat query:",l),sn(`Error sending message: ${l.message}`),ie.disabled=!1,ft(),isSendingMessage=!1}};async function Il(e){if(!e.target.files||e.target.files.length===0){console.log("No file selected.");return}const t=e.target.files[0];console.log(`File selected: ${t.name}, Type: ${t.type}, Size: ${t.size} bytes`);let r=uo();if(!r){sn("Please start a chat before attaching a file."),Kt&&(Kt.value="");return}const n={sender:"system",text:`📎 Attached file: ${t.name}`,timestamp:Date.now(),isLoading:!1};try{await Jr(r,n),await it(r)}catch(i){console.error("Error adding file attachment message to chat:",i),sn("Failed to add file attachment message.")}Kt&&(Kt.value="")}function b0(e,t){console.log(`[HomeInit] Initializing Home Page elements and listeners. Context TabID: ${e}`),Lc=e,!er&&typeof t=="function"?(console.log("[HomeInit] Storing onSessionCreatedCallback."),er=t):typeof t!="function"&&!er&&console.warn("[HomeInit] onSessionCreated callback was not provided or already set."),ie=document.getElementById("query-input"),et=document.getElementById("send-button"),Et=document.getElementById("chat-body"),$a=document.getElementById("attach-button"),Kt=document.getElementById("file-input"),br=document.getElementById("drive-button"),Ni=document.getElementById("drive-viewer-modal"),Vr=document.getElementById("drive-viewer-close"),qe=document.getElementById("drive-viewer-list"),Qr=document.getElementById("drive-viewer-cancel"),za=document.getElementById("drive-viewer-insert"),Rt=document.getElementById("drive-viewer-search"),Va=document.getElementById("drive-viewer-selected-area"),xn=document.getElementById("drive-viewer-breadcrumbs"),qt=document.getElementById("drive-viewer-back"),ie==null||ie.removeEventListener("input",ft),ie==null||ie.addEventListener("input",ft),ie==null||ie.removeEventListener("keydown",Dl),ie==null||ie.addEventListener("keydown",Dl),et==null||et.removeEventListener("click",Cl),et==null||et.addEventListener("click",Cl),$a&&Kt?($a.removeEventListener("click",Ol),$a.addEventListener("click",Ol),Kt.removeEventListener("change",Il),Kt.addEventListener("change",Il)):console.warn("Attach button or file input element not found."),br.addEventListener("click",w0),br==null||br.removeEventListener("click",Rl),br==null||br.addEventListener("click",Rl),Vr==null||Vr.removeEventListener("click",Aa),Vr==null||Vr.addEventListener("click",Aa),Qr==null||Qr.removeEventListener("click",Aa),Qr==null||Qr.addEventListener("click",Aa),Rt==null||Rt.removeEventListener("input",Ml),Rt==null||Rt.addEventListener("input",Ml),qt==null||qt.removeEventListener("click",Ll),qt==null||qt.addEventListener("click",Ll),console.log("Home Page Elements & Listeners Initialized (Drive Viewer - Full Features)."+Date.now())}function Dl(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),fh(Lc))}function Cl(){fh(Lc)}function Ol(){Kt&&Kt.click()}async function w0(){}chrome.runtime.onMessage.addListener(async(e,t,r)=>{if(e.type==="driveFileListResponse")return console.log("Home: Received driveFileListResponse (For Viewer):",e),kn=!1,!Tc||e.folderId!==on?(console.warn(`Home: Ignoring driveFileListResponse for folder ${e.folderId}. Current: ${on}`),!1):(e.success&&e.files?(zn[e.folderId]=e.files,Ac(e.files)):(_t(`Error fetching folder content: ${e.error||"Unknown error."}`,"error"),qe&&(qe.innerHTML=`<div class="text-center text-red-500 p-4">Error loading content: ${e.error||"Unknown"}</div>`)),!1);e.type});async function dh(e){if(console.log(`Home: loadAndRenderChat called for session ID: ${e}`),!ie){console.warn("Home: Cannot load chat, UI elements not ready.");return}await it(e),ie.disabled=!1,ft(),ie.focus()}function Pl(){console.log("Home: Resetting UI to welcome state."),Qa(),ie&&(ie.value=""),ft(),ie&&ie.focus()}function Rl(){Ni&&(console.log("Home: Showing Drive Viewer modal."),Ni.classList.remove("hidden"),Tc=!0,on="root",Ct=[{id:"root",name:"Root"}],ir={},zn={},Cr="",Rt&&(Rt.value=""),ph(),mh(),xo("root"))}function Aa(){Ni&&(console.log("Home: Hiding Drive Viewer modal."),Ni.classList.add("hidden"),Tc=!1,qe&&(qe.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>'))}function xo(e){if(!(!qe||kn)){if(on=e,Cr="",Rt&&(Rt.value=""),console.log(`Home: Fetching content for Drive Viewer (Folder: ${e})`),kn=!0,qe.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>',k0(),E0(),zn[e]){console.log(`Home: Using cached content for folder ${e}`),Ac(zn[e]),kn=!1;return}chrome.runtime.sendMessage({type:"requestDriveFileList",folderId:e},t=>{if(chrome.runtime.lastError)console.error(`Home: Error sending requestDriveFileList (Viewer - ${e}):`,chrome.runtime.lastError.message),_t(`Error requesting folder content: ${chrome.runtime.lastError.message}`,"error"),qe&&(qe.innerHTML='<div class="text-center text-red-500 p-4">Error loading content.</div>'),kn=!1;else if(t&&t.success)console.log(`Home: Background acknowledged requestDriveFileList for Viewer (${e}).`);else{const r=(t==null?void 0:t.error)||"Unknown error from background";console.error(`Home: Background reported error for requestDriveFileList (Viewer - ${e}):`,r),_t(`Error requesting folder content: ${r}`,"error"),qe&&(qe.innerHTML='<div class="text-center text-red-500 dark:text-gray-400 p-4">Error loading content.</div>'),kn=!1}})}}function Ac(e){if(!qe)return;qe.innerHTML="";const t=Cr.toLowerCase(),r=Cr?e.filter(n=>n.name.toLowerCase().includes(t)):e;if(!r||r.length===0){const n=Cr?`No items match "${Cr}".`:"Folder is empty.";qe.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 p-4">${n}</div>`;return}r.forEach(n=>{const i=n.mimeType===$c,o=document.createElement("div");o.className="drive-viewer-item",o.dataset.id=n.id,o.dataset.name=n.name,o.dataset.mime=n.mimeType,!i&&ir[n.id]&&o.classList.add("selected");const c=document.createElement("span");if(c.className="drive-viewer-item-icon",n.iconLink){const d=document.createElement("img");d.src=n.iconLink,d.alt=i?"Folder":"File",d.className="w-5 h-5",d.onerror=()=>{c.innerHTML=Tl(n.mimeType)},c.appendChild(d)}else c.innerHTML=Tl(n.mimeType);const l=document.createElement("span");l.className="flex-grow truncate",l.textContent=n.name,l.title=n.name,o.appendChild(c),o.appendChild(l),o.addEventListener("click",_0),qe.appendChild(o)})}function _0(e){const t=e.currentTarget,r=t.dataset.id,n=t.dataset.name,i=t.dataset.mime;!r||!n||!i||(i===$c?(console.log(`Home: Navigating into folder: ${n} (${r})`),Ct.push({id:r,name:n}),xo(r)):hh(r,t,{id:r,name:n,mimeType:i}))}function E0(){xn&&(xn.innerHTML="",Ct.forEach((e,t)=>{const r=document.createElement(t===Ct.length-1?"span":"button");if(r.textContent=e.name,r.dataset.id=e.id,r.dataset.index=t,t<Ct.length-1){r.className="text-blue-600 hover:underline dark:text-blue-400 cursor-pointer",r.addEventListener("click",S0);const n=document.createElement("span");n.textContent=" / ",n.className="mx-1 text-gray-400",xn.appendChild(r),xn.appendChild(n)}else r.className="font-semibold",xn.appendChild(r)}))}function S0(e){const t=parseInt(e.currentTarget.dataset.index,10),r=e.currentTarget.dataset.id;isNaN(t)||!r||(console.log(`Home: Breadcrumb click - Navigating to index ${t} (${r})`),Ct=Ct.slice(0,t+1),xo(r))}function hh(e,t,r){ir[e]?(delete ir[e],t==null||t.classList.remove("selected")):(ir[e]=r,t==null||t.classList.add("selected")),mh(),ph()}function mh(){if(!Va)return;const e=Object.keys(ir),t=Va.querySelector(".flex-wrap")||Va;t.innerHTML="",e.length===0||e.forEach(r=>{const n=ir[r],i=document.createElement("span");i.className="selected-file-item",i.textContent=n.name;const o=document.createElement("button");o.className="selected-file-remove",o.textContent="×",o.title=`Remove ${n.name}`,o.dataset.id=r,o.addEventListener("click",x0),i.appendChild(o),t.appendChild(i)})}function x0(e){const t=e.currentTarget.dataset.id;if(t&&ir[t]){const r=qe==null?void 0:qe.querySelector(`.drive-viewer-item[data-id="${t}"]`);hh(t,r,null)}}function ph(){if(!za)return;const e=Object.keys(ir).length;za.disabled=e===0,za.textContent=`Insert (${e})`}const Ml=p0(e=>{Cr=e.target.value.trim(),console.log(`Home: Filtering Drive items by term: "${Cr}"`),zn[on]?Ac(zn[on]):(console.warn(`Home: Search triggered but folder ${on} not in cache.`),qe&&(qe.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Folder not cached for search.</div>'))},300);function Ll(){if(Ct.length<=1)return;const e=Ct[Ct.length-2];Ct.pop(),console.log(`Home: Back button click - Navigating to ${e.name} (${e.id})`),xo(e.id)}function k0(){qt&&(Ct.length>1?qt.classList.remove("hidden"):qt.classList.add("hidden"))}function Tl(e){return e===$c?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'}function vh(e){if(!e)return"";const t=e.title||"Chat Session",r=(e.messages||[]).map(i=>{const o=i.sender==="user"?"user-message":"other-message",c=i.sender==="user"?"You":i.sender==="ai"?"Agent":"System",d=i.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return`
            <div class="message-row ${o==="user-message"?"row-user":"row-other"}">
                <div class="message-bubble ${o}">
                    <span class="sender-label">${c}:</span>
                    <div class="message-text">${d}</div>
                </div>
            </div>
        `}).join(`
`);return`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</title>
            <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: 20px auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-top: 0; }
        .chat-body { margin-top: 20px; }
        .message-row { margin-bottom: 15px; overflow: hidden; /* Clear floats */ }
        .row-user { text-align: right; }
        .row-other { text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; max-width: 75%; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; /* Align right */ }
        .other-message { background-color: #e9ecef; color: #343a40; margin-right: auto; /* Align left */ }
        .sender-label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: inherit; }
        .message-text { margin-top: 5px; }
    </style>
        </head>
        <body>
            <div class="container">
                <h1>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</h1>
                <div class="chat-body">
                    ${r}
                </div>
            </div>
        </body>
        </html>
    `}function yh(e,t,r){try{const n=new Blob([e],{type:"text/html"}),i=URL.createObjectURL(n);console.log(`Initiating download for: ${t} (prompting user)`),chrome.downloads.download({url:i,filename:t,saveAs:!0},o=>{const c=chrome.runtime.lastError;if(setTimeout(()=>URL.revokeObjectURL(i),100),c){const l=c.message;console.error("Download API error:",l),!l||!l.toLowerCase().includes("cancel")?r?r(`Download failed: ${l||"Unknown error"}`):(console.error("No error handler provided for download failure."),alert(`Download failed: ${l||"Unknown error"}. Ensure extension has permissions.`)):console.log("Download cancelled by user.")}else console.log(o?`Download initiated (or dialog opened) with ID: ${o}`:"Download cancelled by user (no downloadId assigned).")})}catch(n){console.error("Error creating blob or initiating download:",n),r?r("An error occurred while preparing the download."):(console.error("No error handler provided for download preparation error."),alert("An error occurred while preparing the download."))}}async function gh(){console.log("Library Page Initializing...");const e=document.getElementById("starred-list"),t=document.getElementById("library-search");if(!e){console.error("Library Page: Could not find #starred-list element.");return}const r=async(i="")=>{console.log(`Library: Rendering with filter "${i}"`);try{let c=(await oh()).filter(l=>l.isStarred);if(i){const l=i.toLowerCase();c=c.filter(d=>(d.title||"").toLowerCase().includes(l))}if(e.innerHTML="",c.length===0){const l=i?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items match "${i}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items yet.</p>';e.innerHTML=l;return}c.sort((l,d)=>d.timestamp-l.timestamp),c.forEach(l=>{const d=co(l);e.appendChild(d)}),console.log(`Library Page Initialized/Refreshed: Rendered ${c.length} starred items.`)}catch(o){console.error("Library Page: Error loading or rendering starred history:",o),e.innerHTML='<div class="error-message p-4">Error loading starred items.</div>'}},n=I0(r,300);r(),t?t.addEventListener("input",i=>{n(i.target.value.trim())}):console.warn("Library search input not found."),e.addEventListener("click",async i=>{const o=i.target,c=o.closest("button[data-action], span[data-action]"),l=o.closest(".history-item");if(!l||l.classList.contains("is-editing"))return;const d=l.dataset.id;if(!d)return;const v=c?c.dataset.action:null;if(v==="load-chat"||o.classList.contains("action-load-chat")){i.stopPropagation(),console.log(`Library: Load button clicked for ${d}`);try{_h(d),await dh(d),ji("page-home")}catch(m){console.error("Library Load Error:",m),alert("Error loading chat.")}return}else if(v==="toggle-star"||o.classList.contains("history-item-star-toggle")){i.stopPropagation(),console.log(`Library: Toggling star for item ${d}`);try{await sh(d),await r((t==null?void 0:t.value.trim())||"")}catch(m){console.error("Library Star Toggle Error:",m),alert("Error updating star status.")}return}else if(v==="delete-chat"){if(i.stopPropagation(),console.log(`Library: Delete action clicked for ${d}`),confirm("Are you sure you want to delete this chat history item? This cannot be undone."))try{await ch(d),await r((t==null?void 0:t.value.trim())||"")}catch(m){console.error(`Library: Error deleting item ${d}:`,m),alert("Error deleting item")}return}else if(v==="share-chat"){i.stopPropagation(),console.log(`Library: Share action clicked for ${d}`),alert("Share functionality coming soon!");return}else if(v==="download-chat"){i.stopPropagation(),console.log(`Library: Download action clicked for ${d}`);try{o.textContent="...",o.disabled=!0;const m=await Wn(d);if(!m)throw new Error("Chat session not found.");const y=vh(m),E=`${m.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()||"chat"}_${d.substring(0,5)}.html`;yh(y,E)}catch(m){console.error(`Error preparing download for ${d}:`,m),_t(`Failed to prepare download: ${m.message}`,"error"),o.textContent="↓",o.disabled=!1}return}else if(o.classList.contains("history-item-actions-btn")){i.stopPropagation(),console.log(`Library: Preview action clicked for ${d}`);try{const m=await Wn(d);if(!m||!m.messages){alert("Could not load chat data for preview.");return}const y=m.messages.slice(0,5).map(E=>`${E.sender==="user"?"You":"Agent"}: ${E.text.substring(0,100)}${E.text.length>100?"...":""}`).join(`
`);alert(`Preview of "${m.title}":
--------------------
${y}`)}catch(m){console.error("Library Preview error:",m),alert("Error loading preview.")}return}}),console.log("Library Page Initialization Complete.")}function I0(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}function D0(){var t;console.log("Settings Page Initialized (Placeholder)");const e=(t=document.getElementById("page-settings"))==null?void 0:t.querySelector("p");if(e){e.textContent="Settings controls will be added here.";const r=document.createElement("button");r.className="p-2 border rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 mt-2";const n=()=>{const i=document.documentElement.classList.contains("dark");r.textContent=i?"Switch to Light Mode":"Switch to Dark Mode"};r.onclick=()=>{const i=document.documentElement,o=i.classList.contains("dark");console.log(`[SettingsToggle] Before toggle - isDark: ${o}`),o?(i.classList.remove("dark"),localStorage.setItem("theme","light"),console.log("[SettingsToggle] Removed dark class, set localStorage to light")):(i.classList.add("dark"),localStorage.setItem("theme","dark"),console.log("[SettingsToggle] Added dark class, set localStorage to dark")),n(),setTimeout(()=>{const c=window.getComputedStyle(document.body),l=document.getElementById("query-input"),d=l?window.getComputedStyle(l):null,v=document.documentElement.classList.contains("dark")?"dark":"light";console.log(`[ComputedStyles - ${v} mode] body bg: ${c.getPropertyValue("background-color")}, body color: ${c.getPropertyValue("color")}`),d&&console.log(`[ComputedStyles - ${v} mode] #query-input bg: ${d.getPropertyValue("background-color")}, color: ${d.getPropertyValue("color")}`)},0)},e.parentNode.appendChild(r),n()}}function C0(){var e;console.log("Spaces Page Initialized (Placeholder)"),(e=document.getElementById("page-spaces"))==null||e.querySelector("p")}let bh=[],nc=[],vi=null;const Cs=new Set,$l={"page-home":"Tab Agent","page-discover":"Discover","page-spaces":"Spaces","page-library":"Library","page-settings":"Settings"},Al={"page-discover":h0,"page-library":gh,"page-settings":D0,"page-spaces":C0};async function ji(e){console.log(`Navigating to ${e}`),bh.forEach(n=>{n.classList.add("hidden"),n.classList.remove("active-page")});const t=document.getElementById(e);if(t)t.classList.remove("hidden"),t.classList.add("active-page");else{console.error(`Navigation error: Page with ID ${e} not found. Showing home.`);const n=document.getElementById("page-home");n&&(n.classList.remove("hidden"),n.classList.add("active-page")),e="page-home"}if(vi&&$l[e]?vi.textContent=$l[e]:vi&&(vi.textContent="Tab Agent"),nc.forEach(n=>{n.dataset.page===e?n.classList.add("active"):n.classList.remove("active")}),Al[e]&&!Cs.has(e))try{console.log(`Initializing ${e}...`),await Al[e](),Cs.add(e),console.log(`${e} initialized.`)}catch(n){console.error(`Error initializing ${e}:`,n)}else if(e==="page-library"&&Cs.has(e))try{console.log(`Re-initializing ${e} to refresh content...`),await gh()}catch(n){console.error(`Error re-initializing ${e}:`,n)}const r=document.getElementById("query-input");e==="page-home"&&r&&r.focus()}function O0(){console.log("Initializing navigation..."),bh=document.querySelectorAll(".page-container"),nc=document.querySelectorAll(".nav-button"),vi=document.querySelector("#header h1"),nc.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&ji(t)})}),ji("page-home"),console.log("Navigation initialized.")}let St=null,Sr=null,Bl=null;const Bc=10;let Rn=0,Or=0,Mn=!1,di,je,Ba,hi,Qe,wr;function P0(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}function Vn(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="100",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function R0(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(e.classList.add("is-editing"),t.style.display="none",r.style.display="block",r.value=t.textContent,r.focus(),r.select())}async function Os(e,t,r=!1){if(!e||!t)return;const n=e.querySelector(".history-item-preview"),i=e.querySelector(".history-item-rename-input");if(!n||!i)return;const o=i.value.trim(),c=n.textContent;if(!r&&o&&o!==c)try{console.log(`Attempting to rename item ${t} to "${o}"`),await l0(t,o),n.textContent=o,n.title=o,console.log(`Item ${t} renamed successfully in UI.`)}catch(l){console.error(`Error renaming item ${t}:`,l),Vn(`Failed to rename chat: ${l.message}`)}else i.value=n.textContent;i.style.display="none",n.style.display="block",e.classList.remove("is-editing")}function co(e){const t=document.createElement("div");t.className="history-item group relative mb-2",t.dataset.id=e.id,e.isStarred&&t.classList.add("starred");const n=new Date(e.timestamp).toLocaleString(),i=e.title||(e.messages&&e.messages.length>0?(e.messages[0].text||"").substring(0,50)+"...":"Empty chat"),o='<svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 17.8798 20.1818C17.1169 21 15.8356 21 13.2731 21H10.7269C8.16438 21 6.8831 21 6.12019 20.1818C5.35728 19.3671 5.27811 18.0864 5.11973 15.5251L4.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M3 5.5H21M16.5 5.5L16.1733 3.57923C16.0596 2.8469 15.9989 2.48073 15.8184 2.21449C15.638 1.94825 15.362 1.75019 15.039 1.67153C14.7158 1.59286 14.3501 1.59286 13.6186 1.59286H10.3814C9.64993 1.59286 9.28419 1.59286 8.96099 1.67153C8.63796 1.75019 8.36201 1.94825 8.18156 2.21449C8.00111 2.48073 7.9404 2.8469 7.82672 3.57923L7.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M14 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',c='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>';t.innerHTML=`
        <div class="chat-card bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-3 flex flex-col justify-between min-h-[100px]">
            <div>
                <div class="card-header flex justify-between items-center mb-2">
                    <button data-action="toggle-star" class="action-button history-item-star-toggle ${e.isStarred?"starred":"unstarred"}" title="Toggle Star">
                         <img src="icons/star-alt-svgrepo-com.svg" alt="Star" class="w-4 h-4 action-icon-img">
                    </button>
                    <div class="actions flex items-center space-x-1">
                         <button data-action="download-chat" class="action-button" title="Download">
                              <img src="icons/download-icon-template.svg" alt="Download" class="w-4 h-4 action-icon-img"> <!-- Placeholder: Create or find a download icon -->
                         </button>
                         <button data-action="share-chat" class="action-button" title="Share">
                              <img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">
                         </button>
                         <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${o}</button>
                         <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${c}</button>
                    </div>
                </div>
                <div class="card-body mb-1 cursor-pointer" data-action="load-chat-body">
                    <div class="history-item-preview font-semibold text-sm truncate" title="${i}">${i}</div>
                    <input type="text" class="history-item-rename-input w-full text-sm p-1 border rounded" value="${i}" style="display: none;"/>
                </div>
                <!-- Hidden Preview Content Area -->
                <div class="history-item-preview-content hidden mt-2 p-2 border-t border-gray-200 dark:border-gray-600 text-xs max-h-24 overflow-y-auto">
                    <!-- Preview messages will be injected here -->
                </div>
            </div>
            <div class="card-footer mt-auto">
                 <span class="history-item-date text-xs text-gray-500 dark:text-gray-400">${n}</span>
            </div>
        </div>
    `;const l=t.querySelector(".history-item-preview"),d=t.querySelector(".history-item-rename-input");l&&d&&(l.addEventListener("dblclick",y=>{y.stopPropagation(),R0(t)}),d.addEventListener("blur",()=>Os(t,e.id,!1)),d.addEventListener("keydown",y=>{y.key==="Enter"?(y.preventDefault(),Os(t,e.id,!1)):y.key==="Escape"&&(y.preventDefault(),Os(t,e.id,!0))}));const v=t.querySelector('[data-action="load-chat-body"]');v&&v.addEventListener("click",async()=>{t.classList.contains("is-editing")||console.log(`Card Body: Load action clicked for ${itemId}`)});const m=t.querySelector('[data-action="toggle-star"] img');return m&&(e.isStarred||m.classList.add("icon-unstarred")),t}async function M0(){if(Mn)return;const e=document.getElementById("load-more-history-btn");e&&(e.textContent="Loading...",e.disabled=!0),Mn=!0,console.log(`Global: Loading more history items. Current skip: ${Rn}`);try{const t=Qe.querySelectorAll(".history-item").length;console.log(`Calculated next skip: ${t}`),Rn=t;const r=await uh(Bc,Rn);if(!Qe)return;r.forEach(n=>{const i=co(n);Qe.appendChild(i)}),Nc(r.length)}catch(t){console.error("Global: Error loading more history items:",t),Vn("Failed to load more history"),e&&e.remove()}finally{Mn=!1;const t=document.getElementById("load-more-history-btn");t&&(t.textContent="Load Older Chats",t.disabled=!1)}}function Nc(e){const t=document.getElementById("load-more-history-btn");t&&t.remove();const r=Qe.querySelectorAll(".history-item").length;if(console.log(`Updating Load More button: Loaded this page: ${e}, Displayed total: ${r}, DB total count: ${Or}`),e===Bc&&r<Or){const n=document.createElement("button");n.id="load-more-history-btn",n.textContent="Load Older Chats",n.className="load-more-button w-full text-center py-2 mt-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",n.addEventListener("click",M0),je.querySelector(".history-content").appendChild(n)}else console.log("Load More button condition not met or all items loaded.")}async function wh(e=""){if(console.log(`Global: Rendering history list with filter: "${e}"`),!Qe||Mn){console.log("History list not found or already loading, skipping render.");return}Mn=!0;const t=e.trim()!=="",r=document.getElementById("load-more-history-btn");r&&r.remove(),Qe.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">Loading...</div>';try{if(t){console.log("Performing search..."),Rn=0;const n=await oh();Or=n.length;const i=n.filter(o=>{const c=o.title||"",l=e.toLowerCase();return c.toLowerCase().includes(l)});Qe.innerHTML="",i.length===0?Qe.innerHTML=`<div class="p-4 text-center text-gray-500 dark:text-gray-400">No results for "${e}"</div>`:(console.log(`Displaying ${i.length} search results.`),i.forEach(o=>{const c=co(o);Qe.appendChild(c)}))}else{console.log("Performing initial history load."),Rn=0,Or=await f0();const n=await uh(Bc,Rn);Qe.innerHTML="",Or===0?Qe.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">No chat history found</div>':(console.log(`Displaying first page: ${n.length} of ${Or} items.`),n.forEach(i=>{const o=co(i);Qe.appendChild(o)}),Nc(n.length))}}catch(n){console.error("Global: Error rendering history list:",n),Qe.innerHTML='<div class="p-4 text-center text-red-500">Error loading chat history</div>',Vn("Failed to render chat history")}finally{Mn=!1}}const L0=P0(wh,300);async function T0(){if(!St){console.error("Cannot detach: Missing tab ID"),Vn("Cannot detach: Missing tab ID");return}try{const e=await chrome.runtime.sendMessage({type:"getPopupForTab",tabId:St});if(e&&e.popupId){await chrome.windows.update(e.popupId,{focused:!0});return}const t=`detachedState_${St}`;await chrome.storage.local.set({[t]:JSON.stringify(homeChatMessages)});const r=await chrome.windows.create({url:chrome.runtime.getURL(`src/sidepanel.html?context=popup&originalTabId=${St}`),type:"popup",width:400,height:600});if(r!=null&&r.id)await chrome.runtime.sendMessage({type:"popupCreated",tabId:St,popupId:r.id});else throw new Error("Failed to create popup window.")}catch(e){console.error("Error during detach:",e),Vn(`Error detaching chat: ${e.message}`)}}function _h(e){console.log(`Sidepanel: Setting activeChatSessionId to ${e}`),Sr=e}function $0(e){console.log(`Sidepanel: Updating activeChatSessionId from null to ${e}`),Sr=e}function uo(){return Sr}document.addEventListener("DOMContentLoaded",async()=>{console.log("Sidepanel DOM Loaded. Initializing..."),di=document.getElementById("history-button"),je=document.getElementById("history-popup"),Ba=document.getElementById("close-history"),hi=document.getElementById("history-search"),Qe=document.getElementById("history-list"),wr=document.getElementById("detach-button");const e=new URLSearchParams(window.location.search);if(e.get("context")==="popup"&&e.has("originalTabId")){Bl=parseInt(e.get("originalTabId"),10),St=Bl,console.log(`Sidepanel: Running in POPUP mode for original tab ${St}`),wr.style.display="none";try{const r=`detachedState_${St}`;(await chrome.storage.local.get([r]))[r]&&(console.log(`Sidepanel: Found detached state for popup (tab ${St})`),console.warn("Popup loading logic needs refactoring for session IDs."),await chrome.storage.local.remove(r))}catch(r){console.error("Sidepanel: Error loading detached state for popup:",r)}}else{console.log("Sidepanel: Running in SIDE PANEL mode.");try{const r=await chrome.runtime.sendMessage({type:"getTabId"});r!=null&&r.tabId?(St=r.tabId,console.log(`Sidepanel: Received currentTabId = ${St}`),wr.disabled=!1):(console.error("Sidepanel: Could not get tab ID from background.",r),wr.disabled=!0)}catch(r){console.error("Sidepanel: Error requesting tab ID:",r),wr.disabled=!0}}console.log(`[SidepanelInit] Initial documentElement className: "${document.documentElement.className}"`);try{if(console.log("Sidepanel: Waiting for DB initialization..."),!await d0)throw new Error("Database initialization failed.");console.log("Sidepanel: DB is ready.")}catch(r){console.error("Sidepanel: CRITICAL - Error during DB initialization wait:",r),Vn("Failed to initialize database. History features disabled."),di.disabled=!0;return}O0();const t=document.getElementById("new-chat-button");b0(St,$0),Sr||Pl(),di==null||di.addEventListener("click",async()=>{if(je==null?void 0:je.classList.contains("hidden")){console.log("Global: Showing history popup."),hi.value="";try{await wh(),je==null||je.classList.remove("hidden")}catch{}}else console.log("Global: Hiding history popup."),je==null||je.classList.add("hidden")}),Ba==null||Ba.addEventListener("click",()=>{console.log("Global: Close history button clicked."),je==null||je.classList.add("hidden")}),hi==null||hi.addEventListener("input",r=>{L0(r.target.value.trim())}),wr==null||wr.addEventListener("click",T0),t==null||t.addEventListener("click",()=>{if(console.log("Sidepanel: New Chat button clicked."),Sr===null){console.log("Sidepanel: Already in a new chat state.");return}Sr=null,Pl(),ji("page-home"),console.log("Sidepanel: Active session ID reset to null, UI cleared.")}),chrome.runtime.onMessage.addListener((r,n,i)=>(console.log("Sidepanel received message from background:",r),r.type==="some_other_global_message"||r.type!=="TEMP_SCRAPE_RESULT"&&r.type!=="response"&&r.type!=="error"&&console.log("Sidepanel: Received message not handled by sidepanel listener:",r.type),!1)),console.log("Sidepanel Initialization Complete."),Qe.addEventListener("click",async r=>{var v;const n=r.target,i=n.closest("button"),o=(i==null?void 0:i.closest("[data-action]"))||n.closest("[data-action]"),c=n.closest(".history-item");if(!c||c.classList.contains("is-editing"))return;const l=c.dataset.id;if(!l)return;const d=o?o.dataset.action:null;if(d==="toggle-star"){r.stopPropagation(),console.log(`History: Toggling star for item ${l}`);try{const m=await sh(l);c.classList.toggle("starred",m.isStarred);const y=c.querySelector(".history-item-star-toggle");y&&(y.classList.toggle("starred",m.isStarred),y.classList.toggle("unstarred",!m.isStarred)),_t(m.isStarred?"Chat starred.":"Chat unstarred.","success",2e3)}catch(m){console.error("Star Toggle Error:",m),_t(`Error starring chat: ${m.message}`,"error")}return}else if(d==="delete-chat"){if(r.stopPropagation(),console.log(`History: Delete action clicked for ${l}`),confirm("Are you sure you want to delete this chat history item?"))try{await ch(l),c.remove(),Or--,_t("Chat deleted successfully.","success"),Qe.children.length===0&&Or===0&&(Qe.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">No chat history found</div>'),Nc(0)}catch(m){console.error(`Error deleting item ${l}:`,m),_t(`Error deleting chat: ${m.message}`,"error")}return}else if(d==="share-chat"){r.stopPropagation(),console.log(`History: Share action clicked for ${l}`),_t("Share functionality coming soon!","info",2e3);return}else if(d==="download-chat"){r.stopPropagation(),console.log(`History: Download action clicked for ${l}`);const m=o;try{const y=m.querySelector("img"),E=y?y.src:null;m.innerHTML="...",m.disabled=!0;const S=await Wn(l);if(!S)throw new Error("Chat session not found.");const w=vh(S),A=`${(S.title||"Chat_Session").replace(/[^a-z0-9_\-\.]/gi,"_").replace(/_{2,}/g,"_")}_${l.substring(0,8)}.html`;yh(w,A,N=>{_t(N,"error"),E?m.innerHTML=`<img src="${E}" alt="Download" class="w-4 h-4 action-icon-img">`:m.innerHTML="↓",m.disabled=!1})}catch(y){console.error(`Error preparing download for ${l}:`,y),_t(`Failed to prepare download: ${y.message}`,"error");const E=m.querySelector("img");if(E&&E.getAttribute("data-original-src"),m){const S=((v=m.querySelector("img"))==null?void 0:v.getAttribute("src"))||"icons/download-icon-template.svg";m.innerHTML=`<img src="${S}" alt="Download" class="w-4 h-4 action-icon-img">`,m.disabled=!1}}return}else if(d==="preview-chat"){r.stopPropagation(),console.log(`History: Preview action clicked for ${l}`);const m=c.querySelector(".history-item-preview-content"),E=o;if(!m)return;if(!m.classList.contains("hidden"))m.classList.add("hidden"),m.innerHTML="",c.classList.remove("preview-active"),E.innerHTML=previewIconSvg;else{document.querySelectorAll(".history-item.preview-active").forEach(w=>{const P=w.querySelector(".history-item-preview-content"),A=w.querySelector('[data-action="preview-chat"]');P&&P.classList.add("hidden"),w.classList.remove("preview-active"),A&&(A.innerHTML=previewIconSvg)}),m.innerHTML='<span class="text-gray-500">Loading preview...</span>',m.classList.remove("hidden"),c.classList.add("preview-active"),E.innerHTML='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>';try{const w=await Wn(l);if(!w||!w.messages||w.messages.length===0){m.innerHTML='<span class="text-gray-500">No messages in this chat.</span>';return}const A=w.messages.slice(0,3).map(N=>{const H=N.sender==="user"?"You":N.sender==="ai"?"Agent":"System",Q=(N.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").substring(0,100)+(N.text.length>100?"...":"");return`<div class="preview-message"><span class="preview-sender">${H}:</span><span>${Q}</span></div>`}).join("");m.innerHTML=A}catch(w){console.error("Preview error:",w),m.innerHTML='<span class="text-red-500">Error loading preview.</span>',E.innerHTML=previewIconSvg}}return}else if(d==="load-chat-body"||!d){if(n.closest(".history-item-rename-input"))return;if(console.log(`History: Item body clicked for ${l}, loading chat.`),l===Sr){console.log(`Chat ${l} already active.`),je==null||je.classList.add("hidden");return}try{_h(l),await dh(Sr),ji("page-home"),je==null||je.classList.add("hidden")}catch(m){console.error(`Error loading chat ${l} from history click:`,m),_t(`Failed to load chat: ${m.message}`,"error")}}})});
