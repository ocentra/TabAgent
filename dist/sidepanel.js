var bm=Object.defineProperty;var jl=e=>{throw TypeError(e)};var wm=(e,t,r)=>t in e?bm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var st=(e,t,r)=>wm(e,typeof t!="symbol"?t+"":t,r),Ul=(e,t,r)=>t.has(e)||jl("Cannot "+r);var W=(e,t,r)=>(Ul(e,t,"read from private field"),r?r.call(e):t.get(e)),Fe=(e,t,r)=>t.has(e)?jl("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),je=(e,t,r,n)=>(Ul(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);const _m="modulepreload",Sm=function(e){return"/"+e},Kl={},Em=function(t,r,n){let i=Promise.resolve();if(r&&r.length>0){let c=function(p){return Promise.all(p.map(m=>Promise.resolve(m).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));i=c(r.map(p=>{if(p=Sm(p),p in Kl)return;Kl[p]=!0;const m=p.endsWith(".css"),g=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${g}`))return;const S=document.createElement("link");if(S.rel=m?"stylesheet":_m,m||(S.as="script"),S.crossOrigin="",S.href=p,d&&S.setAttribute("nonce",d),document.head.appendChild(S),m)return new Promise((_,E)=>{S.addEventListener("load",_),S.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${p}`)))})}))}function o(c){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=c,window.dispatchEvent(u),!u.defaultPrevented)throw c}return i.then(c=>{for(const u of c||[])u.status==="rejected"&&o(u.reason);return t().catch(o)})};let sf=[],Kc=[],Xi=null;const Hl={"page-home":"Tab Agent","page-spaces":"Spaces","page-library":"Library","page-settings":"Settings"};async function Bo(e){console.log(`Navigating to ${e}`),sf.forEach(i=>{i.classList.add("hidden"),i.classList.remove("active-page")});const t=document.getElementById(e);if(t)t.classList.remove("hidden"),t.classList.add("active-page");else{console.error(`Navigation error: Page with ID ${e} not found. Showing home.`);const i=document.getElementById("page-home");i&&(i.classList.remove("hidden"),i.classList.add("active-page")),e="page-home"}Xi&&Hl[e]?Xi.textContent=Hl[e]:Xi&&(Xi.textContent="Tab Agent"),Kc.forEach(i=>{i.dataset.page===e?i.classList.add("active"):i.classList.remove("active")});const{eventBus:r}=await Em(async()=>{const{eventBus:i}=await Promise.resolve().then(()=>Im);return{eventBus:i}},void 0);r.publish("navigation:pageChanged",{pageId:e}),console.log(`[Navigation] Published navigation:pageChanged event for ${e}`);const n=document.getElementById("query-input");e==="page-home"&&n&&n.focus()}function xm(){console.log("Initializing navigation..."),sf=document.querySelectorAll(".page-container"),Kc=document.querySelectorAll(".nav-button"),Xi=document.querySelector("#header h1"),Kc.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&Bo(t)})}),Bo("page-home"),console.log("Navigation initialized.")}class Cm{constructor(){this.listeners=new Map}subscribe(t,r){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(r)}unsubscribe(t,r){if(this.listeners.has(t)){const n=this.listeners.get(t),i=n.indexOf(r);i>-1&&n.splice(i,1),n.length===0&&this.listeners.delete(t)}}publish(t,r){const n=this.listeners.get(t);if(n&&n.length>0)try{const i=structuredClone(r);console.log(`[EventBus] Publishing ${t}. Found ${n.length} listeners. Data to send:`,JSON.stringify(i)),n.forEach((o,c)=>{try{console.log(`[EventBus] Calling listener #${c+1} for ${t} with data:`,JSON.stringify(i)),o(i)}catch(u){console.error(`[EventBus] Error in listener #${c+1} for ${t}:`,u)}})}catch(i){console.error(`[EventBus] Failed to structuredClone data for event ${t}:`,i,r)}else console.log(`[EventBus] No listeners registered for event ${t}.`)}}const Q=new Cm,Im=Object.freeze(Object.defineProperty({__proto__:null,eventBus:Q},Symbol.toStringTag,{value:"Module"}));function km(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,r=e=="x"?t:t&3|8;return r.toString(16)})}class _t{constructor(t=null){this.requestId=t||km(),this.timestamp=Date.now()}}class Wt extends _t{constructor(t,r,n=null,i=null){super(t),this.success=r,this.data=n,this.error=i?i.message||String(i):null}}class _u{constructor(t){this.sessionId=t,this.timestamp=Date.now()}}class oi extends Wt{constructor(t,r,n,i=null){super(t,r,n,i),this.type=oi.name}}class si extends Wt{constructor(t,r,n,i=null){super(t,r,{newMessageId:n},i),this.type=si.name}}class ci extends Wt{constructor(t,r,n=null){super(t,r,null,n),this.type=ci.name}}class ui extends Wt{constructor(t,r,n=null){super(t,r,null,n),this.type=ui.name}}class li extends Wt{constructor(t,r,n=null){super(t,r,null,n),this.type=li.name}}class di extends Wt{constructor(t,r,n,i=null){super(t,r,n,i),this.type=di.name}}class fi extends Wt{constructor(t,r,n,i=null){super(t,r,{newSessionId:n},i),this.type=fi.name,console.log(`[dbEvents] DbCreateSessionResponse constructor: type set to ${this.type}`)}get newSessionId(){var t;return(t=this.data)==null?void 0:t.newSessionId}}class hi extends Wt{constructor(t,r,n=null){super(t,r,null,n),this.type=hi.name}}class pi extends Wt{constructor(t,r,n=null){super(t,r,null,n),this.type=pi.name}}class mi extends Wt{constructor(t,r,n=null,i=null){super(t,r,n,i),this.type=mi.name,this.payload={sessions:n}}}class vi extends Wt{constructor(t,r,n=null,i=null){super(t,r,n,i),this.type=vi.name}}const ss=class ss extends _t{constructor(t){super(),this.type=ss.name,this.payload={sessionId:t}}};st(ss,"responseEventName",oi.name);let yr=ss;var hn;let la=(hn=class extends _t{constructor(t,r){super(),this.type=hn.name,this.payload={sessionId:t,messageObject:r}}},st(hn,"responseEventName",si.name),hn);const cs=class cs extends _t{constructor(t,r,n){super(),this.type=cs.name,this.payload={sessionId:t,messageId:r,updates:n}}};st(cs,"responseEventName",ci.name);let qt=cs;const us=class us extends _t{constructor(t,r){super(),this.type=us.name,this.payload={sessionId:t,status:r}}};st(us,"responseEventName",ui.name);let Xe=us;const ls=class ls extends _t{constructor(t,r){super(),this.type=ls.name,this.payload={sessionId:t,messageId:r}}};st(ls,"responseEventName",li.name);let qo=ls;const ds=class ds extends _t{constructor(t){super(),this.type=ds.name,this.payload={sessionId:t}}};st(ds,"responseEventName",di.name);let gi=ds;const fs=class fs extends _t{constructor(t){super(),this.type=fs.name,this.payload={initialMessage:t},console.log(`[dbEvents] DbCreateSessionRequest constructor: type set to ${this.type}`)}};st(fs,"responseEventName",fi.name);let yi=fs;class da extends _t{constructor(){super(),this.type=da.name,this.payload={}}}const hs=class hs extends _t{constructor(t){super(),this.type=hs.name,this.payload={sessionId:t}}};st(hs,"responseEventName",hi.name);let bi=hs;const ps=class ps extends _t{constructor(t,r){super(),this.type=ps.name,this.payload={sessionId:t,newName:r}}};st(ps,"responseEventName",pi.name);let wi=ps;const ms=class ms extends _t{constructor(){super(),this.type=ms.name}};st(ms,"responseEventName",mi.name);let fa=ms;const vs=class vs extends _t{constructor(){super(),this.type=vs.name}};st(vs,"responseEventName",vi.name);let ha=vs;class Ze extends _u{constructor(t,r){super(t),this.type=Ze.name,this.payload={messages:r}}}class Xt extends _u{constructor(t,r){super(t),this.type=Xt.name,this.payload={status:r}}}class En extends _u{constructor(t,r){super(t),this.type=En.name,this.payload={session:r}}}class Fr{constructor({success:t,error:r=null}){this.type=Fr.name,this.timestamp=Date.now(),this.payload={success:t,error:r?r.message||String(r):null}}}let ge,gt,Fo,fr,gn,Vn=!1,Hc=null,cf=null;function Dm(){return ge=document.getElementById("query-input"),gt=document.getElementById("send-button"),Fo=document.getElementById("chat-body"),fr=document.getElementById("attach-button"),gn=document.getElementById("file-input"),document.getElementById("loading-indicator"),!ge||!gt||!Fo||!fr||!gn?(console.error("UIController: One or more essential elements not found (excluding session list)!"),!1):!0}function Om(){ge==null||ge.addEventListener("input",Pi),ge==null||ge.addEventListener("keydown",uf),gt==null||gt.addEventListener("click",lf),fr==null||fr.addEventListener("click",df)}function Pm(){ge==null||ge.removeEventListener("input",Pi),ge==null||ge.removeEventListener("keydown",uf),gt==null||gt.removeEventListener("click",lf),fr==null||fr.removeEventListener("click",df)}function uf(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const t=Eu();t&&!ge.disabled?(console.log("[UIController] Enter key pressed. Publishing ui:querySubmitted"),Q.publish("ui:querySubmitted",{text:t}),ys()):console.log("[UIController] Enter key pressed, but input is empty or disabled.")}}function lf(){const e=Eu();e&&!ge.disabled?(console.log("[UIController] Send button clicked. Publishing ui:querySubmitted"),Q.publish("ui:querySubmitted",{text:e}),ys()):console.log("[UIController] Send button clicked, but input is empty or disabled.")}function df(){Hc&&Hc()}function Pi(){if(!ge)return;ge.style.height="auto";const e=150,t=ge.scrollHeight;ge.style.height=`${Math.min(t,e)}px`,gt&&(gt.disabled=ge.value.trim()===""||ge.disabled)}function Su(e){if(console.log(`[UIController] setInputStateInternal called with status: ${e}`),!(!Vn||!ge||!gt)){switch(e){case"processing":ge.disabled=!0,gt.disabled=!0;break;case"error":case"idle":case"complete":default:ge.disabled=!1,Pi();break}console.log(`[UIController] Input disabled state: ${ge.disabled}`)}}function zl(e){!Vn||!e||!e.sessionId||!e.payload||e.sessionId===cf&&Su(e.payload.status||"idle")}async function ff(e){if(console.log("[UIController] Initializing..."),Vn&&(console.warn("[UIController] Already initialized. Removing old listeners and subscriptions."),Pm(),Q.unsubscribe(Xt.name,zl)),!Dm())return Vn=!1,null;Hc=e==null?void 0:e.onAttachFile,Om();const t=document.getElementById("new-chat-button");return t&&(e!=null&&e.onNewChat)&&t.addEventListener("click",e.onNewChat),Q.subscribe(Xt.name,zl),console.log("[UIController] Subscribed to DB Status notifications."),Vn=!0,Su("idle"),Pi(),console.log("[UIController] Initialized successfully."),console.log(`[UIController] Returning elements: chatBody is ${Fo?"found":"NULL"}, fileInput is ${gn?"found":"NULL"}`),{chatBody:Fo,queryInput:ge,sendButton:gt,attachButton:fr,fileInput:gn}}function hf(e){console.log(`[UIController] Setting active session for UI state: ${e}`),cf=e,e||Su("idle")}function Rm(){return Vn}function Eu(){return(ge==null?void 0:ge.value.trim())||""}function ys(){console.log("[UIController] Entering clearInput function."),ge&&(ge.value="",Pi())}function pf(){ge==null||ge.focus()}function Lm(){gn==null||gn.click()}const $m=Object.freeze(Object.defineProperty({__proto__:null,adjustTextareaHeight:Pi,checkInitialized:Rm,clearInput:ys,focusInput:pf,getInputValue:Eu,initializeUI:ff,setActiveSession:hf,triggerFileInputClick:Lm},Symbol.toStringTag,{value:"Module"}));function Le(e,t="info",r=3e3){console.log(`[Notification] ${t.toUpperCase()}: ${e} (Duration: ${r}ms)`)}function ct(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="1000",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function xu(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}const Am=/^(https?):\/\/[^\s/$.?#].[^\s]*$/i;function zc(){return new Promise((e,t)=>{if(typeof chrome>"u"||!chrome.tabs)return console.warn("Utils: Chrome tabs API not available. Cannot get active tab."),e(null);chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError)return console.error("Utils: Error querying active tab:",chrome.runtime.lastError.message),e(null);r&&r.length>0?e(r[0]):e(null)})})}let Ye=null,Qn=null,Wc=null;function Tm(e,t){if(!e){console.error("[ChatRenderer] chatBody element is required for initialization.");return}if(!t){console.error("[ChatRenderer] requestDbAndWait function is required for initialization.");return}Ye=e,Wc=t,console.log("[ChatRenderer] Initialized with chat body element and DB request function."),Q.subscribe(Ze.name,Bm),console.log("[ChatRenderer] Subscribed to DbMessagesUpdatedNotification."),Q.subscribe(En.name,qm),console.log("[ChatRenderer] Subscribed to DbSessionUpdatedNotification.")}function Mm(e){console.log(`[ChatRenderer] Setting active session ID to: ${e}`),Qn=e,Ye&&(Ye.innerHTML=""),e?(console.log(`[ChatRenderer] Proactively loading messages for new session: ${e}`),Nm(e)):ra()}function ra(){if(!Ye)return;Ye.innerHTML="";const e={messageId:"welcome-msg",sender:"system",text:"Welcome to Tab Agent! Ask me anything or paste a URL to scrape.",timestamp:Date.now(),isLoading:!1};Iu(e)}function Cu(){Ye&&requestAnimationFrame(()=>{Ye.scrollTop=Ye.scrollHeight})}async function Nm(e){if(!Wc){console.error("[ChatRenderer] Cannot load messages: requestDbAndWait function not available."),Ye&&(Ye.innerHTML='<div class="p-4 text-red-500">Error: Cannot load chat messages.</div>');return}if(!e){console.warn("[ChatRenderer] loadAndRenderMessages called with null sessionId. Displaying welcome."),ra();return}console.log(`[ChatRenderer] Requesting messages for session ${e}...`);try{const t=new yr(e),r=await Wc(t);r&&r.messages?(console.log(`[ChatRenderer] Received ${r.messages.length} messages for ${e}. Rendering.`),Ye&&(Ye.innerHTML=""),r.messages.length===0?ra():(r.messages.forEach(n=>Iu(n)),Cu())):(console.warn(`[ChatRenderer] No messages found in session data for ${e}. Displaying welcome.`,r),ra())}catch(t){console.error(`[ChatRenderer] Failed to load messages for session ${e}:`,t),ct(`Failed to load chat: ${t.message}`),Ye&&(Ye.innerHTML=`<div class="p-4 text-red-500">Failed to load chat: ${t.message}</div>`)}}function Bm(e){if(!(!e||!e.sessionId||!e.payload)&&e.sessionId===Qn){console.log(`[ChatRenderer] Received message update notification for active session ${Qn}. Rendering.`);let t=e.payload.messages;if(!Array.isArray(t))if(Array.isArray(e.payload))console.warn("[ChatRenderer] Payload did not have .messages, using payload directly as array."),t=e.payload;else{console.error("[ChatRenderer] Invalid messages structure: Expected array, got:",e.payload);return}if(console.log("[ChatRenderer] Messages array received:",JSON.stringify(t)),!Ye)return;Ye.innerHTML="",t.length===0?(console.log(`[ChatRenderer] Active session ${Qn} has no messages. Displaying welcome.`),ra()):(t.forEach(r=>Iu(r)),Cu())}}function qm(e){var t;if(!(!e||!e.sessionId||!((t=e.payload)!=null&&t.session))&&e.sessionId===Qn){const r=e.payload.session;console.log(`[ChatRenderer] Received metadata update for active session ${Qn}. New Title: ${r.title}, Starred: ${r.isStarred}`),Fm(r)}}function Fm(e){console.log(e?`[ChatRenderer] Updating chat header for ${e.id}. Title: ${e.title}, Starred: ${e.isStarred}`:"[ChatRenderer] Clearing chat header (no active session).")}function Iu(e){var c,u,d,p;if(!Ye)return;const t=document.createElement("div");t.classList.add("flex","mb-2"),t.id=e.messageId||`msg-fallback-${Date.now()}-${Math.random().toString(36).substring(2)}`;const r=document.createElement("div");r.classList.add("rounded-lg","break-words","relative","group","p-2","max-w-4xl");const n=document.createElement("div");n.className="copy-button-container absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity";const i=document.createElement("button");i.innerHTML='<svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>',i.className="copy-button p-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600",i.title="Copy text",i.onclick=m=>{m.stopPropagation();const g=r.querySelector("pre code")||r.querySelector(".prose")||r,S=(g==null?void 0:g.textContent)||"";navigator.clipboard.writeText(S).then(()=>Le("Copied!","success",1500)).catch(_=>{console.error("Failed to copy:",_),Le("Copy failed","error",1500)})},n.appendChild(i),r.appendChild(n);let o=null;if(((c=e.metadata)==null?void 0:c.type)==="scrape_result"){t.classList.add("justify-start"),r.classList.add("bg-gray-200","dark:bg-gray-600");const m=document.createElement("div");m.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),m.textContent=`Scraped (${e.metadata.method||"N/A"}): ${e.metadata.title||e.metadata.url||"Content"}`,r.appendChild(m);const g=document.createElement("div");g.classList.add("overflow-y-auto","max-h-64","text-sm","prose","prose-sm","dark:prose-invert","whitespace-pre-wrap","mt-1"),g.textContent=e.text||"",r.appendChild(g)}else if(((u=e.metadata)==null?void 0:u.type)==="scrape_stage_result"){t.classList.add("justify-start"),r.classList.add("border","border-gray-300","dark:border-gray-600");const m=document.createElement("div");if(m.classList.add("text-xs","font-semibold","mb-1","pr-6"),e.metadata.success){r.classList.add("bg-gray-100","dark:bg-gray-700"),m.classList.add("text-gray-700","dark:text-gray-300"),m.textContent=`[Stage ${e.metadata.stage} - ${e.metadata.method||"?"} - OK] Len: ${e.metadata.length||0}`,r.appendChild(m);const g=document.createElement("div");g.classList.add("overflow-y-auto","max-h-64","mt-1");const S=document.createElement("pre");S.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),o=document.createElement("code"),o.className="language-json";const _={title:e.metadata.title||"N/A",links:e.metadata.links};o.textContent=JSON.stringify(_,null,2),S.appendChild(o),g.appendChild(S),r.appendChild(g)}else r.classList.add("bg-red-100","dark:bg-red-900"),m.classList.add("text-red-700","dark:text-red-300"),m.textContent=`[Stage ${e.metadata.stage} - Failed] ${e.metadata.error||"Unknown"}`,r.appendChild(m)}else if(((d=e.metadata)==null?void 0:d.type)==="scrape_result_full"){t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","border","border-gray-300","dark:border-gray-600");const m=document.createElement("div");m.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),m.textContent=`Full Scrape Result: ${((p=e.metadata.scrapeData)==null?void 0:p.title)||"No Title"}`,r.appendChild(m);const g=document.createElement("div");g.classList.add("overflow-y-auto","max-h-96","mt-1");const S=document.createElement("pre");S.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),o=document.createElement("code"),o.className="language-json";try{o.textContent=JSON.stringify(e.metadata.scrapeData||{error:"No scrape data found"},null,2)}catch(_){console.error("Error stringifying scrapeData:",_),o.textContent=JSON.stringify({error:"Failed to stringify scrape data",details:_.message},null,2)}S.appendChild(o),g.appendChild(S),r.appendChild(g)}else r.textContent=e.text||"",e.isLoading?(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-500","dark:text-gray-400","italic")):e.sender==="user"?(t.classList.add("justify-end"),r.classList.add("bg-blue-500/20","dark:bg-blue-600/40","text-gray-900","dark:text-gray-100")):e.sender==="error"?(t.classList.add("justify-start"),r.classList.add("bg-red-100","dark:bg-red-900","text-red-700","dark:text-red-300")):(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-900","dark:text-gray-100"));if(t.appendChild(r),Ye.appendChild(t),o&&window.Prism)try{Prism.highlightElement(o)}catch(m){console.warn("Prism highlighting failed:",m)}}let Vc=null,jo=null,Qc=null,Jt=!1;const gc=new Map;function Te(e,t=5e3){return new Promise((r,n)=>{const{requestId:i,type:o}=e,c=p=>{p&&p.requestId===i&&(console.log(`[Orchestrator] Received DB response for ${o} (Req ID: ${i})`),console.log(`[Orchestrator] RAW Received Response Event Object (Req ID: ${i}):`,JSON.stringify(p)),Q.unsubscribe(d,c),gc.delete(i),clearTimeout(u),p.success?r(p.data):n(new Error(p.error||`DB operation ${o} failed`)))},u=setTimeout(()=>{console.error(`[Orchestrator] DB request timed out for ${o} (Req ID: ${i})`),Q.unsubscribe(d,c),gc.delete(i),n(new Error(`DB request timed out for ${o}`))},t);let d;if(o===yi.name)d=fi.name;else if(o===la.name)d=si.name;else if(o===yr.name)d=oi.name;else if(o===qt.name)d=ci.name;else if(o===qo.name)d=li.name;else if(o===Xe.name)d=ui.name;else if(o===gi.name)d=di.name;else if(o===fa.name)d=mi.name;else if(o===ha.name)d=vi.name;else if(o===bi.name)d=hi.name;else if(o===wi.name)d=pi.name;else if(console.error(`[Orchestrator] Unknown request type for response mapping: ${o}`),d=o.replace("Request","Response"),d===o){n(new Error(`Cannot determine response event type for request: ${o}`));return}console.log(`[Orchestrator] Subscribing responseHandler for ReqID ${i} to event type: ${d}`),Q.subscribe(d,c),gc.set(i,{handler:c,timeoutId:u}),Q.publish(e.type,e)})}function jm(e){if(Vc=e.getActiveSessionIdFunc,jo=e.onSessionCreatedCallback,Qc=e.getCurrentTabIdFunc,!Vc||!jo||!Qc){console.error("Orchestrator: Missing one or more dependencies during initialization!");return}console.log("[Orchestrator] Initializing and subscribing to application events..."),Q.subscribe("ui:querySubmitted",Um),Q.subscribe("background:responseReceived",Km),Q.subscribe("background:errorReceived",Hm),Q.subscribe("background:scrapeStageResult",zm),Q.subscribe("background:scrapeResultReceived",Wm),console.log("[Orchestrator] Event subscriptions complete.")}async function Um(e){const{text:t}=e;if(console.log(`Orchestrator: handleQuerySubmit received event with text: "${t}"`),Jt){console.warn("Orchestrator: Already processing a previous submission.");return}Jt=!0;let r=Vc();const n=Qc();let i=null;console.log(`Orchestrator: Processing submission. Text: "${t}". Session: ${r}`);const o=Am.test(t);try{const c={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};if(r){console.log(`Orchestrator: Adding user message to existing session ${r} via event.`);const g=new la(r,c);await Te(g)}else{console.log("Orchestrator: No active session, creating new one via event.");const g=new yi(c);if(r=(await Te(g)).newSessionId,jo)jo(r);else throw console.error("Orchestrator: onSessionCreatedCallback is missing!"),new Error("Configuration error: Cannot notify about new session.")}console.log(`[Orchestrator] Setting session ${r} status to 'processing' via event`);const u=new Xe(r,"processing");await Te(u);let d;if(o){const g=await zc(),S=g==null?void 0:g.url,_=B=>B?B.replace("/$",""):null,E=_(t),O=_(S);d={sender:"system",text:g&&g.id&&E===O?`â³ Scraping active tab: ${t}...`:`â³ Scraping ${t}...`,timestamp:Date.now(),isLoading:!0}}else d={sender:"ai",text:"Thinking...",timestamp:Date.now(),isLoading:!0};console.log(`[Orchestrator] Adding placeholder to session ${r} via event.`);const p=new la(r,d);if(i=(await Te(p)).newMessageId,o){const g=await zc(),S=g==null?void 0:g.url,_=T=>T?T.replace("/$",""):null,E=_(t),O=_(S);g&&g.id&&E===O?(console.log("Orchestrator: Triggering content script scrape."),chrome.tabs.sendMessage(g.id,{type:"SCRAPE_ACTIVE_TAB"},T=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending SCRAPE_ACTIVE_TAB:",chrome.runtime.lastError.message);const B=new qt(r,i,{isLoading:!1,sender:"error",text:`Failed to send scrape request: ${chrome.runtime.lastError.message}`});Te(B).catch(j=>console.error("Failed to update placeholder on send error:",j)),Te(new Xe(r,"error")).catch(j=>console.error("Failed to set session status on send error:",j)),Jt=!1}else console.log("Orchestrator: SCRAPE_ACTIVE_TAB message sent.")})):(console.log("Orchestrator: Triggering background scrape."),chrome.runtime.sendMessage({type:"TEMP_SCRAPE_URL",url:t,tabId:n,chatId:r,messageId:i},T=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending TEMP_SCRAPE_URL:",chrome.runtime.lastError.message);const B=new qt(r,i,{isLoading:!1,sender:"error",text:`Failed to initiate scrape: ${chrome.runtime.lastError.message}`});Te(B).catch(j=>console.error("Failed to update placeholder on send error:",j)),Te(new Xe(r,"error")).catch(j=>console.error("Failed to set session status on send error:",j)),Jt=!1}else console.log("Orchestrator: TEMP_SCRAPE_URL message sent successfully.")}))}else{const g={type:"query",tabId:n,text:t,chatId:r,messageId:i};console.log("Orchestrator: Sending query to background:",g),chrome.runtime.sendMessage(g,S=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending query:",chrome.runtime.lastError.message);const _=new qt(r,i,{isLoading:!1,sender:"error",text:`Failed to send query: ${chrome.runtime.lastError.message}`});Te(_).catch(E=>console.error("Failed to update placeholder on send error:",E)),Te(new Xe(r,"error")).catch(E=>console.error("Failed to set session status on send error:",E)),Jt=!1}else console.log("Orchestrator: Query message sent successfully.")})}}catch(c){console.error("Orchestrator: Error processing query submission:",c),ct(`Error: ${c.message||c}`),r?(console.log(`[Orchestrator] Setting session ${r} status to 'error' due to processing failure via event`),Te(new Xe(r,"error")).catch(u=>console.error("Failed to set session status on processing error:",u))):console.error("Orchestrator: Error occurred before session ID was established."),Jt=!1}}async function Km(e){const{chatId:t,messageId:r,text:n}=e;console.log(`Orchestrator: handleBackgroundMsgResponse for chat ${t}, placeholder ${r}`);try{const i={isLoading:!1,sender:"ai",text:n||"Received empty response."},o=new qt(t,r,i);await Te(o),console.log(`[Orchestrator] Setting session ${t} status to 'idle' after response via event`);const c=new Xe(t,"idle");await Te(c)}catch(i){console.error(`Orchestrator: Error handling background response for chat ${t}:`,i),ct(`Failed to update chat with response: ${i.message||i}`);const o=new Xe(t,"error");Te(o).catch(c=>console.error("Failed to set session status on response processing error:",c))}finally{Jt=!1}}async function Hm(e){const{chatId:t,messageId:r,error:n}=e;console.error(`Orchestrator: handleBackgroundMsgError for chat ${t}, placeholder ${r}:`,n);try{const i={isLoading:!1,sender:"error",text:`Error: ${n||"Unknown error occurred."}`},o=new qt(t,r,i);await Te(o),console.log(`[Orchestrator] Setting session ${t} status to 'error' after background error via event`);const c=new Xe(t,"error");await Te(c)}catch(i){console.error(`Orchestrator: Error updating chat/status on background error for chat ${t}:`,i),ct("Failed to update chat with error status.");const o=new Xe(t,"error");Te(o).catch(c=>console.error("Failed to set session status on error handling error:",c))}finally{Jt=!1}}async function zm(e){const{stage:t,success:r,chatId:n,messageId:i,error:o,...c}=e;console.log(`Orchestrator: handleBackgroundScrapeStage Stage ${t}, chatId: ${n}, Success: ${r}`);let u={},d="idle";if(r)console.log(`Orchestrator: Scrape stage ${t} succeeded for chat ${n}.`),u={isLoading:!1,sender:"system",text:`Full Scrape Result: ${c.title||"No Title"}`,metadata:{type:"scrape_result_full",scrapeData:c}},d="idle";else{const p=o||`Scraping failed (Stage ${t}). Unknown error.`;console.error(`Orchestrator: Scrape stage ${t} failed for chat ${n}. Error: ${p}`),u={isLoading:!1,sender:"error",text:`Scraping failed (Stage ${t}): ${p}`},d="error"}try{console.log(`Orchestrator: Updating message ${i} for stage ${t} result.`);const p=new qt(n,i,u);await Te(p),console.log(`Orchestrator: Updated placeholder ${i} with stage ${t} result.`),console.log(`[Orchestrator] Setting session ${n} status to '${d}' after stage ${t} result via event`);const m=new Xe(n,d);await Te(m)}catch(p){if(console.error(`Orchestrator: Failed to update DB after stage ${t} result:`,p),ct(`Failed to update chat with scrape result: ${p.message||p}`),d!=="error")try{const m=new Xe(n,"error");await Te(m)}catch(m){console.error("Failed to set fallback error status:",m)}}finally{Jt=!1,console.log("Orchestrator: Resetting isSendingMessage after processing scrape stage result.")}}async function Wm(e){const{chatId:t,messageId:r,success:n,error:i,...o}=e;console.log(`Orchestrator: handleBackgroundDirectScrapeResult for chat ${t}, placeholder ${r}, Success: ${n}`);const c={isLoading:!1};n?(c.sender="system",c.text=o.text||o.excerpt||"Scraped content (no text found).",c.metadata={type:"scrape_result",method:o.method||"unknown",url:o.url,title:o.title}):(c.sender="error",c.text=`Scraping failed: ${i||"Unknown error."}`);try{const u=new qt(t,r,c);await Te(u);const d=n?"idle":"error";console.log(`[Orchestrator] Setting session ${t} status to '${d}' after direct scrape result via event`);const p=new Xe(t,d);await Te(p)}catch(u){console.error(`Orchestrator: Error handling direct scrape result for chat ${t}:`,u),ct(`Failed to update chat with direct scrape result: ${u.message||u}`);const d=new Xe(t,"error");Te(d).catch(p=>console.error("Failed to set session status on direct scrape processing error:",p))}finally{Jt=!1}}let Uo=null,Ko=null;function Vm(e){Uo=e.getActiveSessionIdFunc,Ko=e.uiController,!Uo||!Ko?console.error("FileHandler: Missing getActiveSessionIdFunc or uiController dependency!"):console.log("[FileHandler] Initialized (Note: DB/Renderer interaction via events assumed).")}async function Qm(e){if(!Uo){console.error("FileHandler: Not initialized properly (missing getActiveSessionIdFunc).");return}const t=e.target.files;if(!t||t.length===0){console.log("FileHandler: No file selected.");return}const r=t[0];console.log(`FileHandler: File selected - ${r.name}, Type: ${r.type}, Size: ${r.size}`);const n=Uo();if(!n){ct("Please start or select a chat before attaching a file."),e.target.value="";return}const i={sender:"system",text:`ðŸ“Ž Attached file: ${r.name}`,timestamp:Date.now(),isLoading:!1};try{const o=new DbAddMessageRequest(n,i);eventBus.publish(DbAddMessageRequest.name,o),console.log("[FileHandler] Published DbAddMessageRequest for file attachment.")}catch(o){console.error("FileHandler: Error publishing file attachment message event:",o),ct("Failed to process file attachment.")}finally{e.target.value=""}}function Gm(){if(!Ko){console.error("FileHandler: UI Controller not available to trigger file input.");return}console.log("FileHandler: Triggering file input click."),Ko.triggerFileInputClick()}const yc='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>',Ym='<svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 17.8798 20.1818C17.1169 21 15.8356 21 13.2731 21H10.7269C8.16438 21 6.8831 21 6.12019 20.1818C5.35728 19.3671 5.27811 18.0864 5.11973 15.5251L4.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M3 5.5H21M16.5 5.5L16.1733 3.57923C16.0596 2.8469 15.9989 2.48073 15.8184 2.21449C15.638 1.94825 15.362 1.75019 15.039 1.67153C14.7158 1.59286 14.3501 1.59286 13.6186 1.59286H10.3814C9.64993 1.59286 9.28419 1.59286 8.96099 1.67153C8.63796 1.75019 8.36201 1.94825 8.18156 2.21449C8.00111 2.48073 7.9404 2.8469 7.82672 3.57923L7.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M14 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',Jm='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 action-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>',Xm='<img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">';function Zm(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(e.classList.add("is-editing"),t.style.display="none",r.style.display="block",r.value=t.textContent,r.focus(),r.select())}function Yi(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(r.style.display="none",t.style.display="block",e.classList.remove("is-editing"))}function mf(e){const{entry:t,onStarClick:r=()=>{},onDownloadClick:n=()=>{},onDeleteClick:i=()=>{},onLoadClick:o=()=>{},onRenameSubmit:c=()=>{},onShareClick:u=()=>{},onPreviewClick:d=()=>{}}=e;if(!t||!t.id)return console.error("renderHistoryItemComponent: Invalid entry data provided",t),null;const p=document.createElement("div");p.className="history-item group relative mb-2",p.dataset.id=t.id,t.isStarred&&p.classList.add("starred");const g=new Date(t.timestamp).toLocaleString(),S=t.title||(t.messages&&t.messages.length>0?(t.messages[0].text||"").substring(0,50)+"...":"Empty chat"),_=t.isStarred?"icons/StarFilled.png":"icons/StarHollow.png",E=t.isStarred?"starred":"unstarred";p.innerHTML=`
        <div class="chat-card bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-3 flex flex-col justify-between min-h-[100px]">
            <div>
                <div class="card-header flex justify-between items-center mb-2">
                    <button data-action="toggle-star" class="action-button history-item-star-toggle ${E}" title="Toggle Star">
                         <img src="${_}" alt="Star" class="w-4 h-4 action-icon-img ${t.isStarred?"":"icon-unstarred"}">
                    </button>
                    <div class="actions flex items-center space-x-1">
                        <!-- Normal Actions (initially visible) -->
                        <div class="normal-actions flex items-center space-x-1" data-normal-container>
                             <button data-action="download-chat" class="action-button" title="Download">${Jm}</button>
                             <button data-action="share-chat" class="action-button" title="Share">${Xm}</button>
                             <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${Ym}</button>
                             <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${yc}</button>
                        </div>
                        <!-- Confirm Delete Actions (initially hidden) -->
                        <div class="confirm-delete-actions hidden flex items-center space-x-1" data-confirm-container>
                            <span class="text-xs text-red-600 dark:text-red-400 mr-1">Confirm?</span>
                            <button data-action="confirm-delete" class="action-button text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300" title="Confirm Delete">
                                <svg class="w-4 h-4 action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> <!-- Checkmark -->
                            </button>
                            <button data-action="cancel-delete" class="action-button text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" title="Cancel Delete">
                                <svg class="w-4 h-4 action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> <!-- X mark -->
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body mb-1">
                    <div class="history-item-preview font-semibold text-sm truncate" title="${S}">${S}</div>
                    <input type="text" class="history-item-rename-input w-full text-sm p-1 border rounded" value="${S}" style="display: none;"/>
                </div>
                <div class="history-item-preview-content hidden mt-2 p-2 border-t border-gray-200 dark:border-gray-600 text-xs max-h-24 overflow-y-auto">
                     <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="card-footer mt-auto flex justify-between items-center">
                 <span class="history-item-date text-xs text-gray-500 dark:text-gray-400">${g}</span>
                 <button class="history-item-load-btn text-xs p-0.5 rounded" data-action="load-chat" title="Load Chat">
                    <img src="icons/Load.png" alt="Load" class="h-6 w-auto">
                 </button>
            </div>
        </div>
    `;const O=p.querySelector(".history-item-preview"),T=p.querySelector(".history-item-rename-input");O&&T&&(O.addEventListener("dblclick",J=>{J.stopPropagation(),Zm(p)}),T.addEventListener("blur",()=>{const J=T.value.trim(),be=O.textContent;J&&J!==be&&(c(t.id,J),O.textContent=J,O.title=J),Yi(p)}),T.addEventListener("keydown",J=>{if(J.key==="Enter"){J.preventDefault();const be=T.value.trim(),Ce=O.textContent;be&&be!==Ce?c(t.id,be):Yi(p)}else J.key==="Escape"&&(J.preventDefault(),Yi(p))}));const B=p.querySelector('[data-action="toggle-star"]');B&&B.addEventListener("click",J=>{J.stopPropagation(),r(t.id)});const j=p.querySelector('[data-action="download-chat"]');j&&j.addEventListener("click",J=>{J.stopPropagation(),n(t.id)});const G=p.querySelector('[data-action="share-chat"]');G&&G.addEventListener("click",J=>{J.stopPropagation(),u(t.id)});const ce=p.querySelector('[data-action="delete-chat"]'),ae=p.querySelector("[data-normal-container]"),Z=p.querySelector("[data-confirm-container]"),ne=p.querySelector('[data-action="confirm-delete"]'),he=p.querySelector('[data-action="cancel-delete"]');ce&&ae&&Z&&ce.addEventListener("click",J=>{J.stopPropagation(),p.classList.contains("is-editing")&&Yi(p),p.classList.add("is-confirming-delete"),ae.classList.add("hidden"),Z.classList.remove("hidden")}),he&&ae&&Z&&he.addEventListener("click",J=>{J.stopPropagation(),p.classList.remove("is-confirming-delete"),ae.classList.remove("hidden"),Z.classList.add("hidden")}),ne&&ae&&Z&&ne.addEventListener("click",J=>{J.stopPropagation(),p.classList.remove("is-confirming-delete"),i(t.id,p)});const ye=p.querySelector('[data-action="preview-chat"]'),xe=p.querySelector(".history-item-preview-content");ye&&xe&&ye.addEventListener("click",J=>{J.stopPropagation(),!xe.classList.contains("hidden")?(xe.classList.add("hidden"),xe.innerHTML="",p.classList.remove("preview-active"),ye.innerHTML=yc,console.log(`HistoryItem: Hiding preview for ${t.id}`)):(document.querySelectorAll(".history-item.preview-active").forEach(Ce=>{if(Ce!==p){const De=Ce.querySelector(".history-item-preview-content"),tt=Ce.querySelector('[data-action="preview-chat"]');De&&(De.classList.add("hidden"),De.innerHTML=""),Ce.classList.remove("preview-active"),tt&&(tt.innerHTML=yc)}}),p.classList.add("preview-active"),ye.innerHTML='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>',xe.classList.remove("hidden"),console.log(`HistoryItem: Requesting preview for ${t.id}`),d(t.id,xe))});const Pe=p.querySelector('[data-action="load-chat"]');return Pe&&Pe.addEventListener("click",J=>{J.stopPropagation(),o(t.id)}),p.querySelector(".card-body"),p}function ev(e){if(!e)return"";const t=e.title||"Chat Session",r=(e.messages||[]).map(i=>{const o=i.sender==="user"?"user-message":"other-message",c=i.sender==="user"?"You":i.sender==="ai"?"Agent":"System",d=i.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return`
            <div class="message-row ${o==="user-message"?"row-user":"row-other"}">
                <div class="message-bubble ${o}">
                    <span class="sender-label">${c}:</span>
                    <div class="message-text">${d}</div>
                </div>
            </div>
        `}).join(`
`);return`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</title>
            <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: 20px auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-top: 0; }
        .chat-body { margin-top: 20px; }
        .message-row { margin-bottom: 15px; overflow: hidden; /* Clear floats */ }
        .row-user { text-align: right; }
        .row-other { text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; max-width: 75%; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; /* Align right */ }
        .other-message { background-color: #e9ecef; color: #343a40; margin-right: auto; /* Align left */ }
        .sender-label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: inherit; }
        .message-text { margin-top: 5px; }
    </style>
        </head>
        <body>
            <div class="container">
                <h1>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</h1>
                <div class="chat-body">
                    ${r}
                </div>
            </div>
        </body>
        </html>
    `}function tv(e,t,r){try{const n=new Blob([e],{type:"text/html"}),i=URL.createObjectURL(n);console.log(`Initiating download for: ${t} (prompting user)`),chrome.downloads.download({url:i,filename:t,saveAs:!0},o=>{const c=chrome.runtime.lastError;if(setTimeout(()=>URL.revokeObjectURL(i),100),c){const u=c.message;console.error("Download API error:",u),!u||!u.toLowerCase().includes("cancel")?r?r(`Download failed: ${u||"Unknown error"}`):(console.error("No error handler provided for download failure."),alert(`Download failed: ${u||"Unknown error"}. Ensure extension has permissions.`)):console.log("Download cancelled by user.")}else console.log(o?`Download initiated (or dialog opened) with ID: ${o}`:"Download cancelled by user (no downloadId assigned).")})}catch(n){console.error("Error creating blob or initiating download:",n),r?r("An error occurred while preparing the download."):(console.error("No error handler provided for download preparation error."),alert("An error occurred while preparing the download."))}}async function vf(e,t,r){if(!e||!t||!r){console.error("[initiateChatDownload] Failed: Missing sessionId, requestDbAndWaitFunc, or showNotificationFunc."),r&&r("Download failed due to internal error.","error");return}console.log(`[initiateChatDownload] Preparing download for: ${e}`),r("Preparing download...","info");try{const n=await t(new yr(e));if(!n)throw new Error("Chat session data not found.");const i=ev(n),c=`${(n.title||n.name||"Chat_Session").replace(/[^a-z0-9_\-\.]/gi,"_").replace(/_{2,}/g,"_")}_${e.substring(0,8)}.html`;tv(i,c,u=>{r(u,"error")})}catch(n){console.error(`[initiateChatDownload] Error preparing download for ${e}:`,n),r(`Failed to prepare download: ${n.message}`,"error")}}let xn=!1,Kr=null,un=null,Wl=null,Vl=null,yt=null,dr=[],jn="";function rv(e){if(!xn||!e||!e.sessionId||!e.payload){console.warn("[HistoryPopupController] Invalid session update notification received.",e);return}const t=e.payload.session,r=e.sessionId,n=e.payload.updateType||"update";if(!t){console.warn(`[HistoryPopupController] Session update notification for ${r} missing session data.`,e);return}console.log(`[HistoryPopupController] Received session update for ${r}. Type: ${n}, New starred: ${t.isStarred}`);const i=dr.findIndex(c=>c.id===r);let o=!1;n==="delete"?i!==-1&&(console.log(`[HistoryPopupController] Removing deleted session ${r} from local list.`),dr.splice(i,1),o=!0):i!==-1?(console.log(`[HistoryPopupController] Updating session ${r} in local list.`),dr[i]={...dr[i],...t},o=!0):(console.log(`[HistoryPopupController] Adding new/updated session ${r} to local list.`),dr.push(t),o=!0),o&&Kr&&!Kr.classList.contains("hidden")?(console.log("[HistoryPopupController] Popup visible and list changed, calling renderHistoryList()"),ku()):console.log("[HistoryPopupController] Popup not visible or list unchanged, skipping renderHistoryList()")}function ku(){if(!xn||!un)return;console.log(`[HistoryPopupController] Rendering history list (Search: "${jn}")...`);let e=dr;if(jn){const t=jn.toLowerCase();e=dr.filter(r=>(r.name||"").toLowerCase().includes(t)),console.log(`[HistoryPopupController] Filtered down to ${e.length} sessions.`)}else console.log(`[HistoryPopupController] Rendering all ${e.length} sessions (no search term).`);if(un.innerHTML="",e.length===0){const t=jn?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No history items match "${jn}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No chat history yet.</p>';un.innerHTML=t}else e.forEach(t=>{const r={entry:{id:t.id,name:t.title,title:t.title,timestamp:t.timestamp,isStarred:t.isStarred,messages:[]},onLoadClick:av,onStarClick:ov,onDeleteClick:sv,onRenameSubmit:cv,onDownloadClick:uv,onShareClick:lv,onPreviewClick:dv},n=mf(r);n&&un.appendChild(n)});console.log("[HistoryPopupController] History list rendered.")}async function nv(){if(!(!xn||!Kr||!yt)){console.log("[HistoryPopupController] Showing popup. Fetching latest history...");try{dr=await yt(new fa)||[],console.log(`[HistoryPopupController] Fetched ${dr.length} sessions.`),ku(),Kr.classList.remove("hidden")}catch(e){console.error("[HistoryPopupController] Error fetching history list:",e),Le("Failed to load history.","error"),un&&(un.innerHTML='<p class="p-4 text-center text-red-500 dark:text-red-400">Error loading history. Please try again.</p>'),Kr.classList.remove("hidden")}}}function Gc(){!xn||!Kr||(console.log("[HistoryPopupController] Hiding popup."),Kr.classList.add("hidden"))}function iv(e){xn&&(jn=e.target.value.trim(),ku())}async function av(e){if(console.log(`[HistoryPopupController] Load clicked: ${e}`),!!e)try{await chrome.storage.local.set({lastSessionId:e}),Bo("page-home"),Gc()}catch(t){console.error("[HistoryPopupController] Error setting storage or navigating:",t),Le("Failed to load chat.","error")}}async function ov(e){if(!(!e||!yt)){console.log(`[HistoryPopupController] Star clicked: ${e}`);try{await yt(new gi(e)),Le("Star toggled","success")}catch(t){console.error("[HistoryPopupController] Error toggling star:",t),Le(`Failed to toggle star: ${t.message}`,"error")}}}async function sv(e,t){var i;if(!e||!t||!yt)return;console.log(`[HistoryPopupController] Delete confirmed inline for: ${e}. Applying deleting state.`),t.classList.add("is-deleting"),t.querySelectorAll("button").forEach(o=>o.disabled=!0);const r=t.querySelector(".card-footer"),n=r==null?void 0:r.querySelector(".deleting-message");if(r&&!n){const o=document.createElement("span");o.textContent="Deleting...",o.className="text-xs text-red-500 ml-2 deleting-message",r.appendChild(o)}try{await yt(new bi(e)),Le("Chat deletion initiated...","info")}catch(o){console.error("[HistoryPopupController] Error deleting chat:",o),Le(`Failed to delete chat: ${o.message}`,"error"),t.classList.remove("is-deleting"),t.querySelectorAll("button").forEach(d=>d.disabled=!1),(i=r==null?void 0:r.querySelector(".deleting-message"))==null||i.remove();const c=t.querySelector("[data-normal-container]");c&&c.classList.remove("hidden");const u=t.querySelector("[data-confirm-container]");u&&u.classList.add("hidden")}}async function cv(e,t){if(!(!e||!t||!yt)){console.log(`[HistoryPopupController] Rename submitted: ${e} to "${t}"`);try{await yt(new wi(e,t)),Le("Rename successful","success")}catch(r){console.error("[HistoryPopupController] Error submitting rename:",r),Le(`Failed to rename chat: ${r.message}`,"error")}}}async function uv(e){yt?vf(e,yt,Le):(console.error("[HistoryPopupController] Cannot download: requestDbAndWaitFunc not available."),Le("Download failed: Internal setup error.","error"))}function lv(e){}async function dv(e,t){if(!e||!t||!yt){console.error("[HistoryPopupController] Preview failed: Missing sessionId, contentElement, or requestDbAndWaitFunc.");return}console.log(`[HistoryPopupController] Handling preview click for: ${e}`),t.innerHTML='<span class="text-gray-500 dark:text-gray-400 italic text-xs">Loading preview...</span>';try{const r=await yt(new yr(e));if(!r||!r.messages||r.messages.length===0){t.innerHTML='<span class="text-gray-500 dark:text-gray-400 text-xs">No messages in this chat.</span>';return}const i=r.messages.slice(0,3).map(o=>{const c=o.sender==="user"?"You":o.sender==="ai"?"Agent":"System",u=(o.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").substring(0,100)+(o.text&&o.text.length>100?"...":"");return`<div class="preview-message mb-1 last:mb-0"><span class="font-medium">${c}:</span><span class="ml-1">${u}</span></div>`}).join("");t.innerHTML=i}catch(r){console.error(`[HistoryPopupController] Error fetching preview for ${e}:`,r),t.innerHTML=`<span class="text-red-500 text-xs">Error loading preview: ${r.message}</span>`}}function fv(e,t){if(console.log("[HistoryPopupController] Entering initializeHistoryPopup..."),!e||!e.popupContainer||!e.listContainer||!e.searchInput||!e.closeButton||!t)return console.error("[HistoryPopupController] Initialization failed: Missing required elements or request function.",{elements:e,requestFunc:t}),null;Kr=e.popupContainer,un=e.listContainer,Wl=e.searchInput,Vl=e.closeButton,yt=t,console.log("[HistoryPopupController] Elements and request function assigned.");try{Vl.addEventListener("click",Gc);const r=xu(iv,300);return Wl.addEventListener("input",r),console.log("[HistoryPopupController] Event listeners attached."),Q.subscribe(En.name,rv),console.log("[HistoryPopupController] Subscribed to DbSessionUpdatedNotification for passive updates."),xn=!0,console.log("[HistoryPopupController] Initialization successful. History will be rendered when popup is shown."),{show:nv,hide:Gc}}catch(r){return console.error("[HistoryPopupController] Error during initialization listeners/subscriptions:",r),xn=!1,null}}function pa(e){"@babel/helpers - typeof";return pa=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},pa(e)}function hv(e,t){if(pa(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(pa(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function pv(e){var t=hv(e,"string");return pa(t)=="symbol"?t:t+""}function mv(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,pv(n.key),n)}}function Vr(e,t,r){return t&&mv(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function vv(e){return e[e.length-1]}function Du(e){return Array.isArray(e)?e.slice(0):[e]}function gv(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Ho(e){return Array.isArray(e)}function bc(e,t){var r=0,n=-1;for(var i of e){n=n+1;var o=t(i,n);if(o)r=r+1;else break}return r}function Cn(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var i=0;i<r;++i)e[n+i]=t[i]}}function yv(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function zr(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function br(e,t){var r=t?zr(t._rev)+1:1;return r+"-"+e}function bv(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var i=n,o=0;o<r;++o){var c=t[o];if(i=i[c],typeof i>"u")return i}return i}}function Me(e){return Object.assign({},e)}function wv(e){return Object.keys(e)[0]}function zo(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,i)=>typeof n=="string"&&typeof i=="string"?n.localeCompare(i):typeof n=="object"?1:-1).map(n=>zo(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,i)=>n.localeCompare(i)).forEach(n=>{r[n]=zo(e[n],t)}),r}return e}function Yc(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=Yc(e[r]);return t}var n={};for(var i in e)n[i]=Yc(e[i]);return n}var ut=Yc;function hr(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var Ou=1;function Ri(){return{lwt:Ou}}function jt(){return""}function _v(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function Sv(e,t,r){if(t.length!==r.length)return!1;for(var n=0,i=t.length;n<i;){var o=t[n],c=r[n];if(n++,o._rev!==c._rev||o[e]!==c[e])return!1}return!0}async function Ev(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),i=>("00"+i.toString(16)).slice(-2)).join("");return n}var gf=Ev;function xv(){return new Promise(e=>setTimeout(e,0))}function Cv(e=0){return new Promise(t=>setTimeout(t,e))}function Iv(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var kv=Promise.resolve(!0),wr=Promise.resolve(!1),Pu=Promise.resolve(null),Rt=Promise.resolve();function bs(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):Cv(0)}var wc=Rt;function Dv(e=void 0){return wc=wc.then(()=>bs(e)),wc}function Ov(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var Pv=/\./g,Ql="abcdefghijklmnopqrstuvwxyz";function $a(e=10){for(var t="",r=0;r<e;r++)t+=Ql.charAt(Math.floor(Math.random()*Ql.length));return t}function yf(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function Zi(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function ma(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!ma(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var i=Object.keys(e);if(r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var o=i[n];if(!ma(e[o],t[o]))return!1}return!0}return e!==e&&t!==t}var Jc=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},_c=new Set(["__proto__","prototype","constructor"]),Rv=new Set("0123456789");function bf(e){var t=[],r="",n="start",i=!1;for(var o of e)switch(o){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");i&&(r+=o),n="property",i=!i;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(i){i=!1,r+=o;break}if(_c.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(i){i=!1,r+=o;break}if(n==="property"){if(_c.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!Rv.has(o))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),i&&(i=!1,r+="\\"),r+=o}}switch(i&&(r+="\\"),n){case"property":{if(_c.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function wf(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function Lv(e,t){if(wf(e,t))throw new Error("Cannot use string index")}function Wr(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!Jc(e)||typeof t!="string")return r===void 0?e:r;var n=bf(t);if(n.length===0)return r;for(var i=0;i<n.length;i++){var o=n[i];if(wf(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function _f(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!Jc(e)||typeof t!="string")return e;for(var n=e,i=bf(t),o=0;o<i.length;o++){var c=i[o];Lv(e,c),o===i.length-1?e[c]=r:Jc(e[c])||(e[c]=typeof i[o+1]=="number"?[]:{}),e=e[c]}return n}function _i(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function Ut(e,t,r,n){var i=e.get(t);return typeof i>"u"&&(i=r(),e.set(t,i)),i}function Ie(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=yf(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function $v(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var Sc=0;function St(){var e=Date.now();e=e+.01,e<=Sc&&(e=Sc+.01);var t=parseFloat(e.toFixed(2));return Sc=t,t}function le(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var Aa={bufferSize:1,refCount:!0},Sf="16.11.0",Ec={},Av="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",Gl=16,xc=wr,Yl=!1;async function Ef(){return Yl||(Yl=!0,xc=(async()=>!!(Ec.premium&&typeof Ec.premium=="string"&&await gf(Ec.premium)===Av))()),xc}function va(e,t){return va=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},va(e,t)}function Ru(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,va(e,t)}function Xc(e){return Xc=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Xc(e)}function Tv(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function xf(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(xf=function(){return!!e})()}function Mv(e,t,r){if(xf())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&va(i,r.prototype),i}function Wo(e){var t=typeof Map=="function"?new Map:void 0;return Wo=function(n){if(n===null||!Tv(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,i)}function i(){return Mv(n,arguments,Xc(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),va(i,n)},Wo(e)}var Se={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return`
        RxDB Error-Code: `+e+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function Nv(e){var t="";return Object.keys(e).length===0||(t+="-".repeat(20)+`
`,t+=`Parameters:
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(i=>JSON.stringify(i,Object.getOwnPropertyNames(i))):n=JSON.stringify(e[r],function(i,o){return o===void 0?null:o},2)}catch{}return r+": "+n}).join(`
`),t+=`
`),t}function Cf(e,t,r){return`
`+e+`
`+Nv(r)}var Bv=function(e){function t(n,i,o={}){var c,u=Cf(i,n,o);return c=e.call(this,u)||this,c.code=n,c.message=u,c.url=Lu(n),c.parameters=o,c.rxdb=!0,c}Ru(t,e);var r=t.prototype;return r.toString=function(){return this.message},Vr(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(Wo(Error)),qv=function(e){function t(n,i,o={}){var c,u=Cf(i,n,o);return c=e.call(this,u)||this,c.code=n,c.message=u,c.url=Lu(n),c.parameters=o,c.rxdb=!0,c}Ru(t,e);var r=t.prototype;return r.toString=function(){return this.message},Vr(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])}(Wo(TypeError));function Lu(e){return"https://rxdb.info/errors.html?console=errors#"+e}function If(e){return`
Find out more about this error here: `+Lu(e)+` 
`}function X(e,t){return new Bv(e,Se.tunnelErrorMessage(e)+If(e),t)}function Ot(e,t){return new qv(e,Se.tunnelErrorMessage(e)+If(e),t)}function ws(e){return e&&e.status===409?e:!1}var Fv={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function kf(e){return X("COL20",{name:Fv[e.status],document:e.documentId,writeError:e})}var ga={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function ft(e,t){ga[e].length>0&&ga[e].forEach(r=>r(t))}async function Ta(e,t){for(var r of ga[e])await r(t)}function Si(e,t){var r=t;r=r.replace(Pv,".properties."),r="properties."+r,r=Zi(r);var n=Wr(e,r);return n}function jv(e,t,r){if(typeof t.primaryKey=="string")return r;var n=Pn(t,r),i=r[e];if(i&&i!==n)throw X("DOC19",{args:{documentData:r,existingPrimary:i,newPrimary:n},schema:t});return r[e]=n,r}function Et(e){return typeof e=="string"?e:e.key}function Uv(e){var t=Et(e.primaryKey),r=Si(e,t);return le(r.maxLength)}function Pn(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var i=Wr(t,n);if(typeof i>"u")throw X("DOC18",{args:{field:n,documentData:t}});return i}).join(r.separator)}function Kv(e){var t=zo(e,!0);return t}function Hv(e){return["_deleted",e]}function _s(e){e=Me(e);var t=Et(e.primaryKey);e.properties=Me(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=zv,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=Df(e);Cn(e.required,r),e.required=e.required.filter(o=>!o.includes(".")).filter((o,c,u)=>u.indexOf(o)===c),e.version=e.version||0;var n=e.indexes.map(o=>{var c=Ho(o)?o.slice(0):[o];return c.includes(t)||c.push(t),c[0]!=="_deleted"&&c.unshift("_deleted"),c});n.length===0&&n.push(Hv(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(o=>{n.push(o)});var i=new Set;return n.filter(o=>{var c=o.join(",");return i.has(c)?!1:(i.add(c),!0)}),e.indexes=n,e}var zv={type:"object",properties:{lwt:{type:"number",minimum:Ou,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Df(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=Et(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function Wv(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var i=r[n];(!Object.prototype.hasOwnProperty.call(t,i)||typeof t[i]>"u")&&(t[i]=e.defaultValues[i])}return t}var Of=function(){function e(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=Vv(this.jsonSchema),this.primaryPath=Et(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw X("SC39",{schema:r});this.finalFields=Df(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,i){this.finalFields.forEach(o=>{if(!ma(n[o],i[o]))throw X("DOC9",{dataBefore:n,dataAfter:i,fieldName:o,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},i=Si(this.jsonSchema,"");return Object.keys(i).forEach(o=>{var c=o;n.__defineGetter__(o,function(){if(!(!this.get||typeof this.get!="function")){var u=this.get(c);return u}}),Object.defineProperty(n,o+"$",{get:function(){return this.get$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"$$",{get:function(){return this.get$$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"_",{get:function(){return this.populate(c)},enumerable:!1,configurable:!1})}),hr(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return Pn(this.jsonSchema,n)},Vr(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,i])=>r[n]=i.default),hr(this,"defaultValues",r)}},{key:"hash",get:function(){return hr(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])}();function Vv(e){return(e.indexes||[]).map(t=>Ho(t)?t:[t])}function Qv(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function Gv(e,t,r=!0){r&&ft("preCreateRxSchema",e);var n=_s(e);n=Kv(n),Se.deepFreezeWhenDevMode(n);var i=new Of(n,t);return ft("createRxSchema",i),i}function He(e){return typeof e=="function"}function Yv(e){return He(e==null?void 0:e.lift)}function tr(e){return function(t){if(Yv(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var Zc=function(e,t){return Zc=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},Zc(e,t)};function Rn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Zc(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function Jv(e,t,r,n){function i(o){return o instanceof r?o:new r(function(c){c(o)})}return new(r||(r=Promise))(function(o,c){function u(m){try{p(n.next(m))}catch(g){c(g)}}function d(m){try{p(n.throw(m))}catch(g){c(g)}}function p(m){m.done?o(m.value):i(m.value).then(u,d)}p((n=n.apply(e,t||[])).next())})}function Pf(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(p){return function(m){return d([p,m])}}function d(p){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,p[0]&&(r=0)),r;)try{if(n=1,i&&(o=p[0]&2?i.return:p[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,p[1])).done)return o;switch(i=0,o&&(p=[p[0]&2,o.value]),p[0]){case 0:case 1:o=p;break;case 4:return r.label++,{value:p[1],done:!1};case 5:r.label++,i=p[1],p=[0];continue;case 7:p=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(p[0]===6||p[0]===2)){r=0;continue}if(p[0]===3&&(!o||p[1]>o[0]&&p[1]<o[3])){r.label=p[1];break}if(p[0]===6&&r.label<o[1]){r.label=o[1],o=p;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(p);break}o[2]&&r.ops.pop(),r.trys.pop();continue}p=t.call(e,r)}catch(m){p=[6,m],i=0}finally{n=o=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}function Ei(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function In(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,o=[],c;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(u){c={error:u}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return o}function kn(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}function Gn(e){return this instanceof Gn?(this.v=e,this):new Gn(e)}function Xv(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,o=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),u("next"),u("throw"),u("return",c),i[Symbol.asyncIterator]=function(){return this},i;function c(_){return function(E){return Promise.resolve(E).then(_,g)}}function u(_,E){n[_]&&(i[_]=function(O){return new Promise(function(T,B){o.push([_,O,T,B])>1||d(_,O)})},E&&(i[_]=E(i[_])))}function d(_,E){try{p(n[_](E))}catch(O){S(o[0][3],O)}}function p(_){_.value instanceof Gn?Promise.resolve(_.value.v).then(m,g):S(o[0][2],_)}function m(_){d("next",_)}function g(_){d("throw",_)}function S(_,E){_(E),o.shift(),o.length&&d(o[0][0],o[0][1])}}function Zv(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof Ei=="function"?Ei(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(o){r[o]=e[o]&&function(c){return new Promise(function(u,d){c=e[o](c),i(u,d,c.done,c.value)})}}function i(o,c,u,d){Promise.resolve(d).then(function(p){o({value:p,done:u})},c)}}var Rf=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function Lf(e){return He(e==null?void 0:e.then)}function $u(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var Cc=$u(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function eu(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Ss=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,i,o;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var u=Ei(c),d=u.next();!d.done;d=u.next()){var p=d.value;p.remove(this)}}catch(O){t={error:O}}finally{try{d&&!d.done&&(r=u.return)&&r.call(u)}finally{if(t)throw t.error}}else c.remove(this);var m=this.initialTeardown;if(He(m))try{m()}catch(O){o=O instanceof Cc?O.errors:[O]}var g=this._finalizers;if(g){this._finalizers=null;try{for(var S=Ei(g),_=S.next();!_.done;_=S.next()){var E=_.value;try{Jl(E)}catch(O){o=o??[],O instanceof Cc?o=kn(kn([],In(o)),In(O.errors)):o.push(O)}}}catch(O){n={error:O}}finally{try{_&&!_.done&&(i=S.return)&&i.call(S)}finally{if(n)throw n.error}}}if(o)throw new Cc(o)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Jl(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&eu(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&eu(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),$f=Ss.EMPTY;function Af(e){return e instanceof Ss||e&&"closed"in e&&He(e.remove)&&He(e.add)&&He(e.unsubscribe)}function Jl(e){He(e)?e():e.unsubscribe()}var eg={Promise:void 0},tg={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,kn([e,t],In(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Tf(e){tg.setTimeout(function(){throw e})}function Xl(){}function Do(e){e()}var Au=function(e){Rn(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,Af(r)&&r.add(n)):n.destination=ig,n}return t.create=function(r,n,i){return new xi(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Ss),rg=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){_o(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){_o(n)}else _o(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){_o(r)}},e}(),xi=function(e){Rn(t,e);function t(r,n,i){var o=e.call(this)||this,c;return He(r)||!r?c={next:r??void 0,error:n??void 0,complete:i??void 0}:c=r,o.destination=new rg(c),o}return t}(Au);function _o(e){Tf(e)}function ng(e){throw e}var ig={closed:!0,next:Xl,error:ng,complete:Xl},Tu=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Ma(e){return e}function ag(e){return e.length===0?Ma:e.length===1?e[0]:function(r){return e.reduce(function(n,i){return i(n)},r)}}var bt=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var i=this,o=sg(t)?t:new xi(t,r,n);return Do(function(){var c=i,u=c.operator,d=c.source;o.add(u?u.call(o,d):d?i._subscribe(o):i._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=Zl(r),new r(function(i,o){var c=new xi({next:function(u){try{t(u)}catch(d){o(d),c.unsubscribe()}},error:o,complete:i});n.subscribe(c)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[Tu]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return ag(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=Zl(t),new t(function(n,i){var o;r.subscribe(function(c){return o=c},function(c){return i(c)},function(){return n(o)})})},e.create=function(t){return new e(t)},e}();function Zl(e){var t;return(t=e??eg.Promise)!==null&&t!==void 0?t:Promise}function og(e){return e&&He(e.next)&&He(e.error)&&He(e.complete)}function sg(e){return e&&e instanceof Au||og(e)&&Af(e)}function Mf(e){return He(e[Tu])}function Nf(e){return Symbol.asyncIterator&&He(e==null?void 0:e[Symbol.asyncIterator])}function Bf(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function cg(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var qf=cg();function Ff(e){return He(e==null?void 0:e[qf])}function jf(e){return Xv(this,arguments,function(){var r,n,i,o;return Pf(this,function(c){switch(c.label){case 0:r=e.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,Gn(r.read())];case 3:return n=c.sent(),i=n.value,o=n.done,o?[4,Gn(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,Gn(i)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function Uf(e){return He(e==null?void 0:e.getReader)}function Cr(e){if(e instanceof bt)return e;if(e!=null){if(Mf(e))return ug(e);if(Rf(e))return lg(e);if(Lf(e))return dg(e);if(Nf(e))return Kf(e);if(Ff(e))return fg(e);if(Uf(e))return hg(e)}throw Bf(e)}function ug(e){return new bt(function(t){var r=e[Tu]();if(He(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function lg(e){return new bt(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function dg(e){return new bt(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Tf)})}function fg(e){return new bt(function(t){var r,n;try{for(var i=Ei(e),o=i.next();!o.done;o=i.next()){var c=o.value;if(t.next(c),t.closed)return}}catch(u){r={error:u}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}t.complete()})}function Kf(e){return new bt(function(t){pg(e,t).catch(function(r){return t.error(r)})})}function hg(e){return Kf(jf(e))}function pg(e,t){var r,n,i,o;return Jv(this,void 0,void 0,function(){var c,u;return Pf(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),r=Zv(e),d.label=1;case 1:return[4,r.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(c=n.value,t.next(c),t.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return u=d.sent(),i={error:u},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(o=r.return)?[4,o.call(r)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function _r(e,t,r,n,i){return new mg(e,t,r,n,i)}var mg=function(e){Rn(t,e);function t(r,n,i,o,c,u){var d=e.call(this,r)||this;return d.onFinalize=c,d.shouldUnsubscribe=u,d._next=n?function(p){try{n(p)}catch(m){r.error(m)}}:e.prototype._next,d._error=o?function(p){try{o(p)}catch(m){r.error(m)}finally{this.unsubscribe()}}:e.prototype._error,d._complete=i?function(){try{i()}catch(p){r.error(p)}finally{this.unsubscribe()}}:e.prototype._complete,d}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(Au),Hf={now:function(){return(Hf.delegate||Date).now()},delegate:void 0};function vg(e){return e&&He(e.schedule)}function Mu(e){return e[e.length-1]}function gg(e){return He(Mu(e))?e.pop():void 0}function Na(e){return vg(Mu(e))?e.pop():void 0}function zf(e,t){return typeof Mu(e)=="number"?e.pop():t}function Hr(e,t,r,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var o=t.schedule(function(){r(),i?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(o),!i)return o}var yg=Array.isArray,bg=Object.getPrototypeOf,wg=Object.prototype,_g=Object.keys;function Sg(e){if(e.length===1){var t=e[0];if(yg(t))return{args:t,keys:null};if(Eg(t)){var r=_g(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function Eg(e){return e&&typeof e=="object"&&bg(e)===wg}function Wf(e,t){return t===void 0&&(t=0),tr(function(r,n){r.subscribe(_r(n,function(i){return Hr(n,e,function(){return n.next(i)},t)},function(){return Hr(n,e,function(){return n.complete()},t)},function(i){return Hr(n,e,function(){return n.error(i)},t)}))})}function Vf(e,t){return t===void 0&&(t=0),tr(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function xg(e,t){return Cr(e).pipe(Vf(t),Wf(t))}function Cg(e,t){return Cr(e).pipe(Vf(t),Wf(t))}function Ig(e,t){return new bt(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function kg(e,t){return new bt(function(r){var n;return Hr(r,t,function(){n=e[qf](),Hr(r,t,function(){var i,o,c;try{i=n.next(),o=i.value,c=i.done}catch(u){r.error(u);return}c?r.complete():r.next(o)},0,!0)}),function(){return He(n==null?void 0:n.return)&&n.return()}})}function Qf(e,t){if(!e)throw new Error("Iterable cannot be null");return new bt(function(r){Hr(r,t,function(){var n=e[Symbol.asyncIterator]();Hr(r,t,function(){n.next().then(function(i){i.done?r.complete():r.next(i.value)})},0,!0)})})}function Dg(e,t){return Qf(jf(e),t)}function Og(e,t){if(e!=null){if(Mf(e))return xg(e,t);if(Rf(e))return Ig(e,t);if(Lf(e))return Cg(e,t);if(Nf(e))return Qf(e,t);if(Ff(e))return kg(e,t);if(Uf(e))return Dg(e,t)}throw Bf(e)}function Ba(e,t){return t?Og(e,t):Cr(e)}function Ue(e,t){return tr(function(r,n){var i=0;r.subscribe(_r(n,function(o){n.next(e.call(t,o,i++))}))})}var Pg=Array.isArray;function Rg(e,t){return Pg(t)?e.apply(void 0,kn([],In(t))):e(t)}function Lg(e){return Ue(function(t){return Rg(e,t)})}function $g(e,t){return e.reduce(function(r,n,i){return r[n]=t[i],r},{})}function Ag(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Na(e),n=gg(e),i=Sg(e),o=i.args,c=i.keys;if(o.length===0)return Ba([],r);var u=new bt(Tg(o,r,c?function(d){return $g(c,d)}:Ma));return n?u.pipe(Lg(n)):u}function Tg(e,t,r){return r===void 0&&(r=Ma),function(n){ed(t,function(){for(var i=e.length,o=new Array(i),c=i,u=i,d=function(m){ed(t,function(){var g=Ba(e[m],t),S=!1;g.subscribe(_r(n,function(_){o[m]=_,S||(S=!0,u--),u||n.next(r(o.slice()))},function(){--c||n.complete()}))},n)},p=0;p<i;p++)d(p)},n)}}function ed(e,t,r){e?Hr(r,e,t):t()}function Mg(e,t,r,n,i,o,c,u){var d=[],p=0,m=0,g=!1,S=function(){g&&!d.length&&!p&&t.complete()},_=function(O){return p<n?E(O):d.push(O)},E=function(O){p++;var T=!1;Cr(r(O,m++)).subscribe(_r(t,function(B){t.next(B)},function(){T=!0},void 0,function(){if(T)try{p--;for(var B=function(){var j=d.shift();c||E(j)};d.length&&p<n;)B();S()}catch(j){t.error(j)}}))};return e.subscribe(_r(t,_,function(){g=!0,S()})),function(){}}function Sr(e,t,r){return r===void 0&&(r=1/0),He(t)?Sr(function(n,i){return Ue(function(o,c){return t(n,o,i,c)})(Cr(e(n,i)))},r):(typeof t=="number"&&(r=t),tr(function(n,i){return Mg(n,i,e,r)}))}function Nu(e){return e===void 0&&(e=1/0),Sr(Ma,e)}function Ng(){return Nu(1)}var Bg=$u(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Lt=function(e){Rn(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new td(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new Bg},t.prototype.next=function(r){var n=this;Do(function(){var i,o;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var c=Ei(n.currentObservers),u=c.next();!u.done;u=c.next()){var d=u.value;d.next(r)}}catch(p){i={error:p}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}}})},t.prototype.error=function(r){var n=this;Do(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var i=n.observers;i.length;)i.shift().error(r)}})},t.prototype.complete=function(){var r=this;Do(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,i=this,o=i.hasError,c=i.isStopped,u=i.observers;return o||c?$f:(this.currentObservers=null,u.push(r),new Ss(function(){n.currentObservers=null,eu(u,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,i=n.hasError,o=n.thrownError,c=n.isStopped;i?r.error(o):c&&r.complete()},t.prototype.asObservable=function(){var r=new bt;return r.source=this,r},t.create=function(r,n){return new td(r,n)},t}(bt),td=function(e){Rn(t,e);function t(r,n){var i=e.call(this)||this;return i.destination=r,i.source=n,i}return t.prototype.next=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.next)===null||i===void 0||i.call(n,r)},t.prototype.error=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.error)===null||i===void 0||i.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,i;return(i=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&i!==void 0?i:$f},t}(Lt);function rd(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Ng()(Ba(e,Na(e)))}var qg=new bt(function(e){return e.complete()});function ya(e,t){return t===void 0&&(t=Ma),e=e??Fg,tr(function(r,n){var i,o=!0;r.subscribe(_r(n,function(c){var u=t(c);(o||!e(i,u))&&(o=!1,i=u,n.next(c))}))})}function Fg(e,t){return e===t}function ke(e,t){return tr(function(r,n){var i=0;r.subscribe(_r(n,function(o){return e.call(t,o,i++)&&n.next(o)}))})}var jg=$u(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function Ug(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Na(e),n=zf(e,1/0);return tr(function(i,o){Nu(n)(Ba(kn([i],In(e)),r)).subscribe(o)})}function Kg(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Ug.apply(void 0,kn([],In(e)))}var Ar=function(e){Rn(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,i=r.thrownError,o=r._value;if(n)throw i;return this._throwIfClosed(),o},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(Lt),Hg=function(e){Rn(t,e);function t(r,n,i){r===void 0&&(r=1/0),n===void 0&&(n=1/0),i===void 0&&(i=Hf);var o=e.call(this)||this;return o._bufferSize=r,o._windowTime=n,o._timestampProvider=i,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=n===1/0,o._bufferSize=Math.max(1,r),o._windowTime=Math.max(1,n),o}return t.prototype.next=function(r){var n=this,i=n.isStopped,o=n._buffer,c=n._infiniteTimeWindow,u=n._timestampProvider,d=n._windowTime;i||(o.push(r),!c&&o.push(u.now()+d)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),i=this,o=i._infiniteTimeWindow,c=i._buffer,u=c.slice(),d=0;d<u.length&&!r.closed;d+=o?1:2)r.next(u[d]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,i=r._timestampProvider,o=r._buffer,c=r._infiniteTimeWindow,u=(c?1:2)*n;if(n<1/0&&u<o.length&&o.splice(0,o.length-u),!c){for(var d=i.now(),p=0,m=1;m<o.length&&o[m]<=d;m+=2)p=m;p&&o.splice(0,p+1)}},t}(Lt);function zg(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new Lt}:t,n=e.resetOnError,i=n===void 0?!0:n,o=e.resetOnComplete,c=o===void 0?!0:o,u=e.resetOnRefCountZero,d=u===void 0?!0:u;return function(p){var m,g,S,_=0,E=!1,O=!1,T=function(){g==null||g.unsubscribe(),g=void 0},B=function(){T(),m=S=void 0,E=O=!1},j=function(){var G=m;B(),G==null||G.unsubscribe()};return tr(function(G,ce){_++,!O&&!E&&T();var ae=S=S??r();ce.add(function(){_--,_===0&&!O&&!E&&(g=Ic(j,d))}),ae.subscribe(ce),!m&&_>0&&(m=new xi({next:function(Z){return ae.next(Z)},error:function(Z){O=!0,T(),g=Ic(B,i,Z),ae.error(Z)},complete:function(){E=!0,T(),g=Ic(B,c),ae.complete()}}),Cr(G).subscribe(m))})(p)}}function Ic(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var i=new xi({next:function(){i.unsubscribe(),e()}});return Cr(t.apply(void 0,kn([],In(r)))).subscribe(i)}}function qa(e,t,r){var n,i,o,c,u=!1;return e&&typeof e=="object"?(n=e.bufferSize,c=n===void 0?1/0:n,i=e.windowTime,t=i===void 0?1/0:i,o=e.refCount,u=o===void 0?!1:o,r=e.scheduler):c=e??1/0,zg({connector:function(){return new Hg(c,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:u})}function Fa(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Na(e);return tr(function(n,i){(r?rd(e,n,r):rd(e,n)).subscribe(i)})}function Wg(e,t){return tr(function(r,n){var i=null,o=0,c=!1,u=function(){return c&&!i&&n.complete()};r.subscribe(_r(n,function(d){i==null||i.unsubscribe();var p=0,m=o++;Cr(e(d,m)).subscribe(i=_r(n,function(g){return n.next(t?t(d,g,m,p++):g)},function(){i=null,u()}))},function(){c=!0,u()}))})}function Gf(e){return e.documentData?e.documentData:e.previousDocumentData}function Vg(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:Se.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var Qg=new Map;function Yf(e){return Ut(Qg,e,()=>{for(var t=new Array(e.events.length),r=e.events,n=e.collectionName,i=e.isLocal,o=Se.deepFreezeWhenDevMode,c=0;c<r.length;c++){var u=r[c];t[c]={documentId:u.documentId,collectionName:n,isLocal:i,operation:u.operation,documentData:o(u.documentData),previousDocumentData:o(u.previousDocumentData)}}return t})}function yn(e,t){return new Promise(function(r,n){var i=new xi({next:function(o){r(o),i.unsubscribe()},error:n,complete:function(){n(new jg)}});e.subscribe(i)})}function Gg(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Na(e),n=zf(e,1/0),i=e;return i.length?i.length===1?Cr(i[0]):Nu(n)(Ba(i,r)):qg}var Yn="ï¿¿",Jn=Number.MIN_SAFE_INTEGER;function Yg(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var i=!!t.sort.find(m=>Object.values(m)[0]==="desc"),o=new Set;Object.keys(r).forEach(m=>{var g=Si(e,m);g&&g.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[m],"$eq")&&o.add(m)});var c=t.sort.map(m=>Object.keys(m)[0]),u=c.filter(m=>!o.has(m)).join(","),d=-1,p;if(n.forEach(m=>{var g=!0,S=!0,_=m.map(j=>{var G=r[j],ce=G?Object.keys(G):[],ae={};if(!G||!ce.length){var Z=S?Jn:Yn;ae={startKey:Z,endKey:g?Yn:Jn,inclusiveStart:!0,inclusiveEnd:!0}}else ce.forEach(ne=>{if(Bu.has(ne)){var he=G[ne],ye=ey(ne,he);ae=Object.assign(ae,ye)}});return typeof ae.startKey>"u"&&(ae.startKey=Jn),typeof ae.endKey>"u"&&(ae.endKey=Yn),typeof ae.inclusiveStart>"u"&&(ae.inclusiveStart=!0),typeof ae.inclusiveEnd>"u"&&(ae.inclusiveEnd=!0),S&&!ae.inclusiveStart&&(S=!1),g&&!ae.inclusiveEnd&&(g=!1),ae}),E=_.map(j=>j.startKey),O=_.map(j=>j.endKey),T={index:m,startKeys:E,endKeys:O,inclusiveEnd:g,inclusiveStart:S,sortSatisfiedByIndex:!i&&u===m.filter(j=>!o.has(j)).join(","),selectorSatisfiedByIndex:Zg(m,t.selector,E,O)},B=ty(e,t,T);(B>=d||t.index)&&(d=B,p=T)}),!p)throw X("SNH",{query:t});return p}var Bu=new Set(["$eq","$gt","$gte","$lt","$lte"]),Jg=new Set(["$eq","$gt","$gte"]),Xg=new Set(["$eq","$lt","$lte"]);function Zg(e,t,r,n){var i=Object.entries(t),o=i.find(([ne,he])=>{if(!e.includes(ne))return!0;var ye=Object.entries(he).find(([xe,Pe])=>!Bu.has(xe));return ye});if(o||t.$and||t.$or)return!1;var c=[],u=new Set;for(var[d,p]of Object.entries(t)){if(!e.includes(d))return!1;var m=Object.keys(p).filter(ne=>Jg.has(ne));if(m.length>1)return!1;var g=m[0];if(g&&u.add(d),g!=="$eq"){if(c.length>0)return!1;c.push(g)}}var S=[],_=new Set;for(var[E,O]of Object.entries(t)){if(!e.includes(E))return!1;var T=Object.keys(O).filter(ne=>Xg.has(ne));if(T.length>1)return!1;var B=T[0];if(B&&_.add(E),B!=="$eq"){if(S.length>0)return!1;S.push(B)}}var j=0;for(var G of e){for(var ce of[u,_]){if(!ce.has(G)&&ce.size>0)return!1;ce.delete(G)}var ae=r[j],Z=n[j];if(ae!==Z&&u.size>0&&_.size>0)return!1;j++}return!0}function ey(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function ty(e,t,r){var n=0,i=m=>{m>0&&(n=n+m)},o=10,c=bc(r.startKeys,m=>m!==Jn&&m!==Yn);i(c*o);var u=bc(r.startKeys,m=>m!==Yn&&m!==Jn);i(u*o);var d=bc(r.startKeys,(m,g)=>m===r.endKeys[g]);i(d*o*1.5);var p=r.sortSatisfiedByIndex?5:0;return i(p),n}class ja extends Error{}const ba=Symbol("missing"),Jf=Object.freeze(new Error("mingo: cycle detected while processing object/array")),Ua=e=>{const t=Oo(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},jr=e=>typeof e!="object"&&typeof e!="function"||e===null,Xf=e=>jr(e)||Ci(e)||pr(e),Zf={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},Mt=(e,t)=>{e===ba&&(e=void 0),t===ba&&(t=void 0);const[r,n]=[e,t].map(i=>Zf[_a(i)]||0);return r!==n?r-n:Ft(e,t)?0:e<t?-1:e>t?1:0};var Oa,sr,pn;const ol=class ol extends Map{constructor(){super();Fe(this,Oa,Ua);Fe(this,sr,new Map);Fe(this,pn,r=>{const n=W(this,Oa).call(this,r);return[(W(this,sr).get(n)||[]).find(i=>Ft(i,r)),n]})}static init(r){const n=new ol;return r&&je(n,Oa,r),n}clear(){super.clear(),W(this,sr).clear()}delete(r){if(jr(r))return super.delete(r);const[n,i]=W(this,pn).call(this,r);return super.delete(n)?(W(this,sr).set(i,W(this,sr).get(i).filter(o=>!Ft(o,n))),!0):!1}get(r){if(jr(r))return super.get(r);const[n,i]=W(this,pn).call(this,r);return super.get(n)}has(r){if(jr(r))return super.has(r);const[n,i]=W(this,pn).call(this,r);return super.has(n)}set(r,n){if(jr(r))return super.set(r,n);const[i,o]=W(this,pn).call(this,r);if(super.has(i))super.set(i,n);else{super.set(r,n);const c=W(this,sr).get(o)||[];c.push(r),W(this,sr).set(o,c)}return this}get size(){return super.size}};Oa=new WeakMap,sr=new WeakMap,pn=new WeakMap;let wa=ol;function Ee(e,t){if(!e)throw new ja(t)}const ry=Object.keys(Zf).reduce((e,t)=>(e["[object "+t[0].toUpperCase()+t.substring(1)+"]"]=t,e),{});function _a(e){var r,n;const t=Object.prototype.toString.call(e);return t==="[object Object]"?((n=(r=e==null?void 0:e.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":ry[t]||t.substring(8,t.length-1).toLowerCase()}const Xn=e=>typeof e=="boolean",Kt=e=>typeof e=="string",ny=e=>typeof e=="symbol",Ge=e=>!isNaN(e)&&typeof e=="number",pe=Array.isArray;function Ke(e){if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&_a(e)==="object"}const eh=e=>!jr(e),Ci=e=>e instanceof Date,pr=e=>e instanceof RegExp,Es=e=>typeof e=="function",wt=e=>e==null,Ii=(e,t=!0)=>!!e||t&&e==="",qu=e=>wt(e)||Kt(e)&&!e||pe(e)&&e.length===0||Ke(e)&&Object.keys(e).length===0,Li=e=>pe(e)?e:[e],Ht=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),iy=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),ki=(e,t)=>{if(wt(e)||Xn(e)||Ge(e)||Kt(e))return e;if(Ci(e))return new Date(e);if(pr(e))return new RegExp(e);if(iy(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw Jf;t.add(e);try{if(pe(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=ki(e[n],t);return r}if(Ke(e)){const r={};for(const n of Object.keys(e))r[n]=ki(e[n],t);return r}}finally{t.delete(e)}return e},nd=e=>e===ba;function tu(e,t){if(nd(e)||wt(e))return t;if(nd(t)||wt(t))return e;if(jr(e)||jr(t))return t;pe(e)&&pe(t)&&Ee(e.length===t.length,"arrays must be of equal length to merge.");for(const r of Object.keys(t))e[r]=tu(e[r],t[r]);return e}function th(e,t=Ua){const r=[wa.init(t),wa.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(i=>{r[0].has(i)&&r[1].set(i,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function rh(e,t=1){const r=new Array;function n(i,o){for(let c=0,u=i.length;c<u;c++)pe(i[c])&&(o>0||o<0)?n(i[c],Math.max(-1,o-1)):r.push(i[c])}return n(e,t),r}function ay(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}function nh(e){for(;e;){if(Object.getOwnPropertyNames(e).includes("toString"))return e.toString!==Object.prototype.toString;e=Object.getPrototypeOf(e)}return!1}function Ft(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object"||e.constructor!==t.constructor)return!1;if(e instanceof Date)return+e==+t;if(e instanceof RegExp)return e.toString()===t.toString();const r=e.constructor;if(r===Array||r===Object){const n=Object.keys(e).sort(),i=Object.keys(t).sort();if(n.length!==i.length)return!1;for(let o=0,c=n[o];o<n.length;c=n[++o])if(c!==i[o]||!Ft(e[c],t[c]))return!1;return!0}return nh(e)&&e.toString()===t.toString()}function oy(e,t=Ua){const r=wa.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}const Oo=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";if(Kt(e)||Ge(e)||Xn(e))return JSON.stringify(e);if(Ci(e))return e.toISOString();if(pr(e)||ny(e)||Es(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw Jf;try{if(t.add(e),pe(e))return"["+e.map(n=>Oo(n,t)).join(",")+"]";if(Ke(e))return"{"+Object.keys(e).sort().map(i=>`${i}:${Oo(e[i],t)}`).join()+"}";const r=nh(e)?e.toString():Oo(ay(e),t);return _a(e)+"("+r+")"}finally{t.delete(e)}};function sy(e,t){return wt(e)?null:(t=t||Ua,t(e))}function cy(e,t,r=Ua){if(e.length<1)return new Map;const n=new Map,i=new Map;for(let o=0;o<e.length;o++){const c=e[o],u=t(c,o),d=sy(u,r);if(d===null)i.has(null)?i.get(null).push(c):i.set(null,[c]);else{const p=n.has(d)?n.get(d).find(m=>Ft(m,u)):null;wt(p)?(i.set(u,[c]),n.has(d)?n.get(d).push(u):n.set(d,[u])):i.get(p).push(c)}}return i}function ru(e,t){return eh(e)?e[t]:void 0}function uy(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function er(e,t,r){let n=0;function i(c,u){let d=c;for(let p=0;p<u.length;p++){const m=u[p];if(/^\d+$/.exec(m)===null&&pe(d)){if(p===0&&n>0)break;n+=1;const S=u.slice(p);d=d.reduce((_,E)=>{const O=i(E,S);return O!==void 0&&_.push(O),_},[]);break}else d=ru(d,m);if(d===void 0)break}return d}const o=Xf(e)?e:i(e,t.split("."));return pe(o)&&(r!=null&&r.unwrapArray)?uy(o,n):o}function na(e,t,r){const n=t.indexOf("."),i=n==-1?t:t.substring(0,n),o=t.substring(n+1),c=n!=-1;if(pe(e)){const p=/^\d+$/.test(i),m=p&&(r!=null&&r.preserveIndex)?[...e]:[];if(p){const g=parseInt(i);let S=ru(e,g);c&&(S=na(S,o,r)),r!=null&&r.preserveIndex?m[g]=S:m.push(S)}else for(const g of e){const S=na(g,t,r);r!=null&&r.preserveMissing?m.push(S??ba):(S!=null||r!=null&&r.preserveIndex)&&m.push(S)}return m}const u=r!=null&&r.preserveKeys?{...e}:{};let d=ru(e,i);if(c&&(d=na(d,o,r)),d!==void 0)return u[i]=d,u}function nu(e){if(pe(e))for(let t=e.length-1;t>=0;t--)e[t]===ba?e.splice(t,1):nu(e[t]);else if(Ke(e))for(const t in e)Ht(e,t)&&nu(e[t])}const id=/^\d+$/;function Sa(e,t,r,n){const i=t.split("."),o=i[0],c=i.slice(1).join(".");if(i.length===1)(Ke(e)||pe(e)&&id.test(o))&&r(e,o);else{n!=null&&n.buildGraph&&wt(e[o])&&(e[o]={});const u=e[o];if(!u)return;const d=!!(i.length>1&&id.test(i[1]));pe(u)&&(n!=null&&n.descendArray)&&!d?u.forEach(p=>Sa(p,c,r,n)):Sa(u,c,r,n)}}function ly(e,t,r){Sa(e,t,(n,i)=>{n[i]=Es(r)?r(n[i]):r},{buildGraph:!0})}function ad(e,t,r){Sa(e,t,(n,i)=>{if(pe(n)){if(/^\d+$/.test(i))n.splice(parseInt(i),1);else if(r&&r.descendArray)for(const o of n)Ke(o)&&delete o[i]}else Ke(n)&&delete n[i]},r)}const dy=/^\$[a-zA-Z0-9_]+$/;function Qr(e){return dy.test(e)}function ih(e){if(Xf(e))return pr(e)?{$regex:e}:{$eq:e};if(eh(e)){if(!Object.keys(e).some(Qr))return{$eq:e};if(Ht(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var iu=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(iu||{}),Qe,Pa,cr;const ua=class ua{constructor(t,r,n){Fe(this,Qe);Fe(this,Pa);Fe(this,cr);je(this,Qe,t),this.update(r,n)}static init(t,r,n){var i;return t instanceof ua?new ua(W(t,Qe),t.root??r,{...W(t,cr),...n,variables:Object.assign({},(i=W(t,cr))==null?void 0:i.variables,n==null?void 0:n.variables)}):new ua(t,r,n)}update(t,r){var i;je(this,Pa,t);const n=Object.assign({},(i=W(this,cr))==null?void 0:i.variables,r==null?void 0:r.variables);return Object.keys(n).length?je(this,cr,{...r,variables:n}):je(this,cr,r??{}),this}getOptions(){return Object.freeze({...W(this,Qe),context:Dn.from(W(this,Qe).context)})}get root(){return W(this,Pa)}get local(){return W(this,cr)}get idKey(){return W(this,Qe).idKey}get collation(){var t;return(t=W(this,Qe))==null?void 0:t.collation}get processingMode(){var t;return((t=W(this,Qe))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=W(this,Qe))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=W(this,Qe))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=W(this,Qe))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=W(this,Qe))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=W(this,Qe))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=W(this,Qe))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=W(this,Qe))==null?void 0:t.variables}get context(){var t;return(t=W(this,Qe))==null?void 0:t.context}};Qe=new WeakMap,Pa=new WeakMap,cr=new WeakMap;let Ea=ua;function ah(e){return e instanceof Ea?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:e!=null&&e.context?Dn.from(e==null?void 0:e.context):Dn.init()})}var au=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(au||{}),Nr;const gs=class gs{constructor(){Fe(this,Nr,new Map)}static init(){return new gs}static from(t){const r=gs.init();return wt(t)||W(t,Nr).forEach((n,i)=>r.addOperators(i,n)),r}addOperators(t,r){W(this,Nr).has(t)||W(this,Nr).set(t,{});for(const[n,i]of Object.entries(r))this.getOperator(t,n)||(W(this,Nr).get(t)[n]=i);return this}getOperator(t,r){return(W(this,Nr).get(t)??{})[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};Nr=new WeakMap;let Dn=gs;const cn=Dn.init();function od(e,t){for(const[r,n]of Object.entries(t)){Ee(Es(n)&&Qr(r),`'${r}' is not a valid operator`);const i=xa(e,r,null);Ee(!i||n===i,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":cn.addAccumulatorOps(t);break;case"expression":cn.addExpressionOps(t);break;case"pipeline":cn.addPipelineOps(t);break;case"projection":cn.addProjectionOps(t);break;case"query":cn.addQueryOps(t);break;case"window":cn.addWindowOps(t);break}}function xa(e,t,r){const{context:n,useGlobalContext:i}=r||{},o=n?n.getOperator(e,t):null;return!o&&i?cn.getOperator(e,t):o}function Pt(e,t,r,n){const i=Ea.init(n,e);return r&&Qr(r)?oh(e,t,r,i):Vo(e,t,i)}const fy=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Vo(e,t,r){var n;if(Kt(t)&&t.length>0&&t[0]==="$"){if(hy.includes(t))return t;let i=r.root;const o=t.split(".");if(fy.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":i=e;break;case"$$REMOVE":i=void 0;break;case"$$NOW":i=new Date;break}t=t.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){i=Object.assign({},r.variables,{this:e},(n=r==null?void 0:r.local)==null?void 0:n.variables);const c=o[0].slice(2);Ee(Ht(i,c),`Use of undefined variable: ${c}`),t=t.slice(2)}else t=t.slice(1);return t===""?i:er(i,t)}if(pe(t))return t.map(i=>Vo(e,i,r));if(Ke(t)){const i={},o=Object.entries(t);for(const[c,u]of o){if(Qr(c))return Ee(o.length==1,"expression must have single operator."),oh(e,u,c,r);i[c]=Vo(e,u,r)}return i}return t}function oh(e,t,r,n){const i=xa("expression",r,n);if(i)return i(e,t,n);const o=xa("accumulator",r,n);return Ee(!!o,`accumulator '${r}' is not registered.`),pe(e)||(e=Vo(e,t,n),t=null),Ee(pe(e),`arguments must resolve to array for ${r}.`),o(e,t,n)}const hy=["$$KEEP","$$PRUNE","$$DESCEND"];function Ca(e){return e instanceof sd?e:new sd(e)}function py(...e){let t=0;return Ca(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function my(e){return!!e&&typeof e=="object"&&(e==null?void 0:e.next)instanceof Function}function vy(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const ou=new Error;function gy(e,t,r){let n=!1,i=-1,o=0;return function(c){try{e:for(;!n;){let u=e();i++;let d=-1;const p=t.length;let m=!1;for(;++d<p;){const g=t[d];switch(g.action){case 0:u=g.func(u,i);break;case 1:if(!g.func(u,i))continue e;break;case 2:--g.count,g.count||(m=!0);break;case 3:--g.count,g.count||vy(t,d);continue e;default:break e}}if(n=m,c)r[o++]=u;else return{value:u,done:!1}}}catch(u){if(u!==ou)throw u}return n=!0,{done:n}}}var mn,ri,ni,of;let sd=(of=class{constructor(t){Fe(this,mn);Fe(this,ri);Fe(this,ni);je(this,mn,[]),je(this,ri,[]),this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),my(t)){const n=t;r=()=>{const i=n.next();if(i.done)throw ou;return i.value}}else if(pe(t)){const n=t,i=n.length;let o=0;r=()=>{if(o<i)return n[o++];throw ou}}else if(!(t instanceof Function))throw new ja("Lazy must be initialized with an array, generator, or function.");je(this,ni,gy(r,W(this,mn),W(this,ri)))}push(t,r){return typeof r=="function"?W(this,mn).push({action:t,func:r}):typeof r=="number"&&W(this,mn).push({action:t,count:r}),this}next(){return W(this,ni).call(this)}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return Ca(()=>(n||(n=Ca(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=W(this,ni).call(this,!0).done),W(this,ri)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}},mn=new WeakMap,ri=new WeakMap,ni=new WeakMap,of);const yy=(e,t,r)=>e.take(t),sh=(e,t,r)=>qu(t)?e:(uh(t,r),e.map(ch(t,Ea.init(r))));function ch(e,t,r=!0){const n=t.idKey,i=Object.keys(e),o=new Array,c=new Array,u={};for(const _ of i){const E=e[_];if(Ge(E)||Xn(E))E?c.push(_):o.push(_);else if(pe(E))u[_]=O=>E.map(T=>Pt(O,T,null,t.update(O))??null);else if(Ke(E)){const O=Object.keys(E),T=O.length==1?O[0]:"",B=xa("projection",T,t);B?T==="$slice"&&!Li(E[T]).every(Ge)?u[_]=G=>Pt(G,E,_,t.update(G)):u[_]=G=>B(G,E[T],_,t.update(G)):Qr(T)?u[_]=j=>Pt(j,E[T],T,t):(uh(E,t),u[_]=j=>{if(!Ht(j,_))return Pt(j,E,null,t);r&&t.update(j);const G=er(j,_),ce=ch(E,t,!1);return pe(G)?G.map(ce):Ke(G)?ce(G):ce(j)})}else u[_]=Kt(E)&&E[0]==="$"?O=>Pt(O,E,_,t):O=>E}const d=Object.keys(u),p=o.includes(n);if(r&&p&&o.length===1&&!c.length&&!d.length)return _=>{const E={..._};return delete E[n],E};const g=r&&!p&&!c.includes(n),S={preserveMissing:!0};return _=>{const E={};if(o.length&&!c.length){tu(E,_);for(const O of o)ad(E,O,{descendArray:!0})}for(const O of c){const T=na(_,O,S)??{};tu(E,T)}c.length&&nu(E);for(const O of d){const T=u[O](_);T===void 0?ad(E,O,{descendArray:!0}):ly(E,O,T)}return g&&Ht(_,n)&&(E[n]=er(_,n)),E}}function uh(e,t){let r=!1,n=!1;for(const[i,o]of Object.entries(e))Ee(!i.startsWith("$"),"Field names may not start with '$'."),Ee(!i.endsWith(".$"),"Positional projection operator '$' is not supported."),i!==(t==null?void 0:t.idKey)&&(o===0||o===!1?r=!0:(o===1||o===!0)&&(n=!0),Ee(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const by=(e,t,r)=>e.drop(t),lh=(e,t,r)=>{if(qu(t)||!Ke(t))return e;let n=Mt;const i=r.collation;return Ke(i)&&Kt(i.locale)&&(n=_y(i)),e.transform(o=>{const c=Object.keys(t);for(const u of c.reverse()){const d=cy(o,g=>er(g,u),r.hashFunction),p=Array.from(d.keys()).sort(n);t[u]===-1&&p.reverse();let m=0;for(const g of p)for(const S of d.get(g))o[m++]=S;Ee(m==o.length,"bug: counter must match collection size.")}return o})},wy={1:"base",2:"accent",3:"variant"};function _y(e){const t={sensitivity:wy[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,i)=>{if(!Kt(n)||!Kt(i))return Mt(n,i);const o=r.compare(n,i);return o<0?-1:o>0?1:0}}const Sy={$sort:lh,$skip:by,$limit:yy};var Ra,La,ii,ur,Br,vt,lr;class Ey{constructor(t,r,n,i){Fe(this,Ra);Fe(this,La);Fe(this,ii);Fe(this,ur);Fe(this,Br,{});Fe(this,vt,null);Fe(this,lr,[]);je(this,Ra,t),je(this,La,r),je(this,ii,n),je(this,ur,i)}fetch(){if(W(this,vt))return W(this,vt);je(this,vt,Ca(W(this,Ra)).filter(W(this,La)));const t=W(this,ur).processingMode;t&iu.CLONE_INPUT&&W(this,vt).map(ki);for(const r of["$sort","$skip","$limit"])Ht(W(this,Br),r)&&je(this,vt,Sy[r](W(this,vt),W(this,Br)[r],W(this,ur)));return Object.keys(W(this,ii)).length&&je(this,vt,sh(W(this,vt),W(this,ii),W(this,ur))),t&iu.CLONE_OUTPUT&&W(this,vt).map(ki),W(this,vt)}fetchAll(){const t=Ca([...W(this,lr)]);return je(this,lr,[]),py(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return W(this,Br).$skip=t,this}limit(t){return W(this,Br).$limit=t,this}sort(t){return W(this,Br).$sort=t,this}collation(t){return je(this,ur,{...W(this,ur),collation:t}),this}next(){if(W(this,lr).length>0)return W(this,lr).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(W(this,lr).length>0)return!0;const t=this.fetch().next();return t.done?!1:(W(this,lr).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}Ra=new WeakMap,La=new WeakMap,ii=new WeakMap,ur=new WeakMap,Br=new WeakMap,vt=new WeakMap,lr=new WeakMap;const xy=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));var ai,qr,vn;class Gr{constructor(t,r){Fe(this,ai);Fe(this,qr);Fe(this,vn);je(this,vn,ki(t)),je(this,qr,ah(r)),je(this,ai,[]),this.compile()}compile(){Ee(Ke(W(this,vn)),`query criteria must be an object: ${JSON.stringify(W(this,vn))}`);const t={};for(const[r,n]of Object.entries(W(this,vn))){if(r==="$where")Ee(W(this,qr).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(xy.has(r))this.processOperator(r,r,n);else{Ee(!Qr(r),`unknown top level operator: ${r}`);for(const[i,o]of Object.entries(ih(n)))this.processOperator(r,i,o)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const i=xa("query",r,W(this,qr));Ee(!!i,`unknown query operator ${r}`),W(this,ai).push(i(t,n,W(this,qr)))}test(t){return W(this,ai).every(r=>r(t))}find(t,r){return new Ey(t,n=>this.test(n),r||{},W(this,qr))}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}ai=new WeakMap,qr=new WeakMap,vn=new WeakMap;const Cy=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(Cy);function lt(e){return(r,n,i)=>{const o={unwrapArray:!0},c=Math.max(1,r.split(".").length-1);return u=>{const d=er(u,r,o);return e(d,n,{...i,depth:c})}}}function $i(e){return(t,r,n)=>{const i=Pt(t,r,null,n);return e(...i)}}function Fu(e,t,r){return Ft(e,t)||wt(e)&&wt(t)?!0:pe(e)?e.some(n=>Ft(n,t))||rh(e,r==null?void 0:r.depth).some(n=>Ft(n,t)):!1}function dh(e,t,r){return!Fu(e,t,r)}function fh(e,t,r){return wt(e)?t.some(n=>n===null):th([Li(e),t],r==null?void 0:r.hashFunction).length>0}function Iy(e,t,r){return!fh(e,t,r)}function hh(e,t,r){return xs(e,t,(n,i)=>Mt(n,i)<0)}function ph(e,t,r){return xs(e,t,(n,i)=>Mt(n,i)<=0)}function mh(e,t,r){return xs(e,t,(n,i)=>Mt(n,i)>0)}function vh(e,t,r){return xs(e,t,(n,i)=>Mt(n,i)>=0)}function ky(e,t,r){return Li(e).some(n=>t.length===2&&n%t[0]===t[1])}function Dy(e,t,r){const n=Li(e),i=o=>Kt(o)&&Ii(t.exec(o),r==null?void 0:r.useStrictMode);return n.some(i)||rh(n,1).some(i)}function Oy(e,t,r){if(!pe(e)||!pe(t)||!e.length||!t.length)return!1;let n=!0;for(const i of t){if(!n)break;Ke(i)&&Object.keys(i).includes("$elemMatch")?n=gh(e,i.$elemMatch,r):pr(i)?n=e.some(o=>typeof o=="string"&&i.test(o)):n=e.some(o=>Ft(i,o))}return n}function Py(e,t,r){return Array.isArray(e)&&e.length===t}function Ry(e){return Qr(e)&&["$and","$or","$nor"].indexOf(e)===-1}function gh(e,t,r){if(pe(e)&&!qu(e)){let n=c=>c,i=t;Object.keys(t).every(Ry)&&(i={temp:t},n=c=>({temp:c}));const o=new Gr(i,r);for(let c=0,u=e.length;c<u;c++)if(o.test(n(e[c])))return!0}return!1}const cd=e=>e===null,Ly={array:pe,boolean:Xn,bool:Xn,date:Ci,number:Ge,int:Ge,long:Ge,double:Ge,decimal:Ge,null:cd,object:Ke,regexp:pr,regex:pr,string:Kt,undefined:wt,function:e=>{throw new ja("unsupported type key `function`.")},1:Ge,2:Kt,3:Ke,4:pe,6:wt,8:Xn,9:Ci,10:cd,11:pr,16:Ge,18:Ge,19:Ge};function ud(e,t,r){const n=Ly[t];return n?n(e):!1}function $y(e,t,r){return pe(t)?t.findIndex(n=>ud(e,n))>=0:ud(e,t)}function xs(e,t,r){return Li(e).some(n=>_a(n)===_a(t)&&r(n,t))}const Ay=(e,t,r)=>{const n=Pt(e,t,null,r);return Ii(n,r.useStrictMode)&&n.every(i=>Ii(i,r.useStrictMode))},Ty=(e,t,r)=>{const n=Li(t);return n.length==0?!1:(Ee(n.length==1,"Expression $not takes exactly 1 argument"),!Pt(e,n[0],null,r))},My=(e,t,r)=>{const n=Pt(e,t,null,r),i=r.useStrictMode;return Ii(n,i)&&n.some(o=>Ii(o,i))},Ny=Object.freeze(Object.defineProperty({__proto__:null,$and:Ay,$not:Ty,$or:My},Symbol.toStringTag,{value:"Module"})),By=(e,t,r)=>{const n=Pt(e,t,null,r);return Ee(pe(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),Mt(n[0],n[1])},qy=$i(Fu),Fy=$i(mh),jy=$i(vh),Uy=$i(hh),Ky=$i(ph),Hy=$i(dh),zy=Object.freeze(Object.defineProperty({__proto__:null,$cmp:By,$eq:qy,$gt:Fy,$gte:jy,$lt:Uy,$lte:Ky,$ne:Hy},Symbol.toStringTag,{value:"Module"})),ld=(e,t)=>{const r={};return e.split("").forEach((n,i)=>r[n]=t*(i+1)),r};({...ld("ABCDEFGHIKLM",1),...ld("NOPQRSTUVWXY",-1)});const dd={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function xt(e,t=dd){const r=Object.assign({},dd,t),n=new Set(Object.keys(r));return(i,o,c)=>{const u=Pt(i,o,null,c);if(n.has(`${u}`)){const d=r[`${u}`];if(d instanceof Error)throw new ja(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return d}return e(u)}}xt(Math.acos,{Infinity:1/0,0:new Error});xt(Math.acosh,{Infinity:1/0,0:new Error});xt(Math.asin);xt(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});xt(Math.atan);xt(Math.atanh,{1:1/0,"-1":-1/0});xt(Math.cos);xt(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const Wy=Math.PI/180;xt(e=>e*Wy,{Infinity:1/0,"-Infinity":1/0});const Vy=180/Math.PI;xt(e=>e*Vy,{Infinity:1/0,"-Infinity":-1/0});xt(Math.sin);xt(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});xt(Math.tan);const yh=(e,t,r)=>{Ee(pe(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(i=>new Gr(i,r));return i=>n.every(o=>o.test(i))},ju=(e,t,r)=>{Ee(pe(t),"Invalid expression. $or expects value to be an Array");const n=t.map(i=>new Gr(i,r));return i=>n.some(o=>o.test(i))},bh=(e,t,r)=>{Ee(pe(t),"Invalid expression. $nor expects value to be an array.");const n=ju("$or",t,r);return i=>!n(i)},wh=(e,t,r)=>{const n={};n[e]=ih(t);const i=new Gr(n,r);return o=>!i.test(o)},_h=lt(Fu),Sh=lt(mh),Eh=lt(vh),xh=lt(fh),Ch=lt(hh),Ih=lt(ph),kh=lt(dh),Dh=lt(Iy);function Qy(e,t,r){return n=>Pt(n,t,null,r)}function Gy(e,t,r){if(!(r!=null&&r.jsonSchemaValidator))throw new ja("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return i=>n(i)}const Oh=lt(ky),Ph=lt(Dy);function Yy(e,t,r){Ee(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return Ee(Es(n),"$where only accepts a Function object"),i=>Ii(n.call(i),r==null?void 0:r.useStrictMode)}const Jy=lt(Oy),Rh=lt(gh),Lh=lt(Py),$h=(e,t,r)=>{const n=e.includes("."),i=!!t;return!n||e.match(/\.\d+$/)?o=>er(o,e)!==void 0===i:o=>{const c=na(o,e,{preserveIndex:!0}),u=er(c,e.substring(0,e.lastIndexOf(".")));return pe(u)?u.some(d=>d!==void 0)===i:u!==void 0===i}},Ah=lt($y);var fd=!1;function Xy(e){return fd||(od(au.PIPELINE,{$sort:lh,$project:sh}),od(au.QUERY,{$and:yh,$eq:_h,$elemMatch:Rh,$exists:$h,$gt:Sh,$gte:Eh,$in:xh,$lt:Ch,$lte:Ih,$ne:kh,$nin:Dh,$mod:Oh,$nor:bh,$not:wh,$or:ju,$regex:Ph,$size:Lh,$type:Ah}),fd=!0),new Gr(e)}function Zn(e,t){var r=Et(e.primaryKey);t=Me(t);var n=ut(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([g,S])=>{(typeof S!="object"||S===null)&&(n.selector[g]={$eq:S})})):n.selector={},n.index){var i=Du(n.index);i.includes(r)||i.push(r),n.index=i}if(n.sort){var m=n.sort.find(g=>wv(g)===r);m||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(g=>({[g]:"asc"}));else{if(e.indexes){var o=new Set;Object.entries(n.selector).forEach(([g,S])=>{var _=!1;typeof S=="object"&&S!==null?_=!!Object.keys(S).find(E=>Bu.has(E)):_=!0,_&&o.add(g)});var c=-1,u;e.indexes.forEach(g=>{var S=Ho(g)?g:[g],_=S.findIndex(E=>!o.has(E));_>0&&_>c&&(c=_,u=S)}),u&&(n.sort=u.map(g=>({[g]:"asc"})))}if(!n.sort)if(e.indexes&&e.indexes.length>0){var d=e.indexes[0],p=Ho(d)?d:[d];n.sort=p.map(g=>({[g]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function Th(e,t){if(!t.sort)throw X("SNH",{query:t});var r=[];t.sort.forEach(i=>{var o=Object.keys(i)[0],c=Object.values(i)[0];r.push({key:o,direction:c,getValueFn:bv(o)})});var n=(i,o)=>{for(var c=0;c<r.length;++c){var u=r[c],d=u.getValueFn(i),p=u.getValueFn(o);if(d!==p){var m=u.direction==="asc"?Mt(d,p):Mt(p,d);return m}}};return n}function Uu(e,t){if(!t.sort)throw X("SNH",{query:t});var r=Xy(t.selector),n=i=>r.test(i);return n}async function Un(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(i=>t(i)));if(r instanceof Map)return Promise.all([...r.values()].map(i=>t(i)));var n=await t(r);return n}function Cs(e,t){if(!t.sort)throw X("SNH",{query:t});var r=Yg(e,t);return{query:t,queryPlan:r}}var Zy="_rxdb_internal";async function Ka(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function Ia(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var i=n.error[0];throw i}else{var o=Et(e.schema.primaryKey),c=Nt(o,[t],n),u=c[0];return u}}function eb(e,t){var r=Ka(e,t),n=e.changeStream().pipe(Ue(i=>i.events.find(o=>o.documentId===t)),ke(i=>!!i),Ue(i=>Promise.resolve(le(i).documentData)),Fa(r),Wg(i=>i),ke(i=>!!i));return n}function ka(e){return Object.assign({},...e)}function Qo(e,t,r,n){if(n)throw n.status===409?X("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?X("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function tb(e,t,r,n,i,o,c){for(var u=!!e.schema.attachments,d=[],p=[],m=[],g=$a(10),S={id:g,events:[],checkpoint:null,context:i},_=S.events,E=[],O=[],T=[],B=r.size>0,j,G=n.length,ce=function(){var Z=n[ae],ne=Z.document,he=Z.previous,ye=ne[t],xe=ne._deleted,Pe=he&&he._deleted,J=void 0;B&&(J=r.get(ye));var be;if(J){var tt=J._rev;if(!he||he&&tt!==he._rev){var rr={isError:!0,status:409,documentId:ye,writeRow:Z,documentInDb:J};return m.push(rr),1}var Ne=u?kc(Z):Z;u&&(xe?he&&Object.keys(he._attachments).forEach(me=>{O.push({documentId:ye,attachmentId:me,digest:le(he)._attachments[me].digest})}):(Object.entries(ne._attachments).find(([me,ze])=>{var It=he?he._attachments[me]:void 0;return!It&&!ze.data&&(be={documentId:ye,documentInDb:J,isError:!0,status:510,writeRow:Z,attachmentId:me}),!0}),be||Object.entries(ne._attachments).forEach(([me,ze])=>{var It=he?he._attachments[me]:void 0;if(!It)E.push({documentId:ye,attachmentId:me,attachmentData:ze,digest:ze.digest});else{var Ir=Ne.document._attachments[me].digest;ze.data&&It.digest!==Ir&&T.push({documentId:ye,attachmentId:me,attachmentData:ze,digest:ze.digest})}}))),be?m.push(be):(u?p.push(kc(Ne)):p.push(Ne),j=Ne);var at=null,oe=null,$e=null;if(Pe&&!xe)$e="INSERT",at=u?Zt(ne):ne;else if(he&&!Pe&&!xe)$e="UPDATE",at=u?Zt(ne):ne,oe=he;else if(xe)$e="DELETE",at=le(ne),oe=he;else throw X("SNH",{args:{writeRow:Z}});var Je={documentId:ye,documentData:at,previousDocumentData:oe,operation:$e};_.push(Je)}else{var Ce=!!xe;if(u&&Object.entries(ne._attachments).forEach(([me,ze])=>{ze.data?E.push({documentId:ye,attachmentId:me,attachmentData:ze,digest:ze.digest}):(be={documentId:ye,isError:!0,status:510,writeRow:Z,attachmentId:me},m.push(be))}),be||(u?d.push(kc(Z)):d.push(Z),j=Z),!Ce){var De={documentId:ye,operation:"INSERT",documentData:u?Zt(ne):ne,previousDocumentData:u&&he?Zt(he):he};_.push(De)}}},ae=0;ae<G;ae++)ce();return{bulkInsertDocs:d,bulkUpdateDocs:p,newestRow:j,errors:m,eventBulk:S,attachmentsAdd:E,attachmentsRemove:O,attachmentsUpdate:T}}function kc(e){return{previous:e.previous,document:Zt(e.document)}}function rb(e){return atob(e).length}function nb(e){var t=e.data;if(!t)return e;var r={length:rb(t),digest:e.digest,type:e.type};return r}function Zt(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=Me(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=nb(n)}),t}function Ha(e){return Object.assign({},e,{_meta:Me(e._meta)})}function Ku(e,t,r){Se.deepFreezeWhenDevMode(r);var n=Et(t.schema.primaryKey),i={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,async bulkWrite(o,c){for(var u=e.token,d=new Array(o.length),p=St(),m=0;m<o.length;m++){var g=o[m],S=Ha(g.document);S._meta.lwt=p;var _=g.previous;S._rev=br(u,_),d[m]={document:S,previous:_}}ft("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:d});var E=await e.lockedRun(()=>t.bulkWrite(d,c)),O={error:[]};Nh.set(O,d);var T=E.error.length===0?[]:E.error.filter(Z=>Z.status===409&&!Z.writeRow.previous&&!Z.writeRow.document._deleted&&le(Z.documentInDb)._deleted?!0:(O.error.push(Z),!1));if(T.length>0){var B=new Set,j=T.map(Z=>(B.add(Z.documentId),{previous:Z.documentInDb,document:Object.assign({},Z.writeRow.document,{_rev:br(e.token,Z.documentInDb)})})),G=await e.lockedRun(()=>t.bulkWrite(j,c));Cn(O.error,G.error);var ce=Nt(n,d,O,B),ae=Nt(n,j,G);return Cn(ce,ae),O}return O},query(o){return e.lockedRun(()=>t.query(o))},count(o){return e.lockedRun(()=>t.count(o))},findDocumentsById(o,c){return e.lockedRun(()=>t.findDocumentsById(o,c))},getAttachmentData(o,c,u){return e.lockedRun(()=>t.getAttachmentData(o,c,u))},getChangedDocumentsSince:t.getChangedDocumentsSince?(o,c)=>e.lockedRun(()=>t.getChangedDocumentsSince(le(o),c)):void 0,cleanup(o){return e.lockedRun(()=>t.cleanup(o))},remove(){return e.storageInstances.delete(i),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(i),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()}};return e.storageInstances.add(i),i}function ib(e){if(e.schema.keyCompression)throw X("UT5",{args:{params:e}});if(su(e.schema))throw X("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw X("UT7",{args:{params:e}})}function su(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function ab(e,t,r){var n=Et(e.schema.primaryKey),i=r?r.lwt:Ou,o=r?r.id:"";return Zn(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:i}},{"_meta.lwt":{$eq:i},[n]:{$gt:r?o:""}}],"_meta.lwt":{$gte:i}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function Mh(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=Et(e.schema.primaryKey),i=Cs(e.schema,ab(e,t,r)),o=await e.query(i),c=o.documents,u=vv(c);return{documents:c,checkpoint:u?{id:u[n],lwt:u._meta.lwt}:r||{id:"",lwt:0}}}var Nh=new WeakMap,ob=new WeakMap;function Nt(e,t,r,n){return Ut(ob,r,()=>{var i=[],o=Nh.get(r);if(o||(o=t),r.error.length>0||n){for(var c=n||new Set,u=0;u<r.error.length;u++){var d=r.error[u];c.add(d.documentId)}for(var p=0;p<o.length;p++){var m=o[p].document;c.has(m[e])||i.push(Zt(m))}}else{i.length=t.length-r.error.length;for(var g=0;g<o.length;g++){var S=o[g].document;i[g]=Zt(S)}}return i})}var Bh=function(){function e(r,n,i,o){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=i,this.postWrite=o}var t=e.prototype;return t.addWrite=function(n,i){var o=n[this.primaryPath],c=Ut(this.queueByDocId,o,()=>[]),u=new Promise((d,p)=>{var m={lastKnownDocumentState:n,modifier:i,resolve:d,reject:p};le(c).push(m),this.triggerRun()});return u},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],i=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(i.entries()).map(async([c,u])=>{var d=sb(u.map(g=>g.lastKnownDocumentState)),p=d;for(var m of u)try{p=await m.modifier(ut(p))}catch(g){m.reject(g),m.reject=()=>{},m.resolve=()=>{}}try{await this.preWrite(p,d)}catch(g){u.forEach(S=>S.reject(g));return}n.push({previous:d,document:p})}));var o=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(Nt(this.primaryPath,n,o).map(c=>{var u=c[this.primaryPath];this.postWrite(c);var d=_i(i,u);d.forEach(p=>p.resolve(c))})),o.error.forEach(c=>{var u=c.documentId,d=_i(i,u),p=ws(c);if(p){var m=Ut(this.queueByDocId,u,()=>[]);d.reverse().forEach(S=>{S.lastKnownDocumentState=le(p.documentInDb),le(m).unshift(S)})}else{var g=kf(c);d.forEach(S=>S.reject(g))}}),this.isRunning=!1,this.triggerRun()}},e}();function hd(e){var t=async r=>{var n=_v(r);n._deleted=r._deleted;var i=await e(n),o=Object.assign({},i,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof i._deleted<"u"?i._deleted:r._deleted});return typeof o._deleted>"u"&&(o._deleted=!1),o};return t}function sb(e){var t=e[0],r=zr(t._rev);return e.forEach(n=>{var i=zr(n._rev);i>r&&(t=n,r=i)}),t}var Is={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(Ue(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,t=this.primary;return e.collection.eventBulks$.pipe(ke(r=>!r.isLocal),Ue(r=>r.events.find(n=>n.documentId===t)),ke(r=>!!r),Ue(r=>Gf(le(r))),Fa(e.collection._docCache.getLatestDocumentData(t)),ya((r,n)=>r._rev===n._rev),Ue(r=>this.collection._docCache.getCachedRxDocument(r)),qa(Aa))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(Se.isDevMode()){if(e.includes(".item."))throw X("DOC1",{path:e});if(e===this.primaryPath)throw X("DOC2");if(this.collection.schema.finalFields.includes(e))throw X("DOC3",{path:e});var t=Si(this.collection.schema.jsonSchema,e);if(!t)throw X("DOC4",{path:e})}return this.$.pipe(Ue(r=>Wr(r,e)),ya())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=Si(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return Pu;if(!t)throw X("DOC5",{path:e});if(!t.ref)throw X("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw X("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(i=>{var o=i.values();return Array.from(o)}):n.findOne(r).exec()},get(e){return jh(this,e)},toJSON(e=!1){if(e)return Se.deepFreezeWhenDevMode(this._data);var t=Me(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,Se.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return ut(this.toJSON(e))},update(e){throw Ie("update")},incrementalUpdate(e){throw Ie("update")},updateCRDT(e){throw Ie("crdt")},putAttachment(){throw Ie("attachments")},getAttachment(){throw Ie("attachments")},allAttachments(){throw Ie("attachments")},get allAttachments$(){throw Ie("attachments")},async modify(e,t){var r=this._data,n=await hd(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,hd(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=ut(t);return Object.entries(e).forEach(([n,i])=>{r[n]=i}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=Me(e),this._data._deleted)throw X("DOC11",{id:this.primary,document:this});await Fh(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),i=n.error[0];return Qo(this.collection,this.primary,e,i),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(Nt(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(X("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var t=e.error[0];Qo(this.collection,this.primary,this._data,t)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw X("DOC14")}};function qh(e=Is){var t=function(n,i){this.collection=n,this._data=i,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function cb(e,t,r){var n=new e(t,r);return ft("createRxDocument",n),n}function Fh(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),Se.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function jh(e,t){return Ut(e._propertyCache,t,()=>{var r=Wr(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return Se.deepFreezeWhenDevMode(r);var n=new Proxy(Me(r),{get(i,o){if(typeof o!="string")return i[o];var c=o.charAt(o.length-1);if(c==="$")if(o.endsWith("$$")){var u=o.slice(0,-2);return e.get$$(Zi(t+"."+u))}else{var d=o.slice(0,-1);return e.get$(Zi(t+"."+d))}else if(c==="_"){var p=o.slice(0,-1);return e.populate(Zi(t+"."+p))}else{var m=i[o];return typeof m=="number"||typeof m=="string"||typeof m=="boolean"?m:jh(e,Zi(t+"."+o))}}});return n})}function Hu(e){return e[e.length-1]}function ub(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function pd(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!ub(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let i=0;i<n.length;i++){const o=n[i];if(lb(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function lb(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const Uh=e=>!!e.queryParams.limit,db=e=>e.queryParams.limit===1,fb=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),hb=e=>e.changeEvent.operation==="DELETE",pb=e=>e.changeEvent.operation==="INSERT",mb=e=>e.changeEvent.operation==="UPDATE",vb=e=>Uh(e)&&e.previousResults.length>=e.queryParams.limit,gb=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let i=0;i<t.length;i++){const o=t[i],c=pd(r,o),u=pd(n,o);if(c!==u)return!0}return!1},yb=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===t)return!0;return!1}},bb=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},wb=e=>{const t=Hu(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},_b=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Sb=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=Hu(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Eb=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},xb=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=Hu(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Cb=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},Ib=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},kb=e=>e.previousResults.length===0,Db={0:pb,1:mb,2:hb,3:Uh,4:db,5:fb,6:kb,7:vb,8:bb,9:wb,10:gb,11:yb,12:_b,13:Sb,14:Eb,15:xb,16:Cb,17:Ib};function Ob(e,t,r,n){var i=e.length,o=i-1,c=0;if(i===0)return e.push(t),0;for(var u;n<=o;)c=n+(o-n>>1),u=e[c],r(u,t)<=0?n=c+1:o=c-1;return r(u,t)<=0&&c++,e.splice(c,0,t),c}const Pb=e=>{},zu=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Wu=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Vu=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Qu=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Rb=e=>{Vu(e),Wu(e)},Lb=e=>{Qu(e),zu(e)},$b=e=>{Vu(e),zu(e)},Ab=e=>{Qu(e),Wu(e)},Kh=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},Tb=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===e.changeEvent.id){n[i]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},Mb=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},Hh=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(i=>i[e.queryParams.primaryKey]===t))return;Ob(e.previousResults,r,e.queryParams.sortComparator,0)},Nb=e=>{Kh(e),Hh(e)},Bb=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},qb=e=>{throw new Error("Action unknownAction should never be called")},Fb=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],jb={doNothing:Pb,insertFirst:zu,insertLast:Wu,removeFirstItem:Vu,removeLastItem:Qu,removeFirstInsertLast:Rb,removeLastInsertFirst:Lb,removeFirstInsertFirst:$b,removeLastInsertLast:Ab,removeExisting:Kh,replaceExisting:Tb,alwaysWrong:Mb,insertAtSortPosition:Hh,removeExistingAndInsertAtSortPosition:Nb,runFullQueryAgain:Bb,unknownAction:qb},Ub=40;function Dc(e){return e.charCodeAt(0)-Ub}function Kb(e){return e?"1":"0"}function md(e,t){const r=[];for(let n=0,i=e.length;n<i;n+=t)r.push(e.substring(n,n+t));return r}function Hb(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,i=e.substring(2,n),o=md(i,2);for(let O=0;O<o.length;O++){const T=o[O],B=T.charAt(0),j=Dc(T.charAt(1));t.set(B,j)}const c=e.substring(n,e.length-3),u=md(c,4);for(let O=0;O<u.length;O++){const T=u[O],B=T.charAt(0),j=T.charAt(1),G=T.charAt(2),ce=Dc(T.charAt(3));if(!t.has(j))throw new Error("missing node with id "+j);if(!t.has(G))throw new Error("missing node with id "+G);const ae=t.get(j),Z=t.get(G),ne={l:ce,0:ae,1:Z};t.set(B,ne)}const d=e.slice(-3),p=d.charAt(0),m=d.charAt(1),g=Dc(d.charAt(2)),S=t.get(p),_=t.get(m);return{l:g,0:S,1:_}}function zb(e,t,r){let n=e,i=e.l;for(;;){const o=t[i](r),c=Kb(o);if(n=n[c],typeof n=="number"||typeof n=="string")return n;i=n.l}}const Wb="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9Â¡bf9Â¢bq9Â£cg9Â¤ck9Â¥cn9Â¦nd9Â§np9Â¨nq9Â©nf9Âªng9Â«nm9Â¬nk9Â­mr9Â®ms9Â¯mt9Â°mj9Â±mk9Â²ml9Â³mn9Â´mc8ÂµÂ³{8Â¶Â¯}8Â·Â°Â¤8Â¸Â³Â§8Â¹mn8ÂºÂ³Â«8Â»Â³m8Â¼mÂ´4Â½zÂ²4Â¾Â³w4Â¿zÂµ4Ã€Â¯Â¶4ÃÂ°Â·4Ã‚Â³Âº4ÃƒÂ³Â¸4Ã„mÂ¹4Ã…vÂ¤7Ã†yn7Ã‡Ã€Ã7Ãˆ~7Ã‰Â¥Â¤7ÃŠÃƒÃ„7Ã‹Â¨n7ÃŒÂºÂ¹7ÃÂ­Â°7ÃŽÂ®m7ÃÂ¯Â°7ÃÂ±m7Ã‘Â³m7Ã’Â¼m5Ã“Ã„m5Ã”Â¹m5Ã•Â½Â°5Ã–Â¾m5Ã—Â¿Â°5Ã˜Ã‡Ã5Ã™Ã‚m5ÃšÃŠÃ‘5Ã›Â±m5ÃœÂºm5ÃÃŒÃ‘5ÃžÃ•Ã2ÃŸ|2Ã Â¡u2Ã¡Â£Ã…2Ã¢Ã–ÃŽ2Ã£Â¦Ã†2Ã¤Â©x2Ã¥ÂªÃ†2Ã¦Ã—Ã˜2Ã§|Ãˆ2Ã¨Â¡Â¢2Ã©Â£Ã‰2ÃªÂ¤Â¥2Ã«Ã™Ãš2Ã¬Â¦Ã‹2Ã­Â©n2Ã®Âªn2Ã¯Ã›Ã2Ã°ÃœÃ2Ã±Â¬n2Ã²Ã’Ã“/Ã³an/Ã´bn/Ãµcn/Ã¶ÃžÃ¢/Ã·ÃŸÃ£/Ã¸Ã Ã¤/Ã¹Ã¡Ã¥/ÃºÃ¦Ã«/Ã»Ã§Ã¬/Ã¼Ã¨Ã­/Ã½Ã©Ã®/Ã¾ÃÃŽ/Ã¿ÃÃ‘/Ä€Ã²Ã”,Äcn,Ä‚Ã¶Ã¯,ÄƒÂ¤Ã±,Ä„ÃºÃ°,Ä…ÃªÃ±,Ä†Ã¾Ã,Ä‡Ã¿Ã‘,Äˆac0Ä‰bc0ÄŠÃ³Ãµ0Ä‹Ã´Ä0ÄŒÃŸÃ¡0ÄÃ Â¤0ÄŽÃ§Ã©0ÄÃ¨Ãª0ÄÃ·Ã¹0Ä‘Ã¸Äƒ0Ä’Ã»Ã½0Ä“Ã¼Ä…0Ä”mÃ’-Ä•mÄ€-Ä–ÃžÃ¦-Ä—ÄŒÄŽ-Ä˜ÄÄ-Ä™Ä‚Ä„-ÄšÄÄ’-Ä›Ä‘Ä“-ÄœÂ²Â»-ÄÃÃ-ÄžÄ†Ä‡-ÄŸÂ²Â³-Ä Ä”Äˆ3Ä¡Ä•ÄŠ3Ä¢Ä–Ä—3Ä£Ä™Äš3Ä¤Ä¢Ä(Ä¥ÄœÄŸ(Ä¦Ä£Äž(Ä§Ä Ä¡+Ä¨Ä‰Ä‹+Ä©Ä¤Ä¦+ÄªÄ˜Ä›+Ä«Ä§Ä¨1Ä¬Ä©Äª1Ä­Ä¬Ä«*Ä®Ä¥m*Ä­Ä®.";let Oc;function Vb(){return Oc||(Oc=Hb(Wb)),Oc}const Qb=e=>zb(Vb(),Db,e);function Gb(e){const t=Qb(e);return Fb[t]}function Yb(e,t,r,n,i){const o=jb[e];return o({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:i}),n}function Jb(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var Xb=new WeakMap;function Zb(e){return Ut(Xb,e,()=>{var t=e.collection,r=Zn(t.storageInstance.schema,ut(e.mangoQuery)),n=t.schema.primaryPath,i=Th(t.schema.jsonSchema,r),o=(p,m)=>{var g={docA:p,docB:m};return i(g.docA,g.docB)},c=Uu(t.schema.jsonSchema,r),u=p=>{var m={doc:p};return c(m.doc)},d={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:Jb(n,r),sortComparator:o,queryMatcher:u};return d})}function ew(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=Zb(e),n=le(e._result).docsData.slice(0),i=le(e._result).docsDataMap,o=!1,c=[],u=0;u<t.length;u++){var d=t[u],p=Vg(d);p&&c.push(p)}var m=c.find(g=>{var S={queryParams:r,changeEvent:g,previousResults:n,keyDocumentMap:i},_=Gb(S);if(_==="runFullQueryAgain")return!0;if(_!=="doNothing")return o=!0,Yb(_,r,g,n,i),!1});return m?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:o,newResults:n}}var tw=function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var i=n.toString(),o=Ut(this._map,i,()=>n);return o},e}();function rw(){return new tw}function vd(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function nw(e){return e.refCount$.observers.length}var iw=100,aw=30*1e3,ow=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var i=St()-t,o=[],c=Array.from(n._map.values());for(var u of c)if(!(nw(u)>0)){if(u._lastEnsureEqual===0&&u._creationTime<i){vd(n,u);continue}o.push(u)}var d=o.length-e;if(!(d<=0)){var p=o.sort((g,S)=>g._lastEnsureEqual-S._lastEnsureEqual),m=p.slice(0,d);m.forEach(g=>vd(n,g))}}},zh=ow(iw,aw),Pc=new WeakSet;function sw(e){Pc.has(e)||(Pc.add(e),xv().then(()=>Dv(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),Pc.delete(e)}))}var Wh=function(){function e(r,n,i){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(o=>{var c=o.docId,u=this.cacheItemByDocId.get(c);u&&(u[0].delete(o.revisionHeight),u[0].size===0&&this.cacheItemByDocId.delete(c))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=i,n.subscribe(o=>{this.tasks.add(()=>{for(var c=this.cacheItemByDocId,u=0;u<o.length;u++){var d=o[u],p=c.get(d.documentId);if(p){var m=d.documentData;m||(m=d.previousDocumentData),p[1]=m}}}),this.tasks.size<=1&&bs().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var i=_i(this.cacheItemByDocId,n);return i[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var i=this.cacheItemByDocId.get(n);if(i)return i[1]},Vr(e,[{key:"getCachedRxDocuments",get:function(){var r=gd(this);return hr(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=gd(this);return hr(this,"getCachedRxDocument",n=>r([n])[0])}}])}();function gd(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,i=Se.deepFreezeWhenDevMode,o=e.documentCreator,c=u=>{for(var d=new Array(u.length),p=[],m=0;m<u.length;m++){var g=u[m],S=g[t],_=zr(g._rev),E=void 0,O=void 0,T=r.get(S);T?(E=T[0],O=E.get(_)):(E=new Map,T=[E,g],r.set(S,T));var B=O?O.deref():void 0;B||(g=i(g),B=o(g),E.set(_,uw(B)),n&&p.push(B)),d[m]=B}return p.length>0&&n&&(e.tasks.add(()=>{for(var j=0;j<p.length;j++){var G=p[j];n.register(G,{docId:G.primary,revisionHeight:zr(G.revision)})}}),e.tasks.size<=1&&bs().then(()=>{e.processTasks()})),d};return c}function cu(e,t){var r=e.getCachedRxDocuments;return r(t)}var cw=typeof WeakRef=="function",uw=cw?lw:dw;function lw(e){return new WeakRef(e)}function dw(e){return{deref(){return e}}}var yd=function(){function e(r,n,i){this.time=St(),this.query=r,this.count=i,this.documents=cu(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var i=this.query.op;if(i==="count")return this.count;if(i==="findOne"){var o=this.documents.length===0?null:this.documents[0];if(!o&&n)throw X("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:i});return o}else return i==="findByIds"?this.docsMap:this.documents.slice(0)},Vr(e,[{key:"docsData",get:function(){return hr(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),hr(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,i=0;i<n.length;i++){var o=n[i];r.set(o.primary,o)}return hr(this,"docsMap",r)}}])}(),fw=0,hw=function(){return++fw},Vh=function(){function e(r,n,i,o={}){this.id=hw(),this._execOverDatabaseCount=0,this._creationTime=St(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new Ar(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=wr,this.op=r,this.mangoQuery=n,this.collection=i,this.other=o,n||(this.mangoQuery=Po()),this.isFindOneByIdQuery=gw(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw X("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new yd(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var i=new yd(this,n,n.length);this._result=i},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var n=this.getPreparedQuery(),i=await this.collection.storageInstance.count(n);if(i.mode==="slow"&&!this.collection.database.allowSlowCount)throw X("QU14",{collection:this.collection,queryObj:this.mangoQuery});return i.count}if(this.op==="findByIds"){var o=le(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,c=new Map,u=[];if(o.forEach(m=>{var g=this.collection._docCache.getLatestDocumentDataIfExists(m);if(g){if(!g._deleted){var S=this.collection._docCache.getCachedRxDocument(g);c.set(m,S)}}else u.push(m)}),u.length>0){var d=await this.collection.storageInstance.findDocumentsById(u,!1);d.forEach(m=>{var g=this.collection._docCache.getCachedRxDocument(m);c.set(g.primary,g)})}return c}var p=vw(this);return p.then(m=>m)},t.exec=async function(n){if(n&&this.op!=="findOne")throw X("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await bd(this);var i=le(this._result);return i.getValue(n)},t.toString=function(){var n=zo({op:this.op,query:Zn(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),i=JSON.stringify(n);return this.toString=()=>i,i},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:Zn(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),ft("prePrepareQuery",n);var i=Cs(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>i,i},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=async function(){var n=await this.exec();if(Array.isArray(n)){var i=await this.collection.bulkRemove(n);if(i.error.length>0)throw kf(i.error[0]);return i.success}else return n.remove()},t.incrementalRemove=function(){return Un(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw Ie("update")},t.patch=function(n){return Un(this.asRxQuery,i=>i.patch(n))},t.incrementalPatch=function(n){return Un(this.asRxQuery,i=>i.incrementalPatch(n))},t.modify=function(n){return Un(this.asRxQuery,i=>i.modify(n))},t.incrementalModify=function(n){return Un(this.asRxQuery,i=>i.incrementalModify(n))},t.where=function(n){throw Ie("query-builder")},t.sort=function(n){throw Ie("query-builder")},t.skip=function(n){throw Ie("query-builder")},t.limit=function(n){throw Ie("query-builder")},Vr(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(ke(n=>!n.isLocal),Fa(null),Sr(()=>bd(this)),Ue(()=>this._result),qa(Aa),ya((n,i)=>!!(n&&n.time===le(i).time)),ke(n=>!!n),Ue(n=>le(n).getValue()));this._$=Gg(r,this.refCount$.pipe(ke(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=Zn(this.collection.schema.jsonSchema,this.mangoQuery);return hr(this,"queryMatcher",Uu(r,n))}},{key:"asRxQuery",get:function(){return this}}])}();function Po(){return{selector:{}}}function pw(e){return e.collection._queryCache.getByQuery(e)}function Kn(e,t,r,n){ft("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var i=new Vh(e,t,r,n);return i=pw(i),sw(r),i}function Qh(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function bd(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.closed||Qh(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>mw(e)),e._ensureEqualQueue)}function mw(e){if(e._lastEnsureEqual=St(),e.collection.database.closed||Qh(e))return wr;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var i=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var o=le(e._result).count,c=o;i.forEach(d=>{var p=d.previousDocumentData&&e.doesDocumentDataMatch(d.previousDocumentData),m=e.doesDocumentDataMatch(d.documentData);!p&&m&&c++,p&&!m&&c--}),c!==o&&(t=!0,e._setResultData(c))}else{var u=ew(e,i);u.runFullQueryAgain?r=!0:u.changed&&(t=!0,e._setResultData(u.newResults))}}}return r?e._execOverDatabase().then(d=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof d=="number"?((!e._result||d!==e._result.count)&&(t=!0,e._setResultData(d)),t):((!e._result||!Sv(e.collection.schema.primaryPath,d,e._result.docsData))&&(t=!0,e._setResultData(d)),t))):Promise.resolve(t)}async function vw(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(m=>{var g=e.collection._docCache.getLatestDocumentDataIfExists(m);return g?(g._deleted||t.push(g),!1):!0}),n.length>0){var i=await r.storageInstance.findDocumentsById(n,!1);Cn(t,i)}}else{var o=e.isFindOneByIdQuery,c=e.collection._docCache.getLatestDocumentDataIfExists(o);if(!c){var u=await r.storageInstance.findDocumentsById([o],!1);u[0]&&(c=u[0])}c&&!c._deleted&&t.push(c)}else{var d=e.getPreparedQuery(),p=await r.storageInstance.query(d);t=p.documents}return t}function gw(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var bn="collection",Gu="storage-token",Ro="rx-migration-status",yw="rx-pipeline-checkpoint",bw="RxInternalDocument",Yu=_s({version:0,title:bw,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[bn,Gu,Ro,yw,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function Di(e,t){return Pn(Yu,{key:e,context:t})}async function Gh(e){var t=Cs(e.schema,{selector:{context:bn,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var Yh="storageToken",ww=Di(Yh,Gu);async function _w(e){var t=$a(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:ww,context:Gu,key:Yh,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:Ri(),_rev:jt(),_attachments:{}},i=[{document:n}],o=await e.internalStore.bulkWrite(i,"internal-add-storage-token");if(!o.error[0])return Nt("id",i,o)[0];var c=le(o.error[0]);if(c.isError&&ws(c)){var u=c;if(!Sw(u.documentInDb.data.rxdbVersion,e.rxdbVersion))throw X("DM5",{args:{database:e.name,databaseStateVersion:u.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==u.documentInDb.data.passwordHash)throw X("DB1",{passwordHash:r,existingPasswordHash:u.documentInDb.data.passwordHash});var d=u.documentInDb;return le(d)}throw c}function Sw(e,t){if(!e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r==="15"&&n==="16"?!0:r===n}async function Ew(e,t,r){if(e.schema.version!==r.version)throw X("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=uu(e.name,e.schema.jsonSchema),i=Di(n,bn);;){var o=await Ka(e.database.internalStore,i),c=ut(le(o)),u=c.data.connectedStorages.find(d=>d.collectionName===t&&d.schema.version===r.version);if(u)return;c.data.connectedStorages.push({collectionName:t,schema:r});try{await Ia(e.database.internalStore,{previous:le(o),document:c},"add-connected-storage-to-collection")}catch(d){if(!ws(d))throw d}}}function uu(e,t){return e+"-"+t.version}function So(e,t){return t=Me(t),t=Wv(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=jv(e.primaryPath,e.jsonSchema,t)),t._meta=Ri(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=jt()),t}async function xw(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function Jh(e,t,r,n,i,o,c,u){var d=await Gh(t),p=d.filter(_=>_.data.name===i),m=[];p.forEach(_=>{m.push({collectionName:_.data.name,schema:_.data.schema,isCollection:!0}),_.data.connectedStorages.forEach(E=>m.push({collectionName:E.collectionName,isCollection:!1,schema:E.schema}))});var g=new Set;if(m=m.filter(_=>{var E=_.collectionName+"||"+_.schema.version;return g.has(E)?!1:(g.add(E),!0)}),await Promise.all(m.map(async _=>{var E=await e.createStorageInstance({collectionName:_.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:o,options:{},schema:_.schema,password:c,devMode:Se.isDevMode()});await E.remove(),_.isCollection&&await Ta("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:i})})),u){var S=p.map(_=>{var E=Ha(_);return E._deleted=!0,E._meta.lwt=St(),E._rev=br(r,_),{previous:_,document:E}});await t.bulkWrite(S,"rx-database-remove-collection-all")}}function Dt(e){if(e.closed)throw X("COL21",{collection:e.name,version:e.schema.version})}var Cw=function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(ke(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&bs().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t._handleChangeEvents=function(n){var i=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(Cn(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var o=i+1,c=this.eventCounterMap,u=0;u<n.length;u++){var d=n[u];c.set(d,o+u)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var i=this.buffer[0],o=this.eventCounterMap.get(i);if(n<o)return null;var c=n-o;return c},t.getFrom=function(n){this.processTasks();var i=[],o=this.getArrayIndexByPointer(n);if(o===null)return null;for(;;){var c=this.buffer[o];if(o++,c)i.push(c);else return i}},t.runFrom=function(n,i){this.processTasks();var o=this.getFrom(n);if(o===null)throw new Error("out of bounds");o.forEach(c=>i(c))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.close=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e}();function Iw(e){return new Cw(e)}var kw=new WeakMap;function Dw(e){var t=e.schema.getDocumentPrototype(),r=Rw(e),n=Is,i={};return[t,r,n].forEach(o=>{var c=Object.getOwnPropertyNames(o);c.forEach(u=>{var d=Object.getOwnPropertyDescriptor(o,u),p=!0;(u.startsWith("_")||u.endsWith("_")||u.startsWith("$")||u.endsWith("$"))&&(p=!1),typeof d.value=="function"?Object.defineProperty(i,u,{get(){return d.value.bind(this)},enumerable:p,configurable:!1}):(d.enumerable=p,d.configurable=!1,d.writable&&(d.writable=!1),Object.defineProperty(i,u,d))})}),i}function Ow(e){return Ut(kw,e,()=>qh(Dw(e)))}function Pw(e,t,r){var n=cb(t,e,Se.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),ft("postCreateRxDocument",n),n}function Rw(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}var Go={isEqual(e,t){return ma(Zt(e),Zt(t))},resolve(e){return e.realMasterState}},Xh=["pre","post"],Zh=["insert","save","remove","create"],wd=!1,Hn=new Set,ep=function(){function e(r,n,i,o,c={},u={},d={},p={},m={},g=zh,S={},_=Go){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=rw(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=i,this.internalStorageInstance=o,this.instanceCreationOptions=c,this.migrationStrategies=u,this.methods=d,this.attachments=p,this.options=m,this.cacheReplacementPolicy=g,this.statics=S,this.conflictHandler=_,Lw(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(ke(E=>E.collectionName===this.name))),this.database&&Hn.add(this)}var t=e.prototype;return t.prepare=async function(){if(!await Ef()){for(var n=0;n<10&&Hn.size>Gl;)n++,await this.promiseWait(30);if(Hn.size>Gl)throw X("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(Hn.values()).map(d=>({db:d.database?d.database.name:"",c:d.name}))}})}this.storageInstance=Ku(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new Bh(this.storageInstance,this.schema.primaryPath,(d,p)=>Fh(this,d,p),d=>this._runHooks("post","save",d)),this.$=this.eventBulks$.pipe(Sr(d=>Yf(d))),this.checkpoint$=this.eventBulks$.pipe(Ue(d=>d.checkpoint)),this._changeEventBuffer=Iw(this.asRxCollection);var i;this._docCache=new Wh(this.schema.primaryPath,this.eventBulks$.pipe(ke(d=>!d.isLocal),Ue(d=>d.events)),d=>(i||(i=Ow(this.asRxCollection)),Pw(this.asRxCollection,i,d)));var o=this.database.internalStore.changeStream().pipe(ke(d=>{var p=this.name+"-"+this.schema.version,m=d.events.find(g=>g.documentData.context==="collection"&&g.documentData.key===p&&g.operation==="DELETE");return!!m})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(d=>d()))});this._subs.push(o);var c=await this.database.storageToken,u=this.storageInstance.changeStream().subscribe(d=>{var p={id:d.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:c,events:d.events,databaseToken:this.database.token,checkpoint:d.checkpoint,context:d.context};this.database.$emit(p)});return this._subs.push(u),Rt},t.cleanup=function(n){throw Dt(this),Ie("cleanup")},t.migrationNeeded=function(){throw Ie("migration-schema")},t.getMigrationState=function(){throw Ie("migration-schema")},t.startMigration=function(n=10){return Dt(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){Dt(this);var i=await this.bulkInsert([n]),o=i.error[0];Qo(this,n[this.schema.primaryPath],n,o);var c=le(i.success[0]);return c},t.insertIfNotExists=async function(n){var i=await this.bulkInsert([n]);if(i.error.length>0){var o=i.error[0];if(o.status===409){var c=o.documentInDb;return cu(this._docCache,[c])[0]}else throw o}return i.success[0]},t.bulkInsert=async function(n){if(Dt(this),n.length===0)return{success:[],error:[]};var i=this.schema.primaryPath,o=new Set,c;if(this.hasHooks("pre","insert"))c=await Promise.all(n.map(T=>{var B=So(this.schema,T);return this._runHooks("pre","insert",B).then(()=>(o.add(B[i]),{document:B}))}));else{c=new Array(n.length);for(var u=this.schema,d=0;d<n.length;d++){var p=n[d],m=So(u,p);o.add(m[i]),c[d]={document:m}}}if(o.size!==n.length)throw X("COL22",{collection:this.name,args:{documents:n}});var g=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-insert"),S,_=this,E={get success(){if(!S){var T=Nt(_.schema.primaryPath,c,g);S=cu(_._docCache,T)}return S},error:g.error};if(this.hasHooks("post","insert")){var O=new Map;c.forEach(T=>{var B=T.document;O.set(B[i],B)}),await Promise.all(E.success.map(T=>this._runHooks("post","insert",O.get(T.primary),T)))}return E},t.bulkRemove=async function(n){Dt(this);var i=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var o;typeof n[0]=="string"?o=await this.findByIds(n).exec():(o=new Map,n.forEach(_=>o.set(_.primary,_)));var c=[],u=new Map;Array.from(o.values()).forEach(_=>{var E=_.toMutableJSON(!0);c.push(E),u.set(_.primary,E)}),await Promise.all(c.map(_=>{var E=_[this.schema.primaryPath];return this._runHooks("pre","remove",_,o.get(E))}));var d=c.map(_=>{var E=Me(_);return E._deleted=!0,{previous:_,document:E}}),p=await this.storageInstance.bulkWrite(d,"rx-collection-bulk-remove"),m=Nt(this.schema.primaryPath,d,p),g=[],S=m.map(_=>{var E=_[i],O=this._docCache.getCachedRxDocument(_);return g.push(O),E});return await Promise.all(S.map(_=>this._runHooks("post","remove",u.get(_),o.get(_)))),{success:g,error:p.error}},t.bulkUpsert=async function(n){Dt(this);var i=[],o=new Map;n.forEach(p=>{var m=So(this.schema,p),g=m[this.schema.primaryPath];if(!g)throw X("COL3",{primaryPath:this.schema.primaryPath,data:m,schema:this.schema.jsonSchema});o.set(g,m),i.push(m)});var c=await this.bulkInsert(i),u=c.success.slice(0),d=[];return await Promise.all(c.error.map(async p=>{if(p.status!==409)d.push(p);else{var m=p.documentId,g=_i(o,m),S=le(p.documentInDb),_=this._docCache.getCachedRxDocuments([S])[0],E=await _.incrementalModify(()=>g);u.push(E)}})),{error:d,success:u}},t.upsert=async function(n){Dt(this);var i=await this.bulkUpsert([n]);return Qo(this.asRxCollection,n[this.schema.primaryPath],n,i.error[0]),i.success[0]},t.incrementalUpsert=function(n){Dt(this);var i=So(this.schema,n),o=i[this.schema.primaryPath];if(!o)throw X("COL4",{data:n});var c=this._incrementalUpsertQueues.get(o);return c||(c=Rt),c=c.then(()=>Aw(this,o,i)).then(u=>u.inserted?u.doc:$w(u.doc,i)),this._incrementalUpsertQueues.set(o,c),c},t.find=function(n){Dt(this),ft("prePrepareRxQuery",{op:"find",queryObj:n,collection:this}),n||(n=Po());var i=Kn("find",n,this);return i},t.findOne=function(n){Dt(this),ft("prePrepareRxQuery",{op:"findOne",queryObj:n,collection:this});var i;if(typeof n=="string")i=Kn("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=Po()),n.limit)throw X("QU6");n=Me(n),n.limit=1,i=Kn("findOne",n,this)}return i},t.count=function(n){Dt(this),n||(n=Po());var i=Kn("count",n,this);return i},t.findByIds=function(n){Dt(this);var i={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},o=Kn("findByIds",i,this);return o},t.exportJSON=function(){throw Ie("json-dump")},t.importJSON=function(n){throw Ie("json-dump")},t.insertCRDT=function(n){throw Ie("crdt")},t.addPipeline=function(n){throw Ie("pipeline")},t.addHook=function(n,i,o,c=!1){if(typeof o!="function")throw Ot("COL7",{key:i,when:n});if(!Xh.includes(n))throw Ot("COL8",{key:i,when:n});if(!Zh.includes(i))throw X("COL9",{key:i});if(n==="post"&&i==="create"&&c===!0)throw X("COL10",{when:n,key:i,parallel:c});var u=o.bind(this),d=c?"parallel":"series";this.hooks[i]=this.hooks[i]||{},this.hooks[i][n]=this.hooks[i][n]||{series:[],parallel:[]},this.hooks[i][n][d].push(u)},t.getHooks=function(n,i){return!this.hooks[i]||!this.hooks[i][n]?{series:[],parallel:[]}:this.hooks[i][n]},t.hasHooks=function(n,i){if(!this.hooks[i]||!this.hooks[i][n])return!1;var o=this.getHooks(n,i);return o?o.series.length>0||o.parallel.length>0:!1},t._runHooks=function(n,i,o,c){var u=this.getHooks(n,i);if(!u)return Rt;var d=u.series.map(p=>()=>p(o,c));return Ov(d).then(()=>Promise.all(u.parallel.map(p=>p(o,c))))},t._runHooksSync=function(n,i,o,c){if(this.hasHooks(n,i)){var u=this.getHooks(n,i);u&&u.series.forEach(d=>d(o,c))}},t.promiseWait=function(n){var i=new Promise(o=>{var c=setTimeout(()=>{this.timeouts.delete(c),o()},n);this.timeouts.add(c)});return i},t.close=async function(){return this.closed?wr:(Hn.delete(this),await Promise.all(this.onClose.map(n=>n())),this.closed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],Ta("postCloseRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(n=>n())),await Jh(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},Vr(e,[{key:"insert$",get:function(){return this.$.pipe(ke(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(ke(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(ke(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])}();function Lw(e){if(!wd){wd=!0;var t=Object.getPrototypeOf(e);Zh.forEach(r=>{Xh.map(n=>{var i=n+yf(r);t[i]=function(o,c){return this.addHook(n,r,o,c)}})})}}function $w(e,t){return e.incrementalModify(r=>t)}function Aw(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(i=>i?{doc:i,inserted:!1}:e.insert(r).then(o=>({doc:o,inserted:!0})))}function Tw({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:i={},autoMigrate:o=!0,statics:c={},methods:u={},attachments:d={},options:p={},localDocuments:m=!1,cacheReplacementPolicy:g=zh,conflictHandler:S=Go}){var _={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:Se.isDevMode()};return ft("preCreateRxStorageInstance",_),xw(e,_).then(E=>{var O=new ep(e,t,r,E,n,i,u,d,p,g,c,S);return O.prepare().then(()=>{Object.entries(c).forEach(([B,j])=>{Object.defineProperty(O,B,{get:()=>j.bind(O)})});var T=Rt;return o&&O.schema.version!==0&&(T=O.migratePromise()),T}).then(()=>(ft("createRxCollection",{collection:O,creator:{name:t,schema:r,storageInstance:E,instanceCreationOptions:n,migrationStrategies:i,methods:u,attachments:d,options:p,cacheReplacementPolicy:g,localDocuments:m,statics:c}}),O)).catch(T=>(Hn.delete(O),E.close().then(()=>Promise.reject(T))))})}var tp=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};tp.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,lu(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(i){throw this.unlock(),i}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(i){return r.unlock(),i}).catch(function(i){throw r.unlock(),i})},requestIdlePromise:function(t){var r=this;t=t||{};var n,i=new Promise(function(u){return n=u}),o=function(){Rc(r,i),n()};if(i._manRes=o,t.timeout){var c=setTimeout(function(){i._manRes()},t.timeout);i._timeoutObj=c}return this._iC.add(i),lu(this),i},cancelIdlePromise:function(t){Rc(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,i=this.requestIdlePromise(r);return this._hPM.set(n,i),this._pHM.set(i,n),i.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return Rc(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function Mw(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return lu(e)},0)}}function Rc(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function lu(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}Mw(e),e._tryIR=!1},0)},0))}class Ju{constructor(t){st(this,"ttl");st(this,"map",new Map);st(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,rp()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Nw(this)},0))}clear(){this.map.clear()}}function Nw(e){const t=rp()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const i=n[0];if(n[1]<t)e.map.delete(i);else return}}function rp(){return Date.now()}var du=new Set,_d=new Map,Xu=function(){function e(r,n,i,o,c,u,d=!1,p={},m,g,S,_,E,O){this.idleQueue=new tp,this.rxdbVersion=Sf,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new Lt,this.closePromise=null,this.observable$=this.eventBulks$.pipe(Sr(T=>Yf(T))),this.storageToken=wr,this.storageTokenDocument=wr,this.emittedEventBulkIds=new Ju(60*1e3),this.name=r,this.token=n,this.storage=i,this.instanceCreationOptions=o,this.password=c,this.multiInstance=u,this.eventReduce=d,this.options=p,this.internalStore=m,this.hashFunction=g,this.cleanupPolicy=S,this.allowSlowCount=_,this.reactivity=E,this.onClosed=O,this.name!=="pseudoInstance"&&(this.internalStore=Ku(this.asRxDatabase,m,Yu),this.storageTokenDocument=_w(this.asRxDatabase).catch(T=>this.startupErrors.push(T)),this.storageToken=this.storageTokenDocument.then(T=>T.data.token).catch(T=>this.startupErrors.push(T)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw X("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,i){var o=await Ka(this.internalStore,Di(uu(n,i),bn));if(!o)throw X("SNH",{name:n,schema:i});var c=Ha(o);c._deleted=!0,await this.internalStore.bulkWrite([{document:c,previous:o}],"rx-database-remove-collection")},t.addCollections=async function(n){var i={},o={},c=[],u={};await Promise.all(Object.entries(n).map(async([m,g])=>{var S=m,_=g.schema;i[S]=_;var E=Gv(_,this.hashFunction);if(o[S]=E,this.collections[m])throw X("DB3",{name:m});var O=uu(m,_),T={id:Di(O,bn),key:O,context:bn,data:{name:S,schemaHash:await E.hash,schema:E.jsonSchema,version:E.version,connectedStorages:[]},_deleted:!1,_meta:Ri(),_rev:jt(),_attachments:{}};c.push({document:T});var B=Object.assign({},g,{name:S,schema:E,database:this}),j=Me(g);j.database=this,j.name=m,ft("preCreateRxCollection",j),B.conflictHandler=j.conflictHandler,u[S]=B}));var d=await this.internalStore.bulkWrite(c,"rx-database-add-collection");await Uw(this),await Promise.all(d.error.map(async m=>{if(m.status!==409)throw X("DB12",{database:this.name,writeError:m});var g=le(m.documentInDb),S=g.data.name,_=o[S];if(g.data.schemaHash!==await _.hash)throw X("DB6",{database:this.name,collection:S,previousSchemaHash:g.data.schemaHash,schemaHash:await _.hash,previousSchema:g.data.schema,schema:le(i[S])})}));var p={};return await Promise.all(Object.keys(n).map(async m=>{var g=u[m],S=await Tw(g);p[m]=S,this.collections[m]=S,this[m]||Object.defineProperty(this,m,{get:()=>this.collections[m]})})),p},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw Ie("json-dump")},t.addState=function(n){throw Ie("state")},t.importJSON=function(n){throw Ie("json-dump")},t.backup=function(n){throw Ie("backup")},t.leaderElector=function(){throw Ie("leader-election")},t.isLeader=function(){throw Ie("leader-election")},t.waitForLeadership=function(){throw Ie("leader-election")},t.migrationStates=function(){throw Ie("migration-schema")},t.close=function(){if(this.closePromise)return this.closePromise;var{promise:n,resolve:i}=np(),o=c=>{this.onClosed&&this.onClosed(),this.closed=!0,i(c)};return this.closePromise=n,(async()=>{if(await Ta("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(c=>c.unsubscribe()),this.name==="pseudoInstance"){o(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(c=>c()))).then(()=>Promise.all(Object.keys(this.collections).map(c=>this.collections[c]).map(c=>c.close()))).then(()=>this.internalStore.close()).then(()=>o(!0))})(),n},t.remove=function(){return this.close().then(()=>Fw(this.name,this.storage,this.multiInstance,this.password))},Vr(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])}();function Bw(e,t){if(du.has(ip(e,t)))throw X("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function np(){var e,t,r=new Promise((n,i)=>{e=n,t=i});return{promise:r,resolve:e,reject:t}}function ip(e,t){return t.name+"|"+e}async function ap(e,t,r,n,i,o){var c=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:Zy,schema:Yu,options:n,multiInstance:i,password:o,devMode:Se.isDevMode()});return c}function qw({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i=!0,eventReduce:o=!0,ignoreDuplicate:c=!1,options:u={},cleanupPolicy:d,closeDuplicates:p=!1,allowSlowCount:m=!1,localDocuments:g=!1,hashFunction:S=gf,reactivity:_}){ft("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:u,localDocuments:g});var E=ip(r,e),O=_d.get(E)||new Set,T=np(),B=Array.from(O),j=()=>{O.delete(T.promise),du.delete(E)};return O.add(T.promise),_d.set(E,O),(async()=>{if(p&&await Promise.all(B.map(Z=>Z.catch(()=>null).then(ne=>ne&&ne.close()))),c){if(!Se.isDevMode())throw X("DB9",{database:r})}else Bw(r,e);du.add(E);var G=$a(10),ce=await ap(G,e,r,t,i,n),ae=new Xu(r,G,e,t,n,i,o,u,ce,S,d,m,_,j);return await Ta("createRxDatabase",{database:ae,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:u,localDocuments:g}}),ae})().then(G=>{T.resolve(G)}).catch(G=>{T.reject(G),j()}),T.promise}async function Fw(e,t,r=!0,n){var i=$a(10),o=await ap(i,t,e,{},r,n),c=await Gh(o),u=new Set;c.forEach(p=>u.add(p.data.name));var d=Array.from(u);return await Promise.all(d.map(p=>Jh(t,o,i,e,p,r,n))),await Ta("postRemoveRxDatabase",{databaseName:e,storage:t}),await o.remove(),d}function jw(e){return e instanceof Xu}async function Uw(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var Kw={RxSchema:Of.prototype,RxDocument:Is,RxQuery:Vh.prototype,RxCollection:ep.prototype,RxDatabase:Xu.prototype},Lc=new Set,Sd=new Set;function Lo(e){if(ft("preAddRxPlugin",{plugin:e,plugins:Lc}),!Lc.has(e)){{if(Sd.has(e.name))throw X("PL3",{name:e.name,plugin:e});Lc.add(e),Sd.add(e.name)}if(!e.rxdb)throw Ot("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(Kw[t])),e.overwritable&&Object.assign(Se,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&ga[t].push(r.after),r.before&&ga[t].unshift(r.before)})}}async function Yo(e,t){var r=Pn(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),i=n[0];if(e.lastCheckpointDoc[t]=i,i)return i.checkpointData}async function Jo(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var i={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:Ri(),_rev:jt()};for(i.id=Pn(e.input.metaInstance.schema,i);!e.events.canceled.getValue();){if(n&&(i.checkpointData=ka([n.checkpointData,i.checkpointData])),i._meta.lwt=St(),i._rev=br(await e.checkpointKey,n),e.events.canceled.getValue())return;var o=[{previous:n,document:i}],c=await e.input.metaInstance.bulkWrite(o,"replication-set-checkpoint"),u=Nt(e.primaryPath,o,c)[0];if(u){e.lastCheckpointDoc[t]=u;return}else{var d=c.error[0];if(d.status!==409)throw d;n=le(d.documentInDb),i._rev=br(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function Hw(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function Ed(e,t,r,n,i){var o=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},i?i._meta:{},{lwt:St()}),_rev:r?n._rev:jt()});return o._rev||(o._rev=br(e,i)),o}function Tr(e,t,r){var n=Me(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function fu(e,t){return e.hasAttachments?t.map(r=>{var n=ut(r.document);return n.docData=Zt(n.docData),{document:n,previous:r.previous}}):t}function hu(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var $o="RxReplicationProtocolMetaData";function xd(e,t){var r=Uv(e),n={title:$o,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var i=_s(n);return i}function op(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=Pn(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(i=>{n[i.itemId]={docData:i.docData,metaDocument:i}}),n})}async function Xo(e,t,r,n){var i=t[e.primaryPath],o=r?Ha(r):{id:"",isCheckpoint:"0",itemId:i,docData:t,_attachments:{},_deleted:!1,_rev:jt(),_meta:{lwt:0}};o.docData=t,n&&(o.isResolvedConflict=n),o._meta.lwt=St(),o.id=Pn(e.input.metaInstance.schema,o),o._rev=br(await e.checkpointKey,r);var c={previous:r,document:o};return c}async function zw(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await Yo(e,"down");t||await Jo(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,i=0,o=[];function c(E){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var O={time:i++,task:E};o.push(O),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var T=[];o.length>0;){e.events.active.down.next(!0);var B=le(o.shift());if(!(B.time<d)){if(B.task==="RESYNC")if(T.length===0){T.push(B.task);break}else break;T.push(B.task)}}if(T.length!==0)return T[0]==="RESYNC"?p():m(T)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(c("RESYNC"),!e.events.canceled.getValue()){var u=n.masterChangeStream$.pipe(Sr(async E=>(await yn(e.events.active.up.pipe(ke(O=>!O))),E))).subscribe(E=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,c(E)});yn(e.events.canceled.pipe(ke(E=>!!E))).then(()=>u.unsubscribe())}var d=-1;async function p(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Yo(e,"down"));for(var E=await e.checkpointQueue,O=[];!e.events.canceled.getValue();){d=i++;var T=await n.masterChangesSince(E,e.input.pullBatchSize);if(T.documents.length===0||(E=ka([E,T.checkpoint]),O.push(_(T.documents,E)),T.documents.length<e.input.pullBatchSize))break}await Promise.all(O)}}function m(E){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var O=[],T=null;return E.forEach(B=>{if(B==="RESYNC")throw new Error("SNH");Cn(O,B.documents),T=ka([T,B.checkpoint])}),_(O,le(T))}var g=Rt,S={docs:{}};function _(E,O){var T=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,E.forEach(B=>{var j=B[T];S.docs[j]=B}),S.checkpoint=O,g=g.then(()=>{var B=S.docs;S.docs={};var j=S.checkpoint,G=Object.keys(B);if(e.events.canceled.getValue()||G.length===0)return Rt;var ce=[],ae={},Z={},ne=[];return Promise.all([e.input.forkInstance.findDocumentsById(G,!0),op(e,G)]).then(([he,ye])=>{var xe=new Map;return he.forEach(Pe=>xe.set(Pe[T],Pe)),Promise.all(G.map(async Pe=>{var J=xe.get(Pe),be=J?Tr(J,e.hasAttachments,!1):void 0,Ce=B[Pe],De=ye[Pe];De&&J&&De.metaDocument.isResolvedConflict===J._rev&&await e.streamQueue.up;var tt=!De||!be?!1:e.input.conflictHandler.isEqual(De.docData,be,"downstream-check-if-equal-0");if(!tt&&De&&De.docData._rev&&J&&J._meta[e.input.identifier]&&zr(J._rev)===J._meta[e.input.identifier]&&(tt=!0),J&&De&&tt===!1||J&&!De)return Rt;var rr=be?e.input.conflictHandler.isEqual(Ce,be,"downstream-check-if-equal-1"):!1;if(be&&rr)return(!De||tt===!1)&&ne.push(await Xo(e,be,De?De.metaDocument:void 0)),Rt;var Ne=Object.assign({},Ce,J?{_meta:Me(J._meta),_attachments:e.hasAttachments&&Ce._attachments?Ce._attachments:{},_rev:jt()}:{_meta:{lwt:St()},_rev:jt(),_attachments:e.hasAttachments&&Ce._attachments?Ce._attachments:{}});if(Ce._rev){var at=J?zr(J._rev)+1:1;Ne._meta[e.input.identifier]=at,e.input.keepMeta&&(Ne._rev=Ce._rev)}e.input.keepMeta&&Ce._meta&&(Ne._meta=Ce._meta);var oe={previous:J,document:Ne};oe.document._rev=oe.document._rev?oe.document._rev:br(r,oe.previous),ce.push(oe),ae[Pe]=oe,Z[Pe]=await Xo(e,Ce,De?De.metaDocument:void 0)}))}).then(async()=>{if(ce.length>0)return e.input.forkInstance.bulkWrite(ce,await e.downstreamBulkWriteFlag).then(he=>{var ye=Nt(e.primaryPath,ce,he);ye.forEach(Pe=>{var J=Pe[T];e.events.processed.down.next(ae[J]),ne.push(Z[J])});var xe;if(he.error.forEach(Pe=>{if(Pe.status!==409){var J=X("RC_PULL",{writeError:Pe});e.events.error.next(J),xe=J}}),xe)throw xe})}).then(()=>{if(ne.length>0)return e.input.metaInstance.bulkWrite(fu(e,ne),"replication-down-write-meta").then(he=>{he.error.forEach(ye=>{e.events.error.next(X("RC_PULL",{id:ye.documentId,writeError:ye}))})})}).then(()=>{Jo(e,"down",j)})}).catch(B=>e.events.error.next(B)),g}}async function Ww(e,t,r){var n=e.input.conflictHandler,i=n.isEqual(t.realMasterState,t.newDocumentState,"replication-resolve-conflict");if(!i){var o=await n.resolve(t,"replication-resolve-conflict"),c=Object.assign({},o,{_meta:Me(r._meta),_rev:jt(),_attachments:Me(r._attachments)});return c._meta.lwt=St(),c._rev=br(await e.checkpointKey,r),c}}async function pu(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var i=r[e],o=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([c,u])=>{if((!o.has(c)||n&&le(n._attachments)[c].digest!==u.digest)&&!u.data){var d=await t.getAttachmentData(i,c,u.digest);u.data=d}})),r}async function Vw(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await Yo(e,"up");t||await Jo(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>m().then(()=>g()));var n=0,i=-1,o=[],c=wr,u={docs:{}},d=e.input.forkInstance.changeStream().subscribe(_=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,o.push({task:_,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>g()):g()}),p=r.masterChangeStream$.pipe(ke(_=>_==="RESYNC")).subscribe(()=>{o.push({task:"RESYNC",time:n++}),g()});yn(e.events.canceled.pipe(ke(_=>!!_))).then(()=>{d.unsubscribe(),p.unsubscribe()});async function m(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Yo(e,"up"));for(var _=await e.checkpointQueue,E=new Set,O=async function(){i=n++,E.size>3&&await Promise.race(Array.from(E));var j=await Mh(e.input.forkInstance,e.input.pushBatchSize,_);if(j.documents.length===0)return 1;_=ka([_,j.checkpoint]);var G=S(j.documents,le(_));E.add(G),G.catch().then(()=>E.delete(G))};!e.events.canceled.getValue()&&!await O(););var T=await Promise.all(E),B=T.find(j=>!!j);B?await m():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function g(){if(e.events.canceled.getValue()||o.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var _=[],E={};o.length>0;){var O=le(o.shift());if(!(O.time<i)){if(O.task==="RESYNC"){e.events.active.up.next(!1),await m();return}O.task.context!==await e.downstreamBulkWriteFlag&&Cn(_,O.task.events.map(T=>T.documentData)),E=ka([E,O.task.checkpoint])}}if(await S(_,E),o.length===0)e.events.active.up.next(!1);else return g()})}function S(_,E){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,_.forEach(O=>{var T=O[e.primaryPath];u.docs[T]=O}),u.checkpoint=E,c=c.then(async()=>{if(e.events.canceled.getValue())return!1;var O=u.docs;u.docs={};var T=u.checkpoint,B=Object.keys(O);function j(){return Jo(e,"up",T)}if(B.length===0)return j(),!1;var G=await op(e,B),ce={},ae=[],Z={},ne={};if(await Promise.all(B.map(async oe=>{var $e=O[oe];ne[oe]=$e;var Je=Tr($e,e.hasAttachments,!!e.input.keepMeta),me=G[oe];me&&me.metaDocument.isResolvedConflict!==$e._rev&&e.input.conflictHandler.isEqual(me.docData,Je,"upstream-check-if-equal")||me&&me.docData._rev&&zr($e._rev)===$e._meta[e.input.identifier]||(ae.push(oe),ce[oe]={assumedMasterState:me?me.docData:void 0,newDocumentState:Je},Z[oe]=await Xo(e,Je,me?me.metaDocument:void 0))})),ae.length===0)return j(),!1;var he=Object.values(ce),ye=new Set,xe={},Pe=gv(he,e.input.pushBatchSize);await Promise.all(Pe.map(async oe=>{e.hasAttachments&&await Promise.all(oe.map(async Je=>{Je.newDocumentState=await pu(e.primaryPath,e.input.forkInstance,ut(Je.newDocumentState),Je.assumedMasterState)}));var $e=await r.masterWrite(oe);$e.forEach(Je=>{var me=Je[e.primaryPath];ye.add(me),xe[me]=Je})}));var J=[];if(ae.forEach(oe=>{ye.has(oe)||(e.events.processed.up.next(ce[oe]),J.push(Z[oe]))}),e.events.canceled.getValue())return!1;J.length>0&&await e.input.metaInstance.bulkWrite(fu(e,J),"replication-up-write-meta");var be=!1;if(ye.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var Ce=[],De={};if(await Promise.all(Object.entries(xe).map(([oe,$e])=>{var Je=ce[oe],me={newDocumentState:Je.newDocumentState,assumedMasterState:Je.assumedMasterState,realMasterState:$e};return Ww(e,me,ne[oe]).then(async ze=>{if(ze){e.events.resolvedConflicts.next({input:me,output:ze}),Ce.push({previous:ne[oe],document:ze});var It=G[oe];De[oe]=await Xo(e,le($e),It?It.metaDocument:void 0,ze._rev)}})})),Ce.length>0){be=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var tt=await e.input.forkInstance.bulkWrite(Ce,"replication-up-write-conflict"),rr;if(tt.error.forEach(oe=>{if(oe.status!==409){var $e=X("RC_PUSH",{writeError:oe});e.events.error.next($e),rr=$e}}),rr)throw rr;var Ne=[],at=Nt(e.primaryPath,Ce,tt);at.forEach(oe=>{var $e=oe[e.primaryPath];Ne.push(De[$e])}),Ne.length>0&&await e.input.metaInstance.bulkWrite(fu(e,Ne),"replication-up-write-conflict-meta")}}return j(),be}).catch(O=>(e.events.error.next(O),!1)),c}}function Qw(e){e=Me(e),e.forkInstance=hu(e.forkInstance),e.metaInstance=hu(e.metaInstance);var t=Hw(e),r={primaryPath:Et(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new Ar(!1),paused:new Ar(!1),active:{down:new Ar(!0),up:new Ar(!0)},processed:{down:new Lt,up:new Lt},resolvedConflicts:new Lt,error:new Lt},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new Ar(!1),up:new Ar(!1)},streamQueue:{down:Rt,up:Rt},checkpointQueue:Rt,lastCheckpointDoc:{}};return zw(r),Vw(r),r}function Gw(e){return yn(Ag([e.firstSyncDone.down.pipe(ke(t=>!!t)),e.firstSyncDone.up.pipe(ke(t=>!!t))])).then(()=>{})}function Yw(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function Jw(e,t,r,n=!1){e=hu(e);var i=!!e.schema.attachments,o=Et(e.schema.primaryKey),c={masterChangeStream$:e.changeStream().pipe(Sr(async u=>{var d={checkpoint:u.checkpoint,documents:await Promise.all(u.events.map(async p=>{var m=Tr(p.documentData,i,n);return i&&(m=await pu(o,e,ut(m),void 0)),m}))};return d})),masterChangesSince(u,d){return Mh(e,d,u).then(async p=>({checkpoint:p.documents.length>0?p.checkpoint:u,documents:await Promise.all(p.documents.map(async m=>{var g=Tr(m,i,n);return i&&(g=await pu(o,e,ut(g),void 0)),g}))}))},async masterWrite(u){var d={};u.forEach(O=>{var T=O.newDocumentState[o];d[T]=O});var p=Object.keys(d),m=await e.findDocumentsById(p,!0),g=new Map;m.forEach(O=>g.set(O[o],O));var S=[],_=[];if(await Promise.all(Object.entries(d).map(([O,T])=>{var B=g.get(O);B?B&&!T.assumedMasterState?S.push(Tr(B,i,n)):t.isEqual(Tr(B,i,n),le(T.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?_.push({previous:B,document:Ed(r,i,n,T.newDocumentState,B)}):S.push(Tr(B,i,n)):_.push({document:Ed(r,i,n,T.newDocumentState)})})),_.length>0){var E=await e.bulkWrite(_,"replication-master-write");E.error.forEach(O=>{if(O.status!==409)throw X("SNH",{name:"non conflict error",error:O});S.push(Tr(le(O.documentInDb),i,n))})}return S}};return c}async function Xw(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}function Zw(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var e0=Promise.resolve(!0),mr=Promise.resolve();function ln(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function t0(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function za(){return Math.random().toString(36).substring(2)}var $c=0;function Wa(){var e=Date.now()*1e3;return e<=$c&&(e=$c+1),$c=e,e}function r0(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var n0=Wa,i0="native";function a0(e){var t={time:Wa(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function o0(e){e.bc.close(),e.subFns=[]}function s0(e,t){try{return e.bc.postMessage(t,!1),mr}catch(r){return Promise.reject(r)}}function c0(e,t){e.messagesCallback=t}function u0(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function l0(){return 150}var d0={create:a0,close:o0,onMessage:c0,postMessage:s0,canBeUsed:u0,type:i0,averageResponseTime:l0,microSeconds:n0};function Zu(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var f0=Wa,h0="pubkey.broadcast-channel-0-",Er="messages",ks={durability:"relaxed"},p0="idb";function sp(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function el(e){e.commit&&e.commit()}function m0(e){var t=sp(),r=h0+e,n=t.open(r);return n.onupgradeneeded=function(i){var o=i.target.result;o.createObjectStore(Er,{keyPath:"id",autoIncrement:!0})},new Promise(function(i,o){n.onerror=function(c){return o(c)},n.onsuccess=function(){i(n.result)}})}function v0(e,t,r){var n=Date.now(),i={uuid:t,time:n,data:r},o=e.transaction([Er],"readwrite",ks);return new Promise(function(c,u){o.oncomplete=function(){return c()},o.onerror=function(p){return u(p)};var d=o.objectStore(Er);d.add(i),el(o)})}function g0(e,t){var r=e.transaction(Er,"readonly",ks),n=r.objectStore(Er),i=[],o=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var c=n.getAll(o);return new Promise(function(d,p){c.onerror=function(m){return p(m)},c.onsuccess=function(m){d(m.target.result)}})}function u(){try{return o=IDBKeyRange.bound(t+1,1/0),n.openCursor(o)}catch{return n.openCursor()}}return new Promise(function(d,p){var m=u();m.onerror=function(g){return p(g)},m.onsuccess=function(g){var S=g.target.result;S?S.value.id<t+1?S.continue(t+1):(i.push(S.value),S.continue()):(el(r),d(i))}})}function y0(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(Er,"readwrite",ks),n=r.objectStore(Er);return Promise.all(t.map(function(i){var o=n.delete(i);return new Promise(function(c){o.onsuccess=function(){return c()}})}))}function b0(e,t){var r=Date.now()-t,n=e.transaction(Er,"readonly",ks),i=n.objectStore(Er),o=[];return new Promise(function(c){i.openCursor().onsuccess=function(u){var d=u.target.result;if(d){var p=d.value;p.time<r?(o.push(p),d.continue()):(el(n),c(o))}else c(o)}})}function w0(e){return b0(e.db,e.options.idb.ttl).then(function(t){return y0(e,t.map(function(r){return r.id}))})}function _0(e,t){return t=Zu(t),m0(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:za(),eMIs:new Ju(t.idb.ttl*2),writeBlockPromise:mr,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},cp(n),n})}function cp(e){e.closed||up(e).then(function(){return ln(e.options.idb.fallbackInterval)}).then(function(){return cp(e)})}function S0(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function up(e){return e.closed||!e.messagesCallback?mr:g0(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return S0(n,e)}).sort(function(n,i){return n.time-i.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),mr})}function E0(e){e.closed=!0,e.db.close()}function x0(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return v0(e.db,e.uuid,t)}).then(function(){t0(0,10)===0&&w0(e)}),e.writeBlockPromise}function C0(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,up(e)}function I0(){return!!sp()}function k0(e){return e.idb.fallbackInterval*2}var D0={create:_0,close:E0,onMessage:C0,postMessage:x0,canBeUsed:I0,type:p0,averageResponseTime:k0,microSeconds:f0},O0=Wa,P0="pubkey.broadcastChannel-",R0="localstorage";function lp(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function dp(e){return P0+e}function L0(e,t){return new Promise(function(r){ln().then(function(){var n=dp(e.channelName),i={token:za(),time:Date.now(),data:t,uuid:e.uuid},o=JSON.stringify(i);lp().setItem(n,o);var c=document.createEvent("Event");c.initEvent("storage",!0,!0),c.key=n,c.newValue=o,window.dispatchEvent(c),r()})})}function $0(e,t){var r=dp(e),n=function(o){o.key===r&&t(JSON.parse(o.newValue))};return window.addEventListener("storage",n),n}function A0(e){window.removeEventListener("storage",e)}function T0(e,t){if(t=Zu(t),!fp())throw new Error("BroadcastChannel: localstorage cannot be used");var r=za(),n=new Ju(t.localstorage.removeTimeout),i={channelName:e,uuid:r,eMIs:n};return i.listener=$0(e,function(o){i.messagesCallback&&o.uuid!==r&&(!o.token||n.has(o.token)||o.data.time&&o.data.time<i.messagesCallbackTime||(n.add(o.token),i.messagesCallback(o.data)))}),i}function M0(e){A0(e.listener)}function N0(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function fp(){var e=lp();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function B0(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var q0={create:T0,close:M0,onMessage:N0,postMessage:L0,canBeUsed:fp,type:R0,averageResponseTime:B0,microSeconds:O0},hp=Wa,F0="simulate",tl=new Set;function j0(e){var t={time:hp(),name:e,messagesCallback:null};return tl.add(t),t}function U0(e){tl.delete(e)}var pp=5;function K0(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(tl);n.forEach(function(i){i.name===e.name&&i!==e&&i.messagesCallback&&i.time<t.time&&i.messagesCallback(t)}),r()},pp)})}function H0(e,t){e.messagesCallback=t}function z0(){return!0}function W0(){return pp}var V0={create:j0,close:U0,onMessage:H0,postMessage:K0,canBeUsed:z0,type:F0,averageResponseTime:W0,microSeconds:hp},Cd=[d0,D0,q0];function Q0(e){var t=[].concat(e.methods,Cd).filter(Boolean);if(e.type){if(e.type==="simulate")return V0;var r=t.find(function(i){return i.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(i){return i.type!=="idb"}));var n=t.find(function(i){return i.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(Cd.map(function(i){return i.type})))}var mp=new Set,G0=0,Ds=function(t,r){this.id=G0++,mp.add(this),this.name=t,this.options=Zu(r),this.method=Q0(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,Y0(this)};Ds._pubkey=!0;Ds.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return Id(this,"message",t)},postInternal:function(t){return Id(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};Dd(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,kd(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),i={time:n,fn:r};kd(this,t,i)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(i){return i.fn===r});Dd(this,t,n)},close:function(){var t=this;if(!this.closed){mp.delete(this),this.closed=!0;var r=this._prepP?this._prepP:mr;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function Id(e,t,r){var n=e.method.microSeconds(),i={time:n,type:t,data:r},o=e._prepP?e._prepP:mr;return o.then(function(){var c=e.method.postMessage(e._state,i);return e._uMP.add(c),c.catch().then(function(){return e._uMP.delete(c)}),c})}function Y0(e){var t=e.method.create(e.name,e.options);Zw(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function vp(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function kd(e,t,r){e._addEL[t].push(r),J0(e)}function Dd(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),X0(e)}function J0(e){if(!e._iL&&vp(e)){var t=function(i){e._addEL[i.type].forEach(function(o){i.time>=o.time&&o.fn(i.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function X0(e){if(e._iL&&!vp(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function Z0(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function e_(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var t_=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",r_=t_?e_:Z0,ia=new Set,Od=!1;function n_(){Od||(Od=!0,r_(a_))}function i_(e){if(n_(),typeof e!="function")throw new Error("Listener is no function");ia.add(e);var t={remove:function(){return ia.delete(e)},run:function(){return ia.delete(e),e()}};return t}function a_(){var e=[];return ia.forEach(function(t){e.push(t()),ia.delete(t)}),Promise.all(e)}function wn(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function gp(e){e.isLeader=!0,e._hasLeader=!0;var t=i_(function(){return e.die()});e._unl.push(t);var r=function(i){i.context==="leader"&&i.action==="apply"&&wn(e,"tell"),i.context==="leader"&&i.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),wn(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),wn(e,"tell")}var yp=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=za(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};yp.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(i){return i.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,i){t._wKMC.res=n,t._wKMC.rej=i});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,gp(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),wn(this,"death")}};var bp=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=za(),this._aplQ=mr,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=function(c){c.context==="leader"&&(c.action==="death"&&(n._hasLeader=!1),c.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};bp.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return ln(0,!0);if(this.isDead)return ln(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return e0;var o=!1,c,u=new Promise(function(m){c=function(){o=!0,m()}}),d=function(g){g.context==="leader"&&g.token!=r.token&&(g.action==="apply"&&g.token>r.token&&c(),g.action==="tell"&&(c(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",d);var p=t?r._options.responseTime*4:r._options.responseTime;return wn(r,"apply").then(function(){return Promise.race([ln(p),u.then(function(){return Promise.reject(new Error)})])}).then(function(){return wn(r,"apply")}).then(function(){return Promise.race([ln(p),u.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",d),o?!1:gp(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=o_(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,wn(this,"death")}};function o_(e){return e.isLeader?mr:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",o),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var i=function(){return ln(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():i()})})};i();var o=function(u){u.context==="leader"&&u.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)})}function s_(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function c_(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=s_(t,e);var r=r0()?new yp(e,t):new bp(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var Zo=new Map;function u_(e,t,r,n){var i=Zo.get(t);return i||(i={bc:new Ds(["RxDB:",e,r].join("|")),refs:new Set},Zo.set(t,i)),i.refs.add(n),i.bc}function Pd(e,t){var r=Zo.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return Zo.delete(e),r.bc.close()}function l_(e,t,r,n){if(t.multiInstance){var i=u_(e,t.databaseInstanceToken,r.databaseName,r),o=new Lt,c=S=>{S.storageName===e&&S.databaseName===t.databaseName&&S.collectionName===t.collectionName&&S.version===t.schema.version&&o.next(S.eventBulk)};i.addEventListener("message",c);var u=r.changeStream(),d=!1,p=u.subscribe(S=>{d||i.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:S})});r.changeStream=function(){return o.asObservable().pipe(Kg(u))};var m=r.close.bind(r);r.close=async function(){return d=!0,p.unsubscribe(),i.removeEventListener("message",c),await Pd(t.databaseInstanceToken,r),m()};var g=r.remove.bind(r);r.remove=async function(){return d=!0,p.unsubscribe(),i.removeEventListener("message",c),await Pd(t.databaseInstanceToken,r),g()}}}var d_=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function f_(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ao={exports:{}},h_=Ao.exports,Rd;function p_(){return Rd||(Rd=1,function(e,t){(function(r,n){e.exports=n()})(h_,function(){var r=function(a,s){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,f){l.__proto__=f}||function(l,f){for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(l[h]=f[h])})(a,s)},n=function(){return(n=Object.assign||function(a){for(var s,l=1,f=arguments.length;l<f;l++)for(var h in s=arguments[l])Object.prototype.hasOwnProperty.call(s,h)&&(a[h]=s[h]);return a}).apply(this,arguments)};function i(a,s,l){for(var f,h=0,v=s.length;h<v;h++)!f&&h in s||((f=f||Array.prototype.slice.call(s,0,h))[h]=s[h]);return a.concat(f||Array.prototype.slice.call(s))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:d_,c=Object.keys,u=Array.isArray;function d(a,s){return typeof s!="object"||c(s).forEach(function(l){a[l]=s[l]}),a}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var p=Object.getPrototypeOf,m={}.hasOwnProperty;function g(a,s){return m.call(a,s)}function S(a,s){typeof s=="function"&&(s=s(p(a))),(typeof Reflect>"u"?c:Reflect.ownKeys)(s).forEach(function(l){E(a,l,s[l])})}var _=Object.defineProperty;function E(a,s,l,f){_(a,s,d(l&&g(l,"get")&&typeof l.get=="function"?{get:l.get,set:l.set,configurable:!0}:{value:l,configurable:!0,writable:!0},f))}function O(a){return{from:function(s){return a.prototype=Object.create(s.prototype),E(a.prototype,"constructor",a),{extend:S.bind(null,a.prototype)}}}}var T=Object.getOwnPropertyDescriptor,B=[].slice;function j(a,s,l){return B.call(a,s,l)}function G(a,s){return s(a)}function ce(a){if(!a)throw new Error("Assertion Failed")}function ae(a){o.setImmediate?setImmediate(a):setTimeout(a,0)}function Z(a,s){if(typeof s=="string"&&g(a,s))return a[s];if(!s)return a;if(typeof s!="string"){for(var l=[],f=0,h=s.length;f<h;++f){var v=Z(a,s[f]);l.push(v)}return l}var y=s.indexOf(".");if(y!==-1){var b=a[s.substr(0,y)];return b==null?void 0:Z(b,s.substr(y+1))}}function ne(a,s,l){if(a&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof s!="string"&&"length"in s){ce(typeof l!="string"&&"length"in l);for(var f=0,h=s.length;f<h;++f)ne(a,s[f],l[f])}else{var v,y,b=s.indexOf(".");b!==-1?(v=s.substr(0,b),(y=s.substr(b+1))===""?l===void 0?u(a)&&!isNaN(parseInt(v))?a.splice(v,1):delete a[v]:a[v]=l:ne(b=!(b=a[v])||!g(a,v)?a[v]={}:b,y,l)):l===void 0?u(a)&&!isNaN(parseInt(s))?a.splice(s,1):delete a[s]:a[s]=l}}function he(a){var s,l={};for(s in a)g(a,s)&&(l[s]=a[s]);return l}var ye=[].concat;function xe(a){return ye.apply([],a)}var ir="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(xe([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(s){return s+a+"Array"})}))).filter(function(a){return o[a]}),Pe=new Set(ir.map(function(a){return o[a]})),J=null;function be(a){return J=new WeakMap,a=function s(l){if(!l||typeof l!="object")return l;var f=J.get(l);if(f)return f;if(u(l)){f=[],J.set(l,f);for(var h=0,v=l.length;h<v;++h)f.push(s(l[h]))}else if(Pe.has(l.constructor))f=l;else{var y,b=p(l);for(y in f=b===Object.prototype?{}:Object.create(b),J.set(l,f),l)g(l,y)&&(f[y]=s(l[y]))}return f}(a),J=null,a}var Ce={}.toString;function De(a){return Ce.call(a).slice(8,-1)}var tt=typeof Symbol<"u"?Symbol.iterator:"@@iterator",rr=typeof tt=="symbol"?function(a){var s;return a!=null&&(s=a[tt])&&s.apply(a)}:function(){return null};function Ne(a,s){return s=a.indexOf(s),0<=s&&a.splice(s,1),0<=s}var at={};function oe(a){var s,l,f,h;if(arguments.length===1){if(u(a))return a.slice();if(this===at&&typeof a=="string")return[a];if(h=rr(a)){for(l=[];!(f=h.next()).done;)l.push(f.value);return l}if(a==null)return[a];if(typeof(s=a.length)!="number")return[a];for(l=new Array(s);s--;)l[s]=a[s];return l}for(s=arguments.length,l=new Array(s);s--;)l[s]=arguments[s];return l}var $e=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Bi=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],kt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Bi),Je={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function me(a,s){this.name=a,this.message=s}function ze(a,s){return a+". Errors: "+Object.keys(s).map(function(l){return s[l].toString()}).filter(function(l,f,h){return h.indexOf(l)===f}).join(`
`)}function It(a,s,l,f){this.failures=s,this.failedKeys=f,this.successCount=l,this.message=ze(a,s)}function Ir(a,s){this.name="BulkError",this.failures=Object.keys(s).map(function(l){return s[l]}),this.failuresByPos=s,this.message=ze(a,this.failures)}O(me).from(Error).extend({toString:function(){return this.name+": "+this.message}}),O(It).from(me),O(Ir).from(me);var As=kt.reduce(function(a,s){return a[s]=s+"Error",a},{}),Up=me,ie=kt.reduce(function(a,s){var l=s+"Error";function f(h,v){this.name=l,h?typeof h=="string"?(this.message="".concat(h).concat(v?`
 `+v:""),this.inner=v||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=Je[s]||l,this.inner=null)}return O(f).from(Up),a[s]=f,a},{});ie.Syntax=SyntaxError,ie.Type=TypeError,ie.Range=RangeError;var sl=Bi.reduce(function(a,s){return a[s+"Error"]=ie[s],a},{}),Va=kt.reduce(function(a,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(a[s+"Error"]=ie[s]),a},{});function _e(){}function Mi(a){return a}function Kp(a,s){return a==null||a===Mi?s:function(l){return s(a(l))}}function Yr(a,s){return function(){a.apply(this,arguments),s.apply(this,arguments)}}function Hp(a,s){return a===_e?s:function(){var l=a.apply(this,arguments);l!==void 0&&(arguments[0]=l);var f=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var v=s.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?Yr(f,this.onsuccess):f),h&&(this.onerror=this.onerror?Yr(h,this.onerror):h),v!==void 0?v:l}}function zp(a,s){return a===_e?s:function(){a.apply(this,arguments);var l=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?Yr(l,this.onsuccess):l),f&&(this.onerror=this.onerror?Yr(f,this.onerror):f)}}function Wp(a,s){return a===_e?s:function(l){var f=a.apply(this,arguments);d(l,f);var h=this.onsuccess,v=this.onerror;return this.onsuccess=null,this.onerror=null,l=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?Yr(h,this.onsuccess):h),v&&(this.onerror=this.onerror?Yr(v,this.onerror):v),f===void 0?l===void 0?void 0:l:d(f,l)}}function Vp(a,s){return a===_e?s:function(){return s.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function Ts(a,s){return a===_e?s:function(){var l=a.apply(this,arguments);if(l&&typeof l.then=="function"){for(var f=this,h=arguments.length,v=new Array(h);h--;)v[h]=arguments[h];return l.then(function(){return s.apply(f,v)})}return s.apply(this,arguments)}}Va.ModifyError=It,Va.DexieError=me,Va.BulkError=Ir;var Vt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function cl(a){Vt=a}var Ni={},ul=100,ir=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,p(a),a];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,p(s),a]}(),Bi=ir[0],kt=ir[1],ir=ir[2],kt=kt&&kt.then,Jr=Bi&&Bi.constructor,Ms=!!ir,qi=function(a,s){Fi.push([a,s]),Qa&&(queueMicrotask(Gp),Qa=!1)},Ns=!0,Qa=!0,Xr=[],Ga=[],Bs=Mi,kr={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:_e,pgp:!1,env:{},finalize:_e},te=kr,Fi=[],Zr=0,Ya=[];function V(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=te;if(typeof a!="function"){if(a!==Ni)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Fs(this,this._value))}this._state=null,this._value=null,++s.ref,function l(f,h){try{h(function(v){if(f._state===null){if(v===f)throw new TypeError("A promise cannot be resolved with itself.");var y=f._lib&&$n();v&&typeof v.then=="function"?l(f,function(b,x){v instanceof V?v._then(b,x):v.then(b,x)}):(f._state=!0,f._value=v,dl(f)),y&&An()}},Fs.bind(null,f))}catch(v){Fs(f,v)}}(this,a)}var qs={get:function(){var a=te,s=eo;function l(f,h){var v=this,y=!a.global&&(a!==te||s!==eo),b=y&&!Or(),x=new V(function(I,P){js(v,new ll(hl(f,a,y,b),hl(h,a,y,b),I,P,a))});return this._consoleTask&&(x._consoleTask=this._consoleTask),x}return l.prototype=Ni,l},set:function(a){E(this,"then",a&&a.prototype===Ni?qs:{get:function(){return a},set:qs.set})}};function ll(a,s,l,f,h){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof s=="function"?s:null,this.resolve=l,this.reject=f,this.psd=h}function Fs(a,s){var l,f;Ga.push(s),a._state===null&&(l=a._lib&&$n(),s=Bs(s),a._state=!1,a._value=s,f=a,Xr.some(function(h){return h._value===f._value})||Xr.push(f),dl(a),l&&An())}function dl(a){var s=a._listeners;a._listeners=[];for(var l=0,f=s.length;l<f;++l)js(a,s[l]);var h=a._PSD;--h.ref||h.finalize(),Zr===0&&(++Zr,qi(function(){--Zr==0&&Us()},[]))}function js(a,s){if(a._state!==null){var l=a._state?s.onFulfilled:s.onRejected;if(l===null)return(a._state?s.resolve:s.reject)(a._value);++s.psd.ref,++Zr,qi(Qp,[l,a,s])}else a._listeners.push(s)}function Qp(a,s,l){try{var f,h=s._value;!s._state&&Ga.length&&(Ga=[]),f=Vt&&s._consoleTask?s._consoleTask.run(function(){return a(h)}):a(h),s._state||Ga.indexOf(h)!==-1||function(v){for(var y=Xr.length;y;)if(Xr[--y]._value===v._value)return Xr.splice(y,1)}(s),l.resolve(f)}catch(v){l.reject(v)}finally{--Zr==0&&Us(),--l.psd.ref||l.psd.finalize()}}function Gp(){en(kr,function(){$n()&&An()})}function $n(){var a=Ns;return Qa=Ns=!1,a}function An(){var a,s,l;do for(;0<Fi.length;)for(a=Fi,Fi=[],l=a.length,s=0;s<l;++s){var f=a[s];f[0].apply(null,f[1])}while(0<Fi.length);Qa=Ns=!0}function Us(){var a=Xr;Xr=[],a.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var s=Ya.slice(0),l=s.length;l;)s[--l]()}function Ja(a){return new V(Ni,!1,a)}function Ae(a,s){var l=te;return function(){var f=$n(),h=te;try{return Pr(l,!0),a.apply(this,arguments)}catch(v){s&&s(v)}finally{Pr(h,!1),f&&An()}}}S(V.prototype,{then:qs,_then:function(a,s){js(this,new ll(null,null,a,s,te))},catch:function(a){if(arguments.length===1)return this.then(null,a);var s=a,l=arguments[1];return typeof s=="function"?this.then(null,function(f){return(f instanceof s?l:Ja)(f)}):this.then(null,function(f){return(f&&f.name===s?l:Ja)(f)})},finally:function(a){return this.then(function(s){return V.resolve(a()).then(function(){return s})},function(s){return V.resolve(a()).then(function(){return Ja(s)})})},timeout:function(a,s){var l=this;return a<1/0?new V(function(f,h){var v=setTimeout(function(){return h(new ie.Timeout(s))},a);l.then(f,h).finally(clearTimeout.bind(null,v))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&E(V.prototype,Symbol.toStringTag,"Dexie.Promise"),kr.env=fl(),S(V,{all:function(){var a=oe.apply(null,arguments).map(to);return new V(function(s,l){a.length===0&&s([]);var f=a.length;a.forEach(function(h,v){return V.resolve(h).then(function(y){a[v]=y,--f||s(a)},l)})})},resolve:function(a){return a instanceof V?a:a&&typeof a.then=="function"?new V(function(s,l){a.then(s,l)}):new V(Ni,!0,a)},reject:Ja,race:function(){var a=oe.apply(null,arguments).map(to);return new V(function(s,l){a.map(function(f){return V.resolve(f).then(s,l)})})},PSD:{get:function(){return te},set:function(a){return te=a}},totalEchoes:{get:function(){return eo}},newPSD:Dr,usePSD:en,scheduler:{get:function(){return qi},set:function(a){qi=a}},rejectionMapper:{get:function(){return Bs},set:function(a){Bs=a}},follow:function(a,s){return new V(function(l,f){return Dr(function(h,v){var y=te;y.unhandleds=[],y.onunhandled=v,y.finalize=Yr(function(){var b,x=this;b=function(){x.unhandleds.length===0?h():v(x.unhandleds[0])},Ya.push(function I(){b(),Ya.splice(Ya.indexOf(I),1)}),++Zr,qi(function(){--Zr==0&&Us()},[])},y.finalize),a()},s,l,f)})}}),Jr&&(Jr.allSettled&&E(V,"allSettled",function(){var a=oe.apply(null,arguments).map(to);return new V(function(s){a.length===0&&s([]);var l=a.length,f=new Array(l);a.forEach(function(h,v){return V.resolve(h).then(function(y){return f[v]={status:"fulfilled",value:y}},function(y){return f[v]={status:"rejected",reason:y}}).then(function(){return--l||s(f)})})})}),Jr.any&&typeof AggregateError<"u"&&E(V,"any",function(){var a=oe.apply(null,arguments).map(to);return new V(function(s,l){a.length===0&&l(new AggregateError([]));var f=a.length,h=new Array(f);a.forEach(function(v,y){return V.resolve(v).then(function(b){return s(b)},function(b){h[y]=b,--f||l(new AggregateError(h))})})})}),Jr.withResolvers&&(V.withResolvers=Jr.withResolvers));var We={awaits:0,echoes:0,id:0},Yp=0,Xa=[],Za=0,eo=0,Jp=0;function Dr(a,s,l,f){var h=te,v=Object.create(h);return v.parent=h,v.ref=0,v.global=!1,v.id=++Jp,kr.env,v.env=Ms?{Promise:V,PromiseProp:{value:V,configurable:!0,writable:!0},all:V.all,race:V.race,allSettled:V.allSettled,any:V.any,resolve:V.resolve,reject:V.reject}:{},s&&d(v,s),++h.ref,v.finalize=function(){--this.parent.ref||this.parent.finalize()},f=en(v,a,l,f),v.ref===0&&v.finalize(),f}function Tn(){return We.id||(We.id=++Yp),++We.awaits,We.echoes+=ul,We.id}function Or(){return!!We.awaits&&(--We.awaits==0&&(We.id=0),We.echoes=We.awaits*ul,!0)}function to(a){return We.echoes&&a&&a.constructor===Jr?(Tn(),a.then(function(s){return Or(),s},function(s){return Or(),Be(s)})):a}function Xp(){var a=Xa[Xa.length-1];Xa.pop(),Pr(a,!1)}function Pr(a,s){var l,f=te;(s?!We.echoes||Za++&&a===te:!Za||--Za&&a===te)||queueMicrotask(s?(function(h){++eo,We.echoes&&--We.echoes!=0||(We.echoes=We.awaits=We.id=0),Xa.push(te),Pr(h,!0)}).bind(null,a):Xp),a!==te&&(te=a,f===kr&&(kr.env=fl()),Ms&&(l=kr.env.Promise,s=a.env,(f.global||a.global)&&(Object.defineProperty(o,"Promise",s.PromiseProp),l.all=s.all,l.race=s.race,l.resolve=s.resolve,l.reject=s.reject,s.allSettled&&(l.allSettled=s.allSettled),s.any&&(l.any=s.any))))}function fl(){var a=o.Promise;return Ms?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function en(a,s,l,f,h){var v=te;try{return Pr(a,!0),s(l,f,h)}finally{Pr(v,!1)}}function hl(a,s,l,f){return typeof a!="function"?a:function(){var h=te;l&&Tn(),Pr(s,!0);try{return a.apply(this,arguments)}finally{Pr(h,!1),f&&queueMicrotask(Or)}}}function Ks(a){Promise===Jr&&We.echoes===0?Za===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+kt).indexOf("[native code]")===-1&&(Tn=Or=_e);var Be=V.reject,tn="ï¿¿",nr="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",pl="String expected.",Mn=[],ro="__dbnames",Hs="readonly",zs="readwrite";function rn(a,s){return a?s?function(){return a.apply(this,arguments)&&s.apply(this,arguments)}:a:s}var ml={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function no(a){return typeof a!="string"||/\./.test(a)?function(s){return s}:function(s){return s[a]===void 0&&a in s&&delete(s=be(s))[a],s}}function vl(){throw ie.Type()}function ve(a,s){try{var l=gl(a),f=gl(s);if(l!==f)return l==="Array"?1:f==="Array"?-1:l==="binary"?1:f==="binary"?-1:l==="string"?1:f==="string"?-1:l==="Date"?1:f!=="Date"?NaN:-1;switch(l){case"number":case"Date":case"string":return s<a?1:a<s?-1:0;case"binary":return function(h,v){for(var y=h.length,b=v.length,x=y<b?y:b,I=0;I<x;++I)if(h[I]!==v[I])return h[I]<v[I]?-1:1;return y===b?0:y<b?-1:1}(yl(a),yl(s));case"Array":return function(h,v){for(var y=h.length,b=v.length,x=y<b?y:b,I=0;I<x;++I){var P=ve(h[I],v[I]);if(P!==0)return P}return y===b?0:y<b?-1:1}(a,s)}}catch{}return NaN}function gl(a){var s=typeof a;return s!="object"?s:ArrayBuffer.isView(a)?"binary":(a=De(a),a==="ArrayBuffer"?"binary":a)}function yl(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}var bl=(Re.prototype._trans=function(a,s,l){var f=this._tx||te.trans,h=this.name,v=Vt&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function y(I,P,w){if(!w.schema[h])throw new ie.NotFound("Table "+h+" not part of transaction");return s(w.idbtrans,w)}var b=$n();try{var x=f&&f.db._novip===this.db._novip?f===te.trans?f._promise(a,y,l):Dr(function(){return f._promise(a,y,l)},{trans:f,transless:te.transless||te}):function I(P,w,L,C){if(P.idbdb&&(P._state.openComplete||te.letThrough||P._vip)){var D=P._createTransaction(w,L,P._dbSchema);try{D.create(),P._state.PR1398_maxLoop=3}catch(R){return R.name===As.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return I(P,w,L,C)})):Be(R)}return D._promise(w,function(R,k){return Dr(function(){return te.trans=D,C(R,k,D)})}).then(function(R){if(w==="readwrite")try{D.idbtrans.commit()}catch{}return w==="readonly"?R:D._completion.then(function(){return R})})}if(P._state.openComplete)return Be(new ie.DatabaseClosed(P._state.dbOpenError));if(!P._state.isBeingOpened){if(!P._state.autoOpen)return Be(new ie.DatabaseClosed);P.open().catch(_e)}return P._state.dbReadyPromise.then(function(){return I(P,w,L,C)})}(this.db,a,[this.name],y);return v&&(x._consoleTask=v,x=x.catch(function(I){return console.trace(I),Be(I)})),x}finally{b&&An()}},Re.prototype.get=function(a,s){var l=this;return a&&a.constructor===Object?this.where(a).first(s):a==null?Be(new ie.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return l.core.get({trans:f,key:a}).then(function(h){return l.hook.reading.fire(h)})}).then(s)},Re.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(u(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var s=c(a);if(s.length===1)return this.where(s[0]).equals(a[s[0]]);var l=this.schema.indexes.concat(this.schema.primKey).filter(function(b){if(b.compound&&s.every(function(I){return 0<=b.keyPath.indexOf(I)})){for(var x=0;x<s.length;++x)if(s.indexOf(b.keyPath[x])===-1)return!1;return!0}return!1}).sort(function(b,x){return b.keyPath.length-x.keyPath.length})[0];if(l&&this.db._maxKey!==tn){var v=l.keyPath.slice(0,s.length);return this.where(v).equals(v.map(function(x){return a[x]}))}!l&&Vt&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var f=this.schema.idxByName;function h(b,x){return ve(b,x)===0}var y=s.reduce(function(w,x){var I=w[0],P=w[1],w=f[x],L=a[x];return[I||w,I||!w?rn(P,w&&w.multi?function(C){return C=Z(C,x),u(C)&&C.some(function(D){return h(L,D)})}:function(C){return h(L,Z(C,x))}):P]},[null,null]),v=y[0],y=y[1];return v?this.where(v.name).equals(a[v.keyPath]).filter(y):l?this.filter(y):this.where(s).equals("")},Re.prototype.filter=function(a){return this.toCollection().and(a)},Re.prototype.count=function(a){return this.toCollection().count(a)},Re.prototype.offset=function(a){return this.toCollection().offset(a)},Re.prototype.limit=function(a){return this.toCollection().limit(a)},Re.prototype.each=function(a){return this.toCollection().each(a)},Re.prototype.toArray=function(a){return this.toCollection().toArray(a)},Re.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Re.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,u(a)?"[".concat(a.join("+"),"]"):a))},Re.prototype.reverse=function(){return this.toCollection().reverse()},Re.prototype.mapToClass=function(a){var s,l=this.db,f=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof vl&&(function(x,I){if(typeof I!="function"&&I!==null)throw new TypeError("Class extends value "+String(I)+" is not a constructor or null");function P(){this.constructor=x}r(x,I),x.prototype=I===null?Object.create(I):(P.prototype=I.prototype,new P)}(h,s=a),Object.defineProperty(h.prototype,"db",{get:function(){return l},enumerable:!1,configurable:!0}),h.prototype.table=function(){return f},a=h);for(var v=new Set,y=a.prototype;y;y=p(y))Object.getOwnPropertyNames(y).forEach(function(x){return v.add(x)});function b(x){if(!x)return x;var I,P=Object.create(a.prototype);for(I in x)if(!v.has(I))try{P[I]=x[I]}catch{}return P}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=b,this.hook("reading",b),a},Re.prototype.defineClass=function(){return this.mapToClass(function(a){d(this,a)})},Re.prototype.add=function(a,s){var l=this,f=this.schema.primKey,h=f.auto,v=f.keyPath,y=a;return v&&h&&(y=no(v)(a)),this._trans("readwrite",function(b){return l.core.mutate({trans:b,type:"add",keys:s!=null?[s]:null,values:[y]})}).then(function(b){return b.numFailures?V.reject(b.failures[0]):b.lastResult}).then(function(b){if(v)try{ne(a,v,b)}catch{}return b})},Re.prototype.update=function(a,s){return typeof a!="object"||u(a)?this.where(":id").equals(a).modify(s):(a=Z(a,this.schema.primKey.keyPath),a===void 0?Be(new ie.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(s))},Re.prototype.put=function(a,s){var l=this,f=this.schema.primKey,h=f.auto,v=f.keyPath,y=a;return v&&h&&(y=no(v)(a)),this._trans("readwrite",function(b){return l.core.mutate({trans:b,type:"put",values:[y],keys:s!=null?[s]:null})}).then(function(b){return b.numFailures?V.reject(b.failures[0]):b.lastResult}).then(function(b){if(v)try{ne(a,v,b)}catch{}return b})},Re.prototype.delete=function(a){var s=this;return this._trans("readwrite",function(l){return s.core.mutate({trans:l,type:"delete",keys:[a]})}).then(function(l){return l.numFailures?V.reject(l.failures[0]):void 0})},Re.prototype.clear=function(){var a=this;return this._trans("readwrite",function(s){return a.core.mutate({trans:s,type:"deleteRange",range:ml})}).then(function(s){return s.numFailures?V.reject(s.failures[0]):void 0})},Re.prototype.bulkGet=function(a){var s=this;return this._trans("readonly",function(l){return s.core.getMany({keys:a,trans:l}).then(function(f){return f.map(function(h){return s.hook.reading.fire(h)})})})},Re.prototype.bulkAdd=function(a,s,l){var f=this,h=Array.isArray(s)?s:void 0,v=(l=l||(h?void 0:s))?l.allKeys:void 0;return this._trans("readwrite",function(y){var I=f.schema.primKey,b=I.auto,I=I.keyPath;if(I&&h)throw new ie.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,I=I&&b?a.map(no(I)):a;return f.core.mutate({trans:y,type:"add",keys:h,values:I,wantResults:v}).then(function(D){var w=D.numFailures,L=D.results,C=D.lastResult,D=D.failures;if(w===0)return v?L:C;throw new Ir("".concat(f.name,".bulkAdd(): ").concat(w," of ").concat(x," operations failed"),D)})})},Re.prototype.bulkPut=function(a,s,l){var f=this,h=Array.isArray(s)?s:void 0,v=(l=l||(h?void 0:s))?l.allKeys:void 0;return this._trans("readwrite",function(y){var I=f.schema.primKey,b=I.auto,I=I.keyPath;if(I&&h)throw new ie.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,I=I&&b?a.map(no(I)):a;return f.core.mutate({trans:y,type:"put",keys:h,values:I,wantResults:v}).then(function(D){var w=D.numFailures,L=D.results,C=D.lastResult,D=D.failures;if(w===0)return v?L:C;throw new Ir("".concat(f.name,".bulkPut(): ").concat(w," of ").concat(x," operations failed"),D)})})},Re.prototype.bulkUpdate=function(a){var s=this,l=this.core,f=a.map(function(y){return y.key}),h=a.map(function(y){return y.changes}),v=[];return this._trans("readwrite",function(y){return l.getMany({trans:y,keys:f,cache:"clone"}).then(function(b){var x=[],I=[];a.forEach(function(w,L){var C=w.key,D=w.changes,R=b[L];if(R){for(var k=0,$=Object.keys(D);k<$.length;k++){var A=$[k],M=D[A];if(A===s.schema.primKey.keyPath){if(ve(M,C)!==0)throw new ie.Constraint("Cannot update primary key in bulkUpdate()")}else ne(R,A,M)}v.push(L),x.push(C),I.push(R)}});var P=x.length;return l.mutate({trans:y,type:"put",keys:x,values:I,updates:{keys:f,changeSpecs:h}}).then(function(w){var L=w.numFailures,C=w.failures;if(L===0)return P;for(var D=0,R=Object.keys(C);D<R.length;D++){var k,$=R[D],A=v[Number($)];A!=null&&(k=C[$],delete C[$],C[A]=k)}throw new Ir("".concat(s.name,".bulkUpdate(): ").concat(L," of ").concat(P," operations failed"),C)})})})},Re.prototype.bulkDelete=function(a){var s=this,l=a.length;return this._trans("readwrite",function(f){return s.core.mutate({trans:f,type:"delete",keys:a})}).then(function(y){var h=y.numFailures,v=y.lastResult,y=y.failures;if(h===0)return v;throw new Ir("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(l," operations failed"),y)})},Re);function Re(){}function ji(a){function s(y,b){if(b){for(var x=arguments.length,I=new Array(x-1);--x;)I[x-1]=arguments[x];return l[y].subscribe.apply(null,I),a}if(typeof y=="string")return l[y]}var l={};s.addEventType=v;for(var f=1,h=arguments.length;f<h;++f)v(arguments[f]);return s;function v(y,b,x){if(typeof y!="object"){var I;b=b||Vp;var P={subscribers:[],fire:x=x||_e,subscribe:function(w){P.subscribers.indexOf(w)===-1&&(P.subscribers.push(w),P.fire=b(P.fire,w))},unsubscribe:function(w){P.subscribers=P.subscribers.filter(function(L){return L!==w}),P.fire=P.subscribers.reduce(b,x)}};return l[y]=s[y]=P}c(I=y).forEach(function(w){var L=I[w];if(u(L))v(w,I[w][0],I[w][1]);else{if(L!=="asap")throw new ie.InvalidArgument("Invalid event config");var C=v(w,Mi,function(){for(var D=arguments.length,R=new Array(D);D--;)R[D]=arguments[D];C.subscribers.forEach(function(k){ae(function(){k.apply(null,R)})})})}})}}function Ui(a,s){return O(s).from({prototype:a}),s}function Nn(a,s){return!(a.filter||a.algorithm||a.or)&&(s?a.justLimit:!a.replayFilter)}function Ws(a,s){a.filter=rn(a.filter,s)}function Vs(a,s,l){var f=a.replayFilter;a.replayFilter=f?function(){return rn(f(),s())}:s,a.justLimit=l&&!f}function io(a,s){if(a.isPrimKey)return s.primaryKey;var l=s.getIndexByKeyPath(a.index);if(!l)throw new ie.Schema("KeyPath "+a.index+" on object store "+s.name+" is not indexed");return l}function wl(a,s,l){var f=io(a,s.schema);return s.openCursor({trans:l,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:f,range:a.range}})}function ao(a,s,l,f){var h=a.replayFilter?rn(a.filter,a.replayFilter()):a.filter;if(a.or){var v={},y=function(b,x,I){var P,w;h&&!h(x,I,function(L){return x.stop(L)},function(L){return x.fail(L)})||((w=""+(P=x.primaryKey))=="[object ArrayBuffer]"&&(w=""+new Uint8Array(P)),g(v,w)||(v[w]=!0,s(b,x,I)))};return Promise.all([a.or._iterate(y,l),_l(wl(a,f,l),a.algorithm,y,!a.keysOnly&&a.valueMapper)])}return _l(wl(a,f,l),rn(a.algorithm,h),s,!a.keysOnly&&a.valueMapper)}function _l(a,s,l,f){var h=Ae(f?function(v,y,b){return l(f(v),y,b)}:l);return a.then(function(v){if(v)return v.start(function(){var y=function(){return v.continue()};s&&!s(v,function(b){return y=b},function(b){v.stop(b),y=_e},function(b){v.fail(b),y=_e})||h(v.value,v,function(b){return y=b}),y()})})}var ir=Symbol(),Ki=(Sl.prototype.execute=function(a){if(this.add!==void 0){var s=this.add;if(u(s))return i(i([],u(a)?a:[],!0),s).sort();if(typeof s=="number")return(Number(a)||0)+s;if(typeof s=="bigint")try{return BigInt(a)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(this.remove!==void 0){var l=this.remove;if(u(l))return u(a)?a.filter(function(f){return!l.includes(f)}).sort():[];if(typeof l=="number")return Number(a)-l;if(typeof l=="bigint")try{return BigInt(a)-l}catch{return BigInt(0)-l}throw new TypeError("Invalid subtrahend ".concat(l))}return s=(s=this.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof a=="string"&&a.startsWith(s)?this.replacePrefix[1]+a.substring(s.length):a},Sl);function Sl(a){Object.assign(this,a)}var Zp=(we.prototype._read=function(a,s){var l=this._ctx;return l.error?l.table._trans(null,Be.bind(null,l.error)):l.table._trans("readonly",a).then(s)},we.prototype._write=function(a){var s=this._ctx;return s.error?s.table._trans(null,Be.bind(null,s.error)):s.table._trans("readwrite",a,"locked")},we.prototype._addAlgorithm=function(a){var s=this._ctx;s.algorithm=rn(s.algorithm,a)},we.prototype._iterate=function(a,s){return ao(this._ctx,a,s,this._ctx.table.core)},we.prototype.clone=function(a){var s=Object.create(this.constructor.prototype),l=Object.create(this._ctx);return a&&d(l,a),s._ctx=l,s},we.prototype.raw=function(){return this._ctx.valueMapper=null,this},we.prototype.each=function(a){var s=this._ctx;return this._read(function(l){return ao(s,a,l,s.table.core)})},we.prototype.count=function(a){var s=this;return this._read(function(l){var f=s._ctx,h=f.table.core;if(Nn(f,!0))return h.count({trans:l,query:{index:io(f,h.schema),range:f.range}}).then(function(y){return Math.min(y,f.limit)});var v=0;return ao(f,function(){return++v,!1},l,h).then(function(){return v})}).then(a)},we.prototype.sortBy=function(a,s){var l=a.split(".").reverse(),f=l[0],h=l.length-1;function v(x,I){return I?v(x[l[I]],I-1):x[f]}var y=this._ctx.dir==="next"?1:-1;function b(x,I){return ve(v(x,h),v(I,h))*y}return this.toArray(function(x){return x.sort(b)}).then(s)},we.prototype.toArray=function(a){var s=this;return this._read(function(l){var f=s._ctx;if(f.dir==="next"&&Nn(f,!0)&&0<f.limit){var h=f.valueMapper,v=io(f,f.table.core.schema);return f.table.core.query({trans:l,limit:f.limit,values:!0,query:{index:v,range:f.range}}).then(function(b){return b=b.result,h?b.map(h):b})}var y=[];return ao(f,function(b){return y.push(b)},l,f.table.core).then(function(){return y})},a)},we.prototype.offset=function(a){var s=this._ctx;return a<=0||(s.offset+=a,Nn(s)?Vs(s,function(){var l=a;return function(f,h){return l===0||(l===1?--l:h(function(){f.advance(l),l=0}),!1)}}):Vs(s,function(){var l=a;return function(){return--l<0}})),this},we.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),Vs(this._ctx,function(){var s=a;return function(l,f,h){return--s<=0&&f(h),0<=s}},!0),this},we.prototype.until=function(a,s){return Ws(this._ctx,function(l,f,h){return!a(l.value)||(f(h),s)}),this},we.prototype.first=function(a){return this.limit(1).toArray(function(s){return s[0]}).then(a)},we.prototype.last=function(a){return this.reverse().first(a)},we.prototype.filter=function(a){var s;return Ws(this._ctx,function(l){return a(l.value)}),(s=this._ctx).isMatch=rn(s.isMatch,a),this},we.prototype.and=function(a){return this.filter(a)},we.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},we.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},we.prototype.desc=function(){return this.reverse()},we.prototype.eachKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(l,f){a(f.key,f)})},we.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},we.prototype.eachPrimaryKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(l,f){a(f.primaryKey,f)})},we.prototype.keys=function(a){var s=this._ctx;s.keysOnly=!s.isMatch;var l=[];return this.each(function(f,h){l.push(h.key)}).then(function(){return l}).then(a)},we.prototype.primaryKeys=function(a){var s=this._ctx;if(s.dir==="next"&&Nn(s,!0)&&0<s.limit)return this._read(function(f){var h=io(s,s.table.core.schema);return s.table.core.query({trans:f,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(f){return f.result}).then(a);s.keysOnly=!s.isMatch;var l=[];return this.each(function(f,h){l.push(h.primaryKey)}).then(function(){return l}).then(a)},we.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},we.prototype.firstKey=function(a){return this.limit(1).keys(function(s){return s[0]}).then(a)},we.prototype.lastKey=function(a){return this.reverse().firstKey(a)},we.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var s={};return Ws(this._ctx,function(h){var f=h.primaryKey.toString(),h=g(s,f);return s[f]=!0,!h}),this},we.prototype.modify=function(a){var s=this,l=this._ctx;return this._write(function(f){var h,v,y;y=typeof a=="function"?a:(h=c(a),v=h.length,function(k){for(var $=!1,A=0;A<v;++A){var M=h[A],N=a[M],q=Z(k,M);N instanceof Ki?(ne(k,M,N.execute(q)),$=!0):q!==N&&(ne(k,M,N),$=!0)}return $});var b=l.table.core,w=b.schema.primaryKey,x=w.outbound,I=w.extractKey,P=200,w=s.db._options.modifyChunkSize;w&&(P=typeof w=="object"?w[b.name]||w["*"]||200:w);function L(k,M){var A=M.failures,M=M.numFailures;D+=k-M;for(var N=0,q=c(A);N<q.length;N++){var H=q[N];C.push(A[H])}}var C=[],D=0,R=[];return s.clone().primaryKeys().then(function(k){function $(M){var N=Math.min(P,k.length-M);return b.getMany({trans:f,keys:k.slice(M,M+N),cache:"immutable"}).then(function(q){for(var H=[],F=[],U=x?[]:null,z=[],K=0;K<N;++K){var Y=q[K],ue={value:be(Y),primKey:k[M+K]};y.call(ue,ue.value,ue)!==!1&&(ue.value==null?z.push(k[M+K]):x||ve(I(Y),I(ue.value))===0?(F.push(ue.value),x&&U.push(k[M+K])):(z.push(k[M+K]),H.push(ue.value)))}return Promise.resolve(0<H.length&&b.mutate({trans:f,type:"add",values:H}).then(function(de){for(var fe in de.failures)z.splice(parseInt(fe),1);L(H.length,de)})).then(function(){return(0<F.length||A&&typeof a=="object")&&b.mutate({trans:f,type:"put",keys:U,values:F,criteria:A,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<M}).then(function(de){return L(F.length,de)})}).then(function(){return(0<z.length||A&&a===Qs)&&b.mutate({trans:f,type:"delete",keys:z,criteria:A,isAdditionalChunk:0<M}).then(function(de){return L(z.length,de)})}).then(function(){return k.length>M+N&&$(M+P)})})}var A=Nn(l)&&l.limit===1/0&&(typeof a!="function"||a===Qs)&&{index:l.index,range:l.range};return $(0).then(function(){if(0<C.length)throw new It("Error modifying one or more objects",C,D,R);return k.length})})})},we.prototype.delete=function(){var a=this._ctx,s=a.range;return Nn(a)&&(a.isPrimKey||s.type===3)?this._write(function(l){var f=a.table.core.schema.primaryKey,h=s;return a.table.core.count({trans:l,query:{index:f,range:h}}).then(function(v){return a.table.core.mutate({trans:l,type:"deleteRange",range:h}).then(function(y){var b=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new It("Could not delete some values",Object.keys(b).map(function(x){return b[x]}),v-y);return v-y})})}):this.modify(Qs)},we);function we(){}var Qs=function(a,s){return s.value=null};function em(a,s){return a<s?-1:a===s?0:1}function tm(a,s){return s<a?-1:a===s?0:1}function pt(a,s,l){return a=a instanceof xl?new a.Collection(a):a,a._ctx.error=new(l||TypeError)(s),a}function Bn(a){return new a.Collection(a,function(){return El("")}).limit(0)}function oo(a,s,l,f){var h,v,y,b,x,I,P,w=l.length;if(!l.every(function(D){return typeof D=="string"}))return pt(a,pl);function L(D){h=D==="next"?function(k){return k.toUpperCase()}:function(k){return k.toLowerCase()},v=D==="next"?function(k){return k.toLowerCase()}:function(k){return k.toUpperCase()},y=D==="next"?em:tm;var R=l.map(function(k){return{lower:v(k),upper:h(k)}}).sort(function(k,$){return y(k.lower,$.lower)});b=R.map(function(k){return k.upper}),x=R.map(function(k){return k.lower}),P=(I=D)==="next"?"":f}L("next"),a=new a.Collection(a,function(){return Rr(b[0],x[w-1]+f)}),a._ondirectionchange=function(D){L(D)};var C=0;return a._addAlgorithm(function(D,R,k){var $=D.key;if(typeof $!="string")return!1;var A=v($);if(s(A,x,C))return!0;for(var M=null,N=C;N<w;++N){var q=function(H,F,U,z,K,Y){for(var ue=Math.min(H.length,z.length),de=-1,fe=0;fe<ue;++fe){var mt=F[fe];if(mt!==z[fe])return K(H[fe],U[fe])<0?H.substr(0,fe)+U[fe]+U.substr(fe+1):K(H[fe],z[fe])<0?H.substr(0,fe)+z[fe]+U.substr(fe+1):0<=de?H.substr(0,de)+F[de]+U.substr(de+1):null;K(H[fe],mt)<0&&(de=fe)}return ue<z.length&&Y==="next"?H+U.substr(H.length):ue<H.length&&Y==="prev"?H.substr(0,U.length):de<0?null:H.substr(0,de)+z[de]+U.substr(de+1)}($,A,b[N],x[N],y,I);q===null&&M===null?C=N+1:(M===null||0<y(M,q))&&(M=q)}return R(M!==null?function(){D.continue(M+P)}:k),!1}),a}function Rr(a,s,l,f){return{type:2,lower:a,upper:s,lowerOpen:l,upperOpen:f}}function El(a){return{type:1,lower:a,upper:a}}var xl=(Object.defineProperty(Ve.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ve.prototype.between=function(a,s,l,f){l=l!==!1,f=f===!0;try{return 0<this._cmp(a,s)||this._cmp(a,s)===0&&(l||f)&&(!l||!f)?Bn(this):new this.Collection(this,function(){return Rr(a,s,!l,!f)})}catch{return pt(this,nr)}},Ve.prototype.equals=function(a){return a==null?pt(this,nr):new this.Collection(this,function(){return El(a)})},Ve.prototype.above=function(a){return a==null?pt(this,nr):new this.Collection(this,function(){return Rr(a,void 0,!0)})},Ve.prototype.aboveOrEqual=function(a){return a==null?pt(this,nr):new this.Collection(this,function(){return Rr(a,void 0,!1)})},Ve.prototype.below=function(a){return a==null?pt(this,nr):new this.Collection(this,function(){return Rr(void 0,a,!1,!0)})},Ve.prototype.belowOrEqual=function(a){return a==null?pt(this,nr):new this.Collection(this,function(){return Rr(void 0,a)})},Ve.prototype.startsWith=function(a){return typeof a!="string"?pt(this,pl):this.between(a,a+tn,!0,!0)},Ve.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):oo(this,function(s,l){return s.indexOf(l[0])===0},[a],tn)},Ve.prototype.equalsIgnoreCase=function(a){return oo(this,function(s,l){return s===l[0]},[a],"")},Ve.prototype.anyOfIgnoreCase=function(){var a=oe.apply(at,arguments);return a.length===0?Bn(this):oo(this,function(s,l){return l.indexOf(s)!==-1},a,"")},Ve.prototype.startsWithAnyOfIgnoreCase=function(){var a=oe.apply(at,arguments);return a.length===0?Bn(this):oo(this,function(s,l){return l.some(function(f){return s.indexOf(f)===0})},a,tn)},Ve.prototype.anyOf=function(){var a=this,s=oe.apply(at,arguments),l=this._cmp;try{s.sort(l)}catch{return pt(this,nr)}if(s.length===0)return Bn(this);var f=new this.Collection(this,function(){return Rr(s[0],s[s.length-1])});f._ondirectionchange=function(v){l=v==="next"?a._ascending:a._descending,s.sort(l)};var h=0;return f._addAlgorithm(function(v,y,b){for(var x=v.key;0<l(x,s[h]);)if(++h===s.length)return y(b),!1;return l(x,s[h])===0||(y(function(){v.continue(s[h])}),!1)}),f},Ve.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ve.prototype.noneOf=function(){var a=oe.apply(at,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return pt(this,nr)}var s=a.reduce(function(l,f){return l?l.concat([[l[l.length-1][1],f]]):[[-1/0,f]]},null);return s.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},Ve.prototype.inAnyRange=function($,s){var l=this,f=this._cmp,h=this._ascending,v=this._descending,y=this._min,b=this._max;if($.length===0)return Bn(this);if(!$.every(function(A){return A[0]!==void 0&&A[1]!==void 0&&h(A[0],A[1])<=0}))return pt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ie.InvalidArgument);var x=!s||s.includeLowers!==!1,I=s&&s.includeUppers===!0,P,w=h;function L(A,M){return w(A[0],M[0])}try{(P=$.reduce(function(A,M){for(var N=0,q=A.length;N<q;++N){var H=A[N];if(f(M[0],H[1])<0&&0<f(M[1],H[0])){H[0]=y(H[0],M[0]),H[1]=b(H[1],M[1]);break}}return N===q&&A.push(M),A},[])).sort(L)}catch{return pt(this,nr)}var C=0,D=I?function(A){return 0<h(A,P[C][1])}:function(A){return 0<=h(A,P[C][1])},R=x?function(A){return 0<v(A,P[C][0])}:function(A){return 0<=v(A,P[C][0])},k=D,$=new this.Collection(this,function(){return Rr(P[0][0],P[P.length-1][1],!x,!I)});return $._ondirectionchange=function(A){w=A==="next"?(k=D,h):(k=R,v),P.sort(L)},$._addAlgorithm(function(A,M,N){for(var q,H=A.key;k(H);)if(++C===P.length)return M(N),!1;return!D(q=H)&&!R(q)||(l._cmp(H,P[C][1])===0||l._cmp(H,P[C][0])===0||M(function(){w===h?A.continue(P[C][0]):A.continue(P[C][1])}),!1)}),$},Ve.prototype.startsWithAnyOf=function(){var a=oe.apply(at,arguments);return a.every(function(s){return typeof s=="string"})?a.length===0?Bn(this):this.inAnyRange(a.map(function(s){return[s,s+tn]})):pt(this,"startsWithAnyOf() only works with strings")},Ve);function Ve(){}function Qt(a){return Ae(function(s){return Hi(s),a(s.target.error),!1})}function Hi(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var zi="storagemutated",Gs="x-storagemutated-1",Lr=ji(null,zi),rm=(Gt.prototype._lock=function(){return ce(!te.global),++this._reculock,this._reculock!==1||te.global||(te.lockOwnerFor=this),this},Gt.prototype._unlock=function(){if(ce(!te.global),--this._reculock==0)for(te.global||(te.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{en(a[1],a[0])}catch{}}return this},Gt.prototype._locked=function(){return this._reculock&&te.lockOwnerFor!==this},Gt.prototype.create=function(a){var s=this;if(!this.mode)return this;var l=this.db.idbdb,f=this.db._state.dbOpenError;if(ce(!this.idbtrans),!a&&!l)switch(f&&f.name){case"DatabaseClosedError":throw new ie.DatabaseClosed(f);case"MissingAPIError":throw new ie.MissingAPI(f.message,f);default:throw new ie.OpenFailed(f)}if(!this.active)throw new ie.TransactionInactive;return ce(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||l).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ae(function(h){Hi(h),s._reject(a.error)}),a.onabort=Ae(function(h){Hi(h),s.active&&s._reject(new ie.Abort(a.error)),s.active=!1,s.on("abort").fire(h)}),a.oncomplete=Ae(function(){s.active=!1,s._resolve(),"mutatedParts"in a&&Lr.storagemutated.fire(a.mutatedParts)}),this},Gt.prototype._promise=function(a,s,l){var f=this;if(a==="readwrite"&&this.mode!=="readwrite")return Be(new ie.ReadOnly("Transaction is readonly"));if(!this.active)return Be(new ie.TransactionInactive);if(this._locked())return new V(function(v,y){f._blockedFuncs.push([function(){f._promise(a,s,l).then(v,y)},te])});if(l)return Dr(function(){var v=new V(function(y,b){f._lock();var x=s(y,b,f);x&&x.then&&x.then(y,b)});return v.finally(function(){return f._unlock()}),v._lib=!0,v});var h=new V(function(v,y){var b=s(v,y,f);b&&b.then&&b.then(v,y)});return h._lib=!0,h},Gt.prototype._root=function(){return this.parent?this.parent._root():this},Gt.prototype.waitFor=function(a){var s,l=this._root(),f=V.resolve(a);l._waitingFor?l._waitingFor=l._waitingFor.then(function(){return f}):(l._waitingFor=f,l._waitingQueue=[],s=l.idbtrans.objectStore(l.storeNames[0]),function v(){for(++l._spinCount;l._waitingQueue.length;)l._waitingQueue.shift()();l._waitingFor&&(s.get(-1/0).onsuccess=v)}());var h=l._waitingFor;return new V(function(v,y){f.then(function(b){return l._waitingQueue.push(Ae(v.bind(null,b)))},function(b){return l._waitingQueue.push(Ae(y.bind(null,b)))}).finally(function(){l._waitingFor===h&&(l._waitingFor=null)})})},Gt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ie.Abort))},Gt.prototype.table=function(a){var s=this._memoizedTables||(this._memoizedTables={});if(g(s,a))return s[a];var l=this.schema[a];if(!l)throw new ie.NotFound("Table "+a+" not part of transaction");return l=new this.db.Table(a,l,this),l.core=this.db.core.table(a),s[a]=l},Gt);function Gt(){}function Ys(a,s,l,f,h,v,y){return{name:a,keyPath:s,unique:l,multi:f,auto:h,compound:v,src:(l&&!y?"&":"")+(f?"*":"")+(h?"++":"")+Cl(s)}}function Cl(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function Js(a,s,l){return{name:a,primKey:s,indexes:l,mappedClass:null,idxByName:(f=function(h){return[h.name,h]},l.reduce(function(h,v,y){return y=f(v,y),y&&(h[y[0]]=y[1]),h},{}))};var f}var Wi=function(a){try{return a.only([[]]),Wi=function(){return[[]]},[[]]}catch{return Wi=function(){return tn},tn}};function Xs(a){return a==null?function(){}:typeof a=="string"?(s=a).split(".").length===1?function(l){return l[s]}:function(l){return Z(l,s)}:function(l){return Z(l,a)};var s}function Il(a){return[].slice.call(a)}var nm=0;function Vi(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function im(a,s,x){function f(k){if(k.type===3)return null;if(k.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var C=k.lower,D=k.upper,R=k.lowerOpen,k=k.upperOpen;return C===void 0?D===void 0?null:s.upperBound(D,!!k):D===void 0?s.lowerBound(C,!!R):s.bound(C,D,!!R,!!k)}function h(L){var C,D=L.name;return{name:D,schema:L,mutate:function(R){var k=R.trans,$=R.type,A=R.keys,M=R.values,N=R.range;return new Promise(function(q,H){q=Ae(q);var F=k.objectStore(D),U=F.keyPath==null,z=$==="put"||$==="add";if(!z&&$!=="delete"&&$!=="deleteRange")throw new Error("Invalid operation type: "+$);var K,Y=(A||M||{length:1}).length;if(A&&M&&A.length!==M.length)throw new Error("Given keys array must have same length as given values array.");if(Y===0)return q({numFailures:0,failures:{},results:[],lastResult:void 0});function ue(ot){++mt,Hi(ot)}var de=[],fe=[],mt=0;if($==="deleteRange"){if(N.type===4)return q({numFailures:mt,failures:fe,results:[],lastResult:void 0});N.type===3?de.push(K=F.clear()):de.push(K=F.delete(f(N)))}else{var U=z?U?[M,A]:[M,null]:[A,null],se=U[0],nt=U[1];if(z)for(var it=0;it<Y;++it)de.push(K=nt&&nt[it]!==void 0?F[$](se[it],nt[it]):F[$](se[it])),K.onerror=ue;else for(it=0;it<Y;++it)de.push(K=F[$](se[it])),K.onerror=ue}function wo(ot){ot=ot.target.result,de.forEach(function(on,vc){return on.error!=null&&(fe[vc]=on.error)}),q({numFailures:mt,failures:fe,results:$==="delete"?A:de.map(function(on){return on.result}),lastResult:ot})}K.onerror=function(ot){ue(ot),wo(ot)},K.onsuccess=wo})},getMany:function(R){var k=R.trans,$=R.keys;return new Promise(function(A,M){A=Ae(A);for(var N,q=k.objectStore(D),H=$.length,F=new Array(H),U=0,z=0,K=function(de){de=de.target,F[de._pos]=de.result,++z===U&&A(F)},Y=Qt(M),ue=0;ue<H;++ue)$[ue]!=null&&((N=q.get($[ue]))._pos=ue,N.onsuccess=K,N.onerror=Y,++U);U===0&&A(F)})},get:function(R){var k=R.trans,$=R.key;return new Promise(function(A,M){A=Ae(A);var N=k.objectStore(D).get($);N.onsuccess=function(q){return A(q.target.result)},N.onerror=Qt(M)})},query:(C=I,function(R){return new Promise(function(k,$){k=Ae(k);var A,M,N,U=R.trans,q=R.values,H=R.limit,K=R.query,F=H===1/0?void 0:H,z=K.index,K=K.range,U=U.objectStore(D),z=z.isPrimaryKey?U:U.index(z.name),K=f(K);if(H===0)return k({result:[]});C?((F=q?z.getAll(K,F):z.getAllKeys(K,F)).onsuccess=function(Y){return k({result:Y.target.result})},F.onerror=Qt($)):(A=0,M=!q&&"openKeyCursor"in z?z.openKeyCursor(K):z.openCursor(K),N=[],M.onsuccess=function(Y){var ue=M.result;return ue?(N.push(q?ue.value:ue.primaryKey),++A===H?k({result:N}):void ue.continue()):k({result:N})},M.onerror=Qt($))})}),openCursor:function(R){var k=R.trans,$=R.values,A=R.query,M=R.reverse,N=R.unique;return new Promise(function(q,H){q=Ae(q);var z=A.index,F=A.range,U=k.objectStore(D),U=z.isPrimaryKey?U:U.index(z.name),z=M?N?"prevunique":"prev":N?"nextunique":"next",K=!$&&"openKeyCursor"in U?U.openKeyCursor(f(F),z):U.openCursor(f(F),z);K.onerror=Qt(H),K.onsuccess=Ae(function(Y){var ue,de,fe,mt,se=K.result;se?(se.___id=++nm,se.done=!1,ue=se.continue.bind(se),de=(de=se.continuePrimaryKey)&&de.bind(se),fe=se.advance.bind(se),mt=function(){throw new Error("Cursor not stopped")},se.trans=k,se.stop=se.continue=se.continuePrimaryKey=se.advance=function(){throw new Error("Cursor not started")},se.fail=Ae(H),se.next=function(){var nt=this,it=1;return this.start(function(){return it--?nt.continue():nt.stop()}).then(function(){return nt})},se.start=function(nt){function it(){if(K.result)try{nt()}catch(ot){se.fail(ot)}else se.done=!0,se.start=function(){throw new Error("Cursor behind last entry")},se.stop()}var wo=new Promise(function(ot,on){ot=Ae(ot),K.onerror=Qt(on),se.fail=on,se.stop=function(vc){se.stop=se.continue=se.continuePrimaryKey=se.advance=mt,ot(vc)}});return K.onsuccess=Ae(function(ot){K.onsuccess=it,it()}),se.continue=ue,se.continuePrimaryKey=de,se.advance=fe,it(),wo},q(se)):q(null)},H)})},count:function(R){var k=R.query,$=R.trans,A=k.index,M=k.range;return new Promise(function(N,q){var H=$.objectStore(D),F=A.isPrimaryKey?H:H.index(A.name),H=f(M),F=H?F.count(H):F.count();F.onsuccess=Ae(function(U){return N(U.target.result)}),F.onerror=Qt(q)})}}}var v,y,b,P=(y=x,b=Il((v=a).objectStoreNames),{schema:{name:v.name,tables:b.map(function(L){return y.objectStore(L)}).map(function(L){var C=L.keyPath,k=L.autoIncrement,D=u(C),R={},k={name:L.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:C==null,compound:D,keyPath:C,autoIncrement:k,unique:!0,extractKey:Xs(C)},indexes:Il(L.indexNames).map(function($){return L.index($)}).map(function(N){var A=N.name,M=N.unique,q=N.multiEntry,N=N.keyPath,q={name:A,compound:u(N),keyPath:N,unique:M,multiEntry:q,extractKey:Xs(N)};return R[Vi(N)]=q}),getIndexByKeyPath:function($){return R[Vi($)]}};return R[":id"]=k.primaryKey,C!=null&&(R[Vi(C)]=k.primaryKey),k})},hasGetAll:0<b.length&&"getAll"in y.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),x=P.schema,I=P.hasGetAll,P=x.tables.map(h),w={};return P.forEach(function(L){return w[L.name]=L}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(L){if(!w[L])throw new Error("Table '".concat(L,"' not found"));return w[L]},MIN_KEY:-1/0,MAX_KEY:Wi(s),schema:x}}function am(a,s,l,f){var h=l.IDBKeyRange;return l.indexedDB,{dbcore:(f=im(s,h,f),a.dbcore.reduce(function(v,y){return y=y.create,n(n({},v),y(v))},f))}}function so(a,f){var l=f.db,f=am(a._middlewares,l,a._deps,f);a.core=f.dbcore,a.tables.forEach(function(h){var v=h.name;a.core.schema.tables.some(function(y){return y.name===v})&&(h.core=a.core.table(v),a[v]instanceof a.Table&&(a[v].core=h.core))})}function co(a,s,l,f){l.forEach(function(h){var v=f[h];s.forEach(function(y){var b=function x(I,P){return T(I,P)||(I=p(I))&&x(I,P)}(y,h);(!b||"value"in b&&b.value===void 0)&&(y===a.Transaction.prototype||y instanceof a.Transaction?E(y,h,{get:function(){return this.table(h)},set:function(x){_(this,h,{value:x,writable:!0,configurable:!0,enumerable:!0})}}):y[h]=new a.Table(h,v))})})}function Zs(a,s){s.forEach(function(l){for(var f in l)l[f]instanceof a.Table&&delete l[f]})}function om(a,s){return a._cfg.version-s._cfg.version}function sm(a,s,l,f){var h=a._dbSchema;l.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=Js("$meta",Dl("")[0],[]),a._storeNames.push("$meta"));var v=a._createTransaction("readwrite",a._storeNames,h);v.create(l),v._completion.catch(f);var y=v._reject.bind(v),b=te.transless||te;Dr(function(){return te.trans=v,te.transless=b,s!==0?(so(a,l),I=s,((x=v).storeNames.includes("$meta")?x.table("$meta").get("version").then(function(P){return P??I}):V.resolve(I)).then(function(P){return L=P,C=v,D=l,R=[],P=(w=a)._versions,k=w._dbSchema=lo(0,w.idbdb,D),(P=P.filter(function($){return $._cfg.version>=L})).length!==0?(P.forEach(function($){R.push(function(){var A=k,M=$._cfg.dbschema;fo(w,A,D),fo(w,M,D),k=w._dbSchema=M;var N=ec(A,M);N.add.forEach(function(z){tc(D,z[0],z[1].primKey,z[1].indexes)}),N.change.forEach(function(z){if(z.recreate)throw new ie.Upgrade("Not yet support for changing primary key");var K=D.objectStore(z.name);z.add.forEach(function(Y){return uo(K,Y)}),z.change.forEach(function(Y){K.deleteIndex(Y.name),uo(K,Y)}),z.del.forEach(function(Y){return K.deleteIndex(Y)})});var q=$._cfg.contentUpgrade;if(q&&$._cfg.version>L){so(w,D),C._memoizedTables={};var H=he(M);N.del.forEach(function(z){H[z]=A[z]}),Zs(w,[w.Transaction.prototype]),co(w,[w.Transaction.prototype],c(H),H),C.schema=H;var F,U=$e(q);return U&&Tn(),N=V.follow(function(){var z;(F=q(C))&&U&&(z=Or.bind(null,null),F.then(z,z))}),F&&typeof F.then=="function"?V.resolve(F):N.then(function(){return F})}}),R.push(function(A){var M,N,q=$._cfg.dbschema;M=q,N=A,[].slice.call(N.db.objectStoreNames).forEach(function(H){return M[H]==null&&N.db.deleteObjectStore(H)}),Zs(w,[w.Transaction.prototype]),co(w,[w.Transaction.prototype],w._storeNames,w._dbSchema),C.schema=w._dbSchema}),R.push(function(A){w.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(w.idbdb.version/10)===$._cfg.version?(w.idbdb.deleteObjectStore("$meta"),delete w._dbSchema.$meta,w._storeNames=w._storeNames.filter(function(M){return M!=="$meta"})):A.objectStore("$meta").put($._cfg.version,"version"))})}),function $(){return R.length?V.resolve(R.shift()(C.idbtrans)).then($):V.resolve()}().then(function(){kl(k,D)})):V.resolve();var w,L,C,D,R,k}).catch(y)):(c(h).forEach(function(P){tc(l,P,h[P].primKey,h[P].indexes)}),so(a,l),void V.follow(function(){return a.on.populate.fire(v)}).catch(y));var x,I})}function cm(a,s){kl(a._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var l=lo(0,a.idbdb,s);fo(a,a._dbSchema,s);for(var f=0,h=ec(l,a._dbSchema).change;f<h.length;f++){var v=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var b=s.objectStore(y.name);y.add.forEach(function(x){Vt&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(x.src)),uo(b,x)})}(h[f]);if(typeof v=="object")return v.value}}function ec(a,s){var l,f={del:[],add:[],change:[]};for(l in a)s[l]||f.del.push(l);for(l in s){var h=a[l],v=s[l];if(h){var y={name:l,def:v,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(v.primKey.keyPath||"")||h.primKey.auto!==v.primKey.auto)y.recreate=!0,f.change.push(y);else{var b=h.idxByName,x=v.idxByName,I=void 0;for(I in b)x[I]||y.del.push(I);for(I in x){var P=b[I],w=x[I];P?P.src!==w.src&&y.change.push(w):y.add.push(w)}(0<y.del.length||0<y.add.length||0<y.change.length)&&f.change.push(y)}}else f.add.push([l,v])}return f}function tc(a,s,l,f){var h=a.db.createObjectStore(s,l.keyPath?{keyPath:l.keyPath,autoIncrement:l.auto}:{autoIncrement:l.auto});return f.forEach(function(v){return uo(h,v)}),h}function kl(a,s){c(a).forEach(function(l){s.db.objectStoreNames.contains(l)||(Vt&&console.debug("Dexie: Creating missing table",l),tc(s,l,a[l].primKey,a[l].indexes))})}function uo(a,s){a.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function lo(a,s,l){var f={};return j(s.objectStoreNames,0).forEach(function(h){for(var v=l.objectStore(h),y=Ys(Cl(I=v.keyPath),I||"",!0,!1,!!v.autoIncrement,I&&typeof I!="string",!0),b=[],x=0;x<v.indexNames.length;++x){var P=v.index(v.indexNames[x]),I=P.keyPath,P=Ys(P.name,I,!!P.unique,!!P.multiEntry,!1,I&&typeof I!="string",!1);b.push(P)}f[h]=Js(h,y,b)}),f}function fo(a,s,l){for(var f=l.db.objectStoreNames,h=0;h<f.length;++h){var v=f[h],y=l.objectStore(v);a._hasGetAll="getAll"in y;for(var b=0;b<y.indexNames.length;++b){var x=y.indexNames[b],I=y.index(x).keyPath,P=typeof I=="string"?I:"["+j(I).join("+")+"]";!s[v]||(I=s[v].idxByName[P])&&(I.name=x,delete s[v].idxByName[P],s[v].idxByName[x]=I)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function Dl(a){return a.split(",").map(function(s,l){var f=(s=s.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return Ys(f,h||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),u(h),l===0)})}var um=(ho.prototype._parseStoresSpec=function(a,s){c(a).forEach(function(l){if(a[l]!==null){var f=Dl(a[l]),h=f.shift();if(h.unique=!0,h.multi)throw new ie.Schema("Primary key cannot be multi-valued");f.forEach(function(v){if(v.auto)throw new ie.Schema("Only primary key can be marked as autoIncrement (++)");if(!v.keyPath)throw new ie.Schema("Index must have a name and cannot be an empty string")}),s[l]=Js(l,h,f)}})},ho.prototype.stores=function(l){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?d(this._cfg.storesSource,l):l;var l=s._versions,f={},h={};return l.forEach(function(v){d(f,v._cfg.storesSource),h=v._cfg.dbschema={},v._parseStoresSpec(f,h)}),s._dbSchema=h,Zs(s,[s._allTables,s,s.Transaction.prototype]),co(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],c(h),h),s._storeNames=c(h),this},ho.prototype.upgrade=function(a){return this._cfg.contentUpgrade=Ts(this._cfg.contentUpgrade||_e,a),this},ho);function ho(){}function rc(a,s){var l=a._dbNamesDB;return l||(l=a._dbNamesDB=new ar(ro,{addons:[],indexedDB:a,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),l.table("dbnames")}function nc(a){return a&&typeof a.databases=="function"}function ic(a){return Dr(function(){return te.letThrough=!0,a()})}function ac(a){return!("from"in a)}var rt=function(a,s){if(!this){var l=new rt;return a&&"d"in a&&d(l,a),l}d(this,arguments.length?{d:1,from:a,to:1<arguments.length?s:a}:{d:0})};function Qi(a,s,l){var f=ve(s,l);if(!isNaN(f)){if(0<f)throw RangeError();if(ac(a))return d(a,{from:s,to:l,d:1});var h=a.l,f=a.r;if(ve(l,a.from)<0)return h?Qi(h,s,l):a.l={from:s,to:l,d:1,l:null,r:null},Pl(a);if(0<ve(s,a.to))return f?Qi(f,s,l):a.r={from:s,to:l,d:1,l:null,r:null},Pl(a);ve(s,a.from)<0&&(a.from=s,a.l=null,a.d=f?f.d+1:1),0<ve(l,a.to)&&(a.to=l,a.r=null,a.d=a.l?a.l.d+1:1),l=!a.r,h&&!a.l&&Gi(a,h),f&&l&&Gi(a,f)}}function Gi(a,s){ac(s)||function l(f,x){var v=x.from,y=x.to,b=x.l,x=x.r;Qi(f,v,y),b&&l(f,b),x&&l(f,x)}(a,s)}function Ol(a,s){var l=po(s),f=l.next();if(f.done)return!1;for(var h=f.value,v=po(a),y=v.next(h.from),b=y.value;!f.done&&!y.done;){if(ve(b.from,h.to)<=0&&0<=ve(b.to,h.from))return!0;ve(h.from,b.from)<0?h=(f=l.next(b.from)).value:b=(y=v.next(h.from)).value}return!1}function po(a){var s=ac(a)?null:{s:0,n:a};return{next:function(l){for(var f=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,f)for(;s.n.l&&ve(l,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!f||ve(l,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function Pl(a){var s,l,f=(((s=a.r)===null||s===void 0?void 0:s.d)||0)-(((l=a.l)===null||l===void 0?void 0:l.d)||0),h=1<f?"r":f<-1?"l":"";h&&(s=h=="r"?"l":"r",l=n({},a),f=a[h],a.from=f.from,a.to=f.to,a[h]=f[h],l[h]=f[s],(a[s]=l).d=Rl(l)),a.d=Rl(a)}function Rl(l){var s=l.r,l=l.l;return(s?l?Math.max(s.d,l.d):s.d:l?l.d:0)+1}function mo(a,s){return c(s).forEach(function(l){a[l]?Gi(a[l],s[l]):a[l]=function f(h){var v,y,b={};for(v in h)g(h,v)&&(y=h[v],b[v]=!y||typeof y!="object"||Pe.has(y.constructor)?y:f(y));return b}(s[l])}),a}function oc(a,s){return a.all||s.all||Object.keys(a).some(function(l){return s[l]&&Ol(s[l],a[l])})}S(rt.prototype,((kt={add:function(a){return Gi(this,a),this},addKey:function(a){return Qi(this,a,a),this},addKeys:function(a){var s=this;return a.forEach(function(l){return Qi(s,l,l)}),this},hasKey:function(a){var s=po(this).next(a).value;return s&&ve(s.from,a)<=0&&0<=ve(s.to,a)}})[tt]=function(){return po(this)},kt));var nn={},sc={},cc=!1;function vo(a){mo(sc,a),cc||(cc=!0,setTimeout(function(){cc=!1,uc(sc,!(sc={}))},0))}function uc(a,s){s===void 0&&(s=!1);var l=new Set;if(a.all)for(var f=0,h=Object.values(nn);f<h.length;f++)Ll(y=h[f],a,l,s);else for(var v in a){var y,b=/^idb\:\/\/(.*)\/(.*)\//.exec(v);b&&(v=b[1],b=b[2],(y=nn["idb://".concat(v,"/").concat(b)])&&Ll(y,a,l,s))}l.forEach(function(x){return x()})}function Ll(a,s,l,f){for(var h=[],v=0,y=Object.entries(a.queries.query);v<y.length;v++){for(var b=y[v],x=b[0],I=[],P=0,w=b[1];P<w.length;P++){var L=w[P];oc(s,L.obsSet)?L.subscribers.forEach(function(k){return l.add(k)}):f&&I.push(L)}f&&h.push([x,I])}if(f)for(var C=0,D=h;C<D.length;C++){var R=D[C],x=R[0],I=R[1];a.queries.query[x]=I}}function lm(a){var s=a._state,l=a._deps.indexedDB;if(s.isBeingOpened||a.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?Be(s.dbOpenError):a});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var f=s.openCanceller,h=Math.round(10*a.verno),v=!1;function y(){if(s.openCanceller!==f)throw new ie.DatabaseClosed("db.open() was cancelled")}function b(){return new V(function(L,C){if(y(),!l)throw new ie.MissingAPI;var D=a.name,R=s.autoSchema||!h?l.open(D):l.open(D,h);if(!R)throw new ie.MissingAPI;R.onerror=Qt(C),R.onblocked=Ae(a._fireOnBlocked),R.onupgradeneeded=Ae(function(k){var $;P=R.transaction,s.autoSchema&&!a._options.allowEmptyDB?(R.onerror=Hi,P.abort(),R.result.close(),($=l.deleteDatabase(D)).onsuccess=$.onerror=Ae(function(){C(new ie.NoSuchDatabase("Database ".concat(D," doesnt exist")))})):(P.onerror=Qt(C),k=k.oldVersion>Math.pow(2,62)?0:k.oldVersion,w=k<1,a.idbdb=R.result,v&&cm(a,P),sm(a,k/10,P,C))},C),R.onsuccess=Ae(function(){P=null;var k,$,A,M,N,q=a.idbdb=R.result,H=j(q.objectStoreNames);if(0<H.length)try{var F=q.transaction((M=H).length===1?M[0]:M,"readonly");if(s.autoSchema)$=q,A=F,(k=a).verno=$.version/10,A=k._dbSchema=lo(0,$,A),k._storeNames=j($.objectStoreNames,0),co(k,[k._allTables],c(A),A);else if(fo(a,a._dbSchema,F),((N=ec(lo(0,(N=a).idbdb,F),N._dbSchema)).add.length||N.change.some(function(U){return U.add.length||U.change.length}))&&!v)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),q.close(),h=q.version+1,v=!0,L(b());so(a,F)}catch{}Mn.push(a),q.onversionchange=Ae(function(U){s.vcFired=!0,a.on("versionchange").fire(U)}),q.onclose=Ae(function(U){a.on("close").fire(U)}),w&&(N=a._deps,F=D,q=N.indexedDB,N=N.IDBKeyRange,nc(q)||F===ro||rc(q,N).put({name:F}).catch(_e)),L()},C)}).catch(function(L){switch(L==null?void 0:L.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),b();break;case"VersionError":if(0<h)return h=0,b()}return V.reject(L)})}var x,I=s.dbReadyResolve,P=null,w=!1;return V.race([f,(typeof navigator>"u"?V.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(L){function C(){return indexedDB.databases().finally(L)}x=setInterval(C,100),C()}).finally(function(){return clearInterval(x)}):Promise.resolve()).then(b)]).then(function(){return y(),s.onReadyBeingFired=[],V.resolve(ic(function(){return a.on.ready.fire(a.vip)})).then(function L(){if(0<s.onReadyBeingFired.length){var C=s.onReadyBeingFired.reduce(Ts,_e);return s.onReadyBeingFired=[],V.resolve(ic(function(){return C(a.vip)})).then(L)}})}).finally(function(){s.openCanceller===f&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(L){s.dbOpenError=L;try{P&&P.abort()}catch{}return f===s.openCanceller&&a._close(),Be(L)}).finally(function(){s.openComplete=!0,I()}).then(function(){var L;return w&&(L={},a.tables.forEach(function(C){C.schema.indexes.forEach(function(D){D.name&&(L["idb://".concat(a.name,"/").concat(C.name,"/").concat(D.name)]=new rt(-1/0,[[[]]]))}),L["idb://".concat(a.name,"/").concat(C.name,"/")]=L["idb://".concat(a.name,"/").concat(C.name,"/:dels")]=new rt(-1/0,[[[]]])}),Lr(zi).fire(L),uc(L,!0)),a})}function lc(a){function s(v){return a.next(v)}var l=h(s),f=h(function(v){return a.throw(v)});function h(v){return function(x){var b=v(x),x=b.value;return b.done?x:x&&typeof x.then=="function"?x.then(l,f):u(x)?Promise.all(x).then(l,f):l(x)}}return h(s)()}function go(a,s,l){for(var f=u(a)?a.slice():[a],h=0;h<l;++h)f.push(s);return f}var dm={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return n(n({},a),{table:function(s){var l=a.table(s),f=l.schema,h={},v=[];function y(w,L,C){var D=Vi(w),R=h[D]=h[D]||[],k=w==null?0:typeof w=="string"?1:w.length,$=0<L,$=n(n({},C),{name:$?"".concat(D,"(virtual-from:").concat(C.name,")"):C.name,lowLevelIndex:C,isVirtual:$,keyTail:L,keyLength:k,extractKey:Xs(w),unique:!$&&C.unique});return R.push($),$.isPrimaryKey||v.push($),1<k&&y(k===2?w[0]:w.slice(0,k-1),L+1,C),R.sort(function(A,M){return A.keyTail-M.keyTail}),$}s=y(f.primaryKey.keyPath,0,f.primaryKey),h[":id"]=[s];for(var b=0,x=f.indexes;b<x.length;b++){var I=x[b];y(I.keyPath,0,I)}function P(w){var L,C=w.query.index;return C.isVirtual?n(n({},w),{query:{index:C.lowLevelIndex,range:(L=w.query.range,C=C.keyTail,{type:L.type===1?2:L.type,lower:go(L.lower,L.lowerOpen?a.MAX_KEY:a.MIN_KEY,C),lowerOpen:!0,upper:go(L.upper,L.upperOpen?a.MIN_KEY:a.MAX_KEY,C),upperOpen:!0})}}):w}return n(n({},l),{schema:n(n({},f),{primaryKey:s,indexes:v,getIndexByKeyPath:function(w){return(w=h[Vi(w)])&&w[0]}}),count:function(w){return l.count(P(w))},query:function(w){return l.query(P(w))},openCursor:function(w){var L=w.query.index,C=L.keyTail,D=L.isVirtual,R=L.keyLength;return D?l.openCursor(P(w)).then(function($){return $&&k($)}):l.openCursor(w);function k($){return Object.create($,{continue:{value:function(A){A!=null?$.continue(go(A,w.reverse?a.MAX_KEY:a.MIN_KEY,C)):w.unique?$.continue($.key.slice(0,R).concat(w.reverse?a.MIN_KEY:a.MAX_KEY,C)):$.continue()}},continuePrimaryKey:{value:function(A,M){$.continuePrimaryKey(go(A,a.MAX_KEY,C),M)}},primaryKey:{get:function(){return $.primaryKey}},key:{get:function(){var A=$.key;return R===1?A[0]:A.slice(0,R)}},value:{get:function(){return $.value}}})}}})}})}};function dc(a,s,l,f){return l=l||{},f=f||"",c(a).forEach(function(h){var v,y,b;g(s,h)?(v=a[h],y=s[h],typeof v=="object"&&typeof y=="object"&&v&&y?(b=De(v))!==De(y)?l[f+h]=s[h]:b==="Object"?dc(v,y,l,f+h+"."):v!==y&&(l[f+h]=s[h]):v!==y&&(l[f+h]=s[h])):l[f+h]=void 0}),c(s).forEach(function(h){g(a,h)||(l[f+h]=s[h])}),l}function fc(a,s){return s.type==="delete"?s.keys:s.keys||s.values.map(a.extractKey)}var fm={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return n(n({},a),{table:function(s){var l=a.table(s),f=l.schema.primaryKey;return n(n({},l),{mutate:function(h){var v=te.trans,y=v.table(s).hook,b=y.deleting,x=y.creating,I=y.updating;switch(h.type){case"add":if(x.fire===_e)break;return v._promise("readwrite",function(){return P(h)},!0);case"put":if(x.fire===_e&&I.fire===_e)break;return v._promise("readwrite",function(){return P(h)},!0);case"delete":if(b.fire===_e)break;return v._promise("readwrite",function(){return P(h)},!0);case"deleteRange":if(b.fire===_e)break;return v._promise("readwrite",function(){return function w(L,C,D){return l.query({trans:L,values:!1,query:{index:f,range:C},limit:D}).then(function(R){var k=R.result;return P({type:"delete",keys:k,trans:L}).then(function($){return 0<$.numFailures?Promise.reject($.failures[0]):k.length<D?{failures:[],numFailures:0,lastResult:void 0}:w(L,n(n({},C),{lower:k[k.length-1],lowerOpen:!0}),D)})})}(h.trans,h.range,1e4)},!0)}return l.mutate(h);function P(w){var L,C,D,R=te.trans,k=w.keys||fc(f,w);if(!k)throw new Error("Keys missing");return(w=w.type==="add"||w.type==="put"?n(n({},w),{keys:k}):n({},w)).type!=="delete"&&(w.values=i([],w.values)),w.keys&&(w.keys=i([],w.keys)),L=l,D=k,((C=w).type==="add"?Promise.resolve([]):L.getMany({trans:C.trans,keys:D,cache:"immutable"})).then(function($){var A=k.map(function(M,N){var q,H,F,U=$[N],z={onerror:null,onsuccess:null};return w.type==="delete"?b.fire.call(z,M,U,R):w.type==="add"||U===void 0?(q=x.fire.call(z,M,w.values[N],R),M==null&&q!=null&&(w.keys[N]=M=q,f.outbound||ne(w.values[N],f.keyPath,M))):(q=dc(U,w.values[N]),(H=I.fire.call(z,q,M,U,R))&&(F=w.values[N],Object.keys(H).forEach(function(K){g(F,K)?F[K]=H[K]:ne(F,K,H[K])}))),z});return l.mutate(w).then(function(M){for(var N=M.failures,q=M.results,H=M.numFailures,M=M.lastResult,F=0;F<k.length;++F){var U=(q||k)[F],z=A[F];U==null?z.onerror&&z.onerror(N[F]):z.onsuccess&&z.onsuccess(w.type==="put"&&$[F]?w.values[F]:U)}return{failures:N,results:q,numFailures:H,lastResult:M}}).catch(function(M){return A.forEach(function(N){return N.onerror&&N.onerror(M)}),Promise.reject(M)})})}}})}})}};function $l(a,s,l){try{if(!s||s.keys.length<a.length)return null;for(var f=[],h=0,v=0;h<s.keys.length&&v<a.length;++h)ve(s.keys[h],a[v])===0&&(f.push(l?be(s.values[h]):s.values[h]),++v);return f.length===a.length?f:null}catch{return null}}var hm={stack:"dbcore",level:-1,create:function(a){return{table:function(s){var l=a.table(s);return n(n({},l),{getMany:function(f){if(!f.cache)return l.getMany(f);var h=$l(f.keys,f.trans._cache,f.cache==="clone");return h?V.resolve(h):l.getMany(f).then(function(v){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?be(v):v},v})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),l.mutate(f)}})}}}};function Al(a,s){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function Tl(a,s){switch(a){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var pm={stack:"dbcore",level:0,name:"Observability",create:function(a){var s=a.schema.name,l=new rt(a.MIN_KEY,a.MAX_KEY);return n(n({},a),{transaction:function(f,h,v){if(te.subscr&&h!=="readonly")throw new ie.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(te.querier));return a.transaction(f,h,v)},table:function(f){var h=a.table(f),v=h.schema,y=v.primaryKey,w=v.indexes,b=y.extractKey,x=y.outbound,I=y.autoIncrement&&w.filter(function(C){return C.compound&&C.keyPath.includes(y.keyPath)}),P=n(n({},h),{mutate:function(C){function D(K){return K="idb://".concat(s,"/").concat(f,"/").concat(K),M[K]||(M[K]=new rt)}var R,k,$,A=C.trans,M=C.mutatedParts||(C.mutatedParts={}),N=D(""),q=D(":dels"),H=C.type,z=C.type==="deleteRange"?[C.range]:C.type==="delete"?[C.keys]:C.values.length<50?[fc(y,C).filter(function(K){return K}),C.values]:[],F=z[0],U=z[1],z=C.trans._cache;return u(F)?(N.addKeys(F),(z=H==="delete"||F.length===U.length?$l(F,z):null)||q.addKeys(F),(z||U)&&(R=D,k=z,$=U,v.indexes.forEach(function(K){var Y=R(K.name||"");function ue(fe){return fe!=null?K.extractKey(fe):null}function de(fe){return K.multiEntry&&u(fe)?fe.forEach(function(mt){return Y.addKey(mt)}):Y.addKey(fe)}(k||$).forEach(function(fe,nt){var se=k&&ue(k[nt]),nt=$&&ue($[nt]);ve(se,nt)!==0&&(se!=null&&de(se),nt!=null&&de(nt))})}))):F?(U={from:(U=F.lower)!==null&&U!==void 0?U:a.MIN_KEY,to:(U=F.upper)!==null&&U!==void 0?U:a.MAX_KEY},q.add(U),N.add(U)):(N.add(l),q.add(l),v.indexes.forEach(function(K){return D(K.name).add(l)})),h.mutate(C).then(function(K){return!F||C.type!=="add"&&C.type!=="put"||(N.addKeys(K.results),I&&I.forEach(function(Y){for(var ue=C.values.map(function(se){return Y.extractKey(se)}),de=Y.keyPath.findIndex(function(se){return se===y.keyPath}),fe=0,mt=K.results.length;fe<mt;++fe)ue[fe][de]=K.results[fe];D(Y.name).addKeys(ue)})),A.mutatedParts=mo(A.mutatedParts||{},M),K})}}),w=function(D){var R=D.query,D=R.index,R=R.range;return[D,new rt((D=R.lower)!==null&&D!==void 0?D:a.MIN_KEY,(R=R.upper)!==null&&R!==void 0?R:a.MAX_KEY)]},L={get:function(C){return[y,new rt(C.key)]},getMany:function(C){return[y,new rt().addKeys(C.keys)]},count:w,query:w,openCursor:w};return c(L).forEach(function(C){P[C]=function(D){var R=te.subscr,k=!!R,$=Al(te,h)&&Tl(C,D)?D.obsSet={}:R;if(k){var A=function(U){return U="idb://".concat(s,"/").concat(f,"/").concat(U),$[U]||($[U]=new rt)},M=A(""),N=A(":dels"),R=L[C](D),k=R[0],R=R[1];if((C==="query"&&k.isPrimaryKey&&!D.values?N:A(k.name||"")).add(R),!k.isPrimaryKey){if(C!=="count"){var q=C==="query"&&x&&D.values&&h.query(n(n({},D),{values:!1}));return h[C].apply(this,arguments).then(function(U){if(C==="query"){if(x&&D.values)return q.then(function(ue){return ue=ue.result,M.addKeys(ue),U});var z=D.values?U.result.map(b):U.result;(D.values?M:N).addKeys(z)}else if(C==="openCursor"){var K=U,Y=D.values;return K&&Object.create(K,{key:{get:function(){return N.addKey(K.primaryKey),K.key}},primaryKey:{get:function(){var ue=K.primaryKey;return N.addKey(ue),ue}},value:{get:function(){return Y&&M.addKey(K.primaryKey),K.value}}})}return U})}N.add(l)}}return h[C].apply(this,arguments)}}),P}})}};function Ml(a,s,l){if(l.numFailures===0)return s;if(s.type==="deleteRange")return null;var f=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return l.numFailures===f?null:(s=n({},s),u(s.keys)&&(s.keys=s.keys.filter(function(h,v){return!(v in l.failures)})),"values"in s&&u(s.values)&&(s.values=s.values.filter(function(h,v){return!(v in l.failures)})),s)}function hc(a,s){return l=a,((f=s).lower===void 0||(f.lowerOpen?0<ve(l,f.lower):0<=ve(l,f.lower)))&&(a=a,(s=s).upper===void 0||(s.upperOpen?ve(a,s.upper)<0:ve(a,s.upper)<=0));var l,f}function Nl(a,s,L,f,h,v){if(!L||L.length===0)return a;var y=s.query.index,b=y.multiEntry,x=s.query.range,I=f.schema.primaryKey.extractKey,P=y.extractKey,w=(y.lowLevelIndex||y).extractKey,L=L.reduce(function(C,D){var R=C,k=[];if(D.type==="add"||D.type==="put")for(var $=new rt,A=D.values.length-1;0<=A;--A){var M,N=D.values[A],q=I(N);$.hasKey(q)||(M=P(N),(b&&u(M)?M.some(function(K){return hc(K,x)}):hc(M,x))&&($.addKey(q),k.push(N)))}switch(D.type){case"add":var H=new rt().addKeys(s.values?C.map(function(Y){return I(Y)}):C),R=C.concat(s.values?k.filter(function(Y){return Y=I(Y),!H.hasKey(Y)&&(H.addKey(Y),!0)}):k.map(function(Y){return I(Y)}).filter(function(Y){return!H.hasKey(Y)&&(H.addKey(Y),!0)}));break;case"put":var F=new rt().addKeys(D.values.map(function(Y){return I(Y)}));R=C.filter(function(Y){return!F.hasKey(s.values?I(Y):Y)}).concat(s.values?k:k.map(function(Y){return I(Y)}));break;case"delete":var U=new rt().addKeys(D.keys);R=C.filter(function(Y){return!U.hasKey(s.values?I(Y):Y)});break;case"deleteRange":var z=D.range;R=C.filter(function(Y){return!hc(I(Y),z)})}return R},a);return L===a?a:(L.sort(function(C,D){return ve(w(C),w(D))||ve(I(C),I(D))}),s.limit&&s.limit<1/0&&(L.length>s.limit?L.length=s.limit:a.length===s.limit&&L.length<s.limit&&(h.dirty=!0)),v?Object.freeze(L):L)}function Bl(a,s){return ve(a.lower,s.lower)===0&&ve(a.upper,s.upper)===0&&!!a.lowerOpen==!!s.lowerOpen&&!!a.upperOpen==!!s.upperOpen}function mm(a,s){return function(l,f,h,v){if(l===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=ve(l,f))===0){if(h&&v)return 0;if(h)return 1;if(v)return-1}return f}(a.lower,s.lower,a.lowerOpen,s.lowerOpen)<=0&&0<=function(l,f,h,v){if(l===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=ve(l,f))===0){if(h&&v)return 0;if(h)return-1;if(v)return 1}return f}(a.upper,s.upper,a.upperOpen,s.upperOpen)}function vm(a,s,l,f){a.subscribers.add(l),f.addEventListener("abort",function(){var h,v;a.subscribers.delete(l),a.subscribers.size===0&&(h=a,v=s,setTimeout(function(){h.subscribers.size===0&&Ne(v,h)},3e3))})}var gm={stack:"dbcore",level:0,name:"Cache",create:function(a){var s=a.schema.name;return n(n({},a),{transaction:function(l,f,h){var v,y,b=a.transaction(l,f,h);return f==="readwrite"&&(y=(v=new AbortController).signal,h=function(x){return function(){if(v.abort(),f==="readwrite"){for(var I=new Set,P=0,w=l;P<w.length;P++){var L=w[P],C=nn["idb://".concat(s,"/").concat(L)];if(C){var D=a.table(L),R=C.optimisticOps.filter(function(Y){return Y.trans===b});if(b._explicit&&x&&b.mutatedParts)for(var k=0,$=Object.values(C.queries.query);k<$.length;k++)for(var A=0,M=(H=$[k]).slice();A<M.length;A++)oc((F=M[A]).obsSet,b.mutatedParts)&&(Ne(H,F),F.subscribers.forEach(function(Y){return I.add(Y)}));else if(0<R.length){C.optimisticOps=C.optimisticOps.filter(function(Y){return Y.trans!==b});for(var N=0,q=Object.values(C.queries.query);N<q.length;N++)for(var H,F,U,z=0,K=(H=q[N]).slice();z<K.length;z++)(F=K[z]).res!=null&&b.mutatedParts&&(x&&!F.dirty?(U=Object.isFrozen(F.res),U=Nl(F.res,F.req,R,D,F,U),F.dirty?(Ne(H,F),F.subscribers.forEach(function(Y){return I.add(Y)})):U!==F.res&&(F.res=U,F.promise=V.resolve({result:U}))):(F.dirty&&Ne(H,F),F.subscribers.forEach(function(Y){return I.add(Y)})))}}}I.forEach(function(Y){return Y()})}}},b.addEventListener("abort",h(!1),{signal:y}),b.addEventListener("error",h(!1),{signal:y}),b.addEventListener("complete",h(!0),{signal:y})),b},table:function(l){var f=a.table(l),h=f.schema.primaryKey;return n(n({},f),{mutate:function(v){var y=te.trans;if(h.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return f.mutate(v);var b=nn["idb://".concat(s,"/").concat(l)];return b?(y=f.mutate(v),v.type!=="add"&&v.type!=="put"||!(50<=v.values.length||fc(h,v).some(function(x){return x==null}))?(b.optimisticOps.push(v),v.mutatedParts&&vo(v.mutatedParts),y.then(function(x){0<x.numFailures&&(Ne(b.optimisticOps,v),(x=Ml(0,v,x))&&b.optimisticOps.push(x),v.mutatedParts&&vo(v.mutatedParts))}),y.catch(function(){Ne(b.optimisticOps,v),v.mutatedParts&&vo(v.mutatedParts)})):y.then(function(x){var I=Ml(0,n(n({},v),{values:v.values.map(function(P,w){var L;return x.failures[w]?P:(P=(L=h.keyPath)!==null&&L!==void 0&&L.includes(".")?be(P):n({},P),ne(P,h.keyPath,x.results[w]),P)})}),x);b.optimisticOps.push(I),queueMicrotask(function(){return v.mutatedParts&&vo(v.mutatedParts)})}),y):f.mutate(v)},query:function(v){if(!Al(te,f)||!Tl("query",v))return f.query(v);var y=((I=te.trans)===null||I===void 0?void 0:I.db._options.cache)==="immutable",w=te,b=w.requery,x=w.signal,I=function(D,R,k,$){var A=nn["idb://".concat(D,"/").concat(R)];if(!A)return[];if(!(R=A.queries[k]))return[null,!1,A,null];var M=R[($.query?$.query.index.name:null)||""];if(!M)return[null,!1,A,null];switch(k){case"query":var N=M.find(function(q){return q.req.limit===$.limit&&q.req.values===$.values&&Bl(q.req.query.range,$.query.range)});return N?[N,!0,A,M]:[M.find(function(q){return("limit"in q.req?q.req.limit:1/0)>=$.limit&&(!$.values||q.req.values)&&mm(q.req.query.range,$.query.range)}),!1,A,M];case"count":return N=M.find(function(q){return Bl(q.req.query.range,$.query.range)}),[N,!!N,A,M]}}(s,l,"query",v),P=I[0],w=I[1],L=I[2],C=I[3];return P&&w?P.obsSet=v.obsSet:(w=f.query(v).then(function(D){var R=D.result;if(P&&(P.res=R),y){for(var k=0,$=R.length;k<$;++k)Object.freeze(R[k]);Object.freeze(R)}else D.result=be(R);return D}).catch(function(D){return C&&P&&Ne(C,P),Promise.reject(D)}),P={obsSet:v.obsSet,promise:w,subscribers:new Set,type:"query",req:v,dirty:!1},C?C.push(P):(C=[P],(L=L||(nn["idb://".concat(s,"/").concat(l)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[v.query.index.name||""]=C)),vm(P,C,b,x),P.promise.then(function(D){return{result:Nl(D.result,v,L==null?void 0:L.optimisticOps,f,P,y)}})}})}})}};function yo(a,s){return new Proxy(a,{get:function(l,f,h){return f==="db"?s:Reflect.get(l,f,h)}})}var ar=(qe.prototype.version=function(a){if(isNaN(a)||a<.1)throw new ie.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new ie.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var s=this._versions,l=s.filter(function(f){return f._cfg.version===a})[0];return l||(l=new this.Version(a),s.push(l),s.sort(om),l.stores({}),this._state.autoSchema=!1,l)},qe.prototype._whenReady=function(a){var s=this;return this.idbdb&&(this._state.openComplete||te.letThrough||this._vip)?a():new V(function(l,f){if(s._state.openComplete)return f(new ie.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void f(new ie.DatabaseClosed);s.open().catch(_e)}s._state.dbReadyPromise.then(l,f)}).then(a)},qe.prototype.use=function(a){var s=a.stack,l=a.create,f=a.level,h=a.name;return h&&this.unuse({stack:s,name:h}),a=this._middlewares[s]||(this._middlewares[s]=[]),a.push({stack:s,create:l,level:f??10,name:h}),a.sort(function(v,y){return v.level-y.level}),this},qe.prototype.unuse=function(a){var s=a.stack,l=a.name,f=a.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return f?h.create!==f:!!l&&h.name!==l})),this},qe.prototype.open=function(){var a=this;return en(kr,function(){return lm(a)})},qe.prototype._close=function(){var a=this._state,s=Mn.indexOf(this);if(0<=s&&Mn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new V(function(l){a.dbReadyResolve=l}),a.openCanceller=new V(function(l,f){a.cancelOpen=f}))},qe.prototype.close=function(l){var s=(l===void 0?{disableAutoOpen:!0}:l).disableAutoOpen,l=this._state;s?(l.isBeingOpened&&l.cancelOpen(new ie.DatabaseClosed),this._close(),l.autoOpen=!1,l.dbOpenError=new ie.DatabaseClosed):(this._close(),l.autoOpen=this._options.autoOpen||l.isBeingOpened,l.openComplete=!1,l.dbOpenError=null)},qe.prototype.delete=function(a){var s=this;a===void 0&&(a={disableAutoOpen:!0});var l=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new V(function(h,v){function y(){s.close(a);var b=s._deps.indexedDB.deleteDatabase(s.name);b.onsuccess=Ae(function(){var x,I,P;x=s._deps,I=s.name,P=x.indexedDB,x=x.IDBKeyRange,nc(P)||I===ro||rc(P,x).delete(I).catch(_e),h()}),b.onerror=Qt(v),b.onblocked=s._fireOnBlocked}if(l)throw new ie.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(y):y()})},qe.prototype.backendDB=function(){return this.idbdb},qe.prototype.isOpen=function(){return this.idbdb!==null},qe.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},qe.prototype.hasFailed=function(){return this._state.dbOpenError!==null},qe.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(qe.prototype,"tables",{get:function(){var a=this;return c(this._allTables).map(function(s){return a._allTables[s]})},enumerable:!1,configurable:!0}),qe.prototype.transaction=function(){var a=(function(s,l,f){var h=arguments.length;if(h<2)throw new ie.InvalidArgument("Too few arguments");for(var v=new Array(h-1);--h;)v[h-1]=arguments[h];return f=v.pop(),[s,xe(v),f]}).apply(this,arguments);return this._transaction.apply(this,a)},qe.prototype._transaction=function(a,s,l){var f=this,h=te.trans;h&&h.db===this&&a.indexOf("!")===-1||(h=null);var v,y,b=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(y=s.map(function(I){if(I=I instanceof f.Table?I.name:I,typeof I!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return I}),a=="r"||a===Hs)v=Hs;else{if(a!="rw"&&a!=zs)throw new ie.InvalidArgument("Invalid transaction mode: "+a);v=zs}if(h){if(h.mode===Hs&&v===zs){if(!b)throw new ie.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&y.forEach(function(I){if(h&&h.storeNames.indexOf(I)===-1){if(!b)throw new ie.SubTransaction("Table "+I+" not included in parent transaction.");h=null}}),b&&h&&!h.active&&(h=null)}}catch(I){return h?h._promise(null,function(P,w){w(I)}):Be(I)}var x=(function I(P,w,L,C,D){return V.resolve().then(function(){var R=te.transless||te,k=P._createTransaction(w,L,P._dbSchema,C);if(k.explicit=!0,R={trans:k,transless:R},C)k.idbtrans=C.idbtrans;else try{k.create(),k.idbtrans._explicit=!0,P._state.PR1398_maxLoop=3}catch(M){return M.name===As.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return I(P,w,L,null,D)})):Be(M)}var $,A=$e(D);return A&&Tn(),R=V.follow(function(){var M;($=D.call(k,k))&&(A?(M=Or.bind(null,null),$.then(M,M)):typeof $.next=="function"&&typeof $.throw=="function"&&($=lc($)))},R),($&&typeof $.then=="function"?V.resolve($).then(function(M){return k.active?M:Be(new ie.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):R.then(function(){return $})).then(function(M){return C&&k._resolve(),k._completion.then(function(){return M})}).catch(function(M){return k._reject(M),Be(M)})})}).bind(null,this,v,y,h,l);return h?h._promise(v,x,"lock"):te.trans?en(te.transless,function(){return f._whenReady(x)}):this._whenReady(x)},qe.prototype.table=function(a){if(!g(this._allTables,a))throw new ie.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},qe);function qe(a,s){var l=this;this._middlewares={},this.verno=0;var f=qe.dependencies;this._options=s=n({addons:qe.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},f=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,v,y,b,x,I={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:_e,dbReadyPromise:null,cancelOpen:_e,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};I.dbReadyPromise=new V(function(w){I.dbReadyResolve=w}),I.openCanceller=new V(function(w,L){I.cancelOpen=L}),this._state=I,this.name=a,this.on=ji(this,"populate","blocked","versionchange","close",{ready:[Ts,_e]}),this.on.ready.subscribe=G(this.on.ready.subscribe,function(w){return function(L,C){qe.vip(function(){var D,R=l._state;R.openComplete?(R.dbOpenError||V.resolve().then(L),C&&w(L)):R.onReadyBeingFired?(R.onReadyBeingFired.push(L),C&&w(L)):(w(L),D=l,C||w(function k(){D.on.ready.unsubscribe(L),D.on.ready.unsubscribe(k)}))})}}),this.Collection=(h=this,Ui(Zp.prototype,function($,k){this.db=h;var C=ml,D=null;if(k)try{C=k()}catch(A){D=A}var R=$._ctx,k=R.table,$=k.hook.reading.fire;this._ctx={table:k,index:R.index,isPrimKey:!R.index||k.schema.primKey.keyPath&&R.index===k.schema.primKey.name,range:C,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:D,or:R.or,valueMapper:$!==Mi?$:null}})),this.Table=(v=this,Ui(bl.prototype,function(w,L,C){this.db=v,this._tx=C,this.name=w,this.schema=L,this.hook=v._allTables[w]?v._allTables[w].hook:ji(null,{creating:[Hp,_e],reading:[Kp,Mi],updating:[Wp,_e],deleting:[zp,_e]})})),this.Transaction=(y=this,Ui(rm.prototype,function(w,L,C,D,R){var k=this;this.db=y,this.mode=w,this.storeNames=L,this.schema=C,this.chromeTransactionDurability=D,this.idbtrans=null,this.on=ji(this,"complete","error","abort"),this.parent=R||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new V(function($,A){k._resolve=$,k._reject=A}),this._completion.then(function(){k.active=!1,k.on.complete.fire()},function($){var A=k.active;return k.active=!1,k.on.error.fire($),k.parent?k.parent._reject($):A&&k.idbtrans&&k.idbtrans.abort(),Be($)})})),this.Version=(b=this,Ui(um.prototype,function(w){this.db=b,this._cfg={version:w,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(x=this,Ui(xl.prototype,function(w,L,C){if(this.db=x,this._ctx={table:w,index:L===":id"?null:L,or:C},this._cmp=this._ascending=ve,this._descending=function(D,R){return ve(R,D)},this._max=function(D,R){return 0<ve(D,R)?D:R},this._min=function(D,R){return ve(D,R)<0?D:R},this._IDBKeyRange=x._deps.IDBKeyRange,!this._IDBKeyRange)throw new ie.MissingAPI})),this.on("versionchange",function(w){0<w.newVersion?console.warn("Another connection wants to upgrade database '".concat(l.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(l.name,"'. Closing db now to resume the delete request.")),l.close({disableAutoOpen:!1})}),this.on("blocked",function(w){!w.newVersion||w.newVersion<w.oldVersion?console.warn("Dexie.delete('".concat(l.name,"') was blocked")):console.warn("Upgrade '".concat(l.name,"' blocked by other connection holding version ").concat(w.oldVersion/10))}),this._maxKey=Wi(s.IDBKeyRange),this._createTransaction=function(w,L,C,D){return new l.Transaction(w,L,C,l._options.chromeTransactionDurability,D)},this._fireOnBlocked=function(w){l.on("blocked").fire(w),Mn.filter(function(L){return L.name===l.name&&L!==l&&!L._state.vcFired}).map(function(L){return L.on("versionchange").fire(w)})},this.use(hm),this.use(gm),this.use(pm),this.use(dm),this.use(fm);var P=new Proxy(this,{get:function(w,L,C){if(L==="_vip")return!0;if(L==="table")return function(R){return yo(l.table(R),P)};var D=Reflect.get(w,L,C);return D instanceof bl?yo(D,P):L==="tables"?D.map(function(R){return yo(R,P)}):L==="_createTransaction"?function(){return yo(D.apply(this,arguments),P)}:D}});this.vip=P,f.forEach(function(w){return w(l)})}var bo,kt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",ym=(pc.prototype.subscribe=function(a,s,l){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:s,complete:l})},pc.prototype[kt]=function(){return this},pc);function pc(a){this._subscribe=a}try{bo={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{bo={indexedDB:null,IDBKeyRange:null}}function ql(a){var s,l=!1,f=new ym(function(h){var v=$e(a),y,b=!1,x={},I={},P={get closed(){return b},unsubscribe:function(){b||(b=!0,y&&y.abort(),w&&Lr.storagemutated.unsubscribe(C))}};h.start&&h.start(P);var w=!1,L=function(){return Ks(D)},C=function(R){mo(x,R),oc(I,x)&&L()},D=function(){var R,k,$;!b&&bo.indexedDB&&(x={},R={},y&&y.abort(),y=new AbortController,$=function(A){var M=$n();try{v&&Tn();var N=Dr(a,A);return N=v?N.finally(Or):N}finally{M&&An()}}(k={subscr:R,signal:y.signal,requery:L,querier:a,trans:null}),Promise.resolve($).then(function(A){l=!0,s=A,b||k.signal.aborted||(x={},function(M){for(var N in M)if(g(M,N))return;return 1}(I=R)||w||(Lr(zi,C),w=!0),Ks(function(){return!b&&h.next&&h.next(A)}))},function(A){l=!1,["DatabaseClosedError","AbortError"].includes(A==null?void 0:A.name)||b||Ks(function(){b||h.error&&h.error(A)})}))};return setTimeout(L,0),P});return f.hasValue=function(){return l},f.getValue=function(){return s},f}var an=ar;function mc(a){var s=$r;try{$r=!0,Lr.storagemutated.fire(a),uc(a,!0)}finally{$r=s}}S(an,n(n({},Va),{delete:function(a){return new an(a,{addons:[]}).delete()},exists:function(a){return new an(a,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return s=an.dependencies,l=s.indexedDB,s=s.IDBKeyRange,(nc(l)?Promise.resolve(l.databases()).then(function(f){return f.map(function(h){return h.name}).filter(function(h){return h!==ro})}):rc(l,s).toCollection().primaryKeys()).then(a)}catch{return Be(new ie.MissingAPI)}var s,l},defineClass:function(){return function(a){d(this,a)}},ignoreTransaction:function(a){return te.trans?en(te.transless,a):a()},vip:ic,async:function(a){return function(){try{var s=lc(a.apply(this,arguments));return s&&typeof s.then=="function"?s:V.resolve(s)}catch(l){return Be(l)}}},spawn:function(a,s,l){try{var f=lc(a.apply(l,s||[]));return f&&typeof f.then=="function"?f:V.resolve(f)}catch(h){return Be(h)}},currentTransaction:{get:function(){return te.trans||null}},waitFor:function(a,s){return s=V.resolve(typeof a=="function"?an.ignoreTransaction(a):a).timeout(s||6e4),te.trans?te.trans.waitFor(s):s},Promise:V,debug:{get:function(){return Vt},set:function(a){cl(a)}},derive:O,extend:d,props:S,override:G,Events:ji,on:Lr,liveQuery:ql,extendObservabilitySet:mo,getByKeyPath:Z,setByKeyPath:ne,delByKeyPath:function(a,s){typeof s=="string"?ne(a,s,void 0):"length"in s&&[].map.call(s,function(l){ne(a,l,void 0)})},shallowClone:he,deepClone:be,getObjectDiff:dc,cmp:ve,asap:ae,minKey:-1/0,addons:[],connections:Mn,errnames:As,dependencies:bo,cache:nn,semVer:"4.0.10",version:"4.0.10".split(".").map(function(a){return parseInt(a)}).reduce(function(a,s,l){return a+s/Math.pow(10,2*l)})})),an.maxKey=Wi(an.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Lr(zi,function(a){$r||(a=new CustomEvent(Gs,{detail:a}),$r=!0,dispatchEvent(a),$r=!1)}),addEventListener(Gs,function(a){a=a.detail,$r||mc(a)}));var qn,$r=!1,Fl=function(){};return typeof BroadcastChannel<"u"&&((Fl=function(){(qn=new BroadcastChannel(Gs)).onmessage=function(a){return a.data&&mc(a.data)}})(),typeof qn.unref=="function"&&qn.unref(),Lr(zi,function(a){$r||qn.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!ar.disableBfCache&&a.persisted){Vt&&console.debug("Dexie: handling persisted pagehide"),qn!=null&&qn.close();for(var s=0,l=Mn;s<l.length;s++)l[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!ar.disableBfCache&&a.persisted&&(Vt&&console.debug("Dexie: handling persisted pageshow"),Fl(),mc({all:new rt(-1/0,[[]])}))})),V.rejectionMapper=function(a,s){return!a||a instanceof me||a instanceof TypeError||a instanceof SyntaxError||!a.name||!sl[a.name]?a:(s=new sl[a.name](s||a.message,a),"stack"in a&&E(s,"stack",{get:function(){return this.inner.stack}}),s)},cl(Vt),n(ar,Object.freeze({__proto__:null,Dexie:ar,liveQuery:ql,Entity:vl,cmp:ve,PropModSymbol:ir,PropModification:Ki,replacePrefix:function(a,s){return new Ki({replacePrefix:[a,s]})},add:function(a){return new Ki({add:a})},remove:function(a){return new Ki({remove:a})},default:ar,RangeSet:rt,mergeRanges:Gi,rangesOverlap:Ol}),{default:ar}),ar})}(Ao)),Ao.exports}var m_=p_();const mu=f_(m_),Ld=Symbol.for("Dexie"),es=globalThis[Ld]||(globalThis[Ld]=mu);if(mu.semVer!==es.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${mu.semVer} and ${es.semVer}`);const{liveQuery:CE,mergeRanges:IE,rangesOverlap:kE,RangeSet:DE,cmp:OE,Entity:PE,PropModSymbol:RE,PropModification:LE,replacePrefix:$E,add:AE,remove:TE}=es;var ts="docs",v_="changes",$d="attachments",wp="dexie",Ad=new Map,To=new Map;function g_(e,t,r,n){var i="rxdb-dexie-"+e+"--"+n.version+"--"+t,o=Ut(Ad,i,()=>{var c=(async()=>{var u=Me(r);u.autoOpen=!1;var d=new es(i,u);r.onCreate&&await r.onCreate(d,i);var p={[ts]:w_(n),[v_]:"++sequence, id",[$d]:"id"};return d.version(1).stores(p),await d.open(),{dexieDb:d,dexieTable:d[ts],dexieAttachmentsTable:d[$d],booleanIndexes:__(n)}})();return Ad.set(i,o),To.set(o,0),c});return o}async function y_(e){var t=await e,r=To.get(e),n=r-1;n===0?(t.dexieDb.close(),To.delete(e)):To.set(e,n)}var vu="__";function Ai(e){var t=e.split(".");if(t.length>1)return t.map(n=>Ai(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return vu+r}else return e}function _p(e){var t=e.split(".");if(t.length>1)return t.map(n=>_p(n)).join(".");if(e.startsWith(vu)){var r=e.substring(vu.length);return"|"+r}else return e}function b_(e,t){if(!t)return t;var r=Me(t);return r=gu(r),e.forEach(n=>{var i=Wr(t,n),o=i?"1":"0",c=Ai(n);_f(r,c,o)}),r}function Sp(e,t){return t&&(t=Me(t),t=yu(t),e.forEach(r=>{var n=Wr(t,r),i=n==="1";_f(t,r,i)}),t)}function gu(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>gu(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=gu(n)),t[Ai(r)]=n}),t}}function yu(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>yu(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=yu(n)),t[_p(r)]=n}),t}}function w_(e){var t=[],r=Et(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(o=>{var c=Du(o);t.push(c)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(o=>o.map(c=>Ai(c)));var n=t.map(o=>o.length===1?o[0]:"["+o.join("+")+"]");n=n.filter((o,c,u)=>u.indexOf(o)===c);var i=n.join(", ");return i}async function Td(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(i=>Sp(r.booleanIndexes,i))}function Eo(e,t){return e+"||"+t}function __(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var i=Du(n);i.forEach(o=>{if(!t.has(o)){t.add(o);var c=Si(e,o);c.type==="boolean"&&r.push(o)}})}),r.push("_deleted"),yv(r)):r}function Md(e){return e===Jn?-1/0:e}function Nd(e,t,r){if(e.includes(t)){var n=r===Yn||r===!0?"1":"0";return n}else return r}function Ep(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((c,u)=>{var d=t.index[u];return Nd(e,d,c)}).map(Md),i=t.endKeys.map((c,u)=>{var d=t.index[u];return Nd(e,d,c)}).map(Md),o=r.bound(n,i,!t.inclusiveStart,!t.inclusiveEnd);return o}async function Bd(e,t){var r=await e.internals,n=t.query,i=n.skip?n.skip:0,o=n.limit?n.limit:1/0,c=i+o,u=t.queryPlan,d=!1;u.selectorSatisfiedByIndex||(d=Uu(e.schema,t.query));var p=Ep(r.booleanIndexes,u,r.dexieDb._options.IDBKeyRange),m=u.index,g=[];if(await r.dexieDb.transaction("r",r.dexieTable,async _=>{var E=_.idbtrans,O=E.objectStore(ts),T,B;B="["+m.map(G=>Ai(G)).join("+")+"]",T=O.index(B);var j=T.openCursor(p);await new Promise(G=>{j.onsuccess=function(ce){var ae=ce.target.result;if(ae){var Z=Sp(r.booleanIndexes,ae.value);(!d||d(Z))&&g.push(Z),u.sortSatisfiedByIndex&&g.length===c?G():ae.continue()}else G()}})}),!u.sortSatisfiedByIndex){var S=Th(e.schema,t.query);g=g.sort(S)}return g=g.slice(i,c),{documents:g}}async function S_(e,t){var r=await e.internals,n=t.queryPlan,i=n.index,o=Ep(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),c=-1;return await r.dexieDb.transaction("r",r.dexieTable,async u=>{var d=u.idbtrans,p=d.objectStore(ts),m,g;g="["+i.map(_=>Ai(_)).join("+")+"]",m=p.index(g);var S=m.count(o);c=await new Promise((_,E)=>{S.onsuccess=function(){_(S.result)},S.onerror=O=>E(O)})}),c}var E_=St(),Ac=!1,x_=function(){function e(r,n,i,o,c,u,d,p){this.changes$=new Lt,this.instanceId=E_++,this.storage=r,this.databaseName=n,this.collectionName=i,this.schema=o,this.internals=c,this.options=u,this.settings=d,this.devMode=p,this.primaryPath=Et(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,i){sn(this),!Ac&&!await Ef()&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium/?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),Ac=!0,n.forEach(m=>{if(!m.document._rev||m.previous&&!m.previous._rev)throw X("SNH",{args:{row:m}})});var o=await this.internals,c={error:[]};this.devMode&&(n=n.map(m=>{var g=Ha(m.document);return{previous:m.previous,document:g}}));var u=n.map(m=>m.document[this.primaryPath]),d;if(await o.dexieDb.transaction("rw",o.dexieTable,o.dexieAttachmentsTable,async()=>{var m=new Map,g=await Td(this.internals,u);g.forEach(E=>{var O=E;return O&&m.set(O[this.primaryPath],O),O}),d=tb(this,this.primaryPath,m,n,i),c.error=d.errors;var S=[];d.bulkInsertDocs.forEach(E=>{S.push(E.document)}),d.bulkUpdateDocs.forEach(E=>{S.push(E.document)}),S=S.map(E=>b_(o.booleanIndexes,E)),S.length>0&&await o.dexieTable.bulkPut(S);var _=[];d.attachmentsAdd.forEach(E=>{_.push({id:Eo(E.documentId,E.attachmentId),data:E.attachmentData.data})}),d.attachmentsUpdate.forEach(E=>{_.push({id:Eo(E.documentId,E.attachmentId),data:E.attachmentData.data})}),await o.dexieAttachmentsTable.bulkPut(_),await o.dexieAttachmentsTable.bulkDelete(d.attachmentsRemove.map(E=>Eo(E.documentId,E.attachmentId)))}),d=le(d),d.eventBulk.events.length>0){var p=le(d.newestRow).document;d.eventBulk.checkpoint={id:p[this.primaryPath],lwt:p._meta.lwt},this.changes$.next(d.eventBulk)}return c},t.findDocumentsById=async function(n,i){sn(this);var o=await this.internals,c=[];return await o.dexieDb.transaction("r",o.dexieTable,async()=>{var u=await Td(this.internals,n);u.forEach(d=>{d&&(!d._deleted||i)&&c.push(d)})}),c},t.query=function(n){return sn(this),Bd(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var i=await S_(this,n);return{count:i,mode:"fast"}}else{var o=await Bd(this,n);return{count:o.documents.length,mode:"slow"}}},t.changeStream=function(){return sn(this),this.changes$.asObservable()},t.cleanup=async function(n){sn(this);var i=await this.internals;return await i.dexieDb.transaction("rw",i.dexieTable,async()=>{var o=St()-n,c=await i.dexieTable.where("_meta.lwt").below(o).toArray(),u=[];c.forEach(d=>{d._deleted==="1"&&u.push(d[this.primaryPath])}),await i.dexieTable.bulkDelete(u)}),!0},t.getAttachmentData=async function(n,i,o){sn(this);var c=await this.internals,u=Eo(n,i);return await c.dexieDb.transaction("r",c.dexieAttachmentsTable,async()=>{var d=await c.dexieAttachmentsTable.get(u);if(d)return d.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+i)})},t.remove=async function(){sn(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await y_(this.internals)})(),this.closed)},e}();async function C_(e,t,r){var n=g_(t.databaseName,t.collectionName,r,t.schema),i=new x_(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await l_(wp,t,i),Promise.resolve(i)}function sn(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var I_=function(){function e(r){this.name=wp,this.rxdbVersion=Sf,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){if(ib(n),n.schema.indexes){var i=n.schema.indexes.flat();i.filter(o=>!o.includes(".")).forEach(o=>{if(!n.schema.required||!n.schema.required.includes(o))throw X("DXE1",{field:o,schema:n.schema})})}return C_(this,n,this.settings)},e}();function xp(e={}){var t=new I_(e);return t}var k_=["__proto__","constructor","prototype"];function ea(e,t){Object.keys(t).forEach(r=>{k_.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:aa(t[r])?ea(e[r],t[r]):e[r]=t[r])})}function aa(e){return e.toString()==="[object Object]"}var Os=function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var i=this;r.selector&&i.find(r.selector),r.limit&&i.limit(r.limit),r.skip&&i.skip(r.skip),r.sort&&r.sort.forEach(o=>i.sort(o))}}var t=e.prototype;return t.where=function(n,i){if(!arguments.length)return this;var o=typeof arguments[0];if(o==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(o==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw Ot("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var i=this._path;return this._conditions[i]=n,this},t.eq=function(n){this._ensurePath("eq");var i=this._path;return this._conditions[i]=n,this},t.or=function(n){var i=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.nor=function(n){var i=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.and=function(n){var i=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.mod=function(n,i){var o,c;arguments.length===1?(this._ensurePath("mod"),o=arguments[0],c=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),o=arguments.slice(),c=this._path):arguments.length===3?(o=arguments.slice(1),c=arguments[0]):(o=arguments[1],c=arguments[0]);var u=this._conditions[c]||(this._conditions[c]={});return u.$mod=o,this},t.exists=function(n,i){var o,c;arguments.length===0?(this._ensurePath("exists"),o=this._path,c=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),o=this._path,c=arguments[0]):(o=arguments[0],c=!0):arguments.length===2&&(o=arguments[0],c=arguments[1]);var u=this._conditions[o]||(this._conditions[o]={});return u.$exists=c,this},t.elemMatch=function(n,i){if(arguments[0]===null)throw Ot("MQ2");var o,c,u;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),c=this._path,o=arguments[0];else if(aa(arguments[0]))this._ensurePath("elemMatch"),c=this._path,u=arguments[0];else if(typeof arguments[1]=="function")c=arguments[0],o=arguments[1];else if(arguments[1]&&aa(arguments[1]))c=arguments[0],u=arguments[1];else throw Ot("MQ2");o&&(u=new e,o(u),u=u._conditions);var d=this._conditions[c]||(this._conditions[c]={});return d.$elemMatch=u,this},t.sort=function(n){if(!n)return this;var i,o=typeof n;if(Array.isArray(n)){i=n.length;for(var c=0;c<n.length;++c)O_(this.options,n[c][0],n[c][1]);return this}if(arguments.length===1&&o==="string"){n=n.split(/\s+/),i=n.length;for(var u=0;u<i;++u){var d=n[u];if(d){var p=d[0]==="-"?-1:1;p===-1&&(d=d.substring(1)),qd(this.options,d,p)}}return this}if(aa(n)){var m=Object.keys(n);return m.forEach(g=>qd(this.options,g,n[g])),this}throw Ot("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!Fd(n))throw Ot("MQ4",{source:n});return n instanceof e?(n._conditions&&ea(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),ea(this._fields,n._fields)),n.options&&(this.options||(this.options={}),ea(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(ea(this._conditions,n),this)},t.find=function(n){return Fd(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw X("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=D_(this.options.sort)),{query:n,path:this._path}},e}();function D_(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",i={[t]:n};return i})}var Cp=["limit","skip","maxScan","batchSize","comment"];Cp.forEach(function(e){Os.prototype[e]=function(t){return this.options[e]=t,this}});var Ip=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];Ip.forEach(function(e){Os.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw X("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function qd(e,t,r){if(Array.isArray(e.sort))throw Ot("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var i=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(i))throw Array.isArray(r)&&(r="["+r+"]"),Ot("MQ7",{field:t,value:r});var o=e.sort||(e.sort={}),c=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");o[t]=parseInt(c,10)}function O_(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw Ot("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function Fd(e){return e instanceof Os||aa(e)}function P_(e,t){return new Os(e,t)}var jd="queryBuilderPath";function R_(e,t,r){var n=P_(ut(e.mangoQuery),e.other[jd]);n[t](r);var i=n.toJSON();return Kn(e.op,i.query,e.collection,{...e.other,[jd]:i.path})}function Tc(e,t){e[t]=function(r){if(Se.isDevMode()&&this.op==="findByIds")throw X("QU17",{collection:this.collection.name,query:this.mangoQuery});return R_(this,t,r)}}var L_={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{Tc(e,t)}),Cp.forEach(t=>{Tc(e,t)}),Ip.forEach(t=>{Tc(e,t)})}}};async function kp(e){var t=Qv(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>Di(n,bn)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function $_(e,t,r){var n=Me(r._attachments),i=ut(r),o=i._meta;delete i._meta,i._attachments=n;for(var c=t+1,u=Promise.resolve(i),d=function(){var p=c;u=u.then(m=>A_(e,p,m)),c++};c<=e.schema.version;)d();return u.then(p=>p===null?Pu:(p._meta=o,p))}function A_(e,t,r){if(r===null)return Pu;var n=e.migrationStrategies[t](r,e),i=Iv(n);return i}async function Dp(e){if(e.collection.schema.version===0)return wr;var t=await kp(e);return!!t}var T_=200,Op=new WeakMap;function M_(e){var t=Pp(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function Pp(e){return Ut(Op,e,()=>new Ar([]))}function N_(e){var t=Op.get(e);t&&t.complete()}var B_=function(){function e(r,n,i=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=kv,this.collection=r,this.migrationStrategies=n,this.statusDocKey=i,this.database=r.database,this.oldCollectionMeta=kp(this),this.mustMigrate=Dp(this),this.statusDocId=Di(this.statusDocKey,Ro),M_(this),this.$=eb(this.database.internalStore,this.statusDocId).pipe(ke(o=>!!o),Ue(o=>le(o).data),qa(Aa))}var t=e.prototype;return t.getStatus=function(){return yn(this.$)},t.startMigration=async function(n=T_){var i=await this.mustMigrate;if(i){if(this.started)throw X("DM1");this.started=!0;var o=void 0;if(this.database.multiInstance){o=new Ds(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var c=c_(o);await c.awaitLeadership()}var u=await this.oldCollectionMeta,d=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:u.data.schema,password:this.database.password,devMode:Se.isDevMode()}),p=await this.getConnectedStorageInstances(),m=await this.countAllDoucments([d].concat(p.map(g=>g.oldStorage)));await this.updateStatus(g=>(g.count.total=m,g));try{await Promise.all(p.map(async g=>{await Ew(this.collection,g.newStorage.collectionName,g.newStorage.schema),await this.migrateStorage(g.oldStorage,g.newStorage,n),await g.newStorage.close()})),await this.migrateStorage(d,this.collection.storageInstance.originalStorageInstance,n)}catch(g){await d.close(),await this.updateStatus(S=>(S.status="ERROR",S.error=$v(g),S));return}await Ia(this.database.internalStore,{previous:u,document:Object.assign({},u,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(g=>(g.status="DONE",g)),o&&await o.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var i=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var o=await Ka(this.database.internalStore,this.statusDocId),c=ut(o);o||(c={id:this.statusDocId,key:this.statusDocKey,context:Ro,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:Ri(),_rev:jt(),_attachments:{}});var u=le(c).data;for(var d of i)u=d(u);if(u.count.percent=Math.round(u.count.handled/u.count.total*100),c&&o&&ma(c.data,o.data))break;try{await Ia(this.database.internalStore,{previous:o,document:le(c)},Ro);break}catch(p){if(!ws(p))throw p}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,i,o){var c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:xd(n.schema,su(n.schema)),password:this.database.password,devMode:Se.isDevMode()}),u=Jw(i,Go,this.database.token,!0),d=Qw({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async m=>{m=await Promise.all(m.map(async S=>{var _=S.newDocumentState;if(i.schema.title===$o&&(_=S.newDocumentState.docData,S.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:S.newDocumentState};var E=await $_(this.collection,n.schema.version,_),O={assumedMasterState:void 0,newDocumentState:i.schema.title===$o?Object.assign({},S.newDocumentState,{docData:E}):E};return O})),m=m.filter(S=>!!S.newDocumentState);var g=await u.masterWrite(m);return g},masterChangeStream$:new Lt().asObservable()},forkInstance:n,metaInstance:c,pushBatchSize:o,pullBatchSize:0,conflictHandler:Go,hashFunction:this.database.hashFunction}),p=!1;if(d.events.error.subscribe(m=>p=m),d.events.processed.up.subscribe(()=>{this.updateStatus(m=>(m.count.handled=m.count.handled+1,m))}),await Gw(d),await Yw(d),await Xw(d),await this.updateStatusQueue,p)throw await c.close(),p;await Promise.all([n.remove(),c.remove()])},t.countAllDoucments=async function(n){var i=0;return await Promise.all(n.map(async o=>{var c=Cs(o.schema,Zn(o.schema,{selector:{}})),u=await o.count(c);i+=u.count})),i},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,i=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async o=>{if(o.schema.title!==$o)throw new Error("unknown migration handling for schema");var c=xd(ut(this.collection.schema.jsonSchema),su(o.schema));c.version=this.collection.schema.version;var[u,d]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Se.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:o.schema,password:this.database.password,collectionName:o.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Se.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:c,password:this.database.password,collectionName:o.collectionName})]);i.push({oldStorage:u,newStorage:d})}))),i},t.migratePromise=async function(n){this.startMigration(n);var i=await this.mustMigrate;if(!i)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var o=await Promise.race([yn(this.$.pipe(ke(c=>c.status==="DONE"))),yn(this.$.pipe(ke(c=>c.status==="ERROR")))]);if(o.status==="ERROR")throw X("DM4",{collection:this.collection.name,error:o.error});return o},e}(),q_=qh(),F_=function(e){function t(r,n,i){var o;return o=e.call(this,null,n)||this,o.id=r,o.parent=i,o}return Ru(t,e),t}(q_),oa={get isLocal(){return!0},get allAttachments$(){throw X("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=_i(bu,this.parent),r=this.primary;return e.parent.eventBulks$.pipe(ke(n=>!!n.isLocal),Ue(n=>n.events.find(i=>i.documentId===r)),ke(n=>!!n),Ue(n=>Gf(le(n))),Fa(t.docCache.getLatestDocumentData(this.primary)),ya((n,i)=>n._rev===i._rev),Ue(n=>t.docCache.getCachedRxDocument(n)),qa(Aa))},get $$(){var e=this,t=Mc(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=Mc(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=_i(bu,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw Ot("LD2",{objPath:e});var t=Wr(this._data,e);return t=Se.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,Se.isDevMode()){if(e.includes(".item."))throw X("LD3",{objPath:e});if(e===this.primaryPath)throw X("LD4")}return this.$.pipe(Ue(t=>t._data),Ue(t=>Wr(t,e)),ya())},get$$(e){var t=Mc(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await sa(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await sa(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(i=>{if(i.error[0])throw i.error[0];var o=Nt(this.collection.schema.primaryPath,n,i)[0];e=Me(e),e._rev=o._rev})},async remove(){var e=await sa(this.parent),t=Me(this._data);return t._deleted=!0,Ia(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},Ud=!1,j_=()=>{if(!Ud){Ud=!0;var e=Is,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var i=Object.getOwnPropertyDescriptor(oa,n);if(!i){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(oa,n,o)}});var r=n=>()=>{throw X("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>oa[n]=r(n))}};function U_(e,t){j_();var r=new F_(e.id,e,t);return Object.setPrototypeOf(r,oa),r.prototype=oa,r}function Mc(e){var t=e.parent;return jw(t)?t:t.database}var rs=new WeakMap,bu=new WeakMap;function Kd(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var i=await Rp(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);i=Ku(t,i,Lp);var o=new Wh("id",t.eventBulks$.pipe(ke(m=>{var g=!1;return(r===""&&!m.collectionName||r!==""&&m.collectionName===r)&&(g=!0),g&&m.isLocal}),Ue(m=>m.events)),m=>U_(m,e)),c=new Bh(i,"id",()=>{},()=>{}),u=await t.storageToken,d=i.changeStream().subscribe(m=>{for(var g=new Array(m.events.length),S=m.events,_=e.database?e.name:void 0,E=0;E<S.length;E++){var O=S[E];g[E]={documentId:O.documentId,collectionName:_,isLocal:!0,operation:O.operation,documentData:Se.deepFreezeWhenDevMode(O.documentData),previousDocumentData:Se.deepFreezeWhenDevMode(O.previousDocumentData)}}var T={id:m.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:u,events:g,databaseToken:t.token,checkpoint:m.checkpoint,context:m.context};t.$emit(T)});e._subs.push(d);var p={database:t,parent:e,storageInstance:i,docCache:o,incrementalWriteQueue:c};return bu.set(e,p),p})();rs.set(e,n)}function sa(e){var t=rs.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw X("LD8",{database:r.name,collection:n})}return t}function Rp(e,t,r,n,i,o){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:K_(n),schema:Lp,options:i,multiInstance:o,devMode:Se.isDevMode()})}function Hd(e){var t=rs.get(e);if(t)return rs.delete(e),t.then(r=>r.storageInstance.close())}async function zd(e,t,r){var n=$a(10),i=await Rp(n,e,t,r,{},!1);await i.remove()}function K_(e){return"plugin-local-documents-"+e}var Lp=_s({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function Wd(e,t){var r=await sa(this),n={id:e,data:t,_deleted:!1,_meta:Ri(),_rev:jt(),_attachments:{}};return Ia(r.storageInstance,{document:n},"local-document-insert").then(i=>r.docCache.getCachedRxDocument(i))}function Vd(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function Qd(e){var t=await sa(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):Ka(t.storageInstance,e).then(i=>i?t.docCache.getCachedRxDocument(i):null)}function Gd(e){return this.$.pipe(Fa(null),Sr(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),Sr(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),ke(t=>t.use),Ue(t=>t.doc))}var H_={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=Wd,e.upsertLocal=Vd,e.getLocal=Qd,e.getLocal$=Gd},RxDatabase:e=>{e.insertLocal=Wd,e.upsertLocal=Vd,e.getLocal=Qd,e.getLocal$=Gd}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&Kd(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&Kd(e.collection)}},preCloseRxDatabase:{after:e=>Hd(e)},postCloseRxCollection:{after:e=>Hd(e)},postRemoveRxDatabase:{after:e=>zd(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>zd(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},z_=new WeakMap,W_={name:"migration-schema",rxdb:!0,init(){Lo(H_)},hooks:{preCloseRxDatabase:{after:N_}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return Pp(this).pipe(qa(Aa))}},RxCollection:e=>{e.getMigrationState=function(){return Ut(z_,this,()=>new B_(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?wr:Dp(this.getMigrationState())}}}},V_=W_;const Ps=e=>lt((t,r,n)=>{let i=0;if(pe(r))for(const o of r)i=i|1<<o;else i=r;return e(t&i,i)}),Q_=Ps((e,t)=>e==0),G_=Ps((e,t)=>e==t),Y_=Ps((e,t)=>e<t),J_=Ps((e,t)=>e>0),X_=Object.freeze(Object.defineProperty({__proto__:null,$all:Jy,$and:yh,$bitsAllClear:Q_,$bitsAllSet:G_,$bitsAnyClear:Y_,$bitsAnySet:J_,$elemMatch:Rh,$eq:_h,$exists:$h,$expr:Qy,$gt:Sh,$gte:Eh,$in:xh,$jsonSchema:Gy,$lt:Ch,$lte:Ih,$mod:Oh,$ne:kh,$nin:Dh,$nor:bh,$not:wh,$or:ju,$regex:Ph,$size:Lh,$type:Ah,$where:Yy},Symbol.toStringTag,{value:"Module"})),dt={cloneMode:"copy",queryOptions:ah({context:Dn.init().addQueryOps(X_).addExpressionOps(Ny).addExpressionOps(zy)})},rl=(e,t)=>{switch(e){case"deep":return ki(t);case"copy":return Ci(t)?new Date(t):pe(t)?[...t]:Ke(t)?{...t}:pr(t)?new RegExp(t):t;default:return t}},Z_=/^[a-z]+[a-zA-Z0-9]*$/;function $p(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),i=e.substring(t+3,r);Ee(i===""||Z_.test(i),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const o=e.substring(r+2),[c,u]=o?$p(o):[];return[{selector:e,parent:n,child:i||"$",next:c},[i,...u||[]].filter(Boolean)]}const ht=(e,t,r,n,i)=>{const{parent:o,child:c,next:u}=t;if(!c){let p=!1;return Sa(e,o,(g,S)=>p=!!n(g,S)||p,i),p}const d=er(e,o);return pe(d)?d.map((p,m)=>r[c]&&!r[c].test({[c]:p})?!1:u?ht(p,u,r,n,i):n(d,m)).some(Boolean):!1};function Ct(e,t,r,n){const i=[];for(const[o,c]of Object.entries(e)){const[u,d]=$p(o);if(!d.length)n(c,u,{})&&i.push(u.parent);else{const p={};t.forEach(g=>{Object.keys(g).forEach(S=>{d.forEach(_=>{(S===_||S.startsWith(_+"."))&&(p[_]=p[_]||{},Object.assign(p[_],{[S]:g[S]}))})})});const m={};for(const[g,S]of Object.entries(p))m[g]=new Gr(S,r.queryOptions);n(c,u,m)&&i.push(u.parent)}}return i}const eS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>{const u={$each:[i]};return Ke(i)&&Ht(i,"$each")&&Object.assign(u,i),ht(e,o,c,(d,p)=>{const m=d[p]||(d[p]=[]);return th([m,u.$each]).length===u.$each.length?!1:(d[p]=rl(n.cloneMode,oy(m.concat(u.$each))),!0)},{buildGraph:!0})}),tS=new Set(["and","or","xor"]),rS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>{const u=Object.keys(i);return Ee(u.length===1&&tS.has(u[0]),`Invalid bit operator '${u[0]}'. Must be one of 'and', 'or', or 'xor'.`),ht(e,o,c,(d,p)=>{let m=d[p];const g=i[u[0]];if(m!==void 0&&!(Ge(m)&&Ge(g)))return!1;switch(m=m||0,u[0]){case"and":d[p]=m&g;break;case"or":d[p]=m|g;break;case"xor":d[p]=m^g;break}return d[p]!==m},{buildGraph:!0})}),nS=(e,t,r=[],n=dt)=>{const i=Date.now();return Ct(t,r,n,(o,c,u)=>ht(e,c,u,(d,p)=>(d[p]=i,!0),{buildGraph:!0}))},iS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>{if(!o.child){const u=er(e,o.parent);Ee(u===void 0||Ge(u),"cannot apply $inc to a value of non-numeric type")}return ht(e,o,c,(u,d)=>(u[d]=(u[d]||(u[d]=0))+i,!0),{buildGraph:!0})}),aS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>ht(e,o,c,(u,d)=>u[d]!==void 0&&Mt(u[d],i)>-1?!1:(u[d]=i,!0),{buildGraph:!0})),oS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>ht(e,o,c,(u,d)=>u[d]!==void 0&&Mt(u[d],i)<1?!1:(u[d]=i,!0),{buildGraph:!0})),sS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>ht(e,o,c,(u,d)=>{const p=u[d];return u[d]=u[d]===void 0?0:u[d]*i,u[d]!==p},{buildGraph:!0})),cS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>ht(e,o,c,(u,d)=>{const p=u[d];return Ee(pe(p),`path '${o.selector}' contains an element of non-array type.`),p.length?(i===-1?p.splice(0,1):p.pop(),!0):!1})),Ap=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>{const u=!Ke(i)||Object.keys(i).some(Qr),d=new Gr(u?{k:i}:i,n.queryOptions),p=u?m=>d.test({k:m}):m=>d.test(m);return ht(e,o,c,(m,g)=>{const S=m[g],_=new Array;return S.map(O=>{const T=p(O);return T||_.push(O),T}).some(Boolean)?(m[g]=_,!0):!1})}),uS=(e,t,r=[],n=dt)=>{const i={};return Object.entries(t).forEach(([o,c])=>{i[o]={$in:c}}),Ap(e,i,r,n)},lS=Object.freeze(["$each","$slice","$sort","$position"]),dS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>{const u={$each:[i]};return Ke(i)&&lS.some(d=>Ht(i,d))&&Object.assign(u,i),ht(e,o,c,(d,p)=>{const m=d[p]||(d[p]=[]),g=m.slice(0,u.$slice||m.length),S=m.length,_=Ge(u.$position)?u.$position:m.length;if(m.splice(_,0,...rl(n.cloneMode,u.$each)),u.$sort){const E=Ke(u.$sort)?Object.keys(u.$sort||{}).pop():"",O=E?u.$sort[E]:u.$sort,T=E?B=>er(B,E):B=>B;m.sort((B,j)=>O*Mt(T(B),T(j)))}return Ge(u.$slice)&&(u.$slice<0?m.splice(0,m.length+u.$slice):m.splice(u.$slice)),S!=m.length||!Ft(g,m)},{descendArray:!0,buildGraph:!0})}),Tp=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>ht(e,o,c,(u,d)=>Ft(u[d],i)?!1:(u[d]=rl(n.cloneMode,i),!0),{buildGraph:!0})),fS=(e,t,r=[],n=dt)=>{const i=[],o=Ct(t,r,n,(c,u,d)=>ht(e,u,d,(p,m)=>Ht(p,m)?(i.push(...Tp(e,{[c]:p[m]},r,n)),delete p[m],!0):!1));return Array.from(new Set(o.concat(i)))},hS=(e,t,r=[],n=dt)=>Ct(t,r,n,(i,o,c)=>ht(e,o,c,(u,d)=>Ht(u,d)?(pe(u)?u[d]=null:delete u[d],!0):!1)),Yd=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:eS,$bit:rS,$currentDate:nS,$inc:iS,$max:aS,$min:oS,$mul:sS,$pop:cS,$pull:Ap,$pullAll:uS,$push:dS,$rename:fS,$set:Tp,$unset:hS},Symbol.toStringTag,{value:"Module"}));function Mp(e){return e=e??dt,(t,r,n=[],i={},o=e)=>{const c=Object.entries(r);Ee(c.length===1,"Update expression must contain only one operator.");const[u,d]=c[0];Ee(Ht(Yd,u),`Update operator '${u}' is not supported.`);const p=Yd[u];return Object.keys(i).length&&!new Gr(i,o.queryOptions).test(t)?[]:p(t,d,n,o)}}Mp();var Nc;function Np(e,t){if(!Nc){var r=Mp({cloneMode:"none"});Nc=(n,i)=>{var o=ut(n);return r(o,i),o}}return Nc(e,t)}function pS(e){return this.incrementalModify(t=>{var r=Np(t,e);return r})}function mS(e){var t=this._data,r=Np(t,e);return this._saveData(r,t)}async function vS(e){return Un(this.asRxQuery,t=>t.update(e))}var gS={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=mS,e.incrementalUpdate=pS},RxQuery:e=>{e.update=vS}}};const Fn={OFF:0,ERROR:1,INFO:2,DEBUG:3};class Oe{constructor(t,r="debug"){this.module=t,this.level=Fn[r.toUpperCase()]}debug(t,r={}){this.level>=Fn.DEBUG&&console.debug(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}info(t,r={}){this.level>=Fn.INFO&&console.info(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}error(t,r={}){this.level>=Fn.ERROR&&console.error(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}setLevel(t){this.level=Fn[t.toUpperCase()]||Fn.OFF}}class re extends Error{constructor(t,r,n={}){super(r),this.code=t,this.details=n}}async function ee(e,t,r=`Operation timed out after ${t}ms`){const n=new Promise((i,o)=>setTimeout(()=>o(new re("TIMEOUT",r)),t));return Promise.race([e,n])}const yS=new Oe("Main");let ei=null,ns=null,Mo=!1,is;const bS=new Promise(e=>{is=e}),wS={title:"chat history schema",version:0,description:"Stores chat sessions",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100},tabId:{type:"number"},timestamp:{type:"number"},title:{type:"string",maxLength:100},messages:{type:"array",items:{type:"object",properties:{messageId:{type:"string",maxLength:100},sender:{type:"string"},text:{type:"string"},timestamp:{type:"number"},isLoading:{type:"boolean",default:!1}},required:["messageId","sender","text","timestamp"]}},isStarred:{type:"boolean",default:!1},status:{type:"string",default:"idle"}},required:["id","timestamp","messages"],indexes:[["timestamp"]]};async function Bt(){if(!await ee(bS,5e3,"Database initialization timeout")||!ns)throw new re("DB_NOT_READY","Database not initialized");return ns}async function _S(){const e=new Oe("Reset");e.info("Resetting database due to initialization failure");try{ei&&(await ei.destroy(),e.debug("Existing database destroyed")),await xp().getDexieDb().delete(),e.info("Dexie database deleted"),ei=null,ns=null,Mo=!1,is(!1)}catch(t){throw console.error("[DB:Reset] CAUGHT RAW ERROR during reset:",t),e.error("Failed to reset database",{error:t}),new re("RESET_FAILED","Could not reset database",{originalError:t})}}async function Bp(e){const t=new Oe("Initialize");if(t.info("Handling initialize request"),Mo){t.info("Already initialized, skipping");return}try{Lo(L_),Lo(V_),Lo(gS),ei=await ee(qw({name:"tabagentdb",storage:xp()}),1e4),t.debug("Database created",{name:ei.name}),ns=(await ei.addCollections({chatHistory:{schema:wS}})).chatHistory,t.debug("Chat history collection initialized");const n=[{event:yi.name,handler:LS},{event:yr.name,handler:$S},{event:la.name,handler:AS},{event:qt.name,handler:TS},{event:qo.name,handler:MS},{event:Xe.name,handler:NS},{event:gi.name,handler:BS},{event:fa.name,handler:qS},{event:ha.name,handler:FS},{event:bi.name,handler:jS},{event:wi.name,handler:US}];n.forEach(({event:i,handler:o})=>Q.subscribe(i,o)),t.debug("Event bus subscriptions complete",{count:n.length}),Mo=!0,is(!0),t.info("Initialization complete"),await Q.publish(Fr.name,new Fr({success:!0}))}catch(r){console.error("[DB:Initialize] Entered CATCH block for init error."),console.error("[DB:Initialize] Raw Error Name:",r==null?void 0:r.name),console.error("[DB:Initialize] Raw Error Message:",r==null?void 0:r.message),console.error("[DB:Initialize] CAUGHT RAW ERROR OBJECT during init:",r);const n=r instanceof re?r:new re("INIT_FAILED","Database initialization failed",{originalError:r});t.error("Initialization failed",{error:n,details:r});try{await _S(),t.info("Attempting reinitialization after reset"),await Bp(e);return}catch(i){t.error("Reinitialization after reset failed",{error:i})}Mo=!1,is(!1),await Q.publish(Fr.name,new Fr({success:!1,error:n}))}}function qp(e){if(!e||typeof e!="string")throw new re("INVALID_INPUT","Chat ID must be a non-empty string");return`${e}-msg-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}function Da(e){return typeof e!="string"?e:e.replace(/[<>]/g,"")}async function SS(e){const t=new Oe("CreateSession");t.debug("Creating new chat session",{initialMessage:e});const r=await Bt();if(!e||!e.text)throw new re("INVALID_INPUT","Initial message with text is required");const n=Date.now(),i=crypto.randomUUID(),o={...e,text:Da(e.text),messageId:qp(i),timestamp:e.timestamp||n,sender:e.sender||"user"},c={id:i,tabId:null,timestamp:n,title:Da(o.text.substring(0,30))+"...",messages:[o],isStarred:!1,status:"idle"};t.debug("Inserting session",{sessionId:i});const u=await ee(r.insert(c),3e3);return t.info("Session created",{sessionId:i}),await Ln(i),u}async function Fp(e){const t=new Oe("GetSession");if(t.debug("Getting session",{sessionId:e}),!e)throw new re("INVALID_INPUT","Session ID is required");const r=await Bt(),n=await ee(r.findOne(e).exec(),3e3);return n?(t.debug("Session retrieved",{sessionId:e}),n):(t.info("Session not found",{sessionId:e}),null)}async function ES(e,t){const r=new Oe("AddMessage");if(r.debug("Adding message",{chatId:e}),!e||!t||!t.text)throw new re("INVALID_INPUT","Chat ID and message with text are required");const n=await Bt(),i=await ee(n.findOne(e).exec(),3e3);if(!i)throw new re("NOT_FOUND",`Chat session ${e} not found`);const o={...t,text:Da(t.text),messageId:t.messageId||qp(e),timestamp:t.timestamp||Date.now(),isLoading:t.isLoading??!1},c=await ee(i.incrementalPatch({messages:[...i.messages,o]}),3e3);return r.info("Message added",{chatId:e,messageId:o.messageId}),{updatedDoc:c,newMessageId:o.messageId}}async function xS(e,t,r){const n=new Oe("UpdateMessage");if(n.debug("Updating message",{chatId:e,messageId:t}),!e||!t||!r||!r.text)throw new re("INVALID_INPUT","Chat ID, message ID, and updates with text are required");const i=await Bt(),o=await ee(i.findOne(e).exec(),3e3);if(!o)throw new re("NOT_FOUND",`Chat session ${e} not found`);let c=!1;const u=await ee(o.incrementalModify(d=>{const p=d.messages.findIndex(g=>g.messageId===t);if(p===-1)return d;c=!0;const m=d.messages[p];return d.messages[p]={...m,...r,text:Da(r.text),messageId:m.messageId},d}),3e3);if(!c)throw new re("NOT_FOUND",`Message ${t} not found in chat ${e}`);return n.info("Message updated",{chatId:e,messageId:t}),await Ln(e),u}async function CS(e,t){const r=new Oe("DeleteMessage");if(r.debug("Deleting message",{sessionId:e,messageId:t}),!e||!t)throw new re("INVALID_INPUT","Session ID and message ID are required");const n=await Bt(),i=await ee(n.findOne(e).exec(),3e3);if(!i)throw new re("NOT_FOUND",`Session ${e} not found`);const o=i.messages.length,c=i.messages.filter(d=>d.messageId!==t);if(c.length===o)return r.info("Message not found",{sessionId:e,messageId:t}),{updatedDoc:i,deleted:!1};const u=await ee(i.incrementalPatch({messages:c}),3e3);return r.info("Message deleted",{sessionId:e,messageId:t}),await Ln(e),{updatedDoc:u,deleted:!0}}async function IS(e,t){const r=new Oe("UpdateStatus");if(r.debug("Updating status",{sessionId:e,newStatus:t}),!e||!["idle","processing","complete","error"].includes(t))throw new re("INVALID_INPUT",`Invalid session ID or status: ${t}`);const i=await Bt(),o=await ee(i.findOne(e).exec(),3e3);if(!o)throw new re("NOT_FOUND",`Session ${e} not found`);const c=await ee(o.incrementalPatch({status:t}),3e3);return r.info("Status updated",{sessionId:e,newStatus:t}),await Ln(e),c}async function kS(e){const t=new Oe("ToggleStar");if(t.debug("Toggling starred status",{itemId:e}),!e)throw new re("INVALID_INPUT","Item ID is required");const r=await Bt(),n=await ee(r.findOne(e).exec(),3e3);if(!n)throw new re("NOT_FOUND",`Item ${e} not found`);const i=n.get("isStarred")||!1,o=await ee(n.incrementalPatch({isStarred:!i}),3e3);return t.info("Starred status toggled",{itemId:e,isStarred:!i}),await Ln(e),o}async function DS(e){const t=new Oe("DeleteHistory");if(t.debug("Deleting history item",{itemId:e}),!e)throw new re("INVALID_INPUT","Item ID is required");const r=await Bt(),n=await ee(r.findOne(e).exec(),3e3);return n?(await ee(n.remove(),3e3),t.info("Item deleted",{itemId:e}),await Ln(e),!0):(t.info("Item not found",{itemId:e}),!1)}async function OS(e,t){const r=new Oe("RenameHistory");if(r.debug("Renaming history item",{itemId:e,newTitle:t}),!e||!t)throw new re("INVALID_INPUT","Item ID and new title are required");const n=await Bt(),i=await ee(n.findOne(e).exec(),3e3);if(!i)throw new re("NOT_FOUND",`Item ${e} not found`);const o=await ee(i.incrementalPatch({title:Da(t)}),3e3);return r.info("Item renamed",{itemId:e,newTitle:t}),await Ln(e),o}async function PS(){const e=new Oe("GetAllSessions");e.debug("Getting all sessions");const t=await Bt(),n=(await ee(t.find().sort({timestamp:"desc"}).exec(),5e3)).map(i=>i.toJSON());return e.info("Retrieved sessions",{count:n.length}),n}async function RS(){const e=new Oe("GetStarredSessions");e.debug("Getting starred sessions");const t=await Bt(),r=await ee(t.find({selector:{isStarred:!0}}).sort({timestamp:"desc"}).exec(),5e3);return e.info("Retrieved starred sessions",{count:r.length}),r}async function Ln(e,t="update"){const r=new Oe("SessionUpdate");r.debug(`Attempting to publish session update for ${e}, type: ${t}`);try{await Bt();const n=await Fp(e);if(!n){r.error("Session not found after update, cannot publish notification",{sessionId:e});return}const i=n.toJSON?n.toJSON():n;r.info(`Publishing session update notification for ${e}`),await Q.publish(En.name,new En(e,i,t)),r.debug("Session update published",{sessionId:e,updateType:t})}catch(n){r.error("Failed to publish session update",{sessionId:e,error:n})}}async function LS(e){var n;const t=new Oe("CreateSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling session creation",{requestId:r});try{if(!(e!=null&&e.requestId)||!((n=e==null?void 0:e.payload)!=null&&n.initialMessage)||!e.payload.initialMessage.text)throw new re("INVALID_INPUT","Missing requestId, initialMessage, or message text");const i=await ee(SS(e.payload.initialMessage),5e3);if(!(i!=null&&i.id))throw new re("INVALID_DOCUMENT","Invalid session document returned");await ee(Promise.all([Q.publish(Ze.name,new Ze(i.id,i.messages)),Q.publish(Xt.name,new Xt(i.id,i.status))]),3e3);const o=new fi(r,!0,i.id);console.log(`[DB:${t.module}] PRE-PUBLISH Check (Success Path): ReqID ${r}, Response Success: ${o==null?void 0:o.success}, Response Type: ${o==null?void 0:o.type}`),await ee(Q.publish(o.type,o),3e3),t.info("Session created successfully",{requestId:r,sessionId:i.id})}catch(i){const o=i instanceof re?i:new re("UNKNOWN","Failed to create session",{originalError:i}),c=new fi(r,!1,null,o);console.log(`[DB:${t.module}] PRE-PUBLISH Check (Error Path): ReqID ${r}, Response Success: ${c==null?void 0:c.success}, Response Type: ${c==null?void 0:c.type}`);try{await ee(Q.publish(c.type,c),3e3)}catch(u){t.error("FATAL: Failed even to publish error response!",{requestId:r,publishError:u})}t.error("Session creation failed",{requestId:r,error:o})}}async function $S(e){var n;const t=new Oe("GetSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new re("INVALID_INPUT","Session ID is required");const i=await ee(Fp(e.payload.sessionId),5e3),o=new oi(r,!0,i?i.toJSON():null);await ee(Q.publish(o.type,o),3e3),t.info("Session retrieved",{requestId:r,sessionId:e.payload.sessionId})}catch(i){const o=i instanceof re?i:new re("UNKNOWN","Failed to get session",{originalError:i}),c=new oi(r,!1,null,o);await ee(Q.publish(c.type,c),3e3),t.error("Get session failed",{requestId:r,error:o})}}async function AS(e){var n,i;const t=new Oe("AddMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling add message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((i=e==null?void 0:e.payload)!=null&&i.messageObject)||!e.payload.messageObject.text)throw new re("INVALID_INPUT","Session ID and message with text are required");const{updatedDoc:o,newMessageId:c}=await ee(ES(e.payload.sessionId,e.payload.messageObject),5e3),u=o.messages.map(p=>p.toJSON?p.toJSON():p);await ee(Q.publish(Ze.name,new Ze(o.id,u)),3e3);const d=new si(r,!0,c);await ee(Q.publish(d.type,d),3e3),t.info("Message added",{requestId:r,sessionId:e.payload.sessionId,messageId:c})}catch(o){const c=o instanceof re?o:new re("UNKNOWN","Failed to add message",{originalError:o}),u=new si(r,!1,null,c);await ee(Q.publish(u.type,u),3e3),t.error("Add message failed",{requestId:r,error:c})}}async function TS(e){var n,i,o;const t=new Oe("UpdateMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling update message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((i=e==null?void 0:e.payload)!=null&&i.messageId)||!((o=e==null?void 0:e.payload)!=null&&o.updates)||!e.payload.updates.text)throw new re("INVALID_INPUT","Session ID, message ID, and updates with text are required");const c=await ee(xS(e.payload.sessionId,e.payload.messageId,e.payload.updates),5e3);await ee(Q.publish(Ze.name,new Ze(c.id,c.messages)),3e3);const u=new ci(r,!0);await ee(Q.publish(u.type,u),3e3),t.info("Message updated",{requestId:r,sessionId:e.payload.sessionId,messageId:e.payload.messageId})}catch(c){const u=c instanceof re?c:new re("UNKNOWN","Failed to update message",{originalError:c}),d=new ci(r,!1,u);await ee(Q.publish(d.type,d),3e3),t.error("Update message failed",{requestId:r,error:u})}}async function MS(e){var n,i;const t=new Oe("DeleteMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling delete message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((i=e==null?void 0:e.payload)!=null&&i.messageId))throw new re("INVALID_INPUT","Session ID and message ID are required");const{updatedDoc:o,deleted:c}=await ee(CS(e.payload.sessionId,e.payload.messageId),5e3);c&&await ee(Q.publish(Ze.name,new Ze(o.id,o.messages)),3e3);const u=new li(r,!0);await ee(Q.publish(u.type,u),3e3),t.info("Message deleted",{requestId:r,sessionId:e.payload.sessionId,messageId:e.payload.messageId})}catch(o){const c=o instanceof re?o:new re("UNKNOWN","Failed to delete message",{originalError:o}),u=new li(r,!1,c);await ee(Q.publish(u.type,u),3e3),t.error("Delete message failed",{requestId:r,error:c})}}async function NS(e){var n,i;const t=new Oe("UpdateStatusHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling update status",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((i=e==null?void 0:e.payload)!=null&&i.status))throw new re("INVALID_INPUT","Session ID and status are required");const o=await ee(IS(e.payload.sessionId,e.payload.status),5e3);await ee(Q.publish(Xt.name,new Xt(o.id,o.status)),3e3);const c=new ui(r,!0);await ee(Q.publish(c.type,c),3e3),t.info("Status updated",{requestId:r,sessionId:e.payload.sessionId,status:e.payload.status})}catch(o){const c=o instanceof re?o:new re("UNKNOWN","Failed to update status",{originalError:o}),u=new ui(r,!1,c);await ee(Q.publish(u.type,u),3e3),t.error("Update status failed",{requestId:r,error:c});try{await ee(Q.publish(Xt.name,new Xt(e.payload.sessionId,"error")),3e3)}catch(d){t.error("Failed to publish error status notification",{requestId:r,error:d})}}}async function BS(e){var n;const t=new Oe("ToggleStarHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling toggle star",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new re("INVALID_INPUT","Session ID is required");const i=await ee(kS(e.payload.sessionId),5e3),o=new di(r,!0,i.toJSON());await ee(Q.publish(o.type,o),3e3),t.info("Star toggled",{requestId:r,sessionId:e.payload.sessionId})}catch(i){const o=i instanceof re?i:new re("UNKNOWN","Failed to toggle star",{originalError:i}),c=new di(r,!1,null,o);await ee(Q.publish(c.type,c),3e3),t.error("Toggle star failed",{requestId:r,error:o})}}async function qS(e){const t=new Oe("GetAllSessionsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get all sessions",{requestId:r});try{const i=(await ee(PS(),5e3)).sort((c,u)=>u.timestamp-c.timestamp);t.debug("Using plain sessions directly",{count:i.length});const o=new mi(r,!0,i);await ee(Q.publish(o.type,o),3e3),t.info("Sessions retrieved",{requestId:r,count:i.length})}catch(n){const i=n instanceof re?n:new re("UNKNOWN","Failed to get all sessions",{originalError:n}),o=new mi(r,!1,null,i);await ee(Q.publish(o.type,o),3e3),t.error("Get all sessions failed",{requestId:r,error:i})}}async function FS(e){const t=new Oe("GetStarredSessionsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get starred sessions",{requestId:r});try{const i=(await ee(RS(),5e3)).map(c=>({sessionId:c.id,name:c.title,lastUpdated:c.timestamp,isStarred:c.isStarred})).sort((c,u)=>u.lastUpdated-c.lastUpdated);t.debug("Retrieved starred sessions",{count:i.length});const o=new vi(r,!0,i);await ee(Q.publish(o.type,o),3e3),t.info("Starred sessions retrieved",{requestId:r,count:i.length})}catch(n){const i=n instanceof re?n:new re("UNKNOWN","Failed to get starred sessions",{originalError:n}),o=new vi(r,!1,null,i);await ee(Q.publish(o.type,o),3e3),t.error("Get starred sessions failed",{requestId:r,error:i})}}async function jS(e){var n;const t=new Oe("DeleteSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling delete session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new re("INVALID_INPUT","Session ID is required");const i=await ee(DS(e.payload.sessionId),5e3),o=new hi(r,!0);await ee(Q.publish(o.type,o),3e3),t.info("Session deleted",{requestId:r,sessionId:e.payload.sessionId})}catch(i){const o=i instanceof re?i:new re("UNKNOWN","Failed to delete session",{originalError:i}),c=new hi(r,!1,o);await ee(Q.publish(c.type,c),3e3),t.error("Delete session failed",{requestId:r,error:o})}}async function US(e){var n,i;const t=new Oe("RenameSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling rename session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((i=e==null?void 0:e.payload)!=null&&i.newName))throw new re("INVALID_INPUT","Session ID and new name are required");const o=await ee(OS(e.payload.sessionId,e.payload.newName),5e3),c=new pi(r,!0);await ee(Q.publish(c.type,c),3e3),t.info("Session renamed",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const c=o instanceof re?o:new re("UNKNOWN","Failed to rename session",{originalError:o}),u=new pi(r,!1,c);await ee(Q.publish(u.type,u),3e3),t.error("Rename session failed",{requestId:r,error:c})}}Q.subscribe(da.name,Bp);yS.info("Subscribed to DbInitializeRequest");let Ti=!1,Ur=null,vr=null,zt=null,Yt=[],_n="",Jd=!1;async function KS(e){if(console.log(`[LibraryController] Star clicked: ${e}`),!!zt)try{await zt(new gi(e)),Le("Star toggled","success")}catch(t){console.error("[LibraryController] Error toggling star:",t),Le(`Failed to toggle star: ${t.message}`,"error")}}async function HS(e){if(console.log(`[LibraryController] Delete clicked: ${e}`),!!zt&&confirm("Are you sure you want to delete this chat history item? This cannot be undone."))try{await zt(new bi(e)),Le("Chat deleted","success")}catch(t){console.error("[LibraryController] Error deleting chat:",t),Le(`Failed to delete chat: ${t.message}`,"error")}}async function zS(e,t){if(console.log(`[LibraryController] Rename submitted: ${e} to "${t}"`),!!zt)try{await zt(new wi(e,t)),Le("Rename successful","success")}catch(r){console.error("[LibraryController] Error submitting rename:",r),Le(`Failed to rename chat: ${r.message}`,"error")}}async function WS(e){zt?vf(e,zt,Le):(console.error("[LibraryController] Cannot download: requestDbAndWaitFunc not available."),Le("Download failed: Internal setup error.","error"))}async function VS(e){console.log(`[LibraryController] Load clicked: ${e}`);try{await chrome.storage.local.set({lastSessionId:e}),Bo("page-home")}catch(t){console.error("[LibraryController] Error setting storage or navigating:",t),Le("Failed to load chat.","error"),await chrome.storage.local.remove("lastSessionId")}}function QS(e){console.log(`[LibraryController] Share clicked: ${e}`),Le("Share functionality not yet implemented.","info")}function GS(e,t){console.log(`[LibraryController] Preview clicked: ${e}`),Le("Preview functionality not yet implemented.","info"),t&&(t.innerHTML="Preview loading...",t.classList.toggle("hidden"))}function YS(e){!Ti||(e==null?void 0:e.pageId)!=="page-library"||(console.log("[LibraryController] Library page activated."),Jd||(vr=document.getElementById("library-search"),vr?(vr.addEventListener("input",ZS),Jd=!0,console.log("[LibraryController] Search input listener attached.")):console.warn("[LibraryController] Library search input (#library-search) still not found even when page is active.")),JS())}async function JS(){if(!Ti||!Ur||!zt){console.error("[LibraryController] Cannot fetch/render - not initialized or missing elements/functions.");return}console.log("[LibraryController] Fetching starred items..."),Ur.innerHTML='<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">Loading starred items...</p>',_n=(vr==null?void 0:vr.value.trim())||"";try{const e=await zt(new ha);Yt=Array.isArray(e)?e:(e==null?void 0:e.sessions)||[],console.log(`[LibraryController] Received ${Yt.length} starred items.`),nl(_n)}catch(e){console.error("[LibraryController] Error fetching starred items:",e),Ur.innerHTML='<div class="p-4 text-red-500">Error loading starred items.</div>'}}function XS(e){if(!Ti||!e||!e.sessionId||!e.payload){console.warn("[LibraryController] Invalid session update notification received.",e);return}const t=e.payload.session,r=e.sessionId;if(!t){console.warn(`[LibraryController] Session update notification for ${r} missing session data in payload.session.`,e);return}console.log(`[LibraryController] Received session update for ${r}. New starred status: ${t.isStarred}`);const n=Yt.findIndex(o=>o.sessionId===r);if(t.isStarred)if(n===-1){console.log(`[LibraryController] Session ${r} is newly starred. Adding to list.`);const o={sessionId:r,name:t.title||"Untitled",lastUpdated:t.timestamp||Date.now(),isStarred:!0};Yt.push(o)}else console.log(`[LibraryController] Session ${r} was already starred. Updating data.`),Yt[n]={...Yt[n],name:t.title||Yt[n].name,lastUpdated:t.timestamp||Yt[n].lastUpdated,isStarred:!0};else n!==-1?(console.log(`[LibraryController] Session ${r} is no longer starred. Removing from list.`),Yt.splice(n,1)):console.log(`[LibraryController] Session ${r} is not starred and was not in the list.`);const i=document.getElementById("page-library");i&&!i.classList.contains("hidden")?(console.log("[LibraryController] Library page is active, re-rendering list with filter."),_n=(vr==null?void 0:vr.value.trim())||"",nl(_n)):console.log("[LibraryController] Library page not active, internal list updated passively.")}function nl(e=""){if(!Ti||!Ur)return;console.log(`[LibraryController] Rendering with filter "${e}"`);let t=[...Yt];if(e){const r=e.toLowerCase();t=t.filter(n=>(n.name||"").toLowerCase().includes(r))}if(t.sort((r,n)=>n.lastUpdated-r.lastUpdated),Ur.innerHTML="",t.length===0){const r=e?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items match "${e}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items yet.</p>';Ur.innerHTML=r}else t.forEach(r=>{const n={entry:{id:r.sessionId,name:r.name,title:r.name,timestamp:r.lastUpdated,isStarred:r.isStarred,messages:[]},onLoadClick:VS,onStarClick:KS,onDeleteClick:HS,onRenameSubmit:zS,onDownloadClick:WS,onShareClick:QS,onPreviewClick:GS},i=mf(n);i&&Ur.appendChild(i)});console.log(`[LibraryController] Rendered ${t.length} items.`)}const ZS=xu(e=>{Ti&&(_n=e.target.value.trim(),console.log(`[LibraryController] Search input changed: "${_n}"`),nl(_n))},300);function eE(e,t){return console.log("[LibraryController] Initializing..."),!e||!e.listContainer||!t?(console.error("[LibraryController] Initialization failed: Missing required elements (listContainer) or request function.",{elements:e,requestFunc:t}),null):(Ur=e.listContainer,zt=t,console.log("[LibraryController] Elements and request function assigned."),Q.subscribe("navigation:pageChanged",YS),console.log("[LibraryController] Subscribed to navigation:pageChanged."),Q.subscribe(En.name,XS),console.log("[LibraryController] Subscribed to DbSessionUpdatedNotification."),Ti=!0,console.log("[LibraryController] Initialization successful. Library will render when activated."),{})}let Xd=!1;function tE(){if(Xd){console.log("[DiscoverController] Already initialized.");return}return console.log("[DiscoverController] Initializing..."),Xd=!0,console.log("[DiscoverController] Initialized successfully."),{}}let Zd=!1;const ef=e=>{if(!e)return;const t=document.documentElement.classList.contains("dark");e.textContent=t?"Switch to Light Mode":"Switch to Dark Mode"};function rE(){const e=document.getElementById("page-settings");if(!e){console.warn("[SettingsController] Could not find #page-settings container.");return}let t=e.querySelector("#theme-toggle-button");if(t)console.log("[SettingsController] Theme toggle button already exists.");else{console.log("[SettingsController] Creating theme toggle button."),t=document.createElement("button"),t.id="theme-toggle-button",t.className="p-2 border rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 mt-4",t.onclick=()=>{const n=document.documentElement,i=n.classList.contains("dark");console.log(`[SettingsToggle] Before toggle - isDark: ${i}`),i?(n.classList.remove("dark"),localStorage.setItem("theme","light"),console.log("[SettingsToggle] Removed dark class, set localStorage to light")):(n.classList.add("dark"),localStorage.setItem("theme","dark"),console.log("[SettingsToggle] Added dark class, set localStorage to dark")),ef(t)};const r=e.querySelector("p");r?r.insertAdjacentElement("afterend",t):e.appendChild(t)}ef(t)}function nE(){if(Zd){console.log("[SettingsController] Already initialized.");return}return console.log("[SettingsController] Initializing..."),rE(),Zd=!0,console.log("[SettingsController] Initialized successfully."),{}}let tf=!1;function iE(){if(tf){console.log("[SpacesController] Already initialized.");return}return console.log("[SpacesController] Initializing..."),tf=!0,console.log("[SpacesController] Initialized successfully."),{}}const il="application/vnd.google-apps.folder";let or,Sn,xo,et,Co,dn,$t,wu,zn,fn,On=!1,xr="root",At=[{id:"root",name:"Root"}],Oi={},Tt={},ta=!1,gr="",Ji=null,rf=null,Bc=null,as=Le,qc=null;function aE(){if(!On){if(!Sn){console.error("DriveViewerModal element not found.");return}console.log("DriveController: Showing Drive Viewer modal."),xr="root",At=[{id:"root",name:"Root"}],Tt={},Oi={},gr="",$t&&($t.value=""),$s(),Ls(),Rs("root"),Sn.classList.remove("hidden"),On=!0}}function Io(){On&&Sn&&(console.log("DriveController: Hiding Drive Viewer modal."),Sn.classList.add("hidden"),On=!1,et&&(et.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>'))}function oE(e){return e===il?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'}function al(e){if(!et)return;et.innerHTML="";const t=gr.toLowerCase(),r=gr?e.filter(n=>n.name.toLowerCase().includes(t)):e;if(!r||r.length===0){et.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 p-4">${gr?"No results found.":"Folder is empty."}</div>`;return}r.forEach(n=>{const i=n.mimeType===il,o=document.createElement("div");o.className="drive-viewer-item flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer",o.dataset.id=n.id,o.dataset.name=n.name,o.dataset.mimeType=n.mimeType,o.dataset.iconLink=n.iconLink||"";const c=document.createElement("div");c.className="flex-shrink-0 w-6 h-6 mr-3 flex items-center justify-center",n.iconLink?c.innerHTML=`<img src="${n.iconLink}" alt="${i?"Folder":"File"}" class="w-5 h-5">`:c.innerHTML=oE(n.mimeType);const u=document.createElement("span");u.className="flex-grow truncate",u.textContent=n.name,u.title=n.name,o.appendChild(c),o.appendChild(u),Tt[n.id]&&o.classList.add("selected"),o.addEventListener("click",sE),et.appendChild(o)})}function Rs(e){if(!(!et||ta)){if(ta=!0,console.log(`DriveController: Fetching Drive content for folder: ${e}`),cE(),hE(),et.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>',Oi[e]){console.log(`DriveController: Using cached content for folder: ${e}`),al(Oi[e]),ta=!1;return}chrome.runtime.sendMessage({type:"getDriveFileList",folderId:e},t=>{chrome.runtime.lastError?(console.error("DriveController: Error sending getDriveFileList message:",chrome.runtime.lastError.message),as(`Error fetching folder content: ${chrome.runtime.lastError.message}`,"error"),et&&(et.innerHTML='<div class="text-center text-red-500 p-4">Error sending request.</div>'),ta=!1):console.log(`DriveController: Sent getDriveFileList request for ${e}. Waiting for response...`)})}}function sE(e){e.stopPropagation();const t=e.currentTarget,r=t.dataset.id,n=t.dataset.name,i=t.dataset.mimeType,o=t.dataset.iconLink;if(!r||!i){console.error("DriveController: Clicked Drive item missing ID or mimeType.");return}i===il?(console.log(`DriveController: Navigating into folder: ${n} (${r})`),xr=r,At.push({id:r,name:n}),gr="",$t&&($t.value=""),Rs(r)):(console.log(`DriveController: Toggling selection for file: ${n} (${r})`),lE(r,t,{id:r,name:n,mimeType:i,iconLink:o}))}function cE(){zn&&(zn.innerHTML="",At.forEach((e,t)=>{const r=document.createElement(t===At.length-1?"span":"button");if(r.textContent=e.name,r.dataset.id=e.id,r.dataset.index=t,t<At.length-1){r.className="text-blue-600 hover:underline dark:text-blue-400 cursor-pointer",r.addEventListener("click",uE);const n=document.createElement("span");n.textContent=" / ",n.className="mx-1 text-gray-400",zn.appendChild(r),zn.appendChild(n)}else r.className="font-semibold",zn.appendChild(r)}))}function uE(e){const t=parseInt(e.currentTarget.dataset.index,10),r=e.currentTarget.dataset.id;if(isNaN(t)||!r){console.error("DriveController: Invalid breadcrumb data.");return}r!==xr&&(console.log(`DriveController: Breadcrumb click - Navigating to index ${t} (${r})`),At=At.slice(0,t+1),xr=r,gr="",$t&&($t.value=""),Rs(r))}function lE(e,t,r){Tt[e]?(delete Tt[e],t==null||t.classList.remove("selected")):(Tt[e]=r,t==null||t.classList.add("selected")),Ls(),$s()}function Ls(){if(!wu)return;const e=Object.keys(Tt),t=wu;if(!t){console.error("Selected area container not found");return}const r=t.querySelector(".flex-wrap")||t;r.innerHTML="",e.length===0?t.classList.add("hidden"):(t.classList.remove("hidden"),e.forEach(n=>{const i=Tt[n],o=document.createElement("span");o.className="selected-file-item";const c=i.iconLink?`<img src="${i.iconLink}" alt="" class="w-3 h-3 mr-1.5">`:"",u=`<button class="selected-file-remove" data-id="${n}">&times;</button>`;o.innerHTML=`${c}${i.name} ${u}`,r.appendChild(o);const d=o.querySelector(".selected-file-remove");d==null||d.addEventListener("click",dE)}))}function dE(e){const t=e.currentTarget.dataset.id;if(t&&Tt[t]){delete Tt[t],Ls(),$s();const r=et==null?void 0:et.querySelector(`.drive-viewer-item[data-id="${t}"]`);r==null||r.classList.remove("selected")}}function $s(){if(!dn)return;const e=Object.keys(Tt).length;dn.disabled=e===0,dn.textContent=`Insert (${e})`}let Fc=null;function nf(e){gr=e.target.value.trim(),console.log(`DriveController: Filtering Drive items by term: "${gr}"`),Oi[xr]?al(Oi[xr]):et.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Folder not loaded or empty.</div>'}function fE(){if(At.length<=1)return;const e=At[At.length-2];At.pop(),xr=e.id,console.log(`DriveController: Back button click - Navigating to ${e.name} (${e.id})`),gr="",$t&&($t.value=""),Rs(e.id)}function hE(){fn&&(At.length>1?fn.classList.remove("hidden"):fn.classList.add("hidden"))}function pE(e,t,r){if(e.type==="driveFileListResponse"){if(console.log(`DriveController: Handling driveFileListResponse for folder: ${e.folderId}`),ta=!1,!On||e.folderId!==xr)return console.warn(`DriveController: Ignoring driveFileListResponse for folder ${e.folderId}. Current: ${xr}, IsOpen: ${On}`),!1;if(e.success&&e.files)Oi[e.folderId]=e.files,al(e.files);else{const n=e.error||"Unknown error fetching files.";console.error(`DriveController: Drive file list error for ${e.folderId}: ${n}`),as(`Error fetching folder content: ${n}`,"error"),et&&(et.innerHTML=`<div class="text-center text-red-500 p-4">Error loading content: ${n}</div>`)}return!1}return!1}function mE(e){console.log("Initializing DriveController..."),Ji=e.requestDbAndWaitFunc,rf=e.getActiveChatSessionId,Bc=e.setActiveChatSessionId,e.showNotification&&(as=e.showNotification),qc=e.debounce,qc?Fc=qc(nf,300):(console.error("DriveController requires a debounce function dependency."),Fc=nf),or=document.getElementById("drive-button"),Sn=document.getElementById("drive-viewer-modal"),xo=document.getElementById("drive-viewer-close"),et=document.getElementById("drive-viewer-list"),Co=document.getElementById("drive-viewer-cancel"),dn=document.getElementById("drive-viewer-insert"),$t=document.getElementById("drive-viewer-search"),wu=document.getElementById("drive-viewer-selected-area"),zn=document.getElementById("drive-viewer-breadcrumbs"),fn=document.getElementById("drive-viewer-back");const t=r=>{r.stopPropagation(),aE()};or==null||or.removeEventListener("click",t),or==null||or.addEventListener("click",t),xo==null||xo.addEventListener("click",Io),Co==null||Co.addEventListener("click",Io),dn==null||dn.addEventListener("click",async()=>{const r=Object.values(Tt);if(r.length===0)return;let n=rf(),i=!1;console.log(`DriveController: Inserting ${r.length} Drive files. Current session: ${n}`);const c=`ðŸ“Ž Attached Drive files: ${r.map(d=>d.name).join(", ")}`,u={type:"drive_attachments",files:r.map(d=>({id:d.id,name:d.name,mimeType:d.mimeType,iconLink:d.iconLink}))};try{if(n){const d={sender:"system",text:c,timestamp:Date.now(),isLoading:!1,metadata:u};if(!Ji)throw new Error("requestDbAndWaitFunc function not provided.");const p=new la(n,d);await Ji(p)}else{i=!0;const d={sender:"system",text:c,timestamp:Date.now(),isLoading:!1,metadata:u};if(!Ji)throw new Error("requestDbAndWaitFunc function not provided.");const p=new yi(d),m=await Ji(p);if(console.log("[DriveController] Received createSessionResponse:",JSON.stringify(m)),n=m==null?void 0:m.newSessionId,console.log("[DriveController] Extracted currentSessionId:",n),!n)throw new Error("Failed to create session or get sessionId from response.");Bc?Bc(n):console.warn("setActiveChatSessionIdDep not provided to DriveController."),console.log(`DriveController: New session ${n} created.`)}Tt={},Ls(),$s(),Io()}catch(d){console.error("DriveController: Error adding Drive attachment message:",d),as(`Failed to add Drive attachment: ${d.message}`,"error")}}),$t==null||$t.addEventListener("input",Fc),fn==null||fn.addEventListener("click",fE),document.addEventListener("click",r=>{On&&Sn&&!Sn.contains(r.target)&&or&&!or.contains(r.target)&&Io()}),chrome.runtime.onMessage.addListener(pE),console.log("DriveController Initialization Complete.")}let vE=null,os=null,af=!1,jc=null,Mr=null,ko=null,jp=!1;const Uc=new Map;function Wn(e,t=5e3){return new Promise((r,n)=>{const{requestId:i,type:o}=e,c=e.constructor.responseEventName;if(!c){const p=`[requestDbAndWait] Cannot determine response event type for request: ${o}`;console.error(p),n(new Error(p));return}const u=p=>{console.log(`[requestDbAndWait] Received event for ${c}, ReqID ${p==null?void 0:p.requestId}, Waiting for ${i}`),console.log("[requestDbAndWait] RAW Received Event Object:",p),p&&p.requestId===i&&(console.log(`[requestDbAndWait] MATCH FOUND for ReqID ${i}. Event Payload:`,p),clearTimeout(d),Q.unsubscribe(c,u),Uc.delete(i),p.error===null||typeof p.error>"u"?(console.log(`[requestDbAndWait] Success assumed (no error property) for ReqID ${i}. Resolving promise.`),r(p.data||p.payload)):(console.error(`[requestDbAndWait] Error property found for ReqID ${i}. responseEvent.error was: ${p.error}. Rejecting promise.`),n(new Error(p.error||`DB operation ${o} failed`))))},d=setTimeout(()=>{console.error(`[Sidepanel] DB request timed out for ${o} (Req ID: ${i})`),Q.unsubscribe(c,u),Uc.delete(i),n(new Error(`DB request timed out for ${o}`))},t);Uc.set(i,{handler:u,timeoutId:d}),Q.subscribe(c,u),Q.publish(e.type,e)})}function No(){return os}async function ti(e){console.log(`[Sidepanel] Setting active session ID to: ${e}`),os=e,e?await chrome.storage.local.set({lastSessionId:e}):await chrome.storage.local.remove("lastSessionId"),Mm(e),hf(e)}document.addEventListener("DOMContentLoaded",async()=>{console.log("[Sidepanel] DOM Content Loaded. Initializing modules...");let e=!1;const t=new Promise((r,n)=>{const o=setTimeout(()=>{e||(console.error("[Sidepanel] DB Initialization timed out!"),n(new Error("Database initialization timed out.")))},1e4),c=u=>{var d;if(e=!0,clearTimeout(o),Q.unsubscribe(Fr.name,c),u&&u.payload&&u.payload.success)console.log("[Sidepanel] Received DB Initialization Complete notification (Success)."),r(!0);else{const p=((d=u==null?void 0:u.payload)==null?void 0:d.error)||"Unknown DB initialization error";console.error(`[Sidepanel] Received DB Initialization Complete notification (Failure): ${p}`),n(new Error(`Database initialization failed: ${p}`))}};Q.subscribe(Fr.name,c),console.log("[Sidepanel] Subscribed to DbInitializationCompleteNotification. Publishing DbInitializeRequest..."),Q.publish(da.name,new da)});try{const{chatBody:r,newChatButton:n,chatInputElement:i,sendButton:o,fileInput:c}=ff({onNewChat:bE,onSessionClick:wE,onAttachFile:Gm});console.log("[Sidepanel] UI Controller Initialized.");const u=document.getElementById("chat-body");u||console.error("[Sidepanel] CRITICAL: chatBodyForRenderer is null right before calling initializeRenderer!"),Tm(u,Wn),console.log("[Sidepanel] Chat Renderer Initialized."),xm(),console.log("[Sidepanel] Navigation Initialized."),Q.subscribe("navigation:pageChanged",SE),Vm({uiController:$m,getActiveSessionIdFunc:No}),console.log("[Sidepanel] File Handler Initialized.");const d=document.getElementById("file-input");d?d.addEventListener("change",Qm):console.warn("[Sidepanel] File input element (re-fetched) not found before adding listener.");const p=await zc();Mr=p==null?void 0:p.id,vE=p,console.log(`[Sidepanel] Current Tab ID: ${Mr}`),jm({getActiveSessionIdFunc:No,onSessionCreatedCallback:yE,getCurrentTabIdFunc:()=>Mr}),console.log("[Sidepanel] Message Orchestrator Initialized."),chrome.runtime.onMessage.addListener(gE),console.log("[Sidepanel] Background message listener added.");const m=document.getElementById("history-popup"),g=document.getElementById("history-list"),S=document.getElementById("history-search"),_=document.getElementById("close-history"),E=document.getElementById("history-button"),O=document.getElementById("detach-button");m&&g&&S&&_?(ko=fv({popupContainer:m,listContainer:g,searchInput:S,closeButton:_},Wn),ko||console.error("[Sidepanel] History Popup Controller initialization failed.")):console.warn("[Sidepanel] Could not find all required elements for History Popup Controller."),E&&ko?E.addEventListener("click",()=>{ko.show()}):console.warn("[Sidepanel] History button or controller not available for listener."),O?O.addEventListener("click",_E):console.warn("[Sidepanel] Detach button not found.");const T=document.getElementById("starred-list");T?(eE({listContainer:T},Wn),console.log("[Sidepanel] Library Controller Initialized.")):console.warn("[Sidepanel] Could not find #starred-list element for Library Controller."),tE(),console.log("[Sidepanel] Discover Controller Initialized call attempted."),nE(),console.log("[Sidepanel] Settings Controller Initialized call attempted."),iE(),console.log("[Sidepanel] Spaces Controller Initialized call attempted."),mE({requestDbAndWaitFunc:Wn,getActiveChatSessionId:No,setActiveChatSessionId:ti,showNotification:Le,debounce:xu}),console.log("[Sidepanel] Drive Controller Initialized.");const B=new URLSearchParams(window.location.search);af=B.get("context")==="popup",jc=B.get("originalTabId"),console.log(`[Sidepanel] Context: ${af?"Popup":"Sidepanel"}${jc?", Original Tab: "+jc:""}`),console.log("[Sidepanel] Waiting for DB initialization to complete...");try{await t,jp=!0,console.log("[Sidepanel] DB initialization confirmed complete.")}catch(j){console.error("[Sidepanel] DB Initialization failed within DOMContentLoaded:",j),ct(`Critical Error: ${j.message}. Cannot load data.`),r&&(r.innerHTML='<div class="p-4 text-red-500">Database failed to load. Please try reloading the extension.</div>');return}console.log("[Sidepanel] DB ready. Starting with a clean session."),await ca(null),console.log("[Sidepanel] Initialization complete (starting fresh).")}catch(r){console.error("[Sidepanel] Initialization failed:",r),ct(`Initialization failed: ${r.message}. Please try reloading.`);const n=document.getElementById("chat-body");n&&(n.innerHTML=`<div class="p-4 text-red-500">Critical Error: ${r.message}. Please reload the extension.</div>`)}});function gE(e,t,r){if(console.log("[Sidepanel] Received message from background:",e),e.type==="response"){const n={chatId:e.chatId,messageId:e.messageId,text:e.text};Q.publish("background:responseReceived",n)}else if(e.type==="error"){const n={chatId:e.chatId,messageId:e.messageId,error:e.error};Q.publish("background:errorReceived",n)}else e.type==="STAGE_SCRAPE_RESULT"?Q.publish("background:scrapeStageResult",e.payload):e.type==="DIRECT_SCRAPE_RESULT"?Q.publish("background:scrapeResultReceived",e.payload):console.warn("[Sidepanel] Received unknown message type from background:",e.type,e)}async function yE(e){console.log(`[Sidepanel] Orchestrator reported new session created: ${e}`),await ti(e),console.log(`[Sidepanel] Explicitly fetching messages for new session ${e}`);try{const t=new yr(e),r=await Wn(t);r&&r.messages?(Q.publish(Ze.name,new Ze(e,r.messages)),console.log(`[Sidepanel] Manually triggered message render for new session ${e}`)):console.warn(`[Sidepanel] No messages found in session data for new session ${e}. Response data:`,r)}catch(t){console.error(`[Sidepanel] Failed to fetch messages for new session ${e}:`,t),ct(`Failed to load initial messages for new chat: ${t.message}`)}}async function bE(){console.log("[Sidepanel] New Chat button clicked."),await ti(null),ys(),pf()}async function wE(e){const t=e.currentTarget.dataset.sessionId;t&&t!==os?(console.log(`[Sidepanel] Session list item clicked: ${t}`),await ca(t)):t===os?(console.log(`[Sidepanel] Clicked already active session: ${t}`),Cu()):console.warn("[Sidepanel] Session list click event missing sessionId:",e.currentTarget)}async function ca(e){if(!e){console.log("[Sidepanel] No session ID to load, setting renderer to null."),await ti(null);return}console.log(`[Sidepanel] Loading session data for: ${e}`);let t=null;try{const r=new yr(e);t=await Wn(r),console.log(`[Sidepanel] Session data successfully loaded for ${e}.`),await ti(e),t&&t.messages?(console.log(`[Sidepanel] Manually triggering message render for loaded session ${e}.`),Q.publish(Ze.name,new Ze(e,t.messages))):(console.warn(`[Sidepanel] No messages found in loaded session data for ${e}. Displaying empty chat.`),Q.publish(Ze.name,new Ze(e,{messages:[]})))}catch(r){console.error(`[Sidepanel] Failed to load session ${e}:`,r),ct(`Failed to load chat: ${r.message}`),await ti(null)}}async function _E(){if(!Mr){console.error("Cannot detach: Missing tab ID"),ct("Cannot detach: Missing tab ID");return}const e=No();try{const t=await chrome.runtime.sendMessage({type:"getPopupForTab",tabId:Mr});if(t&&t.popupId){await chrome.windows.update(t.popupId,{focused:!0});return}const r=`detachedSessionId_${Mr}`;await chrome.storage.local.set({[r]:e}),console.log(`Sidepanel: Saved session ID ${e} for detach key ${r}.`);const n=await chrome.windows.create({url:chrome.runtime.getURL(`sidepanel.html?context=popup&originalTabId=${Mr}`),type:"popup",width:400,height:600});if(n!=null&&n.id)await chrome.runtime.sendMessage({type:"popupCreated",tabId:Mr,popupId:n.id});else throw new Error("Failed to create popup window.")}catch(t){console.error("Error during detach:",t),ct(`Error detaching chat: ${t.message}`)}}async function SE(e){if(!(!e||!e.pageId)){if(console.log(`[Sidepanel] Navigation changed to: ${e.pageId}`),!jp){console.log("[Sidepanel] DB not ready yet, skipping session load on initial navigation event.");return}if(e.pageId==="page-home"){console.log("[Sidepanel] Navigated to home page, checking for specific session load signal...");try{const{lastSessionId:t}=await chrome.storage.local.get(["lastSessionId"]);t?(console.log(`[Sidepanel] Found load signal: ${t}. Loading session and clearing signal.`),await ca(t),await chrome.storage.local.remove("lastSessionId")):(console.log("[Sidepanel] No load signal found. Resetting to welcome state."),await ca(null))}catch(t){console.error("[Sidepanel] Error checking/loading session based on signal:",t),ct("Failed to load session state."),await ca(null)}}}}
//# sourceMappingURL=sidepanel.js.map
