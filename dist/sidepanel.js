var Dm=Object.defineProperty;var Ql=e=>{throw TypeError(e)};var Om=(e,t,r)=>t in e?Dm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var lt=(e,t,r)=>Om(e,typeof t!="symbol"?t+"":t,r),Gl=(e,t,r)=>t.has(e)||Ql("Cannot "+r);var W=(e,t,r)=>(Gl(e,t,"read from private field"),r?r.call(e):t.get(e)),je=(e,t,r)=>t.has(e)?Ql("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),Ue=(e,t,r,n)=>(Gl(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);const Pm="modulepreload",Rm=function(e){return"/"+e},Yl={},Lm=function(t,r,n){let o=Promise.resolve();if(r&&r.length>0){let c=function(p){return Promise.all(p.map(m=>Promise.resolve(m).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));o=c(r.map(p=>{if(p=Rm(p),p in Yl)return;Yl[p]=!0;const m=p.endsWith(".css"),v=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${v}`))return;const w=document.createElement("link");if(w.rel=m?"stylesheet":Pm,m||(w.as="script"),w.crossOrigin="",w.href=p,d&&w.setAttribute("nonce",d),document.head.appendChild(w),m)return new Promise((_,E)=>{w.addEventListener("load",_),w.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${p}`)))})}))}function a(c){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=c,window.dispatchEvent(u),!u.defaultPrevented)throw c}return o.then(c=>{for(const u of c||[])u.status==="rejected"&&a(u.reason);return t().catch(a)})};let mf=[],Yc=[],ri=null;const Jl={"page-home":"Tab Agent","page-spaces":"Spaces","page-library":"Library","page-settings":"Settings"};async function Ka(e){console.log(`Navigating to ${e}`),mf.forEach(o=>{o.classList.add("hidden"),o.classList.remove("active-page")});const t=document.getElementById(e);if(t)t.classList.remove("hidden"),t.classList.add("active-page");else{console.error(`Navigation error: Page with ID ${e} not found. Showing home.`);const o=document.getElementById("page-home");o&&(o.classList.remove("hidden"),o.classList.add("active-page")),e="page-home"}ri&&Jl[e]?ri.textContent=Jl[e]:ri&&(ri.textContent="Tab Agent"),Yc.forEach(o=>{o.dataset.page===e?o.classList.add("active"):o.classList.remove("active")});const{eventBus:r}=await Lm(async()=>{const{eventBus:o}=await Promise.resolve().then(()=>Am);return{eventBus:o}},void 0);r.publish("navigation:pageChanged",{pageId:e}),console.log(`[Navigation] Published navigation:pageChanged event for ${e}`);const n=document.getElementById("query-input");e==="page-home"&&n&&n.focus()}function $m(){console.log("Initializing navigation..."),mf=document.querySelectorAll(".page-container"),Yc=document.querySelectorAll(".nav-button"),ri=document.querySelector("#header h1"),Yc.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&Ka(t)})}),Ka("page-home"),console.log("Navigation initialized.")}class Mm{constructor(){this.listeners=new Map}subscribe(t,r){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(r)}unsubscribe(t,r){if(this.listeners.has(t)){const n=this.listeners.get(t),o=n.indexOf(r);o>-1&&n.splice(o,1),n.length===0&&this.listeners.delete(t)}}publish(t,r){const n=this.listeners.get(t);if(n&&n.length>0)try{const o=structuredClone(r);console.log(`[EventBus] Publishing ${t}. Found ${n.length} listeners. Data to send:`,JSON.stringify(o)),n.forEach((a,c)=>{try{console.log(`[EventBus] Calling listener #${c+1} for ${t} with data:`,JSON.stringify(o)),a(o)}catch(u){console.error(`[EventBus] Error in listener #${c+1} for ${t}:`,u)}})}catch(o){console.error(`[EventBus] Failed to structuredClone data for event ${t}:`,o,r)}else console.log(`[EventBus] No listeners registered for event ${t}.`)}}const V=new Mm,Am=Object.freeze(Object.defineProperty({__proto__:null,eventBus:V},Symbol.toStringTag,{value:"Module"}));function Tm(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,r=e=="x"?t:t&3|8;return r.toString(16)})}class St{constructor(t=null){this.requestId=t||Tm(),this.timestamp=Date.now()}}class Gt extends St{constructor(t,r,n=null,o=null){super(t),this.success=r,this.data=n,this.error=o?o.message||String(o):null}}class Du{constructor(t){this.sessionId=t,this.timestamp=Date.now()}}class uo extends Gt{constructor(t,r,n,o=null){super(t,r,n,o),this.type=uo.name}}class lo extends Gt{constructor(t,r,n,o=null){super(t,r,{newMessageId:n},o),this.type=lo.name}}class fo extends Gt{constructor(t,r,n=null){super(t,r,null,n),this.type=fo.name}}class ho extends Gt{constructor(t,r,n=null){super(t,r,null,n),this.type=ho.name}}class po extends Gt{constructor(t,r,n=null){super(t,r,null,n),this.type=po.name}}class mo extends Gt{constructor(t,r,n,o=null){super(t,r,n,o),this.type=mo.name}}class go extends Gt{constructor(t,r,n,o=null){super(t,r,{newSessionId:n},o),this.type=go.name,console.log(`[dbEvents] DbCreateSessionResponse constructor: type set to ${this.type}`)}get newSessionId(){var t;return(t=this.data)==null?void 0:t.newSessionId}}class vo extends Gt{constructor(t,r,n=null){super(t,r,null,n),this.type=vo.name}}class yo extends Gt{constructor(t,r,n=null){super(t,r,null,n),this.type=yo.name}}class bo extends Gt{constructor(t,r,n=null,o=null){super(t,r,n,o),this.type=bo.name,this.payload={sessions:n}}}class wo extends Gt{constructor(t,r,n=null,o=null){super(t,r,n,o),this.type=wo.name}}const hs=class hs extends St{constructor(t){super(),this.type=hs.name,this.payload={sessionId:t}}};lt(hs,"responseEventName",uo.name);let wr=hs;var gn;let pi=(gn=class extends St{constructor(t,r){super(),this.type=gn.name,this.payload={sessionId:t,messageObject:r}}},lt(gn,"responseEventName",lo.name),gn);const ps=class ps extends St{constructor(t,r,n){super(),this.type=ps.name,this.payload={sessionId:t,messageId:r,updates:n}}};lt(ps,"responseEventName",fo.name);let Lt=ps;const ms=class ms extends St{constructor(t,r){super(),this.type=ms.name,this.payload={sessionId:t,status:r}}};lt(ms,"responseEventName",ho.name);let Qe=ms;const gs=class gs extends St{constructor(t,r){super(),this.type=gs.name,this.payload={sessionId:t,messageId:r}}};lt(gs,"responseEventName",po.name);let Ha=gs;const vs=class vs extends St{constructor(t){super(),this.type=vs.name,this.payload={sessionId:t}}};lt(vs,"responseEventName",mo.name);let _o=vs;const ys=class ys extends St{constructor(t){super(),this.type=ys.name,this.payload={initialMessage:t},console.log(`[dbEvents] DbCreateSessionRequest constructor: type set to ${this.type}`)}};lt(ys,"responseEventName",go.name);let So=ys;class mi extends St{constructor(){super(),this.type=mi.name,this.payload={}}}const bs=class bs extends St{constructor(t){super(),this.type=bs.name,this.payload={sessionId:t}}};lt(bs,"responseEventName",vo.name);let Eo=bs;const ws=class ws extends St{constructor(t,r){super(),this.type=ws.name,this.payload={sessionId:t,newName:r}}};lt(ws,"responseEventName",yo.name);let Io=ws;const _s=class _s extends St{constructor(){super(),this.type=_s.name}};lt(_s,"responseEventName",bo.name);let gi=_s;const Ss=class Ss extends St{constructor(){super(),this.type=Ss.name}};lt(Ss,"responseEventName",wo.name);let vi=Ss;class et extends Du{constructor(t,r){super(t),this.type=et.name,this.payload={messages:r}}}class er extends Du{constructor(t,r){super(t),this.type=er.name,this.payload={status:r}}}class xn extends Du{constructor(t,r){super(t),this.type=xn.name,this.payload={session:r}}}class Ur{constructor({success:t,error:r=null}){this.type=Ur.name,this.timestamp=Date.now(),this.payload={success:t,error:r?r.message||String(r):null}}}function $e(e,t="info",r=3e3){console.log(`[Notification] ${t.toUpperCase()}: ${e} (Duration: ${r}ms)`)}function st(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="1000",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function Ou(e,t){let r;return function(...o){const a=()=>{clearTimeout(r),e(...o)};clearTimeout(r),r=setTimeout(a,t)}}const Nm=/^(https?):\/\/[^\s/$.?#].[^\s]*$/i;function Jc(){return new Promise((e,t)=>{if(typeof chrome>"u"||!chrome.tabs)return console.warn("Utils: Chrome tabs API not available. Cannot get active tab."),e(null);chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError)return console.error("Utils: Error querying active tab:",chrome.runtime.lastError.message),e(null);r&&r.length>0?e(r[0]):e(null)})})}let Te=null,Jn=null,Xc=null,Ca=null;const gf="temp-status-message";function Bm(e,t){if(!e){console.error("[ChatRenderer] chatBody element is required for initialization.");return}if(!t){console.error("[ChatRenderer] requestDbAndWait function is required for initialization.");return}Te=e,Xc=t,console.log("[ChatRenderer] Initialized with chat body element and DB request function."),V.subscribe(et.name,jm),console.log("[ChatRenderer] Subscribed to DbMessagesUpdatedNotification."),V.subscribe(xn.name,Um),console.log("[ChatRenderer] Subscribed to DbSessionUpdatedNotification."),Hm()}function qm(e){console.log(`[ChatRenderer] Setting active session ID to: ${e}`),Jn=e,Te&&(Te.innerHTML=""),e?(console.log(`[ChatRenderer] Proactively loading messages for new session: ${e}`),Fm(e)):ai()}function ai(){if(!Te)return;Te.innerHTML="";const e={messageId:"welcome-msg",sender:"system",text:"Welcome to Tab Agent! Ask me anything or paste a URL to scrape.",timestamp:Date.now(),isLoading:!1};Pu(e)}function Is(){Te&&requestAnimationFrame(()=>{Te.scrollTop=Te.scrollHeight})}async function Fm(e){if(!Xc){console.error("[ChatRenderer] Cannot load messages: requestDbAndWait function not available."),Te&&(Te.innerHTML='<div class="p-4 text-red-500">Error: Cannot load chat messages.</div>');return}if(!e){console.warn("[ChatRenderer] loadAndRenderMessages called with null sessionId. Displaying welcome."),ai();return}console.log(`[ChatRenderer] Requesting messages for session ${e}...`);try{const t=new wr(e),r=await Xc(t);r&&r.messages?(console.log(`[ChatRenderer] Received ${r.messages.length} messages for ${e}. Rendering.`),Te&&(Te.innerHTML=""),r.messages.length===0?ai():(r.messages.forEach(n=>Pu(n)),Is())):(console.warn(`[ChatRenderer] No messages found in session data for ${e}. Displaying welcome.`,r),ai())}catch(t){console.error(`[ChatRenderer] Failed to load messages for session ${e}:`,t),st(`Failed to load chat: ${t.message}`),Te&&(Te.innerHTML=`<div class="p-4 text-red-500">Failed to load chat: ${t.message}</div>`)}}function jm(e){if(!(!e||!e.sessionId||!e.payload)&&e.sessionId===Jn){console.log(`[ChatRenderer] Received message update notification for active session ${Jn}. Rendering.`);let t=e.payload.messages;if(!Array.isArray(t))if(Array.isArray(e.payload))console.warn("[ChatRenderer] Payload did not have .messages, using payload directly as array."),t=e.payload;else{console.error("[ChatRenderer] Invalid messages structure: Expected array, got:",e.payload);return}if(console.log("[ChatRenderer] Messages array received:",JSON.stringify(t)),!Te)return;Te.innerHTML="",t.length===0?(console.log(`[ChatRenderer] Active session ${Jn} has no messages. Displaying welcome.`),ai()):(t.forEach(r=>Pu(r)),Is())}}function Um(e){var t;if(!(!e||!e.sessionId||!((t=e.payload)!=null&&t.session))&&e.sessionId===Jn){const r=e.payload.session;console.log(`[ChatRenderer] Received metadata update for active session ${Jn}. New Title: ${r.title}, Starred: ${r.isStarred}`),Km(r)}}function Km(e){console.log(e?`[ChatRenderer] Updating chat header for ${e.id}. Title: ${e.title}, Starred: ${e.isStarred}`:"[ChatRenderer] Clearing chat header (no active session).")}function Pu(e){var c,u,d,p;if(!Te)return;const t=document.createElement("div");t.classList.add("flex","mb-2"),t.id=e.messageId||`msg-fallback-${Date.now()}-${Math.random().toString(36).substring(2)}`;const r=document.createElement("div");r.classList.add("rounded-lg","break-words","relative","group","p-2","max-w-4xl");const n=document.createElement("div");n.className="copy-button-container absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity";const o=document.createElement("button");o.innerHTML='<svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>',o.className="copy-button p-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600",o.title="Copy text",o.onclick=m=>{m.stopPropagation();const v=r.querySelector("pre code")||r.querySelector(".prose")||r,w=(v==null?void 0:v.textContent)||"";navigator.clipboard.writeText(w).then(()=>$e("Copied!","success",1500)).catch(_=>{console.error("Failed to copy:",_),$e("Copy failed","error",1500)})},n.appendChild(o),r.appendChild(n);let a=null;if(((c=e.metadata)==null?void 0:c.type)==="scrape_result"){t.classList.add("justify-start"),r.classList.add("bg-gray-200","dark:bg-gray-600");const m=document.createElement("div");m.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),m.textContent=`Scraped (${e.metadata.method||"N/A"}): ${e.metadata.title||e.metadata.url||"Content"}`,r.appendChild(m);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-64","text-sm","prose","prose-sm","dark:prose-invert","whitespace-pre-wrap","mt-1"),v.textContent=e.text||"",r.appendChild(v)}else if(((u=e.metadata)==null?void 0:u.type)==="scrape_stage_result"){t.classList.add("justify-start"),r.classList.add("border","border-gray-300","dark:border-gray-600");const m=document.createElement("div");if(m.classList.add("text-xs","font-semibold","mb-1","pr-6"),e.metadata.success){r.classList.add("bg-gray-100","dark:bg-gray-700"),m.classList.add("text-gray-700","dark:text-gray-300"),m.textContent=`[Stage ${e.metadata.stage} - ${e.metadata.method||"?"} - OK] Len: ${e.metadata.length||0}`,r.appendChild(m);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-64","mt-1");const w=document.createElement("pre");w.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),a=document.createElement("code"),a.className="language-json";const _={title:e.metadata.title||"N/A",links:e.metadata.links};a.textContent=JSON.stringify(_,null,2),w.appendChild(a),v.appendChild(w),r.appendChild(v)}else r.classList.add("bg-red-100","dark:bg-red-900"),m.classList.add("text-red-700","dark:text-red-300"),m.textContent=`[Stage ${e.metadata.stage} - Failed] ${e.metadata.error||"Unknown"}`,r.appendChild(m)}else if(((d=e.metadata)==null?void 0:d.type)==="scrape_result_full"){t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","border","border-gray-300","dark:border-gray-600");const m=document.createElement("div");m.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),m.textContent=`Full Scrape Result: ${((p=e.metadata.scrapeData)==null?void 0:p.title)||"No Title"}`,r.appendChild(m);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-96","mt-1");const w=document.createElement("pre");w.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),a=document.createElement("code"),a.className="language-json";try{a.textContent=JSON.stringify(e.metadata.scrapeData||{error:"No scrape data found"},null,2)}catch(_){console.error("Error stringifying scrapeData:",_),a.textContent=JSON.stringify({error:"Failed to stringify scrape data",details:_.message},null,2)}w.appendChild(a),v.appendChild(w),r.appendChild(v)}else r.textContent=e.text||"",e.isLoading?(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-500","dark:text-gray-400","italic")):e.sender==="user"?(t.classList.add("justify-end"),r.classList.add("bg-blue-500/20","dark:bg-blue-600/40","text-gray-900","dark:text-gray-100")):e.sender==="error"?(t.classList.add("justify-start"),r.classList.add("bg-red-100","dark:bg-red-900","text-red-700","dark:text-red-300")):(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-900","dark:text-gray-100"));if(t.appendChild(r),Te.appendChild(t),a&&window.Prism)try{Prism.highlightElement(a)}catch(m){console.warn("Prism highlighting failed:",m)}}function Gn(e,t){if(!Te)return;e!=="system"&&console.log(`[ChatRenderer] Rendering temporary message (${e}): ${t}`);const r=document.createElement("div");r.classList.add("message",`message-${e}`,gf),r.style.padding="8px 12px",r.style.borderRadius="8px",r.style.marginBottom="10px",r.style.maxWidth="90%",r.style.alignSelf="center",r.style.backgroundColor=e==="error"?"#fee2e2":e==="success"?"#dcfce7":"#f3f4f6",r.style.color=e==="error"?"#b91c1c":e==="success"?"#166534":"#374151",document.documentElement.classList.contains("dark")&&(r.style.backgroundColor=e==="error"?"#450a0a":e==="success"?"#14532d":"#374151",r.style.color=e==="error"?"#fca5a5":e==="success"?"#bbf7d0":"#d1d5db"),r.textContent=t,Te.appendChild(r),Is()}function yi(){if(!Te)return;console.log("[ChatRenderer] Clearing temporary status messages."),Te.querySelectorAll(`.${gf}`).forEach(t=>t.remove())}function Hm(){Ca&&Ca.disconnect(),Ca=new MutationObserver(e=>{e.forEach(t=>{t.type==="childList"&&t.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="PRE"){const n=r.querySelector('code[class*="language-"]');n&&window.Prism&&Prism.highlightElement(n)}else r.nodeType===Node.ELEMENT_NODE&&r.querySelectorAll('pre code[class*="language-"]').forEach(o=>{o.classList.contains("prism-highlighted")||(window.Prism&&Prism.highlightElement(o),o.classList.add("prism-highlighted"))})})})}),Te?(Ca.observe(Te,{childList:!0,subtree:!0}),console.log("[ChatRenderer] MutationObserver initialized and observing chat body.")):console.error("[ChatRenderer] Cannot initialize MutationObserver: chatBody is null.")}let le,rt,za,pr,wn,Ke,Ut=!1,Zc=null,vf=null;const eu={"Xenova/Qwen1.5-1.8B-Chat":"Qwen 1.8B Chat (Quantized)","Xenova/Phi-3-mini-4k-instruct":"Phi-3 Mini Instruct (Quantized)","HuggingFaceTB/SmolLM-1.7B-Instruct":"SmolLM 1.7B Instruct","HuggingFaceTB/SmolLM2-1.7B":"SmolLM2 1.7B","google/gemma-3-4b-it-qat-q4_0-gguf":"Gemma 3 4B IT Q4 (GGUF)","bubblspace/Bubbl-P4-multimodal-instruct":"Bubbl-P4 Instruct (Multimodal)","microsoft/Phi-4-multimodal-instruct":"Phi-4 Instruct (Multimodal)","microsoft/Phi-4-mini-instruct":"Phi-4 Mini Instruct","Qwen/Qwen3-4B":"Qwen/Qwen3-4B","google/gemma-3-1b-pt":"google/gemma-3-1b-pt","HuggingFaceTB/SmolLM2-360M":"HuggingFaceTB/SmolLM2-360M"};function zm(){return le=document.getElementById("query-input"),rt=document.getElementById("send-button"),za=document.getElementById("chat-body"),pr=document.getElementById("attach-button"),wn=document.getElementById("file-input"),document.getElementById("loading-indicator"),!le||!rt||!za||!pr||!wn?(console.error("UIController: One or more essential elements not found (excluding session list)!"),!1):!0}function Wm(){le==null||le.addEventListener("input",Mo),le==null||le.addEventListener("keydown",yf),rt==null||rt.addEventListener("click",bf),pr==null||pr.addEventListener("click",wf)}function Vm(){le==null||le.removeEventListener("input",Mo),le==null||le.removeEventListener("keydown",yf),rt==null||rt.removeEventListener("click",bf),pr==null||pr.removeEventListener("click",wf)}function yf(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const t=Lu();t&&!le.disabled?(console.log("[UIController] Enter key pressed. Publishing ui:querySubmitted"),V.publish("ui:querySubmitted",{text:t}),Cs()):console.log("[UIController] Enter key pressed, but input is empty or disabled.")}}function bf(){const e=Lu();e&&!le.disabled?(console.log("[UIController] Send button clicked. Publishing ui:querySubmitted"),V.publish("ui:querySubmitted",{text:e}),Cs()):console.log("[UIController] Send button clicked, but input is empty or disabled.")}function wf(){Zc&&Zc()}function Mo(){if(!le)return;le.style.height="auto";const e=150,t=le.scrollHeight;le.style.height=`${Math.min(t,e)}px`,rt&&(rt.disabled=le.value.trim()===""||le.disabled)}function Ru(e){if(console.log(`[UIController] setInputStateInternal called with status: ${e}`),!(!Ut||!le||!rt)){switch(e){case"processing":le.disabled=!0,rt.disabled=!0;break;case"error":case"idle":case"complete":default:le.disabled=!1,Mo();break}console.log(`[UIController] Input disabled state: ${le.disabled}`)}}function Xl(e){!Ut||!e||!e.sessionId||!e.payload||e.sessionId===vf&&Ru(e.payload.status||"idle")}function Zl(e){if(!Ut||!e)return;console.warn("[UIController] Model load progress bar not found.");const{status:t,file:r,progress:n,model:o}=e;let a=t;t==="progress"?(a=`Downloading ${r}... ${Math.round(n)}%`,Gn("system",a),Kr("loading",`Down: ${Math.round(n)}%`)):t==="download"||t==="ready"?(a=`Loading ${r}...`,Gn("system",a),Kr("loading",`Loading ${r}`)):t==="done"?(a=`${r} loaded. Preparing pipeline...`,Gn("system",a),Kr("loading","Preparing...")):(Gn("system",a),Kr("loading",t))}async function _f(e){if(console.log("[UIController] Initializing..."),Ut&&(console.warn("[UIController] Already initialized. Removing old listeners and subscriptions."),Vm(),V.unsubscribe(er.name,Xl),V.unsubscribe("ui:loadingStatusUpdate",Zl)),!zm())return Ut=!1,null;Zc=e==null?void 0:e.onAttachFile,Wm();const t=document.getElementById("new-chat-button");t&&(e!=null&&e.onNewChat)&&t.addEventListener("click",e.onNewChat),V.subscribe(er.name,Xl),V.subscribe("ui:loadingStatusUpdate",Zl),console.log("[UIController] Subscribed to DB Status & Loading Status notifications."),Ut=!0,Ru("idle"),Mo(),console.log("[UIController] Initialized successfully."),console.log(`[UIController] Returning elements: chatBody is ${za?"found":"NULL"}, fileInput is ${wn?"found":"NULL"}`),yi(),Ke=document.getElementById("load-model-button"),Ke?Ke.addEventListener("click",Ym):console.error("[UIController] Load Model button not found!"),$u("Model not loaded. Click 'Load'."),Kr("idle"),console.log("[UIController] Initializing UI elements..."),console.log("[UIController] Attempting to find model selector...");const r=document.getElementById("model-selector");if(console.log(r?"[UIController] Model selector found.":"[UIController] WARNING: Model selector NOT found!"),r){r.innerHTML="",console.log("[UIController] Populating model selector. Available models:",eu);for(const[n,o]of Object.entries(eu)){console.log(`[UIController] Adding option: ${o} (${n})`);const a=document.createElement("option");a.value=n,a.textContent=o,r.appendChild(a)}}else console.warn("[UIController] Model selector dropdown not found.");return console.log("[UIController] UI Initialization complete."),{chatBody:za,queryInput:le,sendButton:rt,attachButton:pr,fileInput:wn}}function Sf(e){console.log(`[UIController] Setting active session for UI state: ${e}`),vf=e,e||Ru("idle")}function Qm(){return Ut}function Lu(){return(le==null?void 0:le.value.trim())||""}function Cs(){console.log("[UIController] Entering clearInput function."),le&&(le.value="",Mo())}function Ef(){le==null||le.focus()}function Gm(){wn==null||wn.click()}function Ym(){if(!Ut)return;console.log("[UIController] Load Model button clicked.");const e=document.getElementById("model-selector"),t=e==null?void 0:e.value;if(!t){console.error("[UIController] Cannot load: No model selected or selector not found."),showNotification("Error: Please select a model.","error");return}console.log(`[UIController] Requesting load for model: ${t}`),Kr("loading"),$u(`Loading ${eu[t]||t}...`),V.publish("ui:requestModelLoad",{modelId:t})}function Kr(e,t="Load"){if(!(!Ut||!Ke))switch(e){case"idle":Ke.disabled=!1,Ke.textContent=t,Ke.classList.replace("bg-yellow-500","bg-green-500"),Ke.classList.replace("bg-gray-500","bg-green-500");break;case"loading":Ke.disabled=!0,Ke.textContent=t==="Load"?"Loading...":t,Ke.classList.replace("bg-green-500","bg-yellow-500"),Ke.classList.replace("bg-gray-500","bg-yellow-500");break;case"loaded":Ke.disabled=!0,Ke.textContent="Loaded",Ke.classList.replace("bg-green-500","bg-gray-500"),Ke.classList.replace("bg-yellow-500","bg-gray-500");break;case"error":Ke.disabled=!1,Ke.textContent="Load Failed",Ke.classList.replace("bg-yellow-500","bg-red-500"),Ke.classList.replace("bg-green-500","bg-red-500"),Ke.classList.replace("bg-gray-500","bg-red-500");break}}function $u(e="Processing..."){!Ut||!le||!rt||(le.disabled=!0,le.placeholder=e,rt.disabled=!0)}function Jm(){!Ut||!le||!rt||(le.disabled=!1,le.placeholder="Ask Tab Agent...",rt.disabled=le.value.trim()==="")}V.subscribe("worker:ready",e=>{console.log("[UIController] Received worker:ready signal",e),yi(),Gn("success",`Model ${(e==null?void 0:e.model)||""} ready.`),Jm(),Kr("loaded")});V.subscribe("worker:error",e=>{console.error("[UIController] Received worker:error signal",e),yi(),Gn("error",`Model load failed: ${e}`),Kr("error"),$u("Model load failed. Check logs.")});const Xm=Object.freeze(Object.defineProperty({__proto__:null,adjustTextareaHeight:Mo,checkInitialized:Qm,clearInput:Cs,focusInput:Ef,getInputValue:Lu,initializeUI:_f,setActiveSession:Sf,triggerFileInputClick:Gm},Symbol.toStringTag,{value:"Module"}));let Wa=null,Va=null,tu=null,jt=!1;const Ic=new Map;function Oe(e,t=5e3){return new Promise((r,n)=>{const{requestId:o,type:a}=e,c=p=>{p&&p.requestId===o&&(console.log(`[Orchestrator] Received DB response for ${a} (Req ID: ${o})`),console.log(`[Orchestrator] RAW Received Response Event Object (Req ID: ${o}):`,JSON.stringify(p)),V.unsubscribe(d,c),Ic.delete(o),clearTimeout(u),p.success?r(p.data):n(new Error(p.error||`DB operation ${a} failed`)))},u=setTimeout(()=>{console.error(`[Orchestrator] DB request timed out for ${a} (Req ID: ${o})`),V.unsubscribe(d,c),Ic.delete(o),n(new Error(`DB request timed out for ${a}`))},t);let d;if(a===So.name)d=go.name;else if(a===pi.name)d=lo.name;else if(a===wr.name)d=uo.name;else if(a===Lt.name)d=fo.name;else if(a===Ha.name)d=po.name;else if(a===Qe.name)d=ho.name;else if(a===_o.name)d=mo.name;else if(a===gi.name)d=bo.name;else if(a===vi.name)d=wo.name;else if(a===Eo.name)d=vo.name;else if(a===Io.name)d=yo.name;else if(console.error(`[Orchestrator] Unknown request type for response mapping: ${a}`),d=a.replace("Request","Response"),d===a){n(new Error(`Cannot determine response event type for request: ${a}`));return}console.log(`[Orchestrator] Subscribing responseHandler for ReqID ${o} to event type: ${d}`),V.subscribe(d,c),Ic.set(o,{handler:c,timeoutId:u}),V.publish(e.type,e)})}function Zm(e){if(Wa=e.getActiveSessionIdFunc,Va=e.onSessionCreatedCallback,tu=e.getCurrentTabIdFunc,!Wa||!Va||!tu){console.error("Orchestrator: Missing one or more dependencies during initialization!");return}console.log("[Orchestrator] Initializing and subscribing to application events..."),V.subscribe("ui:querySubmitted",eg),V.subscribe("background:responseReceived",tg),V.subscribe("background:errorReceived",rg),V.subscribe("background:scrapeStageResult",ng),V.subscribe("background:scrapeResultReceived",og),console.log("[Orchestrator] Event subscriptions complete.")}async function eg(e){const{text:t}=e;if(console.log(`Orchestrator: handleQuerySubmit received event with text: "${t}"`),jt){console.warn("Orchestrator: Already processing a previous submission.");return}jt=!0;let r=Wa();const n=tu();let o=null;console.log(`Orchestrator: Processing submission. Text: "${t}". Session: ${r}`);const a=Nm.test(t);try{yi();const c={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};if(r){console.log(`Orchestrator: Adding user message to existing session ${r} via event.`),yi();const v=new pi(r,c);await Oe(v)}else{console.log("Orchestrator: No active session, creating new one via event.");const v=new So(c);if(r=(await Oe(v)).newSessionId,Va)Va(r);else throw console.error("Orchestrator: onSessionCreatedCallback is missing!"),new Error("Configuration error: Cannot notify about new session.")}console.log(`[Orchestrator] Setting session ${r} status to 'processing' via event`);const u=new Qe(r,"processing");await Oe(u);let d;if(a){const v=await Jc(),w=v==null?void 0:v.url,_=B=>B?B.replace("/$",""):null,E=_(t),D=_(w);d={sender:"system",text:v&&v.id&&E===D?`⏳ Scraping active tab: ${t}...`:`⏳ Scraping ${t}...`,timestamp:Date.now(),isLoading:!0}}else d={sender:"ai",text:"Thinking...",timestamp:Date.now(),isLoading:!0};console.log(`[Orchestrator] Adding placeholder to session ${r} via event.`);const p=new pi(r,d);if(o=(await Oe(p)).newMessageId,a){const v=await Jc(),w=v==null?void 0:v.url,_=M=>M?M.replace("/$",""):null,E=_(t),D=_(w);v&&v.id&&E===D?(console.log("Orchestrator: Triggering content script scrape."),chrome.tabs.sendMessage(v.id,{type:"SCRAPE_ACTIVE_TAB"},M=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending SCRAPE_ACTIVE_TAB:",chrome.runtime.lastError.message);const B=new Lt(r,o,{isLoading:!1,sender:"error",text:`Failed to send scrape request: ${chrome.runtime.lastError.message}`});Oe(B).catch(q=>console.error("Failed to update placeholder on send error:",q)),Oe(new Qe(r,"error")).catch(q=>console.error("Failed to set session status on send error:",q)),jt=!1}else console.log("Orchestrator: SCRAPE_ACTIVE_TAB message sent.")})):(console.log("Orchestrator: Triggering background scrape."),chrome.runtime.sendMessage({type:"TEMP_SCRAPE_URL",url:t,tabId:n,chatId:r,messageId:o},M=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending TEMP_SCRAPE_URL:",chrome.runtime.lastError.message);const B=new Lt(r,o,{isLoading:!1,sender:"error",text:`Failed to initiate scrape: ${chrome.runtime.lastError.message}`});Oe(B).catch(q=>console.error("Failed to update placeholder on send error:",q)),Oe(new Qe(r,"error")).catch(q=>console.error("Failed to set session status on send error:",q)),jt=!1}else console.log("Orchestrator: TEMP_SCRAPE_URL message sent successfully.")}))}else{const v={type:"query",tabId:n,text:t,chatId:r,messageId:o};console.log("Orchestrator: Sending query to background:",v),chrome.runtime.sendMessage(v,w=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending query:",chrome.runtime.lastError.message);const _={isLoading:!1,sender:"error",text:`Failed to send query: ${chrome.runtime.lastError.message}`},E=new Lt(r,o,_);Oe(E).catch(D=>console.error("Failed to update placeholder on send error:",D)),Oe(new Qe(r,"error")).catch(D=>console.error("Failed to set session status on send error:",D)),jt=!1}else{console.log("Orchestrator: Received direct response from background for query:",w);let _={},E="idle";w&&w.success?(_={isLoading:!1,sender:"ai",text:w.data||"Received empty successful response."},E="idle"):(_={isLoading:!1,sender:"error",text:`Error: ${(w==null?void 0:w.error)||"Unknown error from background."}`},E="error",console.error("Orchestrator: Background query processing failed:",w==null?void 0:w.error));const D=new Lt(r,o,_);Oe(D).then(()=>(console.log(`[Orchestrator] Setting session ${r} status to '${E}' after query response via event`),Oe(new Qe(r,E)))).catch(M=>{console.error("Failed to update placeholder/status after query response:",M),Oe(new Qe(r,"error")).catch(B=>console.error("Failed to set fallback error status:",B))}).finally(()=>{jt=!1})}})}}catch(c){console.error("Orchestrator: Error processing query submission:",c),st(`Error: ${c.message||c}`),r?(console.log(`[Orchestrator] Setting session ${r} status to 'error' due to processing failure via event`),Oe(new Qe(r,"error")).catch(u=>console.error("Failed to set session status on processing error:",u))):console.error("Orchestrator: Error occurred before session ID was established."),jt=!1}}async function tg(e){const{chatId:t,messageId:r,text:n}=e;console.log(`Orchestrator: handleBackgroundMsgResponse for chat ${t}, placeholder ${r}`);try{const o={isLoading:!1,sender:"ai",text:n||"Received empty response."},a=new Lt(t,r,o);await Oe(a),console.log(`[Orchestrator] Setting session ${t} status to 'idle' after response via event`);const c=new Qe(t,"idle");await Oe(c)}catch(o){console.error(`Orchestrator: Error handling background response for chat ${t}:`,o),st(`Failed to update chat with response: ${o.message||o}`);const a=new Qe(t,"error");Oe(a).catch(c=>console.error("Failed to set session status on response processing error:",c))}finally{jt=!1}}async function rg(e){console.error(`Orchestrator: Received error for chat ${e.chatId}, placeholder ${e.messageId}: ${e.error}`),st(`Error processing request: ${e.error}`);const t=Wa();if(t&&e.chatId===t&&e.messageId){console.log(`Orchestrator: Attempting to update message ${e.messageId} in active session ${t} with error.`);const r={isLoading:!1,sender:"error",text:`Error: ${e.error}`},n=new Lt(t,e.messageId,r),o=new Qe(t,"error");try{await Oe(n),console.log(`Orchestrator: Error message update successful for session ${t}.`),await Oe(o),console.log(`Orchestrator: Session ${t} status set to 'error'.`)}catch(a){console.error("Orchestrator: Error updating chat/status on background error:",a),st(`Failed to update chat with error status: ${a.message}`);try{await Oe(new Qe(t,"error"))}catch(c){console.error("Failed to set session status on error handling error:",c)}}}else console.warn(`Orchestrator: Received error, but no active session ID (${t}) or message ID (${e.messageId}) matches the error context (${e.chatId}). Not updating DB.`);jt=!1}async function ng(e){const{stage:t,success:r,chatId:n,messageId:o,error:a,...c}=e;console.log(`Orchestrator: handleBackgroundScrapeStage Stage ${t}, chatId: ${n}, Success: ${r}`);let u={},d="idle";if(r)console.log(`Orchestrator: Scrape stage ${t} succeeded for chat ${n}.`),u={isLoading:!1,sender:"system",text:`Full Scrape Result: ${c.title||"No Title"}`,metadata:{type:"scrape_result_full",scrapeData:c}},d="idle";else{const p=a||`Scraping failed (Stage ${t}). Unknown error.`;console.error(`Orchestrator: Scrape stage ${t} failed for chat ${n}. Error: ${p}`),u={isLoading:!1,sender:"error",text:`Scraping failed (Stage ${t}): ${p}`},d="error"}try{console.log(`Orchestrator: Updating message ${o} for stage ${t} result.`);const p=new Lt(n,o,u);await Oe(p),console.log(`Orchestrator: Updated placeholder ${o} with stage ${t} result.`),console.log(`[Orchestrator] Setting session ${n} status to '${d}' after stage ${t} result via event`);const m=new Qe(n,d);await Oe(m)}catch(p){if(console.error(`Orchestrator: Failed to update DB after stage ${t} result:`,p),st(`Failed to update chat with scrape result: ${p.message||p}`),d!=="error")try{const m=new Qe(n,"error");await Oe(m)}catch(m){console.error("Failed to set fallback error status:",m)}}finally{jt=!1,console.log("Orchestrator: Resetting isSendingMessage after processing scrape stage result.")}}async function og(e){const{chatId:t,messageId:r,success:n,error:o,...a}=e;console.log(`Orchestrator: handleBackgroundDirectScrapeResult for chat ${t}, placeholder ${r}, Success: ${n}`);const c={isLoading:!1};n?(c.sender="system",c.text=a.text||a.excerpt||"Scraped content (no text found).",c.metadata={type:"scrape_result",method:a.method||"unknown",url:a.url,title:a.title}):(c.sender="error",c.text=`Scraping failed: ${o||"Unknown error."}`);try{const u=new Lt(t,r,c);await Oe(u);const d=n?"idle":"error";console.log(`[Orchestrator] Setting session ${t} status to '${d}' after direct scrape result via event`);const p=new Qe(t,d);await Oe(p)}catch(u){console.error(`Orchestrator: Error handling direct scrape result for chat ${t}:`,u),st(`Failed to update chat with direct scrape result: ${u.message||u}`);const d=new Qe(t,"error");Oe(d).catch(p=>console.error("Failed to set session status on direct scrape processing error:",p))}finally{jt=!1}}let Qa=null,Ga=null;function ig(e){Qa=e.getActiveSessionIdFunc,Ga=e.uiController,!Qa||!Ga?console.error("FileHandler: Missing getActiveSessionIdFunc or uiController dependency!"):console.log("[FileHandler] Initialized (Note: DB/Renderer interaction via events assumed).")}async function ag(e){if(!Qa){console.error("FileHandler: Not initialized properly (missing getActiveSessionIdFunc).");return}const t=e.target.files;if(!t||t.length===0){console.log("FileHandler: No file selected.");return}const r=t[0];console.log(`FileHandler: File selected - ${r.name}, Type: ${r.type}, Size: ${r.size}`);const n=Qa();if(!n){st("Please start or select a chat before attaching a file."),e.target.value="";return}const o={sender:"system",text:`📎 Attached file: ${r.name}`,timestamp:Date.now(),isLoading:!1};try{const a=new DbAddMessageRequest(n,o);eventBus.publish(DbAddMessageRequest.name,a),console.log("[FileHandler] Published DbAddMessageRequest for file attachment.")}catch(a){console.error("FileHandler: Error publishing file attachment message event:",a),st("Failed to process file attachment.")}finally{e.target.value=""}}function sg(){if(!Ga){console.error("FileHandler: UI Controller not available to trigger file input.");return}console.log("FileHandler: Triggering file input click."),Ga.triggerFileInputClick()}const Cc='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>',cg='<svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 17.8798 20.1818C17.1169 21 15.8356 21 13.2731 21H10.7269C8.16438 21 6.8831 21 6.12019 20.1818C5.35728 19.3671 5.27811 18.0864 5.11973 15.5251L4.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M3 5.5H21M16.5 5.5L16.1733 3.57923C16.0596 2.8469 15.9989 2.48073 15.8184 2.21449C15.638 1.94825 15.362 1.75019 15.039 1.67153C14.7158 1.59286 14.3501 1.59286 13.6186 1.59286H10.3814C9.64993 1.59286 9.28419 1.59286 8.96099 1.67153C8.63796 1.75019 8.36201 1.94825 8.18156 2.21449C8.00111 2.48073 7.9404 2.8469 7.82672 3.57923L7.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M14 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',ug='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 action-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>',lg='<img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">';function dg(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(e.classList.add("is-editing"),t.style.display="none",r.style.display="block",r.value=t.textContent,r.focus(),r.select())}function ei(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(r.style.display="none",t.style.display="block",e.classList.remove("is-editing"))}function If(e){const{entry:t,onStarClick:r=()=>{},onDownloadClick:n=()=>{},onDeleteClick:o=()=>{},onLoadClick:a=()=>{},onRenameSubmit:c=()=>{},onShareClick:u=()=>{},onPreviewClick:d=()=>{}}=e;if(!t||!t.id)return console.error("renderHistoryItemComponent: Invalid entry data provided",t),null;const p=document.createElement("div");p.className="history-item group relative mb-2",p.dataset.id=t.id,t.isStarred&&p.classList.add("starred");const v=new Date(t.timestamp).toLocaleString(),w=t.title||(t.messages&&t.messages.length>0?(t.messages[0].text||"").substring(0,50)+"...":"Empty chat"),_=t.isStarred?"icons/StarFilled.png":"icons/StarHollow.png",E=t.isStarred?"starred":"unstarred";p.innerHTML=`
        <div class="chat-card bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-3 flex flex-col justify-between min-h-[100px]">
            <div>
                <div class="card-header flex justify-between items-center mb-2">
                    <button data-action="toggle-star" class="action-button history-item-star-toggle ${E}" title="Toggle Star">
                         <img src="${_}" alt="Star" class="w-4 h-4 action-icon-img ${t.isStarred?"":"icon-unstarred"}">
                    </button>
                    <div class="actions flex items-center space-x-1">
                        <!-- Normal Actions (initially visible) -->
                        <div class="normal-actions flex items-center space-x-1" data-normal-container>
                             <button data-action="download-chat" class="action-button" title="Download">${ug}</button>
                             <button data-action="share-chat" class="action-button" title="Share">${lg}</button>
                             <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${cg}</button>
                             <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${Cc}</button>
                        </div>
                        <!-- Confirm Delete Actions (initially hidden) -->
                        <div class="confirm-delete-actions hidden flex items-center space-x-1" data-confirm-container>
                            <span class="text-xs text-red-600 dark:text-red-400 mr-1">Confirm?</span>
                            <button data-action="confirm-delete" class="action-button text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300" title="Confirm Delete">
                                <svg class="w-4 h-4 action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> <!-- Checkmark -->
                            </button>
                            <button data-action="cancel-delete" class="action-button text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" title="Cancel Delete">
                                <svg class="w-4 h-4 action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> <!-- X mark -->
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body mb-1">
                    <div class="history-item-preview font-semibold text-sm truncate" title="${w}">${w}</div>
                    <input type="text" class="history-item-rename-input w-full text-sm p-1 border rounded" value="${w}" style="display: none;"/>
                </div>
                <div class="history-item-preview-content hidden mt-2 p-2 border-t border-gray-200 dark:border-gray-600 text-xs max-h-24 overflow-y-auto">
                     <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="card-footer mt-auto flex justify-between items-center">
                 <span class="history-item-date text-xs text-gray-500 dark:text-gray-400">${v}</span>
                 <button class="history-item-load-btn text-xs p-0.5 rounded" data-action="load-chat" title="Load Chat">
                    <img src="icons/Load.png" alt="Load" class="h-6 w-auto">
                 </button>
            </div>
        </div>
    `;const D=p.querySelector(".history-item-preview"),M=p.querySelector(".history-item-rename-input");D&&M&&(D.addEventListener("dblclick",J=>{J.stopPropagation(),dg(p)}),M.addEventListener("blur",()=>{const J=M.value.trim(),be=D.textContent;J&&J!==be&&(c(t.id,J),D.textContent=J,D.title=J),ei(p)}),M.addEventListener("keydown",J=>{if(J.key==="Enter"){J.preventDefault();const be=M.value.trim(),Ce=D.textContent;be&&be!==Ce?c(t.id,be):ei(p)}else J.key==="Escape"&&(J.preventDefault(),ei(p))}));const B=p.querySelector('[data-action="toggle-star"]');B&&B.addEventListener("click",J=>{J.stopPropagation(),r(t.id)});const q=p.querySelector('[data-action="download-chat"]');q&&q.addEventListener("click",J=>{J.stopPropagation(),n(t.id)});const G=p.querySelector('[data-action="share-chat"]');G&&G.addEventListener("click",J=>{J.stopPropagation(),u(t.id)});const ae=p.querySelector('[data-action="delete-chat"]'),ie=p.querySelector("[data-normal-container]"),Z=p.querySelector("[data-confirm-container]"),ne=p.querySelector('[data-action="confirm-delete"]'),pe=p.querySelector('[data-action="cancel-delete"]');ae&&ie&&Z&&ae.addEventListener("click",J=>{J.stopPropagation(),p.classList.contains("is-editing")&&ei(p),p.classList.add("is-confirming-delete"),ie.classList.add("hidden"),Z.classList.remove("hidden")}),pe&&ie&&Z&&pe.addEventListener("click",J=>{J.stopPropagation(),p.classList.remove("is-confirming-delete"),ie.classList.remove("hidden"),Z.classList.add("hidden")}),ne&&ie&&Z&&ne.addEventListener("click",J=>{J.stopPropagation(),p.classList.remove("is-confirming-delete"),o(t.id,p)});const ye=p.querySelector('[data-action="preview-chat"]'),Ie=p.querySelector(".history-item-preview-content");ye&&Ie&&ye.addEventListener("click",J=>{J.stopPropagation(),!Ie.classList.contains("hidden")?(Ie.classList.add("hidden"),Ie.innerHTML="",p.classList.remove("preview-active"),ye.innerHTML=Cc,console.log(`HistoryItem: Hiding preview for ${t.id}`)):(document.querySelectorAll(".history-item.preview-active").forEach(Ce=>{if(Ce!==p){const De=Ce.querySelector(".history-item-preview-content"),nt=Ce.querySelector('[data-action="preview-chat"]');De&&(De.classList.add("hidden"),De.innerHTML=""),Ce.classList.remove("preview-active"),nt&&(nt.innerHTML=Cc)}}),p.classList.add("preview-active"),ye.innerHTML='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>',Ie.classList.remove("hidden"),console.log(`HistoryItem: Requesting preview for ${t.id}`),d(t.id,Ie))});const Re=p.querySelector('[data-action="load-chat"]');return Re&&Re.addEventListener("click",J=>{J.stopPropagation(),a(t.id)}),p.querySelector(".card-body"),p}function fg(e){if(!e)return"";const t=e.title||"Chat Session",r=(e.messages||[]).map(o=>{const a=o.sender==="user"?"user-message":"other-message",c=o.sender==="user"?"You":o.sender==="ai"?"Agent":"System",d=o.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return`
            <div class="message-row ${a==="user-message"?"row-user":"row-other"}">
                <div class="message-bubble ${a}">
                    <span class="sender-label">${c}:</span>
                    <div class="message-text">${d}</div>
                </div>
            </div>
        `}).join(`
`);return`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</title>
            <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: 20px auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-top: 0; }
        .chat-body { margin-top: 20px; }
        .message-row { margin-bottom: 15px; overflow: hidden; /* Clear floats */ }
        .row-user { text-align: right; }
        .row-other { text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; max-width: 75%; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; /* Align right */ }
        .other-message { background-color: #e9ecef; color: #343a40; margin-right: auto; /* Align left */ }
        .sender-label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: inherit; }
        .message-text { margin-top: 5px; }
    </style>
        </head>
        <body>
            <div class="container">
                <h1>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</h1>
                <div class="chat-body">
                    ${r}
                </div>
            </div>
        </body>
        </html>
    `}function hg(e,t,r){try{const n=new Blob([e],{type:"text/html"}),o=URL.createObjectURL(n);console.log(`Initiating download for: ${t} (prompting user)`),chrome.downloads.download({url:o,filename:t,saveAs:!0},a=>{const c=chrome.runtime.lastError;if(setTimeout(()=>URL.revokeObjectURL(o),100),c){const u=c.message;console.error("Download API error:",u),!u||!u.toLowerCase().includes("cancel")?r?r(`Download failed: ${u||"Unknown error"}`):(console.error("No error handler provided for download failure."),alert(`Download failed: ${u||"Unknown error"}. Ensure extension has permissions.`)):console.log("Download cancelled by user.")}else console.log(a?`Download initiated (or dialog opened) with ID: ${a}`:"Download cancelled by user (no downloadId assigned).")})}catch(n){console.error("Error creating blob or initiating download:",n),r?r("An error occurred while preparing the download."):(console.error("No error handler provided for download preparation error."),alert("An error occurred while preparing the download."))}}async function Cf(e,t,r){if(!e||!t||!r){console.error("[initiateChatDownload] Failed: Missing sessionId, requestDbAndWaitFunc, or showNotificationFunc."),r&&r("Download failed due to internal error.","error");return}console.log(`[initiateChatDownload] Preparing download for: ${e}`),r("Preparing download...","info");try{const n=await t(new wr(e));if(!n)throw new Error("Chat session data not found.");const o=fg(n),c=`${(n.title||n.name||"Chat_Session").replace(/[^a-z0-9_\-\.]/gi,"_").replace(/_{2,}/g,"_")}_${e.substring(0,8)}.html`;hg(o,c,u=>{r(u,"error")})}catch(n){console.error(`[initiateChatDownload] Error preparing download for ${e}:`,n),r(`Failed to prepare download: ${n.message}`,"error")}}let kn=!1,Wr=null,fn=null,ed=null,td=null,bt=null,hr=[],Hn="";function pg(e){if(!kn||!e||!e.sessionId||!e.payload){console.warn("[HistoryPopupController] Invalid session update notification received.",e);return}const t=e.payload.session,r=e.sessionId,n=e.payload.updateType||"update";if(!t){console.warn(`[HistoryPopupController] Session update notification for ${r} missing session data.`,e);return}console.log(`[HistoryPopupController] Received session update for ${r}. Type: ${n}, New starred: ${t.isStarred}`);const o=hr.findIndex(c=>c.id===r);let a=!1;n==="delete"?o!==-1&&(console.log(`[HistoryPopupController] Removing deleted session ${r} from local list.`),hr.splice(o,1),a=!0):o!==-1?(console.log(`[HistoryPopupController] Updating session ${r} in local list.`),hr[o]={...hr[o],...t},a=!0):(console.log(`[HistoryPopupController] Adding new/updated session ${r} to local list.`),hr.push(t),a=!0),a&&Wr&&!Wr.classList.contains("hidden")?(console.log("[HistoryPopupController] Popup visible and list changed, calling renderHistoryList()"),Mu()):console.log("[HistoryPopupController] Popup not visible or list unchanged, skipping renderHistoryList()")}function Mu(){if(!kn||!fn)return;console.log(`[HistoryPopupController] Rendering history list (Search: "${Hn}")...`);let e=hr;if(Hn){const t=Hn.toLowerCase();e=hr.filter(r=>(r.name||"").toLowerCase().includes(t)),console.log(`[HistoryPopupController] Filtered down to ${e.length} sessions.`)}else console.log(`[HistoryPopupController] Rendering all ${e.length} sessions (no search term).`);if(fn.innerHTML="",e.length===0){const t=Hn?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No history items match "${Hn}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No chat history yet.</p>';fn.innerHTML=t}else e.forEach(t=>{const r={entry:{id:t.id,name:t.title,title:t.title,timestamp:t.timestamp,isStarred:t.isStarred,messages:[]},onLoadClick:vg,onStarClick:yg,onDeleteClick:bg,onRenameSubmit:wg,onDownloadClick:_g,onShareClick:Sg,onPreviewClick:Eg},n=If(r);n&&fn.appendChild(n)});console.log("[HistoryPopupController] History list rendered.")}async function mg(){if(!(!kn||!Wr||!bt)){console.log("[HistoryPopupController] Showing popup. Fetching latest history...");try{hr=await bt(new gi)||[],console.log(`[HistoryPopupController] Fetched ${hr.length} sessions.`),Mu(),Wr.classList.remove("hidden")}catch(e){console.error("[HistoryPopupController] Error fetching history list:",e),$e("Failed to load history.","error"),fn&&(fn.innerHTML='<p class="p-4 text-center text-red-500 dark:text-red-400">Error loading history. Please try again.</p>'),Wr.classList.remove("hidden")}}}function ru(){!kn||!Wr||(console.log("[HistoryPopupController] Hiding popup."),Wr.classList.add("hidden"))}function gg(e){kn&&(Hn=e.target.value.trim(),Mu())}async function vg(e){if(console.log(`[HistoryPopupController] Load clicked: ${e}`),!!e)try{await chrome.storage.local.set({lastSessionId:e}),Ka("page-home"),ru()}catch(t){console.error("[HistoryPopupController] Error setting storage or navigating:",t),$e("Failed to load chat.","error")}}async function yg(e){if(!(!e||!bt)){console.log(`[HistoryPopupController] Star clicked: ${e}`);try{await bt(new _o(e)),$e("Star toggled","success")}catch(t){console.error("[HistoryPopupController] Error toggling star:",t),$e(`Failed to toggle star: ${t.message}`,"error")}}}async function bg(e,t){var o;if(!e||!t||!bt)return;console.log(`[HistoryPopupController] Delete confirmed inline for: ${e}. Applying deleting state.`),t.classList.add("is-deleting"),t.querySelectorAll("button").forEach(a=>a.disabled=!0);const r=t.querySelector(".card-footer"),n=r==null?void 0:r.querySelector(".deleting-message");if(r&&!n){const a=document.createElement("span");a.textContent="Deleting...",a.className="text-xs text-red-500 ml-2 deleting-message",r.appendChild(a)}try{await bt(new Eo(e)),$e("Chat deletion initiated...","info")}catch(a){console.error("[HistoryPopupController] Error deleting chat:",a),$e(`Failed to delete chat: ${a.message}`,"error"),t.classList.remove("is-deleting"),t.querySelectorAll("button").forEach(d=>d.disabled=!1),(o=r==null?void 0:r.querySelector(".deleting-message"))==null||o.remove();const c=t.querySelector("[data-normal-container]");c&&c.classList.remove("hidden");const u=t.querySelector("[data-confirm-container]");u&&u.classList.add("hidden")}}async function wg(e,t){if(!(!e||!t||!bt)){console.log(`[HistoryPopupController] Rename submitted: ${e} to "${t}"`);try{await bt(new Io(e,t)),$e("Rename successful","success")}catch(r){console.error("[HistoryPopupController] Error submitting rename:",r),$e(`Failed to rename chat: ${r.message}`,"error")}}}async function _g(e){bt?Cf(e,bt,$e):(console.error("[HistoryPopupController] Cannot download: requestDbAndWaitFunc not available."),$e("Download failed: Internal setup error.","error"))}function Sg(e){}async function Eg(e,t){if(!e||!t||!bt){console.error("[HistoryPopupController] Preview failed: Missing sessionId, contentElement, or requestDbAndWaitFunc.");return}console.log(`[HistoryPopupController] Handling preview click for: ${e}`),t.innerHTML='<span class="text-gray-500 dark:text-gray-400 italic text-xs">Loading preview...</span>';try{const r=await bt(new wr(e));if(!r||!r.messages||r.messages.length===0){t.innerHTML='<span class="text-gray-500 dark:text-gray-400 text-xs">No messages in this chat.</span>';return}const o=r.messages.slice(0,3).map(a=>{const c=a.sender==="user"?"You":a.sender==="ai"?"Agent":"System",u=(a.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").substring(0,100)+(a.text&&a.text.length>100?"...":"");return`<div class="preview-message mb-1 last:mb-0"><span class="font-medium">${c}:</span><span class="ml-1">${u}</span></div>`}).join("");t.innerHTML=o}catch(r){console.error(`[HistoryPopupController] Error fetching preview for ${e}:`,r),t.innerHTML=`<span class="text-red-500 text-xs">Error loading preview: ${r.message}</span>`}}function Ig(e,t){if(console.log("[HistoryPopupController] Entering initializeHistoryPopup..."),!e||!e.popupContainer||!e.listContainer||!e.searchInput||!e.closeButton||!t)return console.error("[HistoryPopupController] Initialization failed: Missing required elements or request function.",{elements:e,requestFunc:t}),null;Wr=e.popupContainer,fn=e.listContainer,ed=e.searchInput,td=e.closeButton,bt=t,console.log("[HistoryPopupController] Elements and request function assigned.");try{td.addEventListener("click",ru);const r=Ou(gg,300);return ed.addEventListener("input",r),console.log("[HistoryPopupController] Event listeners attached."),V.subscribe(xn.name,pg),console.log("[HistoryPopupController] Subscribed to DbSessionUpdatedNotification for passive updates."),kn=!0,console.log("[HistoryPopupController] Initialization successful. History will be rendered when popup is shown."),{show:mg,hide:ru}}catch(r){return console.error("[HistoryPopupController] Error during initialization listeners/subscriptions:",r),kn=!1,null}}function bi(e){"@babel/helpers - typeof";return bi=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},bi(e)}function Cg(e,t){if(bi(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(bi(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function xg(e){var t=Cg(e,"string");return bi(t)=="symbol"?t:t+""}function kg(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,xg(n.key),n)}}function Yr(e,t,r){return t&&kg(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function Dg(e){return e[e.length-1]}function Au(e){return Array.isArray(e)?e.slice(0):[e]}function Og(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Ya(e){return Array.isArray(e)}function xc(e,t){var r=0,n=-1;for(var o of e){n=n+1;var a=t(o,n);if(a)r=r+1;else break}return r}function Dn(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var o=0;o<r;++o)e[n+o]=t[o]}}function Pg(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Qr(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function _r(e,t){var r=t?Qr(t._rev)+1:1;return r+"-"+e}function Rg(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var o=n,a=0;a<r;++a){var c=t[a];if(o=o[c],typeof o>"u")return o}return o}}function Ne(e){return Object.assign({},e)}function Lg(e){return Object.keys(e)[0]}function Ja(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,o)=>typeof n=="string"&&typeof o=="string"?n.localeCompare(o):typeof n=="object"?1:-1).map(n=>Ja(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,o)=>n.localeCompare(o)).forEach(n=>{r[n]=Ja(e[n],t)}),r}return e}function nu(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=nu(e[r]);return t}var n={};for(var o in e)n[o]=nu(e[o]);return n}var dt=nu;function mr(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var Tu=1;function Ao(){return{lwt:Tu}}function Ht(){return""}function $g(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function Mg(e,t,r){if(t.length!==r.length)return!1;for(var n=0,o=t.length;n<o;){var a=t[n],c=r[n];if(n++,a._rev!==c._rev||a[e]!==c[e])return!1}return!0}async function Ag(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),o=>("00"+o.toString(16)).slice(-2)).join("");return n}var xf=Ag;function Tg(){return new Promise(e=>setTimeout(e,0))}function Ng(e=0){return new Promise(t=>setTimeout(t,e))}function Bg(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var qg=Promise.resolve(!0),Sr=Promise.resolve(!1),Nu=Promise.resolve(null),$t=Promise.resolve();function xs(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):Ng(0)}var kc=$t;function Fg(e=void 0){return kc=kc.then(()=>xs(e)),kc}function jg(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var Ug=/\./g,rd="abcdefghijklmnopqrstuvwxyz";function Bi(e=10){for(var t="",r=0;r<e;r++)t+=rd.charAt(Math.floor(Math.random()*rd.length));return t}function kf(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function ni(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function wi(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!wi(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var o=Object.keys(e);if(r=o.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,o[n]))return!1;for(n=r;n--!==0;){var a=o[n];if(!wi(e[a],t[a]))return!1}return!0}return e!==e&&t!==t}var ou=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},Dc=new Set(["__proto__","prototype","constructor"]),Kg=new Set("0123456789");function Df(e){var t=[],r="",n="start",o=!1;for(var a of e)switch(a){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");o&&(r+=a),n="property",o=!o;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(o){o=!1,r+=a;break}if(Dc.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(o){o=!1,r+=a;break}if(n==="property"){if(Dc.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!Kg.has(a))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),o&&(o=!1,r+="\\"),r+=a}}switch(o&&(r+="\\"),n){case"property":{if(Dc.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function Of(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function Hg(e,t){if(Of(e,t))throw new Error("Cannot use string index")}function Gr(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!ou(e)||typeof t!="string")return r===void 0?e:r;var n=Df(t);if(n.length===0)return r;for(var o=0;o<n.length;o++){var a=n[o];if(Of(e,a)?e=o===n.length-1?void 0:null:e=e[a],e==null){if(o!==n.length-1)return r;break}}return e===void 0?r:e}function Pf(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!ou(e)||typeof t!="string")return e;for(var n=e,o=Df(t),a=0;a<o.length;a++){var c=o[a];Hg(e,c),a===o.length-1?e[c]=r:ou(e[c])||(e[c]=typeof o[a+1]=="number"?[]:{}),e=e[c]}return n}function Co(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function zt(e,t,r,n){var o=e.get(t);return typeof o>"u"&&(o=r(),e.set(t,o)),o}function xe(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=kf(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function zg(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var Oc=0;function Et(){var e=Date.now();e=e+.01,e<=Oc&&(e=Oc+.01);var t=parseFloat(e.toFixed(2));return Oc=t,t}function de(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var qi={bufferSize:1,refCount:!0},Rf="16.11.0",Pc={},Wg="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",nd=16,Rc=Sr,od=!1;async function Lf(){return od||(od=!0,Rc=(async()=>!!(Pc.premium&&typeof Pc.premium=="string"&&await xf(Pc.premium)===Wg))()),Rc}function _i(e,t){return _i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},_i(e,t)}function Bu(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_i(e,t)}function iu(e){return iu=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},iu(e)}function Vg(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function $f(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return($f=function(){return!!e})()}function Qg(e,t,r){if($f())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var o=new(e.bind.apply(e,n));return r&&_i(o,r.prototype),o}function Xa(e){var t=typeof Map=="function"?new Map:void 0;return Xa=function(n){if(n===null||!Vg(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,o)}function o(){return Qg(n,arguments,iu(this).constructor)}return o.prototype=Object.create(n.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),_i(o,n)},Xa(e)}var Se={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return`
        RxDB Error-Code: `+e+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function Gg(e){var t="";return Object.keys(e).length===0||(t+="-".repeat(20)+`
`,t+=`Parameters:
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(o=>JSON.stringify(o,Object.getOwnPropertyNames(o))):n=JSON.stringify(e[r],function(o,a){return a===void 0?null:a},2)}catch{}return r+": "+n}).join(`
`),t+=`
`),t}function Mf(e,t,r){return`
`+e+`
`+Gg(r)}var Yg=function(e){function t(n,o,a={}){var c,u=Mf(o,n,a);return c=e.call(this,u)||this,c.code=n,c.message=u,c.url=qu(n),c.parameters=a,c.rxdb=!0,c}Bu(t,e);var r=t.prototype;return r.toString=function(){return this.message},Yr(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(Xa(Error)),Jg=function(e){function t(n,o,a={}){var c,u=Mf(o,n,a);return c=e.call(this,u)||this,c.code=n,c.message=u,c.url=qu(n),c.parameters=a,c.rxdb=!0,c}Bu(t,e);var r=t.prototype;return r.toString=function(){return this.message},Yr(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])}(Xa(TypeError));function qu(e){return"https://rxdb.info/errors.html?console=errors#"+e}function Af(e){return`
Find out more about this error here: `+qu(e)+` 
`}function X(e,t){return new Yg(e,Se.tunnelErrorMessage(e)+Af(e),t)}function Pt(e,t){return new Jg(e,Se.tunnelErrorMessage(e)+Af(e),t)}function ks(e){return e&&e.status===409?e:!1}var Xg={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function Tf(e){return X("COL20",{name:Xg[e.status],document:e.documentId,writeError:e})}var Si={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function pt(e,t){Si[e].length>0&&Si[e].forEach(r=>r(t))}async function Fi(e,t){for(var r of Si[e])await r(t)}function xo(e,t){var r=t;r=r.replace(Ug,".properties."),r="properties."+r,r=ni(r);var n=Gr(e,r);return n}function Zg(e,t,r){if(typeof t.primaryKey=="string")return r;var n=$n(t,r),o=r[e];if(o&&o!==n)throw X("DOC19",{args:{documentData:r,existingPrimary:o,newPrimary:n},schema:t});return r[e]=n,r}function It(e){return typeof e=="string"?e:e.key}function ev(e){var t=It(e.primaryKey),r=xo(e,t);return de(r.maxLength)}function $n(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var o=Gr(t,n);if(typeof o>"u")throw X("DOC18",{args:{field:n,documentData:t}});return o}).join(r.separator)}function tv(e){var t=Ja(e,!0);return t}function rv(e){return["_deleted",e]}function Ds(e){e=Ne(e);var t=It(e.primaryKey);e.properties=Ne(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=nv,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=Nf(e);Dn(e.required,r),e.required=e.required.filter(a=>!a.includes(".")).filter((a,c,u)=>u.indexOf(a)===c),e.version=e.version||0;var n=e.indexes.map(a=>{var c=Ya(a)?a.slice(0):[a];return c.includes(t)||c.push(t),c[0]!=="_deleted"&&c.unshift("_deleted"),c});n.length===0&&n.push(rv(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(a=>{n.push(a)});var o=new Set;return n.filter(a=>{var c=a.join(",");return o.has(c)?!1:(o.add(c),!0)}),e.indexes=n,e}var nv={type:"object",properties:{lwt:{type:"number",minimum:Tu,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Nf(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=It(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function ov(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var o=r[n];(!Object.prototype.hasOwnProperty.call(t,o)||typeof t[o]>"u")&&(t[o]=e.defaultValues[o])}return t}var Bf=function(){function e(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=iv(this.jsonSchema),this.primaryPath=It(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw X("SC39",{schema:r});this.finalFields=Nf(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,o){this.finalFields.forEach(a=>{if(!wi(n[a],o[a]))throw X("DOC9",{dataBefore:n,dataAfter:o,fieldName:a,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},o=xo(this.jsonSchema,"");return Object.keys(o).forEach(a=>{var c=a;n.__defineGetter__(a,function(){if(!(!this.get||typeof this.get!="function")){var u=this.get(c);return u}}),Object.defineProperty(n,a+"$",{get:function(){return this.get$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,a+"$$",{get:function(){return this.get$$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,a+"_",{get:function(){return this.populate(c)},enumerable:!1,configurable:!1})}),mr(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return $n(this.jsonSchema,n)},Yr(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,o])=>r[n]=o.default),mr(this,"defaultValues",r)}},{key:"hash",get:function(){return mr(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])}();function iv(e){return(e.indexes||[]).map(t=>Ya(t)?t:[t])}function av(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function sv(e,t,r=!0){r&&pt("preCreateRxSchema",e);var n=Ds(e);n=tv(n),Se.deepFreezeWhenDevMode(n);var o=new Bf(n,t);return pt("createRxSchema",o),o}function We(e){return typeof e=="function"}function cv(e){return We(e==null?void 0:e.lift)}function nr(e){return function(t){if(cv(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var au=function(e,t){return au=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(r[o]=n[o])},au(e,t)};function Mn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");au(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function uv(e,t,r,n){function o(a){return a instanceof r?a:new r(function(c){c(a)})}return new(r||(r=Promise))(function(a,c){function u(m){try{p(n.next(m))}catch(v){c(v)}}function d(m){try{p(n.throw(m))}catch(v){c(v)}}function p(m){m.done?a(m.value):o(m.value).then(u,d)}p((n=n.apply(e,t||[])).next())})}function qf(e,t){var r={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},n,o,a,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(p){return function(m){return d([p,m])}}function d(p){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,p[0]&&(r=0)),r;)try{if(n=1,o&&(a=p[0]&2?o.return:p[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,p[1])).done)return a;switch(o=0,a&&(p=[p[0]&2,a.value]),p[0]){case 0:case 1:a=p;break;case 4:return r.label++,{value:p[1],done:!1};case 5:r.label++,o=p[1],p=[0];continue;case 7:p=r.ops.pop(),r.trys.pop();continue;default:if(a=r.trys,!(a=a.length>0&&a[a.length-1])&&(p[0]===6||p[0]===2)){r=0;continue}if(p[0]===3&&(!a||p[1]>a[0]&&p[1]<a[3])){r.label=p[1];break}if(p[0]===6&&r.label<a[1]){r.label=a[1],a=p;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(p);break}a[2]&&r.ops.pop(),r.trys.pop();continue}p=t.call(e,r)}catch(m){p=[6,m],o=0}finally{n=a=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}function ko(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function On(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,a=[],c;try{for(;(t===void 0||t-- >0)&&!(o=n.next()).done;)a.push(o.value)}catch(u){c={error:u}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return a}function Pn(e,t,r){if(r||arguments.length===2)for(var n=0,o=t.length,a;n<o;n++)(a||!(n in t))&&(a||(a=Array.prototype.slice.call(t,0,n)),a[n]=t[n]);return e.concat(a||Array.prototype.slice.call(t))}function Xn(e){return this instanceof Xn?(this.v=e,this):new Xn(e)}function lv(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),o,a=[];return o=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),u("next"),u("throw"),u("return",c),o[Symbol.asyncIterator]=function(){return this},o;function c(_){return function(E){return Promise.resolve(E).then(_,v)}}function u(_,E){n[_]&&(o[_]=function(D){return new Promise(function(M,B){a.push([_,D,M,B])>1||d(_,D)})},E&&(o[_]=E(o[_])))}function d(_,E){try{p(n[_](E))}catch(D){w(a[0][3],D)}}function p(_){_.value instanceof Xn?Promise.resolve(_.value.v).then(m,v):w(a[0][2],_)}function m(_){d("next",_)}function v(_){d("throw",_)}function w(_,E){_(E),a.shift(),a.length&&d(a[0][0],a[0][1])}}function dv(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof ko=="function"?ko(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(a){r[a]=e[a]&&function(c){return new Promise(function(u,d){c=e[a](c),o(u,d,c.done,c.value)})}}function o(a,c,u,d){Promise.resolve(d).then(function(p){a({value:p,done:u})},c)}}var Ff=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function jf(e){return We(e==null?void 0:e.then)}function Fu(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var Lc=Fu(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,o){return o+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function su(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Os=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,o,a;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var u=ko(c),d=u.next();!d.done;d=u.next()){var p=d.value;p.remove(this)}}catch(D){t={error:D}}finally{try{d&&!d.done&&(r=u.return)&&r.call(u)}finally{if(t)throw t.error}}else c.remove(this);var m=this.initialTeardown;if(We(m))try{m()}catch(D){a=D instanceof Lc?D.errors:[D]}var v=this._finalizers;if(v){this._finalizers=null;try{for(var w=ko(v),_=w.next();!_.done;_=w.next()){var E=_.value;try{id(E)}catch(D){a=a??[],D instanceof Lc?a=Pn(Pn([],On(a)),On(D.errors)):a.push(D)}}}catch(D){n={error:D}}finally{try{_&&!_.done&&(o=w.return)&&o.call(w)}finally{if(n)throw n.error}}}if(a)throw new Lc(a)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)id(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&su(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&su(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),Uf=Os.EMPTY;function Kf(e){return e instanceof Os||e&&"closed"in e&&We(e.remove)&&We(e.add)&&We(e.unsubscribe)}function id(e){We(e)?e():e.unsubscribe()}var fv={Promise:void 0},hv={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,Pn([e,t],On(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Hf(e){hv.setTimeout(function(){throw e})}function ad(){}function $a(e){e()}var ju=function(e){Mn(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,Kf(r)&&r.add(n)):n.destination=gv,n}return t.create=function(r,n,o){return new Do(r,n,o)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Os),pv=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){xa(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){xa(n)}else xa(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){xa(r)}},e}(),Do=function(e){Mn(t,e);function t(r,n,o){var a=e.call(this)||this,c;return We(r)||!r?c={next:r??void 0,error:n??void 0,complete:o??void 0}:c=r,a.destination=new pv(c),a}return t}(ju);function xa(e){Hf(e)}function mv(e){throw e}var gv={closed:!0,next:ad,error:mv,complete:ad},Uu=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function ji(e){return e}function vv(e){return e.length===0?ji:e.length===1?e[0]:function(r){return e.reduce(function(n,o){return o(n)},r)}}var wt=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var o=this,a=bv(t)?t:new Do(t,r,n);return $a(function(){var c=o,u=c.operator,d=c.source;a.add(u?u.call(a,d):d?o._subscribe(a):o._trySubscribe(a))}),a},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=sd(r),new r(function(o,a){var c=new Do({next:function(u){try{t(u)}catch(d){a(d),c.unsubscribe()}},error:a,complete:o});n.subscribe(c)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[Uu]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return vv(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=sd(t),new t(function(n,o){var a;r.subscribe(function(c){return a=c},function(c){return o(c)},function(){return n(a)})})},e.create=function(t){return new e(t)},e}();function sd(e){var t;return(t=e??fv.Promise)!==null&&t!==void 0?t:Promise}function yv(e){return e&&We(e.next)&&We(e.error)&&We(e.complete)}function bv(e){return e&&e instanceof ju||yv(e)&&Kf(e)}function zf(e){return We(e[Uu])}function Wf(e){return Symbol.asyncIterator&&We(e==null?void 0:e[Symbol.asyncIterator])}function Vf(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function wv(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Qf=wv();function Gf(e){return We(e==null?void 0:e[Qf])}function Yf(e){return lv(this,arguments,function(){var r,n,o,a;return qf(this,function(c){switch(c.label){case 0:r=e.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,Xn(r.read())];case 3:return n=c.sent(),o=n.value,a=n.done,a?[4,Xn(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,Xn(o)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function Jf(e){return We(e==null?void 0:e.getReader)}function kr(e){if(e instanceof wt)return e;if(e!=null){if(zf(e))return _v(e);if(Ff(e))return Sv(e);if(jf(e))return Ev(e);if(Wf(e))return Xf(e);if(Gf(e))return Iv(e);if(Jf(e))return Cv(e)}throw Vf(e)}function _v(e){return new wt(function(t){var r=e[Uu]();if(We(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Sv(e){return new wt(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function Ev(e){return new wt(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Hf)})}function Iv(e){return new wt(function(t){var r,n;try{for(var o=ko(e),a=o.next();!a.done;a=o.next()){var c=a.value;if(t.next(c),t.closed)return}}catch(u){r={error:u}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}t.complete()})}function Xf(e){return new wt(function(t){xv(e,t).catch(function(r){return t.error(r)})})}function Cv(e){return Xf(Yf(e))}function xv(e,t){var r,n,o,a;return uv(this,void 0,void 0,function(){var c,u;return qf(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),r=dv(e),d.label=1;case 1:return[4,r.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(c=n.value,t.next(c),t.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return u=d.sent(),o={error:u},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(a=r.return)?[4,a.call(r)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function Er(e,t,r,n,o){return new kv(e,t,r,n,o)}var kv=function(e){Mn(t,e);function t(r,n,o,a,c,u){var d=e.call(this,r)||this;return d.onFinalize=c,d.shouldUnsubscribe=u,d._next=n?function(p){try{n(p)}catch(m){r.error(m)}}:e.prototype._next,d._error=a?function(p){try{a(p)}catch(m){r.error(m)}finally{this.unsubscribe()}}:e.prototype._error,d._complete=o?function(){try{o()}catch(p){r.error(p)}finally{this.unsubscribe()}}:e.prototype._complete,d}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(ju),Zf={now:function(){return(Zf.delegate||Date).now()},delegate:void 0};function Dv(e){return e&&We(e.schedule)}function Ku(e){return e[e.length-1]}function Ov(e){return We(Ku(e))?e.pop():void 0}function Ui(e){return Dv(Ku(e))?e.pop():void 0}function eh(e,t){return typeof Ku(e)=="number"?e.pop():t}function Vr(e,t,r,n,o){n===void 0&&(n=0),o===void 0&&(o=!1);var a=t.schedule(function(){r(),o?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(a),!o)return a}var Pv=Array.isArray,Rv=Object.getPrototypeOf,Lv=Object.prototype,$v=Object.keys;function Mv(e){if(e.length===1){var t=e[0];if(Pv(t))return{args:t,keys:null};if(Av(t)){var r=$v(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function Av(e){return e&&typeof e=="object"&&Rv(e)===Lv}function th(e,t){return t===void 0&&(t=0),nr(function(r,n){r.subscribe(Er(n,function(o){return Vr(n,e,function(){return n.next(o)},t)},function(){return Vr(n,e,function(){return n.complete()},t)},function(o){return Vr(n,e,function(){return n.error(o)},t)}))})}function rh(e,t){return t===void 0&&(t=0),nr(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function Tv(e,t){return kr(e).pipe(rh(t),th(t))}function Nv(e,t){return kr(e).pipe(rh(t),th(t))}function Bv(e,t){return new wt(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function qv(e,t){return new wt(function(r){var n;return Vr(r,t,function(){n=e[Qf](),Vr(r,t,function(){var o,a,c;try{o=n.next(),a=o.value,c=o.done}catch(u){r.error(u);return}c?r.complete():r.next(a)},0,!0)}),function(){return We(n==null?void 0:n.return)&&n.return()}})}function nh(e,t){if(!e)throw new Error("Iterable cannot be null");return new wt(function(r){Vr(r,t,function(){var n=e[Symbol.asyncIterator]();Vr(r,t,function(){n.next().then(function(o){o.done?r.complete():r.next(o.value)})},0,!0)})})}function Fv(e,t){return nh(Yf(e),t)}function jv(e,t){if(e!=null){if(zf(e))return Tv(e,t);if(Ff(e))return Bv(e,t);if(jf(e))return Nv(e,t);if(Wf(e))return nh(e,t);if(Gf(e))return qv(e,t);if(Jf(e))return Fv(e,t)}throw Vf(e)}function Ki(e,t){return t?jv(e,t):kr(e)}function He(e,t){return nr(function(r,n){var o=0;r.subscribe(Er(n,function(a){n.next(e.call(t,a,o++))}))})}var Uv=Array.isArray;function Kv(e,t){return Uv(t)?e.apply(void 0,Pn([],On(t))):e(t)}function Hv(e){return He(function(t){return Kv(e,t)})}function zv(e,t){return e.reduce(function(r,n,o){return r[n]=t[o],r},{})}function Wv(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ui(e),n=Ov(e),o=Mv(e),a=o.args,c=o.keys;if(a.length===0)return Ki([],r);var u=new wt(Vv(a,r,c?function(d){return zv(c,d)}:ji));return n?u.pipe(Hv(n)):u}function Vv(e,t,r){return r===void 0&&(r=ji),function(n){cd(t,function(){for(var o=e.length,a=new Array(o),c=o,u=o,d=function(m){cd(t,function(){var v=Ki(e[m],t),w=!1;v.subscribe(Er(n,function(_){a[m]=_,w||(w=!0,u--),u||n.next(r(a.slice()))},function(){--c||n.complete()}))},n)},p=0;p<o;p++)d(p)},n)}}function cd(e,t,r){e?Vr(r,e,t):t()}function Qv(e,t,r,n,o,a,c,u){var d=[],p=0,m=0,v=!1,w=function(){v&&!d.length&&!p&&t.complete()},_=function(D){return p<n?E(D):d.push(D)},E=function(D){p++;var M=!1;kr(r(D,m++)).subscribe(Er(t,function(B){t.next(B)},function(){M=!0},void 0,function(){if(M)try{p--;for(var B=function(){var q=d.shift();c||E(q)};d.length&&p<n;)B();w()}catch(q){t.error(q)}}))};return e.subscribe(Er(t,_,function(){v=!0,w()})),function(){}}function Ir(e,t,r){return r===void 0&&(r=1/0),We(t)?Ir(function(n,o){return He(function(a,c){return t(n,a,o,c)})(kr(e(n,o)))},r):(typeof t=="number"&&(r=t),nr(function(n,o){return Qv(n,o,e,r)}))}function Hu(e){return e===void 0&&(e=1/0),Ir(ji,e)}function Gv(){return Hu(1)}var Yv=Fu(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Mt=function(e){Mn(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new ud(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new Yv},t.prototype.next=function(r){var n=this;$a(function(){var o,a;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var c=ko(n.currentObservers),u=c.next();!u.done;u=c.next()){var d=u.value;d.next(r)}}catch(p){o={error:p}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(o)throw o.error}}}})},t.prototype.error=function(r){var n=this;$a(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var o=n.observers;o.length;)o.shift().error(r)}})},t.prototype.complete=function(){var r=this;$a(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,o=this,a=o.hasError,c=o.isStopped,u=o.observers;return a||c?Uf:(this.currentObservers=null,u.push(r),new Os(function(){n.currentObservers=null,su(u,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,o=n.hasError,a=n.thrownError,c=n.isStopped;o?r.error(a):c&&r.complete()},t.prototype.asObservable=function(){var r=new wt;return r.source=this,r},t.create=function(r,n){return new ud(r,n)},t}(wt),ud=function(e){Mn(t,e);function t(r,n){var o=e.call(this)||this;return o.destination=r,o.source=n,o}return t.prototype.next=function(r){var n,o;(o=(n=this.destination)===null||n===void 0?void 0:n.next)===null||o===void 0||o.call(n,r)},t.prototype.error=function(r){var n,o;(o=(n=this.destination)===null||n===void 0?void 0:n.error)===null||o===void 0||o.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,o;return(o=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&o!==void 0?o:Uf},t}(Mt);function ld(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Gv()(Ki(e,Ui(e)))}var Jv=new wt(function(e){return e.complete()});function Ei(e,t){return t===void 0&&(t=ji),e=e??Xv,nr(function(r,n){var o,a=!0;r.subscribe(Er(n,function(c){var u=t(c);(a||!e(o,u))&&(a=!1,o=u,n.next(c))}))})}function Xv(e,t){return e===t}function ke(e,t){return nr(function(r,n){var o=0;r.subscribe(Er(n,function(a){return e.call(t,a,o++)&&n.next(a)}))})}var Zv=Fu(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function ey(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ui(e),n=eh(e,1/0);return nr(function(o,a){Hu(n)(Ki(Pn([o],On(e)),r)).subscribe(a)})}function ty(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ey.apply(void 0,Pn([],On(e)))}var Tr=function(e){Mn(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,o=r.thrownError,a=r._value;if(n)throw o;return this._throwIfClosed(),a},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(Mt),ry=function(e){Mn(t,e);function t(r,n,o){r===void 0&&(r=1/0),n===void 0&&(n=1/0),o===void 0&&(o=Zf);var a=e.call(this)||this;return a._bufferSize=r,a._windowTime=n,a._timestampProvider=o,a._buffer=[],a._infiniteTimeWindow=!0,a._infiniteTimeWindow=n===1/0,a._bufferSize=Math.max(1,r),a._windowTime=Math.max(1,n),a}return t.prototype.next=function(r){var n=this,o=n.isStopped,a=n._buffer,c=n._infiniteTimeWindow,u=n._timestampProvider,d=n._windowTime;o||(a.push(r),!c&&a.push(u.now()+d)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),o=this,a=o._infiniteTimeWindow,c=o._buffer,u=c.slice(),d=0;d<u.length&&!r.closed;d+=a?1:2)r.next(u[d]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,o=r._timestampProvider,a=r._buffer,c=r._infiniteTimeWindow,u=(c?1:2)*n;if(n<1/0&&u<a.length&&a.splice(0,a.length-u),!c){for(var d=o.now(),p=0,m=1;m<a.length&&a[m]<=d;m+=2)p=m;p&&a.splice(0,p+1)}},t}(Mt);function ny(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new Mt}:t,n=e.resetOnError,o=n===void 0?!0:n,a=e.resetOnComplete,c=a===void 0?!0:a,u=e.resetOnRefCountZero,d=u===void 0?!0:u;return function(p){var m,v,w,_=0,E=!1,D=!1,M=function(){v==null||v.unsubscribe(),v=void 0},B=function(){M(),m=w=void 0,E=D=!1},q=function(){var G=m;B(),G==null||G.unsubscribe()};return nr(function(G,ae){_++,!D&&!E&&M();var ie=w=w??r();ae.add(function(){_--,_===0&&!D&&!E&&(v=$c(q,d))}),ie.subscribe(ae),!m&&_>0&&(m=new Do({next:function(Z){return ie.next(Z)},error:function(Z){D=!0,M(),v=$c(B,o,Z),ie.error(Z)},complete:function(){E=!0,M(),v=$c(B,c),ie.complete()}}),kr(G).subscribe(m))})(p)}}function $c(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var o=new Do({next:function(){o.unsubscribe(),e()}});return kr(t.apply(void 0,Pn([],On(r)))).subscribe(o)}}function Hi(e,t,r){var n,o,a,c,u=!1;return e&&typeof e=="object"?(n=e.bufferSize,c=n===void 0?1/0:n,o=e.windowTime,t=o===void 0?1/0:o,a=e.refCount,u=a===void 0?!1:a,r=e.scheduler):c=e??1/0,ny({connector:function(){return new ry(c,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:u})}function zi(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ui(e);return nr(function(n,o){(r?ld(e,n,r):ld(e,n)).subscribe(o)})}function oy(e,t){return nr(function(r,n){var o=null,a=0,c=!1,u=function(){return c&&!o&&n.complete()};r.subscribe(Er(n,function(d){o==null||o.unsubscribe();var p=0,m=a++;kr(e(d,m)).subscribe(o=Er(n,function(v){return n.next(t?t(d,v,m,p++):v)},function(){o=null,u()}))},function(){c=!0,u()}))})}function oh(e){return e.documentData?e.documentData:e.previousDocumentData}function iy(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:Se.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var ay=new Map;function ih(e){return zt(ay,e,()=>{for(var t=new Array(e.events.length),r=e.events,n=e.collectionName,o=e.isLocal,a=Se.deepFreezeWhenDevMode,c=0;c<r.length;c++){var u=r[c];t[c]={documentId:u.documentId,collectionName:n,isLocal:o,operation:u.operation,documentData:a(u.documentData),previousDocumentData:a(u.previousDocumentData)}}return t})}function _n(e,t){return new Promise(function(r,n){var o=new Do({next:function(a){r(a),o.unsubscribe()},error:n,complete:function(){n(new Zv)}});e.subscribe(o)})}function sy(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ui(e),n=eh(e,1/0),o=e;return o.length?o.length===1?kr(o[0]):Hu(n)(Ki(o,r)):Jv}var Zn="￿",eo=Number.MIN_SAFE_INTEGER;function cy(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var o=!!t.sort.find(m=>Object.values(m)[0]==="desc"),a=new Set;Object.keys(r).forEach(m=>{var v=xo(e,m);v&&v.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[m],"$eq")&&a.add(m)});var c=t.sort.map(m=>Object.keys(m)[0]),u=c.filter(m=>!a.has(m)).join(","),d=-1,p;if(n.forEach(m=>{var v=!0,w=!0,_=m.map(q=>{var G=r[q],ae=G?Object.keys(G):[],ie={};if(!G||!ae.length){var Z=w?eo:Zn;ie={startKey:Z,endKey:v?Zn:eo,inclusiveStart:!0,inclusiveEnd:!0}}else ae.forEach(ne=>{if(zu.has(ne)){var pe=G[ne],ye=fy(ne,pe);ie=Object.assign(ie,ye)}});return typeof ie.startKey>"u"&&(ie.startKey=eo),typeof ie.endKey>"u"&&(ie.endKey=Zn),typeof ie.inclusiveStart>"u"&&(ie.inclusiveStart=!0),typeof ie.inclusiveEnd>"u"&&(ie.inclusiveEnd=!0),w&&!ie.inclusiveStart&&(w=!1),v&&!ie.inclusiveEnd&&(v=!1),ie}),E=_.map(q=>q.startKey),D=_.map(q=>q.endKey),M={index:m,startKeys:E,endKeys:D,inclusiveEnd:v,inclusiveStart:w,sortSatisfiedByIndex:!o&&u===m.filter(q=>!a.has(q)).join(","),selectorSatisfiedByIndex:dy(m,t.selector,E,D)},B=hy(e,t,M);(B>=d||t.index)&&(d=B,p=M)}),!p)throw X("SNH",{query:t});return p}var zu=new Set(["$eq","$gt","$gte","$lt","$lte"]),uy=new Set(["$eq","$gt","$gte"]),ly=new Set(["$eq","$lt","$lte"]);function dy(e,t,r,n){var o=Object.entries(t),a=o.find(([ne,pe])=>{if(!e.includes(ne))return!0;var ye=Object.entries(pe).find(([Ie,Re])=>!zu.has(Ie));return ye});if(a||t.$and||t.$or)return!1;var c=[],u=new Set;for(var[d,p]of Object.entries(t)){if(!e.includes(d))return!1;var m=Object.keys(p).filter(ne=>uy.has(ne));if(m.length>1)return!1;var v=m[0];if(v&&u.add(d),v!=="$eq"){if(c.length>0)return!1;c.push(v)}}var w=[],_=new Set;for(var[E,D]of Object.entries(t)){if(!e.includes(E))return!1;var M=Object.keys(D).filter(ne=>ly.has(ne));if(M.length>1)return!1;var B=M[0];if(B&&_.add(E),B!=="$eq"){if(w.length>0)return!1;w.push(B)}}var q=0;for(var G of e){for(var ae of[u,_]){if(!ae.has(G)&&ae.size>0)return!1;ae.delete(G)}var ie=r[q],Z=n[q];if(ie!==Z&&u.size>0&&_.size>0)return!1;q++}return!0}function fy(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function hy(e,t,r){var n=0,o=m=>{m>0&&(n=n+m)},a=10,c=xc(r.startKeys,m=>m!==eo&&m!==Zn);o(c*a);var u=xc(r.startKeys,m=>m!==Zn&&m!==eo);o(u*a);var d=xc(r.startKeys,(m,v)=>m===r.endKeys[v]);o(d*a*1.5);var p=r.sortSatisfiedByIndex?5:0;return o(p),n}class Wi extends Error{}const Ii=Symbol("missing"),ah=Object.freeze(new Error("mingo: cycle detected while processing object/array")),Vi=e=>{const t=Ma(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},Hr=e=>typeof e!="object"&&typeof e!="function"||e===null,sh=e=>Hr(e)||Oo(e)||gr(e),ch={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},Bt=(e,t)=>{e===Ii&&(e=void 0),t===Ii&&(t=void 0);const[r,n]=[e,t].map(o=>ch[xi(o)]||0);return r!==n?r-n:Kt(e,t)?0:e<t?-1:e>t?1:0};var Mi,ur,vn;const hl=class hl extends Map{constructor(){super();je(this,Mi,Vi);je(this,ur,new Map);je(this,vn,r=>{const n=W(this,Mi).call(this,r);return[(W(this,ur).get(n)||[]).find(o=>Kt(o,r)),n]})}static init(r){const n=new hl;return r&&Ue(n,Mi,r),n}clear(){super.clear(),W(this,ur).clear()}delete(r){if(Hr(r))return super.delete(r);const[n,o]=W(this,vn).call(this,r);return super.delete(n)?(W(this,ur).set(o,W(this,ur).get(o).filter(a=>!Kt(a,n))),!0):!1}get(r){if(Hr(r))return super.get(r);const[n,o]=W(this,vn).call(this,r);return super.get(n)}has(r){if(Hr(r))return super.has(r);const[n,o]=W(this,vn).call(this,r);return super.has(n)}set(r,n){if(Hr(r))return super.set(r,n);const[o,a]=W(this,vn).call(this,r);if(super.has(o))super.set(o,n);else{super.set(r,n);const c=W(this,ur).get(a)||[];c.push(r),W(this,ur).set(a,c)}return this}get size(){return super.size}};Mi=new WeakMap,ur=new WeakMap,vn=new WeakMap;let Ci=hl;function Ee(e,t){if(!e)throw new Wi(t)}const py=Object.keys(ch).reduce((e,t)=>(e["[object "+t[0].toUpperCase()+t.substring(1)+"]"]=t,e),{});function xi(e){var r,n;const t=Object.prototype.toString.call(e);return t==="[object Object]"?((n=(r=e==null?void 0:e.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":py[t]||t.substring(8,t.length-1).toLowerCase()}const to=e=>typeof e=="boolean",Wt=e=>typeof e=="string",my=e=>typeof e=="symbol",Xe=e=>!isNaN(e)&&typeof e=="number",me=Array.isArray;function ze(e){if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&xi(e)==="object"}const uh=e=>!Hr(e),Oo=e=>e instanceof Date,gr=e=>e instanceof RegExp,Ps=e=>typeof e=="function",_t=e=>e==null,Po=(e,t=!0)=>!!e||t&&e==="",Wu=e=>_t(e)||Wt(e)&&!e||me(e)&&e.length===0||ze(e)&&Object.keys(e).length===0,To=e=>me(e)?e:[e],Vt=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),gy=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),Ro=(e,t)=>{if(_t(e)||to(e)||Xe(e)||Wt(e))return e;if(Oo(e))return new Date(e);if(gr(e))return new RegExp(e);if(gy(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw ah;t.add(e);try{if(me(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=Ro(e[n],t);return r}if(ze(e)){const r={};for(const n of Object.keys(e))r[n]=Ro(e[n],t);return r}}finally{t.delete(e)}return e},dd=e=>e===Ii;function cu(e,t){if(dd(e)||_t(e))return t;if(dd(t)||_t(t))return e;if(Hr(e)||Hr(t))return t;me(e)&&me(t)&&Ee(e.length===t.length,"arrays must be of equal length to merge.");for(const r of Object.keys(t))e[r]=cu(e[r],t[r]);return e}function lh(e,t=Vi){const r=[Ci.init(t),Ci.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(o=>{r[0].has(o)&&r[1].set(o,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function dh(e,t=1){const r=new Array;function n(o,a){for(let c=0,u=o.length;c<u;c++)me(o[c])&&(a>0||a<0)?n(o[c],Math.max(-1,a-1)):r.push(o[c])}return n(e,t),r}function vy(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}function fh(e){for(;e;){if(Object.getOwnPropertyNames(e).includes("toString"))return e.toString!==Object.prototype.toString;e=Object.getPrototypeOf(e)}return!1}function Kt(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object"||e.constructor!==t.constructor)return!1;if(e instanceof Date)return+e==+t;if(e instanceof RegExp)return e.toString()===t.toString();const r=e.constructor;if(r===Array||r===Object){const n=Object.keys(e).sort(),o=Object.keys(t).sort();if(n.length!==o.length)return!1;for(let a=0,c=n[a];a<n.length;c=n[++a])if(c!==o[a]||!Kt(e[c],t[c]))return!1;return!0}return fh(e)&&e.toString()===t.toString()}function yy(e,t=Vi){const r=Ci.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}const Ma=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";if(Wt(e)||Xe(e)||to(e))return JSON.stringify(e);if(Oo(e))return e.toISOString();if(gr(e)||my(e)||Ps(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw ah;try{if(t.add(e),me(e))return"["+e.map(n=>Ma(n,t)).join(",")+"]";if(ze(e))return"{"+Object.keys(e).sort().map(o=>`${o}:${Ma(e[o],t)}`).join()+"}";const r=fh(e)?e.toString():Ma(vy(e),t);return xi(e)+"("+r+")"}finally{t.delete(e)}};function by(e,t){return _t(e)?null:(t=t||Vi,t(e))}function wy(e,t,r=Vi){if(e.length<1)return new Map;const n=new Map,o=new Map;for(let a=0;a<e.length;a++){const c=e[a],u=t(c,a),d=by(u,r);if(d===null)o.has(null)?o.get(null).push(c):o.set(null,[c]);else{const p=n.has(d)?n.get(d).find(m=>Kt(m,u)):null;_t(p)?(o.set(u,[c]),n.has(d)?n.get(d).push(u):n.set(d,[u])):o.get(p).push(c)}}return o}function uu(e,t){return uh(e)?e[t]:void 0}function _y(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function rr(e,t,r){let n=0;function o(c,u){let d=c;for(let p=0;p<u.length;p++){const m=u[p];if(/^\d+$/.exec(m)===null&&me(d)){if(p===0&&n>0)break;n+=1;const w=u.slice(p);d=d.reduce((_,E)=>{const D=o(E,w);return D!==void 0&&_.push(D),_},[]);break}else d=uu(d,m);if(d===void 0)break}return d}const a=sh(e)?e:o(e,t.split("."));return me(a)&&(r!=null&&r.unwrapArray)?_y(a,n):a}function si(e,t,r){const n=t.indexOf("."),o=n==-1?t:t.substring(0,n),a=t.substring(n+1),c=n!=-1;if(me(e)){const p=/^\d+$/.test(o),m=p&&(r!=null&&r.preserveIndex)?[...e]:[];if(p){const v=parseInt(o);let w=uu(e,v);c&&(w=si(w,a,r)),r!=null&&r.preserveIndex?m[v]=w:m.push(w)}else for(const v of e){const w=si(v,t,r);r!=null&&r.preserveMissing?m.push(w??Ii):(w!=null||r!=null&&r.preserveIndex)&&m.push(w)}return m}const u=r!=null&&r.preserveKeys?{...e}:{};let d=uu(e,o);if(c&&(d=si(d,a,r)),d!==void 0)return u[o]=d,u}function lu(e){if(me(e))for(let t=e.length-1;t>=0;t--)e[t]===Ii?e.splice(t,1):lu(e[t]);else if(ze(e))for(const t in e)Vt(e,t)&&lu(e[t])}const fd=/^\d+$/;function ki(e,t,r,n){const o=t.split("."),a=o[0],c=o.slice(1).join(".");if(o.length===1)(ze(e)||me(e)&&fd.test(a))&&r(e,a);else{n!=null&&n.buildGraph&&_t(e[a])&&(e[a]={});const u=e[a];if(!u)return;const d=!!(o.length>1&&fd.test(o[1]));me(u)&&(n!=null&&n.descendArray)&&!d?u.forEach(p=>ki(p,c,r,n)):ki(u,c,r,n)}}function Sy(e,t,r){ki(e,t,(n,o)=>{n[o]=Ps(r)?r(n[o]):r},{buildGraph:!0})}function hd(e,t,r){ki(e,t,(n,o)=>{if(me(n)){if(/^\d+$/.test(o))n.splice(parseInt(o),1);else if(r&&r.descendArray)for(const a of n)ze(a)&&delete a[o]}else ze(n)&&delete n[o]},r)}const Ey=/^\$[a-zA-Z0-9_]+$/;function Jr(e){return Ey.test(e)}function hh(e){if(sh(e))return gr(e)?{$regex:e}:{$eq:e};if(uh(e)){if(!Object.keys(e).some(Jr))return{$eq:e};if(Vt(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var du=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(du||{}),Je,Ai,lr;const hi=class hi{constructor(t,r,n){je(this,Je);je(this,Ai);je(this,lr);Ue(this,Je,t),this.update(r,n)}static init(t,r,n){var o;return t instanceof hi?new hi(W(t,Je),t.root??r,{...W(t,lr),...n,variables:Object.assign({},(o=W(t,lr))==null?void 0:o.variables,n==null?void 0:n.variables)}):new hi(t,r,n)}update(t,r){var o;Ue(this,Ai,t);const n=Object.assign({},(o=W(this,lr))==null?void 0:o.variables,r==null?void 0:r.variables);return Object.keys(n).length?Ue(this,lr,{...r,variables:n}):Ue(this,lr,r??{}),this}getOptions(){return Object.freeze({...W(this,Je),context:Rn.from(W(this,Je).context)})}get root(){return W(this,Ai)}get local(){return W(this,lr)}get idKey(){return W(this,Je).idKey}get collation(){var t;return(t=W(this,Je))==null?void 0:t.collation}get processingMode(){var t;return((t=W(this,Je))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=W(this,Je))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=W(this,Je))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=W(this,Je))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=W(this,Je))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=W(this,Je))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=W(this,Je))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=W(this,Je))==null?void 0:t.variables}get context(){var t;return(t=W(this,Je))==null?void 0:t.context}};Je=new WeakMap,Ai=new WeakMap,lr=new WeakMap;let Di=hi;function ph(e){return e instanceof Di?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:e!=null&&e.context?Rn.from(e==null?void 0:e.context):Rn.init()})}var fu=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(fu||{}),qr;const Es=class Es{constructor(){je(this,qr,new Map)}static init(){return new Es}static from(t){const r=Es.init();return _t(t)||W(t,qr).forEach((n,o)=>r.addOperators(o,n)),r}addOperators(t,r){W(this,qr).has(t)||W(this,qr).set(t,{});for(const[n,o]of Object.entries(r))this.getOperator(t,n)||(W(this,qr).get(t)[n]=o);return this}getOperator(t,r){return(W(this,qr).get(t)??{})[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};qr=new WeakMap;let Rn=Es;const dn=Rn.init();function pd(e,t){for(const[r,n]of Object.entries(t)){Ee(Ps(n)&&Jr(r),`'${r}' is not a valid operator`);const o=Oi(e,r,null);Ee(!o||n===o,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":dn.addAccumulatorOps(t);break;case"expression":dn.addExpressionOps(t);break;case"pipeline":dn.addPipelineOps(t);break;case"projection":dn.addProjectionOps(t);break;case"query":dn.addQueryOps(t);break;case"window":dn.addWindowOps(t);break}}function Oi(e,t,r){const{context:n,useGlobalContext:o}=r||{},a=n?n.getOperator(e,t):null;return!a&&o?dn.getOperator(e,t):a}function Rt(e,t,r,n){const o=Di.init(n,e);return r&&Jr(r)?mh(e,t,r,o):Za(e,t,o)}const Iy=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Za(e,t,r){var n;if(Wt(t)&&t.length>0&&t[0]==="$"){if(Cy.includes(t))return t;let o=r.root;const a=t.split(".");if(Iy.includes(a[0])){switch(a[0]){case"$$ROOT":break;case"$$CURRENT":o=e;break;case"$$REMOVE":o=void 0;break;case"$$NOW":o=new Date;break}t=t.slice(a[0].length+1)}else if(a[0].slice(0,2)==="$$"){o=Object.assign({},r.variables,{this:e},(n=r==null?void 0:r.local)==null?void 0:n.variables);const c=a[0].slice(2);Ee(Vt(o,c),`Use of undefined variable: ${c}`),t=t.slice(2)}else t=t.slice(1);return t===""?o:rr(o,t)}if(me(t))return t.map(o=>Za(e,o,r));if(ze(t)){const o={},a=Object.entries(t);for(const[c,u]of a){if(Jr(c))return Ee(a.length==1,"expression must have single operator."),mh(e,u,c,r);o[c]=Za(e,u,r)}return o}return t}function mh(e,t,r,n){const o=Oi("expression",r,n);if(o)return o(e,t,n);const a=Oi("accumulator",r,n);return Ee(!!a,`accumulator '${r}' is not registered.`),me(e)||(e=Za(e,t,n),t=null),Ee(me(e),`arguments must resolve to array for ${r}.`),a(e,t,n)}const Cy=["$$KEEP","$$PRUNE","$$DESCEND"];function Pi(e){return e instanceof md?e:new md(e)}function xy(...e){let t=0;return Pi(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function ky(e){return!!e&&typeof e=="object"&&(e==null?void 0:e.next)instanceof Function}function Dy(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const hu=new Error;function Oy(e,t,r){let n=!1,o=-1,a=0;return function(c){try{e:for(;!n;){let u=e();o++;let d=-1;const p=t.length;let m=!1;for(;++d<p;){const v=t[d];switch(v.action){case 0:u=v.func(u,o);break;case 1:if(!v.func(u,o))continue e;break;case 2:--v.count,v.count||(m=!0);break;case 3:--v.count,v.count||Dy(t,d);continue e;default:break e}}if(n=m,c)r[a++]=u;else return{value:u,done:!1}}}catch(u){if(u!==hu)throw u}return n=!0,{done:n}}}var yn,io,ao,pf;let md=(pf=class{constructor(t){je(this,yn);je(this,io);je(this,ao);Ue(this,yn,[]),Ue(this,io,[]),this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),ky(t)){const n=t;r=()=>{const o=n.next();if(o.done)throw hu;return o.value}}else if(me(t)){const n=t,o=n.length;let a=0;r=()=>{if(a<o)return n[a++];throw hu}}else if(!(t instanceof Function))throw new Wi("Lazy must be initialized with an array, generator, or function.");Ue(this,ao,Oy(r,W(this,yn),W(this,io)))}push(t,r){return typeof r=="function"?W(this,yn).push({action:t,func:r}):typeof r=="number"&&W(this,yn).push({action:t,count:r}),this}next(){return W(this,ao).call(this)}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return Pi(()=>(n||(n=Pi(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=W(this,ao).call(this,!0).done),W(this,io)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}},yn=new WeakMap,io=new WeakMap,ao=new WeakMap,pf);const Py=(e,t,r)=>e.take(t),gh=(e,t,r)=>Wu(t)?e:(yh(t,r),e.map(vh(t,Di.init(r))));function vh(e,t,r=!0){const n=t.idKey,o=Object.keys(e),a=new Array,c=new Array,u={};for(const _ of o){const E=e[_];if(Xe(E)||to(E))E?c.push(_):a.push(_);else if(me(E))u[_]=D=>E.map(M=>Rt(D,M,null,t.update(D))??null);else if(ze(E)){const D=Object.keys(E),M=D.length==1?D[0]:"",B=Oi("projection",M,t);B?M==="$slice"&&!To(E[M]).every(Xe)?u[_]=G=>Rt(G,E,_,t.update(G)):u[_]=G=>B(G,E[M],_,t.update(G)):Jr(M)?u[_]=q=>Rt(q,E[M],M,t):(yh(E,t),u[_]=q=>{if(!Vt(q,_))return Rt(q,E,null,t);r&&t.update(q);const G=rr(q,_),ae=vh(E,t,!1);return me(G)?G.map(ae):ze(G)?ae(G):ae(q)})}else u[_]=Wt(E)&&E[0]==="$"?D=>Rt(D,E,_,t):D=>E}const d=Object.keys(u),p=a.includes(n);if(r&&p&&a.length===1&&!c.length&&!d.length)return _=>{const E={..._};return delete E[n],E};const v=r&&!p&&!c.includes(n),w={preserveMissing:!0};return _=>{const E={};if(a.length&&!c.length){cu(E,_);for(const D of a)hd(E,D,{descendArray:!0})}for(const D of c){const M=si(_,D,w)??{};cu(E,M)}c.length&&lu(E);for(const D of d){const M=u[D](_);M===void 0?hd(E,D,{descendArray:!0}):Sy(E,D,M)}return v&&Vt(_,n)&&(E[n]=rr(_,n)),E}}function yh(e,t){let r=!1,n=!1;for(const[o,a]of Object.entries(e))Ee(!o.startsWith("$"),"Field names may not start with '$'."),Ee(!o.endsWith(".$"),"Positional projection operator '$' is not supported."),o!==(t==null?void 0:t.idKey)&&(a===0||a===!1?r=!0:(a===1||a===!0)&&(n=!0),Ee(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const Ry=(e,t,r)=>e.drop(t),bh=(e,t,r)=>{if(Wu(t)||!ze(t))return e;let n=Bt;const o=r.collation;return ze(o)&&Wt(o.locale)&&(n=$y(o)),e.transform(a=>{const c=Object.keys(t);for(const u of c.reverse()){const d=wy(a,v=>rr(v,u),r.hashFunction),p=Array.from(d.keys()).sort(n);t[u]===-1&&p.reverse();let m=0;for(const v of p)for(const w of d.get(v))a[m++]=w;Ee(m==a.length,"bug: counter must match collection size.")}return a})},Ly={1:"base",2:"accent",3:"variant"};function $y(e){const t={sensitivity:Ly[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,o)=>{if(!Wt(n)||!Wt(o))return Bt(n,o);const a=r.compare(n,o);return a<0?-1:a>0?1:0}}const My={$sort:bh,$skip:Ry,$limit:Py};var Ti,Ni,so,dr,Fr,yt,fr;class Ay{constructor(t,r,n,o){je(this,Ti);je(this,Ni);je(this,so);je(this,dr);je(this,Fr,{});je(this,yt,null);je(this,fr,[]);Ue(this,Ti,t),Ue(this,Ni,r),Ue(this,so,n),Ue(this,dr,o)}fetch(){if(W(this,yt))return W(this,yt);Ue(this,yt,Pi(W(this,Ti)).filter(W(this,Ni)));const t=W(this,dr).processingMode;t&du.CLONE_INPUT&&W(this,yt).map(Ro);for(const r of["$sort","$skip","$limit"])Vt(W(this,Fr),r)&&Ue(this,yt,My[r](W(this,yt),W(this,Fr)[r],W(this,dr)));return Object.keys(W(this,so)).length&&Ue(this,yt,gh(W(this,yt),W(this,so),W(this,dr))),t&du.CLONE_OUTPUT&&W(this,yt).map(Ro),W(this,yt)}fetchAll(){const t=Pi([...W(this,fr)]);return Ue(this,fr,[]),xy(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return W(this,Fr).$skip=t,this}limit(t){return W(this,Fr).$limit=t,this}sort(t){return W(this,Fr).$sort=t,this}collation(t){return Ue(this,dr,{...W(this,dr),collation:t}),this}next(){if(W(this,fr).length>0)return W(this,fr).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(W(this,fr).length>0)return!0;const t=this.fetch().next();return t.done?!1:(W(this,fr).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}Ti=new WeakMap,Ni=new WeakMap,so=new WeakMap,dr=new WeakMap,Fr=new WeakMap,yt=new WeakMap,fr=new WeakMap;const Ty=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));var co,jr,bn;class Xr{constructor(t,r){je(this,co);je(this,jr);je(this,bn);Ue(this,bn,Ro(t)),Ue(this,jr,ph(r)),Ue(this,co,[]),this.compile()}compile(){Ee(ze(W(this,bn)),`query criteria must be an object: ${JSON.stringify(W(this,bn))}`);const t={};for(const[r,n]of Object.entries(W(this,bn))){if(r==="$where")Ee(W(this,jr).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(Ty.has(r))this.processOperator(r,r,n);else{Ee(!Jr(r),`unknown top level operator: ${r}`);for(const[o,a]of Object.entries(hh(n)))this.processOperator(r,o,a)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const o=Oi("query",r,W(this,jr));Ee(!!o,`unknown query operator ${r}`),W(this,co).push(o(t,n,W(this,jr)))}test(t){return W(this,co).every(r=>r(t))}find(t,r){return new Ay(t,n=>this.test(n),r||{},W(this,jr))}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}co=new WeakMap,jr=new WeakMap,bn=new WeakMap;const Ny=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(Ny);function ft(e){return(r,n,o)=>{const a={unwrapArray:!0},c=Math.max(1,r.split(".").length-1);return u=>{const d=rr(u,r,a);return e(d,n,{...o,depth:c})}}}function No(e){return(t,r,n)=>{const o=Rt(t,r,null,n);return e(...o)}}function Vu(e,t,r){return Kt(e,t)||_t(e)&&_t(t)?!0:me(e)?e.some(n=>Kt(n,t))||dh(e,r==null?void 0:r.depth).some(n=>Kt(n,t)):!1}function wh(e,t,r){return!Vu(e,t,r)}function _h(e,t,r){return _t(e)?t.some(n=>n===null):lh([To(e),t],r==null?void 0:r.hashFunction).length>0}function By(e,t,r){return!_h(e,t,r)}function Sh(e,t,r){return Rs(e,t,(n,o)=>Bt(n,o)<0)}function Eh(e,t,r){return Rs(e,t,(n,o)=>Bt(n,o)<=0)}function Ih(e,t,r){return Rs(e,t,(n,o)=>Bt(n,o)>0)}function Ch(e,t,r){return Rs(e,t,(n,o)=>Bt(n,o)>=0)}function qy(e,t,r){return To(e).some(n=>t.length===2&&n%t[0]===t[1])}function Fy(e,t,r){const n=To(e),o=a=>Wt(a)&&Po(t.exec(a),r==null?void 0:r.useStrictMode);return n.some(o)||dh(n,1).some(o)}function jy(e,t,r){if(!me(e)||!me(t)||!e.length||!t.length)return!1;let n=!0;for(const o of t){if(!n)break;ze(o)&&Object.keys(o).includes("$elemMatch")?n=xh(e,o.$elemMatch,r):gr(o)?n=e.some(a=>typeof a=="string"&&o.test(a)):n=e.some(a=>Kt(o,a))}return n}function Uy(e,t,r){return Array.isArray(e)&&e.length===t}function Ky(e){return Jr(e)&&["$and","$or","$nor"].indexOf(e)===-1}function xh(e,t,r){if(me(e)&&!Wu(e)){let n=c=>c,o=t;Object.keys(t).every(Ky)&&(o={temp:t},n=c=>({temp:c}));const a=new Xr(o,r);for(let c=0,u=e.length;c<u;c++)if(a.test(n(e[c])))return!0}return!1}const gd=e=>e===null,Hy={array:me,boolean:to,bool:to,date:Oo,number:Xe,int:Xe,long:Xe,double:Xe,decimal:Xe,null:gd,object:ze,regexp:gr,regex:gr,string:Wt,undefined:_t,function:e=>{throw new Wi("unsupported type key `function`.")},1:Xe,2:Wt,3:ze,4:me,6:_t,8:to,9:Oo,10:gd,11:gr,16:Xe,18:Xe,19:Xe};function vd(e,t,r){const n=Hy[t];return n?n(e):!1}function zy(e,t,r){return me(t)?t.findIndex(n=>vd(e,n))>=0:vd(e,t)}function Rs(e,t,r){return To(e).some(n=>xi(n)===xi(t)&&r(n,t))}const Wy=(e,t,r)=>{const n=Rt(e,t,null,r);return Po(n,r.useStrictMode)&&n.every(o=>Po(o,r.useStrictMode))},Vy=(e,t,r)=>{const n=To(t);return n.length==0?!1:(Ee(n.length==1,"Expression $not takes exactly 1 argument"),!Rt(e,n[0],null,r))},Qy=(e,t,r)=>{const n=Rt(e,t,null,r),o=r.useStrictMode;return Po(n,o)&&n.some(a=>Po(a,o))},Gy=Object.freeze(Object.defineProperty({__proto__:null,$and:Wy,$not:Vy,$or:Qy},Symbol.toStringTag,{value:"Module"})),Yy=(e,t,r)=>{const n=Rt(e,t,null,r);return Ee(me(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),Bt(n[0],n[1])},Jy=No(Vu),Xy=No(Ih),Zy=No(Ch),eb=No(Sh),tb=No(Eh),rb=No(wh),nb=Object.freeze(Object.defineProperty({__proto__:null,$cmp:Yy,$eq:Jy,$gt:Xy,$gte:Zy,$lt:eb,$lte:tb,$ne:rb},Symbol.toStringTag,{value:"Module"})),yd=(e,t)=>{const r={};return e.split("").forEach((n,o)=>r[n]=t*(o+1)),r};({...yd("ABCDEFGHIKLM",1),...yd("NOPQRSTUVWXY",-1)});const bd={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function Ct(e,t=bd){const r=Object.assign({},bd,t),n=new Set(Object.keys(r));return(o,a,c)=>{const u=Rt(o,a,null,c);if(n.has(`${u}`)){const d=r[`${u}`];if(d instanceof Error)throw new Wi(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return d}return e(u)}}Ct(Math.acos,{Infinity:1/0,0:new Error});Ct(Math.acosh,{Infinity:1/0,0:new Error});Ct(Math.asin);Ct(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});Ct(Math.atan);Ct(Math.atanh,{1:1/0,"-1":-1/0});Ct(Math.cos);Ct(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const ob=Math.PI/180;Ct(e=>e*ob,{Infinity:1/0,"-Infinity":1/0});const ib=180/Math.PI;Ct(e=>e*ib,{Infinity:1/0,"-Infinity":-1/0});Ct(Math.sin);Ct(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});Ct(Math.tan);const kh=(e,t,r)=>{Ee(me(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(o=>new Xr(o,r));return o=>n.every(a=>a.test(o))},Qu=(e,t,r)=>{Ee(me(t),"Invalid expression. $or expects value to be an Array");const n=t.map(o=>new Xr(o,r));return o=>n.some(a=>a.test(o))},Dh=(e,t,r)=>{Ee(me(t),"Invalid expression. $nor expects value to be an array.");const n=Qu("$or",t,r);return o=>!n(o)},Oh=(e,t,r)=>{const n={};n[e]=hh(t);const o=new Xr(n,r);return a=>!o.test(a)},Ph=ft(Vu),Rh=ft(Ih),Lh=ft(Ch),$h=ft(_h),Mh=ft(Sh),Ah=ft(Eh),Th=ft(wh),Nh=ft(By);function ab(e,t,r){return n=>Rt(n,t,null,r)}function sb(e,t,r){if(!(r!=null&&r.jsonSchemaValidator))throw new Wi("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return o=>n(o)}const Bh=ft(qy),qh=ft(Fy);function cb(e,t,r){Ee(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return Ee(Ps(n),"$where only accepts a Function object"),o=>Po(n.call(o),r==null?void 0:r.useStrictMode)}const ub=ft(jy),Fh=ft(xh),jh=ft(Uy),Uh=(e,t,r)=>{const n=e.includes("."),o=!!t;return!n||e.match(/\.\d+$/)?a=>rr(a,e)!==void 0===o:a=>{const c=si(a,e,{preserveIndex:!0}),u=rr(c,e.substring(0,e.lastIndexOf(".")));return me(u)?u.some(d=>d!==void 0)===o:u!==void 0===o}},Kh=ft(zy);var wd=!1;function lb(e){return wd||(pd(fu.PIPELINE,{$sort:bh,$project:gh}),pd(fu.QUERY,{$and:kh,$eq:Ph,$elemMatch:Fh,$exists:Uh,$gt:Rh,$gte:Lh,$in:$h,$lt:Mh,$lte:Ah,$ne:Th,$nin:Nh,$mod:Bh,$nor:Dh,$not:Oh,$or:Qu,$regex:qh,$size:jh,$type:Kh}),wd=!0),new Xr(e)}function ro(e,t){var r=It(e.primaryKey);t=Ne(t);var n=dt(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([v,w])=>{(typeof w!="object"||w===null)&&(n.selector[v]={$eq:w})})):n.selector={},n.index){var o=Au(n.index);o.includes(r)||o.push(r),n.index=o}if(n.sort){var m=n.sort.find(v=>Lg(v)===r);m||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(v=>({[v]:"asc"}));else{if(e.indexes){var a=new Set;Object.entries(n.selector).forEach(([v,w])=>{var _=!1;typeof w=="object"&&w!==null?_=!!Object.keys(w).find(E=>zu.has(E)):_=!0,_&&a.add(v)});var c=-1,u;e.indexes.forEach(v=>{var w=Ya(v)?v:[v],_=w.findIndex(E=>!a.has(E));_>0&&_>c&&(c=_,u=w)}),u&&(n.sort=u.map(v=>({[v]:"asc"})))}if(!n.sort)if(e.indexes&&e.indexes.length>0){var d=e.indexes[0],p=Ya(d)?d:[d];n.sort=p.map(v=>({[v]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function Hh(e,t){if(!t.sort)throw X("SNH",{query:t});var r=[];t.sort.forEach(o=>{var a=Object.keys(o)[0],c=Object.values(o)[0];r.push({key:a,direction:c,getValueFn:Rg(a)})});var n=(o,a)=>{for(var c=0;c<r.length;++c){var u=r[c],d=u.getValueFn(o),p=u.getValueFn(a);if(d!==p){var m=u.direction==="asc"?Bt(d,p):Bt(p,d);return m}}};return n}function Gu(e,t){if(!t.sort)throw X("SNH",{query:t});var r=lb(t.selector),n=o=>r.test(o);return n}async function zn(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(o=>t(o)));if(r instanceof Map)return Promise.all([...r.values()].map(o=>t(o)));var n=await t(r);return n}function Ls(e,t){if(!t.sort)throw X("SNH",{query:t});var r=cy(e,t);return{query:t,queryPlan:r}}var db="_rxdb_internal";async function Qi(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function Ri(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var o=n.error[0];throw o}else{var a=It(e.schema.primaryKey),c=qt(a,[t],n),u=c[0];return u}}function fb(e,t){var r=Qi(e,t),n=e.changeStream().pipe(He(o=>o.events.find(a=>a.documentId===t)),ke(o=>!!o),He(o=>Promise.resolve(de(o).documentData)),zi(r),oy(o=>o),ke(o=>!!o));return n}function Li(e){return Object.assign({},...e)}function es(e,t,r,n){if(n)throw n.status===409?X("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?X("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function hb(e,t,r,n,o,a,c){for(var u=!!e.schema.attachments,d=[],p=[],m=[],v=Bi(10),w={id:v,events:[],checkpoint:null,context:o},_=w.events,E=[],D=[],M=[],B=r.size>0,q,G=n.length,ae=function(){var Z=n[ie],ne=Z.document,pe=Z.previous,ye=ne[t],Ie=ne._deleted,Re=pe&&pe._deleted,J=void 0;B&&(J=r.get(ye));var be;if(J){var nt=J._rev;if(!pe||pe&&nt!==pe._rev){var or={isError:!0,status:409,documentId:ye,writeRow:Z,documentInDb:J};return m.push(or),1}var Be=u?Mc(Z):Z;u&&(Ie?pe&&Object.keys(pe._attachments).forEach(ge=>{D.push({documentId:ye,attachmentId:ge,digest:de(pe)._attachments[ge].digest})}):(Object.entries(ne._attachments).find(([ge,Ve])=>{var kt=pe?pe._attachments[ge]:void 0;return!kt&&!Ve.data&&(be={documentId:ye,documentInDb:J,isError:!0,status:510,writeRow:Z,attachmentId:ge}),!0}),be||Object.entries(ne._attachments).forEach(([ge,Ve])=>{var kt=pe?pe._attachments[ge]:void 0;if(!kt)E.push({documentId:ye,attachmentId:ge,attachmentData:Ve,digest:Ve.digest});else{var Dr=Be.document._attachments[ge].digest;Ve.data&&kt.digest!==Dr&&M.push({documentId:ye,attachmentId:ge,attachmentData:Ve,digest:Ve.digest})}}))),be?m.push(be):(u?p.push(Mc(Be)):p.push(Be),q=Be);var ct=null,se=null,Me=null;if(Re&&!Ie)Me="INSERT",ct=u?tr(ne):ne;else if(pe&&!Re&&!Ie)Me="UPDATE",ct=u?tr(ne):ne,se=pe;else if(Ie)Me="DELETE",ct=de(ne),se=pe;else throw X("SNH",{args:{writeRow:Z}});var Ze={documentId:ye,documentData:ct,previousDocumentData:se,operation:Me};_.push(Ze)}else{var Ce=!!Ie;if(u&&Object.entries(ne._attachments).forEach(([ge,Ve])=>{Ve.data?E.push({documentId:ye,attachmentId:ge,attachmentData:Ve,digest:Ve.digest}):(be={documentId:ye,isError:!0,status:510,writeRow:Z,attachmentId:ge},m.push(be))}),be||(u?d.push(Mc(Z)):d.push(Z),q=Z),!Ce){var De={documentId:ye,operation:"INSERT",documentData:u?tr(ne):ne,previousDocumentData:u&&pe?tr(pe):pe};_.push(De)}}},ie=0;ie<G;ie++)ae();return{bulkInsertDocs:d,bulkUpdateDocs:p,newestRow:q,errors:m,eventBulk:w,attachmentsAdd:E,attachmentsRemove:D,attachmentsUpdate:M}}function Mc(e){return{previous:e.previous,document:tr(e.document)}}function pb(e){return atob(e).length}function mb(e){var t=e.data;if(!t)return e;var r={length:pb(t),digest:e.digest,type:e.type};return r}function tr(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=Ne(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=mb(n)}),t}function Gi(e){return Object.assign({},e,{_meta:Ne(e._meta)})}function Yu(e,t,r){Se.deepFreezeWhenDevMode(r);var n=It(t.schema.primaryKey),o={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,async bulkWrite(a,c){for(var u=e.token,d=new Array(a.length),p=Et(),m=0;m<a.length;m++){var v=a[m],w=Gi(v.document);w._meta.lwt=p;var _=v.previous;w._rev=_r(u,_),d[m]={document:w,previous:_}}pt("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:d});var E=await e.lockedRun(()=>t.bulkWrite(d,c)),D={error:[]};Wh.set(D,d);var M=E.error.length===0?[]:E.error.filter(Z=>Z.status===409&&!Z.writeRow.previous&&!Z.writeRow.document._deleted&&de(Z.documentInDb)._deleted?!0:(D.error.push(Z),!1));if(M.length>0){var B=new Set,q=M.map(Z=>(B.add(Z.documentId),{previous:Z.documentInDb,document:Object.assign({},Z.writeRow.document,{_rev:_r(e.token,Z.documentInDb)})})),G=await e.lockedRun(()=>t.bulkWrite(q,c));Dn(D.error,G.error);var ae=qt(n,d,D,B),ie=qt(n,q,G);return Dn(ae,ie),D}return D},query(a){return e.lockedRun(()=>t.query(a))},count(a){return e.lockedRun(()=>t.count(a))},findDocumentsById(a,c){return e.lockedRun(()=>t.findDocumentsById(a,c))},getAttachmentData(a,c,u){return e.lockedRun(()=>t.getAttachmentData(a,c,u))},getChangedDocumentsSince:t.getChangedDocumentsSince?(a,c)=>e.lockedRun(()=>t.getChangedDocumentsSince(de(a),c)):void 0,cleanup(a){return e.lockedRun(()=>t.cleanup(a))},remove(){return e.storageInstances.delete(o),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(o),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()}};return e.storageInstances.add(o),o}function gb(e){if(e.schema.keyCompression)throw X("UT5",{args:{params:e}});if(pu(e.schema))throw X("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw X("UT7",{args:{params:e}})}function pu(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function vb(e,t,r){var n=It(e.schema.primaryKey),o=r?r.lwt:Tu,a=r?r.id:"";return ro(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:o}},{"_meta.lwt":{$eq:o},[n]:{$gt:r?a:""}}],"_meta.lwt":{$gte:o}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function zh(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=It(e.schema.primaryKey),o=Ls(e.schema,vb(e,t,r)),a=await e.query(o),c=a.documents,u=Dg(c);return{documents:c,checkpoint:u?{id:u[n],lwt:u._meta.lwt}:r||{id:"",lwt:0}}}var Wh=new WeakMap,yb=new WeakMap;function qt(e,t,r,n){return zt(yb,r,()=>{var o=[],a=Wh.get(r);if(a||(a=t),r.error.length>0||n){for(var c=n||new Set,u=0;u<r.error.length;u++){var d=r.error[u];c.add(d.documentId)}for(var p=0;p<a.length;p++){var m=a[p].document;c.has(m[e])||o.push(tr(m))}}else{o.length=t.length-r.error.length;for(var v=0;v<a.length;v++){var w=a[v].document;o[v]=tr(w)}}return o})}var Vh=function(){function e(r,n,o,a){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=o,this.postWrite=a}var t=e.prototype;return t.addWrite=function(n,o){var a=n[this.primaryPath],c=zt(this.queueByDocId,a,()=>[]),u=new Promise((d,p)=>{var m={lastKnownDocumentState:n,modifier:o,resolve:d,reject:p};de(c).push(m),this.triggerRun()});return u},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],o=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(o.entries()).map(async([c,u])=>{var d=bb(u.map(v=>v.lastKnownDocumentState)),p=d;for(var m of u)try{p=await m.modifier(dt(p))}catch(v){m.reject(v),m.reject=()=>{},m.resolve=()=>{}}try{await this.preWrite(p,d)}catch(v){u.forEach(w=>w.reject(v));return}n.push({previous:d,document:p})}));var a=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(qt(this.primaryPath,n,a).map(c=>{var u=c[this.primaryPath];this.postWrite(c);var d=Co(o,u);d.forEach(p=>p.resolve(c))})),a.error.forEach(c=>{var u=c.documentId,d=Co(o,u),p=ks(c);if(p){var m=zt(this.queueByDocId,u,()=>[]);d.reverse().forEach(w=>{w.lastKnownDocumentState=de(p.documentInDb),de(m).unshift(w)})}else{var v=Tf(c);d.forEach(w=>w.reject(v))}}),this.isRunning=!1,this.triggerRun()}},e}();function _d(e){var t=async r=>{var n=$g(r);n._deleted=r._deleted;var o=await e(n),a=Object.assign({},o,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof o._deleted<"u"?o._deleted:r._deleted});return typeof a._deleted>"u"&&(a._deleted=!1),a};return t}function bb(e){var t=e[0],r=Qr(t._rev);return e.forEach(n=>{var o=Qr(n._rev);o>r&&(t=n,r=o)}),t}var $s={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(He(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,t=this.primary;return e.collection.eventBulks$.pipe(ke(r=>!r.isLocal),He(r=>r.events.find(n=>n.documentId===t)),ke(r=>!!r),He(r=>oh(de(r))),zi(e.collection._docCache.getLatestDocumentData(t)),Ei((r,n)=>r._rev===n._rev),He(r=>this.collection._docCache.getCachedRxDocument(r)),Hi(qi))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(Se.isDevMode()){if(e.includes(".item."))throw X("DOC1",{path:e});if(e===this.primaryPath)throw X("DOC2");if(this.collection.schema.finalFields.includes(e))throw X("DOC3",{path:e});var t=xo(this.collection.schema.jsonSchema,e);if(!t)throw X("DOC4",{path:e})}return this.$.pipe(He(r=>Gr(r,e)),Ei())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=xo(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return Nu;if(!t)throw X("DOC5",{path:e});if(!t.ref)throw X("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw X("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(o=>{var a=o.values();return Array.from(a)}):n.findOne(r).exec()},get(e){return Yh(this,e)},toJSON(e=!1){if(e)return Se.deepFreezeWhenDevMode(this._data);var t=Ne(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,Se.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return dt(this.toJSON(e))},update(e){throw xe("update")},incrementalUpdate(e){throw xe("update")},updateCRDT(e){throw xe("crdt")},putAttachment(){throw xe("attachments")},getAttachment(){throw xe("attachments")},allAttachments(){throw xe("attachments")},get allAttachments$(){throw xe("attachments")},async modify(e,t){var r=this._data,n=await _d(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,_d(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=dt(t);return Object.entries(e).forEach(([n,o])=>{r[n]=o}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=Ne(e),this._data._deleted)throw X("DOC11",{id:this.primary,document:this});await Gh(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),o=n.error[0];return es(this.collection,this.primary,e,o),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(qt(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(X("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var t=e.error[0];es(this.collection,this.primary,this._data,t)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw X("DOC14")}};function Qh(e=$s){var t=function(n,o){this.collection=n,this._data=o,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function wb(e,t,r){var n=new e(t,r);return pt("createRxDocument",n),n}function Gh(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),Se.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function Yh(e,t){return zt(e._propertyCache,t,()=>{var r=Gr(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return Se.deepFreezeWhenDevMode(r);var n=new Proxy(Ne(r),{get(o,a){if(typeof a!="string")return o[a];var c=a.charAt(a.length-1);if(c==="$")if(a.endsWith("$$")){var u=a.slice(0,-2);return e.get$$(ni(t+"."+u))}else{var d=a.slice(0,-1);return e.get$(ni(t+"."+d))}else if(c==="_"){var p=a.slice(0,-1);return e.populate(ni(t+"."+p))}else{var m=o[a];return typeof m=="number"||typeof m=="string"||typeof m=="boolean"?m:Yh(e,ni(t+"."+a))}}});return n})}function Ju(e){return e[e.length-1]}function _b(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function Sd(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!_b(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let o=0;o<n.length;o++){const a=n[o];if(Sb(e,a)?e=o===n.length-1?void 0:null:e=e[a],e==null){if(o!==n.length-1)return r;break}}return e===void 0?r:e}function Sb(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const Jh=e=>!!e.queryParams.limit,Eb=e=>e.queryParams.limit===1,Ib=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),Cb=e=>e.changeEvent.operation==="DELETE",xb=e=>e.changeEvent.operation==="INSERT",kb=e=>e.changeEvent.operation==="UPDATE",Db=e=>Jh(e)&&e.previousResults.length>=e.queryParams.limit,Ob=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let o=0;o<t.length;o++){const a=t[o],c=Sd(r,a),u=Sd(n,a);if(c!==u)return!0}return!1},Pb=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let o=0;o<n.length;o++)if(n[o][r]===t)return!0;return!1}},Rb=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},Lb=e=>{const t=Ju(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},$b=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Mb=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=Ju(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Ab=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Tb=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=Ju(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Nb=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},Bb=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},qb=e=>e.previousResults.length===0,Fb={0:xb,1:kb,2:Cb,3:Jh,4:Eb,5:Ib,6:qb,7:Db,8:Rb,9:Lb,10:Ob,11:Pb,12:$b,13:Mb,14:Ab,15:Tb,16:Nb,17:Bb};function jb(e,t,r,n){var o=e.length,a=o-1,c=0;if(o===0)return e.push(t),0;for(var u;n<=a;)c=n+(a-n>>1),u=e[c],r(u,t)<=0?n=c+1:a=c-1;return r(u,t)<=0&&c++,e.splice(c,0,t),c}const Ub=e=>{},Xu=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Zu=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},el=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},tl=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Kb=e=>{el(e),Zu(e)},Hb=e=>{tl(e),Xu(e)},zb=e=>{el(e),Xu(e)},Wb=e=>{tl(e),Zu(e)},Xh=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},Vb=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let o=0;o<n.length;o++)if(n[o][r]===e.changeEvent.id){n[o]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},Qb=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},Zh=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(o=>o[e.queryParams.primaryKey]===t))return;jb(e.previousResults,r,e.queryParams.sortComparator,0)},Gb=e=>{Xh(e),Zh(e)},Yb=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},Jb=e=>{throw new Error("Action unknownAction should never be called")},Xb=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],Zb={doNothing:Ub,insertFirst:Xu,insertLast:Zu,removeFirstItem:el,removeLastItem:tl,removeFirstInsertLast:Kb,removeLastInsertFirst:Hb,removeFirstInsertFirst:zb,removeLastInsertLast:Wb,removeExisting:Xh,replaceExisting:Vb,alwaysWrong:Qb,insertAtSortPosition:Zh,removeExistingAndInsertAtSortPosition:Gb,runFullQueryAgain:Yb,unknownAction:Jb},ew=40;function Ac(e){return e.charCodeAt(0)-ew}function tw(e){return e?"1":"0"}function Ed(e,t){const r=[];for(let n=0,o=e.length;n<o;n+=t)r.push(e.substring(n,n+t));return r}function rw(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,o=e.substring(2,n),a=Ed(o,2);for(let D=0;D<a.length;D++){const M=a[D],B=M.charAt(0),q=Ac(M.charAt(1));t.set(B,q)}const c=e.substring(n,e.length-3),u=Ed(c,4);for(let D=0;D<u.length;D++){const M=u[D],B=M.charAt(0),q=M.charAt(1),G=M.charAt(2),ae=Ac(M.charAt(3));if(!t.has(q))throw new Error("missing node with id "+q);if(!t.has(G))throw new Error("missing node with id "+G);const ie=t.get(q),Z=t.get(G),ne={l:ae,0:ie,1:Z};t.set(B,ne)}const d=e.slice(-3),p=d.charAt(0),m=d.charAt(1),v=Ac(d.charAt(2)),w=t.get(p),_=t.get(m);return{l:v,0:w,1:_}}function nw(e,t,r){let n=e,o=e.l;for(;;){const a=t[o](r),c=tw(a);if(n=n[c],typeof n=="number"||typeof n=="string")return n;o=n.l}}const ow="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9¡bf9¢bq9£cg9¤ck9¥cn9¦nd9§np9¨nq9©nf9ªng9«nm9¬nk9­mr9®ms9¯mt9°mj9±mk9²ml9³mn9´mc8µ³{8¶¯}8·°¤8¸³§8¹mn8º³«8»³m8¼m´4½z²4¾³w4¿zµ4À¯¶4Á°·4Â³º4Ã³¸4Äm¹4Åv¤7Æyn7ÇÀÁ7È~7É¥¤7ÊÃÄ7Ë¨n7Ìº¹7Í­°7Î®m7Ï¯°7Ð±m7Ñ³m7Ò¼m5ÓÄm5Ô¹m5Õ½°5Ö¾m5×¿°5ØÇÏ5ÙÂm5ÚÊÑ5Û±m5Üºm5ÝÌÑ5ÞÕÍ2ß|2à¡u2á£Å2âÖÎ2ã¦Æ2ä©x2åªÆ2æ×Ø2ç|È2è¡¢2é£É2ê¤¥2ëÙÚ2ì¦Ë2í©n2îªn2ïÛÐ2ðÜÝ2ñ¬n2òÒÓ/óan/ôbn/õcn/öÞâ/÷ßã/øàä/ùáå/úæë/ûçì/üèí/ýéî/þÍÎ/ÿÏÑ/ĀòÔ,ācn,Ăöï,ă¤ñ,Ąúð,ąêñ,ĆþÐ,ćÿÑ,Ĉac0ĉbc0Ċóõ0ċôā0Čßá0čà¤0Ďçé0ďèê0Đ÷ù0đøă0Ēûý0ēüą0ĔmÒ-ĕmĀ-ĖÞæ-ėČĎ-Ęčď-ęĂĄ-ĚĐĒ-ěđē-Ĝ²»-ĝÍÏ-ĞĆć-ğ²³-ĠĔĈ3ġĕĊ3ĢĖė3ģęĚ3ĤĢĝ(ĥĜğ(ĦģĞ(ħĠġ+Ĩĉċ+ĩĤĦ+ĪĘě+īħĨ1ĬĩĪ1ĭĬī*Įĥm*ĭĮ.";let Tc;function iw(){return Tc||(Tc=rw(ow)),Tc}const aw=e=>nw(iw(),Fb,e);function sw(e){const t=aw(e);return Xb[t]}function cw(e,t,r,n,o){const a=Zb[e];return a({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:o}),n}function uw(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var lw=new WeakMap;function dw(e){return zt(lw,e,()=>{var t=e.collection,r=ro(t.storageInstance.schema,dt(e.mangoQuery)),n=t.schema.primaryPath,o=Hh(t.schema.jsonSchema,r),a=(p,m)=>{var v={docA:p,docB:m};return o(v.docA,v.docB)},c=Gu(t.schema.jsonSchema,r),u=p=>{var m={doc:p};return c(m.doc)},d={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:uw(n,r),sortComparator:a,queryMatcher:u};return d})}function fw(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=dw(e),n=de(e._result).docsData.slice(0),o=de(e._result).docsDataMap,a=!1,c=[],u=0;u<t.length;u++){var d=t[u],p=iy(d);p&&c.push(p)}var m=c.find(v=>{var w={queryParams:r,changeEvent:v,previousResults:n,keyDocumentMap:o},_=sw(w);if(_==="runFullQueryAgain")return!0;if(_!=="doNothing")return a=!0,cw(_,r,v,n,o),!1});return m?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:a,newResults:n}}var hw=function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var o=n.toString(),a=zt(this._map,o,()=>n);return a},e}();function pw(){return new hw}function Id(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function mw(e){return e.refCount$.observers.length}var gw=100,vw=30*1e3,yw=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var o=Et()-t,a=[],c=Array.from(n._map.values());for(var u of c)if(!(mw(u)>0)){if(u._lastEnsureEqual===0&&u._creationTime<o){Id(n,u);continue}a.push(u)}var d=a.length-e;if(!(d<=0)){var p=a.sort((v,w)=>v._lastEnsureEqual-w._lastEnsureEqual),m=p.slice(0,d);m.forEach(v=>Id(n,v))}}},ep=yw(gw,vw),Nc=new WeakSet;function bw(e){Nc.has(e)||(Nc.add(e),Tg().then(()=>Fg(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),Nc.delete(e)}))}var tp=function(){function e(r,n,o){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(a=>{var c=a.docId,u=this.cacheItemByDocId.get(c);u&&(u[0].delete(a.revisionHeight),u[0].size===0&&this.cacheItemByDocId.delete(c))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=o,n.subscribe(a=>{this.tasks.add(()=>{for(var c=this.cacheItemByDocId,u=0;u<a.length;u++){var d=a[u],p=c.get(d.documentId);if(p){var m=d.documentData;m||(m=d.previousDocumentData),p[1]=m}}}),this.tasks.size<=1&&xs().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(o=>o()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var o=Co(this.cacheItemByDocId,n);return o[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var o=this.cacheItemByDocId.get(n);if(o)return o[1]},Yr(e,[{key:"getCachedRxDocuments",get:function(){var r=Cd(this);return mr(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=Cd(this);return mr(this,"getCachedRxDocument",n=>r([n])[0])}}])}();function Cd(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,o=Se.deepFreezeWhenDevMode,a=e.documentCreator,c=u=>{for(var d=new Array(u.length),p=[],m=0;m<u.length;m++){var v=u[m],w=v[t],_=Qr(v._rev),E=void 0,D=void 0,M=r.get(w);M?(E=M[0],D=E.get(_)):(E=new Map,M=[E,v],r.set(w,M));var B=D?D.deref():void 0;B||(v=o(v),B=a(v),E.set(_,_w(B)),n&&p.push(B)),d[m]=B}return p.length>0&&n&&(e.tasks.add(()=>{for(var q=0;q<p.length;q++){var G=p[q];n.register(G,{docId:G.primary,revisionHeight:Qr(G.revision)})}}),e.tasks.size<=1&&xs().then(()=>{e.processTasks()})),d};return c}function mu(e,t){var r=e.getCachedRxDocuments;return r(t)}var ww=typeof WeakRef=="function",_w=ww?Sw:Ew;function Sw(e){return new WeakRef(e)}function Ew(e){return{deref(){return e}}}var xd=function(){function e(r,n,o){this.time=Et(),this.query=r,this.count=o,this.documents=mu(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var o=this.query.op;if(o==="count")return this.count;if(o==="findOne"){var a=this.documents.length===0?null:this.documents[0];if(!a&&n)throw X("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:o});return a}else return o==="findByIds"?this.docsMap:this.documents.slice(0)},Yr(e,[{key:"docsData",get:function(){return mr(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),mr(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,o=0;o<n.length;o++){var a=n[o];r.set(a.primary,a)}return mr(this,"docsMap",r)}}])}(),Iw=0,Cw=function(){return++Iw},rp=function(){function e(r,n,o,a={}){this.id=Cw(),this._execOverDatabaseCount=0,this._creationTime=Et(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new Tr(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=Sr,this.op=r,this.mangoQuery=n,this.collection=o,this.other=a,n||(this.mangoQuery=Aa()),this.isFindOneByIdQuery=Ow(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw X("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new xd(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var o=new xd(this,n,n.length);this._result=o},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var n=this.getPreparedQuery(),o=await this.collection.storageInstance.count(n);if(o.mode==="slow"&&!this.collection.database.allowSlowCount)throw X("QU14",{collection:this.collection,queryObj:this.mangoQuery});return o.count}if(this.op==="findByIds"){var a=de(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,c=new Map,u=[];if(a.forEach(m=>{var v=this.collection._docCache.getLatestDocumentDataIfExists(m);if(v){if(!v._deleted){var w=this.collection._docCache.getCachedRxDocument(v);c.set(m,w)}}else u.push(m)}),u.length>0){var d=await this.collection.storageInstance.findDocumentsById(u,!1);d.forEach(m=>{var v=this.collection._docCache.getCachedRxDocument(m);c.set(v.primary,v)})}return c}var p=Dw(this);return p.then(m=>m)},t.exec=async function(n){if(n&&this.op!=="findOne")throw X("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await kd(this);var o=de(this._result);return o.getValue(n)},t.toString=function(){var n=Ja({op:this.op,query:ro(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),o=JSON.stringify(n);return this.toString=()=>o,o},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:ro(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),pt("prePrepareQuery",n);var o=Ls(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>o,o},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=async function(){var n=await this.exec();if(Array.isArray(n)){var o=await this.collection.bulkRemove(n);if(o.error.length>0)throw Tf(o.error[0]);return o.success}else return n.remove()},t.incrementalRemove=function(){return zn(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw xe("update")},t.patch=function(n){return zn(this.asRxQuery,o=>o.patch(n))},t.incrementalPatch=function(n){return zn(this.asRxQuery,o=>o.incrementalPatch(n))},t.modify=function(n){return zn(this.asRxQuery,o=>o.modify(n))},t.incrementalModify=function(n){return zn(this.asRxQuery,o=>o.incrementalModify(n))},t.where=function(n){throw xe("query-builder")},t.sort=function(n){throw xe("query-builder")},t.skip=function(n){throw xe("query-builder")},t.limit=function(n){throw xe("query-builder")},Yr(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(ke(n=>!n.isLocal),zi(null),Ir(()=>kd(this)),He(()=>this._result),Hi(qi),Ei((n,o)=>!!(n&&n.time===de(o).time)),ke(n=>!!n),He(n=>de(n).getValue()));this._$=sy(r,this.refCount$.pipe(ke(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=ro(this.collection.schema.jsonSchema,this.mangoQuery);return mr(this,"queryMatcher",Gu(r,n))}},{key:"asRxQuery",get:function(){return this}}])}();function Aa(){return{selector:{}}}function xw(e){return e.collection._queryCache.getByQuery(e)}function Wn(e,t,r,n){pt("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var o=new rp(e,t,r,n);return o=xw(o),bw(r),o}function np(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function kd(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.closed||np(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>kw(e)),e._ensureEqualQueue)}function kw(e){if(e._lastEnsureEqual=Et(),e.collection.database.closed||np(e))return Sr;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var o=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var a=de(e._result).count,c=a;o.forEach(d=>{var p=d.previousDocumentData&&e.doesDocumentDataMatch(d.previousDocumentData),m=e.doesDocumentDataMatch(d.documentData);!p&&m&&c++,p&&!m&&c--}),c!==a&&(t=!0,e._setResultData(c))}else{var u=fw(e,o);u.runFullQueryAgain?r=!0:u.changed&&(t=!0,e._setResultData(u.newResults))}}}return r?e._execOverDatabase().then(d=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof d=="number"?((!e._result||d!==e._result.count)&&(t=!0,e._setResultData(d)),t):((!e._result||!Mg(e.collection.schema.primaryPath,d,e._result.docsData))&&(t=!0,e._setResultData(d)),t))):Promise.resolve(t)}async function Dw(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(m=>{var v=e.collection._docCache.getLatestDocumentDataIfExists(m);return v?(v._deleted||t.push(v),!1):!0}),n.length>0){var o=await r.storageInstance.findDocumentsById(n,!1);Dn(t,o)}}else{var a=e.isFindOneByIdQuery,c=e.collection._docCache.getLatestDocumentDataIfExists(a);if(!c){var u=await r.storageInstance.findDocumentsById([a],!1);u[0]&&(c=u[0])}c&&!c._deleted&&t.push(c)}else{var d=e.getPreparedQuery(),p=await r.storageInstance.query(d);t=p.documents}return t}function Ow(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var Sn="collection",rl="storage-token",Ta="rx-migration-status",Pw="rx-pipeline-checkpoint",Rw="RxInternalDocument",nl=Ds({version:0,title:Rw,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[Sn,rl,Ta,Pw,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function Lo(e,t){return $n(nl,{key:e,context:t})}async function op(e){var t=Ls(e.schema,{selector:{context:Sn,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var ip="storageToken",Lw=Lo(ip,rl);async function $w(e){var t=Bi(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:Lw,context:rl,key:ip,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:Ao(),_rev:Ht(),_attachments:{}},o=[{document:n}],a=await e.internalStore.bulkWrite(o,"internal-add-storage-token");if(!a.error[0])return qt("id",o,a)[0];var c=de(a.error[0]);if(c.isError&&ks(c)){var u=c;if(!Mw(u.documentInDb.data.rxdbVersion,e.rxdbVersion))throw X("DM5",{args:{database:e.name,databaseStateVersion:u.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==u.documentInDb.data.passwordHash)throw X("DB1",{passwordHash:r,existingPasswordHash:u.documentInDb.data.passwordHash});var d=u.documentInDb;return de(d)}throw c}function Mw(e,t){if(!e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r==="15"&&n==="16"?!0:r===n}async function Aw(e,t,r){if(e.schema.version!==r.version)throw X("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=gu(e.name,e.schema.jsonSchema),o=Lo(n,Sn);;){var a=await Qi(e.database.internalStore,o),c=dt(de(a)),u=c.data.connectedStorages.find(d=>d.collectionName===t&&d.schema.version===r.version);if(u)return;c.data.connectedStorages.push({collectionName:t,schema:r});try{await Ri(e.database.internalStore,{previous:de(a),document:c},"add-connected-storage-to-collection")}catch(d){if(!ks(d))throw d}}}function gu(e,t){return e+"-"+t.version}function ka(e,t){return t=Ne(t),t=ov(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=Zg(e.primaryPath,e.jsonSchema,t)),t._meta=Ao(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=Ht()),t}async function Tw(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function ap(e,t,r,n,o,a,c,u){var d=await op(t),p=d.filter(_=>_.data.name===o),m=[];p.forEach(_=>{m.push({collectionName:_.data.name,schema:_.data.schema,isCollection:!0}),_.data.connectedStorages.forEach(E=>m.push({collectionName:E.collectionName,isCollection:!1,schema:E.schema}))});var v=new Set;if(m=m.filter(_=>{var E=_.collectionName+"||"+_.schema.version;return v.has(E)?!1:(v.add(E),!0)}),await Promise.all(m.map(async _=>{var E=await e.createStorageInstance({collectionName:_.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:a,options:{},schema:_.schema,password:c,devMode:Se.isDevMode()});await E.remove(),_.isCollection&&await Fi("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:o})})),u){var w=p.map(_=>{var E=Gi(_);return E._deleted=!0,E._meta.lwt=Et(),E._rev=_r(r,_),{previous:_,document:E}});await t.bulkWrite(w,"rx-database-remove-collection-all")}}function Ot(e){if(e.closed)throw X("COL21",{collection:e.name,version:e.schema.version})}var Nw=function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(ke(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&xs().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(o=>o()),this.tasks.clear()}},t._handleChangeEvents=function(n){var o=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(Dn(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var a=o+1,c=this.eventCounterMap,u=0;u<n.length;u++){var d=n[u];c.set(d,a+u)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var o=this.buffer[0],a=this.eventCounterMap.get(o);if(n<a)return null;var c=n-a;return c},t.getFrom=function(n){this.processTasks();var o=[],a=this.getArrayIndexByPointer(n);if(a===null)return null;for(;;){var c=this.buffer[a];if(a++,c)o.push(c);else return o}},t.runFrom=function(n,o){this.processTasks();var a=this.getFrom(n);if(a===null)throw new Error("out of bounds");a.forEach(c=>o(c))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.close=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e}();function Bw(e){return new Nw(e)}var qw=new WeakMap;function Fw(e){var t=e.schema.getDocumentPrototype(),r=Kw(e),n=$s,o={};return[t,r,n].forEach(a=>{var c=Object.getOwnPropertyNames(a);c.forEach(u=>{var d=Object.getOwnPropertyDescriptor(a,u),p=!0;(u.startsWith("_")||u.endsWith("_")||u.startsWith("$")||u.endsWith("$"))&&(p=!1),typeof d.value=="function"?Object.defineProperty(o,u,{get(){return d.value.bind(this)},enumerable:p,configurable:!1}):(d.enumerable=p,d.configurable=!1,d.writable&&(d.writable=!1),Object.defineProperty(o,u,d))})}),o}function jw(e){return zt(qw,e,()=>Qh(Fw(e)))}function Uw(e,t,r){var n=wb(t,e,Se.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),pt("postCreateRxDocument",n),n}function Kw(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}var ts={isEqual(e,t){return wi(tr(e),tr(t))},resolve(e){return e.realMasterState}},sp=["pre","post"],cp=["insert","save","remove","create"],Dd=!1,Vn=new Set,up=function(){function e(r,n,o,a,c={},u={},d={},p={},m={},v=ep,w={},_=ts){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=pw(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=o,this.internalStorageInstance=a,this.instanceCreationOptions=c,this.migrationStrategies=u,this.methods=d,this.attachments=p,this.options=m,this.cacheReplacementPolicy=v,this.statics=w,this.conflictHandler=_,Hw(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(ke(E=>E.collectionName===this.name))),this.database&&Vn.add(this)}var t=e.prototype;return t.prepare=async function(){if(!await Lf()){for(var n=0;n<10&&Vn.size>nd;)n++,await this.promiseWait(30);if(Vn.size>nd)throw X("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(Vn.values()).map(d=>({db:d.database?d.database.name:"",c:d.name}))}})}this.storageInstance=Yu(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new Vh(this.storageInstance,this.schema.primaryPath,(d,p)=>Gh(this,d,p),d=>this._runHooks("post","save",d)),this.$=this.eventBulks$.pipe(Ir(d=>ih(d))),this.checkpoint$=this.eventBulks$.pipe(He(d=>d.checkpoint)),this._changeEventBuffer=Bw(this.asRxCollection);var o;this._docCache=new tp(this.schema.primaryPath,this.eventBulks$.pipe(ke(d=>!d.isLocal),He(d=>d.events)),d=>(o||(o=jw(this.asRxCollection)),Uw(this.asRxCollection,o,d)));var a=this.database.internalStore.changeStream().pipe(ke(d=>{var p=this.name+"-"+this.schema.version,m=d.events.find(v=>v.documentData.context==="collection"&&v.documentData.key===p&&v.operation==="DELETE");return!!m})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(d=>d()))});this._subs.push(a);var c=await this.database.storageToken,u=this.storageInstance.changeStream().subscribe(d=>{var p={id:d.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:c,events:d.events,databaseToken:this.database.token,checkpoint:d.checkpoint,context:d.context};this.database.$emit(p)});return this._subs.push(u),$t},t.cleanup=function(n){throw Ot(this),xe("cleanup")},t.migrationNeeded=function(){throw xe("migration-schema")},t.getMigrationState=function(){throw xe("migration-schema")},t.startMigration=function(n=10){return Ot(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){Ot(this);var o=await this.bulkInsert([n]),a=o.error[0];es(this,n[this.schema.primaryPath],n,a);var c=de(o.success[0]);return c},t.insertIfNotExists=async function(n){var o=await this.bulkInsert([n]);if(o.error.length>0){var a=o.error[0];if(a.status===409){var c=a.documentInDb;return mu(this._docCache,[c])[0]}else throw a}return o.success[0]},t.bulkInsert=async function(n){if(Ot(this),n.length===0)return{success:[],error:[]};var o=this.schema.primaryPath,a=new Set,c;if(this.hasHooks("pre","insert"))c=await Promise.all(n.map(M=>{var B=ka(this.schema,M);return this._runHooks("pre","insert",B).then(()=>(a.add(B[o]),{document:B}))}));else{c=new Array(n.length);for(var u=this.schema,d=0;d<n.length;d++){var p=n[d],m=ka(u,p);a.add(m[o]),c[d]={document:m}}}if(a.size!==n.length)throw X("COL22",{collection:this.name,args:{documents:n}});var v=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-insert"),w,_=this,E={get success(){if(!w){var M=qt(_.schema.primaryPath,c,v);w=mu(_._docCache,M)}return w},error:v.error};if(this.hasHooks("post","insert")){var D=new Map;c.forEach(M=>{var B=M.document;D.set(B[o],B)}),await Promise.all(E.success.map(M=>this._runHooks("post","insert",D.get(M.primary),M)))}return E},t.bulkRemove=async function(n){Ot(this);var o=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var a;typeof n[0]=="string"?a=await this.findByIds(n).exec():(a=new Map,n.forEach(_=>a.set(_.primary,_)));var c=[],u=new Map;Array.from(a.values()).forEach(_=>{var E=_.toMutableJSON(!0);c.push(E),u.set(_.primary,E)}),await Promise.all(c.map(_=>{var E=_[this.schema.primaryPath];return this._runHooks("pre","remove",_,a.get(E))}));var d=c.map(_=>{var E=Ne(_);return E._deleted=!0,{previous:_,document:E}}),p=await this.storageInstance.bulkWrite(d,"rx-collection-bulk-remove"),m=qt(this.schema.primaryPath,d,p),v=[],w=m.map(_=>{var E=_[o],D=this._docCache.getCachedRxDocument(_);return v.push(D),E});return await Promise.all(w.map(_=>this._runHooks("post","remove",u.get(_),a.get(_)))),{success:v,error:p.error}},t.bulkUpsert=async function(n){Ot(this);var o=[],a=new Map;n.forEach(p=>{var m=ka(this.schema,p),v=m[this.schema.primaryPath];if(!v)throw X("COL3",{primaryPath:this.schema.primaryPath,data:m,schema:this.schema.jsonSchema});a.set(v,m),o.push(m)});var c=await this.bulkInsert(o),u=c.success.slice(0),d=[];return await Promise.all(c.error.map(async p=>{if(p.status!==409)d.push(p);else{var m=p.documentId,v=Co(a,m),w=de(p.documentInDb),_=this._docCache.getCachedRxDocuments([w])[0],E=await _.incrementalModify(()=>v);u.push(E)}})),{error:d,success:u}},t.upsert=async function(n){Ot(this);var o=await this.bulkUpsert([n]);return es(this.asRxCollection,n[this.schema.primaryPath],n,o.error[0]),o.success[0]},t.incrementalUpsert=function(n){Ot(this);var o=ka(this.schema,n),a=o[this.schema.primaryPath];if(!a)throw X("COL4",{data:n});var c=this._incrementalUpsertQueues.get(a);return c||(c=$t),c=c.then(()=>Ww(this,a,o)).then(u=>u.inserted?u.doc:zw(u.doc,o)),this._incrementalUpsertQueues.set(a,c),c},t.find=function(n){Ot(this),pt("prePrepareRxQuery",{op:"find",queryObj:n,collection:this}),n||(n=Aa());var o=Wn("find",n,this);return o},t.findOne=function(n){Ot(this),pt("prePrepareRxQuery",{op:"findOne",queryObj:n,collection:this});var o;if(typeof n=="string")o=Wn("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=Aa()),n.limit)throw X("QU6");n=Ne(n),n.limit=1,o=Wn("findOne",n,this)}return o},t.count=function(n){Ot(this),n||(n=Aa());var o=Wn("count",n,this);return o},t.findByIds=function(n){Ot(this);var o={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},a=Wn("findByIds",o,this);return a},t.exportJSON=function(){throw xe("json-dump")},t.importJSON=function(n){throw xe("json-dump")},t.insertCRDT=function(n){throw xe("crdt")},t.addPipeline=function(n){throw xe("pipeline")},t.addHook=function(n,o,a,c=!1){if(typeof a!="function")throw Pt("COL7",{key:o,when:n});if(!sp.includes(n))throw Pt("COL8",{key:o,when:n});if(!cp.includes(o))throw X("COL9",{key:o});if(n==="post"&&o==="create"&&c===!0)throw X("COL10",{when:n,key:o,parallel:c});var u=a.bind(this),d=c?"parallel":"series";this.hooks[o]=this.hooks[o]||{},this.hooks[o][n]=this.hooks[o][n]||{series:[],parallel:[]},this.hooks[o][n][d].push(u)},t.getHooks=function(n,o){return!this.hooks[o]||!this.hooks[o][n]?{series:[],parallel:[]}:this.hooks[o][n]},t.hasHooks=function(n,o){if(!this.hooks[o]||!this.hooks[o][n])return!1;var a=this.getHooks(n,o);return a?a.series.length>0||a.parallel.length>0:!1},t._runHooks=function(n,o,a,c){var u=this.getHooks(n,o);if(!u)return $t;var d=u.series.map(p=>()=>p(a,c));return jg(d).then(()=>Promise.all(u.parallel.map(p=>p(a,c))))},t._runHooksSync=function(n,o,a,c){if(this.hasHooks(n,o)){var u=this.getHooks(n,o);u&&u.series.forEach(d=>d(a,c))}},t.promiseWait=function(n){var o=new Promise(a=>{var c=setTimeout(()=>{this.timeouts.delete(c),a()},n);this.timeouts.add(c)});return o},t.close=async function(){return this.closed?Sr:(Vn.delete(this),await Promise.all(this.onClose.map(n=>n())),this.closed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],Fi("postCloseRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(n=>n())),await ap(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},Yr(e,[{key:"insert$",get:function(){return this.$.pipe(ke(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(ke(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(ke(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])}();function Hw(e){if(!Dd){Dd=!0;var t=Object.getPrototypeOf(e);cp.forEach(r=>{sp.map(n=>{var o=n+kf(r);t[o]=function(a,c){return this.addHook(n,r,a,c)}})})}}function zw(e,t){return e.incrementalModify(r=>t)}function Ww(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(o=>o?{doc:o,inserted:!1}:e.insert(r).then(a=>({doc:a,inserted:!0})))}function Vw({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:o={},autoMigrate:a=!0,statics:c={},methods:u={},attachments:d={},options:p={},localDocuments:m=!1,cacheReplacementPolicy:v=ep,conflictHandler:w=ts}){var _={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:Se.isDevMode()};return pt("preCreateRxStorageInstance",_),Tw(e,_).then(E=>{var D=new up(e,t,r,E,n,o,u,d,p,v,c,w);return D.prepare().then(()=>{Object.entries(c).forEach(([B,q])=>{Object.defineProperty(D,B,{get:()=>q.bind(D)})});var M=$t;return a&&D.schema.version!==0&&(M=D.migratePromise()),M}).then(()=>(pt("createRxCollection",{collection:D,creator:{name:t,schema:r,storageInstance:E,instanceCreationOptions:n,migrationStrategies:o,methods:u,attachments:d,options:p,cacheReplacementPolicy:v,localDocuments:m,statics:c}}),D)).catch(M=>(Vn.delete(D),E.close().then(()=>Promise.reject(M))))})}var lp=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};lp.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,vu(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(o){throw this.unlock(),o}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(o){return r.unlock(),o}).catch(function(o){throw r.unlock(),o})},requestIdlePromise:function(t){var r=this;t=t||{};var n,o=new Promise(function(u){return n=u}),a=function(){Bc(r,o),n()};if(o._manRes=a,t.timeout){var c=setTimeout(function(){o._manRes()},t.timeout);o._timeoutObj=c}return this._iC.add(o),vu(this),o},cancelIdlePromise:function(t){Bc(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,o=this.requestIdlePromise(r);return this._hPM.set(n,o),this._pHM.set(o,n),o.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return Bc(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function Qw(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return vu(e)},0)}}function Bc(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function vu(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}Qw(e),e._tryIR=!1},0)},0))}class ol{constructor(t){lt(this,"ttl");lt(this,"map",new Map);lt(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,dp()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Gw(this)},0))}clear(){this.map.clear()}}function Gw(e){const t=dp()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const o=n[0];if(n[1]<t)e.map.delete(o);else return}}function dp(){return Date.now()}var yu=new Set,Od=new Map,il=function(){function e(r,n,o,a,c,u,d=!1,p={},m,v,w,_,E,D){this.idleQueue=new lp,this.rxdbVersion=Rf,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new Mt,this.closePromise=null,this.observable$=this.eventBulks$.pipe(Ir(M=>ih(M))),this.storageToken=Sr,this.storageTokenDocument=Sr,this.emittedEventBulkIds=new ol(60*1e3),this.name=r,this.token=n,this.storage=o,this.instanceCreationOptions=a,this.password=c,this.multiInstance=u,this.eventReduce=d,this.options=p,this.internalStore=m,this.hashFunction=v,this.cleanupPolicy=w,this.allowSlowCount=_,this.reactivity=E,this.onClosed=D,this.name!=="pseudoInstance"&&(this.internalStore=Yu(this.asRxDatabase,m,nl),this.storageTokenDocument=$w(this.asRxDatabase).catch(M=>this.startupErrors.push(M)),this.storageToken=this.storageTokenDocument.then(M=>M.data.token).catch(M=>this.startupErrors.push(M)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw X("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,o){var a=await Qi(this.internalStore,Lo(gu(n,o),Sn));if(!a)throw X("SNH",{name:n,schema:o});var c=Gi(a);c._deleted=!0,await this.internalStore.bulkWrite([{document:c,previous:a}],"rx-database-remove-collection")},t.addCollections=async function(n){var o={},a={},c=[],u={};await Promise.all(Object.entries(n).map(async([m,v])=>{var w=m,_=v.schema;o[w]=_;var E=sv(_,this.hashFunction);if(a[w]=E,this.collections[m])throw X("DB3",{name:m});var D=gu(m,_),M={id:Lo(D,Sn),key:D,context:Sn,data:{name:w,schemaHash:await E.hash,schema:E.jsonSchema,version:E.version,connectedStorages:[]},_deleted:!1,_meta:Ao(),_rev:Ht(),_attachments:{}};c.push({document:M});var B=Object.assign({},v,{name:w,schema:E,database:this}),q=Ne(v);q.database=this,q.name=m,pt("preCreateRxCollection",q),B.conflictHandler=q.conflictHandler,u[w]=B}));var d=await this.internalStore.bulkWrite(c,"rx-database-add-collection");await e0(this),await Promise.all(d.error.map(async m=>{if(m.status!==409)throw X("DB12",{database:this.name,writeError:m});var v=de(m.documentInDb),w=v.data.name,_=a[w];if(v.data.schemaHash!==await _.hash)throw X("DB6",{database:this.name,collection:w,previousSchemaHash:v.data.schemaHash,schemaHash:await _.hash,previousSchema:v.data.schema,schema:de(o[w])})}));var p={};return await Promise.all(Object.keys(n).map(async m=>{var v=u[m],w=await Vw(v);p[m]=w,this.collections[m]=w,this[m]||Object.defineProperty(this,m,{get:()=>this.collections[m]})})),p},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw xe("json-dump")},t.addState=function(n){throw xe("state")},t.importJSON=function(n){throw xe("json-dump")},t.backup=function(n){throw xe("backup")},t.leaderElector=function(){throw xe("leader-election")},t.isLeader=function(){throw xe("leader-election")},t.waitForLeadership=function(){throw xe("leader-election")},t.migrationStates=function(){throw xe("migration-schema")},t.close=function(){if(this.closePromise)return this.closePromise;var{promise:n,resolve:o}=fp(),a=c=>{this.onClosed&&this.onClosed(),this.closed=!0,o(c)};return this.closePromise=n,(async()=>{if(await Fi("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(c=>c.unsubscribe()),this.name==="pseudoInstance"){a(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(c=>c()))).then(()=>Promise.all(Object.keys(this.collections).map(c=>this.collections[c]).map(c=>c.close()))).then(()=>this.internalStore.close()).then(()=>a(!0))})(),n},t.remove=function(){return this.close().then(()=>Xw(this.name,this.storage,this.multiInstance,this.password))},Yr(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])}();function Yw(e,t){if(yu.has(hp(e,t)))throw X("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function fp(){var e,t,r=new Promise((n,o)=>{e=n,t=o});return{promise:r,resolve:e,reject:t}}function hp(e,t){return t.name+"|"+e}async function pp(e,t,r,n,o,a){var c=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:db,schema:nl,options:n,multiInstance:o,password:a,devMode:Se.isDevMode()});return c}function Jw({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:o=!0,eventReduce:a=!0,ignoreDuplicate:c=!1,options:u={},cleanupPolicy:d,closeDuplicates:p=!1,allowSlowCount:m=!1,localDocuments:v=!1,hashFunction:w=xf,reactivity:_}){pt("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:o,eventReduce:a,ignoreDuplicate:c,options:u,localDocuments:v});var E=hp(r,e),D=Od.get(E)||new Set,M=fp(),B=Array.from(D),q=()=>{D.delete(M.promise),yu.delete(E)};return D.add(M.promise),Od.set(E,D),(async()=>{if(p&&await Promise.all(B.map(Z=>Z.catch(()=>null).then(ne=>ne&&ne.close()))),c){if(!Se.isDevMode())throw X("DB9",{database:r})}else Yw(r,e);yu.add(E);var G=Bi(10),ae=await pp(G,e,r,t,o,n),ie=new il(r,G,e,t,n,o,a,u,ae,w,d,m,_,q);return await Fi("createRxDatabase",{database:ie,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:o,eventReduce:a,ignoreDuplicate:c,options:u,localDocuments:v}}),ie})().then(G=>{M.resolve(G)}).catch(G=>{M.reject(G),q()}),M.promise}async function Xw(e,t,r=!0,n){var o=Bi(10),a=await pp(o,t,e,{},r,n),c=await op(a),u=new Set;c.forEach(p=>u.add(p.data.name));var d=Array.from(u);return await Promise.all(d.map(p=>ap(t,a,o,e,p,r,n))),await Fi("postRemoveRxDatabase",{databaseName:e,storage:t}),await a.remove(),d}function Zw(e){return e instanceof il}async function e0(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var t0={RxSchema:Bf.prototype,RxDocument:$s,RxQuery:rp.prototype,RxCollection:up.prototype,RxDatabase:il.prototype},qc=new Set,Pd=new Set;function Na(e){if(pt("preAddRxPlugin",{plugin:e,plugins:qc}),!qc.has(e)){{if(Pd.has(e.name))throw X("PL3",{name:e.name,plugin:e});qc.add(e),Pd.add(e.name)}if(!e.rxdb)throw Pt("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(t0[t])),e.overwritable&&Object.assign(Se,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&Si[t].push(r.after),r.before&&Si[t].unshift(r.before)})}}async function rs(e,t){var r=$n(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),o=n[0];if(e.lastCheckpointDoc[t]=o,o)return o.checkpointData}async function ns(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var o={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:Ao(),_rev:Ht()};for(o.id=$n(e.input.metaInstance.schema,o);!e.events.canceled.getValue();){if(n&&(o.checkpointData=Li([n.checkpointData,o.checkpointData])),o._meta.lwt=Et(),o._rev=_r(await e.checkpointKey,n),e.events.canceled.getValue())return;var a=[{previous:n,document:o}],c=await e.input.metaInstance.bulkWrite(a,"replication-set-checkpoint"),u=qt(e.primaryPath,a,c)[0];if(u){e.lastCheckpointDoc[t]=u;return}else{var d=c.error[0];if(d.status!==409)throw d;n=de(d.documentInDb),o._rev=_r(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function r0(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function Rd(e,t,r,n,o){var a=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},o?o._meta:{},{lwt:Et()}),_rev:r?n._rev:Ht()});return a._rev||(a._rev=_r(e,o)),a}function Nr(e,t,r){var n=Ne(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function bu(e,t){return e.hasAttachments?t.map(r=>{var n=dt(r.document);return n.docData=tr(n.docData),{document:n,previous:r.previous}}):t}function wu(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Ba="RxReplicationProtocolMetaData";function Ld(e,t){var r=ev(e),n={title:Ba,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var o=Ds(n);return o}function mp(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=$n(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(o=>{n[o.itemId]={docData:o.docData,metaDocument:o}}),n})}async function os(e,t,r,n){var o=t[e.primaryPath],a=r?Gi(r):{id:"",isCheckpoint:"0",itemId:o,docData:t,_attachments:{},_deleted:!1,_rev:Ht(),_meta:{lwt:0}};a.docData=t,n&&(a.isResolvedConflict=n),a._meta.lwt=Et(),a.id=$n(e.input.metaInstance.schema,a),a._rev=_r(await e.checkpointKey,r);var c={previous:r,document:a};return c}async function n0(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await rs(e,"down");t||await ns(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,o=0,a=[];function c(E){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var D={time:o++,task:E};a.push(D),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var M=[];a.length>0;){e.events.active.down.next(!0);var B=de(a.shift());if(!(B.time<d)){if(B.task==="RESYNC")if(M.length===0){M.push(B.task);break}else break;M.push(B.task)}}if(M.length!==0)return M[0]==="RESYNC"?p():m(M)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(c("RESYNC"),!e.events.canceled.getValue()){var u=n.masterChangeStream$.pipe(Ir(async E=>(await _n(e.events.active.up.pipe(ke(D=>!D))),E))).subscribe(E=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,c(E)});_n(e.events.canceled.pipe(ke(E=>!!E))).then(()=>u.unsubscribe())}var d=-1;async function p(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>rs(e,"down"));for(var E=await e.checkpointQueue,D=[];!e.events.canceled.getValue();){d=o++;var M=await n.masterChangesSince(E,e.input.pullBatchSize);if(M.documents.length===0||(E=Li([E,M.checkpoint]),D.push(_(M.documents,E)),M.documents.length<e.input.pullBatchSize))break}await Promise.all(D)}}function m(E){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var D=[],M=null;return E.forEach(B=>{if(B==="RESYNC")throw new Error("SNH");Dn(D,B.documents),M=Li([M,B.checkpoint])}),_(D,de(M))}var v=$t,w={docs:{}};function _(E,D){var M=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,E.forEach(B=>{var q=B[M];w.docs[q]=B}),w.checkpoint=D,v=v.then(()=>{var B=w.docs;w.docs={};var q=w.checkpoint,G=Object.keys(B);if(e.events.canceled.getValue()||G.length===0)return $t;var ae=[],ie={},Z={},ne=[];return Promise.all([e.input.forkInstance.findDocumentsById(G,!0),mp(e,G)]).then(([pe,ye])=>{var Ie=new Map;return pe.forEach(Re=>Ie.set(Re[M],Re)),Promise.all(G.map(async Re=>{var J=Ie.get(Re),be=J?Nr(J,e.hasAttachments,!1):void 0,Ce=B[Re],De=ye[Re];De&&J&&De.metaDocument.isResolvedConflict===J._rev&&await e.streamQueue.up;var nt=!De||!be?!1:e.input.conflictHandler.isEqual(De.docData,be,"downstream-check-if-equal-0");if(!nt&&De&&De.docData._rev&&J&&J._meta[e.input.identifier]&&Qr(J._rev)===J._meta[e.input.identifier]&&(nt=!0),J&&De&&nt===!1||J&&!De)return $t;var or=be?e.input.conflictHandler.isEqual(Ce,be,"downstream-check-if-equal-1"):!1;if(be&&or)return(!De||nt===!1)&&ne.push(await os(e,be,De?De.metaDocument:void 0)),$t;var Be=Object.assign({},Ce,J?{_meta:Ne(J._meta),_attachments:e.hasAttachments&&Ce._attachments?Ce._attachments:{},_rev:Ht()}:{_meta:{lwt:Et()},_rev:Ht(),_attachments:e.hasAttachments&&Ce._attachments?Ce._attachments:{}});if(Ce._rev){var ct=J?Qr(J._rev)+1:1;Be._meta[e.input.identifier]=ct,e.input.keepMeta&&(Be._rev=Ce._rev)}e.input.keepMeta&&Ce._meta&&(Be._meta=Ce._meta);var se={previous:J,document:Be};se.document._rev=se.document._rev?se.document._rev:_r(r,se.previous),ae.push(se),ie[Re]=se,Z[Re]=await os(e,Ce,De?De.metaDocument:void 0)}))}).then(async()=>{if(ae.length>0)return e.input.forkInstance.bulkWrite(ae,await e.downstreamBulkWriteFlag).then(pe=>{var ye=qt(e.primaryPath,ae,pe);ye.forEach(Re=>{var J=Re[M];e.events.processed.down.next(ie[J]),ne.push(Z[J])});var Ie;if(pe.error.forEach(Re=>{if(Re.status!==409){var J=X("RC_PULL",{writeError:Re});e.events.error.next(J),Ie=J}}),Ie)throw Ie})}).then(()=>{if(ne.length>0)return e.input.metaInstance.bulkWrite(bu(e,ne),"replication-down-write-meta").then(pe=>{pe.error.forEach(ye=>{e.events.error.next(X("RC_PULL",{id:ye.documentId,writeError:ye}))})})}).then(()=>{ns(e,"down",q)})}).catch(B=>e.events.error.next(B)),v}}async function o0(e,t,r){var n=e.input.conflictHandler,o=n.isEqual(t.realMasterState,t.newDocumentState,"replication-resolve-conflict");if(!o){var a=await n.resolve(t,"replication-resolve-conflict"),c=Object.assign({},a,{_meta:Ne(r._meta),_rev:Ht(),_attachments:Ne(r._attachments)});return c._meta.lwt=Et(),c._rev=_r(await e.checkpointKey,r),c}}async function _u(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var o=r[e],a=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([c,u])=>{if((!a.has(c)||n&&de(n._attachments)[c].digest!==u.digest)&&!u.data){var d=await t.getAttachmentData(o,c,u.digest);u.data=d}})),r}async function i0(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await rs(e,"up");t||await ns(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>m().then(()=>v()));var n=0,o=-1,a=[],c=Sr,u={docs:{}},d=e.input.forkInstance.changeStream().subscribe(_=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,a.push({task:_,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>v()):v()}),p=r.masterChangeStream$.pipe(ke(_=>_==="RESYNC")).subscribe(()=>{a.push({task:"RESYNC",time:n++}),v()});_n(e.events.canceled.pipe(ke(_=>!!_))).then(()=>{d.unsubscribe(),p.unsubscribe()});async function m(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>rs(e,"up"));for(var _=await e.checkpointQueue,E=new Set,D=async function(){o=n++,E.size>3&&await Promise.race(Array.from(E));var q=await zh(e.input.forkInstance,e.input.pushBatchSize,_);if(q.documents.length===0)return 1;_=Li([_,q.checkpoint]);var G=w(q.documents,de(_));E.add(G),G.catch().then(()=>E.delete(G))};!e.events.canceled.getValue()&&!await D(););var M=await Promise.all(E),B=M.find(q=>!!q);B?await m():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function v(){if(e.events.canceled.getValue()||a.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var _=[],E={};a.length>0;){var D=de(a.shift());if(!(D.time<o)){if(D.task==="RESYNC"){e.events.active.up.next(!1),await m();return}D.task.context!==await e.downstreamBulkWriteFlag&&Dn(_,D.task.events.map(M=>M.documentData)),E=Li([E,D.task.checkpoint])}}if(await w(_,E),a.length===0)e.events.active.up.next(!1);else return v()})}function w(_,E){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,_.forEach(D=>{var M=D[e.primaryPath];u.docs[M]=D}),u.checkpoint=E,c=c.then(async()=>{if(e.events.canceled.getValue())return!1;var D=u.docs;u.docs={};var M=u.checkpoint,B=Object.keys(D);function q(){return ns(e,"up",M)}if(B.length===0)return q(),!1;var G=await mp(e,B),ae={},ie=[],Z={},ne={};if(await Promise.all(B.map(async se=>{var Me=D[se];ne[se]=Me;var Ze=Nr(Me,e.hasAttachments,!!e.input.keepMeta),ge=G[se];ge&&ge.metaDocument.isResolvedConflict!==Me._rev&&e.input.conflictHandler.isEqual(ge.docData,Ze,"upstream-check-if-equal")||ge&&ge.docData._rev&&Qr(Me._rev)===Me._meta[e.input.identifier]||(ie.push(se),ae[se]={assumedMasterState:ge?ge.docData:void 0,newDocumentState:Ze},Z[se]=await os(e,Ze,ge?ge.metaDocument:void 0))})),ie.length===0)return q(),!1;var pe=Object.values(ae),ye=new Set,Ie={},Re=Og(pe,e.input.pushBatchSize);await Promise.all(Re.map(async se=>{e.hasAttachments&&await Promise.all(se.map(async Ze=>{Ze.newDocumentState=await _u(e.primaryPath,e.input.forkInstance,dt(Ze.newDocumentState),Ze.assumedMasterState)}));var Me=await r.masterWrite(se);Me.forEach(Ze=>{var ge=Ze[e.primaryPath];ye.add(ge),Ie[ge]=Ze})}));var J=[];if(ie.forEach(se=>{ye.has(se)||(e.events.processed.up.next(ae[se]),J.push(Z[se]))}),e.events.canceled.getValue())return!1;J.length>0&&await e.input.metaInstance.bulkWrite(bu(e,J),"replication-up-write-meta");var be=!1;if(ye.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var Ce=[],De={};if(await Promise.all(Object.entries(Ie).map(([se,Me])=>{var Ze=ae[se],ge={newDocumentState:Ze.newDocumentState,assumedMasterState:Ze.assumedMasterState,realMasterState:Me};return o0(e,ge,ne[se]).then(async Ve=>{if(Ve){e.events.resolvedConflicts.next({input:ge,output:Ve}),Ce.push({previous:ne[se],document:Ve});var kt=G[se];De[se]=await os(e,de(Me),kt?kt.metaDocument:void 0,Ve._rev)}})})),Ce.length>0){be=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var nt=await e.input.forkInstance.bulkWrite(Ce,"replication-up-write-conflict"),or;if(nt.error.forEach(se=>{if(se.status!==409){var Me=X("RC_PUSH",{writeError:se});e.events.error.next(Me),or=Me}}),or)throw or;var Be=[],ct=qt(e.primaryPath,Ce,nt);ct.forEach(se=>{var Me=se[e.primaryPath];Be.push(De[Me])}),Be.length>0&&await e.input.metaInstance.bulkWrite(bu(e,Be),"replication-up-write-conflict-meta")}}return q(),be}).catch(D=>(e.events.error.next(D),!1)),c}}function a0(e){e=Ne(e),e.forkInstance=wu(e.forkInstance),e.metaInstance=wu(e.metaInstance);var t=r0(e),r={primaryPath:It(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new Tr(!1),paused:new Tr(!1),active:{down:new Tr(!0),up:new Tr(!0)},processed:{down:new Mt,up:new Mt},resolvedConflicts:new Mt,error:new Mt},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new Tr(!1),up:new Tr(!1)},streamQueue:{down:$t,up:$t},checkpointQueue:$t,lastCheckpointDoc:{}};return n0(r),i0(r),r}function s0(e){return _n(Wv([e.firstSyncDone.down.pipe(ke(t=>!!t)),e.firstSyncDone.up.pipe(ke(t=>!!t))])).then(()=>{})}function c0(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function u0(e,t,r,n=!1){e=wu(e);var o=!!e.schema.attachments,a=It(e.schema.primaryKey),c={masterChangeStream$:e.changeStream().pipe(Ir(async u=>{var d={checkpoint:u.checkpoint,documents:await Promise.all(u.events.map(async p=>{var m=Nr(p.documentData,o,n);return o&&(m=await _u(a,e,dt(m),void 0)),m}))};return d})),masterChangesSince(u,d){return zh(e,d,u).then(async p=>({checkpoint:p.documents.length>0?p.checkpoint:u,documents:await Promise.all(p.documents.map(async m=>{var v=Nr(m,o,n);return o&&(v=await _u(a,e,dt(v),void 0)),v}))}))},async masterWrite(u){var d={};u.forEach(D=>{var M=D.newDocumentState[a];d[M]=D});var p=Object.keys(d),m=await e.findDocumentsById(p,!0),v=new Map;m.forEach(D=>v.set(D[a],D));var w=[],_=[];if(await Promise.all(Object.entries(d).map(([D,M])=>{var B=v.get(D);B?B&&!M.assumedMasterState?w.push(Nr(B,o,n)):t.isEqual(Nr(B,o,n),de(M.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?_.push({previous:B,document:Rd(r,o,n,M.newDocumentState,B)}):w.push(Nr(B,o,n)):_.push({document:Rd(r,o,n,M.newDocumentState)})})),_.length>0){var E=await e.bulkWrite(_,"replication-master-write");E.error.forEach(D=>{if(D.status!==409)throw X("SNH",{name:"non conflict error",error:D});w.push(Nr(de(D.documentInDb),o,n))})}return w}};return c}async function l0(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}function d0(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var f0=Promise.resolve(!0),vr=Promise.resolve();function hn(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function h0(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function Yi(){return Math.random().toString(36).substring(2)}var Fc=0;function Ji(){var e=Date.now()*1e3;return e<=Fc&&(e=Fc+1),Fc=e,e}function p0(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var m0=Ji,g0="native";function v0(e){var t={time:Ji(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function y0(e){e.bc.close(),e.subFns=[]}function b0(e,t){try{return e.bc.postMessage(t,!1),vr}catch(r){return Promise.reject(r)}}function w0(e,t){e.messagesCallback=t}function _0(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function S0(){return 150}var E0={create:v0,close:y0,onMessage:w0,postMessage:b0,canBeUsed:_0,type:g0,averageResponseTime:S0,microSeconds:m0};function al(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var I0=Ji,C0="pubkey.broadcast-channel-0-",Cr="messages",Ms={durability:"relaxed"},x0="idb";function gp(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function sl(e){e.commit&&e.commit()}function k0(e){var t=gp(),r=C0+e,n=t.open(r);return n.onupgradeneeded=function(o){var a=o.target.result;a.createObjectStore(Cr,{keyPath:"id",autoIncrement:!0})},new Promise(function(o,a){n.onerror=function(c){return a(c)},n.onsuccess=function(){o(n.result)}})}function D0(e,t,r){var n=Date.now(),o={uuid:t,time:n,data:r},a=e.transaction([Cr],"readwrite",Ms);return new Promise(function(c,u){a.oncomplete=function(){return c()},a.onerror=function(p){return u(p)};var d=a.objectStore(Cr);d.add(o),sl(a)})}function O0(e,t){var r=e.transaction(Cr,"readonly",Ms),n=r.objectStore(Cr),o=[],a=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var c=n.getAll(a);return new Promise(function(d,p){c.onerror=function(m){return p(m)},c.onsuccess=function(m){d(m.target.result)}})}function u(){try{return a=IDBKeyRange.bound(t+1,1/0),n.openCursor(a)}catch{return n.openCursor()}}return new Promise(function(d,p){var m=u();m.onerror=function(v){return p(v)},m.onsuccess=function(v){var w=v.target.result;w?w.value.id<t+1?w.continue(t+1):(o.push(w.value),w.continue()):(sl(r),d(o))}})}function P0(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(Cr,"readwrite",Ms),n=r.objectStore(Cr);return Promise.all(t.map(function(o){var a=n.delete(o);return new Promise(function(c){a.onsuccess=function(){return c()}})}))}function R0(e,t){var r=Date.now()-t,n=e.transaction(Cr,"readonly",Ms),o=n.objectStore(Cr),a=[];return new Promise(function(c){o.openCursor().onsuccess=function(u){var d=u.target.result;if(d){var p=d.value;p.time<r?(a.push(p),d.continue()):(sl(n),c(a))}else c(a)}})}function L0(e){return R0(e.db,e.options.idb.ttl).then(function(t){return P0(e,t.map(function(r){return r.id}))})}function $0(e,t){return t=al(t),k0(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:Yi(),eMIs:new ol(t.idb.ttl*2),writeBlockPromise:vr,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},vp(n),n})}function vp(e){e.closed||yp(e).then(function(){return hn(e.options.idb.fallbackInterval)}).then(function(){return vp(e)})}function M0(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function yp(e){return e.closed||!e.messagesCallback?vr:O0(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return M0(n,e)}).sort(function(n,o){return n.time-o.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),vr})}function A0(e){e.closed=!0,e.db.close()}function T0(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return D0(e.db,e.uuid,t)}).then(function(){h0(0,10)===0&&L0(e)}),e.writeBlockPromise}function N0(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,yp(e)}function B0(){return!!gp()}function q0(e){return e.idb.fallbackInterval*2}var F0={create:$0,close:A0,onMessage:N0,postMessage:T0,canBeUsed:B0,type:x0,averageResponseTime:q0,microSeconds:I0},j0=Ji,U0="pubkey.broadcastChannel-",K0="localstorage";function bp(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function wp(e){return U0+e}function H0(e,t){return new Promise(function(r){hn().then(function(){var n=wp(e.channelName),o={token:Yi(),time:Date.now(),data:t,uuid:e.uuid},a=JSON.stringify(o);bp().setItem(n,a);var c=document.createEvent("Event");c.initEvent("storage",!0,!0),c.key=n,c.newValue=a,window.dispatchEvent(c),r()})})}function z0(e,t){var r=wp(e),n=function(a){a.key===r&&t(JSON.parse(a.newValue))};return window.addEventListener("storage",n),n}function W0(e){window.removeEventListener("storage",e)}function V0(e,t){if(t=al(t),!_p())throw new Error("BroadcastChannel: localstorage cannot be used");var r=Yi(),n=new ol(t.localstorage.removeTimeout),o={channelName:e,uuid:r,eMIs:n};return o.listener=z0(e,function(a){o.messagesCallback&&a.uuid!==r&&(!a.token||n.has(a.token)||a.data.time&&a.data.time<o.messagesCallbackTime||(n.add(a.token),o.messagesCallback(a.data)))}),o}function Q0(e){W0(e.listener)}function G0(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function _p(){var e=bp();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function Y0(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var J0={create:V0,close:Q0,onMessage:G0,postMessage:H0,canBeUsed:_p,type:K0,averageResponseTime:Y0,microSeconds:j0},Sp=Ji,X0="simulate",cl=new Set;function Z0(e){var t={time:Sp(),name:e,messagesCallback:null};return cl.add(t),t}function e_(e){cl.delete(e)}var Ep=5;function t_(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(cl);n.forEach(function(o){o.name===e.name&&o!==e&&o.messagesCallback&&o.time<t.time&&o.messagesCallback(t)}),r()},Ep)})}function r_(e,t){e.messagesCallback=t}function n_(){return!0}function o_(){return Ep}var i_={create:Z0,close:e_,onMessage:r_,postMessage:t_,canBeUsed:n_,type:X0,averageResponseTime:o_,microSeconds:Sp},$d=[E0,F0,J0];function a_(e){var t=[].concat(e.methods,$d).filter(Boolean);if(e.type){if(e.type==="simulate")return i_;var r=t.find(function(o){return o.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(o){return o.type!=="idb"}));var n=t.find(function(o){return o.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify($d.map(function(o){return o.type})))}var Ip=new Set,s_=0,As=function(t,r){this.id=s_++,Ip.add(this),this.name=t,this.options=al(r),this.method=a_(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,c_(this)};As._pubkey=!0;As.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return Md(this,"message",t)},postInternal:function(t){return Md(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};Td(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,Ad(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),o={time:n,fn:r};Ad(this,t,o)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(o){return o.fn===r});Td(this,t,n)},close:function(){var t=this;if(!this.closed){Ip.delete(this),this.closed=!0;var r=this._prepP?this._prepP:vr;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function Md(e,t,r){var n=e.method.microSeconds(),o={time:n,type:t,data:r},a=e._prepP?e._prepP:vr;return a.then(function(){var c=e.method.postMessage(e._state,o);return e._uMP.add(c),c.catch().then(function(){return e._uMP.delete(c)}),c})}function c_(e){var t=e.method.create(e.name,e.options);d0(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function Cp(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function Ad(e,t,r){e._addEL[t].push(r),u_(e)}function Td(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),l_(e)}function u_(e){if(!e._iL&&Cp(e)){var t=function(o){e._addEL[o.type].forEach(function(a){o.time>=a.time&&a.fn(o.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function l_(e){if(e._iL&&!Cp(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function d_(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function f_(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var h_=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",p_=h_?f_:d_,ci=new Set,Nd=!1;function m_(){Nd||(Nd=!0,p_(v_))}function g_(e){if(m_(),typeof e!="function")throw new Error("Listener is no function");ci.add(e);var t={remove:function(){return ci.delete(e)},run:function(){return ci.delete(e),e()}};return t}function v_(){var e=[];return ci.forEach(function(t){e.push(t()),ci.delete(t)}),Promise.all(e)}function En(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function xp(e){e.isLeader=!0,e._hasLeader=!0;var t=g_(function(){return e.die()});e._unl.push(t);var r=function(o){o.context==="leader"&&o.action==="apply"&&En(e,"tell"),o.context==="leader"&&o.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),En(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),En(e,"tell")}var kp=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=Yi(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};kp.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(o){return o.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,o){t._wKMC.res=n,t._wKMC.rej=o});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,xp(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),En(this,"death")}};var Dp=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=Yi(),this._aplQ=vr,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var o=function(c){c.context==="leader"&&(c.action==="death"&&(n._hasLeader=!1),c.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",o),this._lstns.push(o)};Dp.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return hn(0,!0);if(this.isDead)return hn(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return f0;var a=!1,c,u=new Promise(function(m){c=function(){a=!0,m()}}),d=function(v){v.context==="leader"&&v.token!=r.token&&(v.action==="apply"&&v.token>r.token&&c(),v.action==="tell"&&(c(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",d);var p=t?r._options.responseTime*4:r._options.responseTime;return En(r,"apply").then(function(){return Promise.race([hn(p),u.then(function(){return Promise.reject(new Error)})])}).then(function(){return En(r,"apply")}).then(function(){return Promise.race([hn(p),u.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",d),a?!1:xp(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=y_(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,En(this,"death")}};function y_(e){return e.isLeader?vr:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",a),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var o=function(){return hn(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():o()})})};o();var a=function(u){u.context==="leader"&&u.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",a),e._lstns.push(a)})}function b_(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function w_(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=b_(t,e);var r=p0()?new kp(e,t):new Dp(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var is=new Map;function __(e,t,r,n){var o=is.get(t);return o||(o={bc:new As(["RxDB:",e,r].join("|")),refs:new Set},is.set(t,o)),o.refs.add(n),o.bc}function Bd(e,t){var r=is.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return is.delete(e),r.bc.close()}function S_(e,t,r,n){if(t.multiInstance){var o=__(e,t.databaseInstanceToken,r.databaseName,r),a=new Mt,c=w=>{w.storageName===e&&w.databaseName===t.databaseName&&w.collectionName===t.collectionName&&w.version===t.schema.version&&a.next(w.eventBulk)};o.addEventListener("message",c);var u=r.changeStream(),d=!1,p=u.subscribe(w=>{d||o.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:w})});r.changeStream=function(){return a.asObservable().pipe(ty(u))};var m=r.close.bind(r);r.close=async function(){return d=!0,p.unsubscribe(),o.removeEventListener("message",c),await Bd(t.databaseInstanceToken,r),m()};var v=r.remove.bind(r);r.remove=async function(){return d=!0,p.unsubscribe(),o.removeEventListener("message",c),await Bd(t.databaseInstanceToken,r),v()}}}var E_=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function I_(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var qa={exports:{}},C_=qa.exports,qd;function x_(){return qd||(qd=1,function(e,t){(function(r,n){e.exports=n()})(C_,function(){var r=function(i,s){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,f){l.__proto__=f}||function(l,f){for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(l[h]=f[h])})(i,s)},n=function(){return(n=Object.assign||function(i){for(var s,l=1,f=arguments.length;l<f;l++)for(var h in s=arguments[l])Object.prototype.hasOwnProperty.call(s,h)&&(i[h]=s[h]);return i}).apply(this,arguments)};function o(i,s,l){for(var f,h=0,g=s.length;h<g;h++)!f&&h in s||((f=f||Array.prototype.slice.call(s,0,h))[h]=s[h]);return i.concat(f||Array.prototype.slice.call(s))}var a=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:E_,c=Object.keys,u=Array.isArray;function d(i,s){return typeof s!="object"||c(s).forEach(function(l){i[l]=s[l]}),i}typeof Promise>"u"||a.Promise||(a.Promise=Promise);var p=Object.getPrototypeOf,m={}.hasOwnProperty;function v(i,s){return m.call(i,s)}function w(i,s){typeof s=="function"&&(s=s(p(i))),(typeof Reflect>"u"?c:Reflect.ownKeys)(s).forEach(function(l){E(i,l,s[l])})}var _=Object.defineProperty;function E(i,s,l,f){_(i,s,d(l&&v(l,"get")&&typeof l.get=="function"?{get:l.get,set:l.set,configurable:!0}:{value:l,configurable:!0,writable:!0},f))}function D(i){return{from:function(s){return i.prototype=Object.create(s.prototype),E(i.prototype,"constructor",i),{extend:w.bind(null,i.prototype)}}}}var M=Object.getOwnPropertyDescriptor,B=[].slice;function q(i,s,l){return B.call(i,s,l)}function G(i,s){return s(i)}function ae(i){if(!i)throw new Error("Assertion Failed")}function ie(i){a.setImmediate?setImmediate(i):setTimeout(i,0)}function Z(i,s){if(typeof s=="string"&&v(i,s))return i[s];if(!s)return i;if(typeof s!="string"){for(var l=[],f=0,h=s.length;f<h;++f){var g=Z(i,s[f]);l.push(g)}return l}var y=s.indexOf(".");if(y!==-1){var b=i[s.substr(0,y)];return b==null?void 0:Z(b,s.substr(y+1))}}function ne(i,s,l){if(i&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(i)))if(typeof s!="string"&&"length"in s){ae(typeof l!="string"&&"length"in l);for(var f=0,h=s.length;f<h;++f)ne(i,s[f],l[f])}else{var g,y,b=s.indexOf(".");b!==-1?(g=s.substr(0,b),(y=s.substr(b+1))===""?l===void 0?u(i)&&!isNaN(parseInt(g))?i.splice(g,1):delete i[g]:i[g]=l:ne(b=!(b=i[g])||!v(i,g)?i[g]={}:b,y,l)):l===void 0?u(i)&&!isNaN(parseInt(s))?i.splice(s,1):delete i[s]:i[s]=l}}function pe(i){var s,l={};for(s in i)v(i,s)&&(l[s]=i[s]);return l}var ye=[].concat;function Ie(i){return ye.apply([],i)}var ar="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ie([8,16,32,64].map(function(i){return["Int","Uint","Float"].map(function(s){return s+i+"Array"})}))).filter(function(i){return a[i]}),Re=new Set(ar.map(function(i){return a[i]})),J=null;function be(i){return J=new WeakMap,i=function s(l){if(!l||typeof l!="object")return l;var f=J.get(l);if(f)return f;if(u(l)){f=[],J.set(l,f);for(var h=0,g=l.length;h<g;++h)f.push(s(l[h]))}else if(Re.has(l.constructor))f=l;else{var y,b=p(l);for(y in f=b===Object.prototype?{}:Object.create(b),J.set(l,f),l)v(l,y)&&(f[y]=s(l[y]))}return f}(i),J=null,i}var Ce={}.toString;function De(i){return Ce.call(i).slice(8,-1)}var nt=typeof Symbol<"u"?Symbol.iterator:"@@iterator",or=typeof nt=="symbol"?function(i){var s;return i!=null&&(s=i[nt])&&s.apply(i)}:function(){return null};function Be(i,s){return s=i.indexOf(s),0<=s&&i.splice(s,1),0<=s}var ct={};function se(i){var s,l,f,h;if(arguments.length===1){if(u(i))return i.slice();if(this===ct&&typeof i=="string")return[i];if(h=or(i)){for(l=[];!(f=h.next()).done;)l.push(f.value);return l}if(i==null)return[i];if(typeof(s=i.length)!="number")return[i];for(l=new Array(s);s--;)l[s]=i[s];return l}for(s=arguments.length,l=new Array(s);s--;)l[s]=arguments[s];return l}var Me=typeof Symbol<"u"?function(i){return i[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Uo=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Dt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Uo),Ze={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ge(i,s){this.name=i,this.message=s}function Ve(i,s){return i+". Errors: "+Object.keys(s).map(function(l){return s[l].toString()}).filter(function(l,f,h){return h.indexOf(l)===f}).join(`
`)}function kt(i,s,l,f){this.failures=s,this.failedKeys=f,this.successCount=l,this.message=Ve(i,s)}function Dr(i,s){this.name="BulkError",this.failures=Object.keys(s).map(function(l){return s[l]}),this.failuresByPos=s,this.message=Ve(i,this.failures)}D(ge).from(Error).extend({toString:function(){return this.name+": "+this.message}}),D(kt).from(ge),D(Dr).from(ge);var js=Dt.reduce(function(i,s){return i[s]=s+"Error",i},{}),Jp=ge,oe=Dt.reduce(function(i,s){var l=s+"Error";function f(h,g){this.name=l,h?typeof h=="string"?(this.message="".concat(h).concat(g?`
 `+g:""),this.inner=g||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=Ze[s]||l,this.inner=null)}return D(f).from(Jp),i[s]=f,i},{});oe.Syntax=SyntaxError,oe.Type=TypeError,oe.Range=RangeError;var pl=Uo.reduce(function(i,s){return i[s+"Error"]=oe[s],i},{}),Xi=Dt.reduce(function(i,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(i[s+"Error"]=oe[s]),i},{});function _e(){}function Fo(i){return i}function Xp(i,s){return i==null||i===Fo?s:function(l){return s(i(l))}}function Zr(i,s){return function(){i.apply(this,arguments),s.apply(this,arguments)}}function Zp(i,s){return i===_e?s:function(){var l=i.apply(this,arguments);l!==void 0&&(arguments[0]=l);var f=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var g=s.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?Zr(f,this.onsuccess):f),h&&(this.onerror=this.onerror?Zr(h,this.onerror):h),g!==void 0?g:l}}function em(i,s){return i===_e?s:function(){i.apply(this,arguments);var l=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?Zr(l,this.onsuccess):l),f&&(this.onerror=this.onerror?Zr(f,this.onerror):f)}}function tm(i,s){return i===_e?s:function(l){var f=i.apply(this,arguments);d(l,f);var h=this.onsuccess,g=this.onerror;return this.onsuccess=null,this.onerror=null,l=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?Zr(h,this.onsuccess):h),g&&(this.onerror=this.onerror?Zr(g,this.onerror):g),f===void 0?l===void 0?void 0:l:d(f,l)}}function rm(i,s){return i===_e?s:function(){return s.apply(this,arguments)!==!1&&i.apply(this,arguments)}}function Us(i,s){return i===_e?s:function(){var l=i.apply(this,arguments);if(l&&typeof l.then=="function"){for(var f=this,h=arguments.length,g=new Array(h);h--;)g[h]=arguments[h];return l.then(function(){return s.apply(f,g)})}return s.apply(this,arguments)}}Xi.ModifyError=kt,Xi.DexieError=ge,Xi.BulkError=Dr;var Yt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ml(i){Yt=i}var jo={},gl=100,ar=typeof Promise>"u"?[]:function(){var i=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[i,p(i),i];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,p(s),i]}(),Uo=ar[0],Dt=ar[1],ar=ar[2],Dt=Dt&&Dt.then,en=Uo&&Uo.constructor,Ks=!!ar,Ko=function(i,s){Ho.push([i,s]),Zi&&(queueMicrotask(om),Zi=!1)},Hs=!0,Zi=!0,tn=[],ea=[],zs=Fo,Or={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:_e,pgp:!1,env:{},finalize:_e},te=Or,Ho=[],rn=0,ta=[];function Q(i){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=te;if(typeof i!="function"){if(i!==jo)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Vs(this,this._value))}this._state=null,this._value=null,++s.ref,function l(f,h){try{h(function(g){if(f._state===null){if(g===f)throw new TypeError("A promise cannot be resolved with itself.");var y=f._lib&&Tn();g&&typeof g.then=="function"?l(f,function(b,I){g instanceof Q?g._then(b,I):g.then(b,I)}):(f._state=!0,f._value=g,yl(f)),y&&Nn()}},Vs.bind(null,f))}catch(g){Vs(f,g)}}(this,i)}var Ws={get:function(){var i=te,s=ia;function l(f,h){var g=this,y=!i.global&&(i!==te||s!==ia),b=y&&!Rr(),I=new Q(function(x,P){Qs(g,new vl(wl(f,i,y,b),wl(h,i,y,b),x,P,i))});return this._consoleTask&&(I._consoleTask=this._consoleTask),I}return l.prototype=jo,l},set:function(i){E(this,"then",i&&i.prototype===jo?Ws:{get:function(){return i},set:Ws.set})}};function vl(i,s,l,f,h){this.onFulfilled=typeof i=="function"?i:null,this.onRejected=typeof s=="function"?s:null,this.resolve=l,this.reject=f,this.psd=h}function Vs(i,s){var l,f;ea.push(s),i._state===null&&(l=i._lib&&Tn(),s=zs(s),i._state=!1,i._value=s,f=i,tn.some(function(h){return h._value===f._value})||tn.push(f),yl(i),l&&Nn())}function yl(i){var s=i._listeners;i._listeners=[];for(var l=0,f=s.length;l<f;++l)Qs(i,s[l]);var h=i._PSD;--h.ref||h.finalize(),rn===0&&(++rn,Ko(function(){--rn==0&&Gs()},[]))}function Qs(i,s){if(i._state!==null){var l=i._state?s.onFulfilled:s.onRejected;if(l===null)return(i._state?s.resolve:s.reject)(i._value);++s.psd.ref,++rn,Ko(nm,[l,i,s])}else i._listeners.push(s)}function nm(i,s,l){try{var f,h=s._value;!s._state&&ea.length&&(ea=[]),f=Yt&&s._consoleTask?s._consoleTask.run(function(){return i(h)}):i(h),s._state||ea.indexOf(h)!==-1||function(g){for(var y=tn.length;y;)if(tn[--y]._value===g._value)return tn.splice(y,1)}(s),l.resolve(f)}catch(g){l.reject(g)}finally{--rn==0&&Gs(),--l.psd.ref||l.psd.finalize()}}function om(){nn(Or,function(){Tn()&&Nn()})}function Tn(){var i=Hs;return Zi=Hs=!1,i}function Nn(){var i,s,l;do for(;0<Ho.length;)for(i=Ho,Ho=[],l=i.length,s=0;s<l;++s){var f=i[s];f[0].apply(null,f[1])}while(0<Ho.length);Zi=Hs=!0}function Gs(){var i=tn;tn=[],i.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var s=ta.slice(0),l=s.length;l;)s[--l]()}function ra(i){return new Q(jo,!1,i)}function Ae(i,s){var l=te;return function(){var f=Tn(),h=te;try{return Lr(l,!0),i.apply(this,arguments)}catch(g){s&&s(g)}finally{Lr(h,!1),f&&Nn()}}}w(Q.prototype,{then:Ws,_then:function(i,s){Qs(this,new vl(null,null,i,s,te))},catch:function(i){if(arguments.length===1)return this.then(null,i);var s=i,l=arguments[1];return typeof s=="function"?this.then(null,function(f){return(f instanceof s?l:ra)(f)}):this.then(null,function(f){return(f&&f.name===s?l:ra)(f)})},finally:function(i){return this.then(function(s){return Q.resolve(i()).then(function(){return s})},function(s){return Q.resolve(i()).then(function(){return ra(s)})})},timeout:function(i,s){var l=this;return i<1/0?new Q(function(f,h){var g=setTimeout(function(){return h(new oe.Timeout(s))},i);l.then(f,h).finally(clearTimeout.bind(null,g))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&E(Q.prototype,Symbol.toStringTag,"Dexie.Promise"),Or.env=bl(),w(Q,{all:function(){var i=se.apply(null,arguments).map(aa);return new Q(function(s,l){i.length===0&&s([]);var f=i.length;i.forEach(function(h,g){return Q.resolve(h).then(function(y){i[g]=y,--f||s(i)},l)})})},resolve:function(i){return i instanceof Q?i:i&&typeof i.then=="function"?new Q(function(s,l){i.then(s,l)}):new Q(jo,!0,i)},reject:ra,race:function(){var i=se.apply(null,arguments).map(aa);return new Q(function(s,l){i.map(function(f){return Q.resolve(f).then(s,l)})})},PSD:{get:function(){return te},set:function(i){return te=i}},totalEchoes:{get:function(){return ia}},newPSD:Pr,usePSD:nn,scheduler:{get:function(){return Ko},set:function(i){Ko=i}},rejectionMapper:{get:function(){return zs},set:function(i){zs=i}},follow:function(i,s){return new Q(function(l,f){return Pr(function(h,g){var y=te;y.unhandleds=[],y.onunhandled=g,y.finalize=Zr(function(){var b,I=this;b=function(){I.unhandleds.length===0?h():g(I.unhandleds[0])},ta.push(function x(){b(),ta.splice(ta.indexOf(x),1)}),++rn,Ko(function(){--rn==0&&Gs()},[])},y.finalize),i()},s,l,f)})}}),en&&(en.allSettled&&E(Q,"allSettled",function(){var i=se.apply(null,arguments).map(aa);return new Q(function(s){i.length===0&&s([]);var l=i.length,f=new Array(l);i.forEach(function(h,g){return Q.resolve(h).then(function(y){return f[g]={status:"fulfilled",value:y}},function(y){return f[g]={status:"rejected",reason:y}}).then(function(){return--l||s(f)})})})}),en.any&&typeof AggregateError<"u"&&E(Q,"any",function(){var i=se.apply(null,arguments).map(aa);return new Q(function(s,l){i.length===0&&l(new AggregateError([]));var f=i.length,h=new Array(f);i.forEach(function(g,y){return Q.resolve(g).then(function(b){return s(b)},function(b){h[y]=b,--f||l(new AggregateError(h))})})})}),en.withResolvers&&(Q.withResolvers=en.withResolvers));var Ge={awaits:0,echoes:0,id:0},im=0,na=[],oa=0,ia=0,am=0;function Pr(i,s,l,f){var h=te,g=Object.create(h);return g.parent=h,g.ref=0,g.global=!1,g.id=++am,Or.env,g.env=Ks?{Promise:Q,PromiseProp:{value:Q,configurable:!0,writable:!0},all:Q.all,race:Q.race,allSettled:Q.allSettled,any:Q.any,resolve:Q.resolve,reject:Q.reject}:{},s&&d(g,s),++h.ref,g.finalize=function(){--this.parent.ref||this.parent.finalize()},f=nn(g,i,l,f),g.ref===0&&g.finalize(),f}function Bn(){return Ge.id||(Ge.id=++im),++Ge.awaits,Ge.echoes+=gl,Ge.id}function Rr(){return!!Ge.awaits&&(--Ge.awaits==0&&(Ge.id=0),Ge.echoes=Ge.awaits*gl,!0)}function aa(i){return Ge.echoes&&i&&i.constructor===en?(Bn(),i.then(function(s){return Rr(),s},function(s){return Rr(),qe(s)})):i}function sm(){var i=na[na.length-1];na.pop(),Lr(i,!1)}function Lr(i,s){var l,f=te;(s?!Ge.echoes||oa++&&i===te:!oa||--oa&&i===te)||queueMicrotask(s?(function(h){++ia,Ge.echoes&&--Ge.echoes!=0||(Ge.echoes=Ge.awaits=Ge.id=0),na.push(te),Lr(h,!0)}).bind(null,i):sm),i!==te&&(te=i,f===Or&&(Or.env=bl()),Ks&&(l=Or.env.Promise,s=i.env,(f.global||i.global)&&(Object.defineProperty(a,"Promise",s.PromiseProp),l.all=s.all,l.race=s.race,l.resolve=s.resolve,l.reject=s.reject,s.allSettled&&(l.allSettled=s.allSettled),s.any&&(l.any=s.any))))}function bl(){var i=a.Promise;return Ks?{Promise:i,PromiseProp:Object.getOwnPropertyDescriptor(a,"Promise"),all:i.all,race:i.race,allSettled:i.allSettled,any:i.any,resolve:i.resolve,reject:i.reject}:{}}function nn(i,s,l,f,h){var g=te;try{return Lr(i,!0),s(l,f,h)}finally{Lr(g,!1)}}function wl(i,s,l,f){return typeof i!="function"?i:function(){var h=te;l&&Bn(),Lr(s,!0);try{return i.apply(this,arguments)}finally{Lr(h,!1),f&&queueMicrotask(Rr)}}}function Ys(i){Promise===en&&Ge.echoes===0?oa===0?i():enqueueNativeMicroTask(i):setTimeout(i,0)}(""+Dt).indexOf("[native code]")===-1&&(Bn=Rr=_e);var qe=Q.reject,on="￿",ir="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",_l="String expected.",qn=[],sa="__dbnames",Js="readonly",Xs="readwrite";function an(i,s){return i?s?function(){return i.apply(this,arguments)&&s.apply(this,arguments)}:i:s}var Sl={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function ca(i){return typeof i!="string"||/\./.test(i)?function(s){return s}:function(s){return s[i]===void 0&&i in s&&delete(s=be(s))[i],s}}function El(){throw oe.Type()}function ve(i,s){try{var l=Il(i),f=Il(s);if(l!==f)return l==="Array"?1:f==="Array"?-1:l==="binary"?1:f==="binary"?-1:l==="string"?1:f==="string"?-1:l==="Date"?1:f!=="Date"?NaN:-1;switch(l){case"number":case"Date":case"string":return s<i?1:i<s?-1:0;case"binary":return function(h,g){for(var y=h.length,b=g.length,I=y<b?y:b,x=0;x<I;++x)if(h[x]!==g[x])return h[x]<g[x]?-1:1;return y===b?0:y<b?-1:1}(Cl(i),Cl(s));case"Array":return function(h,g){for(var y=h.length,b=g.length,I=y<b?y:b,x=0;x<I;++x){var P=ve(h[x],g[x]);if(P!==0)return P}return y===b?0:y<b?-1:1}(i,s)}}catch{}return NaN}function Il(i){var s=typeof i;return s!="object"?s:ArrayBuffer.isView(i)?"binary":(i=De(i),i==="ArrayBuffer"?"binary":i)}function Cl(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i)}var xl=(Le.prototype._trans=function(i,s,l){var f=this._tx||te.trans,h=this.name,g=Yt&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(i==="readonly"?"read":"write"," ").concat(this.name));function y(x,P,S){if(!S.schema[h])throw new oe.NotFound("Table "+h+" not part of transaction");return s(S.idbtrans,S)}var b=Tn();try{var I=f&&f.db._novip===this.db._novip?f===te.trans?f._promise(i,y,l):Pr(function(){return f._promise(i,y,l)},{trans:f,transless:te.transless||te}):function x(P,S,L,C){if(P.idbdb&&(P._state.openComplete||te.letThrough||P._vip)){var O=P._createTransaction(S,L,P._dbSchema);try{O.create(),P._state.PR1398_maxLoop=3}catch(R){return R.name===js.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return x(P,S,L,C)})):qe(R)}return O._promise(S,function(R,k){return Pr(function(){return te.trans=O,C(R,k,O)})}).then(function(R){if(S==="readwrite")try{O.idbtrans.commit()}catch{}return S==="readonly"?R:O._completion.then(function(){return R})})}if(P._state.openComplete)return qe(new oe.DatabaseClosed(P._state.dbOpenError));if(!P._state.isBeingOpened){if(!P._state.autoOpen)return qe(new oe.DatabaseClosed);P.open().catch(_e)}return P._state.dbReadyPromise.then(function(){return x(P,S,L,C)})}(this.db,i,[this.name],y);return g&&(I._consoleTask=g,I=I.catch(function(x){return console.trace(x),qe(x)})),I}finally{b&&Nn()}},Le.prototype.get=function(i,s){var l=this;return i&&i.constructor===Object?this.where(i).first(s):i==null?qe(new oe.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return l.core.get({trans:f,key:i}).then(function(h){return l.hook.reading.fire(h)})}).then(s)},Le.prototype.where=function(i){if(typeof i=="string")return new this.db.WhereClause(this,i);if(u(i))return new this.db.WhereClause(this,"[".concat(i.join("+"),"]"));var s=c(i);if(s.length===1)return this.where(s[0]).equals(i[s[0]]);var l=this.schema.indexes.concat(this.schema.primKey).filter(function(b){if(b.compound&&s.every(function(x){return 0<=b.keyPath.indexOf(x)})){for(var I=0;I<s.length;++I)if(s.indexOf(b.keyPath[I])===-1)return!1;return!0}return!1}).sort(function(b,I){return b.keyPath.length-I.keyPath.length})[0];if(l&&this.db._maxKey!==on){var g=l.keyPath.slice(0,s.length);return this.where(g).equals(g.map(function(I){return i[I]}))}!l&&Yt&&console.warn("The query ".concat(JSON.stringify(i)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var f=this.schema.idxByName;function h(b,I){return ve(b,I)===0}var y=s.reduce(function(S,I){var x=S[0],P=S[1],S=f[I],L=i[I];return[x||S,x||!S?an(P,S&&S.multi?function(C){return C=Z(C,I),u(C)&&C.some(function(O){return h(L,O)})}:function(C){return h(L,Z(C,I))}):P]},[null,null]),g=y[0],y=y[1];return g?this.where(g.name).equals(i[g.keyPath]).filter(y):l?this.filter(y):this.where(s).equals("")},Le.prototype.filter=function(i){return this.toCollection().and(i)},Le.prototype.count=function(i){return this.toCollection().count(i)},Le.prototype.offset=function(i){return this.toCollection().offset(i)},Le.prototype.limit=function(i){return this.toCollection().limit(i)},Le.prototype.each=function(i){return this.toCollection().each(i)},Le.prototype.toArray=function(i){return this.toCollection().toArray(i)},Le.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Le.prototype.orderBy=function(i){return new this.db.Collection(new this.db.WhereClause(this,u(i)?"[".concat(i.join("+"),"]"):i))},Le.prototype.reverse=function(){return this.toCollection().reverse()},Le.prototype.mapToClass=function(i){var s,l=this.db,f=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=i).prototype instanceof El&&(function(I,x){if(typeof x!="function"&&x!==null)throw new TypeError("Class extends value "+String(x)+" is not a constructor or null");function P(){this.constructor=I}r(I,x),I.prototype=x===null?Object.create(x):(P.prototype=x.prototype,new P)}(h,s=i),Object.defineProperty(h.prototype,"db",{get:function(){return l},enumerable:!1,configurable:!0}),h.prototype.table=function(){return f},i=h);for(var g=new Set,y=i.prototype;y;y=p(y))Object.getOwnPropertyNames(y).forEach(function(I){return g.add(I)});function b(I){if(!I)return I;var x,P=Object.create(i.prototype);for(x in I)if(!g.has(x))try{P[x]=I[x]}catch{}return P}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=b,this.hook("reading",b),i},Le.prototype.defineClass=function(){return this.mapToClass(function(i){d(this,i)})},Le.prototype.add=function(i,s){var l=this,f=this.schema.primKey,h=f.auto,g=f.keyPath,y=i;return g&&h&&(y=ca(g)(i)),this._trans("readwrite",function(b){return l.core.mutate({trans:b,type:"add",keys:s!=null?[s]:null,values:[y]})}).then(function(b){return b.numFailures?Q.reject(b.failures[0]):b.lastResult}).then(function(b){if(g)try{ne(i,g,b)}catch{}return b})},Le.prototype.update=function(i,s){return typeof i!="object"||u(i)?this.where(":id").equals(i).modify(s):(i=Z(i,this.schema.primKey.keyPath),i===void 0?qe(new oe.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(i).modify(s))},Le.prototype.put=function(i,s){var l=this,f=this.schema.primKey,h=f.auto,g=f.keyPath,y=i;return g&&h&&(y=ca(g)(i)),this._trans("readwrite",function(b){return l.core.mutate({trans:b,type:"put",values:[y],keys:s!=null?[s]:null})}).then(function(b){return b.numFailures?Q.reject(b.failures[0]):b.lastResult}).then(function(b){if(g)try{ne(i,g,b)}catch{}return b})},Le.prototype.delete=function(i){var s=this;return this._trans("readwrite",function(l){return s.core.mutate({trans:l,type:"delete",keys:[i]})}).then(function(l){return l.numFailures?Q.reject(l.failures[0]):void 0})},Le.prototype.clear=function(){var i=this;return this._trans("readwrite",function(s){return i.core.mutate({trans:s,type:"deleteRange",range:Sl})}).then(function(s){return s.numFailures?Q.reject(s.failures[0]):void 0})},Le.prototype.bulkGet=function(i){var s=this;return this._trans("readonly",function(l){return s.core.getMany({keys:i,trans:l}).then(function(f){return f.map(function(h){return s.hook.reading.fire(h)})})})},Le.prototype.bulkAdd=function(i,s,l){var f=this,h=Array.isArray(s)?s:void 0,g=(l=l||(h?void 0:s))?l.allKeys:void 0;return this._trans("readwrite",function(y){var x=f.schema.primKey,b=x.auto,x=x.keyPath;if(x&&h)throw new oe.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==i.length)throw new oe.InvalidArgument("Arguments objects and keys must have the same length");var I=i.length,x=x&&b?i.map(ca(x)):i;return f.core.mutate({trans:y,type:"add",keys:h,values:x,wantResults:g}).then(function(O){var S=O.numFailures,L=O.results,C=O.lastResult,O=O.failures;if(S===0)return g?L:C;throw new Dr("".concat(f.name,".bulkAdd(): ").concat(S," of ").concat(I," operations failed"),O)})})},Le.prototype.bulkPut=function(i,s,l){var f=this,h=Array.isArray(s)?s:void 0,g=(l=l||(h?void 0:s))?l.allKeys:void 0;return this._trans("readwrite",function(y){var x=f.schema.primKey,b=x.auto,x=x.keyPath;if(x&&h)throw new oe.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==i.length)throw new oe.InvalidArgument("Arguments objects and keys must have the same length");var I=i.length,x=x&&b?i.map(ca(x)):i;return f.core.mutate({trans:y,type:"put",keys:h,values:x,wantResults:g}).then(function(O){var S=O.numFailures,L=O.results,C=O.lastResult,O=O.failures;if(S===0)return g?L:C;throw new Dr("".concat(f.name,".bulkPut(): ").concat(S," of ").concat(I," operations failed"),O)})})},Le.prototype.bulkUpdate=function(i){var s=this,l=this.core,f=i.map(function(y){return y.key}),h=i.map(function(y){return y.changes}),g=[];return this._trans("readwrite",function(y){return l.getMany({trans:y,keys:f,cache:"clone"}).then(function(b){var I=[],x=[];i.forEach(function(S,L){var C=S.key,O=S.changes,R=b[L];if(R){for(var k=0,$=Object.keys(O);k<$.length;k++){var A=$[k],T=O[A];if(A===s.schema.primKey.keyPath){if(ve(T,C)!==0)throw new oe.Constraint("Cannot update primary key in bulkUpdate()")}else ne(R,A,T)}g.push(L),I.push(C),x.push(R)}});var P=I.length;return l.mutate({trans:y,type:"put",keys:I,values:x,updates:{keys:f,changeSpecs:h}}).then(function(S){var L=S.numFailures,C=S.failures;if(L===0)return P;for(var O=0,R=Object.keys(C);O<R.length;O++){var k,$=R[O],A=g[Number($)];A!=null&&(k=C[$],delete C[$],C[A]=k)}throw new Dr("".concat(s.name,".bulkUpdate(): ").concat(L," of ").concat(P," operations failed"),C)})})})},Le.prototype.bulkDelete=function(i){var s=this,l=i.length;return this._trans("readwrite",function(f){return s.core.mutate({trans:f,type:"delete",keys:i})}).then(function(y){var h=y.numFailures,g=y.lastResult,y=y.failures;if(h===0)return g;throw new Dr("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(l," operations failed"),y)})},Le);function Le(){}function zo(i){function s(y,b){if(b){for(var I=arguments.length,x=new Array(I-1);--I;)x[I-1]=arguments[I];return l[y].subscribe.apply(null,x),i}if(typeof y=="string")return l[y]}var l={};s.addEventType=g;for(var f=1,h=arguments.length;f<h;++f)g(arguments[f]);return s;function g(y,b,I){if(typeof y!="object"){var x;b=b||rm;var P={subscribers:[],fire:I=I||_e,subscribe:function(S){P.subscribers.indexOf(S)===-1&&(P.subscribers.push(S),P.fire=b(P.fire,S))},unsubscribe:function(S){P.subscribers=P.subscribers.filter(function(L){return L!==S}),P.fire=P.subscribers.reduce(b,I)}};return l[y]=s[y]=P}c(x=y).forEach(function(S){var L=x[S];if(u(L))g(S,x[S][0],x[S][1]);else{if(L!=="asap")throw new oe.InvalidArgument("Invalid event config");var C=g(S,Fo,function(){for(var O=arguments.length,R=new Array(O);O--;)R[O]=arguments[O];C.subscribers.forEach(function(k){ie(function(){k.apply(null,R)})})})}})}}function Wo(i,s){return D(s).from({prototype:i}),s}function Fn(i,s){return!(i.filter||i.algorithm||i.or)&&(s?i.justLimit:!i.replayFilter)}function Zs(i,s){i.filter=an(i.filter,s)}function ec(i,s,l){var f=i.replayFilter;i.replayFilter=f?function(){return an(f(),s())}:s,i.justLimit=l&&!f}function ua(i,s){if(i.isPrimKey)return s.primaryKey;var l=s.getIndexByKeyPath(i.index);if(!l)throw new oe.Schema("KeyPath "+i.index+" on object store "+s.name+" is not indexed");return l}function kl(i,s,l){var f=ua(i,s.schema);return s.openCursor({trans:l,values:!i.keysOnly,reverse:i.dir==="prev",unique:!!i.unique,query:{index:f,range:i.range}})}function la(i,s,l,f){var h=i.replayFilter?an(i.filter,i.replayFilter()):i.filter;if(i.or){var g={},y=function(b,I,x){var P,S;h&&!h(I,x,function(L){return I.stop(L)},function(L){return I.fail(L)})||((S=""+(P=I.primaryKey))=="[object ArrayBuffer]"&&(S=""+new Uint8Array(P)),v(g,S)||(g[S]=!0,s(b,I,x)))};return Promise.all([i.or._iterate(y,l),Dl(kl(i,f,l),i.algorithm,y,!i.keysOnly&&i.valueMapper)])}return Dl(kl(i,f,l),an(i.algorithm,h),s,!i.keysOnly&&i.valueMapper)}function Dl(i,s,l,f){var h=Ae(f?function(g,y,b){return l(f(g),y,b)}:l);return i.then(function(g){if(g)return g.start(function(){var y=function(){return g.continue()};s&&!s(g,function(b){return y=b},function(b){g.stop(b),y=_e},function(b){g.fail(b),y=_e})||h(g.value,g,function(b){return y=b}),y()})})}var ar=Symbol(),Vo=(Ol.prototype.execute=function(i){if(this.add!==void 0){var s=this.add;if(u(s))return o(o([],u(i)?i:[],!0),s).sort();if(typeof s=="number")return(Number(i)||0)+s;if(typeof s=="bigint")try{return BigInt(i)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(this.remove!==void 0){var l=this.remove;if(u(l))return u(i)?i.filter(function(f){return!l.includes(f)}).sort():[];if(typeof l=="number")return Number(i)-l;if(typeof l=="bigint")try{return BigInt(i)-l}catch{return BigInt(0)-l}throw new TypeError("Invalid subtrahend ".concat(l))}return s=(s=this.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof i=="string"&&i.startsWith(s)?this.replacePrefix[1]+i.substring(s.length):i},Ol);function Ol(i){Object.assign(this,i)}var cm=(we.prototype._read=function(i,s){var l=this._ctx;return l.error?l.table._trans(null,qe.bind(null,l.error)):l.table._trans("readonly",i).then(s)},we.prototype._write=function(i){var s=this._ctx;return s.error?s.table._trans(null,qe.bind(null,s.error)):s.table._trans("readwrite",i,"locked")},we.prototype._addAlgorithm=function(i){var s=this._ctx;s.algorithm=an(s.algorithm,i)},we.prototype._iterate=function(i,s){return la(this._ctx,i,s,this._ctx.table.core)},we.prototype.clone=function(i){var s=Object.create(this.constructor.prototype),l=Object.create(this._ctx);return i&&d(l,i),s._ctx=l,s},we.prototype.raw=function(){return this._ctx.valueMapper=null,this},we.prototype.each=function(i){var s=this._ctx;return this._read(function(l){return la(s,i,l,s.table.core)})},we.prototype.count=function(i){var s=this;return this._read(function(l){var f=s._ctx,h=f.table.core;if(Fn(f,!0))return h.count({trans:l,query:{index:ua(f,h.schema),range:f.range}}).then(function(y){return Math.min(y,f.limit)});var g=0;return la(f,function(){return++g,!1},l,h).then(function(){return g})}).then(i)},we.prototype.sortBy=function(i,s){var l=i.split(".").reverse(),f=l[0],h=l.length-1;function g(I,x){return x?g(I[l[x]],x-1):I[f]}var y=this._ctx.dir==="next"?1:-1;function b(I,x){return ve(g(I,h),g(x,h))*y}return this.toArray(function(I){return I.sort(b)}).then(s)},we.prototype.toArray=function(i){var s=this;return this._read(function(l){var f=s._ctx;if(f.dir==="next"&&Fn(f,!0)&&0<f.limit){var h=f.valueMapper,g=ua(f,f.table.core.schema);return f.table.core.query({trans:l,limit:f.limit,values:!0,query:{index:g,range:f.range}}).then(function(b){return b=b.result,h?b.map(h):b})}var y=[];return la(f,function(b){return y.push(b)},l,f.table.core).then(function(){return y})},i)},we.prototype.offset=function(i){var s=this._ctx;return i<=0||(s.offset+=i,Fn(s)?ec(s,function(){var l=i;return function(f,h){return l===0||(l===1?--l:h(function(){f.advance(l),l=0}),!1)}}):ec(s,function(){var l=i;return function(){return--l<0}})),this},we.prototype.limit=function(i){return this._ctx.limit=Math.min(this._ctx.limit,i),ec(this._ctx,function(){var s=i;return function(l,f,h){return--s<=0&&f(h),0<=s}},!0),this},we.prototype.until=function(i,s){return Zs(this._ctx,function(l,f,h){return!i(l.value)||(f(h),s)}),this},we.prototype.first=function(i){return this.limit(1).toArray(function(s){return s[0]}).then(i)},we.prototype.last=function(i){return this.reverse().first(i)},we.prototype.filter=function(i){var s;return Zs(this._ctx,function(l){return i(l.value)}),(s=this._ctx).isMatch=an(s.isMatch,i),this},we.prototype.and=function(i){return this.filter(i)},we.prototype.or=function(i){return new this.db.WhereClause(this._ctx.table,i,this)},we.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},we.prototype.desc=function(){return this.reverse()},we.prototype.eachKey=function(i){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(l,f){i(f.key,f)})},we.prototype.eachUniqueKey=function(i){return this._ctx.unique="unique",this.eachKey(i)},we.prototype.eachPrimaryKey=function(i){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(l,f){i(f.primaryKey,f)})},we.prototype.keys=function(i){var s=this._ctx;s.keysOnly=!s.isMatch;var l=[];return this.each(function(f,h){l.push(h.key)}).then(function(){return l}).then(i)},we.prototype.primaryKeys=function(i){var s=this._ctx;if(s.dir==="next"&&Fn(s,!0)&&0<s.limit)return this._read(function(f){var h=ua(s,s.table.core.schema);return s.table.core.query({trans:f,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(f){return f.result}).then(i);s.keysOnly=!s.isMatch;var l=[];return this.each(function(f,h){l.push(h.primaryKey)}).then(function(){return l}).then(i)},we.prototype.uniqueKeys=function(i){return this._ctx.unique="unique",this.keys(i)},we.prototype.firstKey=function(i){return this.limit(1).keys(function(s){return s[0]}).then(i)},we.prototype.lastKey=function(i){return this.reverse().firstKey(i)},we.prototype.distinct=function(){var i=this._ctx,i=i.index&&i.table.schema.idxByName[i.index];if(!i||!i.multi)return this;var s={};return Zs(this._ctx,function(h){var f=h.primaryKey.toString(),h=v(s,f);return s[f]=!0,!h}),this},we.prototype.modify=function(i){var s=this,l=this._ctx;return this._write(function(f){var h,g,y;y=typeof i=="function"?i:(h=c(i),g=h.length,function(k){for(var $=!1,A=0;A<g;++A){var T=h[A],N=i[T],F=Z(k,T);N instanceof Vo?(ne(k,T,N.execute(F)),$=!0):F!==N&&(ne(k,T,N),$=!0)}return $});var b=l.table.core,S=b.schema.primaryKey,I=S.outbound,x=S.extractKey,P=200,S=s.db._options.modifyChunkSize;S&&(P=typeof S=="object"?S[b.name]||S["*"]||200:S);function L(k,T){var A=T.failures,T=T.numFailures;O+=k-T;for(var N=0,F=c(A);N<F.length;N++){var H=F[N];C.push(A[H])}}var C=[],O=0,R=[];return s.clone().primaryKeys().then(function(k){function $(T){var N=Math.min(P,k.length-T);return b.getMany({trans:f,keys:k.slice(T,T+N),cache:"immutable"}).then(function(F){for(var H=[],j=[],U=I?[]:null,z=[],K=0;K<N;++K){var Y=F[K],ue={value:be(Y),primKey:k[T+K]};y.call(ue,ue.value,ue)!==!1&&(ue.value==null?z.push(k[T+K]):I||ve(x(Y),x(ue.value))===0?(j.push(ue.value),I&&U.push(k[T+K])):(z.push(k[T+K]),H.push(ue.value)))}return Promise.resolve(0<H.length&&b.mutate({trans:f,type:"add",values:H}).then(function(fe){for(var he in fe.failures)z.splice(parseInt(he),1);L(H.length,fe)})).then(function(){return(0<j.length||A&&typeof i=="object")&&b.mutate({trans:f,type:"put",keys:U,values:j,criteria:A,changeSpec:typeof i!="function"&&i,isAdditionalChunk:0<T}).then(function(fe){return L(j.length,fe)})}).then(function(){return(0<z.length||A&&i===tc)&&b.mutate({trans:f,type:"delete",keys:z,criteria:A,isAdditionalChunk:0<T}).then(function(fe){return L(z.length,fe)})}).then(function(){return k.length>T+N&&$(T+P)})})}var A=Fn(l)&&l.limit===1/0&&(typeof i!="function"||i===tc)&&{index:l.index,range:l.range};return $(0).then(function(){if(0<C.length)throw new kt("Error modifying one or more objects",C,O,R);return k.length})})})},we.prototype.delete=function(){var i=this._ctx,s=i.range;return Fn(i)&&(i.isPrimKey||s.type===3)?this._write(function(l){var f=i.table.core.schema.primaryKey,h=s;return i.table.core.count({trans:l,query:{index:f,range:h}}).then(function(g){return i.table.core.mutate({trans:l,type:"deleteRange",range:h}).then(function(y){var b=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new kt("Could not delete some values",Object.keys(b).map(function(I){return b[I]}),g-y);return g-y})})}):this.modify(tc)},we);function we(){}var tc=function(i,s){return s.value=null};function um(i,s){return i<s?-1:i===s?0:1}function lm(i,s){return s<i?-1:i===s?0:1}function gt(i,s,l){return i=i instanceof Rl?new i.Collection(i):i,i._ctx.error=new(l||TypeError)(s),i}function jn(i){return new i.Collection(i,function(){return Pl("")}).limit(0)}function da(i,s,l,f){var h,g,y,b,I,x,P,S=l.length;if(!l.every(function(O){return typeof O=="string"}))return gt(i,_l);function L(O){h=O==="next"?function(k){return k.toUpperCase()}:function(k){return k.toLowerCase()},g=O==="next"?function(k){return k.toLowerCase()}:function(k){return k.toUpperCase()},y=O==="next"?um:lm;var R=l.map(function(k){return{lower:g(k),upper:h(k)}}).sort(function(k,$){return y(k.lower,$.lower)});b=R.map(function(k){return k.upper}),I=R.map(function(k){return k.lower}),P=(x=O)==="next"?"":f}L("next"),i=new i.Collection(i,function(){return $r(b[0],I[S-1]+f)}),i._ondirectionchange=function(O){L(O)};var C=0;return i._addAlgorithm(function(O,R,k){var $=O.key;if(typeof $!="string")return!1;var A=g($);if(s(A,I,C))return!0;for(var T=null,N=C;N<S;++N){var F=function(H,j,U,z,K,Y){for(var ue=Math.min(H.length,z.length),fe=-1,he=0;he<ue;++he){var vt=j[he];if(vt!==z[he])return K(H[he],U[he])<0?H.substr(0,he)+U[he]+U.substr(he+1):K(H[he],z[he])<0?H.substr(0,he)+z[he]+U.substr(he+1):0<=fe?H.substr(0,fe)+j[fe]+U.substr(fe+1):null;K(H[he],vt)<0&&(fe=he)}return ue<z.length&&Y==="next"?H+U.substr(H.length):ue<H.length&&Y==="prev"?H.substr(0,U.length):fe<0?null:H.substr(0,fe)+z[fe]+U.substr(fe+1)}($,A,b[N],I[N],y,x);F===null&&T===null?C=N+1:(T===null||0<y(T,F))&&(T=F)}return R(T!==null?function(){O.continue(T+P)}:k),!1}),i}function $r(i,s,l,f){return{type:2,lower:i,upper:s,lowerOpen:l,upperOpen:f}}function Pl(i){return{type:1,lower:i,upper:i}}var Rl=(Object.defineProperty(Ye.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ye.prototype.between=function(i,s,l,f){l=l!==!1,f=f===!0;try{return 0<this._cmp(i,s)||this._cmp(i,s)===0&&(l||f)&&(!l||!f)?jn(this):new this.Collection(this,function(){return $r(i,s,!l,!f)})}catch{return gt(this,ir)}},Ye.prototype.equals=function(i){return i==null?gt(this,ir):new this.Collection(this,function(){return Pl(i)})},Ye.prototype.above=function(i){return i==null?gt(this,ir):new this.Collection(this,function(){return $r(i,void 0,!0)})},Ye.prototype.aboveOrEqual=function(i){return i==null?gt(this,ir):new this.Collection(this,function(){return $r(i,void 0,!1)})},Ye.prototype.below=function(i){return i==null?gt(this,ir):new this.Collection(this,function(){return $r(void 0,i,!1,!0)})},Ye.prototype.belowOrEqual=function(i){return i==null?gt(this,ir):new this.Collection(this,function(){return $r(void 0,i)})},Ye.prototype.startsWith=function(i){return typeof i!="string"?gt(this,_l):this.between(i,i+on,!0,!0)},Ye.prototype.startsWithIgnoreCase=function(i){return i===""?this.startsWith(i):da(this,function(s,l){return s.indexOf(l[0])===0},[i],on)},Ye.prototype.equalsIgnoreCase=function(i){return da(this,function(s,l){return s===l[0]},[i],"")},Ye.prototype.anyOfIgnoreCase=function(){var i=se.apply(ct,arguments);return i.length===0?jn(this):da(this,function(s,l){return l.indexOf(s)!==-1},i,"")},Ye.prototype.startsWithAnyOfIgnoreCase=function(){var i=se.apply(ct,arguments);return i.length===0?jn(this):da(this,function(s,l){return l.some(function(f){return s.indexOf(f)===0})},i,on)},Ye.prototype.anyOf=function(){var i=this,s=se.apply(ct,arguments),l=this._cmp;try{s.sort(l)}catch{return gt(this,ir)}if(s.length===0)return jn(this);var f=new this.Collection(this,function(){return $r(s[0],s[s.length-1])});f._ondirectionchange=function(g){l=g==="next"?i._ascending:i._descending,s.sort(l)};var h=0;return f._addAlgorithm(function(g,y,b){for(var I=g.key;0<l(I,s[h]);)if(++h===s.length)return y(b),!1;return l(I,s[h])===0||(y(function(){g.continue(s[h])}),!1)}),f},Ye.prototype.notEqual=function(i){return this.inAnyRange([[-1/0,i],[i,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ye.prototype.noneOf=function(){var i=se.apply(ct,arguments);if(i.length===0)return new this.Collection(this);try{i.sort(this._ascending)}catch{return gt(this,ir)}var s=i.reduce(function(l,f){return l?l.concat([[l[l.length-1][1],f]]):[[-1/0,f]]},null);return s.push([i[i.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},Ye.prototype.inAnyRange=function($,s){var l=this,f=this._cmp,h=this._ascending,g=this._descending,y=this._min,b=this._max;if($.length===0)return jn(this);if(!$.every(function(A){return A[0]!==void 0&&A[1]!==void 0&&h(A[0],A[1])<=0}))return gt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",oe.InvalidArgument);var I=!s||s.includeLowers!==!1,x=s&&s.includeUppers===!0,P,S=h;function L(A,T){return S(A[0],T[0])}try{(P=$.reduce(function(A,T){for(var N=0,F=A.length;N<F;++N){var H=A[N];if(f(T[0],H[1])<0&&0<f(T[1],H[0])){H[0]=y(H[0],T[0]),H[1]=b(H[1],T[1]);break}}return N===F&&A.push(T),A},[])).sort(L)}catch{return gt(this,ir)}var C=0,O=x?function(A){return 0<h(A,P[C][1])}:function(A){return 0<=h(A,P[C][1])},R=I?function(A){return 0<g(A,P[C][0])}:function(A){return 0<=g(A,P[C][0])},k=O,$=new this.Collection(this,function(){return $r(P[0][0],P[P.length-1][1],!I,!x)});return $._ondirectionchange=function(A){S=A==="next"?(k=O,h):(k=R,g),P.sort(L)},$._addAlgorithm(function(A,T,N){for(var F,H=A.key;k(H);)if(++C===P.length)return T(N),!1;return!O(F=H)&&!R(F)||(l._cmp(H,P[C][1])===0||l._cmp(H,P[C][0])===0||T(function(){S===h?A.continue(P[C][0]):A.continue(P[C][1])}),!1)}),$},Ye.prototype.startsWithAnyOf=function(){var i=se.apply(ct,arguments);return i.every(function(s){return typeof s=="string"})?i.length===0?jn(this):this.inAnyRange(i.map(function(s){return[s,s+on]})):gt(this,"startsWithAnyOf() only works with strings")},Ye);function Ye(){}function Jt(i){return Ae(function(s){return Qo(s),i(s.target.error),!1})}function Qo(i){i.stopPropagation&&i.stopPropagation(),i.preventDefault&&i.preventDefault()}var Go="storagemutated",rc="x-storagemutated-1",Mr=zo(null,Go),dm=(Xt.prototype._lock=function(){return ae(!te.global),++this._reculock,this._reculock!==1||te.global||(te.lockOwnerFor=this),this},Xt.prototype._unlock=function(){if(ae(!te.global),--this._reculock==0)for(te.global||(te.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var i=this._blockedFuncs.shift();try{nn(i[1],i[0])}catch{}}return this},Xt.prototype._locked=function(){return this._reculock&&te.lockOwnerFor!==this},Xt.prototype.create=function(i){var s=this;if(!this.mode)return this;var l=this.db.idbdb,f=this.db._state.dbOpenError;if(ae(!this.idbtrans),!i&&!l)switch(f&&f.name){case"DatabaseClosedError":throw new oe.DatabaseClosed(f);case"MissingAPIError":throw new oe.MissingAPI(f.message,f);default:throw new oe.OpenFailed(f)}if(!this.active)throw new oe.TransactionInactive;return ae(this._completion._state===null),(i=this.idbtrans=i||(this.db.core||l).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ae(function(h){Qo(h),s._reject(i.error)}),i.onabort=Ae(function(h){Qo(h),s.active&&s._reject(new oe.Abort(i.error)),s.active=!1,s.on("abort").fire(h)}),i.oncomplete=Ae(function(){s.active=!1,s._resolve(),"mutatedParts"in i&&Mr.storagemutated.fire(i.mutatedParts)}),this},Xt.prototype._promise=function(i,s,l){var f=this;if(i==="readwrite"&&this.mode!=="readwrite")return qe(new oe.ReadOnly("Transaction is readonly"));if(!this.active)return qe(new oe.TransactionInactive);if(this._locked())return new Q(function(g,y){f._blockedFuncs.push([function(){f._promise(i,s,l).then(g,y)},te])});if(l)return Pr(function(){var g=new Q(function(y,b){f._lock();var I=s(y,b,f);I&&I.then&&I.then(y,b)});return g.finally(function(){return f._unlock()}),g._lib=!0,g});var h=new Q(function(g,y){var b=s(g,y,f);b&&b.then&&b.then(g,y)});return h._lib=!0,h},Xt.prototype._root=function(){return this.parent?this.parent._root():this},Xt.prototype.waitFor=function(i){var s,l=this._root(),f=Q.resolve(i);l._waitingFor?l._waitingFor=l._waitingFor.then(function(){return f}):(l._waitingFor=f,l._waitingQueue=[],s=l.idbtrans.objectStore(l.storeNames[0]),function g(){for(++l._spinCount;l._waitingQueue.length;)l._waitingQueue.shift()();l._waitingFor&&(s.get(-1/0).onsuccess=g)}());var h=l._waitingFor;return new Q(function(g,y){f.then(function(b){return l._waitingQueue.push(Ae(g.bind(null,b)))},function(b){return l._waitingQueue.push(Ae(y.bind(null,b)))}).finally(function(){l._waitingFor===h&&(l._waitingFor=null)})})},Xt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new oe.Abort))},Xt.prototype.table=function(i){var s=this._memoizedTables||(this._memoizedTables={});if(v(s,i))return s[i];var l=this.schema[i];if(!l)throw new oe.NotFound("Table "+i+" not part of transaction");return l=new this.db.Table(i,l,this),l.core=this.db.core.table(i),s[i]=l},Xt);function Xt(){}function nc(i,s,l,f,h,g,y){return{name:i,keyPath:s,unique:l,multi:f,auto:h,compound:g,src:(l&&!y?"&":"")+(f?"*":"")+(h?"++":"")+Ll(s)}}function Ll(i){return typeof i=="string"?i:i?"["+[].join.call(i,"+")+"]":""}function oc(i,s,l){return{name:i,primKey:s,indexes:l,mappedClass:null,idxByName:(f=function(h){return[h.name,h]},l.reduce(function(h,g,y){return y=f(g,y),y&&(h[y[0]]=y[1]),h},{}))};var f}var Yo=function(i){try{return i.only([[]]),Yo=function(){return[[]]},[[]]}catch{return Yo=function(){return on},on}};function ic(i){return i==null?function(){}:typeof i=="string"?(s=i).split(".").length===1?function(l){return l[s]}:function(l){return Z(l,s)}:function(l){return Z(l,i)};var s}function $l(i){return[].slice.call(i)}var fm=0;function Jo(i){return i==null?":id":typeof i=="string"?i:"[".concat(i.join("+"),"]")}function hm(i,s,I){function f(k){if(k.type===3)return null;if(k.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var C=k.lower,O=k.upper,R=k.lowerOpen,k=k.upperOpen;return C===void 0?O===void 0?null:s.upperBound(O,!!k):O===void 0?s.lowerBound(C,!!R):s.bound(C,O,!!R,!!k)}function h(L){var C,O=L.name;return{name:O,schema:L,mutate:function(R){var k=R.trans,$=R.type,A=R.keys,T=R.values,N=R.range;return new Promise(function(F,H){F=Ae(F);var j=k.objectStore(O),U=j.keyPath==null,z=$==="put"||$==="add";if(!z&&$!=="delete"&&$!=="deleteRange")throw new Error("Invalid operation type: "+$);var K,Y=(A||T||{length:1}).length;if(A&&T&&A.length!==T.length)throw new Error("Given keys array must have same length as given values array.");if(Y===0)return F({numFailures:0,failures:{},results:[],lastResult:void 0});function ue(ut){++vt,Qo(ut)}var fe=[],he=[],vt=0;if($==="deleteRange"){if(N.type===4)return F({numFailures:vt,failures:he,results:[],lastResult:void 0});N.type===3?fe.push(K=j.clear()):fe.push(K=j.delete(f(N)))}else{var U=z?U?[T,A]:[T,null]:[A,null],ce=U[0],it=U[1];if(z)for(var at=0;at<Y;++at)fe.push(K=it&&it[at]!==void 0?j[$](ce[at],it[at]):j[$](ce[at])),K.onerror=ue;else for(at=0;at<Y;++at)fe.push(K=j[$](ce[at])),K.onerror=ue}function Ia(ut){ut=ut.target.result,fe.forEach(function(un,Ec){return un.error!=null&&(he[Ec]=un.error)}),F({numFailures:vt,failures:he,results:$==="delete"?A:fe.map(function(un){return un.result}),lastResult:ut})}K.onerror=function(ut){ue(ut),Ia(ut)},K.onsuccess=Ia})},getMany:function(R){var k=R.trans,$=R.keys;return new Promise(function(A,T){A=Ae(A);for(var N,F=k.objectStore(O),H=$.length,j=new Array(H),U=0,z=0,K=function(fe){fe=fe.target,j[fe._pos]=fe.result,++z===U&&A(j)},Y=Jt(T),ue=0;ue<H;++ue)$[ue]!=null&&((N=F.get($[ue]))._pos=ue,N.onsuccess=K,N.onerror=Y,++U);U===0&&A(j)})},get:function(R){var k=R.trans,$=R.key;return new Promise(function(A,T){A=Ae(A);var N=k.objectStore(O).get($);N.onsuccess=function(F){return A(F.target.result)},N.onerror=Jt(T)})},query:(C=x,function(R){return new Promise(function(k,$){k=Ae(k);var A,T,N,U=R.trans,F=R.values,H=R.limit,K=R.query,j=H===1/0?void 0:H,z=K.index,K=K.range,U=U.objectStore(O),z=z.isPrimaryKey?U:U.index(z.name),K=f(K);if(H===0)return k({result:[]});C?((j=F?z.getAll(K,j):z.getAllKeys(K,j)).onsuccess=function(Y){return k({result:Y.target.result})},j.onerror=Jt($)):(A=0,T=!F&&"openKeyCursor"in z?z.openKeyCursor(K):z.openCursor(K),N=[],T.onsuccess=function(Y){var ue=T.result;return ue?(N.push(F?ue.value:ue.primaryKey),++A===H?k({result:N}):void ue.continue()):k({result:N})},T.onerror=Jt($))})}),openCursor:function(R){var k=R.trans,$=R.values,A=R.query,T=R.reverse,N=R.unique;return new Promise(function(F,H){F=Ae(F);var z=A.index,j=A.range,U=k.objectStore(O),U=z.isPrimaryKey?U:U.index(z.name),z=T?N?"prevunique":"prev":N?"nextunique":"next",K=!$&&"openKeyCursor"in U?U.openKeyCursor(f(j),z):U.openCursor(f(j),z);K.onerror=Jt(H),K.onsuccess=Ae(function(Y){var ue,fe,he,vt,ce=K.result;ce?(ce.___id=++fm,ce.done=!1,ue=ce.continue.bind(ce),fe=(fe=ce.continuePrimaryKey)&&fe.bind(ce),he=ce.advance.bind(ce),vt=function(){throw new Error("Cursor not stopped")},ce.trans=k,ce.stop=ce.continue=ce.continuePrimaryKey=ce.advance=function(){throw new Error("Cursor not started")},ce.fail=Ae(H),ce.next=function(){var it=this,at=1;return this.start(function(){return at--?it.continue():it.stop()}).then(function(){return it})},ce.start=function(it){function at(){if(K.result)try{it()}catch(ut){ce.fail(ut)}else ce.done=!0,ce.start=function(){throw new Error("Cursor behind last entry")},ce.stop()}var Ia=new Promise(function(ut,un){ut=Ae(ut),K.onerror=Jt(un),ce.fail=un,ce.stop=function(Ec){ce.stop=ce.continue=ce.continuePrimaryKey=ce.advance=vt,ut(Ec)}});return K.onsuccess=Ae(function(ut){K.onsuccess=at,at()}),ce.continue=ue,ce.continuePrimaryKey=fe,ce.advance=he,at(),Ia},F(ce)):F(null)},H)})},count:function(R){var k=R.query,$=R.trans,A=k.index,T=k.range;return new Promise(function(N,F){var H=$.objectStore(O),j=A.isPrimaryKey?H:H.index(A.name),H=f(T),j=H?j.count(H):j.count();j.onsuccess=Ae(function(U){return N(U.target.result)}),j.onerror=Jt(F)})}}}var g,y,b,P=(y=I,b=$l((g=i).objectStoreNames),{schema:{name:g.name,tables:b.map(function(L){return y.objectStore(L)}).map(function(L){var C=L.keyPath,k=L.autoIncrement,O=u(C),R={},k={name:L.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:C==null,compound:O,keyPath:C,autoIncrement:k,unique:!0,extractKey:ic(C)},indexes:$l(L.indexNames).map(function($){return L.index($)}).map(function(N){var A=N.name,T=N.unique,F=N.multiEntry,N=N.keyPath,F={name:A,compound:u(N),keyPath:N,unique:T,multiEntry:F,extractKey:ic(N)};return R[Jo(N)]=F}),getIndexByKeyPath:function($){return R[Jo($)]}};return R[":id"]=k.primaryKey,C!=null&&(R[Jo(C)]=k.primaryKey),k})},hasGetAll:0<b.length&&"getAll"in y.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),I=P.schema,x=P.hasGetAll,P=I.tables.map(h),S={};return P.forEach(function(L){return S[L.name]=L}),{stack:"dbcore",transaction:i.transaction.bind(i),table:function(L){if(!S[L])throw new Error("Table '".concat(L,"' not found"));return S[L]},MIN_KEY:-1/0,MAX_KEY:Yo(s),schema:I}}function pm(i,s,l,f){var h=l.IDBKeyRange;return l.indexedDB,{dbcore:(f=hm(s,h,f),i.dbcore.reduce(function(g,y){return y=y.create,n(n({},g),y(g))},f))}}function fa(i,f){var l=f.db,f=pm(i._middlewares,l,i._deps,f);i.core=f.dbcore,i.tables.forEach(function(h){var g=h.name;i.core.schema.tables.some(function(y){return y.name===g})&&(h.core=i.core.table(g),i[g]instanceof i.Table&&(i[g].core=h.core))})}function ha(i,s,l,f){l.forEach(function(h){var g=f[h];s.forEach(function(y){var b=function I(x,P){return M(x,P)||(x=p(x))&&I(x,P)}(y,h);(!b||"value"in b&&b.value===void 0)&&(y===i.Transaction.prototype||y instanceof i.Transaction?E(y,h,{get:function(){return this.table(h)},set:function(I){_(this,h,{value:I,writable:!0,configurable:!0,enumerable:!0})}}):y[h]=new i.Table(h,g))})})}function ac(i,s){s.forEach(function(l){for(var f in l)l[f]instanceof i.Table&&delete l[f]})}function mm(i,s){return i._cfg.version-s._cfg.version}function gm(i,s,l,f){var h=i._dbSchema;l.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=oc("$meta",Al("")[0],[]),i._storeNames.push("$meta"));var g=i._createTransaction("readwrite",i._storeNames,h);g.create(l),g._completion.catch(f);var y=g._reject.bind(g),b=te.transless||te;Pr(function(){return te.trans=g,te.transless=b,s!==0?(fa(i,l),x=s,((I=g).storeNames.includes("$meta")?I.table("$meta").get("version").then(function(P){return P??x}):Q.resolve(x)).then(function(P){return L=P,C=g,O=l,R=[],P=(S=i)._versions,k=S._dbSchema=ma(0,S.idbdb,O),(P=P.filter(function($){return $._cfg.version>=L})).length!==0?(P.forEach(function($){R.push(function(){var A=k,T=$._cfg.dbschema;ga(S,A,O),ga(S,T,O),k=S._dbSchema=T;var N=sc(A,T);N.add.forEach(function(z){cc(O,z[0],z[1].primKey,z[1].indexes)}),N.change.forEach(function(z){if(z.recreate)throw new oe.Upgrade("Not yet support for changing primary key");var K=O.objectStore(z.name);z.add.forEach(function(Y){return pa(K,Y)}),z.change.forEach(function(Y){K.deleteIndex(Y.name),pa(K,Y)}),z.del.forEach(function(Y){return K.deleteIndex(Y)})});var F=$._cfg.contentUpgrade;if(F&&$._cfg.version>L){fa(S,O),C._memoizedTables={};var H=pe(T);N.del.forEach(function(z){H[z]=A[z]}),ac(S,[S.Transaction.prototype]),ha(S,[S.Transaction.prototype],c(H),H),C.schema=H;var j,U=Me(F);return U&&Bn(),N=Q.follow(function(){var z;(j=F(C))&&U&&(z=Rr.bind(null,null),j.then(z,z))}),j&&typeof j.then=="function"?Q.resolve(j):N.then(function(){return j})}}),R.push(function(A){var T,N,F=$._cfg.dbschema;T=F,N=A,[].slice.call(N.db.objectStoreNames).forEach(function(H){return T[H]==null&&N.db.deleteObjectStore(H)}),ac(S,[S.Transaction.prototype]),ha(S,[S.Transaction.prototype],S._storeNames,S._dbSchema),C.schema=S._dbSchema}),R.push(function(A){S.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(S.idbdb.version/10)===$._cfg.version?(S.idbdb.deleteObjectStore("$meta"),delete S._dbSchema.$meta,S._storeNames=S._storeNames.filter(function(T){return T!=="$meta"})):A.objectStore("$meta").put($._cfg.version,"version"))})}),function $(){return R.length?Q.resolve(R.shift()(C.idbtrans)).then($):Q.resolve()}().then(function(){Ml(k,O)})):Q.resolve();var S,L,C,O,R,k}).catch(y)):(c(h).forEach(function(P){cc(l,P,h[P].primKey,h[P].indexes)}),fa(i,l),void Q.follow(function(){return i.on.populate.fire(g)}).catch(y));var I,x})}function vm(i,s){Ml(i._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var l=ma(0,i.idbdb,s);ga(i,i._dbSchema,s);for(var f=0,h=sc(l,i._dbSchema).change;f<h.length;f++){var g=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var b=s.objectStore(y.name);y.add.forEach(function(I){Yt&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(I.src)),pa(b,I)})}(h[f]);if(typeof g=="object")return g.value}}function sc(i,s){var l,f={del:[],add:[],change:[]};for(l in i)s[l]||f.del.push(l);for(l in s){var h=i[l],g=s[l];if(h){var y={name:l,def:g,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(g.primKey.keyPath||"")||h.primKey.auto!==g.primKey.auto)y.recreate=!0,f.change.push(y);else{var b=h.idxByName,I=g.idxByName,x=void 0;for(x in b)I[x]||y.del.push(x);for(x in I){var P=b[x],S=I[x];P?P.src!==S.src&&y.change.push(S):y.add.push(S)}(0<y.del.length||0<y.add.length||0<y.change.length)&&f.change.push(y)}}else f.add.push([l,g])}return f}function cc(i,s,l,f){var h=i.db.createObjectStore(s,l.keyPath?{keyPath:l.keyPath,autoIncrement:l.auto}:{autoIncrement:l.auto});return f.forEach(function(g){return pa(h,g)}),h}function Ml(i,s){c(i).forEach(function(l){s.db.objectStoreNames.contains(l)||(Yt&&console.debug("Dexie: Creating missing table",l),cc(s,l,i[l].primKey,i[l].indexes))})}function pa(i,s){i.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function ma(i,s,l){var f={};return q(s.objectStoreNames,0).forEach(function(h){for(var g=l.objectStore(h),y=nc(Ll(x=g.keyPath),x||"",!0,!1,!!g.autoIncrement,x&&typeof x!="string",!0),b=[],I=0;I<g.indexNames.length;++I){var P=g.index(g.indexNames[I]),x=P.keyPath,P=nc(P.name,x,!!P.unique,!!P.multiEntry,!1,x&&typeof x!="string",!1);b.push(P)}f[h]=oc(h,y,b)}),f}function ga(i,s,l){for(var f=l.db.objectStoreNames,h=0;h<f.length;++h){var g=f[h],y=l.objectStore(g);i._hasGetAll="getAll"in y;for(var b=0;b<y.indexNames.length;++b){var I=y.indexNames[b],x=y.index(I).keyPath,P=typeof x=="string"?x:"["+q(x).join("+")+"]";!s[g]||(x=s[g].idxByName[P])&&(x.name=I,delete s[g].idxByName[P],s[g].idxByName[I]=x)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&a.WorkerGlobalScope&&a instanceof a.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(i._hasGetAll=!1)}function Al(i){return i.split(",").map(function(s,l){var f=(s=s.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return nc(f,h||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),u(h),l===0)})}var ym=(va.prototype._parseStoresSpec=function(i,s){c(i).forEach(function(l){if(i[l]!==null){var f=Al(i[l]),h=f.shift();if(h.unique=!0,h.multi)throw new oe.Schema("Primary key cannot be multi-valued");f.forEach(function(g){if(g.auto)throw new oe.Schema("Only primary key can be marked as autoIncrement (++)");if(!g.keyPath)throw new oe.Schema("Index must have a name and cannot be an empty string")}),s[l]=oc(l,h,f)}})},va.prototype.stores=function(l){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?d(this._cfg.storesSource,l):l;var l=s._versions,f={},h={};return l.forEach(function(g){d(f,g._cfg.storesSource),h=g._cfg.dbschema={},g._parseStoresSpec(f,h)}),s._dbSchema=h,ac(s,[s._allTables,s,s.Transaction.prototype]),ha(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],c(h),h),s._storeNames=c(h),this},va.prototype.upgrade=function(i){return this._cfg.contentUpgrade=Us(this._cfg.contentUpgrade||_e,i),this},va);function va(){}function uc(i,s){var l=i._dbNamesDB;return l||(l=i._dbNamesDB=new sr(sa,{addons:[],indexedDB:i,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),l.table("dbnames")}function lc(i){return i&&typeof i.databases=="function"}function dc(i){return Pr(function(){return te.letThrough=!0,i()})}function fc(i){return!("from"in i)}var ot=function(i,s){if(!this){var l=new ot;return i&&"d"in i&&d(l,i),l}d(this,arguments.length?{d:1,from:i,to:1<arguments.length?s:i}:{d:0})};function Xo(i,s,l){var f=ve(s,l);if(!isNaN(f)){if(0<f)throw RangeError();if(fc(i))return d(i,{from:s,to:l,d:1});var h=i.l,f=i.r;if(ve(l,i.from)<0)return h?Xo(h,s,l):i.l={from:s,to:l,d:1,l:null,r:null},Nl(i);if(0<ve(s,i.to))return f?Xo(f,s,l):i.r={from:s,to:l,d:1,l:null,r:null},Nl(i);ve(s,i.from)<0&&(i.from=s,i.l=null,i.d=f?f.d+1:1),0<ve(l,i.to)&&(i.to=l,i.r=null,i.d=i.l?i.l.d+1:1),l=!i.r,h&&!i.l&&Zo(i,h),f&&l&&Zo(i,f)}}function Zo(i,s){fc(s)||function l(f,I){var g=I.from,y=I.to,b=I.l,I=I.r;Xo(f,g,y),b&&l(f,b),I&&l(f,I)}(i,s)}function Tl(i,s){var l=ya(s),f=l.next();if(f.done)return!1;for(var h=f.value,g=ya(i),y=g.next(h.from),b=y.value;!f.done&&!y.done;){if(ve(b.from,h.to)<=0&&0<=ve(b.to,h.from))return!0;ve(h.from,b.from)<0?h=(f=l.next(b.from)).value:b=(y=g.next(h.from)).value}return!1}function ya(i){var s=fc(i)?null:{s:0,n:i};return{next:function(l){for(var f=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,f)for(;s.n.l&&ve(l,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!f||ve(l,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function Nl(i){var s,l,f=(((s=i.r)===null||s===void 0?void 0:s.d)||0)-(((l=i.l)===null||l===void 0?void 0:l.d)||0),h=1<f?"r":f<-1?"l":"";h&&(s=h=="r"?"l":"r",l=n({},i),f=i[h],i.from=f.from,i.to=f.to,i[h]=f[h],l[h]=f[s],(i[s]=l).d=Bl(l)),i.d=Bl(i)}function Bl(l){var s=l.r,l=l.l;return(s?l?Math.max(s.d,l.d):s.d:l?l.d:0)+1}function ba(i,s){return c(s).forEach(function(l){i[l]?Zo(i[l],s[l]):i[l]=function f(h){var g,y,b={};for(g in h)v(h,g)&&(y=h[g],b[g]=!y||typeof y!="object"||Re.has(y.constructor)?y:f(y));return b}(s[l])}),i}function hc(i,s){return i.all||s.all||Object.keys(i).some(function(l){return s[l]&&Tl(s[l],i[l])})}w(ot.prototype,((Dt={add:function(i){return Zo(this,i),this},addKey:function(i){return Xo(this,i,i),this},addKeys:function(i){var s=this;return i.forEach(function(l){return Xo(s,l,l)}),this},hasKey:function(i){var s=ya(this).next(i).value;return s&&ve(s.from,i)<=0&&0<=ve(s.to,i)}})[nt]=function(){return ya(this)},Dt));var sn={},pc={},mc=!1;function wa(i){ba(pc,i),mc||(mc=!0,setTimeout(function(){mc=!1,gc(pc,!(pc={}))},0))}function gc(i,s){s===void 0&&(s=!1);var l=new Set;if(i.all)for(var f=0,h=Object.values(sn);f<h.length;f++)ql(y=h[f],i,l,s);else for(var g in i){var y,b=/^idb\:\/\/(.*)\/(.*)\//.exec(g);b&&(g=b[1],b=b[2],(y=sn["idb://".concat(g,"/").concat(b)])&&ql(y,i,l,s))}l.forEach(function(I){return I()})}function ql(i,s,l,f){for(var h=[],g=0,y=Object.entries(i.queries.query);g<y.length;g++){for(var b=y[g],I=b[0],x=[],P=0,S=b[1];P<S.length;P++){var L=S[P];hc(s,L.obsSet)?L.subscribers.forEach(function(k){return l.add(k)}):f&&x.push(L)}f&&h.push([I,x])}if(f)for(var C=0,O=h;C<O.length;C++){var R=O[C],I=R[0],x=R[1];i.queries.query[I]=x}}function bm(i){var s=i._state,l=i._deps.indexedDB;if(s.isBeingOpened||i.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?qe(s.dbOpenError):i});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var f=s.openCanceller,h=Math.round(10*i.verno),g=!1;function y(){if(s.openCanceller!==f)throw new oe.DatabaseClosed("db.open() was cancelled")}function b(){return new Q(function(L,C){if(y(),!l)throw new oe.MissingAPI;var O=i.name,R=s.autoSchema||!h?l.open(O):l.open(O,h);if(!R)throw new oe.MissingAPI;R.onerror=Jt(C),R.onblocked=Ae(i._fireOnBlocked),R.onupgradeneeded=Ae(function(k){var $;P=R.transaction,s.autoSchema&&!i._options.allowEmptyDB?(R.onerror=Qo,P.abort(),R.result.close(),($=l.deleteDatabase(O)).onsuccess=$.onerror=Ae(function(){C(new oe.NoSuchDatabase("Database ".concat(O," doesnt exist")))})):(P.onerror=Jt(C),k=k.oldVersion>Math.pow(2,62)?0:k.oldVersion,S=k<1,i.idbdb=R.result,g&&vm(i,P),gm(i,k/10,P,C))},C),R.onsuccess=Ae(function(){P=null;var k,$,A,T,N,F=i.idbdb=R.result,H=q(F.objectStoreNames);if(0<H.length)try{var j=F.transaction((T=H).length===1?T[0]:T,"readonly");if(s.autoSchema)$=F,A=j,(k=i).verno=$.version/10,A=k._dbSchema=ma(0,$,A),k._storeNames=q($.objectStoreNames,0),ha(k,[k._allTables],c(A),A);else if(ga(i,i._dbSchema,j),((N=sc(ma(0,(N=i).idbdb,j),N._dbSchema)).add.length||N.change.some(function(U){return U.add.length||U.change.length}))&&!g)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),F.close(),h=F.version+1,g=!0,L(b());fa(i,j)}catch{}qn.push(i),F.onversionchange=Ae(function(U){s.vcFired=!0,i.on("versionchange").fire(U)}),F.onclose=Ae(function(U){i.on("close").fire(U)}),S&&(N=i._deps,j=O,F=N.indexedDB,N=N.IDBKeyRange,lc(F)||j===sa||uc(F,N).put({name:j}).catch(_e)),L()},C)}).catch(function(L){switch(L==null?void 0:L.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),b();break;case"VersionError":if(0<h)return h=0,b()}return Q.reject(L)})}var I,x=s.dbReadyResolve,P=null,S=!1;return Q.race([f,(typeof navigator>"u"?Q.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(L){function C(){return indexedDB.databases().finally(L)}I=setInterval(C,100),C()}).finally(function(){return clearInterval(I)}):Promise.resolve()).then(b)]).then(function(){return y(),s.onReadyBeingFired=[],Q.resolve(dc(function(){return i.on.ready.fire(i.vip)})).then(function L(){if(0<s.onReadyBeingFired.length){var C=s.onReadyBeingFired.reduce(Us,_e);return s.onReadyBeingFired=[],Q.resolve(dc(function(){return C(i.vip)})).then(L)}})}).finally(function(){s.openCanceller===f&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(L){s.dbOpenError=L;try{P&&P.abort()}catch{}return f===s.openCanceller&&i._close(),qe(L)}).finally(function(){s.openComplete=!0,x()}).then(function(){var L;return S&&(L={},i.tables.forEach(function(C){C.schema.indexes.forEach(function(O){O.name&&(L["idb://".concat(i.name,"/").concat(C.name,"/").concat(O.name)]=new ot(-1/0,[[[]]]))}),L["idb://".concat(i.name,"/").concat(C.name,"/")]=L["idb://".concat(i.name,"/").concat(C.name,"/:dels")]=new ot(-1/0,[[[]]])}),Mr(Go).fire(L),gc(L,!0)),i})}function vc(i){function s(g){return i.next(g)}var l=h(s),f=h(function(g){return i.throw(g)});function h(g){return function(I){var b=g(I),I=b.value;return b.done?I:I&&typeof I.then=="function"?I.then(l,f):u(I)?Promise.all(I).then(l,f):l(I)}}return h(s)()}function _a(i,s,l){for(var f=u(i)?i.slice():[i],h=0;h<l;++h)f.push(s);return f}var wm={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(i){return n(n({},i),{table:function(s){var l=i.table(s),f=l.schema,h={},g=[];function y(S,L,C){var O=Jo(S),R=h[O]=h[O]||[],k=S==null?0:typeof S=="string"?1:S.length,$=0<L,$=n(n({},C),{name:$?"".concat(O,"(virtual-from:").concat(C.name,")"):C.name,lowLevelIndex:C,isVirtual:$,keyTail:L,keyLength:k,extractKey:ic(S),unique:!$&&C.unique});return R.push($),$.isPrimaryKey||g.push($),1<k&&y(k===2?S[0]:S.slice(0,k-1),L+1,C),R.sort(function(A,T){return A.keyTail-T.keyTail}),$}s=y(f.primaryKey.keyPath,0,f.primaryKey),h[":id"]=[s];for(var b=0,I=f.indexes;b<I.length;b++){var x=I[b];y(x.keyPath,0,x)}function P(S){var L,C=S.query.index;return C.isVirtual?n(n({},S),{query:{index:C.lowLevelIndex,range:(L=S.query.range,C=C.keyTail,{type:L.type===1?2:L.type,lower:_a(L.lower,L.lowerOpen?i.MAX_KEY:i.MIN_KEY,C),lowerOpen:!0,upper:_a(L.upper,L.upperOpen?i.MIN_KEY:i.MAX_KEY,C),upperOpen:!0})}}):S}return n(n({},l),{schema:n(n({},f),{primaryKey:s,indexes:g,getIndexByKeyPath:function(S){return(S=h[Jo(S)])&&S[0]}}),count:function(S){return l.count(P(S))},query:function(S){return l.query(P(S))},openCursor:function(S){var L=S.query.index,C=L.keyTail,O=L.isVirtual,R=L.keyLength;return O?l.openCursor(P(S)).then(function($){return $&&k($)}):l.openCursor(S);function k($){return Object.create($,{continue:{value:function(A){A!=null?$.continue(_a(A,S.reverse?i.MAX_KEY:i.MIN_KEY,C)):S.unique?$.continue($.key.slice(0,R).concat(S.reverse?i.MIN_KEY:i.MAX_KEY,C)):$.continue()}},continuePrimaryKey:{value:function(A,T){$.continuePrimaryKey(_a(A,i.MAX_KEY,C),T)}},primaryKey:{get:function(){return $.primaryKey}},key:{get:function(){var A=$.key;return R===1?A[0]:A.slice(0,R)}},value:{get:function(){return $.value}}})}}})}})}};function yc(i,s,l,f){return l=l||{},f=f||"",c(i).forEach(function(h){var g,y,b;v(s,h)?(g=i[h],y=s[h],typeof g=="object"&&typeof y=="object"&&g&&y?(b=De(g))!==De(y)?l[f+h]=s[h]:b==="Object"?yc(g,y,l,f+h+"."):g!==y&&(l[f+h]=s[h]):g!==y&&(l[f+h]=s[h])):l[f+h]=void 0}),c(s).forEach(function(h){v(i,h)||(l[f+h]=s[h])}),l}function bc(i,s){return s.type==="delete"?s.keys:s.keys||s.values.map(i.extractKey)}var _m={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(i){return n(n({},i),{table:function(s){var l=i.table(s),f=l.schema.primaryKey;return n(n({},l),{mutate:function(h){var g=te.trans,y=g.table(s).hook,b=y.deleting,I=y.creating,x=y.updating;switch(h.type){case"add":if(I.fire===_e)break;return g._promise("readwrite",function(){return P(h)},!0);case"put":if(I.fire===_e&&x.fire===_e)break;return g._promise("readwrite",function(){return P(h)},!0);case"delete":if(b.fire===_e)break;return g._promise("readwrite",function(){return P(h)},!0);case"deleteRange":if(b.fire===_e)break;return g._promise("readwrite",function(){return function S(L,C,O){return l.query({trans:L,values:!1,query:{index:f,range:C},limit:O}).then(function(R){var k=R.result;return P({type:"delete",keys:k,trans:L}).then(function($){return 0<$.numFailures?Promise.reject($.failures[0]):k.length<O?{failures:[],numFailures:0,lastResult:void 0}:S(L,n(n({},C),{lower:k[k.length-1],lowerOpen:!0}),O)})})}(h.trans,h.range,1e4)},!0)}return l.mutate(h);function P(S){var L,C,O,R=te.trans,k=S.keys||bc(f,S);if(!k)throw new Error("Keys missing");return(S=S.type==="add"||S.type==="put"?n(n({},S),{keys:k}):n({},S)).type!=="delete"&&(S.values=o([],S.values)),S.keys&&(S.keys=o([],S.keys)),L=l,O=k,((C=S).type==="add"?Promise.resolve([]):L.getMany({trans:C.trans,keys:O,cache:"immutable"})).then(function($){var A=k.map(function(T,N){var F,H,j,U=$[N],z={onerror:null,onsuccess:null};return S.type==="delete"?b.fire.call(z,T,U,R):S.type==="add"||U===void 0?(F=I.fire.call(z,T,S.values[N],R),T==null&&F!=null&&(S.keys[N]=T=F,f.outbound||ne(S.values[N],f.keyPath,T))):(F=yc(U,S.values[N]),(H=x.fire.call(z,F,T,U,R))&&(j=S.values[N],Object.keys(H).forEach(function(K){v(j,K)?j[K]=H[K]:ne(j,K,H[K])}))),z});return l.mutate(S).then(function(T){for(var N=T.failures,F=T.results,H=T.numFailures,T=T.lastResult,j=0;j<k.length;++j){var U=(F||k)[j],z=A[j];U==null?z.onerror&&z.onerror(N[j]):z.onsuccess&&z.onsuccess(S.type==="put"&&$[j]?S.values[j]:U)}return{failures:N,results:F,numFailures:H,lastResult:T}}).catch(function(T){return A.forEach(function(N){return N.onerror&&N.onerror(T)}),Promise.reject(T)})})}}})}})}};function Fl(i,s,l){try{if(!s||s.keys.length<i.length)return null;for(var f=[],h=0,g=0;h<s.keys.length&&g<i.length;++h)ve(s.keys[h],i[g])===0&&(f.push(l?be(s.values[h]):s.values[h]),++g);return f.length===i.length?f:null}catch{return null}}var Sm={stack:"dbcore",level:-1,create:function(i){return{table:function(s){var l=i.table(s);return n(n({},l),{getMany:function(f){if(!f.cache)return l.getMany(f);var h=Fl(f.keys,f.trans._cache,f.cache==="clone");return h?Q.resolve(h):l.getMany(f).then(function(g){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?be(g):g},g})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),l.mutate(f)}})}}}};function jl(i,s){return i.trans.mode==="readonly"&&!!i.subscr&&!i.trans.explicit&&i.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function Ul(i,s){switch(i){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Em={stack:"dbcore",level:0,name:"Observability",create:function(i){var s=i.schema.name,l=new ot(i.MIN_KEY,i.MAX_KEY);return n(n({},i),{transaction:function(f,h,g){if(te.subscr&&h!=="readonly")throw new oe.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(te.querier));return i.transaction(f,h,g)},table:function(f){var h=i.table(f),g=h.schema,y=g.primaryKey,S=g.indexes,b=y.extractKey,I=y.outbound,x=y.autoIncrement&&S.filter(function(C){return C.compound&&C.keyPath.includes(y.keyPath)}),P=n(n({},h),{mutate:function(C){function O(K){return K="idb://".concat(s,"/").concat(f,"/").concat(K),T[K]||(T[K]=new ot)}var R,k,$,A=C.trans,T=C.mutatedParts||(C.mutatedParts={}),N=O(""),F=O(":dels"),H=C.type,z=C.type==="deleteRange"?[C.range]:C.type==="delete"?[C.keys]:C.values.length<50?[bc(y,C).filter(function(K){return K}),C.values]:[],j=z[0],U=z[1],z=C.trans._cache;return u(j)?(N.addKeys(j),(z=H==="delete"||j.length===U.length?Fl(j,z):null)||F.addKeys(j),(z||U)&&(R=O,k=z,$=U,g.indexes.forEach(function(K){var Y=R(K.name||"");function ue(he){return he!=null?K.extractKey(he):null}function fe(he){return K.multiEntry&&u(he)?he.forEach(function(vt){return Y.addKey(vt)}):Y.addKey(he)}(k||$).forEach(function(he,it){var ce=k&&ue(k[it]),it=$&&ue($[it]);ve(ce,it)!==0&&(ce!=null&&fe(ce),it!=null&&fe(it))})}))):j?(U={from:(U=j.lower)!==null&&U!==void 0?U:i.MIN_KEY,to:(U=j.upper)!==null&&U!==void 0?U:i.MAX_KEY},F.add(U),N.add(U)):(N.add(l),F.add(l),g.indexes.forEach(function(K){return O(K.name).add(l)})),h.mutate(C).then(function(K){return!j||C.type!=="add"&&C.type!=="put"||(N.addKeys(K.results),x&&x.forEach(function(Y){for(var ue=C.values.map(function(ce){return Y.extractKey(ce)}),fe=Y.keyPath.findIndex(function(ce){return ce===y.keyPath}),he=0,vt=K.results.length;he<vt;++he)ue[he][fe]=K.results[he];O(Y.name).addKeys(ue)})),A.mutatedParts=ba(A.mutatedParts||{},T),K})}}),S=function(O){var R=O.query,O=R.index,R=R.range;return[O,new ot((O=R.lower)!==null&&O!==void 0?O:i.MIN_KEY,(R=R.upper)!==null&&R!==void 0?R:i.MAX_KEY)]},L={get:function(C){return[y,new ot(C.key)]},getMany:function(C){return[y,new ot().addKeys(C.keys)]},count:S,query:S,openCursor:S};return c(L).forEach(function(C){P[C]=function(O){var R=te.subscr,k=!!R,$=jl(te,h)&&Ul(C,O)?O.obsSet={}:R;if(k){var A=function(U){return U="idb://".concat(s,"/").concat(f,"/").concat(U),$[U]||($[U]=new ot)},T=A(""),N=A(":dels"),R=L[C](O),k=R[0],R=R[1];if((C==="query"&&k.isPrimaryKey&&!O.values?N:A(k.name||"")).add(R),!k.isPrimaryKey){if(C!=="count"){var F=C==="query"&&I&&O.values&&h.query(n(n({},O),{values:!1}));return h[C].apply(this,arguments).then(function(U){if(C==="query"){if(I&&O.values)return F.then(function(ue){return ue=ue.result,T.addKeys(ue),U});var z=O.values?U.result.map(b):U.result;(O.values?T:N).addKeys(z)}else if(C==="openCursor"){var K=U,Y=O.values;return K&&Object.create(K,{key:{get:function(){return N.addKey(K.primaryKey),K.key}},primaryKey:{get:function(){var ue=K.primaryKey;return N.addKey(ue),ue}},value:{get:function(){return Y&&T.addKey(K.primaryKey),K.value}}})}return U})}N.add(l)}}return h[C].apply(this,arguments)}}),P}})}};function Kl(i,s,l){if(l.numFailures===0)return s;if(s.type==="deleteRange")return null;var f=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return l.numFailures===f?null:(s=n({},s),u(s.keys)&&(s.keys=s.keys.filter(function(h,g){return!(g in l.failures)})),"values"in s&&u(s.values)&&(s.values=s.values.filter(function(h,g){return!(g in l.failures)})),s)}function wc(i,s){return l=i,((f=s).lower===void 0||(f.lowerOpen?0<ve(l,f.lower):0<=ve(l,f.lower)))&&(i=i,(s=s).upper===void 0||(s.upperOpen?ve(i,s.upper)<0:ve(i,s.upper)<=0));var l,f}function Hl(i,s,L,f,h,g){if(!L||L.length===0)return i;var y=s.query.index,b=y.multiEntry,I=s.query.range,x=f.schema.primaryKey.extractKey,P=y.extractKey,S=(y.lowLevelIndex||y).extractKey,L=L.reduce(function(C,O){var R=C,k=[];if(O.type==="add"||O.type==="put")for(var $=new ot,A=O.values.length-1;0<=A;--A){var T,N=O.values[A],F=x(N);$.hasKey(F)||(T=P(N),(b&&u(T)?T.some(function(K){return wc(K,I)}):wc(T,I))&&($.addKey(F),k.push(N)))}switch(O.type){case"add":var H=new ot().addKeys(s.values?C.map(function(Y){return x(Y)}):C),R=C.concat(s.values?k.filter(function(Y){return Y=x(Y),!H.hasKey(Y)&&(H.addKey(Y),!0)}):k.map(function(Y){return x(Y)}).filter(function(Y){return!H.hasKey(Y)&&(H.addKey(Y),!0)}));break;case"put":var j=new ot().addKeys(O.values.map(function(Y){return x(Y)}));R=C.filter(function(Y){return!j.hasKey(s.values?x(Y):Y)}).concat(s.values?k:k.map(function(Y){return x(Y)}));break;case"delete":var U=new ot().addKeys(O.keys);R=C.filter(function(Y){return!U.hasKey(s.values?x(Y):Y)});break;case"deleteRange":var z=O.range;R=C.filter(function(Y){return!wc(x(Y),z)})}return R},i);return L===i?i:(L.sort(function(C,O){return ve(S(C),S(O))||ve(x(C),x(O))}),s.limit&&s.limit<1/0&&(L.length>s.limit?L.length=s.limit:i.length===s.limit&&L.length<s.limit&&(h.dirty=!0)),g?Object.freeze(L):L)}function zl(i,s){return ve(i.lower,s.lower)===0&&ve(i.upper,s.upper)===0&&!!i.lowerOpen==!!s.lowerOpen&&!!i.upperOpen==!!s.upperOpen}function Im(i,s){return function(l,f,h,g){if(l===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=ve(l,f))===0){if(h&&g)return 0;if(h)return 1;if(g)return-1}return f}(i.lower,s.lower,i.lowerOpen,s.lowerOpen)<=0&&0<=function(l,f,h,g){if(l===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=ve(l,f))===0){if(h&&g)return 0;if(h)return-1;if(g)return 1}return f}(i.upper,s.upper,i.upperOpen,s.upperOpen)}function Cm(i,s,l,f){i.subscribers.add(l),f.addEventListener("abort",function(){var h,g;i.subscribers.delete(l),i.subscribers.size===0&&(h=i,g=s,setTimeout(function(){h.subscribers.size===0&&Be(g,h)},3e3))})}var xm={stack:"dbcore",level:0,name:"Cache",create:function(i){var s=i.schema.name;return n(n({},i),{transaction:function(l,f,h){var g,y,b=i.transaction(l,f,h);return f==="readwrite"&&(y=(g=new AbortController).signal,h=function(I){return function(){if(g.abort(),f==="readwrite"){for(var x=new Set,P=0,S=l;P<S.length;P++){var L=S[P],C=sn["idb://".concat(s,"/").concat(L)];if(C){var O=i.table(L),R=C.optimisticOps.filter(function(Y){return Y.trans===b});if(b._explicit&&I&&b.mutatedParts)for(var k=0,$=Object.values(C.queries.query);k<$.length;k++)for(var A=0,T=(H=$[k]).slice();A<T.length;A++)hc((j=T[A]).obsSet,b.mutatedParts)&&(Be(H,j),j.subscribers.forEach(function(Y){return x.add(Y)}));else if(0<R.length){C.optimisticOps=C.optimisticOps.filter(function(Y){return Y.trans!==b});for(var N=0,F=Object.values(C.queries.query);N<F.length;N++)for(var H,j,U,z=0,K=(H=F[N]).slice();z<K.length;z++)(j=K[z]).res!=null&&b.mutatedParts&&(I&&!j.dirty?(U=Object.isFrozen(j.res),U=Hl(j.res,j.req,R,O,j,U),j.dirty?(Be(H,j),j.subscribers.forEach(function(Y){return x.add(Y)})):U!==j.res&&(j.res=U,j.promise=Q.resolve({result:U}))):(j.dirty&&Be(H,j),j.subscribers.forEach(function(Y){return x.add(Y)})))}}}x.forEach(function(Y){return Y()})}}},b.addEventListener("abort",h(!1),{signal:y}),b.addEventListener("error",h(!1),{signal:y}),b.addEventListener("complete",h(!0),{signal:y})),b},table:function(l){var f=i.table(l),h=f.schema.primaryKey;return n(n({},f),{mutate:function(g){var y=te.trans;if(h.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return f.mutate(g);var b=sn["idb://".concat(s,"/").concat(l)];return b?(y=f.mutate(g),g.type!=="add"&&g.type!=="put"||!(50<=g.values.length||bc(h,g).some(function(I){return I==null}))?(b.optimisticOps.push(g),g.mutatedParts&&wa(g.mutatedParts),y.then(function(I){0<I.numFailures&&(Be(b.optimisticOps,g),(I=Kl(0,g,I))&&b.optimisticOps.push(I),g.mutatedParts&&wa(g.mutatedParts))}),y.catch(function(){Be(b.optimisticOps,g),g.mutatedParts&&wa(g.mutatedParts)})):y.then(function(I){var x=Kl(0,n(n({},g),{values:g.values.map(function(P,S){var L;return I.failures[S]?P:(P=(L=h.keyPath)!==null&&L!==void 0&&L.includes(".")?be(P):n({},P),ne(P,h.keyPath,I.results[S]),P)})}),I);b.optimisticOps.push(x),queueMicrotask(function(){return g.mutatedParts&&wa(g.mutatedParts)})}),y):f.mutate(g)},query:function(g){if(!jl(te,f)||!Ul("query",g))return f.query(g);var y=((x=te.trans)===null||x===void 0?void 0:x.db._options.cache)==="immutable",S=te,b=S.requery,I=S.signal,x=function(O,R,k,$){var A=sn["idb://".concat(O,"/").concat(R)];if(!A)return[];if(!(R=A.queries[k]))return[null,!1,A,null];var T=R[($.query?$.query.index.name:null)||""];if(!T)return[null,!1,A,null];switch(k){case"query":var N=T.find(function(F){return F.req.limit===$.limit&&F.req.values===$.values&&zl(F.req.query.range,$.query.range)});return N?[N,!0,A,T]:[T.find(function(F){return("limit"in F.req?F.req.limit:1/0)>=$.limit&&(!$.values||F.req.values)&&Im(F.req.query.range,$.query.range)}),!1,A,T];case"count":return N=T.find(function(F){return zl(F.req.query.range,$.query.range)}),[N,!!N,A,T]}}(s,l,"query",g),P=x[0],S=x[1],L=x[2],C=x[3];return P&&S?P.obsSet=g.obsSet:(S=f.query(g).then(function(O){var R=O.result;if(P&&(P.res=R),y){for(var k=0,$=R.length;k<$;++k)Object.freeze(R[k]);Object.freeze(R)}else O.result=be(R);return O}).catch(function(O){return C&&P&&Be(C,P),Promise.reject(O)}),P={obsSet:g.obsSet,promise:S,subscribers:new Set,type:"query",req:g,dirty:!1},C?C.push(P):(C=[P],(L=L||(sn["idb://".concat(s,"/").concat(l)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[g.query.index.name||""]=C)),Cm(P,C,b,I),P.promise.then(function(O){return{result:Hl(O.result,g,L==null?void 0:L.optimisticOps,f,P,y)}})}})}})}};function Sa(i,s){return new Proxy(i,{get:function(l,f,h){return f==="db"?s:Reflect.get(l,f,h)}})}var sr=(Fe.prototype.version=function(i){if(isNaN(i)||i<.1)throw new oe.Type("Given version is not a positive number");if(i=Math.round(10*i)/10,this.idbdb||this._state.isBeingOpened)throw new oe.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,i);var s=this._versions,l=s.filter(function(f){return f._cfg.version===i})[0];return l||(l=new this.Version(i),s.push(l),s.sort(mm),l.stores({}),this._state.autoSchema=!1,l)},Fe.prototype._whenReady=function(i){var s=this;return this.idbdb&&(this._state.openComplete||te.letThrough||this._vip)?i():new Q(function(l,f){if(s._state.openComplete)return f(new oe.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void f(new oe.DatabaseClosed);s.open().catch(_e)}s._state.dbReadyPromise.then(l,f)}).then(i)},Fe.prototype.use=function(i){var s=i.stack,l=i.create,f=i.level,h=i.name;return h&&this.unuse({stack:s,name:h}),i=this._middlewares[s]||(this._middlewares[s]=[]),i.push({stack:s,create:l,level:f??10,name:h}),i.sort(function(g,y){return g.level-y.level}),this},Fe.prototype.unuse=function(i){var s=i.stack,l=i.name,f=i.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return f?h.create!==f:!!l&&h.name!==l})),this},Fe.prototype.open=function(){var i=this;return nn(Or,function(){return bm(i)})},Fe.prototype._close=function(){var i=this._state,s=qn.indexOf(this);if(0<=s&&qn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}i.isBeingOpened||(i.dbReadyPromise=new Q(function(l){i.dbReadyResolve=l}),i.openCanceller=new Q(function(l,f){i.cancelOpen=f}))},Fe.prototype.close=function(l){var s=(l===void 0?{disableAutoOpen:!0}:l).disableAutoOpen,l=this._state;s?(l.isBeingOpened&&l.cancelOpen(new oe.DatabaseClosed),this._close(),l.autoOpen=!1,l.dbOpenError=new oe.DatabaseClosed):(this._close(),l.autoOpen=this._options.autoOpen||l.isBeingOpened,l.openComplete=!1,l.dbOpenError=null)},Fe.prototype.delete=function(i){var s=this;i===void 0&&(i={disableAutoOpen:!0});var l=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new Q(function(h,g){function y(){s.close(i);var b=s._deps.indexedDB.deleteDatabase(s.name);b.onsuccess=Ae(function(){var I,x,P;I=s._deps,x=s.name,P=I.indexedDB,I=I.IDBKeyRange,lc(P)||x===sa||uc(P,I).delete(x).catch(_e),h()}),b.onerror=Jt(g),b.onblocked=s._fireOnBlocked}if(l)throw new oe.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(y):y()})},Fe.prototype.backendDB=function(){return this.idbdb},Fe.prototype.isOpen=function(){return this.idbdb!==null},Fe.prototype.hasBeenClosed=function(){var i=this._state.dbOpenError;return i&&i.name==="DatabaseClosed"},Fe.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Fe.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Fe.prototype,"tables",{get:function(){var i=this;return c(this._allTables).map(function(s){return i._allTables[s]})},enumerable:!1,configurable:!0}),Fe.prototype.transaction=function(){var i=(function(s,l,f){var h=arguments.length;if(h<2)throw new oe.InvalidArgument("Too few arguments");for(var g=new Array(h-1);--h;)g[h-1]=arguments[h];return f=g.pop(),[s,Ie(g),f]}).apply(this,arguments);return this._transaction.apply(this,i)},Fe.prototype._transaction=function(i,s,l){var f=this,h=te.trans;h&&h.db===this&&i.indexOf("!")===-1||(h=null);var g,y,b=i.indexOf("?")!==-1;i=i.replace("!","").replace("?","");try{if(y=s.map(function(x){if(x=x instanceof f.Table?x.name:x,typeof x!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return x}),i=="r"||i===Js)g=Js;else{if(i!="rw"&&i!=Xs)throw new oe.InvalidArgument("Invalid transaction mode: "+i);g=Xs}if(h){if(h.mode===Js&&g===Xs){if(!b)throw new oe.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&y.forEach(function(x){if(h&&h.storeNames.indexOf(x)===-1){if(!b)throw new oe.SubTransaction("Table "+x+" not included in parent transaction.");h=null}}),b&&h&&!h.active&&(h=null)}}catch(x){return h?h._promise(null,function(P,S){S(x)}):qe(x)}var I=(function x(P,S,L,C,O){return Q.resolve().then(function(){var R=te.transless||te,k=P._createTransaction(S,L,P._dbSchema,C);if(k.explicit=!0,R={trans:k,transless:R},C)k.idbtrans=C.idbtrans;else try{k.create(),k.idbtrans._explicit=!0,P._state.PR1398_maxLoop=3}catch(T){return T.name===js.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return x(P,S,L,null,O)})):qe(T)}var $,A=Me(O);return A&&Bn(),R=Q.follow(function(){var T;($=O.call(k,k))&&(A?(T=Rr.bind(null,null),$.then(T,T)):typeof $.next=="function"&&typeof $.throw=="function"&&($=vc($)))},R),($&&typeof $.then=="function"?Q.resolve($).then(function(T){return k.active?T:qe(new oe.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):R.then(function(){return $})).then(function(T){return C&&k._resolve(),k._completion.then(function(){return T})}).catch(function(T){return k._reject(T),qe(T)})})}).bind(null,this,g,y,h,l);return h?h._promise(g,I,"lock"):te.trans?nn(te.transless,function(){return f._whenReady(I)}):this._whenReady(I)},Fe.prototype.table=function(i){if(!v(this._allTables,i))throw new oe.InvalidTable("Table ".concat(i," does not exist"));return this._allTables[i]},Fe);function Fe(i,s){var l=this;this._middlewares={},this.verno=0;var f=Fe.dependencies;this._options=s=n({addons:Fe.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},f=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,g,y,b,I,x={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:_e,dbReadyPromise:null,cancelOpen:_e,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};x.dbReadyPromise=new Q(function(S){x.dbReadyResolve=S}),x.openCanceller=new Q(function(S,L){x.cancelOpen=L}),this._state=x,this.name=i,this.on=zo(this,"populate","blocked","versionchange","close",{ready:[Us,_e]}),this.on.ready.subscribe=G(this.on.ready.subscribe,function(S){return function(L,C){Fe.vip(function(){var O,R=l._state;R.openComplete?(R.dbOpenError||Q.resolve().then(L),C&&S(L)):R.onReadyBeingFired?(R.onReadyBeingFired.push(L),C&&S(L)):(S(L),O=l,C||S(function k(){O.on.ready.unsubscribe(L),O.on.ready.unsubscribe(k)}))})}}),this.Collection=(h=this,Wo(cm.prototype,function($,k){this.db=h;var C=Sl,O=null;if(k)try{C=k()}catch(A){O=A}var R=$._ctx,k=R.table,$=k.hook.reading.fire;this._ctx={table:k,index:R.index,isPrimKey:!R.index||k.schema.primKey.keyPath&&R.index===k.schema.primKey.name,range:C,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:O,or:R.or,valueMapper:$!==Fo?$:null}})),this.Table=(g=this,Wo(xl.prototype,function(S,L,C){this.db=g,this._tx=C,this.name=S,this.schema=L,this.hook=g._allTables[S]?g._allTables[S].hook:zo(null,{creating:[Zp,_e],reading:[Xp,Fo],updating:[tm,_e],deleting:[em,_e]})})),this.Transaction=(y=this,Wo(dm.prototype,function(S,L,C,O,R){var k=this;this.db=y,this.mode=S,this.storeNames=L,this.schema=C,this.chromeTransactionDurability=O,this.idbtrans=null,this.on=zo(this,"complete","error","abort"),this.parent=R||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Q(function($,A){k._resolve=$,k._reject=A}),this._completion.then(function(){k.active=!1,k.on.complete.fire()},function($){var A=k.active;return k.active=!1,k.on.error.fire($),k.parent?k.parent._reject($):A&&k.idbtrans&&k.idbtrans.abort(),qe($)})})),this.Version=(b=this,Wo(ym.prototype,function(S){this.db=b,this._cfg={version:S,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(I=this,Wo(Rl.prototype,function(S,L,C){if(this.db=I,this._ctx={table:S,index:L===":id"?null:L,or:C},this._cmp=this._ascending=ve,this._descending=function(O,R){return ve(R,O)},this._max=function(O,R){return 0<ve(O,R)?O:R},this._min=function(O,R){return ve(O,R)<0?O:R},this._IDBKeyRange=I._deps.IDBKeyRange,!this._IDBKeyRange)throw new oe.MissingAPI})),this.on("versionchange",function(S){0<S.newVersion?console.warn("Another connection wants to upgrade database '".concat(l.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(l.name,"'. Closing db now to resume the delete request.")),l.close({disableAutoOpen:!1})}),this.on("blocked",function(S){!S.newVersion||S.newVersion<S.oldVersion?console.warn("Dexie.delete('".concat(l.name,"') was blocked")):console.warn("Upgrade '".concat(l.name,"' blocked by other connection holding version ").concat(S.oldVersion/10))}),this._maxKey=Yo(s.IDBKeyRange),this._createTransaction=function(S,L,C,O){return new l.Transaction(S,L,C,l._options.chromeTransactionDurability,O)},this._fireOnBlocked=function(S){l.on("blocked").fire(S),qn.filter(function(L){return L.name===l.name&&L!==l&&!L._state.vcFired}).map(function(L){return L.on("versionchange").fire(S)})},this.use(Sm),this.use(xm),this.use(Em),this.use(wm),this.use(_m);var P=new Proxy(this,{get:function(S,L,C){if(L==="_vip")return!0;if(L==="table")return function(R){return Sa(l.table(R),P)};var O=Reflect.get(S,L,C);return O instanceof xl?Sa(O,P):L==="tables"?O.map(function(R){return Sa(R,P)}):L==="_createTransaction"?function(){return Sa(O.apply(this,arguments),P)}:O}});this.vip=P,f.forEach(function(S){return S(l)})}var Ea,Dt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",km=(_c.prototype.subscribe=function(i,s,l){return this._subscribe(i&&typeof i!="function"?i:{next:i,error:s,complete:l})},_c.prototype[Dt]=function(){return this},_c);function _c(i){this._subscribe=i}try{Ea={indexedDB:a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,IDBKeyRange:a.IDBKeyRange||a.webkitIDBKeyRange}}catch{Ea={indexedDB:null,IDBKeyRange:null}}function Wl(i){var s,l=!1,f=new km(function(h){var g=Me(i),y,b=!1,I={},x={},P={get closed(){return b},unsubscribe:function(){b||(b=!0,y&&y.abort(),S&&Mr.storagemutated.unsubscribe(C))}};h.start&&h.start(P);var S=!1,L=function(){return Ys(O)},C=function(R){ba(I,R),hc(x,I)&&L()},O=function(){var R,k,$;!b&&Ea.indexedDB&&(I={},R={},y&&y.abort(),y=new AbortController,$=function(A){var T=Tn();try{g&&Bn();var N=Pr(i,A);return N=g?N.finally(Rr):N}finally{T&&Nn()}}(k={subscr:R,signal:y.signal,requery:L,querier:i,trans:null}),Promise.resolve($).then(function(A){l=!0,s=A,b||k.signal.aborted||(I={},function(T){for(var N in T)if(v(T,N))return;return 1}(x=R)||S||(Mr(Go,C),S=!0),Ys(function(){return!b&&h.next&&h.next(A)}))},function(A){l=!1,["DatabaseClosedError","AbortError"].includes(A==null?void 0:A.name)||b||Ys(function(){b||h.error&&h.error(A)})}))};return setTimeout(L,0),P});return f.hasValue=function(){return l},f.getValue=function(){return s},f}var cn=sr;function Sc(i){var s=Ar;try{Ar=!0,Mr.storagemutated.fire(i),gc(i,!0)}finally{Ar=s}}w(cn,n(n({},Xi),{delete:function(i){return new cn(i,{addons:[]}).delete()},exists:function(i){return new cn(i,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(i){try{return s=cn.dependencies,l=s.indexedDB,s=s.IDBKeyRange,(lc(l)?Promise.resolve(l.databases()).then(function(f){return f.map(function(h){return h.name}).filter(function(h){return h!==sa})}):uc(l,s).toCollection().primaryKeys()).then(i)}catch{return qe(new oe.MissingAPI)}var s,l},defineClass:function(){return function(i){d(this,i)}},ignoreTransaction:function(i){return te.trans?nn(te.transless,i):i()},vip:dc,async:function(i){return function(){try{var s=vc(i.apply(this,arguments));return s&&typeof s.then=="function"?s:Q.resolve(s)}catch(l){return qe(l)}}},spawn:function(i,s,l){try{var f=vc(i.apply(l,s||[]));return f&&typeof f.then=="function"?f:Q.resolve(f)}catch(h){return qe(h)}},currentTransaction:{get:function(){return te.trans||null}},waitFor:function(i,s){return s=Q.resolve(typeof i=="function"?cn.ignoreTransaction(i):i).timeout(s||6e4),te.trans?te.trans.waitFor(s):s},Promise:Q,debug:{get:function(){return Yt},set:function(i){ml(i)}},derive:D,extend:d,props:w,override:G,Events:zo,on:Mr,liveQuery:Wl,extendObservabilitySet:ba,getByKeyPath:Z,setByKeyPath:ne,delByKeyPath:function(i,s){typeof s=="string"?ne(i,s,void 0):"length"in s&&[].map.call(s,function(l){ne(i,l,void 0)})},shallowClone:pe,deepClone:be,getObjectDiff:yc,cmp:ve,asap:ie,minKey:-1/0,addons:[],connections:qn,errnames:js,dependencies:Ea,cache:sn,semVer:"4.0.10",version:"4.0.10".split(".").map(function(i){return parseInt(i)}).reduce(function(i,s,l){return i+s/Math.pow(10,2*l)})})),cn.maxKey=Yo(cn.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Mr(Go,function(i){Ar||(i=new CustomEvent(rc,{detail:i}),Ar=!0,dispatchEvent(i),Ar=!1)}),addEventListener(rc,function(i){i=i.detail,Ar||Sc(i)}));var Un,Ar=!1,Vl=function(){};return typeof BroadcastChannel<"u"&&((Vl=function(){(Un=new BroadcastChannel(rc)).onmessage=function(i){return i.data&&Sc(i.data)}})(),typeof Un.unref=="function"&&Un.unref(),Mr(Go,function(i){Ar||Un.postMessage(i)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(i){if(!sr.disableBfCache&&i.persisted){Yt&&console.debug("Dexie: handling persisted pagehide"),Un!=null&&Un.close();for(var s=0,l=qn;s<l.length;s++)l[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(i){!sr.disableBfCache&&i.persisted&&(Yt&&console.debug("Dexie: handling persisted pageshow"),Vl(),Sc({all:new ot(-1/0,[[]])}))})),Q.rejectionMapper=function(i,s){return!i||i instanceof ge||i instanceof TypeError||i instanceof SyntaxError||!i.name||!pl[i.name]?i:(s=new pl[i.name](s||i.message,i),"stack"in i&&E(s,"stack",{get:function(){return this.inner.stack}}),s)},ml(Yt),n(sr,Object.freeze({__proto__:null,Dexie:sr,liveQuery:Wl,Entity:El,cmp:ve,PropModSymbol:ar,PropModification:Vo,replacePrefix:function(i,s){return new Vo({replacePrefix:[i,s]})},add:function(i){return new Vo({add:i})},remove:function(i){return new Vo({remove:i})},default:sr,RangeSet:ot,mergeRanges:Zo,rangesOverlap:Tl}),{default:sr}),sr})}(qa)),qa.exports}var k_=x_();const Su=I_(k_),Fd=Symbol.for("Dexie"),as=globalThis[Fd]||(globalThis[Fd]=Su);if(Su.semVer!==as.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Su.semVer} and ${as.semVer}`);const{liveQuery:NE,mergeRanges:BE,rangesOverlap:qE,RangeSet:FE,cmp:jE,Entity:UE,PropModSymbol:KE,PropModification:HE,replacePrefix:zE,add:WE,remove:VE}=as;var ss="docs",D_="changes",jd="attachments",Op="dexie",Ud=new Map,Fa=new Map;function O_(e,t,r,n){var o="rxdb-dexie-"+e+"--"+n.version+"--"+t,a=zt(Ud,o,()=>{var c=(async()=>{var u=Ne(r);u.autoOpen=!1;var d=new as(o,u);r.onCreate&&await r.onCreate(d,o);var p={[ss]:L_(n),[D_]:"++sequence, id",[jd]:"id"};return d.version(1).stores(p),await d.open(),{dexieDb:d,dexieTable:d[ss],dexieAttachmentsTable:d[jd],booleanIndexes:$_(n)}})();return Ud.set(o,a),Fa.set(a,0),c});return a}async function P_(e){var t=await e,r=Fa.get(e),n=r-1;n===0?(t.dexieDb.close(),Fa.delete(e)):Fa.set(e,n)}var Eu="__";function Bo(e){var t=e.split(".");if(t.length>1)return t.map(n=>Bo(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return Eu+r}else return e}function Pp(e){var t=e.split(".");if(t.length>1)return t.map(n=>Pp(n)).join(".");if(e.startsWith(Eu)){var r=e.substring(Eu.length);return"|"+r}else return e}function R_(e,t){if(!t)return t;var r=Ne(t);return r=Iu(r),e.forEach(n=>{var o=Gr(t,n),a=o?"1":"0",c=Bo(n);Pf(r,c,a)}),r}function Rp(e,t){return t&&(t=Ne(t),t=Cu(t),e.forEach(r=>{var n=Gr(t,r),o=n==="1";Pf(t,r,o)}),t)}function Iu(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Iu(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=Iu(n)),t[Bo(r)]=n}),t}}function Cu(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Cu(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=Cu(n)),t[Pp(r)]=n}),t}}function L_(e){var t=[],r=It(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(a=>{var c=Au(a);t.push(c)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(a=>a.map(c=>Bo(c)));var n=t.map(a=>a.length===1?a[0]:"["+a.join("+")+"]");n=n.filter((a,c,u)=>u.indexOf(a)===c);var o=n.join(", ");return o}async function Kd(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(o=>Rp(r.booleanIndexes,o))}function Da(e,t){return e+"||"+t}function $_(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var o=Au(n);o.forEach(a=>{if(!t.has(a)){t.add(a);var c=xo(e,a);c.type==="boolean"&&r.push(a)}})}),r.push("_deleted"),Pg(r)):r}function Hd(e){return e===eo?-1/0:e}function zd(e,t,r){if(e.includes(t)){var n=r===Zn||r===!0?"1":"0";return n}else return r}function Lp(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((c,u)=>{var d=t.index[u];return zd(e,d,c)}).map(Hd),o=t.endKeys.map((c,u)=>{var d=t.index[u];return zd(e,d,c)}).map(Hd),a=r.bound(n,o,!t.inclusiveStart,!t.inclusiveEnd);return a}async function Wd(e,t){var r=await e.internals,n=t.query,o=n.skip?n.skip:0,a=n.limit?n.limit:1/0,c=o+a,u=t.queryPlan,d=!1;u.selectorSatisfiedByIndex||(d=Gu(e.schema,t.query));var p=Lp(r.booleanIndexes,u,r.dexieDb._options.IDBKeyRange),m=u.index,v=[];if(await r.dexieDb.transaction("r",r.dexieTable,async _=>{var E=_.idbtrans,D=E.objectStore(ss),M,B;B="["+m.map(G=>Bo(G)).join("+")+"]",M=D.index(B);var q=M.openCursor(p);await new Promise(G=>{q.onsuccess=function(ae){var ie=ae.target.result;if(ie){var Z=Rp(r.booleanIndexes,ie.value);(!d||d(Z))&&v.push(Z),u.sortSatisfiedByIndex&&v.length===c?G():ie.continue()}else G()}})}),!u.sortSatisfiedByIndex){var w=Hh(e.schema,t.query);v=v.sort(w)}return v=v.slice(o,c),{documents:v}}async function M_(e,t){var r=await e.internals,n=t.queryPlan,o=n.index,a=Lp(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),c=-1;return await r.dexieDb.transaction("r",r.dexieTable,async u=>{var d=u.idbtrans,p=d.objectStore(ss),m,v;v="["+o.map(_=>Bo(_)).join("+")+"]",m=p.index(v);var w=m.count(a);c=await new Promise((_,E)=>{w.onsuccess=function(){_(w.result)},w.onerror=D=>E(D)})}),c}var A_=Et(),jc=!1,T_=function(){function e(r,n,o,a,c,u,d,p){this.changes$=new Mt,this.instanceId=A_++,this.storage=r,this.databaseName=n,this.collectionName=o,this.schema=a,this.internals=c,this.options=u,this.settings=d,this.devMode=p,this.primaryPath=It(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,o){ln(this),!jc&&!await Lf()&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium/?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),jc=!0,n.forEach(m=>{if(!m.document._rev||m.previous&&!m.previous._rev)throw X("SNH",{args:{row:m}})});var a=await this.internals,c={error:[]};this.devMode&&(n=n.map(m=>{var v=Gi(m.document);return{previous:m.previous,document:v}}));var u=n.map(m=>m.document[this.primaryPath]),d;if(await a.dexieDb.transaction("rw",a.dexieTable,a.dexieAttachmentsTable,async()=>{var m=new Map,v=await Kd(this.internals,u);v.forEach(E=>{var D=E;return D&&m.set(D[this.primaryPath],D),D}),d=hb(this,this.primaryPath,m,n,o),c.error=d.errors;var w=[];d.bulkInsertDocs.forEach(E=>{w.push(E.document)}),d.bulkUpdateDocs.forEach(E=>{w.push(E.document)}),w=w.map(E=>R_(a.booleanIndexes,E)),w.length>0&&await a.dexieTable.bulkPut(w);var _=[];d.attachmentsAdd.forEach(E=>{_.push({id:Da(E.documentId,E.attachmentId),data:E.attachmentData.data})}),d.attachmentsUpdate.forEach(E=>{_.push({id:Da(E.documentId,E.attachmentId),data:E.attachmentData.data})}),await a.dexieAttachmentsTable.bulkPut(_),await a.dexieAttachmentsTable.bulkDelete(d.attachmentsRemove.map(E=>Da(E.documentId,E.attachmentId)))}),d=de(d),d.eventBulk.events.length>0){var p=de(d.newestRow).document;d.eventBulk.checkpoint={id:p[this.primaryPath],lwt:p._meta.lwt},this.changes$.next(d.eventBulk)}return c},t.findDocumentsById=async function(n,o){ln(this);var a=await this.internals,c=[];return await a.dexieDb.transaction("r",a.dexieTable,async()=>{var u=await Kd(this.internals,n);u.forEach(d=>{d&&(!d._deleted||o)&&c.push(d)})}),c},t.query=function(n){return ln(this),Wd(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var o=await M_(this,n);return{count:o,mode:"fast"}}else{var a=await Wd(this,n);return{count:a.documents.length,mode:"slow"}}},t.changeStream=function(){return ln(this),this.changes$.asObservable()},t.cleanup=async function(n){ln(this);var o=await this.internals;return await o.dexieDb.transaction("rw",o.dexieTable,async()=>{var a=Et()-n,c=await o.dexieTable.where("_meta.lwt").below(a).toArray(),u=[];c.forEach(d=>{d._deleted==="1"&&u.push(d[this.primaryPath])}),await o.dexieTable.bulkDelete(u)}),!0},t.getAttachmentData=async function(n,o,a){ln(this);var c=await this.internals,u=Da(n,o);return await c.dexieDb.transaction("r",c.dexieAttachmentsTable,async()=>{var d=await c.dexieAttachmentsTable.get(u);if(d)return d.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+o)})},t.remove=async function(){ln(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await P_(this.internals)})(),this.closed)},e}();async function N_(e,t,r){var n=O_(t.databaseName,t.collectionName,r,t.schema),o=new T_(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await S_(Op,t,o),Promise.resolve(o)}function ln(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var B_=function(){function e(r){this.name=Op,this.rxdbVersion=Rf,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){if(gb(n),n.schema.indexes){var o=n.schema.indexes.flat();o.filter(a=>!a.includes(".")).forEach(a=>{if(!n.schema.required||!n.schema.required.includes(a))throw X("DXE1",{field:a,schema:n.schema})})}return N_(this,n,this.settings)},e}();function $p(e={}){var t=new B_(e);return t}var q_=["__proto__","constructor","prototype"];function oi(e,t){Object.keys(t).forEach(r=>{q_.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:ui(t[r])?oi(e[r],t[r]):e[r]=t[r])})}function ui(e){return e.toString()==="[object Object]"}var Ts=function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var o=this;r.selector&&o.find(r.selector),r.limit&&o.limit(r.limit),r.skip&&o.skip(r.skip),r.sort&&r.sort.forEach(a=>o.sort(a))}}var t=e.prototype;return t.where=function(n,o){if(!arguments.length)return this;var a=typeof arguments[0];if(a==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(a==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw Pt("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var o=this._path;return this._conditions[o]=n,this},t.eq=function(n){this._ensurePath("eq");var o=this._path;return this._conditions[o]=n,this},t.or=function(n){var o=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),o.push.apply(o,n),this},t.nor=function(n){var o=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),o.push.apply(o,n),this},t.and=function(n){var o=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),o.push.apply(o,n),this},t.mod=function(n,o){var a,c;arguments.length===1?(this._ensurePath("mod"),a=arguments[0],c=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),a=arguments.slice(),c=this._path):arguments.length===3?(a=arguments.slice(1),c=arguments[0]):(a=arguments[1],c=arguments[0]);var u=this._conditions[c]||(this._conditions[c]={});return u.$mod=a,this},t.exists=function(n,o){var a,c;arguments.length===0?(this._ensurePath("exists"),a=this._path,c=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),a=this._path,c=arguments[0]):(a=arguments[0],c=!0):arguments.length===2&&(a=arguments[0],c=arguments[1]);var u=this._conditions[a]||(this._conditions[a]={});return u.$exists=c,this},t.elemMatch=function(n,o){if(arguments[0]===null)throw Pt("MQ2");var a,c,u;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),c=this._path,a=arguments[0];else if(ui(arguments[0]))this._ensurePath("elemMatch"),c=this._path,u=arguments[0];else if(typeof arguments[1]=="function")c=arguments[0],a=arguments[1];else if(arguments[1]&&ui(arguments[1]))c=arguments[0],u=arguments[1];else throw Pt("MQ2");a&&(u=new e,a(u),u=u._conditions);var d=this._conditions[c]||(this._conditions[c]={});return d.$elemMatch=u,this},t.sort=function(n){if(!n)return this;var o,a=typeof n;if(Array.isArray(n)){o=n.length;for(var c=0;c<n.length;++c)j_(this.options,n[c][0],n[c][1]);return this}if(arguments.length===1&&a==="string"){n=n.split(/\s+/),o=n.length;for(var u=0;u<o;++u){var d=n[u];if(d){var p=d[0]==="-"?-1:1;p===-1&&(d=d.substring(1)),Vd(this.options,d,p)}}return this}if(ui(n)){var m=Object.keys(n);return m.forEach(v=>Vd(this.options,v,n[v])),this}throw Pt("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!Qd(n))throw Pt("MQ4",{source:n});return n instanceof e?(n._conditions&&oi(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),oi(this._fields,n._fields)),n.options&&(this.options||(this.options={}),oi(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(oi(this._conditions,n),this)},t.find=function(n){return Qd(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw X("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=F_(this.options.sort)),{query:n,path:this._path}},e}();function F_(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",o={[t]:n};return o})}var Mp=["limit","skip","maxScan","batchSize","comment"];Mp.forEach(function(e){Ts.prototype[e]=function(t){return this.options[e]=t,this}});var Ap=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];Ap.forEach(function(e){Ts.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw X("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function Vd(e,t,r){if(Array.isArray(e.sort))throw Pt("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var o=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(o))throw Array.isArray(r)&&(r="["+r+"]"),Pt("MQ7",{field:t,value:r});var a=e.sort||(e.sort={}),c=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");a[t]=parseInt(c,10)}function j_(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw Pt("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function Qd(e){return e instanceof Ts||ui(e)}function U_(e,t){return new Ts(e,t)}var Gd="queryBuilderPath";function K_(e,t,r){var n=U_(dt(e.mangoQuery),e.other[Gd]);n[t](r);var o=n.toJSON();return Wn(e.op,o.query,e.collection,{...e.other,[Gd]:o.path})}function Uc(e,t){e[t]=function(r){if(Se.isDevMode()&&this.op==="findByIds")throw X("QU17",{collection:this.collection.name,query:this.mangoQuery});return K_(this,t,r)}}var H_={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{Uc(e,t)}),Mp.forEach(t=>{Uc(e,t)}),Ap.forEach(t=>{Uc(e,t)})}}};async function Tp(e){var t=av(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>Lo(n,Sn)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function z_(e,t,r){var n=Ne(r._attachments),o=dt(r),a=o._meta;delete o._meta,o._attachments=n;for(var c=t+1,u=Promise.resolve(o),d=function(){var p=c;u=u.then(m=>W_(e,p,m)),c++};c<=e.schema.version;)d();return u.then(p=>p===null?Nu:(p._meta=a,p))}function W_(e,t,r){if(r===null)return Nu;var n=e.migrationStrategies[t](r,e),o=Bg(n);return o}async function Np(e){if(e.collection.schema.version===0)return Sr;var t=await Tp(e);return!!t}var V_=200,Bp=new WeakMap;function Q_(e){var t=qp(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function qp(e){return zt(Bp,e,()=>new Tr([]))}function G_(e){var t=Bp.get(e);t&&t.complete()}var Y_=function(){function e(r,n,o=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=qg,this.collection=r,this.migrationStrategies=n,this.statusDocKey=o,this.database=r.database,this.oldCollectionMeta=Tp(this),this.mustMigrate=Np(this),this.statusDocId=Lo(this.statusDocKey,Ta),Q_(this),this.$=fb(this.database.internalStore,this.statusDocId).pipe(ke(a=>!!a),He(a=>de(a).data),Hi(qi))}var t=e.prototype;return t.getStatus=function(){return _n(this.$)},t.startMigration=async function(n=V_){var o=await this.mustMigrate;if(o){if(this.started)throw X("DM1");this.started=!0;var a=void 0;if(this.database.multiInstance){a=new As(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var c=w_(a);await c.awaitLeadership()}var u=await this.oldCollectionMeta,d=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:u.data.schema,password:this.database.password,devMode:Se.isDevMode()}),p=await this.getConnectedStorageInstances(),m=await this.countAllDoucments([d].concat(p.map(v=>v.oldStorage)));await this.updateStatus(v=>(v.count.total=m,v));try{await Promise.all(p.map(async v=>{await Aw(this.collection,v.newStorage.collectionName,v.newStorage.schema),await this.migrateStorage(v.oldStorage,v.newStorage,n),await v.newStorage.close()})),await this.migrateStorage(d,this.collection.storageInstance.originalStorageInstance,n)}catch(v){await d.close(),await this.updateStatus(w=>(w.status="ERROR",w.error=zg(v),w));return}await Ri(this.database.internalStore,{previous:u,document:Object.assign({},u,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(v=>(v.status="DONE",v)),a&&await a.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var o=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var a=await Qi(this.database.internalStore,this.statusDocId),c=dt(a);a||(c={id:this.statusDocId,key:this.statusDocKey,context:Ta,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:Ao(),_rev:Ht(),_attachments:{}});var u=de(c).data;for(var d of o)u=d(u);if(u.count.percent=Math.round(u.count.handled/u.count.total*100),c&&a&&wi(c.data,a.data))break;try{await Ri(this.database.internalStore,{previous:a,document:de(c)},Ta);break}catch(p){if(!ks(p))throw p}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,o,a){var c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:Ld(n.schema,pu(n.schema)),password:this.database.password,devMode:Se.isDevMode()}),u=u0(o,ts,this.database.token,!0),d=a0({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async m=>{m=await Promise.all(m.map(async w=>{var _=w.newDocumentState;if(o.schema.title===Ba&&(_=w.newDocumentState.docData,w.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:w.newDocumentState};var E=await z_(this.collection,n.schema.version,_),D={assumedMasterState:void 0,newDocumentState:o.schema.title===Ba?Object.assign({},w.newDocumentState,{docData:E}):E};return D})),m=m.filter(w=>!!w.newDocumentState);var v=await u.masterWrite(m);return v},masterChangeStream$:new Mt().asObservable()},forkInstance:n,metaInstance:c,pushBatchSize:a,pullBatchSize:0,conflictHandler:ts,hashFunction:this.database.hashFunction}),p=!1;if(d.events.error.subscribe(m=>p=m),d.events.processed.up.subscribe(()=>{this.updateStatus(m=>(m.count.handled=m.count.handled+1,m))}),await s0(d),await c0(d),await l0(d),await this.updateStatusQueue,p)throw await c.close(),p;await Promise.all([n.remove(),c.remove()])},t.countAllDoucments=async function(n){var o=0;return await Promise.all(n.map(async a=>{var c=Ls(a.schema,ro(a.schema,{selector:{}})),u=await a.count(c);o+=u.count})),o},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,o=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async a=>{if(a.schema.title!==Ba)throw new Error("unknown migration handling for schema");var c=Ld(dt(this.collection.schema.jsonSchema),pu(a.schema));c.version=this.collection.schema.version;var[u,d]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Se.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:a.schema,password:this.database.password,collectionName:a.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Se.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:c,password:this.database.password,collectionName:a.collectionName})]);o.push({oldStorage:u,newStorage:d})}))),o},t.migratePromise=async function(n){this.startMigration(n);var o=await this.mustMigrate;if(!o)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var a=await Promise.race([_n(this.$.pipe(ke(c=>c.status==="DONE"))),_n(this.$.pipe(ke(c=>c.status==="ERROR")))]);if(a.status==="ERROR")throw X("DM4",{collection:this.collection.name,error:a.error});return a},e}(),J_=Qh(),X_=function(e){function t(r,n,o){var a;return a=e.call(this,null,n)||this,a.id=r,a.parent=o,a}return Bu(t,e),t}(J_),li={get isLocal(){return!0},get allAttachments$(){throw X("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=Co(xu,this.parent),r=this.primary;return e.parent.eventBulks$.pipe(ke(n=>!!n.isLocal),He(n=>n.events.find(o=>o.documentId===r)),ke(n=>!!n),He(n=>oh(de(n))),zi(t.docCache.getLatestDocumentData(this.primary)),Ei((n,o)=>n._rev===o._rev),He(n=>t.docCache.getCachedRxDocument(n)),Hi(qi))},get $$(){var e=this,t=Kc(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=Kc(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=Co(xu,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw Pt("LD2",{objPath:e});var t=Gr(this._data,e);return t=Se.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,Se.isDevMode()){if(e.includes(".item."))throw X("LD3",{objPath:e});if(e===this.primaryPath)throw X("LD4")}return this.$.pipe(He(t=>t._data),He(t=>Gr(t,e)),Ei())},get$$(e){var t=Kc(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await di(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await di(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(o=>{if(o.error[0])throw o.error[0];var a=qt(this.collection.schema.primaryPath,n,o)[0];e=Ne(e),e._rev=a._rev})},async remove(){var e=await di(this.parent),t=Ne(this._data);return t._deleted=!0,Ri(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},Yd=!1,Z_=()=>{if(!Yd){Yd=!0;var e=$s,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var o=Object.getOwnPropertyDescriptor(li,n);if(!o){var a=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(li,n,a)}});var r=n=>()=>{throw X("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>li[n]=r(n))}};function eS(e,t){Z_();var r=new X_(e.id,e,t);return Object.setPrototypeOf(r,li),r.prototype=li,r}function Kc(e){var t=e.parent;return Zw(t)?t:t.database}var cs=new WeakMap,xu=new WeakMap;function Jd(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var o=await Fp(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);o=Yu(t,o,jp);var a=new tp("id",t.eventBulks$.pipe(ke(m=>{var v=!1;return(r===""&&!m.collectionName||r!==""&&m.collectionName===r)&&(v=!0),v&&m.isLocal}),He(m=>m.events)),m=>eS(m,e)),c=new Vh(o,"id",()=>{},()=>{}),u=await t.storageToken,d=o.changeStream().subscribe(m=>{for(var v=new Array(m.events.length),w=m.events,_=e.database?e.name:void 0,E=0;E<w.length;E++){var D=w[E];v[E]={documentId:D.documentId,collectionName:_,isLocal:!0,operation:D.operation,documentData:Se.deepFreezeWhenDevMode(D.documentData),previousDocumentData:Se.deepFreezeWhenDevMode(D.previousDocumentData)}}var M={id:m.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:u,events:v,databaseToken:t.token,checkpoint:m.checkpoint,context:m.context};t.$emit(M)});e._subs.push(d);var p={database:t,parent:e,storageInstance:o,docCache:a,incrementalWriteQueue:c};return xu.set(e,p),p})();cs.set(e,n)}function di(e){var t=cs.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw X("LD8",{database:r.name,collection:n})}return t}function Fp(e,t,r,n,o,a){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:tS(n),schema:jp,options:o,multiInstance:a,devMode:Se.isDevMode()})}function Xd(e){var t=cs.get(e);if(t)return cs.delete(e),t.then(r=>r.storageInstance.close())}async function Zd(e,t,r){var n=Bi(10),o=await Fp(n,e,t,r,{},!1);await o.remove()}function tS(e){return"plugin-local-documents-"+e}var jp=Ds({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function ef(e,t){var r=await di(this),n={id:e,data:t,_deleted:!1,_meta:Ao(),_rev:Ht(),_attachments:{}};return Ri(r.storageInstance,{document:n},"local-document-insert").then(o=>r.docCache.getCachedRxDocument(o))}function tf(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function rf(e){var t=await di(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):Qi(t.storageInstance,e).then(o=>o?t.docCache.getCachedRxDocument(o):null)}function nf(e){return this.$.pipe(zi(null),Ir(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),Ir(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),ke(t=>t.use),He(t=>t.doc))}var rS={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=ef,e.upsertLocal=tf,e.getLocal=rf,e.getLocal$=nf},RxDatabase:e=>{e.insertLocal=ef,e.upsertLocal=tf,e.getLocal=rf,e.getLocal$=nf}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&Jd(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&Jd(e.collection)}},preCloseRxDatabase:{after:e=>Xd(e)},postCloseRxCollection:{after:e=>Xd(e)},postRemoveRxDatabase:{after:e=>Zd(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>Zd(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},nS=new WeakMap,oS={name:"migration-schema",rxdb:!0,init(){Na(rS)},hooks:{preCloseRxDatabase:{after:G_}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return qp(this).pipe(Hi(qi))}},RxCollection:e=>{e.getMigrationState=function(){return zt(nS,this,()=>new Y_(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?Sr:Np(this.getMigrationState())}}}},iS=oS;const Ns=e=>ft((t,r,n)=>{let o=0;if(me(r))for(const a of r)o=o|1<<a;else o=r;return e(t&o,o)}),aS=Ns((e,t)=>e==0),sS=Ns((e,t)=>e==t),cS=Ns((e,t)=>e<t),uS=Ns((e,t)=>e>0),lS=Object.freeze(Object.defineProperty({__proto__:null,$all:ub,$and:kh,$bitsAllClear:aS,$bitsAllSet:sS,$bitsAnyClear:cS,$bitsAnySet:uS,$elemMatch:Fh,$eq:Ph,$exists:Uh,$expr:ab,$gt:Rh,$gte:Lh,$in:$h,$jsonSchema:sb,$lt:Mh,$lte:Ah,$mod:Bh,$ne:Th,$nin:Nh,$nor:Dh,$not:Oh,$or:Qu,$regex:qh,$size:jh,$type:Kh,$where:cb},Symbol.toStringTag,{value:"Module"})),ht={cloneMode:"copy",queryOptions:ph({context:Rn.init().addQueryOps(lS).addExpressionOps(Gy).addExpressionOps(nb)})},ul=(e,t)=>{switch(e){case"deep":return Ro(t);case"copy":return Oo(t)?new Date(t):me(t)?[...t]:ze(t)?{...t}:gr(t)?new RegExp(t):t;default:return t}},dS=/^[a-z]+[a-zA-Z0-9]*$/;function Up(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),o=e.substring(t+3,r);Ee(o===""||dS.test(o),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const a=e.substring(r+2),[c,u]=a?Up(a):[];return[{selector:e,parent:n,child:o||"$",next:c},[o,...u||[]].filter(Boolean)]}const mt=(e,t,r,n,o)=>{const{parent:a,child:c,next:u}=t;if(!c){let p=!1;return ki(e,a,(v,w)=>p=!!n(v,w)||p,o),p}const d=rr(e,a);return me(d)?d.map((p,m)=>r[c]&&!r[c].test({[c]:p})?!1:u?mt(p,u,r,n,o):n(d,m)).some(Boolean):!1};function xt(e,t,r,n){const o=[];for(const[a,c]of Object.entries(e)){const[u,d]=Up(a);if(!d.length)n(c,u,{})&&o.push(u.parent);else{const p={};t.forEach(v=>{Object.keys(v).forEach(w=>{d.forEach(_=>{(w===_||w.startsWith(_+"."))&&(p[_]=p[_]||{},Object.assign(p[_],{[w]:v[w]}))})})});const m={};for(const[v,w]of Object.entries(p))m[v]=new Xr(w,r.queryOptions);n(c,u,m)&&o.push(u.parent)}}return o}const fS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>{const u={$each:[o]};return ze(o)&&Vt(o,"$each")&&Object.assign(u,o),mt(e,a,c,(d,p)=>{const m=d[p]||(d[p]=[]);return lh([m,u.$each]).length===u.$each.length?!1:(d[p]=ul(n.cloneMode,yy(m.concat(u.$each))),!0)},{buildGraph:!0})}),hS=new Set(["and","or","xor"]),pS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>{const u=Object.keys(o);return Ee(u.length===1&&hS.has(u[0]),`Invalid bit operator '${u[0]}'. Must be one of 'and', 'or', or 'xor'.`),mt(e,a,c,(d,p)=>{let m=d[p];const v=o[u[0]];if(m!==void 0&&!(Xe(m)&&Xe(v)))return!1;switch(m=m||0,u[0]){case"and":d[p]=m&v;break;case"or":d[p]=m|v;break;case"xor":d[p]=m^v;break}return d[p]!==m},{buildGraph:!0})}),mS=(e,t,r=[],n=ht)=>{const o=Date.now();return xt(t,r,n,(a,c,u)=>mt(e,c,u,(d,p)=>(d[p]=o,!0),{buildGraph:!0}))},gS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>{if(!a.child){const u=rr(e,a.parent);Ee(u===void 0||Xe(u),"cannot apply $inc to a value of non-numeric type")}return mt(e,a,c,(u,d)=>(u[d]=(u[d]||(u[d]=0))+o,!0),{buildGraph:!0})}),vS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>mt(e,a,c,(u,d)=>u[d]!==void 0&&Bt(u[d],o)>-1?!1:(u[d]=o,!0),{buildGraph:!0})),yS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>mt(e,a,c,(u,d)=>u[d]!==void 0&&Bt(u[d],o)<1?!1:(u[d]=o,!0),{buildGraph:!0})),bS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>mt(e,a,c,(u,d)=>{const p=u[d];return u[d]=u[d]===void 0?0:u[d]*o,u[d]!==p},{buildGraph:!0})),wS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>mt(e,a,c,(u,d)=>{const p=u[d];return Ee(me(p),`path '${a.selector}' contains an element of non-array type.`),p.length?(o===-1?p.splice(0,1):p.pop(),!0):!1})),Kp=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>{const u=!ze(o)||Object.keys(o).some(Jr),d=new Xr(u?{k:o}:o,n.queryOptions),p=u?m=>d.test({k:m}):m=>d.test(m);return mt(e,a,c,(m,v)=>{const w=m[v],_=new Array;return w.map(D=>{const M=p(D);return M||_.push(D),M}).some(Boolean)?(m[v]=_,!0):!1})}),_S=(e,t,r=[],n=ht)=>{const o={};return Object.entries(t).forEach(([a,c])=>{o[a]={$in:c}}),Kp(e,o,r,n)},SS=Object.freeze(["$each","$slice","$sort","$position"]),ES=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>{const u={$each:[o]};return ze(o)&&SS.some(d=>Vt(o,d))&&Object.assign(u,o),mt(e,a,c,(d,p)=>{const m=d[p]||(d[p]=[]),v=m.slice(0,u.$slice||m.length),w=m.length,_=Xe(u.$position)?u.$position:m.length;if(m.splice(_,0,...ul(n.cloneMode,u.$each)),u.$sort){const E=ze(u.$sort)?Object.keys(u.$sort||{}).pop():"",D=E?u.$sort[E]:u.$sort,M=E?B=>rr(B,E):B=>B;m.sort((B,q)=>D*Bt(M(B),M(q)))}return Xe(u.$slice)&&(u.$slice<0?m.splice(0,m.length+u.$slice):m.splice(u.$slice)),w!=m.length||!Kt(v,m)},{descendArray:!0,buildGraph:!0})}),Hp=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>mt(e,a,c,(u,d)=>Kt(u[d],o)?!1:(u[d]=ul(n.cloneMode,o),!0),{buildGraph:!0})),IS=(e,t,r=[],n=ht)=>{const o=[],a=xt(t,r,n,(c,u,d)=>mt(e,u,d,(p,m)=>Vt(p,m)?(o.push(...Hp(e,{[c]:p[m]},r,n)),delete p[m],!0):!1));return Array.from(new Set(a.concat(o)))},CS=(e,t,r=[],n=ht)=>xt(t,r,n,(o,a,c)=>mt(e,a,c,(u,d)=>Vt(u,d)?(me(u)?u[d]=null:delete u[d],!0):!1)),of=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:fS,$bit:pS,$currentDate:mS,$inc:gS,$max:vS,$min:yS,$mul:bS,$pop:wS,$pull:Kp,$pullAll:_S,$push:ES,$rename:IS,$set:Hp,$unset:CS},Symbol.toStringTag,{value:"Module"}));function zp(e){return e=e??ht,(t,r,n=[],o={},a=e)=>{const c=Object.entries(r);Ee(c.length===1,"Update expression must contain only one operator.");const[u,d]=c[0];Ee(Vt(of,u),`Update operator '${u}' is not supported.`);const p=of[u];return Object.keys(o).length&&!new Xr(o,a.queryOptions).test(t)?[]:p(t,d,n,a)}}zp();var Hc;function Wp(e,t){if(!Hc){var r=zp({cloneMode:"none"});Hc=(n,o)=>{var a=dt(n);return r(a,o),a}}return Hc(e,t)}function xS(e){return this.incrementalModify(t=>{var r=Wp(t,e);return r})}function kS(e){var t=this._data,r=Wp(t,e);return this._saveData(r,t)}async function DS(e){return zn(this.asRxQuery,t=>t.update(e))}var OS={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=kS,e.incrementalUpdate=xS},RxQuery:e=>{e.update=DS}}};const Kn={OFF:0,ERROR:1,INFO:2,DEBUG:3};class Pe{constructor(t,r="debug"){this.module=t,this.level=Kn[r.toUpperCase()]}debug(t,r={}){this.level>=Kn.DEBUG&&console.debug(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}info(t,r={}){this.level>=Kn.INFO&&console.info(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}error(t,r={}){this.level>=Kn.ERROR&&console.error(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}setLevel(t){this.level=Kn[t.toUpperCase()]||Kn.OFF}}class re extends Error{constructor(t,r,n={}){super(r),this.code=t,this.details=n}}async function ee(e,t,r=`Operation timed out after ${t}ms`){const n=new Promise((o,a)=>setTimeout(()=>a(new re("TIMEOUT",r)),t));return Promise.race([e,n])}const PS=new Pe("Main");let no=null,us=null,ja=!1,ls;const RS=new Promise(e=>{ls=e}),LS={title:"chat history schema",version:0,description:"Stores chat sessions",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100},tabId:{type:"number"},timestamp:{type:"number"},title:{type:"string",maxLength:100},messages:{type:"array",items:{type:"object",properties:{messageId:{type:"string",maxLength:100},sender:{type:"string"},text:{type:"string"},timestamp:{type:"number"},isLoading:{type:"boolean",default:!1}},required:["messageId","sender","text","timestamp"]}},isStarred:{type:"boolean",default:!1},status:{type:"string",default:"idle"}},required:["id","timestamp","messages"],indexes:[["timestamp"]]};async function Ft(){if(!await ee(RS,5e3,"Database initialization timeout")||!us)throw new re("DB_NOT_READY","Database not initialized");return us}async function $S(){const e=new Pe("Reset");e.info("Resetting database due to initialization failure");try{no&&(await no.destroy(),e.debug("Existing database destroyed")),await $p().getDexieDb().delete(),e.info("Dexie database deleted"),no=null,us=null,ja=!1,ls(!1)}catch(t){throw console.error("[DB:Reset] CAUGHT RAW ERROR during reset:",t),e.error("Failed to reset database",{error:t}),new re("RESET_FAILED","Could not reset database",{originalError:t})}}async function Vp(e){const t=new Pe("Initialize");if(t.info("Handling initialize request"),ja){t.info("Already initialized, skipping");return}try{Na(H_),Na(iS),Na(OS),no=await ee(Jw({name:"tabagentdb",storage:$p()}),1e4),t.debug("Database created",{name:no.name}),us=(await no.addCollections({chatHistory:{schema:LS}})).chatHistory,t.debug("Chat history collection initialized");const n=[{event:So.name,handler:HS},{event:wr.name,handler:zS},{event:pi.name,handler:WS},{event:Lt.name,handler:VS},{event:Ha.name,handler:QS},{event:Qe.name,handler:GS},{event:_o.name,handler:YS},{event:gi.name,handler:JS},{event:vi.name,handler:XS},{event:Eo.name,handler:ZS},{event:Io.name,handler:eE}];n.forEach(({event:o,handler:a})=>V.subscribe(o,a)),t.debug("Event bus subscriptions complete",{count:n.length}),ja=!0,ls(!0),t.info("Initialization complete"),await V.publish(Ur.name,new Ur({success:!0}))}catch(r){console.error("[DB:Initialize] Entered CATCH block for init error."),console.error("[DB:Initialize] Raw Error Name:",r==null?void 0:r.name),console.error("[DB:Initialize] Raw Error Message:",r==null?void 0:r.message),console.error("[DB:Initialize] CAUGHT RAW ERROR OBJECT during init:",r);const n=r instanceof re?r:new re("INIT_FAILED","Database initialization failed",{originalError:r});t.error("Initialization failed",{error:n,details:r});try{await $S(),t.info("Attempting reinitialization after reset"),await Vp(e);return}catch(o){t.error("Reinitialization after reset failed",{error:o})}ja=!1,ls(!1),await V.publish(Ur.name,new Ur({success:!1,error:n}))}}function Qp(e){if(!e||typeof e!="string")throw new re("INVALID_INPUT","Chat ID must be a non-empty string");return`${e}-msg-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}function $i(e){return typeof e!="string"?e:e.replace(/[<>]/g,"")}async function MS(e){const t=new Pe("CreateSession");t.debug("Creating new chat session",{initialMessage:e});const r=await Ft();if(!e||!e.text)throw new re("INVALID_INPUT","Initial message with text is required");const n=Date.now(),o=crypto.randomUUID(),a={...e,text:$i(e.text),messageId:Qp(o),timestamp:e.timestamp||n,sender:e.sender||"user"},c={id:o,tabId:null,timestamp:n,title:$i(a.text.substring(0,30))+"...",messages:[a],isStarred:!1,status:"idle"};t.debug("Inserting session",{sessionId:o});const u=await ee(r.insert(c),3e3);return t.info("Session created",{sessionId:o}),await An(o),u}async function Gp(e){const t=new Pe("GetSession");if(t.debug("Getting session",{sessionId:e}),!e)throw new re("INVALID_INPUT","Session ID is required");const r=await Ft(),n=await ee(r.findOne(e).exec(),3e3);return n?(t.debug("Session retrieved",{sessionId:e}),n):(t.info("Session not found",{sessionId:e}),null)}async function AS(e,t){const r=new Pe("AddMessage");if(r.debug("Adding message",{chatId:e}),!e||!t||!t.text)throw new re("INVALID_INPUT","Chat ID and message with text are required");const n=await Ft(),o=await ee(n.findOne(e).exec(),3e3);if(!o)throw new re("NOT_FOUND",`Chat session ${e} not found`);const a={...t,text:$i(t.text),messageId:t.messageId||Qp(e),timestamp:t.timestamp||Date.now(),isLoading:t.isLoading??!1},c=await ee(o.incrementalPatch({messages:[...o.messages,a]}),3e3);return r.info("Message added",{chatId:e,messageId:a.messageId}),{updatedDoc:c,newMessageId:a.messageId}}async function TS(e,t,r){const n=new Pe("UpdateMessage");if(n.debug("Updating message",{chatId:e,messageId:t}),!e||!t||!r||!r.text)throw new re("INVALID_INPUT","Chat ID, message ID, and updates with text are required");const o=await Ft(),a=await ee(o.findOne(e).exec(),3e3);if(!a)throw new re("NOT_FOUND",`Chat session ${e} not found`);let c=!1;const u=await ee(a.incrementalModify(d=>{const p=d.messages.findIndex(v=>v.messageId===t);if(p===-1)return d;c=!0;const m=d.messages[p];return d.messages[p]={...m,...r,text:$i(r.text),messageId:m.messageId},d}),3e3);if(!c)throw new re("NOT_FOUND",`Message ${t} not found in chat ${e}`);return n.info("Message updated",{chatId:e,messageId:t}),await An(e),u}async function NS(e,t){const r=new Pe("DeleteMessage");if(r.debug("Deleting message",{sessionId:e,messageId:t}),!e||!t)throw new re("INVALID_INPUT","Session ID and message ID are required");const n=await Ft(),o=await ee(n.findOne(e).exec(),3e3);if(!o)throw new re("NOT_FOUND",`Session ${e} not found`);const a=o.messages.length,c=o.messages.filter(d=>d.messageId!==t);if(c.length===a)return r.info("Message not found",{sessionId:e,messageId:t}),{updatedDoc:o,deleted:!1};const u=await ee(o.incrementalPatch({messages:c}),3e3);return r.info("Message deleted",{sessionId:e,messageId:t}),await An(e),{updatedDoc:u,deleted:!0}}async function BS(e,t){const r=new Pe("UpdateStatus");if(r.debug("Updating status",{sessionId:e,newStatus:t}),!e||!["idle","processing","complete","error"].includes(t))throw new re("INVALID_INPUT",`Invalid session ID or status: ${t}`);const o=await Ft(),a=await ee(o.findOne(e).exec(),3e3);if(!a)throw new re("NOT_FOUND",`Session ${e} not found`);const c=await ee(a.incrementalPatch({status:t}),3e3);return r.info("Status updated",{sessionId:e,newStatus:t}),await An(e),c}async function qS(e){const t=new Pe("ToggleStar");if(t.debug("Toggling starred status",{itemId:e}),!e)throw new re("INVALID_INPUT","Item ID is required");const r=await Ft(),n=await ee(r.findOne(e).exec(),3e3);if(!n)throw new re("NOT_FOUND",`Item ${e} not found`);const o=n.get("isStarred")||!1,a=await ee(n.incrementalPatch({isStarred:!o}),3e3);return t.info("Starred status toggled",{itemId:e,isStarred:!o}),await An(e),a}async function FS(e){const t=new Pe("DeleteHistory");if(t.debug("Deleting history item",{itemId:e}),!e)throw new re("INVALID_INPUT","Item ID is required");const r=await Ft(),n=await ee(r.findOne(e).exec(),3e3);return n?(await ee(n.remove(),3e3),t.info("Item deleted",{itemId:e}),await An(e),!0):(t.info("Item not found",{itemId:e}),!1)}async function jS(e,t){const r=new Pe("RenameHistory");if(r.debug("Renaming history item",{itemId:e,newTitle:t}),!e||!t)throw new re("INVALID_INPUT","Item ID and new title are required");const n=await Ft(),o=await ee(n.findOne(e).exec(),3e3);if(!o)throw new re("NOT_FOUND",`Item ${e} not found`);const a=await ee(o.incrementalPatch({title:$i(t)}),3e3);return r.info("Item renamed",{itemId:e,newTitle:t}),await An(e),a}async function US(){const e=new Pe("GetAllSessions");e.debug("Getting all sessions");const t=await Ft(),n=(await ee(t.find().sort({timestamp:"desc"}).exec(),5e3)).map(o=>o.toJSON());return e.info("Retrieved sessions",{count:n.length}),n}async function KS(){const e=new Pe("GetStarredSessions");e.debug("Getting starred sessions");const t=await Ft(),r=await ee(t.find({selector:{isStarred:!0}}).sort({timestamp:"desc"}).exec(),5e3);return e.info("Retrieved starred sessions",{count:r.length}),r}async function An(e,t="update"){const r=new Pe("SessionUpdate");r.debug(`Attempting to publish session update for ${e}, type: ${t}`);try{await Ft();const n=await Gp(e);if(!n){r.error("Session not found after update, cannot publish notification",{sessionId:e});return}const o=n.toJSON?n.toJSON():n;r.info(`Publishing session update notification for ${e}`),await V.publish(xn.name,new xn(e,o,t)),r.debug("Session update published",{sessionId:e,updateType:t})}catch(n){r.error("Failed to publish session update",{sessionId:e,error:n})}}async function HS(e){var n;const t=new Pe("CreateSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling session creation",{requestId:r});try{if(!(e!=null&&e.requestId)||!((n=e==null?void 0:e.payload)!=null&&n.initialMessage)||!e.payload.initialMessage.text)throw new re("INVALID_INPUT","Missing requestId, initialMessage, or message text");const o=await ee(MS(e.payload.initialMessage),5e3);if(!(o!=null&&o.id))throw new re("INVALID_DOCUMENT","Invalid session document returned");await ee(Promise.all([V.publish(et.name,new et(o.id,o.messages)),V.publish(er.name,new er(o.id,o.status))]),3e3);const a=new go(r,!0,o.id);console.log(`[DB:${t.module}] PRE-PUBLISH Check (Success Path): ReqID ${r}, Response Success: ${a==null?void 0:a.success}, Response Type: ${a==null?void 0:a.type}`),await ee(V.publish(a.type,a),3e3),t.info("Session created successfully",{requestId:r,sessionId:o.id})}catch(o){const a=o instanceof re?o:new re("UNKNOWN","Failed to create session",{originalError:o}),c=new go(r,!1,null,a);console.log(`[DB:${t.module}] PRE-PUBLISH Check (Error Path): ReqID ${r}, Response Success: ${c==null?void 0:c.success}, Response Type: ${c==null?void 0:c.type}`);try{await ee(V.publish(c.type,c),3e3)}catch(u){t.error("FATAL: Failed even to publish error response!",{requestId:r,publishError:u})}t.error("Session creation failed",{requestId:r,error:a})}}async function zS(e){var n;const t=new Pe("GetSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new re("INVALID_INPUT","Session ID is required");const o=await ee(Gp(e.payload.sessionId),5e3),a=new uo(r,!0,o?o.toJSON():null);await ee(V.publish(a.type,a),3e3),t.info("Session retrieved",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const a=o instanceof re?o:new re("UNKNOWN","Failed to get session",{originalError:o}),c=new uo(r,!1,null,a);await ee(V.publish(c.type,c),3e3),t.error("Get session failed",{requestId:r,error:a})}}async function WS(e){var n,o;const t=new Pe("AddMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling add message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.messageObject)||!e.payload.messageObject.text)throw new re("INVALID_INPUT","Session ID and message with text are required");const{updatedDoc:a,newMessageId:c}=await ee(AS(e.payload.sessionId,e.payload.messageObject),5e3),u=a.messages.map(p=>p.toJSON?p.toJSON():p);await ee(V.publish(et.name,new et(a.id,u)),3e3);const d=new lo(r,!0,c);await ee(V.publish(d.type,d),3e3),t.info("Message added",{requestId:r,sessionId:e.payload.sessionId,messageId:c})}catch(a){const c=a instanceof re?a:new re("UNKNOWN","Failed to add message",{originalError:a}),u=new lo(r,!1,null,c);await ee(V.publish(u.type,u),3e3),t.error("Add message failed",{requestId:r,error:c})}}async function VS(e){var n,o,a;const t=new Pe("UpdateMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling update message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.messageId)||!((a=e==null?void 0:e.payload)!=null&&a.updates)||!e.payload.updates.text)throw new re("INVALID_INPUT","Session ID, message ID, and updates with text are required");const c=await ee(TS(e.payload.sessionId,e.payload.messageId,e.payload.updates),5e3);await ee(V.publish(et.name,new et(c.id,c.messages)),3e3);const u=new fo(r,!0);await ee(V.publish(u.type,u),3e3),t.info("Message updated",{requestId:r,sessionId:e.payload.sessionId,messageId:e.payload.messageId})}catch(c){const u=c instanceof re?c:new re("UNKNOWN","Failed to update message",{originalError:c}),d=new fo(r,!1,u);await ee(V.publish(d.type,d),3e3),t.error("Update message failed",{requestId:r,error:u})}}async function QS(e){var n,o;const t=new Pe("DeleteMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling delete message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.messageId))throw new re("INVALID_INPUT","Session ID and message ID are required");const{updatedDoc:a,deleted:c}=await ee(NS(e.payload.sessionId,e.payload.messageId),5e3);c&&await ee(V.publish(et.name,new et(a.id,a.messages)),3e3);const u=new po(r,!0);await ee(V.publish(u.type,u),3e3),t.info("Message deleted",{requestId:r,sessionId:e.payload.sessionId,messageId:e.payload.messageId})}catch(a){const c=a instanceof re?a:new re("UNKNOWN","Failed to delete message",{originalError:a}),u=new po(r,!1,c);await ee(V.publish(u.type,u),3e3),t.error("Delete message failed",{requestId:r,error:c})}}async function GS(e){var n,o;const t=new Pe("UpdateStatusHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling update status",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.status))throw new re("INVALID_INPUT","Session ID and status are required");const a=await ee(BS(e.payload.sessionId,e.payload.status),5e3);await ee(V.publish(er.name,new er(a.id,a.status)),3e3);const c=new ho(r,!0);await ee(V.publish(c.type,c),3e3),t.info("Status updated",{requestId:r,sessionId:e.payload.sessionId,status:e.payload.status})}catch(a){const c=a instanceof re?a:new re("UNKNOWN","Failed to update status",{originalError:a}),u=new ho(r,!1,c);await ee(V.publish(u.type,u),3e3),t.error("Update status failed",{requestId:r,error:c});try{await ee(V.publish(er.name,new er(e.payload.sessionId,"error")),3e3)}catch(d){t.error("Failed to publish error status notification",{requestId:r,error:d})}}}async function YS(e){var n;const t=new Pe("ToggleStarHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling toggle star",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new re("INVALID_INPUT","Session ID is required");const o=await ee(qS(e.payload.sessionId),5e3),a=new mo(r,!0,o.toJSON());await ee(V.publish(a.type,a),3e3),t.info("Star toggled",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const a=o instanceof re?o:new re("UNKNOWN","Failed to toggle star",{originalError:o}),c=new mo(r,!1,null,a);await ee(V.publish(c.type,c),3e3),t.error("Toggle star failed",{requestId:r,error:a})}}async function JS(e){const t=new Pe("GetAllSessionsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get all sessions",{requestId:r});try{const o=(await ee(US(),5e3)).sort((c,u)=>u.timestamp-c.timestamp);t.debug("Using plain sessions directly",{count:o.length});const a=new bo(r,!0,o);await ee(V.publish(a.type,a),3e3),t.info("Sessions retrieved",{requestId:r,count:o.length})}catch(n){const o=n instanceof re?n:new re("UNKNOWN","Failed to get all sessions",{originalError:n}),a=new bo(r,!1,null,o);await ee(V.publish(a.type,a),3e3),t.error("Get all sessions failed",{requestId:r,error:o})}}async function XS(e){const t=new Pe("GetStarredSessionsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get starred sessions",{requestId:r});try{const o=(await ee(KS(),5e3)).map(c=>({sessionId:c.id,name:c.title,lastUpdated:c.timestamp,isStarred:c.isStarred})).sort((c,u)=>u.lastUpdated-c.lastUpdated);t.debug("Retrieved starred sessions",{count:o.length});const a=new wo(r,!0,o);await ee(V.publish(a.type,a),3e3),t.info("Starred sessions retrieved",{requestId:r,count:o.length})}catch(n){const o=n instanceof re?n:new re("UNKNOWN","Failed to get starred sessions",{originalError:n}),a=new wo(r,!1,null,o);await ee(V.publish(a.type,a),3e3),t.error("Get starred sessions failed",{requestId:r,error:o})}}async function ZS(e){var n;const t=new Pe("DeleteSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling delete session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new re("INVALID_INPUT","Session ID is required");const o=await ee(FS(e.payload.sessionId),5e3),a=new vo(r,!0);await ee(V.publish(a.type,a),3e3),t.info("Session deleted",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const a=o instanceof re?o:new re("UNKNOWN","Failed to delete session",{originalError:o}),c=new vo(r,!1,a);await ee(V.publish(c.type,c),3e3),t.error("Delete session failed",{requestId:r,error:a})}}async function eE(e){var n,o;const t=new Pe("RenameSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling rename session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.newName))throw new re("INVALID_INPUT","Session ID and new name are required");const a=await ee(jS(e.payload.sessionId,e.payload.newName),5e3),c=new yo(r,!0);await ee(V.publish(c.type,c),3e3),t.info("Session renamed",{requestId:r,sessionId:e.payload.sessionId})}catch(a){const c=a instanceof re?a:new re("UNKNOWN","Failed to rename session",{originalError:a}),u=new yo(r,!1,c);await ee(V.publish(u.type,u),3e3),t.error("Rename session failed",{requestId:r,error:c})}}V.subscribe(mi.name,Vp);PS.info("Subscribed to DbInitializeRequest");let qo=!1,zr=null,yr=null,Qt=null,Zt=[],In="",af=!1;async function tE(e){if(console.log(`[LibraryController] Star clicked: ${e}`),!!Qt)try{await Qt(new _o(e)),$e("Star toggled","success")}catch(t){console.error("[LibraryController] Error toggling star:",t),$e(`Failed to toggle star: ${t.message}`,"error")}}async function rE(e){if(console.log(`[LibraryController] Delete clicked: ${e}`),!!Qt&&confirm("Are you sure you want to delete this chat history item? This cannot be undone."))try{await Qt(new Eo(e)),$e("Chat deleted","success")}catch(t){console.error("[LibraryController] Error deleting chat:",t),$e(`Failed to delete chat: ${t.message}`,"error")}}async function nE(e,t){if(console.log(`[LibraryController] Rename submitted: ${e} to "${t}"`),!!Qt)try{await Qt(new Io(e,t)),$e("Rename successful","success")}catch(r){console.error("[LibraryController] Error submitting rename:",r),$e(`Failed to rename chat: ${r.message}`,"error")}}async function oE(e){Qt?Cf(e,Qt,$e):(console.error("[LibraryController] Cannot download: requestDbAndWaitFunc not available."),$e("Download failed: Internal setup error.","error"))}async function iE(e){console.log(`[LibraryController] Load clicked: ${e}`);try{await chrome.storage.local.set({lastSessionId:e}),Ka("page-home")}catch(t){console.error("[LibraryController] Error setting storage or navigating:",t),$e("Failed to load chat.","error"),await chrome.storage.local.remove("lastSessionId")}}function aE(e){console.log(`[LibraryController] Share clicked: ${e}`),$e("Share functionality not yet implemented.","info")}function sE(e,t){console.log(`[LibraryController] Preview clicked: ${e}`),$e("Preview functionality not yet implemented.","info"),t&&(t.innerHTML="Preview loading...",t.classList.toggle("hidden"))}function cE(e){!qo||(e==null?void 0:e.pageId)!=="page-library"||(console.log("[LibraryController] Library page activated."),af||(yr=document.getElementById("library-search"),yr?(yr.addEventListener("input",dE),af=!0,console.log("[LibraryController] Search input listener attached.")):console.warn("[LibraryController] Library search input (#library-search) still not found even when page is active.")),uE())}async function uE(){if(!qo||!zr||!Qt){console.error("[LibraryController] Cannot fetch/render - not initialized or missing elements/functions.");return}console.log("[LibraryController] Fetching starred items..."),zr.innerHTML='<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">Loading starred items...</p>',In=(yr==null?void 0:yr.value.trim())||"";try{const e=await Qt(new vi);Zt=Array.isArray(e)?e:(e==null?void 0:e.sessions)||[],console.log(`[LibraryController] Received ${Zt.length} starred items.`),ll(In)}catch(e){console.error("[LibraryController] Error fetching starred items:",e),zr.innerHTML='<div class="p-4 text-red-500">Error loading starred items.</div>'}}function lE(e){if(!qo||!e||!e.sessionId||!e.payload){console.warn("[LibraryController] Invalid session update notification received.",e);return}const t=e.payload.session,r=e.sessionId;if(!t){console.warn(`[LibraryController] Session update notification for ${r} missing session data in payload.session.`,e);return}console.log(`[LibraryController] Received session update for ${r}. New starred status: ${t.isStarred}`);const n=Zt.findIndex(a=>a.sessionId===r);if(t.isStarred)if(n===-1){console.log(`[LibraryController] Session ${r} is newly starred. Adding to list.`);const a={sessionId:r,name:t.title||"Untitled",lastUpdated:t.timestamp||Date.now(),isStarred:!0};Zt.push(a)}else console.log(`[LibraryController] Session ${r} was already starred. Updating data.`),Zt[n]={...Zt[n],name:t.title||Zt[n].name,lastUpdated:t.timestamp||Zt[n].lastUpdated,isStarred:!0};else n!==-1?(console.log(`[LibraryController] Session ${r} is no longer starred. Removing from list.`),Zt.splice(n,1)):console.log(`[LibraryController] Session ${r} is not starred and was not in the list.`);const o=document.getElementById("page-library");o&&!o.classList.contains("hidden")?(console.log("[LibraryController] Library page is active, re-rendering list with filter."),In=(yr==null?void 0:yr.value.trim())||"",ll(In)):console.log("[LibraryController] Library page not active, internal list updated passively.")}function ll(e=""){if(!qo||!zr)return;console.log(`[LibraryController] Rendering with filter "${e}"`);let t=[...Zt];if(e){const r=e.toLowerCase();t=t.filter(n=>(n.name||"").toLowerCase().includes(r))}if(t.sort((r,n)=>n.lastUpdated-r.lastUpdated),zr.innerHTML="",t.length===0){const r=e?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items match "${e}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items yet.</p>';zr.innerHTML=r}else t.forEach(r=>{const n={entry:{id:r.sessionId,name:r.name,title:r.name,timestamp:r.lastUpdated,isStarred:r.isStarred,messages:[]},onLoadClick:iE,onStarClick:tE,onDeleteClick:rE,onRenameSubmit:nE,onDownloadClick:oE,onShareClick:aE,onPreviewClick:sE},o=If(n);o&&zr.appendChild(o)});console.log(`[LibraryController] Rendered ${t.length} items.`)}const dE=Ou(e=>{qo&&(In=e.target.value.trim(),console.log(`[LibraryController] Search input changed: "${In}"`),ll(In))},300);function fE(e,t){return console.log("[LibraryController] Initializing..."),!e||!e.listContainer||!t?(console.error("[LibraryController] Initialization failed: Missing required elements (listContainer) or request function.",{elements:e,requestFunc:t}),null):(zr=e.listContainer,Qt=t,console.log("[LibraryController] Elements and request function assigned."),V.subscribe("navigation:pageChanged",cE),console.log("[LibraryController] Subscribed to navigation:pageChanged."),V.subscribe(xn.name,lE),console.log("[LibraryController] Subscribed to DbSessionUpdatedNotification."),qo=!0,console.log("[LibraryController] Initialization successful. Library will render when activated."),{})}let sf=!1;function hE(){if(sf){console.log("[DiscoverController] Already initialized.");return}return console.log("[DiscoverController] Initializing..."),sf=!0,console.log("[DiscoverController] Initialized successfully."),{}}let cf=!1;const uf=e=>{if(!e)return;const t=document.documentElement.classList.contains("dark");e.textContent=t?"Switch to Light Mode":"Switch to Dark Mode"};function pE(){const e=document.getElementById("page-settings");if(!e){console.warn("[SettingsController] Could not find #page-settings container.");return}let t=e.querySelector("#theme-toggle-button");if(t)console.log("[SettingsController] Theme toggle button already exists.");else{console.log("[SettingsController] Creating theme toggle button."),t=document.createElement("button"),t.id="theme-toggle-button",t.className="p-2 border rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 mt-4",t.onclick=()=>{const n=document.documentElement,o=n.classList.contains("dark");console.log(`[SettingsToggle] Before toggle - isDark: ${o}`),o?(n.classList.remove("dark"),localStorage.setItem("theme","light"),console.log("[SettingsToggle] Removed dark class, set localStorage to light")):(n.classList.add("dark"),localStorage.setItem("theme","dark"),console.log("[SettingsToggle] Added dark class, set localStorage to dark")),uf(t)};const r=e.querySelector("p");r?r.insertAdjacentElement("afterend",t):e.appendChild(t)}uf(t)}function mE(){if(cf){console.log("[SettingsController] Already initialized.");return}return console.log("[SettingsController] Initializing..."),pE(),cf=!0,console.log("[SettingsController] Initialized successfully."),{}}let lf=!1;function gE(){if(lf){console.log("[SpacesController] Already initialized.");return}return console.log("[SpacesController] Initializing..."),lf=!0,console.log("[SpacesController] Initialized successfully."),{}}const dl="application/vnd.google-apps.folder";let cr,Cn,Oa,tt,Pa,pn,At,ku,Qn,mn,Ln=!1,xr="root",Tt=[{id:"root",name:"Root"}],$o={},Nt={},ii=!1,br="",ti=null,df=null,zc=null,ds=$e,Wc=null;function vE(){if(!Ln){if(!Cn){console.error("DriveViewerModal element not found.");return}console.log("DriveController: Showing Drive Viewer modal."),xr="root",Tt=[{id:"root",name:"Root"}],Nt={},$o={},br="",At&&(At.value=""),Fs(),qs(),Bs("root"),Cn.classList.remove("hidden"),Ln=!0}}function Ra(){Ln&&Cn&&(console.log("DriveController: Hiding Drive Viewer modal."),Cn.classList.add("hidden"),Ln=!1,tt&&(tt.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>'))}function yE(e){return e===dl?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'}function fl(e){if(!tt)return;tt.innerHTML="";const t=br.toLowerCase(),r=br?e.filter(n=>n.name.toLowerCase().includes(t)):e;if(!r||r.length===0){tt.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 p-4">${br?"No results found.":"Folder is empty."}</div>`;return}r.forEach(n=>{const o=n.mimeType===dl,a=document.createElement("div");a.className="drive-viewer-item flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer",a.dataset.id=n.id,a.dataset.name=n.name,a.dataset.mimeType=n.mimeType,a.dataset.iconLink=n.iconLink||"";const c=document.createElement("div");c.className="flex-shrink-0 w-6 h-6 mr-3 flex items-center justify-center",n.iconLink?c.innerHTML=`<img src="${n.iconLink}" alt="${o?"Folder":"File"}" class="w-5 h-5">`:c.innerHTML=yE(n.mimeType);const u=document.createElement("span");u.className="flex-grow truncate",u.textContent=n.name,u.title=n.name,a.appendChild(c),a.appendChild(u),Nt[n.id]&&a.classList.add("selected"),a.addEventListener("click",bE),tt.appendChild(a)})}function Bs(e){if(!(!tt||ii)){if(ii=!0,console.log(`DriveController: Fetching Drive content for folder: ${e}`),wE(),CE(),tt.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>',$o[e]){console.log(`DriveController: Using cached content for folder: ${e}`),fl($o[e]),ii=!1;return}chrome.runtime.sendMessage({type:"getDriveFileList",folderId:e},t=>{chrome.runtime.lastError?(console.error("DriveController: Error sending getDriveFileList message:",chrome.runtime.lastError.message),ds(`Error fetching folder content: ${chrome.runtime.lastError.message}`,"error"),tt&&(tt.innerHTML='<div class="text-center text-red-500 p-4">Error sending request.</div>'),ii=!1):console.log(`DriveController: Sent getDriveFileList request for ${e}. Waiting for response...`)})}}function bE(e){e.stopPropagation();const t=e.currentTarget,r=t.dataset.id,n=t.dataset.name,o=t.dataset.mimeType,a=t.dataset.iconLink;if(!r||!o){console.error("DriveController: Clicked Drive item missing ID or mimeType.");return}o===dl?(console.log(`DriveController: Navigating into folder: ${n} (${r})`),xr=r,Tt.push({id:r,name:n}),br="",At&&(At.value=""),Bs(r)):(console.log(`DriveController: Toggling selection for file: ${n} (${r})`),SE(r,t,{id:r,name:n,mimeType:o,iconLink:a}))}function wE(){Qn&&(Qn.innerHTML="",Tt.forEach((e,t)=>{const r=document.createElement(t===Tt.length-1?"span":"button");if(r.textContent=e.name,r.dataset.id=e.id,r.dataset.index=t,t<Tt.length-1){r.className="text-blue-600 hover:underline dark:text-blue-400 cursor-pointer",r.addEventListener("click",_E);const n=document.createElement("span");n.textContent=" / ",n.className="mx-1 text-gray-400",Qn.appendChild(r),Qn.appendChild(n)}else r.className="font-semibold",Qn.appendChild(r)}))}function _E(e){const t=parseInt(e.currentTarget.dataset.index,10),r=e.currentTarget.dataset.id;if(isNaN(t)||!r){console.error("DriveController: Invalid breadcrumb data.");return}r!==xr&&(console.log(`DriveController: Breadcrumb click - Navigating to index ${t} (${r})`),Tt=Tt.slice(0,t+1),xr=r,br="",At&&(At.value=""),Bs(r))}function SE(e,t,r){Nt[e]?(delete Nt[e],t==null||t.classList.remove("selected")):(Nt[e]=r,t==null||t.classList.add("selected")),qs(),Fs()}function qs(){if(!ku)return;const e=Object.keys(Nt),t=ku;if(!t){console.error("Selected area container not found");return}const r=t.querySelector(".flex-wrap")||t;r.innerHTML="",e.length===0?t.classList.add("hidden"):(t.classList.remove("hidden"),e.forEach(n=>{const o=Nt[n],a=document.createElement("span");a.className="selected-file-item";const c=o.iconLink?`<img src="${o.iconLink}" alt="" class="w-3 h-3 mr-1.5">`:"",u=`<button class="selected-file-remove" data-id="${n}">&times;</button>`;a.innerHTML=`${c}${o.name} ${u}`,r.appendChild(a);const d=a.querySelector(".selected-file-remove");d==null||d.addEventListener("click",EE)}))}function EE(e){const t=e.currentTarget.dataset.id;if(t&&Nt[t]){delete Nt[t],qs(),Fs();const r=tt==null?void 0:tt.querySelector(`.drive-viewer-item[data-id="${t}"]`);r==null||r.classList.remove("selected")}}function Fs(){if(!pn)return;const e=Object.keys(Nt).length;pn.disabled=e===0,pn.textContent=`Insert (${e})`}let Vc=null;function ff(e){br=e.target.value.trim(),console.log(`DriveController: Filtering Drive items by term: "${br}"`),$o[xr]?fl($o[xr]):tt.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Folder not loaded or empty.</div>'}function IE(){if(Tt.length<=1)return;const e=Tt[Tt.length-2];Tt.pop(),xr=e.id,console.log(`DriveController: Back button click - Navigating to ${e.name} (${e.id})`),br="",At&&(At.value=""),Bs(e.id)}function CE(){mn&&(Tt.length>1?mn.classList.remove("hidden"):mn.classList.add("hidden"))}function xE(e,t,r){if(e.type==="driveFileListResponse"){if(console.log(`DriveController: Handling driveFileListResponse for folder: ${e.folderId}`),ii=!1,!Ln||e.folderId!==xr)return console.warn(`DriveController: Ignoring driveFileListResponse for folder ${e.folderId}. Current: ${xr}, IsOpen: ${Ln}`),!1;if(e.success&&e.files)$o[e.folderId]=e.files,fl(e.files);else{const n=e.error||"Unknown error fetching files.";console.error(`DriveController: Drive file list error for ${e.folderId}: ${n}`),ds(`Error fetching folder content: ${n}`,"error"),tt&&(tt.innerHTML=`<div class="text-center text-red-500 p-4">Error loading content: ${n}</div>`)}return!1}return!1}function kE(e){console.log("Initializing DriveController..."),ti=e.requestDbAndWaitFunc,df=e.getActiveChatSessionId,zc=e.setActiveChatSessionId,e.showNotification&&(ds=e.showNotification),Wc=e.debounce,Wc?Vc=Wc(ff,300):(console.error("DriveController requires a debounce function dependency."),Vc=ff),cr=document.getElementById("drive-button"),Cn=document.getElementById("drive-viewer-modal"),Oa=document.getElementById("drive-viewer-close"),tt=document.getElementById("drive-viewer-list"),Pa=document.getElementById("drive-viewer-cancel"),pn=document.getElementById("drive-viewer-insert"),At=document.getElementById("drive-viewer-search"),ku=document.getElementById("drive-viewer-selected-area"),Qn=document.getElementById("drive-viewer-breadcrumbs"),mn=document.getElementById("drive-viewer-back");const t=r=>{r.stopPropagation(),vE()};cr==null||cr.removeEventListener("click",t),cr==null||cr.addEventListener("click",t),Oa==null||Oa.addEventListener("click",Ra),Pa==null||Pa.addEventListener("click",Ra),pn==null||pn.addEventListener("click",async()=>{const r=Object.values(Nt);if(r.length===0)return;let n=df(),o=!1;console.log(`DriveController: Inserting ${r.length} Drive files. Current session: ${n}`);const c=`📎 Attached Drive files: ${r.map(d=>d.name).join(", ")}`,u={type:"drive_attachments",files:r.map(d=>({id:d.id,name:d.name,mimeType:d.mimeType,iconLink:d.iconLink}))};try{if(n){const d={sender:"system",text:c,timestamp:Date.now(),isLoading:!1,metadata:u};if(!ti)throw new Error("requestDbAndWaitFunc function not provided.");const p=new pi(n,d);await ti(p)}else{o=!0;const d={sender:"system",text:c,timestamp:Date.now(),isLoading:!1,metadata:u};if(!ti)throw new Error("requestDbAndWaitFunc function not provided.");const p=new So(d),m=await ti(p);if(console.log("[DriveController] Received createSessionResponse:",JSON.stringify(m)),n=m==null?void 0:m.newSessionId,console.log("[DriveController] Extracted currentSessionId:",n),!n)throw new Error("Failed to create session or get sessionId from response.");zc?zc(n):console.warn("setActiveChatSessionIdDep not provided to DriveController."),console.log(`DriveController: New session ${n} created.`)}Nt={},qs(),Fs(),Ra()}catch(d){console.error("DriveController: Error adding Drive attachment message:",d),ds(`Failed to add Drive attachment: ${d.message}`,"error")}}),At==null||At.addEventListener("input",Vc),mn==null||mn.addEventListener("click",IE),document.addEventListener("click",r=>{Ln&&Cn&&!Cn.contains(r.target)&&cr&&!cr.contains(r.target)&&Ra()}),chrome.runtime.onMessage.addListener(xE),console.log("DriveController Initialization Complete.")}let DE=null,fs=null,hf=!1,Qc=null,Br=null,La=null,Yp=!1;const Gc=new Map;function Yn(e,t=5e3){return new Promise((r,n)=>{const{requestId:o,type:a}=e,c=e.constructor.responseEventName;if(!c){const p=`[requestDbAndWait] Cannot determine response event type for request: ${a}`;console.error(p),n(new Error(p));return}const u=p=>{console.log(`[requestDbAndWait] Received event for ${c}, ReqID ${p==null?void 0:p.requestId}, Waiting for ${o}`),console.log("[requestDbAndWait] RAW Received Event Object:",p),p&&p.requestId===o&&(console.log(`[requestDbAndWait] MATCH FOUND for ReqID ${o}. Event Payload:`,p),clearTimeout(d),V.unsubscribe(c,u),Gc.delete(o),p.error===null||typeof p.error>"u"?(console.log(`[requestDbAndWait] Success assumed (no error property) for ReqID ${o}. Resolving promise.`),r(p.data||p.payload)):(console.error(`[requestDbAndWait] Error property found for ReqID ${o}. responseEvent.error was: ${p.error}. Rejecting promise.`),n(new Error(p.error||`DB operation ${a} failed`))))},d=setTimeout(()=>{console.error(`[Sidepanel] DB request timed out for ${a} (Req ID: ${o})`),V.unsubscribe(c,u),Gc.delete(o),n(new Error(`DB request timed out for ${a}`))},t);Gc.set(o,{handler:u,timeoutId:d}),V.subscribe(c,u),V.publish(e.type,e)})}function Ua(){return fs}async function oo(e){console.log(`[Sidepanel] Setting active session ID to: ${e}`),fs=e,e?await chrome.storage.local.set({lastSessionId:e}):await chrome.storage.local.remove("lastSessionId"),qm(e),Sf(e)}document.addEventListener("DOMContentLoaded",async()=>{console.log("[Sidepanel] DOM Content Loaded. Initializing modules...");let e=!1;const t=new Promise((r,n)=>{const a=setTimeout(()=>{e||(console.error("[Sidepanel] DB Initialization timed out!"),n(new Error("Database initialization timed out.")))},1e4),c=u=>{var d;if(e=!0,clearTimeout(a),V.unsubscribe(Ur.name,c),u&&u.payload&&u.payload.success)console.log("[Sidepanel] Received DB Initialization Complete notification (Success)."),r(!0);else{const p=((d=u==null?void 0:u.payload)==null?void 0:d.error)||"Unknown DB initialization error";console.error(`[Sidepanel] Received DB Initialization Complete notification (Failure): ${p}`),n(new Error(`Database initialization failed: ${p}`))}};V.subscribe(Ur.name,c),console.log("[Sidepanel] Subscribed to DbInitializationCompleteNotification. Publishing DbInitializeRequest..."),V.publish(mi.name,new mi)});try{const{chatBody:r,newChatButton:n,chatInputElement:o,sendButton:a,fileInput:c}=_f({onNewChat:RE,onSessionClick:LE,onAttachFile:sg});console.log("[Sidepanel] UI Controller Initialized.");const u=document.getElementById("chat-body");u||console.error("[Sidepanel] CRITICAL: chatBodyForRenderer is null right before calling initializeRenderer!"),Bm(u,Yn),console.log("[Sidepanel] Chat Renderer Initialized."),$m(),console.log("[Sidepanel] Navigation Initialized."),V.subscribe("navigation:pageChanged",ME),ig({uiController:Xm,getActiveSessionIdFunc:Ua}),console.log("[Sidepanel] File Handler Initialized.");const d=document.getElementById("file-input");d?d.addEventListener("change",ag):console.warn("[Sidepanel] File input element (re-fetched) not found before adding listener.");const p=await Jc();Br=p==null?void 0:p.id,DE=p,console.log(`[Sidepanel] Current Tab ID: ${Br}`),Zm({getActiveSessionIdFunc:Ua,onSessionCreatedCallback:PE,getCurrentTabIdFunc:()=>Br}),console.log("[Sidepanel] Message Orchestrator Initialized."),chrome.runtime.onMessage.addListener(OE),console.log("[Sidepanel] Background message listener added.");const m=document.getElementById("history-popup"),v=document.getElementById("history-list"),w=document.getElementById("history-search"),_=document.getElementById("close-history"),E=document.getElementById("history-button"),D=document.getElementById("detach-button");m&&v&&w&&_?(La=Ig({popupContainer:m,listContainer:v,searchInput:w,closeButton:_},Yn),La||console.error("[Sidepanel] History Popup Controller initialization failed.")):console.warn("[Sidepanel] Could not find all required elements for History Popup Controller."),E&&La?E.addEventListener("click",()=>{La.show()}):console.warn("[Sidepanel] History button or controller not available for listener."),D?D.addEventListener("click",$E):console.warn("[Sidepanel] Detach button not found.");const M=document.getElementById("starred-list");M?(fE({listContainer:M},Yn),console.log("[Sidepanel] Library Controller Initialized.")):console.warn("[Sidepanel] Could not find #starred-list element for Library Controller."),V.subscribe("ui:requestModelLoad",q=>{const G=q==null?void 0:q.modelId;if(!G){console.error("[Sidepanel] Received 'ui:requestModelLoad' but missing modelId."),V.publish("worker:error","No model ID specified for loading.");return}console.log(`[Sidepanel] Received 'ui:requestModelLoad' for ${G}. Sending 'loadModel' to background.`),chrome.runtime.sendMessage({type:"loadModel",payload:{modelId:G}}).catch(ae=>{console.error(`[Sidepanel] Error sending 'loadModel' message for ${G}:`,ae),V.publish("worker:error",`Failed to send load request: ${ae.message}`)})}),hE(),console.log("[Sidepanel] Discover Controller Initialized call attempted."),mE(),console.log("[Sidepanel] Settings Controller Initialized call attempted."),gE(),console.log("[Sidepanel] Spaces Controller Initialized call attempted."),kE({requestDbAndWaitFunc:Yn,getActiveChatSessionId:Ua,setActiveChatSessionId:oo,showNotification:$e,debounce:Ou}),console.log("[Sidepanel] Drive Controller Initialized.");const B=new URLSearchParams(window.location.search);hf=B.get("context")==="popup",Qc=B.get("originalTabId"),console.log(`[Sidepanel] Context: ${hf?"Popup":"Sidepanel"}${Qc?", Original Tab: "+Qc:""}`),console.log("[Sidepanel] Waiting for DB initialization to complete...");try{await t,Yp=!0,console.log("[Sidepanel] DB initialization confirmed complete.")}catch(q){console.error("[Sidepanel] DB Initialization failed within DOMContentLoaded:",q),st(`Critical Error: ${q.message}. Cannot load data.`),r&&(r.innerHTML='<div class="p-4 text-red-500">Database failed to load. Please try reloading the extension.</div>');return}console.log("[Sidepanel] DB ready. Starting with a clean session."),await fi(null),console.log("[Sidepanel] Initialization complete (starting fresh).")}catch(r){console.error("[Sidepanel] Initialization failed:",r),st(`Initialization failed: ${r.message}. Please try reloading.`);const n=document.getElementById("chat-body");n&&(n.innerHTML=`<div class="p-4 text-red-500">Critical Error: ${r.message}. Please reload the extension.</div>`)}});function OE(e,t,r){if(console.log("[Sidepanel] Received message from background:",e),e.type==="response"){const n={chatId:e.chatId,messageId:e.messageId,text:e.text};V.publish("background:responseReceived",n)}else if(e.type==="error"){const n={chatId:e.chatId,messageId:e.messageId,error:e.error};V.publish("background:errorReceived",n)}else e.type==="STAGE_SCRAPE_RESULT"?V.publish("background:scrapeStageResult",e.payload):e.type==="DIRECT_SCRAPE_RESULT"?V.publish("background:scrapeResultReceived",e.payload):e.type==="uiLoadingStatusUpdate"?(console.log("[Sidepanel] Forwarding uiLoadingStatusUpdate to eventBus."),V.publish("ui:loadingStatusUpdate",e.payload)):console.warn("[Sidepanel] Received unknown message type from background:",e.type,e)}async function PE(e){console.log(`[Sidepanel] Orchestrator reported new session created: ${e}`),await oo(e),console.log(`[Sidepanel] Explicitly fetching messages for new session ${e}`);try{const t=new wr(e),r=await Yn(t);r&&r.messages?(V.publish(et.name,new et(e,r.messages)),console.log(`[Sidepanel] Manually triggered message render for new session ${e}`)):console.warn(`[Sidepanel] No messages found in session data for new session ${e}. Response data:`,r)}catch(t){console.error(`[Sidepanel] Failed to fetch messages for new session ${e}:`,t),st(`Failed to load initial messages for new chat: ${t.message}`)}}async function RE(){console.log("[Sidepanel] New Chat button clicked."),await oo(null),Cs(),Ef()}async function LE(e){const t=e.currentTarget.dataset.sessionId;t&&t!==fs?(console.log(`[Sidepanel] Session list item clicked: ${t}`),await fi(t)):t===fs?(console.log(`[Sidepanel] Clicked already active session: ${t}`),Is()):console.warn("[Sidepanel] Session list click event missing sessionId:",e.currentTarget)}async function fi(e){if(!e){console.log("[Sidepanel] No session ID to load, setting renderer to null."),await oo(null);return}console.log(`[Sidepanel] Loading session data for: ${e}`);let t=null;try{const r=new wr(e);t=await Yn(r),console.log(`[Sidepanel] Session data successfully loaded for ${e}.`),await oo(e),t&&t.messages?(console.log(`[Sidepanel] Manually triggering message render for loaded session ${e}.`),V.publish(et.name,new et(e,t.messages))):(console.warn(`[Sidepanel] No messages found in loaded session data for ${e}. Displaying empty chat.`),V.publish(et.name,new et(e,{messages:[]})))}catch(r){console.error(`[Sidepanel] Failed to load session ${e}:`,r),st(`Failed to load chat: ${r.message}`),await oo(null)}}async function $E(){if(!Br){console.error("Cannot detach: Missing tab ID"),st("Cannot detach: Missing tab ID");return}const e=Ua();try{const t=await chrome.runtime.sendMessage({type:"getPopupForTab",tabId:Br});if(t&&t.popupId){await chrome.windows.update(t.popupId,{focused:!0});return}const r=`detachedSessionId_${Br}`;await chrome.storage.local.set({[r]:e}),console.log(`Sidepanel: Saved session ID ${e} for detach key ${r}.`);const n=await chrome.windows.create({url:chrome.runtime.getURL(`sidepanel.html?context=popup&originalTabId=${Br}`),type:"popup",width:400,height:600});if(n!=null&&n.id)await chrome.runtime.sendMessage({type:"popupCreated",tabId:Br,popupId:n.id});else throw new Error("Failed to create popup window.")}catch(t){console.error("Error during detach:",t),st(`Error detaching chat: ${t.message}`)}}async function ME(e){if(!(!e||!e.pageId)){if(console.log(`[Sidepanel] Navigation changed to: ${e.pageId}`),!Yp){console.log("[Sidepanel] DB not ready yet, skipping session load on initial navigation event.");return}if(e.pageId==="page-home"){console.log("[Sidepanel] Navigated to home page, checking for specific session load signal...");try{const{lastSessionId:t}=await chrome.storage.local.get(["lastSessionId"]);t?(console.log(`[Sidepanel] Found load signal: ${t}. Loading session and clearing signal.`),await fi(t),await chrome.storage.local.remove("lastSessionId")):(console.log("[Sidepanel] No load signal found. Resetting to welcome state."),await fi(null))}catch(t){console.error("[Sidepanel] Error checking/loading session based on signal:",t),st("Failed to load session state."),await fi(null)}}}}
//# sourceMappingURL=sidepanel.js.map
