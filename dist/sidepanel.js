var Sh=Object.defineProperty;var iu=e=>{throw TypeError(e)};var xh=(e,t,r)=>t in e?Sh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var Oa=(e,t,r)=>xh(e,typeof t!="symbol"?t+"":t,r),au=(e,t,r)=>t.has(e)||iu("Cannot "+r);var Q=(e,t,r)=>(au(e,t,"read from private field"),r?r.call(e):t.get(e)),Ke=(e,t,r)=>t.has(e)?iu("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),He=(e,t,r,n)=>(au(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);function Ei(e){"@babel/helpers - typeof";return Ei=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ei(e)}function kh(e,t){if(Ei(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(Ei(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function Ih(e){var t=kh(e,"string");return Ei(t)=="symbol"?t:t+""}function Ch(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Ih(n.key),n)}}function Hr(e,t,r){return t&&Ch(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function Dh(e){return e[e.length-1]}function Ys(e){return Array.isArray(e)?e.slice(0):[e]}function Oh(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Wa(e){return Array.isArray(e)}function Zo(e,t){var r=0,n=-1;for(var i of e){n=n+1;var o=t(i,n);if(o)r=r+1;else break}return r}function pn(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var i=0;i<r;++i)e[n+i]=t[i]}}function Ph(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Fr(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function yr(e,t){var r=t?Fr(t._rev)+1:1;return r+"-"+e}function Rh(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var i=n,o=0;o<r;++o){var c=t[o];if(i=i[c],typeof i>"u")return i}return i}}function Be(e){return Object.assign({},e)}function Lh(e){return Object.keys(e)[0]}function za(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,i)=>typeof n=="string"&&typeof i=="string"?n.localeCompare(i):typeof n=="object"?1:-1).map(n=>za(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,i)=>n.localeCompare(i)).forEach(n=>{r[n]=za(e[n],t)}),r}return e}function Es(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=Es(e[r]);return t}var n={};for(var i in e)n[i]=Es(e[i]);return n}var ft=Es;function mr(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var Js=1;function Yn(){return{lwt:Js}}function Ht(){return""}function $h(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function Mh(e,t,r){if(t.length!==r.length)return!1;for(var n=0,i=t.length;n<i;){var o=t[n],c=r[n];if(n++,o._rev!==c._rev||o[e]!==c[e])return!1}return!0}async function Th(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),i=>("00"+i.toString(16)).slice(-2)).join("");return n}var wl=Th;function Ah(){return new Promise(e=>setTimeout(e,0))}function Bh(e=0){return new Promise(t=>setTimeout(t,e))}function Nh(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var jh=Promise.resolve(!0),br=Promise.resolve(!1),Xs=Promise.resolve(null),Mt=Promise.resolve();function ao(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):Bh(0)}var es=Mt;function qh(e=void 0){return es=es.then(()=>ao(e)),es}function Fh(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var Kh=/\./g,ou="abcdefghijklmnopqrstuvwxyz";function Ki(e=10){for(var t="",r=0;r<e;r++)t+=ou.charAt(Math.floor(Math.random()*ou.length));return t}function _l(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function di(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function Si(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!Si(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var i=Object.keys(e);if(r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var o=i[n];if(!Si(e[o],t[o]))return!1}return!0}return e!==e&&t!==t}var Ss=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},ts=new Set(["__proto__","prototype","constructor"]),Hh=new Set("0123456789");function El(e){var t=[],r="",n="start",i=!1;for(var o of e)switch(o){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");i&&(r+=o),n="property",i=!i;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(i){i=!1,r+=o;break}if(ts.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(i){i=!1,r+=o;break}if(n==="property"){if(ts.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!Hh.has(o))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),i&&(i=!1,r+="\\"),r+=o}}switch(i&&(r+="\\"),n){case"property":{if(ts.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function Sl(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function Uh(e,t){if(Sl(e,t))throw new Error("Cannot use string index")}function Kr(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!Ss(e)||typeof t!="string")return r===void 0?e:r;var n=El(t);if(n.length===0)return r;for(var i=0;i<n.length;i++){var o=n[i];if(Sl(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function xl(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!Ss(e)||typeof t!="string")return e;for(var n=e,i=El(t),o=0;o<i.length;o++){var c=i[o];Uh(e,c),o===i.length-1?e[c]=r:Ss(e[c])||(e[c]=typeof i[o+1]=="number"?[]:{}),e=e[c]}return n}function qn(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function Ut(e,t,r,n){var i=e.get(t);return typeof i>"u"&&(i=r(),e.set(t,i)),i}function Ce(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=_l(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function Wh(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var rs=0;function Et(){var e=Date.now();e=e+.01,e<=rs&&(e=rs+.01);var t=parseFloat(e.toFixed(2));return rs=t,t}function de(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var Hi={bufferSize:1,refCount:!0},kl="16.11.0",ns={},zh="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",su=16,is=br,cu=!1;async function Il(){return cu||(cu=!0,is=(async()=>!!(ns.premium&&typeof ns.premium=="string"&&await wl(ns.premium)===zh))()),is}function xi(e,t){return xi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},xi(e,t)}function Zs(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,xi(e,t)}function xs(e){return xs=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},xs(e)}function Vh(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function Cl(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Cl=function(){return!!e})()}function Qh(e,t,r){if(Cl())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&xi(i,r.prototype),i}function Va(e){var t=typeof Map=="function"?new Map:void 0;return Va=function(n){if(n===null||!Vh(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,i)}function i(){return Qh(n,arguments,xs(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),xi(i,n)},Va(e)}var xe={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return`
        RxDB Error-Code: `+e+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function Gh(e){var t="";return Object.keys(e).length===0||(t+="-".repeat(20)+`
`,t+=`Parameters:
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(i=>JSON.stringify(i,Object.getOwnPropertyNames(i))):n=JSON.stringify(e[r],function(i,o){return o===void 0?null:o},2)}catch{}return r+": "+n}).join(`
`),t+=`
`),t}function Dl(e,t,r){return`
`+e+`
`+Gh(r)}var Yh=function(e){function t(n,i,o={}){var c,l=Dl(i,n,o);return c=e.call(this,l)||this,c.code=n,c.message=l,c.url=ec(n),c.parameters=o,c.rxdb=!0,c}Zs(t,e);var r=t.prototype;return r.toString=function(){return this.message},Hr(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(Va(Error)),Jh=function(e){function t(n,i,o={}){var c,l=Dl(i,n,o);return c=e.call(this,l)||this,c.code=n,c.message=l,c.url=ec(n),c.parameters=o,c.rxdb=!0,c}Zs(t,e);var r=t.prototype;return r.toString=function(){return this.message},Hr(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])}(Va(TypeError));function ec(e){return"https://rxdb.info/errors.html?console=errors#"+e}function Ol(e){return`
Find out more about this error here: `+ec(e)+` 
`}function Z(e,t){return new Yh(e,xe.tunnelErrorMessage(e)+Ol(e),t)}function Lt(e,t){return new Jh(e,xe.tunnelErrorMessage(e)+Ol(e),t)}function oo(e){return e&&e.status===409?e:!1}var Xh={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function Pl(e){return Z("COL20",{name:Xh[e.status],document:e.documentId,writeError:e})}var ki={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function pt(e,t){ki[e].length>0&&ki[e].forEach(r=>r(t))}async function Ui(e,t){for(var r of ki[e])await r(t)}function Fn(e,t){var r=t;r=r.replace(Kh,".properties."),r="properties."+r,r=di(r);var n=Kr(e,r);return n}function Zh(e,t,r){if(typeof t.primaryKey=="string")return r;var n=bn(t,r),i=r[e];if(i&&i!==n)throw Z("DOC19",{args:{documentData:r,existingPrimary:i,newPrimary:n},schema:t});return r[e]=n,r}function St(e){return typeof e=="string"?e:e.key}function em(e){var t=St(e.primaryKey),r=Fn(e,t);return de(r.maxLength)}function bn(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var i=Kr(t,n);if(typeof i>"u")throw Z("DOC18",{args:{field:n,documentData:t}});return i}).join(r.separator)}function tm(e){var t=za(e,!0);return t}function rm(e){return["_deleted",e]}function so(e){e=Be(e);var t=St(e.primaryKey);e.properties=Be(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=nm,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=Rl(e);pn(e.required,r),e.required=e.required.filter(o=>!o.includes(".")).filter((o,c,l)=>l.indexOf(o)===c),e.version=e.version||0;var n=e.indexes.map(o=>{var c=Wa(o)?o.slice(0):[o];return c.includes(t)||c.push(t),c[0]!=="_deleted"&&c.unshift("_deleted"),c});n.length===0&&n.push(rm(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(o=>{n.push(o)});var i=new Set;return n.filter(o=>{var c=o.join(",");return i.has(c)?!1:(i.add(c),!0)}),e.indexes=n,e}var nm={type:"object",properties:{lwt:{type:"number",minimum:Js,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Rl(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=St(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function im(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var i=r[n];(!Object.prototype.hasOwnProperty.call(t,i)||typeof t[i]>"u")&&(t[i]=e.defaultValues[i])}return t}var Ll=function(){function e(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=am(this.jsonSchema),this.primaryPath=St(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw Z("SC39",{schema:r});this.finalFields=Rl(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,i){this.finalFields.forEach(o=>{if(!Si(n[o],i[o]))throw Z("DOC9",{dataBefore:n,dataAfter:i,fieldName:o,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},i=Fn(this.jsonSchema,"");return Object.keys(i).forEach(o=>{var c=o;n.__defineGetter__(o,function(){if(!(!this.get||typeof this.get!="function")){var l=this.get(c);return l}}),Object.defineProperty(n,o+"$",{get:function(){return this.get$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"$$",{get:function(){return this.get$$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"_",{get:function(){return this.populate(c)},enumerable:!1,configurable:!1})}),mr(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return bn(this.jsonSchema,n)},Hr(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,i])=>r[n]=i.default),mr(this,"defaultValues",r)}},{key:"hash",get:function(){return mr(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])}();function am(e){return(e.indexes||[]).map(t=>Wa(t)?t:[t])}function om(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function sm(e,t,r=!0){r&&pt("preCreateRxSchema",e);var n=so(e);n=tm(n),xe.deepFreezeWhenDevMode(n);var i=new Ll(n,t);return pt("createRxSchema",i),i}function Ve(e){return typeof e=="function"}function cm(e){return Ve(e==null?void 0:e.lift)}function rr(e){return function(t){if(cm(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var ks=function(e,t){return ks=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},ks(e,t)};function wn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");ks(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function um(e,t,r,n){function i(o){return o instanceof r?o:new r(function(c){c(o)})}return new(r||(r=Promise))(function(o,c){function l(m){try{v(n.next(m))}catch(g){c(g)}}function d(m){try{v(n.throw(m))}catch(g){c(g)}}function v(m){m.done?o(m.value):i(m.value).then(l,d)}v((n=n.apply(e,t||[])).next())})}function $l(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=l(0),c.throw=l(1),c.return=l(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(v){return function(m){return d([v,m])}}function d(v){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,v[0]&&(r=0)),r;)try{if(n=1,i&&(o=v[0]&2?i.return:v[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,v[1])).done)return o;switch(i=0,o&&(v=[v[0]&2,o.value]),v[0]){case 0:case 1:o=v;break;case 4:return r.label++,{value:v[1],done:!1};case 5:r.label++,i=v[1],v=[0];continue;case 7:v=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(v[0]===6||v[0]===2)){r=0;continue}if(v[0]===3&&(!o||v[1]>o[0]&&v[1]<o[3])){r.label=v[1];break}if(v[0]===6&&r.label<o[1]){r.label=o[1],o=v;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(v);break}o[2]&&r.ops.pop(),r.trys.pop();continue}v=t.call(e,r)}catch(m){v=[6,m],i=0}finally{n=o=0}if(v[0]&5)throw v[1];return{value:v[0]?v[1]:void 0,done:!0}}}function Kn(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function vn(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,o=[],c;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(l){c={error:l}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return o}function gn(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}function Rn(e){return this instanceof Rn?(this.v=e,this):new Rn(e)}function lm(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,o=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),l("next"),l("throw"),l("return",c),i[Symbol.asyncIterator]=function(){return this},i;function c(E){return function(_){return Promise.resolve(_).then(E,g)}}function l(E,_){n[E]&&(i[E]=function(D){return new Promise(function(A,j){o.push([E,D,A,j])>1||d(E,D)})},_&&(i[E]=_(i[E])))}function d(E,_){try{v(n[E](_))}catch(D){S(o[0][3],D)}}function v(E){E.value instanceof Rn?Promise.resolve(E.value.v).then(m,g):S(o[0][2],E)}function m(E){d("next",E)}function g(E){d("throw",E)}function S(E,_){E(_),o.shift(),o.length&&d(o[0][0],o[0][1])}}function fm(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof Kn=="function"?Kn(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(o){r[o]=e[o]&&function(c){return new Promise(function(l,d){c=e[o](c),i(l,d,c.done,c.value)})}}function i(o,c,l,d){Promise.resolve(d).then(function(v){o({value:v,done:l})},c)}}var Ml=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function Tl(e){return Ve(e==null?void 0:e.then)}function tc(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var as=tc(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function Is(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var co=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,i,o;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var l=Kn(c),d=l.next();!d.done;d=l.next()){var v=d.value;v.remove(this)}}catch(D){t={error:D}}finally{try{d&&!d.done&&(r=l.return)&&r.call(l)}finally{if(t)throw t.error}}else c.remove(this);var m=this.initialTeardown;if(Ve(m))try{m()}catch(D){o=D instanceof as?D.errors:[D]}var g=this._finalizers;if(g){this._finalizers=null;try{for(var S=Kn(g),E=S.next();!E.done;E=S.next()){var _=E.value;try{uu(_)}catch(D){o=o??[],D instanceof as?o=gn(gn([],vn(o)),vn(D.errors)):o.push(D)}}}catch(D){n={error:D}}finally{try{E&&!E.done&&(i=S.return)&&i.call(S)}finally{if(n)throw n.error}}}if(o)throw new as(o)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)uu(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&Is(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&Is(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),Al=co.EMPTY;function Bl(e){return e instanceof co||e&&"closed"in e&&Ve(e.remove)&&Ve(e.add)&&Ve(e.unsubscribe)}function uu(e){Ve(e)?e():e.unsubscribe()}var dm={Promise:void 0},hm={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,gn([e,t],vn(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Nl(e){hm.setTimeout(function(){throw e})}function lu(){}function Ta(e){e()}var rc=function(e){wn(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,Bl(r)&&r.add(n)):n.destination=vm,n}return t.create=function(r,n,i){return new Hn(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(co),mm=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){Pa(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){Pa(n)}else Pa(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){Pa(r)}},e}(),Hn=function(e){wn(t,e);function t(r,n,i){var o=e.call(this)||this,c;return Ve(r)||!r?c={next:r??void 0,error:n??void 0,complete:i??void 0}:c=r,o.destination=new mm(c),o}return t}(rc);function Pa(e){Nl(e)}function pm(e){throw e}var vm={closed:!0,next:lu,error:pm,complete:lu},nc=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Wi(e){return e}function gm(e){return e.length===0?Wi:e.length===1?e[0]:function(r){return e.reduce(function(n,i){return i(n)},r)}}var wt=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var i=this,o=bm(t)?t:new Hn(t,r,n);return Ta(function(){var c=i,l=c.operator,d=c.source;o.add(l?l.call(o,d):d?i._subscribe(o):i._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=fu(r),new r(function(i,o){var c=new Hn({next:function(l){try{t(l)}catch(d){o(d),c.unsubscribe()}},error:o,complete:i});n.subscribe(c)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[nc]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return gm(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=fu(t),new t(function(n,i){var o;r.subscribe(function(c){return o=c},function(c){return i(c)},function(){return n(o)})})},e.create=function(t){return new e(t)},e}();function fu(e){var t;return(t=e??dm.Promise)!==null&&t!==void 0?t:Promise}function ym(e){return e&&Ve(e.next)&&Ve(e.error)&&Ve(e.complete)}function bm(e){return e&&e instanceof rc||ym(e)&&Bl(e)}function jl(e){return Ve(e[nc])}function ql(e){return Symbol.asyncIterator&&Ve(e==null?void 0:e[Symbol.asyncIterator])}function Fl(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function wm(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Kl=wm();function Hl(e){return Ve(e==null?void 0:e[Kl])}function Ul(e){return lm(this,arguments,function(){var r,n,i,o;return $l(this,function(c){switch(c.label){case 0:r=e.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,Rn(r.read())];case 3:return n=c.sent(),i=n.value,o=n.done,o?[4,Rn(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,Rn(i)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function Wl(e){return Ve(e==null?void 0:e.getReader)}function Sr(e){if(e instanceof wt)return e;if(e!=null){if(jl(e))return _m(e);if(Ml(e))return Em(e);if(Tl(e))return Sm(e);if(ql(e))return zl(e);if(Hl(e))return xm(e);if(Wl(e))return km(e)}throw Fl(e)}function _m(e){return new wt(function(t){var r=e[nc]();if(Ve(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Em(e){return new wt(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function Sm(e){return new wt(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Nl)})}function xm(e){return new wt(function(t){var r,n;try{for(var i=Kn(e),o=i.next();!o.done;o=i.next()){var c=o.value;if(t.next(c),t.closed)return}}catch(l){r={error:l}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}t.complete()})}function zl(e){return new wt(function(t){Im(e,t).catch(function(r){return t.error(r)})})}function km(e){return zl(Ul(e))}function Im(e,t){var r,n,i,o;return um(this,void 0,void 0,function(){var c,l;return $l(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),r=fm(e),d.label=1;case 1:return[4,r.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(c=n.value,t.next(c),t.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=d.sent(),i={error:l},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(o=r.return)?[4,o.call(r)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function wr(e,t,r,n,i){return new Cm(e,t,r,n,i)}var Cm=function(e){wn(t,e);function t(r,n,i,o,c,l){var d=e.call(this,r)||this;return d.onFinalize=c,d.shouldUnsubscribe=l,d._next=n?function(v){try{n(v)}catch(m){r.error(m)}}:e.prototype._next,d._error=o?function(v){try{o(v)}catch(m){r.error(m)}finally{this.unsubscribe()}}:e.prototype._error,d._complete=i?function(){try{i()}catch(v){r.error(v)}finally{this.unsubscribe()}}:e.prototype._complete,d}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(rc),Vl={now:function(){return(Vl.delegate||Date).now()},delegate:void 0};function Dm(e){return e&&Ve(e.schedule)}function ic(e){return e[e.length-1]}function Om(e){return Ve(ic(e))?e.pop():void 0}function zi(e){return Dm(ic(e))?e.pop():void 0}function Ql(e,t){return typeof ic(e)=="number"?e.pop():t}function qr(e,t,r,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var o=t.schedule(function(){r(),i?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(o),!i)return o}var Pm=Array.isArray,Rm=Object.getPrototypeOf,Lm=Object.prototype,$m=Object.keys;function Mm(e){if(e.length===1){var t=e[0];if(Pm(t))return{args:t,keys:null};if(Tm(t)){var r=$m(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function Tm(e){return e&&typeof e=="object"&&Rm(e)===Lm}function Gl(e,t){return t===void 0&&(t=0),rr(function(r,n){r.subscribe(wr(n,function(i){return qr(n,e,function(){return n.next(i)},t)},function(){return qr(n,e,function(){return n.complete()},t)},function(i){return qr(n,e,function(){return n.error(i)},t)}))})}function Yl(e,t){return t===void 0&&(t=0),rr(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function Am(e,t){return Sr(e).pipe(Yl(t),Gl(t))}function Bm(e,t){return Sr(e).pipe(Yl(t),Gl(t))}function Nm(e,t){return new wt(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function jm(e,t){return new wt(function(r){var n;return qr(r,t,function(){n=e[Kl](),qr(r,t,function(){var i,o,c;try{i=n.next(),o=i.value,c=i.done}catch(l){r.error(l);return}c?r.complete():r.next(o)},0,!0)}),function(){return Ve(n==null?void 0:n.return)&&n.return()}})}function Jl(e,t){if(!e)throw new Error("Iterable cannot be null");return new wt(function(r){qr(r,t,function(){var n=e[Symbol.asyncIterator]();qr(r,t,function(){n.next().then(function(i){i.done?r.complete():r.next(i.value)})},0,!0)})})}function qm(e,t){return Jl(Ul(e),t)}function Fm(e,t){if(e!=null){if(jl(e))return Am(e,t);if(Ml(e))return Nm(e,t);if(Tl(e))return Bm(e,t);if(ql(e))return Jl(e,t);if(Hl(e))return jm(e,t);if(Wl(e))return qm(e,t)}throw Fl(e)}function Vi(e,t){return t?Fm(e,t):Sr(e)}function Ue(e,t){return rr(function(r,n){var i=0;r.subscribe(wr(n,function(o){n.next(e.call(t,o,i++))}))})}var Km=Array.isArray;function Hm(e,t){return Km(t)?e.apply(void 0,gn([],vn(t))):e(t)}function Um(e){return Ue(function(t){return Hm(e,t)})}function Wm(e,t){return e.reduce(function(r,n,i){return r[n]=t[i],r},{})}function zm(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=zi(e),n=Om(e),i=Mm(e),o=i.args,c=i.keys;if(o.length===0)return Vi([],r);var l=new wt(Vm(o,r,c?function(d){return Wm(c,d)}:Wi));return n?l.pipe(Um(n)):l}function Vm(e,t,r){return r===void 0&&(r=Wi),function(n){du(t,function(){for(var i=e.length,o=new Array(i),c=i,l=i,d=function(m){du(t,function(){var g=Vi(e[m],t),S=!1;g.subscribe(wr(n,function(E){o[m]=E,S||(S=!0,l--),l||n.next(r(o.slice()))},function(){--c||n.complete()}))},n)},v=0;v<i;v++)d(v)},n)}}function du(e,t,r){e?qr(r,e,t):t()}function Qm(e,t,r,n,i,o,c,l){var d=[],v=0,m=0,g=!1,S=function(){g&&!d.length&&!v&&t.complete()},E=function(D){return v<n?_(D):d.push(D)},_=function(D){v++;var A=!1;Sr(r(D,m++)).subscribe(wr(t,function(j){t.next(j)},function(){A=!0},void 0,function(){if(A)try{v--;for(var j=function(){var K=d.shift();c||_(K)};d.length&&v<n;)j();S()}catch(K){t.error(K)}}))};return e.subscribe(wr(t,E,function(){g=!0,S()})),function(){}}function _r(e,t,r){return r===void 0&&(r=1/0),Ve(t)?_r(function(n,i){return Ue(function(o,c){return t(n,o,i,c)})(Sr(e(n,i)))},r):(typeof t=="number"&&(r=t),rr(function(n,i){return Qm(n,i,e,r)}))}function ac(e){return e===void 0&&(e=1/0),_r(Wi,e)}function Gm(){return ac(1)}var Ym=tc(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Tt=function(e){wn(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new hu(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new Ym},t.prototype.next=function(r){var n=this;Ta(function(){var i,o;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var c=Kn(n.currentObservers),l=c.next();!l.done;l=c.next()){var d=l.value;d.next(r)}}catch(v){i={error:v}}finally{try{l&&!l.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}}})},t.prototype.error=function(r){var n=this;Ta(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var i=n.observers;i.length;)i.shift().error(r)}})},t.prototype.complete=function(){var r=this;Ta(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,i=this,o=i.hasError,c=i.isStopped,l=i.observers;return o||c?Al:(this.currentObservers=null,l.push(r),new co(function(){n.currentObservers=null,Is(l,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,i=n.hasError,o=n.thrownError,c=n.isStopped;i?r.error(o):c&&r.complete()},t.prototype.asObservable=function(){var r=new wt;return r.source=this,r},t.create=function(r,n){return new hu(r,n)},t}(wt),hu=function(e){wn(t,e);function t(r,n){var i=e.call(this)||this;return i.destination=r,i.source=n,i}return t.prototype.next=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.next)===null||i===void 0||i.call(n,r)},t.prototype.error=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.error)===null||i===void 0||i.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,i;return(i=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&i!==void 0?i:Al},t}(Tt);function mu(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Gm()(Vi(e,zi(e)))}var Jm=new wt(function(e){return e.complete()});function Ii(e,t){return t===void 0&&(t=Wi),e=e??Xm,rr(function(r,n){var i,o=!0;r.subscribe(wr(n,function(c){var l=t(c);(o||!e(i,l))&&(o=!1,i=l,n.next(c))}))})}function Xm(e,t){return e===t}function De(e,t){return rr(function(r,n){var i=0;r.subscribe(wr(n,function(o){return e.call(t,o,i++)&&n.next(o)}))})}var Zm=tc(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function ep(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=zi(e),n=Ql(e,1/0);return rr(function(i,o){ac(n)(Vi(gn([i],vn(e)),r)).subscribe(o)})}function tp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ep.apply(void 0,gn([],vn(e)))}var Lr=function(e){wn(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,i=r.thrownError,o=r._value;if(n)throw i;return this._throwIfClosed(),o},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(Tt),rp=function(e){wn(t,e);function t(r,n,i){r===void 0&&(r=1/0),n===void 0&&(n=1/0),i===void 0&&(i=Vl);var o=e.call(this)||this;return o._bufferSize=r,o._windowTime=n,o._timestampProvider=i,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=n===1/0,o._bufferSize=Math.max(1,r),o._windowTime=Math.max(1,n),o}return t.prototype.next=function(r){var n=this,i=n.isStopped,o=n._buffer,c=n._infiniteTimeWindow,l=n._timestampProvider,d=n._windowTime;i||(o.push(r),!c&&o.push(l.now()+d)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),i=this,o=i._infiniteTimeWindow,c=i._buffer,l=c.slice(),d=0;d<l.length&&!r.closed;d+=o?1:2)r.next(l[d]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,i=r._timestampProvider,o=r._buffer,c=r._infiniteTimeWindow,l=(c?1:2)*n;if(n<1/0&&l<o.length&&o.splice(0,o.length-l),!c){for(var d=i.now(),v=0,m=1;m<o.length&&o[m]<=d;m+=2)v=m;v&&o.splice(0,v+1)}},t}(Tt);function np(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new Tt}:t,n=e.resetOnError,i=n===void 0?!0:n,o=e.resetOnComplete,c=o===void 0?!0:o,l=e.resetOnRefCountZero,d=l===void 0?!0:l;return function(v){var m,g,S,E=0,_=!1,D=!1,A=function(){g==null||g.unsubscribe(),g=void 0},j=function(){A(),m=S=void 0,_=D=!1},K=function(){var Y=m;j(),Y==null||Y.unsubscribe()};return rr(function(Y,se){E++,!D&&!_&&A();var ae=S=S??r();se.add(function(){E--,E===0&&!D&&!_&&(g=os(K,d))}),ae.subscribe(se),!m&&E>0&&(m=new Hn({next:function(ee){return ae.next(ee)},error:function(ee){D=!0,A(),g=os(j,i,ee),ae.error(ee)},complete:function(){_=!0,A(),g=os(j,c),ae.complete()}}),Sr(Y).subscribe(m))})(v)}}function os(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var i=new Hn({next:function(){i.unsubscribe(),e()}});return Sr(t.apply(void 0,gn([],vn(r)))).subscribe(i)}}function Qi(e,t,r){var n,i,o,c,l=!1;return e&&typeof e=="object"?(n=e.bufferSize,c=n===void 0?1/0:n,i=e.windowTime,t=i===void 0?1/0:i,o=e.refCount,l=o===void 0?!1:o,r=e.scheduler):c=e??1/0,np({connector:function(){return new rp(c,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:l})}function Gi(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=zi(e);return rr(function(n,i){(r?mu(e,n,r):mu(e,n)).subscribe(i)})}function ip(e,t){return rr(function(r,n){var i=null,o=0,c=!1,l=function(){return c&&!i&&n.complete()};r.subscribe(wr(n,function(d){i==null||i.unsubscribe();var v=0,m=o++;Sr(e(d,m)).subscribe(i=wr(n,function(g){return n.next(t?t(d,g,m,v++):g)},function(){i=null,l()}))},function(){c=!0,l()}))})}function Xl(e){return e.documentData?e.documentData:e.previousDocumentData}function ap(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:xe.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var op=new Map;function Zl(e){return Ut(op,e,()=>{for(var t=new Array(e.events.length),r=e.events,n=e.collectionName,i=e.isLocal,o=xe.deepFreezeWhenDevMode,c=0;c<r.length;c++){var l=r[c];t[c]={documentId:l.documentId,collectionName:n,isLocal:i,operation:l.operation,documentData:o(l.documentData),previousDocumentData:o(l.previousDocumentData)}}return t})}function dn(e,t){return new Promise(function(r,n){var i=new Hn({next:function(o){r(o),i.unsubscribe()},error:n,complete:function(){n(new Zm)}});e.subscribe(i)})}function sp(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=zi(e),n=Ql(e,1/0),i=e;return i.length?i.length===1?Sr(i[0]):ac(n)(Vi(i,r)):Jm}var Ln="ï¿¿",$n=Number.MIN_SAFE_INTEGER;function cp(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var i=!!t.sort.find(m=>Object.values(m)[0]==="desc"),o=new Set;Object.keys(r).forEach(m=>{var g=Fn(e,m);g&&g.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[m],"$eq")&&o.add(m)});var c=t.sort.map(m=>Object.keys(m)[0]),l=c.filter(m=>!o.has(m)).join(","),d=-1,v;if(n.forEach(m=>{var g=!0,S=!0,E=m.map(K=>{var Y=r[K],se=Y?Object.keys(Y):[],ae={};if(!Y||!se.length){var ee=S?$n:Ln;ae={startKey:ee,endKey:g?Ln:$n,inclusiveStart:!0,inclusiveEnd:!0}}else se.forEach(ne=>{if(oc.has(ne)){var me=Y[ne],_e=dp(ne,me);ae=Object.assign(ae,_e)}});return typeof ae.startKey>"u"&&(ae.startKey=$n),typeof ae.endKey>"u"&&(ae.endKey=Ln),typeof ae.inclusiveStart>"u"&&(ae.inclusiveStart=!0),typeof ae.inclusiveEnd>"u"&&(ae.inclusiveEnd=!0),S&&!ae.inclusiveStart&&(S=!1),g&&!ae.inclusiveEnd&&(g=!1),ae}),_=E.map(K=>K.startKey),D=E.map(K=>K.endKey),A={index:m,startKeys:_,endKeys:D,inclusiveEnd:g,inclusiveStart:S,sortSatisfiedByIndex:!i&&l===m.filter(K=>!o.has(K)).join(","),selectorSatisfiedByIndex:fp(m,t.selector,_,D)},j=hp(e,t,A);(j>=d||t.index)&&(d=j,v=A)}),!v)throw Z("SNH",{query:t});return v}var oc=new Set(["$eq","$gt","$gte","$lt","$lte"]),up=new Set(["$eq","$gt","$gte"]),lp=new Set(["$eq","$lt","$lte"]);function fp(e,t,r,n){var i=Object.entries(t),o=i.find(([ne,me])=>{if(!e.includes(ne))return!0;var _e=Object.entries(me).find(([Ne,Pe])=>!oc.has(Ne));return _e});if(o||t.$and||t.$or)return!1;var c=[],l=new Set;for(var[d,v]of Object.entries(t)){if(!e.includes(d))return!1;var m=Object.keys(v).filter(ne=>up.has(ne));if(m.length>1)return!1;var g=m[0];if(g&&l.add(d),g!=="$eq"){if(c.length>0)return!1;c.push(g)}}var S=[],E=new Set;for(var[_,D]of Object.entries(t)){if(!e.includes(_))return!1;var A=Object.keys(D).filter(ne=>lp.has(ne));if(A.length>1)return!1;var j=A[0];if(j&&E.add(_),j!=="$eq"){if(S.length>0)return!1;S.push(j)}}var K=0;for(var Y of e){for(var se of[l,E]){if(!se.has(Y)&&se.size>0)return!1;se.delete(Y)}var ae=r[K],ee=n[K];if(ae!==ee&&l.size>0&&E.size>0)return!1;K++}return!0}function dp(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function hp(e,t,r){var n=0,i=m=>{m>0&&(n=n+m)},o=10,c=Zo(r.startKeys,m=>m!==$n&&m!==Ln);i(c*o);var l=Zo(r.startKeys,m=>m!==Ln&&m!==$n);i(l*o);var d=Zo(r.startKeys,(m,g)=>m===r.endKeys[g]);i(d*o*1.5);var v=r.sortSatisfiedByIndex?5:0;return i(v),n}class Yi extends Error{}const Ci=Symbol("missing"),ef=Object.freeze(new Error("mingo: cycle detected while processing object/array")),Ji=e=>{const t=Aa(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},Nr=e=>typeof e!="object"&&typeof e!="function"||e===null,tf=e=>Nr(e)||Un(e)||pr(e),rf={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},At=(e,t)=>{e===Ci&&(e=void 0),t===Ci&&(t=void 0);const[r,n]=[e,t].map(i=>rf[Oi(i)]||0);return r!==n?r-n:Kt(e,t)?0:e<t?-1:e>t?1:0};var Ni,ur,un;const Ic=class Ic extends Map{constructor(){super();Ke(this,Ni,Ji);Ke(this,ur,new Map);Ke(this,un,r=>{const n=Q(this,Ni).call(this,r);return[(Q(this,ur).get(n)||[]).find(i=>Kt(i,r)),n]})}static init(r){const n=new Ic;return r&&He(n,Ni,r),n}clear(){super.clear(),Q(this,ur).clear()}delete(r){if(Nr(r))return super.delete(r);const[n,i]=Q(this,un).call(this,r);return super.delete(n)?(Q(this,ur).set(i,Q(this,ur).get(i).filter(o=>!Kt(o,n))),!0):!1}get(r){if(Nr(r))return super.get(r);const[n,i]=Q(this,un).call(this,r);return super.get(n)}has(r){if(Nr(r))return super.has(r);const[n,i]=Q(this,un).call(this,r);return super.has(n)}set(r,n){if(Nr(r))return super.set(r,n);const[i,o]=Q(this,un).call(this,r);if(super.has(i))super.set(i,n);else{super.set(r,n);const c=Q(this,ur).get(o)||[];c.push(r),Q(this,ur).set(o,c)}return this}get size(){return super.size}};Ni=new WeakMap,ur=new WeakMap,un=new WeakMap;let Di=Ic;function ke(e,t){if(!e)throw new Yi(t)}const mp=Object.keys(rf).reduce((e,t)=>(e["[object "+t[0].toUpperCase()+t.substring(1)+"]"]=t,e),{});function Oi(e){var r,n;const t=Object.prototype.toString.call(e);return t==="[object Object]"?((n=(r=e==null?void 0:e.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":mp[t]||t.substring(8,t.length-1).toLowerCase()}const Mn=e=>typeof e=="boolean",Wt=e=>typeof e=="string",pp=e=>typeof e=="symbol",Ze=e=>!isNaN(e)&&typeof e=="number",be=Array.isArray;function We(e){if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&Oi(e)==="object"}const nf=e=>!Nr(e),Un=e=>e instanceof Date,pr=e=>e instanceof RegExp,uo=e=>typeof e=="function",_t=e=>e==null,Wn=(e,t=!0)=>!!e||t&&e==="",sc=e=>_t(e)||Wt(e)&&!e||be(e)&&e.length===0||We(e)&&Object.keys(e).length===0,Jn=e=>be(e)?e:[e],zt=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),vp=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),zn=(e,t)=>{if(_t(e)||Mn(e)||Ze(e)||Wt(e))return e;if(Un(e))return new Date(e);if(pr(e))return new RegExp(e);if(vp(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw ef;t.add(e);try{if(be(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=zn(e[n],t);return r}if(We(e)){const r={};for(const n of Object.keys(e))r[n]=zn(e[n],t);return r}}finally{t.delete(e)}return e},pu=e=>e===Ci;function Cs(e,t){if(pu(e)||_t(e))return t;if(pu(t)||_t(t))return e;if(Nr(e)||Nr(t))return t;be(e)&&be(t)&&ke(e.length===t.length,"arrays must be of equal length to merge.");for(const r of Object.keys(t))e[r]=Cs(e[r],t[r]);return e}function af(e,t=Ji){const r=[Di.init(t),Di.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(i=>{r[0].has(i)&&r[1].set(i,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function of(e,t=1){const r=new Array;function n(i,o){for(let c=0,l=i.length;c<l;c++)be(i[c])&&(o>0||o<0)?n(i[c],Math.max(-1,o-1)):r.push(i[c])}return n(e,t),r}function gp(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}function sf(e){for(;e;){if(Object.getOwnPropertyNames(e).includes("toString"))return e.toString!==Object.prototype.toString;e=Object.getPrototypeOf(e)}return!1}function Kt(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object"||e.constructor!==t.constructor)return!1;if(e instanceof Date)return+e==+t;if(e instanceof RegExp)return e.toString()===t.toString();const r=e.constructor;if(r===Array||r===Object){const n=Object.keys(e).sort(),i=Object.keys(t).sort();if(n.length!==i.length)return!1;for(let o=0,c=n[o];o<n.length;c=n[++o])if(c!==i[o]||!Kt(e[c],t[c]))return!1;return!0}return sf(e)&&e.toString()===t.toString()}function yp(e,t=Ji){const r=Di.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}const Aa=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";if(Wt(e)||Ze(e)||Mn(e))return JSON.stringify(e);if(Un(e))return e.toISOString();if(pr(e)||pp(e)||uo(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw ef;try{if(t.add(e),be(e))return"["+e.map(n=>Aa(n,t)).join(",")+"]";if(We(e))return"{"+Object.keys(e).sort().map(i=>`${i}:${Aa(e[i],t)}`).join()+"}";const r=sf(e)?e.toString():Aa(gp(e),t);return Oi(e)+"("+r+")"}finally{t.delete(e)}};function bp(e,t){return _t(e)?null:(t=t||Ji,t(e))}function wp(e,t,r=Ji){if(e.length<1)return new Map;const n=new Map,i=new Map;for(let o=0;o<e.length;o++){const c=e[o],l=t(c,o),d=bp(l,r);if(d===null)i.has(null)?i.get(null).push(c):i.set(null,[c]);else{const v=n.has(d)?n.get(d).find(m=>Kt(m,l)):null;_t(v)?(i.set(l,[c]),n.has(d)?n.get(d).push(l):n.set(d,[l])):i.get(v).push(c)}}return i}function Ds(e,t){return nf(e)?e[t]:void 0}function _p(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function tr(e,t,r){let n=0;function i(c,l){let d=c;for(let v=0;v<l.length;v++){const m=l[v];if(/^\d+$/.exec(m)===null&&be(d)){if(v===0&&n>0)break;n+=1;const S=l.slice(v);d=d.reduce((E,_)=>{const D=i(_,S);return D!==void 0&&E.push(D),E},[]);break}else d=Ds(d,m);if(d===void 0)break}return d}const o=tf(e)?e:i(e,t.split("."));return be(o)&&(r!=null&&r.unwrapArray)?_p(o,n):o}function pi(e,t,r){const n=t.indexOf("."),i=n==-1?t:t.substring(0,n),o=t.substring(n+1),c=n!=-1;if(be(e)){const v=/^\d+$/.test(i),m=v&&(r!=null&&r.preserveIndex)?[...e]:[];if(v){const g=parseInt(i);let S=Ds(e,g);c&&(S=pi(S,o,r)),r!=null&&r.preserveIndex?m[g]=S:m.push(S)}else for(const g of e){const S=pi(g,t,r);r!=null&&r.preserveMissing?m.push(S??Ci):(S!=null||r!=null&&r.preserveIndex)&&m.push(S)}return m}const l=r!=null&&r.preserveKeys?{...e}:{};let d=Ds(e,i);if(c&&(d=pi(d,o,r)),d!==void 0)return l[i]=d,l}function Os(e){if(be(e))for(let t=e.length-1;t>=0;t--)e[t]===Ci?e.splice(t,1):Os(e[t]);else if(We(e))for(const t in e)zt(e,t)&&Os(e[t])}const vu=/^\d+$/;function Pi(e,t,r,n){const i=t.split("."),o=i[0],c=i.slice(1).join(".");if(i.length===1)(We(e)||be(e)&&vu.test(o))&&r(e,o);else{n!=null&&n.buildGraph&&_t(e[o])&&(e[o]={});const l=e[o];if(!l)return;const d=!!(i.length>1&&vu.test(i[1]));be(l)&&(n!=null&&n.descendArray)&&!d?l.forEach(v=>Pi(v,c,r,n)):Pi(l,c,r,n)}}function Ep(e,t,r){Pi(e,t,(n,i)=>{n[i]=uo(r)?r(n[i]):r},{buildGraph:!0})}function gu(e,t,r){Pi(e,t,(n,i)=>{if(be(n)){if(/^\d+$/.test(i))n.splice(parseInt(i),1);else if(r&&r.descendArray)for(const o of n)We(o)&&delete o[i]}else We(n)&&delete n[i]},r)}const Sp=/^\$[a-zA-Z0-9_]+$/;function Ur(e){return Sp.test(e)}function cf(e){if(tf(e))return pr(e)?{$regex:e}:{$eq:e};if(nf(e)){if(!Object.keys(e).some(Ur))return{$eq:e};if(zt(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var Ps=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(Ps||{}),Xe,ji,lr;const _i=class _i{constructor(t,r,n){Ke(this,Xe);Ke(this,ji);Ke(this,lr);He(this,Xe,t),this.update(r,n)}static init(t,r,n){var i;return t instanceof _i?new _i(Q(t,Xe),t.root??r,{...Q(t,lr),...n,variables:Object.assign({},(i=Q(t,lr))==null?void 0:i.variables,n==null?void 0:n.variables)}):new _i(t,r,n)}update(t,r){var i;He(this,ji,t);const n=Object.assign({},(i=Q(this,lr))==null?void 0:i.variables,r==null?void 0:r.variables);return Object.keys(n).length?He(this,lr,{...r,variables:n}):He(this,lr,r??{}),this}getOptions(){return Object.freeze({...Q(this,Xe),context:yn.from(Q(this,Xe).context)})}get root(){return Q(this,ji)}get local(){return Q(this,lr)}get idKey(){return Q(this,Xe).idKey}get collation(){var t;return(t=Q(this,Xe))==null?void 0:t.collation}get processingMode(){var t;return((t=Q(this,Xe))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=Q(this,Xe))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=Q(this,Xe))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=Q(this,Xe))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=Q(this,Xe))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=Q(this,Xe))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=Q(this,Xe))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=Q(this,Xe))==null?void 0:t.variables}get context(){var t;return(t=Q(this,Xe))==null?void 0:t.context}};Xe=new WeakMap,ji=new WeakMap,lr=new WeakMap;let Ri=_i;function uf(e){return e instanceof Ri?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:e!=null&&e.context?yn.from(e==null?void 0:e.context):yn.init()})}var Rs=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(Rs||{}),Tr;const io=class io{constructor(){Ke(this,Tr,new Map)}static init(){return new io}static from(t){const r=io.init();return _t(t)||Q(t,Tr).forEach((n,i)=>r.addOperators(i,n)),r}addOperators(t,r){Q(this,Tr).has(t)||Q(this,Tr).set(t,{});for(const[n,i]of Object.entries(r))this.getOperator(t,n)||(Q(this,Tr).get(t)[n]=i);return this}getOperator(t,r){return(Q(this,Tr).get(t)??{})[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};Tr=new WeakMap;let yn=io;const on=yn.init();function yu(e,t){for(const[r,n]of Object.entries(t)){ke(uo(n)&&Ur(r),`'${r}' is not a valid operator`);const i=Li(e,r,null);ke(!i||n===i,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":on.addAccumulatorOps(t);break;case"expression":on.addExpressionOps(t);break;case"pipeline":on.addPipelineOps(t);break;case"projection":on.addProjectionOps(t);break;case"query":on.addQueryOps(t);break;case"window":on.addWindowOps(t);break}}function Li(e,t,r){const{context:n,useGlobalContext:i}=r||{},o=n?n.getOperator(e,t):null;return!o&&i?on.getOperator(e,t):o}function $t(e,t,r,n){const i=Ri.init(n,e);return r&&Ur(r)?lf(e,t,r,i):Qa(e,t,i)}const xp=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Qa(e,t,r){var n;if(Wt(t)&&t.length>0&&t[0]==="$"){if(kp.includes(t))return t;let i=r.root;const o=t.split(".");if(xp.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":i=e;break;case"$$REMOVE":i=void 0;break;case"$$NOW":i=new Date;break}t=t.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){i=Object.assign({},r.variables,{this:e},(n=r==null?void 0:r.local)==null?void 0:n.variables);const c=o[0].slice(2);ke(zt(i,c),`Use of undefined variable: ${c}`),t=t.slice(2)}else t=t.slice(1);return t===""?i:tr(i,t)}if(be(t))return t.map(i=>Qa(e,i,r));if(We(t)){const i={},o=Object.entries(t);for(const[c,l]of o){if(Ur(c))return ke(o.length==1,"expression must have single operator."),lf(e,l,c,r);i[c]=Qa(e,l,r)}return i}return t}function lf(e,t,r,n){const i=Li("expression",r,n);if(i)return i(e,t,n);const o=Li("accumulator",r,n);return ke(!!o,`accumulator '${r}' is not registered.`),be(e)||(e=Qa(e,t,n),t=null),ke(be(e),`arguments must resolve to array for ${r}.`),o(e,t,n)}const kp=["$$KEEP","$$PRUNE","$$DESCEND"];function $i(e){return e instanceof bu?e:new bu(e)}function Ip(...e){let t=0;return $i(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function Cp(e){return!!e&&typeof e=="object"&&(e==null?void 0:e.next)instanceof Function}function Dp(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const Ls=new Error;function Op(e,t,r){let n=!1,i=-1,o=0;return function(c){try{e:for(;!n;){let l=e();i++;let d=-1;const v=t.length;let m=!1;for(;++d<v;){const g=t[d];switch(g.action){case 0:l=g.func(l,i);break;case 1:if(!g.func(l,i))continue e;break;case 2:--g.count,g.count||(m=!0);break;case 3:--g.count,g.count||Dp(t,d);continue e;default:break e}}if(n=m,c)r[o++]=l;else return{value:l,done:!1}}}catch(l){if(l!==Ls)throw l}return n=!0,{done:n}}}var ln,An,Bn,bl;let bu=(bl=class{constructor(t){Ke(this,ln);Ke(this,An);Ke(this,Bn);He(this,ln,[]),He(this,An,[]),this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),Cp(t)){const n=t;r=()=>{const i=n.next();if(i.done)throw Ls;return i.value}}else if(be(t)){const n=t,i=n.length;let o=0;r=()=>{if(o<i)return n[o++];throw Ls}}else if(!(t instanceof Function))throw new Yi("Lazy must be initialized with an array, generator, or function.");He(this,Bn,Op(r,Q(this,ln),Q(this,An)))}push(t,r){return typeof r=="function"?Q(this,ln).push({action:t,func:r}):typeof r=="number"&&Q(this,ln).push({action:t,count:r}),this}next(){return Q(this,Bn).call(this)}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return $i(()=>(n||(n=$i(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=Q(this,Bn).call(this,!0).done),Q(this,An)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}},ln=new WeakMap,An=new WeakMap,Bn=new WeakMap,bl);const Pp=(e,t,r)=>e.take(t),ff=(e,t,r)=>sc(t)?e:(hf(t,r),e.map(df(t,Ri.init(r))));function df(e,t,r=!0){const n=t.idKey,i=Object.keys(e),o=new Array,c=new Array,l={};for(const E of i){const _=e[E];if(Ze(_)||Mn(_))_?c.push(E):o.push(E);else if(be(_))l[E]=D=>_.map(A=>$t(D,A,null,t.update(D))??null);else if(We(_)){const D=Object.keys(_),A=D.length==1?D[0]:"",j=Li("projection",A,t);j?A==="$slice"&&!Jn(_[A]).every(Ze)?l[E]=Y=>$t(Y,_,E,t.update(Y)):l[E]=Y=>j(Y,_[A],E,t.update(Y)):Ur(A)?l[E]=K=>$t(K,_[A],A,t):(hf(_,t),l[E]=K=>{if(!zt(K,E))return $t(K,_,null,t);r&&t.update(K);const Y=tr(K,E),se=df(_,t,!1);return be(Y)?Y.map(se):We(Y)?se(Y):se(K)})}else l[E]=Wt(_)&&_[0]==="$"?D=>$t(D,_,E,t):D=>_}const d=Object.keys(l),v=o.includes(n);if(r&&v&&o.length===1&&!c.length&&!d.length)return E=>{const _={...E};return delete _[n],_};const g=r&&!v&&!c.includes(n),S={preserveMissing:!0};return E=>{const _={};if(o.length&&!c.length){Cs(_,E);for(const D of o)gu(_,D,{descendArray:!0})}for(const D of c){const A=pi(E,D,S)??{};Cs(_,A)}c.length&&Os(_);for(const D of d){const A=l[D](E);A===void 0?gu(_,D,{descendArray:!0}):Ep(_,D,A)}return g&&zt(E,n)&&(_[n]=tr(E,n)),_}}function hf(e,t){let r=!1,n=!1;for(const[i,o]of Object.entries(e))ke(!i.startsWith("$"),"Field names may not start with '$'."),ke(!i.endsWith(".$"),"Positional projection operator '$' is not supported."),i!==(t==null?void 0:t.idKey)&&(o===0||o===!1?r=!0:(o===1||o===!0)&&(n=!0),ke(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const Rp=(e,t,r)=>e.drop(t),mf=(e,t,r)=>{if(sc(t)||!We(t))return e;let n=At;const i=r.collation;return We(i)&&Wt(i.locale)&&(n=$p(i)),e.transform(o=>{const c=Object.keys(t);for(const l of c.reverse()){const d=wp(o,g=>tr(g,l),r.hashFunction),v=Array.from(d.keys()).sort(n);t[l]===-1&&v.reverse();let m=0;for(const g of v)for(const S of d.get(g))o[m++]=S;ke(m==o.length,"bug: counter must match collection size.")}return o})},Lp={1:"base",2:"accent",3:"variant"};function $p(e){const t={sensitivity:Lp[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,i)=>{if(!Wt(n)||!Wt(i))return At(n,i);const o=r.compare(n,i);return o<0?-1:o>0?1:0}}const Mp={$sort:mf,$skip:Rp,$limit:Pp};var qi,Fi,Nn,fr,Ar,bt,dr;class Tp{constructor(t,r,n,i){Ke(this,qi);Ke(this,Fi);Ke(this,Nn);Ke(this,fr);Ke(this,Ar,{});Ke(this,bt,null);Ke(this,dr,[]);He(this,qi,t),He(this,Fi,r),He(this,Nn,n),He(this,fr,i)}fetch(){if(Q(this,bt))return Q(this,bt);He(this,bt,$i(Q(this,qi)).filter(Q(this,Fi)));const t=Q(this,fr).processingMode;t&Ps.CLONE_INPUT&&Q(this,bt).map(zn);for(const r of["$sort","$skip","$limit"])zt(Q(this,Ar),r)&&He(this,bt,Mp[r](Q(this,bt),Q(this,Ar)[r],Q(this,fr)));return Object.keys(Q(this,Nn)).length&&He(this,bt,ff(Q(this,bt),Q(this,Nn),Q(this,fr))),t&Ps.CLONE_OUTPUT&&Q(this,bt).map(zn),Q(this,bt)}fetchAll(){const t=$i([...Q(this,dr)]);return He(this,dr,[]),Ip(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return Q(this,Ar).$skip=t,this}limit(t){return Q(this,Ar).$limit=t,this}sort(t){return Q(this,Ar).$sort=t,this}collation(t){return He(this,fr,{...Q(this,fr),collation:t}),this}next(){if(Q(this,dr).length>0)return Q(this,dr).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(Q(this,dr).length>0)return!0;const t=this.fetch().next();return t.done?!1:(Q(this,dr).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}qi=new WeakMap,Fi=new WeakMap,Nn=new WeakMap,fr=new WeakMap,Ar=new WeakMap,bt=new WeakMap,dr=new WeakMap;const Ap=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));var jn,Br,fn;class Wr{constructor(t,r){Ke(this,jn);Ke(this,Br);Ke(this,fn);He(this,fn,zn(t)),He(this,Br,uf(r)),He(this,jn,[]),this.compile()}compile(){ke(We(Q(this,fn)),`query criteria must be an object: ${JSON.stringify(Q(this,fn))}`);const t={};for(const[r,n]of Object.entries(Q(this,fn))){if(r==="$where")ke(Q(this,Br).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(Ap.has(r))this.processOperator(r,r,n);else{ke(!Ur(r),`unknown top level operator: ${r}`);for(const[i,o]of Object.entries(cf(n)))this.processOperator(r,i,o)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const i=Li("query",r,Q(this,Br));ke(!!i,`unknown query operator ${r}`),Q(this,jn).push(i(t,n,Q(this,Br)))}test(t){return Q(this,jn).every(r=>r(t))}find(t,r){return new Tp(t,n=>this.test(n),r||{},Q(this,Br))}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}jn=new WeakMap,Br=new WeakMap,fn=new WeakMap;const Bp=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(Bp);function dt(e){return(r,n,i)=>{const o={unwrapArray:!0},c=Math.max(1,r.split(".").length-1);return l=>{const d=tr(l,r,o);return e(d,n,{...i,depth:c})}}}function Xn(e){return(t,r,n)=>{const i=$t(t,r,null,n);return e(...i)}}function cc(e,t,r){return Kt(e,t)||_t(e)&&_t(t)?!0:be(e)?e.some(n=>Kt(n,t))||of(e,r==null?void 0:r.depth).some(n=>Kt(n,t)):!1}function pf(e,t,r){return!cc(e,t,r)}function vf(e,t,r){return _t(e)?t.some(n=>n===null):af([Jn(e),t],r==null?void 0:r.hashFunction).length>0}function Np(e,t,r){return!vf(e,t,r)}function gf(e,t,r){return lo(e,t,(n,i)=>At(n,i)<0)}function yf(e,t,r){return lo(e,t,(n,i)=>At(n,i)<=0)}function bf(e,t,r){return lo(e,t,(n,i)=>At(n,i)>0)}function wf(e,t,r){return lo(e,t,(n,i)=>At(n,i)>=0)}function jp(e,t,r){return Jn(e).some(n=>t.length===2&&n%t[0]===t[1])}function qp(e,t,r){const n=Jn(e),i=o=>Wt(o)&&Wn(t.exec(o),r==null?void 0:r.useStrictMode);return n.some(i)||of(n,1).some(i)}function Fp(e,t,r){if(!be(e)||!be(t)||!e.length||!t.length)return!1;let n=!0;for(const i of t){if(!n)break;We(i)&&Object.keys(i).includes("$elemMatch")?n=_f(e,i.$elemMatch,r):pr(i)?n=e.some(o=>typeof o=="string"&&i.test(o)):n=e.some(o=>Kt(i,o))}return n}function Kp(e,t,r){return Array.isArray(e)&&e.length===t}function Hp(e){return Ur(e)&&["$and","$or","$nor"].indexOf(e)===-1}function _f(e,t,r){if(be(e)&&!sc(e)){let n=c=>c,i=t;Object.keys(t).every(Hp)&&(i={temp:t},n=c=>({temp:c}));const o=new Wr(i,r);for(let c=0,l=e.length;c<l;c++)if(o.test(n(e[c])))return!0}return!1}const wu=e=>e===null,Up={array:be,boolean:Mn,bool:Mn,date:Un,number:Ze,int:Ze,long:Ze,double:Ze,decimal:Ze,null:wu,object:We,regexp:pr,regex:pr,string:Wt,undefined:_t,function:e=>{throw new Yi("unsupported type key `function`.")},1:Ze,2:Wt,3:We,4:be,6:_t,8:Mn,9:Un,10:wu,11:pr,16:Ze,18:Ze,19:Ze};function _u(e,t,r){const n=Up[t];return n?n(e):!1}function Wp(e,t,r){return be(t)?t.findIndex(n=>_u(e,n))>=0:_u(e,t)}function lo(e,t,r){return Jn(e).some(n=>Oi(n)===Oi(t)&&r(n,t))}const zp=(e,t,r)=>{const n=$t(e,t,null,r);return Wn(n,r.useStrictMode)&&n.every(i=>Wn(i,r.useStrictMode))},Vp=(e,t,r)=>{const n=Jn(t);return n.length==0?!1:(ke(n.length==1,"Expression $not takes exactly 1 argument"),!$t(e,n[0],null,r))},Qp=(e,t,r)=>{const n=$t(e,t,null,r),i=r.useStrictMode;return Wn(n,i)&&n.some(o=>Wn(o,i))},Gp=Object.freeze(Object.defineProperty({__proto__:null,$and:zp,$not:Vp,$or:Qp},Symbol.toStringTag,{value:"Module"})),Yp=(e,t,r)=>{const n=$t(e,t,null,r);return ke(be(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),At(n[0],n[1])},Jp=Xn(cc),Xp=Xn(bf),Zp=Xn(wf),ev=Xn(gf),tv=Xn(yf),rv=Xn(pf),nv=Object.freeze(Object.defineProperty({__proto__:null,$cmp:Yp,$eq:Jp,$gt:Xp,$gte:Zp,$lt:ev,$lte:tv,$ne:rv},Symbol.toStringTag,{value:"Module"})),Eu=(e,t)=>{const r={};return e.split("").forEach((n,i)=>r[n]=t*(i+1)),r};({...Eu("ABCDEFGHIKLM",1),...Eu("NOPQRSTUVWXY",-1)});const Su={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function xt(e,t=Su){const r=Object.assign({},Su,t),n=new Set(Object.keys(r));return(i,o,c)=>{const l=$t(i,o,null,c);if(n.has(`${l}`)){const d=r[`${l}`];if(d instanceof Error)throw new Yi(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return d}return e(l)}}xt(Math.acos,{Infinity:1/0,0:new Error});xt(Math.acosh,{Infinity:1/0,0:new Error});xt(Math.asin);xt(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});xt(Math.atan);xt(Math.atanh,{1:1/0,"-1":-1/0});xt(Math.cos);xt(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const iv=Math.PI/180;xt(e=>e*iv,{Infinity:1/0,"-Infinity":1/0});const av=180/Math.PI;xt(e=>e*av,{Infinity:1/0,"-Infinity":-1/0});xt(Math.sin);xt(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});xt(Math.tan);const Ef=(e,t,r)=>{ke(be(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(i=>new Wr(i,r));return i=>n.every(o=>o.test(i))},uc=(e,t,r)=>{ke(be(t),"Invalid expression. $or expects value to be an Array");const n=t.map(i=>new Wr(i,r));return i=>n.some(o=>o.test(i))},Sf=(e,t,r)=>{ke(be(t),"Invalid expression. $nor expects value to be an array.");const n=uc("$or",t,r);return i=>!n(i)},xf=(e,t,r)=>{const n={};n[e]=cf(t);const i=new Wr(n,r);return o=>!i.test(o)},kf=dt(cc),If=dt(bf),Cf=dt(wf),Df=dt(vf),Of=dt(gf),Pf=dt(yf),Rf=dt(pf),Lf=dt(Np);function ov(e,t,r){return n=>$t(n,t,null,r)}function sv(e,t,r){if(!(r!=null&&r.jsonSchemaValidator))throw new Yi("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return i=>n(i)}const $f=dt(jp),Mf=dt(qp);function cv(e,t,r){ke(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return ke(uo(n),"$where only accepts a Function object"),i=>Wn(n.call(i),r==null?void 0:r.useStrictMode)}const uv=dt(Fp),Tf=dt(_f),Af=dt(Kp),Bf=(e,t,r)=>{const n=e.includes("."),i=!!t;return!n||e.match(/\.\d+$/)?o=>tr(o,e)!==void 0===i:o=>{const c=pi(o,e,{preserveIndex:!0}),l=tr(c,e.substring(0,e.lastIndexOf(".")));return be(l)?l.some(d=>d!==void 0)===i:l!==void 0===i}},Nf=dt(Wp);var xu=!1;function lv(e){return xu||(yu(Rs.PIPELINE,{$sort:mf,$project:ff}),yu(Rs.QUERY,{$and:Ef,$eq:kf,$elemMatch:Tf,$exists:Bf,$gt:If,$gte:Cf,$in:Df,$lt:Of,$lte:Pf,$ne:Rf,$nin:Lf,$mod:$f,$nor:Sf,$not:xf,$or:uc,$regex:Mf,$size:Af,$type:Nf}),xu=!0),new Wr(e)}function Tn(e,t){var r=St(e.primaryKey);t=Be(t);var n=ft(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([g,S])=>{(typeof S!="object"||S===null)&&(n.selector[g]={$eq:S})})):n.selector={},n.index){var i=Ys(n.index);i.includes(r)||i.push(r),n.index=i}if(n.sort){var m=n.sort.find(g=>Lh(g)===r);m||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(g=>({[g]:"asc"}));else{if(e.indexes){var o=new Set;Object.entries(n.selector).forEach(([g,S])=>{var E=!1;typeof S=="object"&&S!==null?E=!!Object.keys(S).find(_=>oc.has(_)):E=!0,E&&o.add(g)});var c=-1,l;e.indexes.forEach(g=>{var S=Wa(g)?g:[g],E=S.findIndex(_=>!o.has(_));E>0&&E>c&&(c=E,l=S)}),l&&(n.sort=l.map(g=>({[g]:"asc"})))}if(!n.sort)if(e.indexes&&e.indexes.length>0){var d=e.indexes[0],v=Wa(d)?d:[d];n.sort=v.map(g=>({[g]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function jf(e,t){if(!t.sort)throw Z("SNH",{query:t});var r=[];t.sort.forEach(i=>{var o=Object.keys(i)[0],c=Object.values(i)[0];r.push({key:o,direction:c,getValueFn:Rh(o)})});var n=(i,o)=>{for(var c=0;c<r.length;++c){var l=r[c],d=l.getValueFn(i),v=l.getValueFn(o);if(d!==v){var m=l.direction==="asc"?At(d,v):At(v,d);return m}}};return n}function lc(e,t){if(!t.sort)throw Z("SNH",{query:t});var r=lv(t.selector),n=i=>r.test(i);return n}async function Dn(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(i=>t(i)));if(r instanceof Map)return Promise.all([...r.values()].map(i=>t(i)));var n=await t(r);return n}function fo(e,t){if(!t.sort)throw Z("SNH",{query:t});var r=cp(e,t);return{query:t,queryPlan:r}}var fv="_rxdb_internal";async function Xi(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function Mi(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var i=n.error[0];throw i}else{var o=St(e.schema.primaryKey),c=Bt(o,[t],n),l=c[0];return l}}function dv(e,t){var r=Xi(e,t),n=e.changeStream().pipe(Ue(i=>i.events.find(o=>o.documentId===t)),De(i=>!!i),Ue(i=>Promise.resolve(de(i).documentData)),Gi(r),ip(i=>i),De(i=>!!i));return n}function Ti(e){return Object.assign({},...e)}function Ga(e,t,r,n){if(n)throw n.status===409?Z("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?Z("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function hv(e,t,r,n,i,o,c){for(var l=!!e.schema.attachments,d=[],v=[],m=[],g=Ki(10),S={id:g,events:[],checkpoint:null,context:i},E=S.events,_=[],D=[],A=[],j=r.size>0,K,Y=n.length,se=function(){var ee=n[ae],ne=ee.document,me=ee.previous,_e=ne[t],Ne=ne._deleted,Pe=me&&me._deleted,he=void 0;j&&(he=r.get(_e));var Ie;if(he){var et=he._rev;if(!me||me&&et!==me._rev){var Nt={isError:!0,status:409,documentId:_e,writeRow:ee,documentInDb:he};return m.push(Nt),1}var Te=l?ss(ee):ee;l&&(Ne?me&&Object.keys(me._attachments).forEach(fe=>{D.push({documentId:_e,attachmentId:fe,digest:de(me)._attachments[fe].digest})}):(Object.entries(ne._attachments).find(([fe,je])=>{var mt=me?me._attachments[fe]:void 0;return!mt&&!je.data&&(Ie={documentId:_e,documentInDb:he,isError:!0,status:510,writeRow:ee,attachmentId:fe}),!0}),Ie||Object.entries(ne._attachments).forEach(([fe,je])=>{var mt=me?me._attachments[fe]:void 0;if(!mt)_.push({documentId:_e,attachmentId:fe,attachmentData:je,digest:je.digest});else{var It=Te.document._attachments[fe].digest;je.data&&mt.digest!==It&&A.push({documentId:_e,attachmentId:fe,attachmentData:je,digest:je.digest})}}))),Ie?m.push(Ie):(l?v.push(ss(Te)):v.push(Te),K=Te);var tt=null,oe=null,Se=null;if(Pe&&!Ne)Se="INSERT",tt=l?Zt(ne):ne;else if(me&&!Pe&&!Ne)Se="UPDATE",tt=l?Zt(ne):ne,oe=me;else if(Ne)Se="DELETE",tt=de(ne),oe=me;else throw Z("SNH",{args:{writeRow:ee}});var Qe={documentId:_e,documentData:tt,previousDocumentData:oe,operation:Se};E.push(Qe)}else{var Re=!!Ne;if(l&&Object.entries(ne._attachments).forEach(([fe,je])=>{je.data?_.push({documentId:_e,attachmentId:fe,attachmentData:je,digest:je.digest}):(Ie={documentId:_e,isError:!0,status:510,writeRow:ee,attachmentId:fe},m.push(Ie))}),Ie||(l?d.push(ss(ee)):d.push(ee),K=ee),!Re){var Le={documentId:_e,operation:"INSERT",documentData:l?Zt(ne):ne,previousDocumentData:l&&me?Zt(me):me};E.push(Le)}}},ae=0;ae<Y;ae++)se();return{bulkInsertDocs:d,bulkUpdateDocs:v,newestRow:K,errors:m,eventBulk:S,attachmentsAdd:_,attachmentsRemove:D,attachmentsUpdate:A}}function ss(e){return{previous:e.previous,document:Zt(e.document)}}function mv(e){return atob(e).length}function pv(e){var t=e.data;if(!t)return e;var r={length:mv(t),digest:e.digest,type:e.type};return r}function Zt(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=Be(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=pv(n)}),t}function Zi(e){return Object.assign({},e,{_meta:Be(e._meta)})}function fc(e,t,r){xe.deepFreezeWhenDevMode(r);var n=St(t.schema.primaryKey),i={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,async bulkWrite(o,c){for(var l=e.token,d=new Array(o.length),v=Et(),m=0;m<o.length;m++){var g=o[m],S=Zi(g.document);S._meta.lwt=v;var E=g.previous;S._rev=yr(l,E),d[m]={document:S,previous:E}}pt("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:d});var _=await e.lockedRun(()=>t.bulkWrite(d,c)),D={error:[]};Ff.set(D,d);var A=_.error.length===0?[]:_.error.filter(ee=>ee.status===409&&!ee.writeRow.previous&&!ee.writeRow.document._deleted&&de(ee.documentInDb)._deleted?!0:(D.error.push(ee),!1));if(A.length>0){var j=new Set,K=A.map(ee=>(j.add(ee.documentId),{previous:ee.documentInDb,document:Object.assign({},ee.writeRow.document,{_rev:yr(e.token,ee.documentInDb)})})),Y=await e.lockedRun(()=>t.bulkWrite(K,c));pn(D.error,Y.error);var se=Bt(n,d,D,j),ae=Bt(n,K,Y);return pn(se,ae),D}return D},query(o){return e.lockedRun(()=>t.query(o))},count(o){return e.lockedRun(()=>t.count(o))},findDocumentsById(o,c){return e.lockedRun(()=>t.findDocumentsById(o,c))},getAttachmentData(o,c,l){return e.lockedRun(()=>t.getAttachmentData(o,c,l))},getChangedDocumentsSince:t.getChangedDocumentsSince?(o,c)=>e.lockedRun(()=>t.getChangedDocumentsSince(de(o),c)):void 0,cleanup(o){return e.lockedRun(()=>t.cleanup(o))},remove(){return e.storageInstances.delete(i),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(i),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()}};return e.storageInstances.add(i),i}function vv(e){if(e.schema.keyCompression)throw Z("UT5",{args:{params:e}});if($s(e.schema))throw Z("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw Z("UT7",{args:{params:e}})}function $s(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function gv(e,t,r){var n=St(e.schema.primaryKey),i=r?r.lwt:Js,o=r?r.id:"";return Tn(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:i}},{"_meta.lwt":{$eq:i},[n]:{$gt:r?o:""}}],"_meta.lwt":{$gte:i}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function qf(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=St(e.schema.primaryKey),i=fo(e.schema,gv(e,t,r)),o=await e.query(i),c=o.documents,l=Dh(c);return{documents:c,checkpoint:l?{id:l[n],lwt:l._meta.lwt}:r||{id:"",lwt:0}}}var Ff=new WeakMap,yv=new WeakMap;function Bt(e,t,r,n){return Ut(yv,r,()=>{var i=[],o=Ff.get(r);if(o||(o=t),r.error.length>0||n){for(var c=n||new Set,l=0;l<r.error.length;l++){var d=r.error[l];c.add(d.documentId)}for(var v=0;v<o.length;v++){var m=o[v].document;c.has(m[e])||i.push(Zt(m))}}else{i.length=t.length-r.error.length;for(var g=0;g<o.length;g++){var S=o[g].document;i[g]=Zt(S)}}return i})}var Kf=function(){function e(r,n,i,o){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=i,this.postWrite=o}var t=e.prototype;return t.addWrite=function(n,i){var o=n[this.primaryPath],c=Ut(this.queueByDocId,o,()=>[]),l=new Promise((d,v)=>{var m={lastKnownDocumentState:n,modifier:i,resolve:d,reject:v};de(c).push(m),this.triggerRun()});return l},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],i=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(i.entries()).map(async([c,l])=>{var d=bv(l.map(g=>g.lastKnownDocumentState)),v=d;for(var m of l)try{v=await m.modifier(ft(v))}catch(g){m.reject(g),m.reject=()=>{},m.resolve=()=>{}}try{await this.preWrite(v,d)}catch(g){l.forEach(S=>S.reject(g));return}n.push({previous:d,document:v})}));var o=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(Bt(this.primaryPath,n,o).map(c=>{var l=c[this.primaryPath];this.postWrite(c);var d=qn(i,l);d.forEach(v=>v.resolve(c))})),o.error.forEach(c=>{var l=c.documentId,d=qn(i,l),v=oo(c);if(v){var m=Ut(this.queueByDocId,l,()=>[]);d.reverse().forEach(S=>{S.lastKnownDocumentState=de(v.documentInDb),de(m).unshift(S)})}else{var g=Pl(c);d.forEach(S=>S.reject(g))}}),this.isRunning=!1,this.triggerRun()}},e}();function ku(e){var t=async r=>{var n=$h(r);n._deleted=r._deleted;var i=await e(n),o=Object.assign({},i,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof i._deleted<"u"?i._deleted:r._deleted});return typeof o._deleted>"u"&&(o._deleted=!1),o};return t}function bv(e){var t=e[0],r=Fr(t._rev);return e.forEach(n=>{var i=Fr(n._rev);i>r&&(t=n,r=i)}),t}var ho={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(Ue(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,t=this.primary;return e.collection.eventBulks$.pipe(De(r=>!r.isLocal),Ue(r=>r.events.find(n=>n.documentId===t)),De(r=>!!r),Ue(r=>Xl(de(r))),Gi(e.collection._docCache.getLatestDocumentData(t)),Ii((r,n)=>r._rev===n._rev),Ue(r=>this.collection._docCache.getCachedRxDocument(r)),Qi(Hi))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(xe.isDevMode()){if(e.includes(".item."))throw Z("DOC1",{path:e});if(e===this.primaryPath)throw Z("DOC2");if(this.collection.schema.finalFields.includes(e))throw Z("DOC3",{path:e});var t=Fn(this.collection.schema.jsonSchema,e);if(!t)throw Z("DOC4",{path:e})}return this.$.pipe(Ue(r=>Kr(r,e)),Ii())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=Fn(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return Xs;if(!t)throw Z("DOC5",{path:e});if(!t.ref)throw Z("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw Z("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(i=>{var o=i.values();return Array.from(o)}):n.findOne(r).exec()},get(e){return Wf(this,e)},toJSON(e=!1){if(e)return xe.deepFreezeWhenDevMode(this._data);var t=Be(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,xe.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return ft(this.toJSON(e))},update(e){throw Ce("update")},incrementalUpdate(e){throw Ce("update")},updateCRDT(e){throw Ce("crdt")},putAttachment(){throw Ce("attachments")},getAttachment(){throw Ce("attachments")},allAttachments(){throw Ce("attachments")},get allAttachments$(){throw Ce("attachments")},async modify(e,t){var r=this._data,n=await ku(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,ku(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=ft(t);return Object.entries(e).forEach(([n,i])=>{r[n]=i}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=Be(e),this._data._deleted)throw Z("DOC11",{id:this.primary,document:this});await Uf(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),i=n.error[0];return Ga(this.collection,this.primary,e,i),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(Bt(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(Z("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var t=e.error[0];Ga(this.collection,this.primary,this._data,t)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw Z("DOC14")}};function Hf(e=ho){var t=function(n,i){this.collection=n,this._data=i,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function wv(e,t,r){var n=new e(t,r);return pt("createRxDocument",n),n}function Uf(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),xe.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function Wf(e,t){return Ut(e._propertyCache,t,()=>{var r=Kr(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return xe.deepFreezeWhenDevMode(r);var n=new Proxy(Be(r),{get(i,o){if(typeof o!="string")return i[o];var c=o.charAt(o.length-1);if(c==="$")if(o.endsWith("$$")){var l=o.slice(0,-2);return e.get$$(di(t+"."+l))}else{var d=o.slice(0,-1);return e.get$(di(t+"."+d))}else if(c==="_"){var v=o.slice(0,-1);return e.populate(di(t+"."+v))}else{var m=i[o];return typeof m=="number"||typeof m=="string"||typeof m=="boolean"?m:Wf(e,di(t+"."+o))}}});return n})}function dc(e){return e[e.length-1]}function _v(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function Iu(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!_v(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let i=0;i<n.length;i++){const o=n[i];if(Ev(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function Ev(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const zf=e=>!!e.queryParams.limit,Sv=e=>e.queryParams.limit===1,xv=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),kv=e=>e.changeEvent.operation==="DELETE",Iv=e=>e.changeEvent.operation==="INSERT",Cv=e=>e.changeEvent.operation==="UPDATE",Dv=e=>zf(e)&&e.previousResults.length>=e.queryParams.limit,Ov=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let i=0;i<t.length;i++){const o=t[i],c=Iu(r,o),l=Iu(n,o);if(c!==l)return!0}return!1},Pv=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===t)return!0;return!1}},Rv=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},Lv=e=>{const t=dc(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},$v=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Mv=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=dc(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Tv=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Av=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=dc(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Bv=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},Nv=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},jv=e=>e.previousResults.length===0,qv={0:Iv,1:Cv,2:kv,3:zf,4:Sv,5:xv,6:jv,7:Dv,8:Rv,9:Lv,10:Ov,11:Pv,12:$v,13:Mv,14:Tv,15:Av,16:Bv,17:Nv};function Fv(e,t,r,n){var i=e.length,o=i-1,c=0;if(i===0)return e.push(t),0;for(var l;n<=o;)c=n+(o-n>>1),l=e[c],r(l,t)<=0?n=c+1:o=c-1;return r(l,t)<=0&&c++,e.splice(c,0,t),c}const Kv=e=>{},hc=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},mc=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},pc=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},vc=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Hv=e=>{pc(e),mc(e)},Uv=e=>{vc(e),hc(e)},Wv=e=>{pc(e),hc(e)},zv=e=>{vc(e),mc(e)},Vf=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},Vv=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===e.changeEvent.id){n[i]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},Qv=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},Qf=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(i=>i[e.queryParams.primaryKey]===t))return;Fv(e.previousResults,r,e.queryParams.sortComparator,0)},Gv=e=>{Vf(e),Qf(e)},Yv=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},Jv=e=>{throw new Error("Action unknownAction should never be called")},Xv=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],Zv={doNothing:Kv,insertFirst:hc,insertLast:mc,removeFirstItem:pc,removeLastItem:vc,removeFirstInsertLast:Hv,removeLastInsertFirst:Uv,removeFirstInsertFirst:Wv,removeLastInsertLast:zv,removeExisting:Vf,replaceExisting:Vv,alwaysWrong:Qv,insertAtSortPosition:Qf,removeExistingAndInsertAtSortPosition:Gv,runFullQueryAgain:Yv,unknownAction:Jv},eg=40;function cs(e){return e.charCodeAt(0)-eg}function tg(e){return e?"1":"0"}function Cu(e,t){const r=[];for(let n=0,i=e.length;n<i;n+=t)r.push(e.substring(n,n+t));return r}function rg(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,i=e.substring(2,n),o=Cu(i,2);for(let D=0;D<o.length;D++){const A=o[D],j=A.charAt(0),K=cs(A.charAt(1));t.set(j,K)}const c=e.substring(n,e.length-3),l=Cu(c,4);for(let D=0;D<l.length;D++){const A=l[D],j=A.charAt(0),K=A.charAt(1),Y=A.charAt(2),se=cs(A.charAt(3));if(!t.has(K))throw new Error("missing node with id "+K);if(!t.has(Y))throw new Error("missing node with id "+Y);const ae=t.get(K),ee=t.get(Y),ne={l:se,0:ae,1:ee};t.set(j,ne)}const d=e.slice(-3),v=d.charAt(0),m=d.charAt(1),g=cs(d.charAt(2)),S=t.get(v),E=t.get(m);return{l:g,0:S,1:E}}function ng(e,t,r){let n=e,i=e.l;for(;;){const o=t[i](r),c=tg(o);if(n=n[c],typeof n=="number"||typeof n=="string")return n;i=n.l}}const ig="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9Â¡bf9Â¢bq9Â£cg9Â¤ck9Â¥cn9Â¦nd9Â§np9Â¨nq9Â©nf9Âªng9Â«nm9Â¬nk9Â­mr9Â®ms9Â¯mt9Â°mj9Â±mk9Â²ml9Â³mn9Â´mc8ÂµÂ³{8Â¶Â¯}8Â·Â°Â¤8Â¸Â³Â§8Â¹mn8ÂºÂ³Â«8Â»Â³m8Â¼mÂ´4Â½zÂ²4Â¾Â³w4Â¿zÂµ4ÃÂ¯Â¶4ÃÂ°Â·4ÃÂ³Âº4ÃÂ³Â¸4ÃmÂ¹4ÃvÂ¤7Ãyn7ÃÃÃ7Ã~7ÃÂ¥Â¤7ÃÃÃ7ÃÂ¨n7ÃÂºÂ¹7ÃÂ­Â°7ÃÂ®m7ÃÂ¯Â°7ÃÂ±m7ÃÂ³m7ÃÂ¼m5ÃÃm5ÃÂ¹m5ÃÂ½Â°5ÃÂ¾m5ÃÂ¿Â°5ÃÃÃ5ÃÃm5ÃÃÃ5ÃÂ±m5ÃÂºm5ÃÃÃ5ÃÃÃ2Ã|2Ã Â¡u2Ã¡Â£Ã2Ã¢ÃÃ2Ã£Â¦Ã2Ã¤Â©x2Ã¥ÂªÃ2Ã¦ÃÃ2Ã§|Ã2Ã¨Â¡Â¢2Ã©Â£Ã2ÃªÂ¤Â¥2Ã«ÃÃ2Ã¬Â¦Ã2Ã­Â©n2Ã®Âªn2Ã¯ÃÃ2Ã°ÃÃ2Ã±Â¬n2Ã²ÃÃ/Ã³an/Ã´bn/Ãµcn/Ã¶ÃÃ¢/Ã·ÃÃ£/Ã¸Ã Ã¤/Ã¹Ã¡Ã¥/ÃºÃ¦Ã«/Ã»Ã§Ã¬/Ã¼Ã¨Ã­/Ã½Ã©Ã®/Ã¾ÃÃ/Ã¿ÃÃ/ÄÃ²Ã,Äcn,ÄÃ¶Ã¯,ÄÂ¤Ã±,ÄÃºÃ°,ÄÃªÃ±,ÄÃ¾Ã,ÄÃ¿Ã,Äac0Äbc0ÄÃ³Ãµ0ÄÃ´Ä0ÄÃÃ¡0ÄÃ Â¤0ÄÃ§Ã©0ÄÃ¨Ãª0ÄÃ·Ã¹0ÄÃ¸Ä0ÄÃ»Ã½0ÄÃ¼Ä0ÄmÃ-ÄmÄ-ÄÃÃ¦-ÄÄÄ-ÄÄÄ-ÄÄÄ-ÄÄÄ-ÄÄÄ-ÄÂ²Â»-ÄÃÃ-ÄÄÄ-ÄÂ²Â³-Ä ÄÄ3Ä¡ÄÄ3Ä¢ÄÄ3Ä£ÄÄ3Ä¤Ä¢Ä(Ä¥ÄÄ(Ä¦Ä£Ä(Ä§Ä Ä¡+Ä¨ÄÄ+Ä©Ä¤Ä¦+ÄªÄÄ+Ä«Ä§Ä¨1Ä¬Ä©Äª1Ä­Ä¬Ä«*Ä®Ä¥m*Ä­Ä®.";let us;function ag(){return us||(us=rg(ig)),us}const og=e=>ng(ag(),qv,e);function sg(e){const t=og(e);return Xv[t]}function cg(e,t,r,n,i){const o=Zv[e];return o({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:i}),n}function ug(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var lg=new WeakMap;function fg(e){return Ut(lg,e,()=>{var t=e.collection,r=Tn(t.storageInstance.schema,ft(e.mangoQuery)),n=t.schema.primaryPath,i=jf(t.schema.jsonSchema,r),o=(v,m)=>{var g={docA:v,docB:m};return i(g.docA,g.docB)},c=lc(t.schema.jsonSchema,r),l=v=>{var m={doc:v};return c(m.doc)},d={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:ug(n,r),sortComparator:o,queryMatcher:l};return d})}function dg(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=fg(e),n=de(e._result).docsData.slice(0),i=de(e._result).docsDataMap,o=!1,c=[],l=0;l<t.length;l++){var d=t[l],v=ap(d);v&&c.push(v)}var m=c.find(g=>{var S={queryParams:r,changeEvent:g,previousResults:n,keyDocumentMap:i},E=sg(S);if(E==="runFullQueryAgain")return!0;if(E!=="doNothing")return o=!0,cg(E,r,g,n,i),!1});return m?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:o,newResults:n}}var hg=function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var i=n.toString(),o=Ut(this._map,i,()=>n);return o},e}();function mg(){return new hg}function Du(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function pg(e){return e.refCount$.observers.length}var vg=100,gg=30*1e3,yg=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var i=Et()-t,o=[],c=Array.from(n._map.values());for(var l of c)if(!(pg(l)>0)){if(l._lastEnsureEqual===0&&l._creationTime<i){Du(n,l);continue}o.push(l)}var d=o.length-e;if(!(d<=0)){var v=o.sort((g,S)=>g._lastEnsureEqual-S._lastEnsureEqual),m=v.slice(0,d);m.forEach(g=>Du(n,g))}}},Gf=yg(vg,gg),ls=new WeakSet;function bg(e){ls.has(e)||(ls.add(e),Ah().then(()=>qh(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),ls.delete(e)}))}var Yf=function(){function e(r,n,i){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(o=>{var c=o.docId,l=this.cacheItemByDocId.get(c);l&&(l[0].delete(o.revisionHeight),l[0].size===0&&this.cacheItemByDocId.delete(c))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=i,n.subscribe(o=>{this.tasks.add(()=>{for(var c=this.cacheItemByDocId,l=0;l<o.length;l++){var d=o[l],v=c.get(d.documentId);if(v){var m=d.documentData;m||(m=d.previousDocumentData),v[1]=m}}}),this.tasks.size<=1&&ao().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var i=qn(this.cacheItemByDocId,n);return i[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var i=this.cacheItemByDocId.get(n);if(i)return i[1]},Hr(e,[{key:"getCachedRxDocuments",get:function(){var r=Ou(this);return mr(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=Ou(this);return mr(this,"getCachedRxDocument",n=>r([n])[0])}}])}();function Ou(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,i=xe.deepFreezeWhenDevMode,o=e.documentCreator,c=l=>{for(var d=new Array(l.length),v=[],m=0;m<l.length;m++){var g=l[m],S=g[t],E=Fr(g._rev),_=void 0,D=void 0,A=r.get(S);A?(_=A[0],D=_.get(E)):(_=new Map,A=[_,g],r.set(S,A));var j=D?D.deref():void 0;j||(g=i(g),j=o(g),_.set(E,_g(j)),n&&v.push(j)),d[m]=j}return v.length>0&&n&&(e.tasks.add(()=>{for(var K=0;K<v.length;K++){var Y=v[K];n.register(Y,{docId:Y.primary,revisionHeight:Fr(Y.revision)})}}),e.tasks.size<=1&&ao().then(()=>{e.processTasks()})),d};return c}function Ms(e,t){var r=e.getCachedRxDocuments;return r(t)}var wg=typeof WeakRef=="function",_g=wg?Eg:Sg;function Eg(e){return new WeakRef(e)}function Sg(e){return{deref(){return e}}}var Pu=function(){function e(r,n,i){this.time=Et(),this.query=r,this.count=i,this.documents=Ms(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var i=this.query.op;if(i==="count")return this.count;if(i==="findOne"){var o=this.documents.length===0?null:this.documents[0];if(!o&&n)throw Z("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:i});return o}else return i==="findByIds"?this.docsMap:this.documents.slice(0)},Hr(e,[{key:"docsData",get:function(){return mr(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),mr(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,i=0;i<n.length;i++){var o=n[i];r.set(o.primary,o)}return mr(this,"docsMap",r)}}])}(),xg=0,kg=function(){return++xg},Jf=function(){function e(r,n,i,o={}){this.id=kg(),this._execOverDatabaseCount=0,this._creationTime=Et(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new Lr(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=br,this.op=r,this.mangoQuery=n,this.collection=i,this.other=o,n||(this.mangoQuery=Ba()),this.isFindOneByIdQuery=Og(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw Z("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new Pu(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var i=new Pu(this,n,n.length);this._result=i},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var n=this.getPreparedQuery(),i=await this.collection.storageInstance.count(n);if(i.mode==="slow"&&!this.collection.database.allowSlowCount)throw Z("QU14",{collection:this.collection,queryObj:this.mangoQuery});return i.count}if(this.op==="findByIds"){var o=de(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,c=new Map,l=[];if(o.forEach(m=>{var g=this.collection._docCache.getLatestDocumentDataIfExists(m);if(g){if(!g._deleted){var S=this.collection._docCache.getCachedRxDocument(g);c.set(m,S)}}else l.push(m)}),l.length>0){var d=await this.collection.storageInstance.findDocumentsById(l,!1);d.forEach(m=>{var g=this.collection._docCache.getCachedRxDocument(m);c.set(g.primary,g)})}return c}var v=Dg(this);return v.then(m=>m)},t.exec=async function(n){if(n&&this.op!=="findOne")throw Z("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await Ru(this);var i=de(this._result);return i.getValue(n)},t.toString=function(){var n=za({op:this.op,query:Tn(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),i=JSON.stringify(n);return this.toString=()=>i,i},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:Tn(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),pt("prePrepareQuery",n);var i=fo(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>i,i},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=async function(){var n=await this.exec();if(Array.isArray(n)){var i=await this.collection.bulkRemove(n);if(i.error.length>0)throw Pl(i.error[0]);return i.success}else return n.remove()},t.incrementalRemove=function(){return Dn(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw Ce("update")},t.patch=function(n){return Dn(this.asRxQuery,i=>i.patch(n))},t.incrementalPatch=function(n){return Dn(this.asRxQuery,i=>i.incrementalPatch(n))},t.modify=function(n){return Dn(this.asRxQuery,i=>i.modify(n))},t.incrementalModify=function(n){return Dn(this.asRxQuery,i=>i.incrementalModify(n))},t.where=function(n){throw Ce("query-builder")},t.sort=function(n){throw Ce("query-builder")},t.skip=function(n){throw Ce("query-builder")},t.limit=function(n){throw Ce("query-builder")},Hr(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(De(n=>!n.isLocal),Gi(null),_r(()=>Ru(this)),Ue(()=>this._result),Qi(Hi),Ii((n,i)=>!!(n&&n.time===de(i).time)),De(n=>!!n),Ue(n=>de(n).getValue()));this._$=sp(r,this.refCount$.pipe(De(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=Tn(this.collection.schema.jsonSchema,this.mangoQuery);return mr(this,"queryMatcher",lc(r,n))}},{key:"asRxQuery",get:function(){return this}}])}();function Ba(){return{selector:{}}}function Ig(e){return e.collection._queryCache.getByQuery(e)}function On(e,t,r,n){pt("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var i=new Jf(e,t,r,n);return i=Ig(i),bg(r),i}function Xf(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function Ru(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.closed||Xf(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>Cg(e)),e._ensureEqualQueue)}function Cg(e){if(e._lastEnsureEqual=Et(),e.collection.database.closed||Xf(e))return br;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var i=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var o=de(e._result).count,c=o;i.forEach(d=>{var v=d.previousDocumentData&&e.doesDocumentDataMatch(d.previousDocumentData),m=e.doesDocumentDataMatch(d.documentData);!v&&m&&c++,v&&!m&&c--}),c!==o&&(t=!0,e._setResultData(c))}else{var l=dg(e,i);l.runFullQueryAgain?r=!0:l.changed&&(t=!0,e._setResultData(l.newResults))}}}return r?e._execOverDatabase().then(d=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof d=="number"?((!e._result||d!==e._result.count)&&(t=!0,e._setResultData(d)),t):((!e._result||!Mh(e.collection.schema.primaryPath,d,e._result.docsData))&&(t=!0,e._setResultData(d)),t))):Promise.resolve(t)}async function Dg(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(m=>{var g=e.collection._docCache.getLatestDocumentDataIfExists(m);return g?(g._deleted||t.push(g),!1):!0}),n.length>0){var i=await r.storageInstance.findDocumentsById(n,!1);pn(t,i)}}else{var o=e.isFindOneByIdQuery,c=e.collection._docCache.getLatestDocumentDataIfExists(o);if(!c){var l=await r.storageInstance.findDocumentsById([o],!1);l[0]&&(c=l[0])}c&&!c._deleted&&t.push(c)}else{var d=e.getPreparedQuery(),v=await r.storageInstance.query(d);t=v.documents}return t}function Og(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var hn="collection",gc="storage-token",Na="rx-migration-status",Pg="rx-pipeline-checkpoint",Rg="RxInternalDocument",yc=so({version:0,title:Rg,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[hn,gc,Na,Pg,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function Vn(e,t){return bn(yc,{key:e,context:t})}async function Zf(e){var t=fo(e.schema,{selector:{context:hn,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var ed="storageToken",Lg=Vn(ed,gc);async function $g(e){var t=Ki(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:Lg,context:gc,key:ed,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:Yn(),_rev:Ht(),_attachments:{}},i=[{document:n}],o=await e.internalStore.bulkWrite(i,"internal-add-storage-token");if(!o.error[0])return Bt("id",i,o)[0];var c=de(o.error[0]);if(c.isError&&oo(c)){var l=c;if(!Mg(l.documentInDb.data.rxdbVersion,e.rxdbVersion))throw Z("DM5",{args:{database:e.name,databaseStateVersion:l.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==l.documentInDb.data.passwordHash)throw Z("DB1",{passwordHash:r,existingPasswordHash:l.documentInDb.data.passwordHash});var d=l.documentInDb;return de(d)}throw c}function Mg(e,t){if(!e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r==="15"&&n==="16"?!0:r===n}async function Tg(e,t,r){if(e.schema.version!==r.version)throw Z("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=Ts(e.name,e.schema.jsonSchema),i=Vn(n,hn);;){var o=await Xi(e.database.internalStore,i),c=ft(de(o)),l=c.data.connectedStorages.find(d=>d.collectionName===t&&d.schema.version===r.version);if(l)return;c.data.connectedStorages.push({collectionName:t,schema:r});try{await Mi(e.database.internalStore,{previous:de(o),document:c},"add-connected-storage-to-collection")}catch(d){if(!oo(d))throw d}}}function Ts(e,t){return e+"-"+t.version}function Ra(e,t){return t=Be(t),t=im(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=Zh(e.primaryPath,e.jsonSchema,t)),t._meta=Yn(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=Ht()),t}async function Ag(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function td(e,t,r,n,i,o,c,l){var d=await Zf(t),v=d.filter(E=>E.data.name===i),m=[];v.forEach(E=>{m.push({collectionName:E.data.name,schema:E.data.schema,isCollection:!0}),E.data.connectedStorages.forEach(_=>m.push({collectionName:_.collectionName,isCollection:!1,schema:_.schema}))});var g=new Set;if(m=m.filter(E=>{var _=E.collectionName+"||"+E.schema.version;return g.has(_)?!1:(g.add(_),!0)}),await Promise.all(m.map(async E=>{var _=await e.createStorageInstance({collectionName:E.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:o,options:{},schema:E.schema,password:c,devMode:xe.isDevMode()});await _.remove(),E.isCollection&&await Ui("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:i})})),l){var S=v.map(E=>{var _=Zi(E);return _._deleted=!0,_._meta.lwt=Et(),_._rev=yr(r,E),{previous:E,document:_}});await t.bulkWrite(S,"rx-database-remove-collection-all")}}function Ot(e){if(e.closed)throw Z("COL21",{collection:e.name,version:e.schema.version})}var Bg=function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(De(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&ao().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t._handleChangeEvents=function(n){var i=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(pn(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var o=i+1,c=this.eventCounterMap,l=0;l<n.length;l++){var d=n[l];c.set(d,o+l)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var i=this.buffer[0],o=this.eventCounterMap.get(i);if(n<o)return null;var c=n-o;return c},t.getFrom=function(n){this.processTasks();var i=[],o=this.getArrayIndexByPointer(n);if(o===null)return null;for(;;){var c=this.buffer[o];if(o++,c)i.push(c);else return i}},t.runFrom=function(n,i){this.processTasks();var o=this.getFrom(n);if(o===null)throw new Error("out of bounds");o.forEach(c=>i(c))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.close=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e}();function Ng(e){return new Bg(e)}var jg=new WeakMap;function qg(e){var t=e.schema.getDocumentPrototype(),r=Hg(e),n=ho,i={};return[t,r,n].forEach(o=>{var c=Object.getOwnPropertyNames(o);c.forEach(l=>{var d=Object.getOwnPropertyDescriptor(o,l),v=!0;(l.startsWith("_")||l.endsWith("_")||l.startsWith("$")||l.endsWith("$"))&&(v=!1),typeof d.value=="function"?Object.defineProperty(i,l,{get(){return d.value.bind(this)},enumerable:v,configurable:!1}):(d.enumerable=v,d.configurable=!1,d.writable&&(d.writable=!1),Object.defineProperty(i,l,d))})}),i}function Fg(e){return Ut(jg,e,()=>Hf(qg(e)))}function Kg(e,t,r){var n=wv(t,e,xe.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),pt("postCreateRxDocument",n),n}function Hg(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}var Ya={isEqual(e,t){return Si(Zt(e),Zt(t))},resolve(e){return e.realMasterState}},rd=["pre","post"],nd=["insert","save","remove","create"],Lu=!1,Pn=new Set,id=function(){function e(r,n,i,o,c={},l={},d={},v={},m={},g=Gf,S={},E=Ya){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=mg(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=i,this.internalStorageInstance=o,this.instanceCreationOptions=c,this.migrationStrategies=l,this.methods=d,this.attachments=v,this.options=m,this.cacheReplacementPolicy=g,this.statics=S,this.conflictHandler=E,Ug(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(De(_=>_.collectionName===this.name))),this.database&&Pn.add(this)}var t=e.prototype;return t.prepare=async function(){if(!await Il()){for(var n=0;n<10&&Pn.size>su;)n++,await this.promiseWait(30);if(Pn.size>su)throw Z("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(Pn.values()).map(d=>({db:d.database?d.database.name:"",c:d.name}))}})}this.storageInstance=fc(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new Kf(this.storageInstance,this.schema.primaryPath,(d,v)=>Uf(this,d,v),d=>this._runHooks("post","save",d)),this.$=this.eventBulks$.pipe(_r(d=>Zl(d))),this.checkpoint$=this.eventBulks$.pipe(Ue(d=>d.checkpoint)),this._changeEventBuffer=Ng(this.asRxCollection);var i;this._docCache=new Yf(this.schema.primaryPath,this.eventBulks$.pipe(De(d=>!d.isLocal),Ue(d=>d.events)),d=>(i||(i=Fg(this.asRxCollection)),Kg(this.asRxCollection,i,d)));var o=this.database.internalStore.changeStream().pipe(De(d=>{var v=this.name+"-"+this.schema.version,m=d.events.find(g=>g.documentData.context==="collection"&&g.documentData.key===v&&g.operation==="DELETE");return!!m})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(d=>d()))});this._subs.push(o);var c=await this.database.storageToken,l=this.storageInstance.changeStream().subscribe(d=>{var v={id:d.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:c,events:d.events,databaseToken:this.database.token,checkpoint:d.checkpoint,context:d.context};this.database.$emit(v)});return this._subs.push(l),Mt},t.cleanup=function(n){throw Ot(this),Ce("cleanup")},t.migrationNeeded=function(){throw Ce("migration-schema")},t.getMigrationState=function(){throw Ce("migration-schema")},t.startMigration=function(n=10){return Ot(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){Ot(this);var i=await this.bulkInsert([n]),o=i.error[0];Ga(this,n[this.schema.primaryPath],n,o);var c=de(i.success[0]);return c},t.insertIfNotExists=async function(n){var i=await this.bulkInsert([n]);if(i.error.length>0){var o=i.error[0];if(o.status===409){var c=o.documentInDb;return Ms(this._docCache,[c])[0]}else throw o}return i.success[0]},t.bulkInsert=async function(n){if(Ot(this),n.length===0)return{success:[],error:[]};var i=this.schema.primaryPath,o=new Set,c;if(this.hasHooks("pre","insert"))c=await Promise.all(n.map(A=>{var j=Ra(this.schema,A);return this._runHooks("pre","insert",j).then(()=>(o.add(j[i]),{document:j}))}));else{c=new Array(n.length);for(var l=this.schema,d=0;d<n.length;d++){var v=n[d],m=Ra(l,v);o.add(m[i]),c[d]={document:m}}}if(o.size!==n.length)throw Z("COL22",{collection:this.name,args:{documents:n}});var g=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-insert"),S,E=this,_={get success(){if(!S){var A=Bt(E.schema.primaryPath,c,g);S=Ms(E._docCache,A)}return S},error:g.error};if(this.hasHooks("post","insert")){var D=new Map;c.forEach(A=>{var j=A.document;D.set(j[i],j)}),await Promise.all(_.success.map(A=>this._runHooks("post","insert",D.get(A.primary),A)))}return _},t.bulkRemove=async function(n){Ot(this);var i=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var o;typeof n[0]=="string"?o=await this.findByIds(n).exec():(o=new Map,n.forEach(E=>o.set(E.primary,E)));var c=[],l=new Map;Array.from(o.values()).forEach(E=>{var _=E.toMutableJSON(!0);c.push(_),l.set(E.primary,_)}),await Promise.all(c.map(E=>{var _=E[this.schema.primaryPath];return this._runHooks("pre","remove",E,o.get(_))}));var d=c.map(E=>{var _=Be(E);return _._deleted=!0,{previous:E,document:_}}),v=await this.storageInstance.bulkWrite(d,"rx-collection-bulk-remove"),m=Bt(this.schema.primaryPath,d,v),g=[],S=m.map(E=>{var _=E[i],D=this._docCache.getCachedRxDocument(E);return g.push(D),_});return await Promise.all(S.map(E=>this._runHooks("post","remove",l.get(E),o.get(E)))),{success:g,error:v.error}},t.bulkUpsert=async function(n){Ot(this);var i=[],o=new Map;n.forEach(v=>{var m=Ra(this.schema,v),g=m[this.schema.primaryPath];if(!g)throw Z("COL3",{primaryPath:this.schema.primaryPath,data:m,schema:this.schema.jsonSchema});o.set(g,m),i.push(m)});var c=await this.bulkInsert(i),l=c.success.slice(0),d=[];return await Promise.all(c.error.map(async v=>{if(v.status!==409)d.push(v);else{var m=v.documentId,g=qn(o,m),S=de(v.documentInDb),E=this._docCache.getCachedRxDocuments([S])[0],_=await E.incrementalModify(()=>g);l.push(_)}})),{error:d,success:l}},t.upsert=async function(n){Ot(this);var i=await this.bulkUpsert([n]);return Ga(this.asRxCollection,n[this.schema.primaryPath],n,i.error[0]),i.success[0]},t.incrementalUpsert=function(n){Ot(this);var i=Ra(this.schema,n),o=i[this.schema.primaryPath];if(!o)throw Z("COL4",{data:n});var c=this._incrementalUpsertQueues.get(o);return c||(c=Mt),c=c.then(()=>zg(this,o,i)).then(l=>l.inserted?l.doc:Wg(l.doc,i)),this._incrementalUpsertQueues.set(o,c),c},t.find=function(n){Ot(this),pt("prePrepareRxQuery",{op:"find",queryObj:n,collection:this}),n||(n=Ba());var i=On("find",n,this);return i},t.findOne=function(n){Ot(this),pt("prePrepareRxQuery",{op:"findOne",queryObj:n,collection:this});var i;if(typeof n=="string")i=On("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=Ba()),n.limit)throw Z("QU6");n=Be(n),n.limit=1,i=On("findOne",n,this)}return i},t.count=function(n){Ot(this),n||(n=Ba());var i=On("count",n,this);return i},t.findByIds=function(n){Ot(this);var i={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},o=On("findByIds",i,this);return o},t.exportJSON=function(){throw Ce("json-dump")},t.importJSON=function(n){throw Ce("json-dump")},t.insertCRDT=function(n){throw Ce("crdt")},t.addPipeline=function(n){throw Ce("pipeline")},t.addHook=function(n,i,o,c=!1){if(typeof o!="function")throw Lt("COL7",{key:i,when:n});if(!rd.includes(n))throw Lt("COL8",{key:i,when:n});if(!nd.includes(i))throw Z("COL9",{key:i});if(n==="post"&&i==="create"&&c===!0)throw Z("COL10",{when:n,key:i,parallel:c});var l=o.bind(this),d=c?"parallel":"series";this.hooks[i]=this.hooks[i]||{},this.hooks[i][n]=this.hooks[i][n]||{series:[],parallel:[]},this.hooks[i][n][d].push(l)},t.getHooks=function(n,i){return!this.hooks[i]||!this.hooks[i][n]?{series:[],parallel:[]}:this.hooks[i][n]},t.hasHooks=function(n,i){if(!this.hooks[i]||!this.hooks[i][n])return!1;var o=this.getHooks(n,i);return o?o.series.length>0||o.parallel.length>0:!1},t._runHooks=function(n,i,o,c){var l=this.getHooks(n,i);if(!l)return Mt;var d=l.series.map(v=>()=>v(o,c));return Fh(d).then(()=>Promise.all(l.parallel.map(v=>v(o,c))))},t._runHooksSync=function(n,i,o,c){if(this.hasHooks(n,i)){var l=this.getHooks(n,i);l&&l.series.forEach(d=>d(o,c))}},t.promiseWait=function(n){var i=new Promise(o=>{var c=setTimeout(()=>{this.timeouts.delete(c),o()},n);this.timeouts.add(c)});return i},t.close=async function(){return this.closed?br:(Pn.delete(this),await Promise.all(this.onClose.map(n=>n())),this.closed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],Ui("postCloseRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(n=>n())),await td(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},Hr(e,[{key:"insert$",get:function(){return this.$.pipe(De(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(De(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(De(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])}();function Ug(e){if(!Lu){Lu=!0;var t=Object.getPrototypeOf(e);nd.forEach(r=>{rd.map(n=>{var i=n+_l(r);t[i]=function(o,c){return this.addHook(n,r,o,c)}})})}}function Wg(e,t){return e.incrementalModify(r=>t)}function zg(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(i=>i?{doc:i,inserted:!1}:e.insert(r).then(o=>({doc:o,inserted:!0})))}function Vg({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:i={},autoMigrate:o=!0,statics:c={},methods:l={},attachments:d={},options:v={},localDocuments:m=!1,cacheReplacementPolicy:g=Gf,conflictHandler:S=Ya}){var E={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:xe.isDevMode()};return pt("preCreateRxStorageInstance",E),Ag(e,E).then(_=>{var D=new id(e,t,r,_,n,i,l,d,v,g,c,S);return D.prepare().then(()=>{Object.entries(c).forEach(([j,K])=>{Object.defineProperty(D,j,{get:()=>K.bind(D)})});var A=Mt;return o&&D.schema.version!==0&&(A=D.migratePromise()),A}).then(()=>(pt("createRxCollection",{collection:D,creator:{name:t,schema:r,storageInstance:_,instanceCreationOptions:n,migrationStrategies:i,methods:l,attachments:d,options:v,cacheReplacementPolicy:g,localDocuments:m,statics:c}}),D)).catch(A=>(Pn.delete(D),_.close().then(()=>Promise.reject(A))))})}var ad=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};ad.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,As(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(i){throw this.unlock(),i}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(i){return r.unlock(),i}).catch(function(i){throw r.unlock(),i})},requestIdlePromise:function(t){var r=this;t=t||{};var n,i=new Promise(function(l){return n=l}),o=function(){fs(r,i),n()};if(i._manRes=o,t.timeout){var c=setTimeout(function(){i._manRes()},t.timeout);i._timeoutObj=c}return this._iC.add(i),As(this),i},cancelIdlePromise:function(t){fs(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,i=this.requestIdlePromise(r);return this._hPM.set(n,i),this._pHM.set(i,n),i.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return fs(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function Qg(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return As(e)},0)}}function fs(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function As(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}Qg(e),e._tryIR=!1},0)},0))}class bc{constructor(t){Oa(this,"ttl");Oa(this,"map",new Map);Oa(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,od()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Gg(this)},0))}clear(){this.map.clear()}}function Gg(e){const t=od()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const i=n[0];if(n[1]<t)e.map.delete(i);else return}}function od(){return Date.now()}var Bs=new Set,$u=new Map,wc=function(){function e(r,n,i,o,c,l,d=!1,v={},m,g,S,E,_,D){this.idleQueue=new ad,this.rxdbVersion=kl,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new Tt,this.closePromise=null,this.observable$=this.eventBulks$.pipe(_r(A=>Zl(A))),this.storageToken=br,this.storageTokenDocument=br,this.emittedEventBulkIds=new bc(60*1e3),this.name=r,this.token=n,this.storage=i,this.instanceCreationOptions=o,this.password=c,this.multiInstance=l,this.eventReduce=d,this.options=v,this.internalStore=m,this.hashFunction=g,this.cleanupPolicy=S,this.allowSlowCount=E,this.reactivity=_,this.onClosed=D,this.name!=="pseudoInstance"&&(this.internalStore=fc(this.asRxDatabase,m,yc),this.storageTokenDocument=$g(this.asRxDatabase).catch(A=>this.startupErrors.push(A)),this.storageToken=this.storageTokenDocument.then(A=>A.data.token).catch(A=>this.startupErrors.push(A)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw Z("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,i){var o=await Xi(this.internalStore,Vn(Ts(n,i),hn));if(!o)throw Z("SNH",{name:n,schema:i});var c=Zi(o);c._deleted=!0,await this.internalStore.bulkWrite([{document:c,previous:o}],"rx-database-remove-collection")},t.addCollections=async function(n){var i={},o={},c=[],l={};await Promise.all(Object.entries(n).map(async([m,g])=>{var S=m,E=g.schema;i[S]=E;var _=sm(E,this.hashFunction);if(o[S]=_,this.collections[m])throw Z("DB3",{name:m});var D=Ts(m,E),A={id:Vn(D,hn),key:D,context:hn,data:{name:S,schemaHash:await _.hash,schema:_.jsonSchema,version:_.version,connectedStorages:[]},_deleted:!1,_meta:Yn(),_rev:Ht(),_attachments:{}};c.push({document:A});var j=Object.assign({},g,{name:S,schema:_,database:this}),K=Be(g);K.database=this,K.name=m,pt("preCreateRxCollection",K),j.conflictHandler=K.conflictHandler,l[S]=j}));var d=await this.internalStore.bulkWrite(c,"rx-database-add-collection");await ey(this),await Promise.all(d.error.map(async m=>{if(m.status!==409)throw Z("DB12",{database:this.name,writeError:m});var g=de(m.documentInDb),S=g.data.name,E=o[S];if(g.data.schemaHash!==await E.hash)throw Z("DB6",{database:this.name,collection:S,previousSchemaHash:g.data.schemaHash,schemaHash:await E.hash,previousSchema:g.data.schema,schema:de(i[S])})}));var v={};return await Promise.all(Object.keys(n).map(async m=>{var g=l[m],S=await Vg(g);v[m]=S,this.collections[m]=S,this[m]||Object.defineProperty(this,m,{get:()=>this.collections[m]})})),v},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw Ce("json-dump")},t.addState=function(n){throw Ce("state")},t.importJSON=function(n){throw Ce("json-dump")},t.backup=function(n){throw Ce("backup")},t.leaderElector=function(){throw Ce("leader-election")},t.isLeader=function(){throw Ce("leader-election")},t.waitForLeadership=function(){throw Ce("leader-election")},t.migrationStates=function(){throw Ce("migration-schema")},t.close=function(){if(this.closePromise)return this.closePromise;var{promise:n,resolve:i}=sd(),o=c=>{this.onClosed&&this.onClosed(),this.closed=!0,i(c)};return this.closePromise=n,(async()=>{if(await Ui("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(c=>c.unsubscribe()),this.name==="pseudoInstance"){o(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(c=>c()))).then(()=>Promise.all(Object.keys(this.collections).map(c=>this.collections[c]).map(c=>c.close()))).then(()=>this.internalStore.close()).then(()=>o(!0))})(),n},t.remove=function(){return this.close().then(()=>Xg(this.name,this.storage,this.multiInstance,this.password))},Hr(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])}();function Yg(e,t){if(Bs.has(cd(e,t)))throw Z("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function sd(){var e,t,r=new Promise((n,i)=>{e=n,t=i});return{promise:r,resolve:e,reject:t}}function cd(e,t){return t.name+"|"+e}async function ud(e,t,r,n,i,o){var c=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:fv,schema:yc,options:n,multiInstance:i,password:o,devMode:xe.isDevMode()});return c}function Jg({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i=!0,eventReduce:o=!0,ignoreDuplicate:c=!1,options:l={},cleanupPolicy:d,closeDuplicates:v=!1,allowSlowCount:m=!1,localDocuments:g=!1,hashFunction:S=wl,reactivity:E}){pt("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:l,localDocuments:g});var _=cd(r,e),D=$u.get(_)||new Set,A=sd(),j=Array.from(D),K=()=>{D.delete(A.promise),Bs.delete(_)};return D.add(A.promise),$u.set(_,D),(async()=>{if(v&&await Promise.all(j.map(ee=>ee.catch(()=>null).then(ne=>ne&&ne.close()))),c){if(!xe.isDevMode())throw Z("DB9",{database:r})}else Yg(r,e);Bs.add(_);var Y=Ki(10),se=await ud(Y,e,r,t,i,n),ae=new wc(r,Y,e,t,n,i,o,l,se,S,d,m,E,K);return await Ui("createRxDatabase",{database:ae,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:l,localDocuments:g}}),ae})().then(Y=>{A.resolve(Y)}).catch(Y=>{A.reject(Y),K()}),A.promise}async function Xg(e,t,r=!0,n){var i=Ki(10),o=await ud(i,t,e,{},r,n),c=await Zf(o),l=new Set;c.forEach(v=>l.add(v.data.name));var d=Array.from(l);return await Promise.all(d.map(v=>td(t,o,i,e,v,r,n))),await Ui("postRemoveRxDatabase",{databaseName:e,storage:t}),await o.remove(),d}function Zg(e){return e instanceof wc}async function ey(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var ty={RxSchema:Ll.prototype,RxDocument:ho,RxQuery:Jf.prototype,RxCollection:id.prototype,RxDatabase:wc.prototype},ds=new Set,Mu=new Set;function ja(e){if(pt("preAddRxPlugin",{plugin:e,plugins:ds}),!ds.has(e)){{if(Mu.has(e.name))throw Z("PL3",{name:e.name,plugin:e});ds.add(e),Mu.add(e.name)}if(!e.rxdb)throw Lt("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(ty[t])),e.overwritable&&Object.assign(xe,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&ki[t].push(r.after),r.before&&ki[t].unshift(r.before)})}}async function Ja(e,t){var r=bn(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),i=n[0];if(e.lastCheckpointDoc[t]=i,i)return i.checkpointData}async function Xa(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var i={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:Yn(),_rev:Ht()};for(i.id=bn(e.input.metaInstance.schema,i);!e.events.canceled.getValue();){if(n&&(i.checkpointData=Ti([n.checkpointData,i.checkpointData])),i._meta.lwt=Et(),i._rev=yr(await e.checkpointKey,n),e.events.canceled.getValue())return;var o=[{previous:n,document:i}],c=await e.input.metaInstance.bulkWrite(o,"replication-set-checkpoint"),l=Bt(e.primaryPath,o,c)[0];if(l){e.lastCheckpointDoc[t]=l;return}else{var d=c.error[0];if(d.status!==409)throw d;n=de(d.documentInDb),i._rev=yr(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function ry(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function Tu(e,t,r,n,i){var o=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},i?i._meta:{},{lwt:Et()}),_rev:r?n._rev:Ht()});return o._rev||(o._rev=yr(e,i)),o}function $r(e,t,r){var n=Be(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function Ns(e,t){return e.hasAttachments?t.map(r=>{var n=ft(r.document);return n.docData=Zt(n.docData),{document:n,previous:r.previous}}):t}function js(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var qa="RxReplicationProtocolMetaData";function Au(e,t){var r=em(e),n={title:qa,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var i=so(n);return i}function ld(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=bn(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(i=>{n[i.itemId]={docData:i.docData,metaDocument:i}}),n})}async function Za(e,t,r,n){var i=t[e.primaryPath],o=r?Zi(r):{id:"",isCheckpoint:"0",itemId:i,docData:t,_attachments:{},_deleted:!1,_rev:Ht(),_meta:{lwt:0}};o.docData=t,n&&(o.isResolvedConflict=n),o._meta.lwt=Et(),o.id=bn(e.input.metaInstance.schema,o),o._rev=yr(await e.checkpointKey,r);var c={previous:r,document:o};return c}async function ny(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await Ja(e,"down");t||await Xa(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,i=0,o=[];function c(_){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var D={time:i++,task:_};o.push(D),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var A=[];o.length>0;){e.events.active.down.next(!0);var j=de(o.shift());if(!(j.time<d)){if(j.task==="RESYNC")if(A.length===0){A.push(j.task);break}else break;A.push(j.task)}}if(A.length!==0)return A[0]==="RESYNC"?v():m(A)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(c("RESYNC"),!e.events.canceled.getValue()){var l=n.masterChangeStream$.pipe(_r(async _=>(await dn(e.events.active.up.pipe(De(D=>!D))),_))).subscribe(_=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,c(_)});dn(e.events.canceled.pipe(De(_=>!!_))).then(()=>l.unsubscribe())}var d=-1;async function v(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Ja(e,"down"));for(var _=await e.checkpointQueue,D=[];!e.events.canceled.getValue();){d=i++;var A=await n.masterChangesSince(_,e.input.pullBatchSize);if(A.documents.length===0||(_=Ti([_,A.checkpoint]),D.push(E(A.documents,_)),A.documents.length<e.input.pullBatchSize))break}await Promise.all(D)}}function m(_){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var D=[],A=null;return _.forEach(j=>{if(j==="RESYNC")throw new Error("SNH");pn(D,j.documents),A=Ti([A,j.checkpoint])}),E(D,de(A))}var g=Mt,S={docs:{}};function E(_,D){var A=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,_.forEach(j=>{var K=j[A];S.docs[K]=j}),S.checkpoint=D,g=g.then(()=>{var j=S.docs;S.docs={};var K=S.checkpoint,Y=Object.keys(j);if(e.events.canceled.getValue()||Y.length===0)return Mt;var se=[],ae={},ee={},ne=[];return Promise.all([e.input.forkInstance.findDocumentsById(Y,!0),ld(e,Y)]).then(([me,_e])=>{var Ne=new Map;return me.forEach(Pe=>Ne.set(Pe[A],Pe)),Promise.all(Y.map(async Pe=>{var he=Ne.get(Pe),Ie=he?$r(he,e.hasAttachments,!1):void 0,Re=j[Pe],Le=_e[Pe];Le&&he&&Le.metaDocument.isResolvedConflict===he._rev&&await e.streamQueue.up;var et=!Le||!Ie?!1:e.input.conflictHandler.isEqual(Le.docData,Ie,"downstream-check-if-equal-0");if(!et&&Le&&Le.docData._rev&&he&&he._meta[e.input.identifier]&&Fr(he._rev)===he._meta[e.input.identifier]&&(et=!0),he&&Le&&et===!1||he&&!Le)return Mt;var Nt=Ie?e.input.conflictHandler.isEqual(Re,Ie,"downstream-check-if-equal-1"):!1;if(Ie&&Nt)return(!Le||et===!1)&&ne.push(await Za(e,Ie,Le?Le.metaDocument:void 0)),Mt;var Te=Object.assign({},Re,he?{_meta:Be(he._meta),_attachments:e.hasAttachments&&Re._attachments?Re._attachments:{},_rev:Ht()}:{_meta:{lwt:Et()},_rev:Ht(),_attachments:e.hasAttachments&&Re._attachments?Re._attachments:{}});if(Re._rev){var tt=he?Fr(he._rev)+1:1;Te._meta[e.input.identifier]=tt,e.input.keepMeta&&(Te._rev=Re._rev)}e.input.keepMeta&&Re._meta&&(Te._meta=Re._meta);var oe={previous:he,document:Te};oe.document._rev=oe.document._rev?oe.document._rev:yr(r,oe.previous),se.push(oe),ae[Pe]=oe,ee[Pe]=await Za(e,Re,Le?Le.metaDocument:void 0)}))}).then(async()=>{if(se.length>0)return e.input.forkInstance.bulkWrite(se,await e.downstreamBulkWriteFlag).then(me=>{var _e=Bt(e.primaryPath,se,me);_e.forEach(Pe=>{var he=Pe[A];e.events.processed.down.next(ae[he]),ne.push(ee[he])});var Ne;if(me.error.forEach(Pe=>{if(Pe.status!==409){var he=Z("RC_PULL",{writeError:Pe});e.events.error.next(he),Ne=he}}),Ne)throw Ne})}).then(()=>{if(ne.length>0)return e.input.metaInstance.bulkWrite(Ns(e,ne),"replication-down-write-meta").then(me=>{me.error.forEach(_e=>{e.events.error.next(Z("RC_PULL",{id:_e.documentId,writeError:_e}))})})}).then(()=>{Xa(e,"down",K)})}).catch(j=>e.events.error.next(j)),g}}async function iy(e,t,r){var n=e.input.conflictHandler,i=n.isEqual(t.realMasterState,t.newDocumentState,"replication-resolve-conflict");if(!i){var o=await n.resolve(t,"replication-resolve-conflict"),c=Object.assign({},o,{_meta:Be(r._meta),_rev:Ht(),_attachments:Be(r._attachments)});return c._meta.lwt=Et(),c._rev=yr(await e.checkpointKey,r),c}}async function qs(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var i=r[e],o=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([c,l])=>{if((!o.has(c)||n&&de(n._attachments)[c].digest!==l.digest)&&!l.data){var d=await t.getAttachmentData(i,c,l.digest);l.data=d}})),r}async function ay(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await Ja(e,"up");t||await Xa(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>m().then(()=>g()));var n=0,i=-1,o=[],c=br,l={docs:{}},d=e.input.forkInstance.changeStream().subscribe(E=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,o.push({task:E,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>g()):g()}),v=r.masterChangeStream$.pipe(De(E=>E==="RESYNC")).subscribe(()=>{o.push({task:"RESYNC",time:n++}),g()});dn(e.events.canceled.pipe(De(E=>!!E))).then(()=>{d.unsubscribe(),v.unsubscribe()});async function m(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Ja(e,"up"));for(var E=await e.checkpointQueue,_=new Set,D=async function(){i=n++,_.size>3&&await Promise.race(Array.from(_));var K=await qf(e.input.forkInstance,e.input.pushBatchSize,E);if(K.documents.length===0)return 1;E=Ti([E,K.checkpoint]);var Y=S(K.documents,de(E));_.add(Y),Y.catch().then(()=>_.delete(Y))};!e.events.canceled.getValue()&&!await D(););var A=await Promise.all(_),j=A.find(K=>!!K);j?await m():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function g(){if(e.events.canceled.getValue()||o.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var E=[],_={};o.length>0;){var D=de(o.shift());if(!(D.time<i)){if(D.task==="RESYNC"){e.events.active.up.next(!1),await m();return}D.task.context!==await e.downstreamBulkWriteFlag&&pn(E,D.task.events.map(A=>A.documentData)),_=Ti([_,D.task.checkpoint])}}if(await S(E,_),o.length===0)e.events.active.up.next(!1);else return g()})}function S(E,_){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,E.forEach(D=>{var A=D[e.primaryPath];l.docs[A]=D}),l.checkpoint=_,c=c.then(async()=>{if(e.events.canceled.getValue())return!1;var D=l.docs;l.docs={};var A=l.checkpoint,j=Object.keys(D);function K(){return Xa(e,"up",A)}if(j.length===0)return K(),!1;var Y=await ld(e,j),se={},ae=[],ee={},ne={};if(await Promise.all(j.map(async oe=>{var Se=D[oe];ne[oe]=Se;var Qe=$r(Se,e.hasAttachments,!!e.input.keepMeta),fe=Y[oe];fe&&fe.metaDocument.isResolvedConflict!==Se._rev&&e.input.conflictHandler.isEqual(fe.docData,Qe,"upstream-check-if-equal")||fe&&fe.docData._rev&&Fr(Se._rev)===Se._meta[e.input.identifier]||(ae.push(oe),se[oe]={assumedMasterState:fe?fe.docData:void 0,newDocumentState:Qe},ee[oe]=await Za(e,Qe,fe?fe.metaDocument:void 0))})),ae.length===0)return K(),!1;var me=Object.values(se),_e=new Set,Ne={},Pe=Oh(me,e.input.pushBatchSize);await Promise.all(Pe.map(async oe=>{e.hasAttachments&&await Promise.all(oe.map(async Qe=>{Qe.newDocumentState=await qs(e.primaryPath,e.input.forkInstance,ft(Qe.newDocumentState),Qe.assumedMasterState)}));var Se=await r.masterWrite(oe);Se.forEach(Qe=>{var fe=Qe[e.primaryPath];_e.add(fe),Ne[fe]=Qe})}));var he=[];if(ae.forEach(oe=>{_e.has(oe)||(e.events.processed.up.next(se[oe]),he.push(ee[oe]))}),e.events.canceled.getValue())return!1;he.length>0&&await e.input.metaInstance.bulkWrite(Ns(e,he),"replication-up-write-meta");var Ie=!1;if(_e.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var Re=[],Le={};if(await Promise.all(Object.entries(Ne).map(([oe,Se])=>{var Qe=se[oe],fe={newDocumentState:Qe.newDocumentState,assumedMasterState:Qe.assumedMasterState,realMasterState:Se};return iy(e,fe,ne[oe]).then(async je=>{if(je){e.events.resolvedConflicts.next({input:fe,output:je}),Re.push({previous:ne[oe],document:je});var mt=Y[oe];Le[oe]=await Za(e,de(Se),mt?mt.metaDocument:void 0,je._rev)}})})),Re.length>0){Ie=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var et=await e.input.forkInstance.bulkWrite(Re,"replication-up-write-conflict"),Nt;if(et.error.forEach(oe=>{if(oe.status!==409){var Se=Z("RC_PUSH",{writeError:oe});e.events.error.next(Se),Nt=Se}}),Nt)throw Nt;var Te=[],tt=Bt(e.primaryPath,Re,et);tt.forEach(oe=>{var Se=oe[e.primaryPath];Te.push(Le[Se])}),Te.length>0&&await e.input.metaInstance.bulkWrite(Ns(e,Te),"replication-up-write-conflict-meta")}}return K(),Ie}).catch(D=>(e.events.error.next(D),!1)),c}}function oy(e){e=Be(e),e.forkInstance=js(e.forkInstance),e.metaInstance=js(e.metaInstance);var t=ry(e),r={primaryPath:St(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new Lr(!1),paused:new Lr(!1),active:{down:new Lr(!0),up:new Lr(!0)},processed:{down:new Tt,up:new Tt},resolvedConflicts:new Tt,error:new Tt},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new Lr(!1),up:new Lr(!1)},streamQueue:{down:Mt,up:Mt},checkpointQueue:Mt,lastCheckpointDoc:{}};return ny(r),ay(r),r}function sy(e){return dn(zm([e.firstSyncDone.down.pipe(De(t=>!!t)),e.firstSyncDone.up.pipe(De(t=>!!t))])).then(()=>{})}function cy(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function uy(e,t,r,n=!1){e=js(e);var i=!!e.schema.attachments,o=St(e.schema.primaryKey),c={masterChangeStream$:e.changeStream().pipe(_r(async l=>{var d={checkpoint:l.checkpoint,documents:await Promise.all(l.events.map(async v=>{var m=$r(v.documentData,i,n);return i&&(m=await qs(o,e,ft(m),void 0)),m}))};return d})),masterChangesSince(l,d){return qf(e,d,l).then(async v=>({checkpoint:v.documents.length>0?v.checkpoint:l,documents:await Promise.all(v.documents.map(async m=>{var g=$r(m,i,n);return i&&(g=await qs(o,e,ft(g),void 0)),g}))}))},async masterWrite(l){var d={};l.forEach(D=>{var A=D.newDocumentState[o];d[A]=D});var v=Object.keys(d),m=await e.findDocumentsById(v,!0),g=new Map;m.forEach(D=>g.set(D[o],D));var S=[],E=[];if(await Promise.all(Object.entries(d).map(([D,A])=>{var j=g.get(D);j?j&&!A.assumedMasterState?S.push($r(j,i,n)):t.isEqual($r(j,i,n),de(A.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?E.push({previous:j,document:Tu(r,i,n,A.newDocumentState,j)}):S.push($r(j,i,n)):E.push({document:Tu(r,i,n,A.newDocumentState)})})),E.length>0){var _=await e.bulkWrite(E,"replication-master-write");_.error.forEach(D=>{if(D.status!==409)throw Z("SNH",{name:"non conflict error",error:D});S.push($r(de(D.documentInDb),i,n))})}return S}};return c}async function ly(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}function fy(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var dy=Promise.resolve(!0),vr=Promise.resolve();function sn(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function hy(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function ea(){return Math.random().toString(36).substring(2)}var hs=0;function ta(){var e=Date.now()*1e3;return e<=hs&&(e=hs+1),hs=e,e}function my(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var py=ta,vy="native";function gy(e){var t={time:ta(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function yy(e){e.bc.close(),e.subFns=[]}function by(e,t){try{return e.bc.postMessage(t,!1),vr}catch(r){return Promise.reject(r)}}function wy(e,t){e.messagesCallback=t}function _y(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Ey(){return 150}var Sy={create:gy,close:yy,onMessage:wy,postMessage:by,canBeUsed:_y,type:vy,averageResponseTime:Ey,microSeconds:py};function _c(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var xy=ta,ky="pubkey.broadcast-channel-0-",Er="messages",mo={durability:"relaxed"},Iy="idb";function fd(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function Ec(e){e.commit&&e.commit()}function Cy(e){var t=fd(),r=ky+e,n=t.open(r);return n.onupgradeneeded=function(i){var o=i.target.result;o.createObjectStore(Er,{keyPath:"id",autoIncrement:!0})},new Promise(function(i,o){n.onerror=function(c){return o(c)},n.onsuccess=function(){i(n.result)}})}function Dy(e,t,r){var n=Date.now(),i={uuid:t,time:n,data:r},o=e.transaction([Er],"readwrite",mo);return new Promise(function(c,l){o.oncomplete=function(){return c()},o.onerror=function(v){return l(v)};var d=o.objectStore(Er);d.add(i),Ec(o)})}function Oy(e,t){var r=e.transaction(Er,"readonly",mo),n=r.objectStore(Er),i=[],o=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var c=n.getAll(o);return new Promise(function(d,v){c.onerror=function(m){return v(m)},c.onsuccess=function(m){d(m.target.result)}})}function l(){try{return o=IDBKeyRange.bound(t+1,1/0),n.openCursor(o)}catch{return n.openCursor()}}return new Promise(function(d,v){var m=l();m.onerror=function(g){return v(g)},m.onsuccess=function(g){var S=g.target.result;S?S.value.id<t+1?S.continue(t+1):(i.push(S.value),S.continue()):(Ec(r),d(i))}})}function Py(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(Er,"readwrite",mo),n=r.objectStore(Er);return Promise.all(t.map(function(i){var o=n.delete(i);return new Promise(function(c){o.onsuccess=function(){return c()}})}))}function Ry(e,t){var r=Date.now()-t,n=e.transaction(Er,"readonly",mo),i=n.objectStore(Er),o=[];return new Promise(function(c){i.openCursor().onsuccess=function(l){var d=l.target.result;if(d){var v=d.value;v.time<r?(o.push(v),d.continue()):(Ec(n),c(o))}else c(o)}})}function Ly(e){return Ry(e.db,e.options.idb.ttl).then(function(t){return Py(e,t.map(function(r){return r.id}))})}function $y(e,t){return t=_c(t),Cy(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:ea(),eMIs:new bc(t.idb.ttl*2),writeBlockPromise:vr,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},dd(n),n})}function dd(e){e.closed||hd(e).then(function(){return sn(e.options.idb.fallbackInterval)}).then(function(){return dd(e)})}function My(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function hd(e){return e.closed||!e.messagesCallback?vr:Oy(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return My(n,e)}).sort(function(n,i){return n.time-i.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),vr})}function Ty(e){e.closed=!0,e.db.close()}function Ay(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return Dy(e.db,e.uuid,t)}).then(function(){hy(0,10)===0&&Ly(e)}),e.writeBlockPromise}function By(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,hd(e)}function Ny(){return!!fd()}function jy(e){return e.idb.fallbackInterval*2}var qy={create:$y,close:Ty,onMessage:By,postMessage:Ay,canBeUsed:Ny,type:Iy,averageResponseTime:jy,microSeconds:xy},Fy=ta,Ky="pubkey.broadcastChannel-",Hy="localstorage";function md(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function pd(e){return Ky+e}function Uy(e,t){return new Promise(function(r){sn().then(function(){var n=pd(e.channelName),i={token:ea(),time:Date.now(),data:t,uuid:e.uuid},o=JSON.stringify(i);md().setItem(n,o);var c=document.createEvent("Event");c.initEvent("storage",!0,!0),c.key=n,c.newValue=o,window.dispatchEvent(c),r()})})}function Wy(e,t){var r=pd(e),n=function(o){o.key===r&&t(JSON.parse(o.newValue))};return window.addEventListener("storage",n),n}function zy(e){window.removeEventListener("storage",e)}function Vy(e,t){if(t=_c(t),!vd())throw new Error("BroadcastChannel: localstorage cannot be used");var r=ea(),n=new bc(t.localstorage.removeTimeout),i={channelName:e,uuid:r,eMIs:n};return i.listener=Wy(e,function(o){i.messagesCallback&&o.uuid!==r&&(!o.token||n.has(o.token)||o.data.time&&o.data.time<i.messagesCallbackTime||(n.add(o.token),i.messagesCallback(o.data)))}),i}function Qy(e){zy(e.listener)}function Gy(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function vd(){var e=md();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function Yy(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var Jy={create:Vy,close:Qy,onMessage:Gy,postMessage:Uy,canBeUsed:vd,type:Hy,averageResponseTime:Yy,microSeconds:Fy},gd=ta,Xy="simulate",Sc=new Set;function Zy(e){var t={time:gd(),name:e,messagesCallback:null};return Sc.add(t),t}function eb(e){Sc.delete(e)}var yd=5;function tb(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(Sc);n.forEach(function(i){i.name===e.name&&i!==e&&i.messagesCallback&&i.time<t.time&&i.messagesCallback(t)}),r()},yd)})}function rb(e,t){e.messagesCallback=t}function nb(){return!0}function ib(){return yd}var ab={create:Zy,close:eb,onMessage:rb,postMessage:tb,canBeUsed:nb,type:Xy,averageResponseTime:ib,microSeconds:gd},Bu=[Sy,qy,Jy];function ob(e){var t=[].concat(e.methods,Bu).filter(Boolean);if(e.type){if(e.type==="simulate")return ab;var r=t.find(function(i){return i.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(i){return i.type!=="idb"}));var n=t.find(function(i){return i.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(Bu.map(function(i){return i.type})))}var bd=new Set,sb=0,po=function(t,r){this.id=sb++,bd.add(this),this.name=t,this.options=_c(r),this.method=ob(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,cb(this)};po._pubkey=!0;po.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return Nu(this,"message",t)},postInternal:function(t){return Nu(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};qu(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,ju(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),i={time:n,fn:r};ju(this,t,i)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(i){return i.fn===r});qu(this,t,n)},close:function(){var t=this;if(!this.closed){bd.delete(this),this.closed=!0;var r=this._prepP?this._prepP:vr;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function Nu(e,t,r){var n=e.method.microSeconds(),i={time:n,type:t,data:r},o=e._prepP?e._prepP:vr;return o.then(function(){var c=e.method.postMessage(e._state,i);return e._uMP.add(c),c.catch().then(function(){return e._uMP.delete(c)}),c})}function cb(e){var t=e.method.create(e.name,e.options);fy(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function wd(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function ju(e,t,r){e._addEL[t].push(r),ub(e)}function qu(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),lb(e)}function ub(e){if(!e._iL&&wd(e)){var t=function(i){e._addEL[i.type].forEach(function(o){i.time>=o.time&&o.fn(i.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function lb(e){if(e._iL&&!wd(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function fb(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function db(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var hb=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",mb=hb?db:fb,vi=new Set,Fu=!1;function pb(){Fu||(Fu=!0,mb(gb))}function vb(e){if(pb(),typeof e!="function")throw new Error("Listener is no function");vi.add(e);var t={remove:function(){return vi.delete(e)},run:function(){return vi.delete(e),e()}};return t}function gb(){var e=[];return vi.forEach(function(t){e.push(t()),vi.delete(t)}),Promise.all(e)}function mn(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function _d(e){e.isLeader=!0,e._hasLeader=!0;var t=vb(function(){return e.die()});e._unl.push(t);var r=function(i){i.context==="leader"&&i.action==="apply"&&mn(e,"tell"),i.context==="leader"&&i.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),mn(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),mn(e,"tell")}var Ed=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=ea(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};Ed.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(i){return i.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,i){t._wKMC.res=n,t._wKMC.rej=i});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,_d(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),mn(this,"death")}};var Sd=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=ea(),this._aplQ=vr,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=function(c){c.context==="leader"&&(c.action==="death"&&(n._hasLeader=!1),c.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};Sd.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return sn(0,!0);if(this.isDead)return sn(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return dy;var o=!1,c,l=new Promise(function(m){c=function(){o=!0,m()}}),d=function(g){g.context==="leader"&&g.token!=r.token&&(g.action==="apply"&&g.token>r.token&&c(),g.action==="tell"&&(c(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",d);var v=t?r._options.responseTime*4:r._options.responseTime;return mn(r,"apply").then(function(){return Promise.race([sn(v),l.then(function(){return Promise.reject(new Error)})])}).then(function(){return mn(r,"apply")}).then(function(){return Promise.race([sn(v),l.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",d),o?!1:_d(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=yb(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,mn(this,"death")}};function yb(e){return e.isLeader?vr:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",o),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var i=function(){return sn(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():i()})})};i();var o=function(l){l.context==="leader"&&l.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)})}function bb(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function wb(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=bb(t,e);var r=my()?new Ed(e,t):new Sd(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var eo=new Map;function _b(e,t,r,n){var i=eo.get(t);return i||(i={bc:new po(["RxDB:",e,r].join("|")),refs:new Set},eo.set(t,i)),i.refs.add(n),i.bc}function Ku(e,t){var r=eo.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return eo.delete(e),r.bc.close()}function Eb(e,t,r,n){if(t.multiInstance){var i=_b(e,t.databaseInstanceToken,r.databaseName,r),o=new Tt,c=S=>{S.storageName===e&&S.databaseName===t.databaseName&&S.collectionName===t.collectionName&&S.version===t.schema.version&&o.next(S.eventBulk)};i.addEventListener("message",c);var l=r.changeStream(),d=!1,v=l.subscribe(S=>{d||i.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:S})});r.changeStream=function(){return o.asObservable().pipe(tp(l))};var m=r.close.bind(r);r.close=async function(){return d=!0,v.unsubscribe(),i.removeEventListener("message",c),await Ku(t.databaseInstanceToken,r),m()};var g=r.remove.bind(r);r.remove=async function(){return d=!0,v.unsubscribe(),i.removeEventListener("message",c),await Ku(t.databaseInstanceToken,r),g()}}}var Sb=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function xb(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Fa={exports:{}},kb=Fa.exports,Hu;function Ib(){return Hu||(Hu=1,function(e,t){(function(r,n){e.exports=n()})(kb,function(){var r=function(a,s){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(u[h]=f[h])})(a,s)},n=function(){return(n=Object.assign||function(a){for(var s,u=1,f=arguments.length;u<f;u++)for(var h in s=arguments[u])Object.prototype.hasOwnProperty.call(s,h)&&(a[h]=s[h]);return a}).apply(this,arguments)};function i(a,s,u){for(var f,h=0,p=s.length;h<p;h++)!f&&h in s||((f=f||Array.prototype.slice.call(s,0,h))[h]=s[h]);return a.concat(f||Array.prototype.slice.call(s))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Sb,c=Object.keys,l=Array.isArray;function d(a,s){return typeof s!="object"||c(s).forEach(function(u){a[u]=s[u]}),a}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var v=Object.getPrototypeOf,m={}.hasOwnProperty;function g(a,s){return m.call(a,s)}function S(a,s){typeof s=="function"&&(s=s(v(a))),(typeof Reflect>"u"?c:Reflect.ownKeys)(s).forEach(function(u){_(a,u,s[u])})}var E=Object.defineProperty;function _(a,s,u,f){E(a,s,d(u&&g(u,"get")&&typeof u.get=="function"?{get:u.get,set:u.set,configurable:!0}:{value:u,configurable:!0,writable:!0},f))}function D(a){return{from:function(s){return a.prototype=Object.create(s.prototype),_(a.prototype,"constructor",a),{extend:S.bind(null,a.prototype)}}}}var A=Object.getOwnPropertyDescriptor,j=[].slice;function K(a,s,u){return j.call(a,s,u)}function Y(a,s){return s(a)}function se(a){if(!a)throw new Error("Assertion Failed")}function ae(a){o.setImmediate?setImmediate(a):setTimeout(a,0)}function ee(a,s){if(typeof s=="string"&&g(a,s))return a[s];if(!s)return a;if(typeof s!="string"){for(var u=[],f=0,h=s.length;f<h;++f){var p=ee(a,s[f]);u.push(p)}return u}var y=s.indexOf(".");if(y!==-1){var b=a[s.substr(0,y)];return b==null?void 0:ee(b,s.substr(y+1))}}function ne(a,s,u){if(a&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof s!="string"&&"length"in s){se(typeof u!="string"&&"length"in u);for(var f=0,h=s.length;f<h;++f)ne(a,s[f],u[f])}else{var p,y,b=s.indexOf(".");b!==-1?(p=s.substr(0,b),(y=s.substr(b+1))===""?u===void 0?l(a)&&!isNaN(parseInt(p))?a.splice(p,1):delete a[p]:a[p]=u:ne(b=!(b=a[p])||!g(a,p)?a[p]={}:b,y,u)):u===void 0?l(a)&&!isNaN(parseInt(s))?a.splice(s,1):delete a[s]:a[s]=u}}function me(a){var s,u={};for(s in a)g(a,s)&&(u[s]=a[s]);return u}var _e=[].concat;function Ne(a){return _e.apply([],a)}var sr="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ne([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(s){return s+a+"Array"})}))).filter(function(a){return o[a]}),Pe=new Set(sr.map(function(a){return o[a]})),he=null;function Ie(a){return he=new WeakMap,a=function s(u){if(!u||typeof u!="object")return u;var f=he.get(u);if(f)return f;if(l(u)){f=[],he.set(u,f);for(var h=0,p=u.length;h<p;++h)f.push(s(u[h]))}else if(Pe.has(u.constructor))f=u;else{var y,b=v(u);for(y in f=b===Object.prototype?{}:Object.create(b),he.set(u,f),u)g(u,y)&&(f[y]=s(u[y]))}return f}(a),he=null,a}var Re={}.toString;function Le(a){return Re.call(a).slice(8,-1)}var et=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Nt=typeof et=="symbol"?function(a){var s;return a!=null&&(s=a[et])&&s.apply(a)}:function(){return null};function Te(a,s){return s=a.indexOf(s),0<=s&&a.splice(s,1),0<=s}var tt={};function oe(a){var s,u,f,h;if(arguments.length===1){if(l(a))return a.slice();if(this===tt&&typeof a=="string")return[a];if(h=Nt(a)){for(u=[];!(f=h.next()).done;)u.push(f.value);return u}if(a==null)return[a];if(typeof(s=a.length)!="number")return[a];for(u=new Array(s);s--;)u[s]=a[s];return u}for(s=arguments.length,u=new Array(s);s--;)u[s]=arguments[s];return u}var Se=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Qr=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Dt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Qr),Qe={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function fe(a,s){this.name=a,this.message=s}function je(a,s){return a+". Errors: "+Object.keys(s).map(function(u){return s[u].toString()}).filter(function(u,f,h){return h.indexOf(u)===f}).join(`
`)}function mt(a,s,u,f){this.failures=s,this.failedKeys=f,this.successCount=u,this.message=je(a,s)}function It(a,s){this.name="BulkError",this.failures=Object.keys(s).map(function(u){return s[u]}),this.failuresByPos=s,this.message=je(a,this.failures)}D(fe).from(Error).extend({toString:function(){return this.name+": "+this.message}}),D(mt).from(fe),D(It).from(fe);var zr=Dt.reduce(function(a,s){return a[s]=s+"Error",a},{}),ra=fe,$=Dt.reduce(function(a,s){var u=s+"Error";function f(h,p){this.name=u,h?typeof h=="string"?(this.message="".concat(h).concat(p?`
 `+p:""),this.inner=p||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=Qe[s]||u,this.inner=null)}return D(f).from(ra),a[s]=f,a},{});$.Syntax=SyntaxError,$.Type=TypeError,$.Range=RangeError;var X=Qr.reduce(function(a,s){return a[s+"Error"]=$[s],a},{}),te=Dt.reduce(function(a,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(a[s+"Error"]=$[s]),a},{});function U(){}function ye(a){return a}function pe(a,s){return a==null||a===ye?s:function(u){return s(a(u))}}function ze(a,s){return function(){a.apply(this,arguments),s.apply(this,arguments)}}function nr(a,s){return a===U?s:function(){var u=a.apply(this,arguments);u!==void 0&&(arguments[0]=u);var f=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var p=s.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?ze(f,this.onsuccess):f),h&&(this.onerror=this.onerror?ze(h,this.onerror):h),p!==void 0?p:u}}function ue(a,s){return a===U?s:function(){a.apply(this,arguments);var u=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?ze(u,this.onsuccess):u),f&&(this.onerror=this.onerror?ze(f,this.onerror):f)}}function ut(a,s){return a===U?s:function(u){var f=a.apply(this,arguments);d(u,f);var h=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,u=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?ze(h,this.onsuccess):h),p&&(this.onerror=this.onerror?ze(p,this.onerror):p),f===void 0?u===void 0?void 0:u:d(f,u)}}function jt(a,s){return a===U?s:function(){return s.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function Qt(a,s){return a===U?s:function(){var u=a.apply(this,arguments);if(u&&typeof u.then=="function"){for(var f=this,h=arguments.length,p=new Array(h);h--;)p[h]=arguments[h];return u.then(function(){return s.apply(f,p)})}return s.apply(this,arguments)}}te.ModifyError=mt,te.DexieError=fe,te.BulkError=It;var Ae=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Vr(a){Ae=a}var Ct={},ir=100,sr=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,v(a),a];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,v(s),a]}(),Qr=sr[0],Dt=sr[1],sr=sr[2],Dt=Dt&&Dt.then,ar=Qr&&Qr.constructor,yo=!!sr,ei=function(a,s){ti.push([a,s]),na&&(queueMicrotask(Zd),na=!1)},bo=!0,na=!0,Gr=[],ia=[],wo=ye,xr={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:U,pgp:!1,env:{},finalize:U},re=xr,ti=[],Yr=0,aa=[];function G(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=re;if(typeof a!="function"){if(a!==Ct)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Eo(this,this._value))}this._state=null,this._value=null,++s.ref,function u(f,h){try{h(function(p){if(f._state===null){if(p===f)throw new TypeError("A promise cannot be resolved with itself.");var y=f._lib&&_n();p&&typeof p.then=="function"?u(f,function(b,x){p instanceof G?p._then(b,x):p.then(b,x)}):(f._state=!0,f._value=p,Dc(f)),y&&En()}},Eo.bind(null,f))}catch(p){Eo(f,p)}}(this,a)}var _o={get:function(){var a=re,s=ua;function u(f,h){var p=this,y=!a.global&&(a!==re||s!==ua),b=y&&!Ir(),x=new G(function(I,P){So(p,new Cc(Pc(f,a,y,b),Pc(h,a,y,b),I,P,a))});return this._consoleTask&&(x._consoleTask=this._consoleTask),x}return u.prototype=Ct,u},set:function(a){_(this,"then",a&&a.prototype===Ct?_o:{get:function(){return a},set:_o.set})}};function Cc(a,s,u,f,h){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof s=="function"?s:null,this.resolve=u,this.reject=f,this.psd=h}function Eo(a,s){var u,f;ia.push(s),a._state===null&&(u=a._lib&&_n(),s=wo(s),a._state=!1,a._value=s,f=a,Gr.some(function(h){return h._value===f._value})||Gr.push(f),Dc(a),u&&En())}function Dc(a){var s=a._listeners;a._listeners=[];for(var u=0,f=s.length;u<f;++u)So(a,s[u]);var h=a._PSD;--h.ref||h.finalize(),Yr===0&&(++Yr,ei(function(){--Yr==0&&xo()},[]))}function So(a,s){if(a._state!==null){var u=a._state?s.onFulfilled:s.onRejected;if(u===null)return(a._state?s.resolve:s.reject)(a._value);++s.psd.ref,++Yr,ei(Xd,[u,a,s])}else a._listeners.push(s)}function Xd(a,s,u){try{var f,h=s._value;!s._state&&ia.length&&(ia=[]),f=Ae&&s._consoleTask?s._consoleTask.run(function(){return a(h)}):a(h),s._state||ia.indexOf(h)!==-1||function(p){for(var y=Gr.length;y;)if(Gr[--y]._value===p._value)return Gr.splice(y,1)}(s),u.resolve(f)}catch(p){u.reject(p)}finally{--Yr==0&&xo(),--u.psd.ref||u.psd.finalize()}}function Zd(){Jr(xr,function(){_n()&&En()})}function _n(){var a=bo;return na=bo=!1,a}function En(){var a,s,u;do for(;0<ti.length;)for(a=ti,ti=[],u=a.length,s=0;s<u;++s){var f=a[s];f[0].apply(null,f[1])}while(0<ti.length);na=bo=!0}function xo(){var a=Gr;Gr=[],a.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var s=aa.slice(0),u=s.length;u;)s[--u]()}function oa(a){return new G(Ct,!1,a)}function $e(a,s){var u=re;return function(){var f=_n(),h=re;try{return Cr(u,!0),a.apply(this,arguments)}catch(p){s&&s(p)}finally{Cr(h,!1),f&&En()}}}S(G.prototype,{then:_o,_then:function(a,s){So(this,new Cc(null,null,a,s,re))},catch:function(a){if(arguments.length===1)return this.then(null,a);var s=a,u=arguments[1];return typeof s=="function"?this.then(null,function(f){return(f instanceof s?u:oa)(f)}):this.then(null,function(f){return(f&&f.name===s?u:oa)(f)})},finally:function(a){return this.then(function(s){return G.resolve(a()).then(function(){return s})},function(s){return G.resolve(a()).then(function(){return oa(s)})})},timeout:function(a,s){var u=this;return a<1/0?new G(function(f,h){var p=setTimeout(function(){return h(new $.Timeout(s))},a);u.then(f,h).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&_(G.prototype,Symbol.toStringTag,"Dexie.Promise"),xr.env=Oc(),S(G,{all:function(){var a=oe.apply(null,arguments).map(la);return new G(function(s,u){a.length===0&&s([]);var f=a.length;a.forEach(function(h,p){return G.resolve(h).then(function(y){a[p]=y,--f||s(a)},u)})})},resolve:function(a){return a instanceof G?a:a&&typeof a.then=="function"?new G(function(s,u){a.then(s,u)}):new G(Ct,!0,a)},reject:oa,race:function(){var a=oe.apply(null,arguments).map(la);return new G(function(s,u){a.map(function(f){return G.resolve(f).then(s,u)})})},PSD:{get:function(){return re},set:function(a){return re=a}},totalEchoes:{get:function(){return ua}},newPSD:kr,usePSD:Jr,scheduler:{get:function(){return ei},set:function(a){ei=a}},rejectionMapper:{get:function(){return wo},set:function(a){wo=a}},follow:function(a,s){return new G(function(u,f){return kr(function(h,p){var y=re;y.unhandleds=[],y.onunhandled=p,y.finalize=ze(function(){var b,x=this;b=function(){x.unhandleds.length===0?h():p(x.unhandleds[0])},aa.push(function I(){b(),aa.splice(aa.indexOf(I),1)}),++Yr,ei(function(){--Yr==0&&xo()},[])},y.finalize),a()},s,u,f)})}}),ar&&(ar.allSettled&&_(G,"allSettled",function(){var a=oe.apply(null,arguments).map(la);return new G(function(s){a.length===0&&s([]);var u=a.length,f=new Array(u);a.forEach(function(h,p){return G.resolve(h).then(function(y){return f[p]={status:"fulfilled",value:y}},function(y){return f[p]={status:"rejected",reason:y}}).then(function(){return--u||s(f)})})})}),ar.any&&typeof AggregateError<"u"&&_(G,"any",function(){var a=oe.apply(null,arguments).map(la);return new G(function(s,u){a.length===0&&u(new AggregateError([]));var f=a.length,h=new Array(f);a.forEach(function(p,y){return G.resolve(p).then(function(b){return s(b)},function(b){h[y]=b,--f||u(new AggregateError(h))})})})}),ar.withResolvers&&(G.withResolvers=ar.withResolvers));var Ge={awaits:0,echoes:0,id:0},eh=0,sa=[],ca=0,ua=0,th=0;function kr(a,s,u,f){var h=re,p=Object.create(h);return p.parent=h,p.ref=0,p.global=!1,p.id=++th,xr.env,p.env=yo?{Promise:G,PromiseProp:{value:G,configurable:!0,writable:!0},all:G.all,race:G.race,allSettled:G.allSettled,any:G.any,resolve:G.resolve,reject:G.reject}:{},s&&d(p,s),++h.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},f=Jr(p,a,u,f),p.ref===0&&p.finalize(),f}function Sn(){return Ge.id||(Ge.id=++eh),++Ge.awaits,Ge.echoes+=ir,Ge.id}function Ir(){return!!Ge.awaits&&(--Ge.awaits==0&&(Ge.id=0),Ge.echoes=Ge.awaits*ir,!0)}function la(a){return Ge.echoes&&a&&a.constructor===ar?(Sn(),a.then(function(s){return Ir(),s},function(s){return Ir(),qe(s)})):a}function rh(){var a=sa[sa.length-1];sa.pop(),Cr(a,!1)}function Cr(a,s){var u,f=re;(s?!Ge.echoes||ca++&&a===re:!ca||--ca&&a===re)||queueMicrotask(s?(function(h){++ua,Ge.echoes&&--Ge.echoes!=0||(Ge.echoes=Ge.awaits=Ge.id=0),sa.push(re),Cr(h,!0)}).bind(null,a):rh),a!==re&&(re=a,f===xr&&(xr.env=Oc()),yo&&(u=xr.env.Promise,s=a.env,(f.global||a.global)&&(Object.defineProperty(o,"Promise",s.PromiseProp),u.all=s.all,u.race=s.race,u.resolve=s.resolve,u.reject=s.reject,s.allSettled&&(u.allSettled=s.allSettled),s.any&&(u.any=s.any))))}function Oc(){var a=o.Promise;return yo?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function Jr(a,s,u,f,h){var p=re;try{return Cr(a,!0),s(u,f,h)}finally{Cr(p,!1)}}function Pc(a,s,u,f){return typeof a!="function"?a:function(){var h=re;u&&Sn(),Cr(s,!0);try{return a.apply(this,arguments)}finally{Cr(h,!1),f&&queueMicrotask(Ir)}}}function ko(a){Promise===ar&&Ge.echoes===0?ca===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+Dt).indexOf("[native code]")===-1&&(Sn=Ir=U);var qe=G.reject,Xr="ï¿¿",or="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Rc="String expected.",xn=[],fa="__dbnames",Io="readonly",Co="readwrite";function Zr(a,s){return a?s?function(){return a.apply(this,arguments)&&s.apply(this,arguments)}:a:s}var Lc={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function da(a){return typeof a!="string"||/\./.test(a)?function(s){return s}:function(s){return s[a]===void 0&&a in s&&delete(s=Ie(s))[a],s}}function $c(){throw $.Type()}function we(a,s){try{var u=Mc(a),f=Mc(s);if(u!==f)return u==="Array"?1:f==="Array"?-1:u==="binary"?1:f==="binary"?-1:u==="string"?1:f==="string"?-1:u==="Date"?1:f!=="Date"?NaN:-1;switch(u){case"number":case"Date":case"string":return s<a?1:a<s?-1:0;case"binary":return function(h,p){for(var y=h.length,b=p.length,x=y<b?y:b,I=0;I<x;++I)if(h[I]!==p[I])return h[I]<p[I]?-1:1;return y===b?0:y<b?-1:1}(Tc(a),Tc(s));case"Array":return function(h,p){for(var y=h.length,b=p.length,x=y<b?y:b,I=0;I<x;++I){var P=we(h[I],p[I]);if(P!==0)return P}return y===b?0:y<b?-1:1}(a,s)}}catch{}return NaN}function Mc(a){var s=typeof a;return s!="object"?s:ArrayBuffer.isView(a)?"binary":(a=Le(a),a==="ArrayBuffer"?"binary":a)}function Tc(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}var Ac=(Oe.prototype._trans=function(a,s,u){var f=this._tx||re.trans,h=this.name,p=Ae&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function y(I,P,w){if(!w.schema[h])throw new $.NotFound("Table "+h+" not part of transaction");return s(w.idbtrans,w)}var b=_n();try{var x=f&&f.db._novip===this.db._novip?f===re.trans?f._promise(a,y,u):kr(function(){return f._promise(a,y,u)},{trans:f,transless:re.transless||re}):function I(P,w,L,k){if(P.idbdb&&(P._state.openComplete||re.letThrough||P._vip)){var O=P._createTransaction(w,L,P._dbSchema);try{O.create(),P._state.PR1398_maxLoop=3}catch(R){return R.name===zr.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return I(P,w,L,k)})):qe(R)}return O._promise(w,function(R,C){return kr(function(){return re.trans=O,k(R,C,O)})}).then(function(R){if(w==="readwrite")try{O.idbtrans.commit()}catch{}return w==="readonly"?R:O._completion.then(function(){return R})})}if(P._state.openComplete)return qe(new $.DatabaseClosed(P._state.dbOpenError));if(!P._state.isBeingOpened){if(!P._state.autoOpen)return qe(new $.DatabaseClosed);P.open().catch(U)}return P._state.dbReadyPromise.then(function(){return I(P,w,L,k)})}(this.db,a,[this.name],y);return p&&(x._consoleTask=p,x=x.catch(function(I){return console.trace(I),qe(I)})),x}finally{b&&En()}},Oe.prototype.get=function(a,s){var u=this;return a&&a.constructor===Object?this.where(a).first(s):a==null?qe(new $.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return u.core.get({trans:f,key:a}).then(function(h){return u.hook.reading.fire(h)})}).then(s)},Oe.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(l(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var s=c(a);if(s.length===1)return this.where(s[0]).equals(a[s[0]]);var u=this.schema.indexes.concat(this.schema.primKey).filter(function(b){if(b.compound&&s.every(function(I){return 0<=b.keyPath.indexOf(I)})){for(var x=0;x<s.length;++x)if(s.indexOf(b.keyPath[x])===-1)return!1;return!0}return!1}).sort(function(b,x){return b.keyPath.length-x.keyPath.length})[0];if(u&&this.db._maxKey!==Xr){var p=u.keyPath.slice(0,s.length);return this.where(p).equals(p.map(function(x){return a[x]}))}!u&&Ae&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var f=this.schema.idxByName;function h(b,x){return we(b,x)===0}var y=s.reduce(function(w,x){var I=w[0],P=w[1],w=f[x],L=a[x];return[I||w,I||!w?Zr(P,w&&w.multi?function(k){return k=ee(k,x),l(k)&&k.some(function(O){return h(L,O)})}:function(k){return h(L,ee(k,x))}):P]},[null,null]),p=y[0],y=y[1];return p?this.where(p.name).equals(a[p.keyPath]).filter(y):u?this.filter(y):this.where(s).equals("")},Oe.prototype.filter=function(a){return this.toCollection().and(a)},Oe.prototype.count=function(a){return this.toCollection().count(a)},Oe.prototype.offset=function(a){return this.toCollection().offset(a)},Oe.prototype.limit=function(a){return this.toCollection().limit(a)},Oe.prototype.each=function(a){return this.toCollection().each(a)},Oe.prototype.toArray=function(a){return this.toCollection().toArray(a)},Oe.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Oe.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,l(a)?"[".concat(a.join("+"),"]"):a))},Oe.prototype.reverse=function(){return this.toCollection().reverse()},Oe.prototype.mapToClass=function(a){var s,u=this.db,f=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof $c&&(function(x,I){if(typeof I!="function"&&I!==null)throw new TypeError("Class extends value "+String(I)+" is not a constructor or null");function P(){this.constructor=x}r(x,I),x.prototype=I===null?Object.create(I):(P.prototype=I.prototype,new P)}(h,s=a),Object.defineProperty(h.prototype,"db",{get:function(){return u},enumerable:!1,configurable:!0}),h.prototype.table=function(){return f},a=h);for(var p=new Set,y=a.prototype;y;y=v(y))Object.getOwnPropertyNames(y).forEach(function(x){return p.add(x)});function b(x){if(!x)return x;var I,P=Object.create(a.prototype);for(I in x)if(!p.has(I))try{P[I]=x[I]}catch{}return P}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=b,this.hook("reading",b),a},Oe.prototype.defineClass=function(){return this.mapToClass(function(a){d(this,a)})},Oe.prototype.add=function(a,s){var u=this,f=this.schema.primKey,h=f.auto,p=f.keyPath,y=a;return p&&h&&(y=da(p)(a)),this._trans("readwrite",function(b){return u.core.mutate({trans:b,type:"add",keys:s!=null?[s]:null,values:[y]})}).then(function(b){return b.numFailures?G.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{ne(a,p,b)}catch{}return b})},Oe.prototype.update=function(a,s){return typeof a!="object"||l(a)?this.where(":id").equals(a).modify(s):(a=ee(a,this.schema.primKey.keyPath),a===void 0?qe(new $.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(s))},Oe.prototype.put=function(a,s){var u=this,f=this.schema.primKey,h=f.auto,p=f.keyPath,y=a;return p&&h&&(y=da(p)(a)),this._trans("readwrite",function(b){return u.core.mutate({trans:b,type:"put",values:[y],keys:s!=null?[s]:null})}).then(function(b){return b.numFailures?G.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{ne(a,p,b)}catch{}return b})},Oe.prototype.delete=function(a){var s=this;return this._trans("readwrite",function(u){return s.core.mutate({trans:u,type:"delete",keys:[a]})}).then(function(u){return u.numFailures?G.reject(u.failures[0]):void 0})},Oe.prototype.clear=function(){var a=this;return this._trans("readwrite",function(s){return a.core.mutate({trans:s,type:"deleteRange",range:Lc})}).then(function(s){return s.numFailures?G.reject(s.failures[0]):void 0})},Oe.prototype.bulkGet=function(a){var s=this;return this._trans("readonly",function(u){return s.core.getMany({keys:a,trans:u}).then(function(f){return f.map(function(h){return s.hook.reading.fire(h)})})})},Oe.prototype.bulkAdd=function(a,s,u){var f=this,h=Array.isArray(s)?s:void 0,p=(u=u||(h?void 0:s))?u.allKeys:void 0;return this._trans("readwrite",function(y){var I=f.schema.primKey,b=I.auto,I=I.keyPath;if(I&&h)throw new $.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new $.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,I=I&&b?a.map(da(I)):a;return f.core.mutate({trans:y,type:"add",keys:h,values:I,wantResults:p}).then(function(O){var w=O.numFailures,L=O.results,k=O.lastResult,O=O.failures;if(w===0)return p?L:k;throw new It("".concat(f.name,".bulkAdd(): ").concat(w," of ").concat(x," operations failed"),O)})})},Oe.prototype.bulkPut=function(a,s,u){var f=this,h=Array.isArray(s)?s:void 0,p=(u=u||(h?void 0:s))?u.allKeys:void 0;return this._trans("readwrite",function(y){var I=f.schema.primKey,b=I.auto,I=I.keyPath;if(I&&h)throw new $.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new $.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,I=I&&b?a.map(da(I)):a;return f.core.mutate({trans:y,type:"put",keys:h,values:I,wantResults:p}).then(function(O){var w=O.numFailures,L=O.results,k=O.lastResult,O=O.failures;if(w===0)return p?L:k;throw new It("".concat(f.name,".bulkPut(): ").concat(w," of ").concat(x," operations failed"),O)})})},Oe.prototype.bulkUpdate=function(a){var s=this,u=this.core,f=a.map(function(y){return y.key}),h=a.map(function(y){return y.changes}),p=[];return this._trans("readwrite",function(y){return u.getMany({trans:y,keys:f,cache:"clone"}).then(function(b){var x=[],I=[];a.forEach(function(w,L){var k=w.key,O=w.changes,R=b[L];if(R){for(var C=0,M=Object.keys(O);C<M.length;C++){var T=M[C],B=O[T];if(T===s.schema.primKey.keyPath){if(we(B,k)!==0)throw new $.Constraint("Cannot update primary key in bulkUpdate()")}else ne(R,T,B)}p.push(L),x.push(k),I.push(R)}});var P=x.length;return u.mutate({trans:y,type:"put",keys:x,values:I,updates:{keys:f,changeSpecs:h}}).then(function(w){var L=w.numFailures,k=w.failures;if(L===0)return P;for(var O=0,R=Object.keys(k);O<R.length;O++){var C,M=R[O],T=p[Number(M)];T!=null&&(C=k[M],delete k[M],k[T]=C)}throw new It("".concat(s.name,".bulkUpdate(): ").concat(L," of ").concat(P," operations failed"),k)})})})},Oe.prototype.bulkDelete=function(a){var s=this,u=a.length;return this._trans("readwrite",function(f){return s.core.mutate({trans:f,type:"delete",keys:a})}).then(function(y){var h=y.numFailures,p=y.lastResult,y=y.failures;if(h===0)return p;throw new It("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(u," operations failed"),y)})},Oe);function Oe(){}function ri(a){function s(y,b){if(b){for(var x=arguments.length,I=new Array(x-1);--x;)I[x-1]=arguments[x];return u[y].subscribe.apply(null,I),a}if(typeof y=="string")return u[y]}var u={};s.addEventType=p;for(var f=1,h=arguments.length;f<h;++f)p(arguments[f]);return s;function p(y,b,x){if(typeof y!="object"){var I;b=b||jt;var P={subscribers:[],fire:x=x||U,subscribe:function(w){P.subscribers.indexOf(w)===-1&&(P.subscribers.push(w),P.fire=b(P.fire,w))},unsubscribe:function(w){P.subscribers=P.subscribers.filter(function(L){return L!==w}),P.fire=P.subscribers.reduce(b,x)}};return u[y]=s[y]=P}c(I=y).forEach(function(w){var L=I[w];if(l(L))p(w,I[w][0],I[w][1]);else{if(L!=="asap")throw new $.InvalidArgument("Invalid event config");var k=p(w,ye,function(){for(var O=arguments.length,R=new Array(O);O--;)R[O]=arguments[O];k.subscribers.forEach(function(C){ae(function(){C.apply(null,R)})})})}})}}function ni(a,s){return D(s).from({prototype:a}),s}function kn(a,s){return!(a.filter||a.algorithm||a.or)&&(s?a.justLimit:!a.replayFilter)}function Do(a,s){a.filter=Zr(a.filter,s)}function Oo(a,s,u){var f=a.replayFilter;a.replayFilter=f?function(){return Zr(f(),s())}:s,a.justLimit=u&&!f}function ha(a,s){if(a.isPrimKey)return s.primaryKey;var u=s.getIndexByKeyPath(a.index);if(!u)throw new $.Schema("KeyPath "+a.index+" on object store "+s.name+" is not indexed");return u}function Bc(a,s,u){var f=ha(a,s.schema);return s.openCursor({trans:u,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:f,range:a.range}})}function ma(a,s,u,f){var h=a.replayFilter?Zr(a.filter,a.replayFilter()):a.filter;if(a.or){var p={},y=function(b,x,I){var P,w;h&&!h(x,I,function(L){return x.stop(L)},function(L){return x.fail(L)})||((w=""+(P=x.primaryKey))=="[object ArrayBuffer]"&&(w=""+new Uint8Array(P)),g(p,w)||(p[w]=!0,s(b,x,I)))};return Promise.all([a.or._iterate(y,u),Nc(Bc(a,f,u),a.algorithm,y,!a.keysOnly&&a.valueMapper)])}return Nc(Bc(a,f,u),Zr(a.algorithm,h),s,!a.keysOnly&&a.valueMapper)}function Nc(a,s,u,f){var h=$e(f?function(p,y,b){return u(f(p),y,b)}:u);return a.then(function(p){if(p)return p.start(function(){var y=function(){return p.continue()};s&&!s(p,function(b){return y=b},function(b){p.stop(b),y=U},function(b){p.fail(b),y=U})||h(p.value,p,function(b){return y=b}),y()})})}var sr=Symbol(),ii=(jc.prototype.execute=function(a){if(this.add!==void 0){var s=this.add;if(l(s))return i(i([],l(a)?a:[],!0),s).sort();if(typeof s=="number")return(Number(a)||0)+s;if(typeof s=="bigint")try{return BigInt(a)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(this.remove!==void 0){var u=this.remove;if(l(u))return l(a)?a.filter(function(f){return!u.includes(f)}).sort():[];if(typeof u=="number")return Number(a)-u;if(typeof u=="bigint")try{return BigInt(a)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return s=(s=this.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof a=="string"&&a.startsWith(s)?this.replacePrefix[1]+a.substring(s.length):a},jc);function jc(a){Object.assign(this,a)}var nh=(Ee.prototype._read=function(a,s){var u=this._ctx;return u.error?u.table._trans(null,qe.bind(null,u.error)):u.table._trans("readonly",a).then(s)},Ee.prototype._write=function(a){var s=this._ctx;return s.error?s.table._trans(null,qe.bind(null,s.error)):s.table._trans("readwrite",a,"locked")},Ee.prototype._addAlgorithm=function(a){var s=this._ctx;s.algorithm=Zr(s.algorithm,a)},Ee.prototype._iterate=function(a,s){return ma(this._ctx,a,s,this._ctx.table.core)},Ee.prototype.clone=function(a){var s=Object.create(this.constructor.prototype),u=Object.create(this._ctx);return a&&d(u,a),s._ctx=u,s},Ee.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ee.prototype.each=function(a){var s=this._ctx;return this._read(function(u){return ma(s,a,u,s.table.core)})},Ee.prototype.count=function(a){var s=this;return this._read(function(u){var f=s._ctx,h=f.table.core;if(kn(f,!0))return h.count({trans:u,query:{index:ha(f,h.schema),range:f.range}}).then(function(y){return Math.min(y,f.limit)});var p=0;return ma(f,function(){return++p,!1},u,h).then(function(){return p})}).then(a)},Ee.prototype.sortBy=function(a,s){var u=a.split(".").reverse(),f=u[0],h=u.length-1;function p(x,I){return I?p(x[u[I]],I-1):x[f]}var y=this._ctx.dir==="next"?1:-1;function b(x,I){return we(p(x,h),p(I,h))*y}return this.toArray(function(x){return x.sort(b)}).then(s)},Ee.prototype.toArray=function(a){var s=this;return this._read(function(u){var f=s._ctx;if(f.dir==="next"&&kn(f,!0)&&0<f.limit){var h=f.valueMapper,p=ha(f,f.table.core.schema);return f.table.core.query({trans:u,limit:f.limit,values:!0,query:{index:p,range:f.range}}).then(function(b){return b=b.result,h?b.map(h):b})}var y=[];return ma(f,function(b){return y.push(b)},u,f.table.core).then(function(){return y})},a)},Ee.prototype.offset=function(a){var s=this._ctx;return a<=0||(s.offset+=a,kn(s)?Oo(s,function(){var u=a;return function(f,h){return u===0||(u===1?--u:h(function(){f.advance(u),u=0}),!1)}}):Oo(s,function(){var u=a;return function(){return--u<0}})),this},Ee.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),Oo(this._ctx,function(){var s=a;return function(u,f,h){return--s<=0&&f(h),0<=s}},!0),this},Ee.prototype.until=function(a,s){return Do(this._ctx,function(u,f,h){return!a(u.value)||(f(h),s)}),this},Ee.prototype.first=function(a){return this.limit(1).toArray(function(s){return s[0]}).then(a)},Ee.prototype.last=function(a){return this.reverse().first(a)},Ee.prototype.filter=function(a){var s;return Do(this._ctx,function(u){return a(u.value)}),(s=this._ctx).isMatch=Zr(s.isMatch,a),this},Ee.prototype.and=function(a){return this.filter(a)},Ee.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},Ee.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ee.prototype.desc=function(){return this.reverse()},Ee.prototype.eachKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(u,f){a(f.key,f)})},Ee.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},Ee.prototype.eachPrimaryKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(u,f){a(f.primaryKey,f)})},Ee.prototype.keys=function(a){var s=this._ctx;s.keysOnly=!s.isMatch;var u=[];return this.each(function(f,h){u.push(h.key)}).then(function(){return u}).then(a)},Ee.prototype.primaryKeys=function(a){var s=this._ctx;if(s.dir==="next"&&kn(s,!0)&&0<s.limit)return this._read(function(f){var h=ha(s,s.table.core.schema);return s.table.core.query({trans:f,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(f){return f.result}).then(a);s.keysOnly=!s.isMatch;var u=[];return this.each(function(f,h){u.push(h.primaryKey)}).then(function(){return u}).then(a)},Ee.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},Ee.prototype.firstKey=function(a){return this.limit(1).keys(function(s){return s[0]}).then(a)},Ee.prototype.lastKey=function(a){return this.reverse().firstKey(a)},Ee.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var s={};return Do(this._ctx,function(h){var f=h.primaryKey.toString(),h=g(s,f);return s[f]=!0,!h}),this},Ee.prototype.modify=function(a){var s=this,u=this._ctx;return this._write(function(f){var h,p,y;y=typeof a=="function"?a:(h=c(a),p=h.length,function(C){for(var M=!1,T=0;T<p;++T){var B=h[T],N=a[B],q=ee(C,B);N instanceof ii?(ne(C,B,N.execute(q)),M=!0):q!==N&&(ne(C,B,N),M=!0)}return M});var b=u.table.core,w=b.schema.primaryKey,x=w.outbound,I=w.extractKey,P=200,w=s.db._options.modifyChunkSize;w&&(P=typeof w=="object"?w[b.name]||w["*"]||200:w);function L(C,B){var T=B.failures,B=B.numFailures;O+=C-B;for(var N=0,q=c(T);N<q.length;N++){var z=q[N];k.push(T[z])}}var k=[],O=0,R=[];return s.clone().primaryKeys().then(function(C){function M(B){var N=Math.min(P,C.length-B);return b.getMany({trans:f,keys:C.slice(B,B+N),cache:"immutable"}).then(function(q){for(var z=[],F=[],H=x?[]:null,V=[],W=0;W<N;++W){var J=q[W],le={value:Ie(J),primKey:C[B+W]};y.call(le,le.value,le)!==!1&&(le.value==null?V.push(C[B+W]):x||we(I(J),I(le.value))===0?(F.push(le.value),x&&H.push(C[B+W])):(V.push(C[B+W]),z.push(le.value)))}return Promise.resolve(0<z.length&&b.mutate({trans:f,type:"add",values:z}).then(function(ve){for(var ge in ve.failures)V.splice(parseInt(ge),1);L(z.length,ve)})).then(function(){return(0<F.length||T&&typeof a=="object")&&b.mutate({trans:f,type:"put",keys:H,values:F,criteria:T,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<B}).then(function(ve){return L(F.length,ve)})}).then(function(){return(0<V.length||T&&a===Po)&&b.mutate({trans:f,type:"delete",keys:V,criteria:T,isAdditionalChunk:0<B}).then(function(ve){return L(V.length,ve)})}).then(function(){return C.length>B+N&&M(B+P)})})}var T=kn(u)&&u.limit===1/0&&(typeof a!="function"||a===Po)&&{index:u.index,range:u.range};return M(0).then(function(){if(0<k.length)throw new mt("Error modifying one or more objects",k,O,R);return C.length})})})},Ee.prototype.delete=function(){var a=this._ctx,s=a.range;return kn(a)&&(a.isPrimKey||s.type===3)?this._write(function(u){var f=a.table.core.schema.primaryKey,h=s;return a.table.core.count({trans:u,query:{index:f,range:h}}).then(function(p){return a.table.core.mutate({trans:u,type:"deleteRange",range:h}).then(function(y){var b=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new mt("Could not delete some values",Object.keys(b).map(function(x){return b[x]}),p-y);return p-y})})}):this.modify(Po)},Ee);function Ee(){}var Po=function(a,s){return s.value=null};function ih(a,s){return a<s?-1:a===s?0:1}function ah(a,s){return s<a?-1:a===s?0:1}function gt(a,s,u){return a=a instanceof Fc?new a.Collection(a):a,a._ctx.error=new(u||TypeError)(s),a}function In(a){return new a.Collection(a,function(){return qc("")}).limit(0)}function pa(a,s,u,f){var h,p,y,b,x,I,P,w=u.length;if(!u.every(function(O){return typeof O=="string"}))return gt(a,Rc);function L(O){h=O==="next"?function(C){return C.toUpperCase()}:function(C){return C.toLowerCase()},p=O==="next"?function(C){return C.toLowerCase()}:function(C){return C.toUpperCase()},y=O==="next"?ih:ah;var R=u.map(function(C){return{lower:p(C),upper:h(C)}}).sort(function(C,M){return y(C.lower,M.lower)});b=R.map(function(C){return C.upper}),x=R.map(function(C){return C.lower}),P=(I=O)==="next"?"":f}L("next"),a=new a.Collection(a,function(){return Dr(b[0],x[w-1]+f)}),a._ondirectionchange=function(O){L(O)};var k=0;return a._addAlgorithm(function(O,R,C){var M=O.key;if(typeof M!="string")return!1;var T=p(M);if(s(T,x,k))return!0;for(var B=null,N=k;N<w;++N){var q=function(z,F,H,V,W,J){for(var le=Math.min(z.length,V.length),ve=-1,ge=0;ge<le;++ge){var yt=F[ge];if(yt!==V[ge])return W(z[ge],H[ge])<0?z.substr(0,ge)+H[ge]+H.substr(ge+1):W(z[ge],V[ge])<0?z.substr(0,ge)+V[ge]+H.substr(ge+1):0<=ve?z.substr(0,ve)+F[ve]+H.substr(ve+1):null;W(z[ge],yt)<0&&(ve=ge)}return le<V.length&&J==="next"?z+H.substr(z.length):le<z.length&&J==="prev"?z.substr(0,H.length):ve<0?null:z.substr(0,ve)+V[ve]+H.substr(ve+1)}(M,T,b[N],x[N],y,I);q===null&&B===null?k=N+1:(B===null||0<y(B,q))&&(B=q)}return R(B!==null?function(){O.continue(B+P)}:C),!1}),a}function Dr(a,s,u,f){return{type:2,lower:a,upper:s,lowerOpen:u,upperOpen:f}}function qc(a){return{type:1,lower:a,upper:a}}var Fc=(Object.defineProperty(Ye.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ye.prototype.between=function(a,s,u,f){u=u!==!1,f=f===!0;try{return 0<this._cmp(a,s)||this._cmp(a,s)===0&&(u||f)&&(!u||!f)?In(this):new this.Collection(this,function(){return Dr(a,s,!u,!f)})}catch{return gt(this,or)}},Ye.prototype.equals=function(a){return a==null?gt(this,or):new this.Collection(this,function(){return qc(a)})},Ye.prototype.above=function(a){return a==null?gt(this,or):new this.Collection(this,function(){return Dr(a,void 0,!0)})},Ye.prototype.aboveOrEqual=function(a){return a==null?gt(this,or):new this.Collection(this,function(){return Dr(a,void 0,!1)})},Ye.prototype.below=function(a){return a==null?gt(this,or):new this.Collection(this,function(){return Dr(void 0,a,!1,!0)})},Ye.prototype.belowOrEqual=function(a){return a==null?gt(this,or):new this.Collection(this,function(){return Dr(void 0,a)})},Ye.prototype.startsWith=function(a){return typeof a!="string"?gt(this,Rc):this.between(a,a+Xr,!0,!0)},Ye.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):pa(this,function(s,u){return s.indexOf(u[0])===0},[a],Xr)},Ye.prototype.equalsIgnoreCase=function(a){return pa(this,function(s,u){return s===u[0]},[a],"")},Ye.prototype.anyOfIgnoreCase=function(){var a=oe.apply(tt,arguments);return a.length===0?In(this):pa(this,function(s,u){return u.indexOf(s)!==-1},a,"")},Ye.prototype.startsWithAnyOfIgnoreCase=function(){var a=oe.apply(tt,arguments);return a.length===0?In(this):pa(this,function(s,u){return u.some(function(f){return s.indexOf(f)===0})},a,Xr)},Ye.prototype.anyOf=function(){var a=this,s=oe.apply(tt,arguments),u=this._cmp;try{s.sort(u)}catch{return gt(this,or)}if(s.length===0)return In(this);var f=new this.Collection(this,function(){return Dr(s[0],s[s.length-1])});f._ondirectionchange=function(p){u=p==="next"?a._ascending:a._descending,s.sort(u)};var h=0;return f._addAlgorithm(function(p,y,b){for(var x=p.key;0<u(x,s[h]);)if(++h===s.length)return y(b),!1;return u(x,s[h])===0||(y(function(){p.continue(s[h])}),!1)}),f},Ye.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ye.prototype.noneOf=function(){var a=oe.apply(tt,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return gt(this,or)}var s=a.reduce(function(u,f){return u?u.concat([[u[u.length-1][1],f]]):[[-1/0,f]]},null);return s.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},Ye.prototype.inAnyRange=function(M,s){var u=this,f=this._cmp,h=this._ascending,p=this._descending,y=this._min,b=this._max;if(M.length===0)return In(this);if(!M.every(function(T){return T[0]!==void 0&&T[1]!==void 0&&h(T[0],T[1])<=0}))return gt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",$.InvalidArgument);var x=!s||s.includeLowers!==!1,I=s&&s.includeUppers===!0,P,w=h;function L(T,B){return w(T[0],B[0])}try{(P=M.reduce(function(T,B){for(var N=0,q=T.length;N<q;++N){var z=T[N];if(f(B[0],z[1])<0&&0<f(B[1],z[0])){z[0]=y(z[0],B[0]),z[1]=b(z[1],B[1]);break}}return N===q&&T.push(B),T},[])).sort(L)}catch{return gt(this,or)}var k=0,O=I?function(T){return 0<h(T,P[k][1])}:function(T){return 0<=h(T,P[k][1])},R=x?function(T){return 0<p(T,P[k][0])}:function(T){return 0<=p(T,P[k][0])},C=O,M=new this.Collection(this,function(){return Dr(P[0][0],P[P.length-1][1],!x,!I)});return M._ondirectionchange=function(T){w=T==="next"?(C=O,h):(C=R,p),P.sort(L)},M._addAlgorithm(function(T,B,N){for(var q,z=T.key;C(z);)if(++k===P.length)return B(N),!1;return!O(q=z)&&!R(q)||(u._cmp(z,P[k][1])===0||u._cmp(z,P[k][0])===0||B(function(){w===h?T.continue(P[k][0]):T.continue(P[k][1])}),!1)}),M},Ye.prototype.startsWithAnyOf=function(){var a=oe.apply(tt,arguments);return a.every(function(s){return typeof s=="string"})?a.length===0?In(this):this.inAnyRange(a.map(function(s){return[s,s+Xr]})):gt(this,"startsWithAnyOf() only works with strings")},Ye);function Ye(){}function Gt(a){return $e(function(s){return ai(s),a(s.target.error),!1})}function ai(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var oi="storagemutated",Ro="x-storagemutated-1",Or=ri(null,oi),oh=(Yt.prototype._lock=function(){return se(!re.global),++this._reculock,this._reculock!==1||re.global||(re.lockOwnerFor=this),this},Yt.prototype._unlock=function(){if(se(!re.global),--this._reculock==0)for(re.global||(re.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{Jr(a[1],a[0])}catch{}}return this},Yt.prototype._locked=function(){return this._reculock&&re.lockOwnerFor!==this},Yt.prototype.create=function(a){var s=this;if(!this.mode)return this;var u=this.db.idbdb,f=this.db._state.dbOpenError;if(se(!this.idbtrans),!a&&!u)switch(f&&f.name){case"DatabaseClosedError":throw new $.DatabaseClosed(f);case"MissingAPIError":throw new $.MissingAPI(f.message,f);default:throw new $.OpenFailed(f)}if(!this.active)throw new $.TransactionInactive;return se(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||u).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=$e(function(h){ai(h),s._reject(a.error)}),a.onabort=$e(function(h){ai(h),s.active&&s._reject(new $.Abort(a.error)),s.active=!1,s.on("abort").fire(h)}),a.oncomplete=$e(function(){s.active=!1,s._resolve(),"mutatedParts"in a&&Or.storagemutated.fire(a.mutatedParts)}),this},Yt.prototype._promise=function(a,s,u){var f=this;if(a==="readwrite"&&this.mode!=="readwrite")return qe(new $.ReadOnly("Transaction is readonly"));if(!this.active)return qe(new $.TransactionInactive);if(this._locked())return new G(function(p,y){f._blockedFuncs.push([function(){f._promise(a,s,u).then(p,y)},re])});if(u)return kr(function(){var p=new G(function(y,b){f._lock();var x=s(y,b,f);x&&x.then&&x.then(y,b)});return p.finally(function(){return f._unlock()}),p._lib=!0,p});var h=new G(function(p,y){var b=s(p,y,f);b&&b.then&&b.then(p,y)});return h._lib=!0,h},Yt.prototype._root=function(){return this.parent?this.parent._root():this},Yt.prototype.waitFor=function(a){var s,u=this._root(),f=G.resolve(a);u._waitingFor?u._waitingFor=u._waitingFor.then(function(){return f}):(u._waitingFor=f,u._waitingQueue=[],s=u.idbtrans.objectStore(u.storeNames[0]),function p(){for(++u._spinCount;u._waitingQueue.length;)u._waitingQueue.shift()();u._waitingFor&&(s.get(-1/0).onsuccess=p)}());var h=u._waitingFor;return new G(function(p,y){f.then(function(b){return u._waitingQueue.push($e(p.bind(null,b)))},function(b){return u._waitingQueue.push($e(y.bind(null,b)))}).finally(function(){u._waitingFor===h&&(u._waitingFor=null)})})},Yt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new $.Abort))},Yt.prototype.table=function(a){var s=this._memoizedTables||(this._memoizedTables={});if(g(s,a))return s[a];var u=this.schema[a];if(!u)throw new $.NotFound("Table "+a+" not part of transaction");return u=new this.db.Table(a,u,this),u.core=this.db.core.table(a),s[a]=u},Yt);function Yt(){}function Lo(a,s,u,f,h,p,y){return{name:a,keyPath:s,unique:u,multi:f,auto:h,compound:p,src:(u&&!y?"&":"")+(f?"*":"")+(h?"++":"")+Kc(s)}}function Kc(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function $o(a,s,u){return{name:a,primKey:s,indexes:u,mappedClass:null,idxByName:(f=function(h){return[h.name,h]},u.reduce(function(h,p,y){return y=f(p,y),y&&(h[y[0]]=y[1]),h},{}))};var f}var si=function(a){try{return a.only([[]]),si=function(){return[[]]},[[]]}catch{return si=function(){return Xr},Xr}};function Mo(a){return a==null?function(){}:typeof a=="string"?(s=a).split(".").length===1?function(u){return u[s]}:function(u){return ee(u,s)}:function(u){return ee(u,a)};var s}function Hc(a){return[].slice.call(a)}var sh=0;function ci(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function ch(a,s,x){function f(C){if(C.type===3)return null;if(C.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var k=C.lower,O=C.upper,R=C.lowerOpen,C=C.upperOpen;return k===void 0?O===void 0?null:s.upperBound(O,!!C):O===void 0?s.lowerBound(k,!!R):s.bound(k,O,!!R,!!C)}function h(L){var k,O=L.name;return{name:O,schema:L,mutate:function(R){var C=R.trans,M=R.type,T=R.keys,B=R.values,N=R.range;return new Promise(function(q,z){q=$e(q);var F=C.objectStore(O),H=F.keyPath==null,V=M==="put"||M==="add";if(!V&&M!=="delete"&&M!=="deleteRange")throw new Error("Invalid operation type: "+M);var W,J=(T||B||{length:1}).length;if(T&&B&&T.length!==B.length)throw new Error("Given keys array must have same length as given values array.");if(J===0)return q({numFailures:0,failures:{},results:[],lastResult:void 0});function le(lt){++yt,ai(lt)}var ve=[],ge=[],yt=0;if(M==="deleteRange"){if(N.type===4)return q({numFailures:yt,failures:ge,results:[],lastResult:void 0});N.type===3?ve.push(W=F.clear()):ve.push(W=F.delete(f(N)))}else{var H=V?H?[B,T]:[B,null]:[T,null],ce=H[0],ot=H[1];if(V)for(var st=0;st<J;++st)ve.push(W=ot&&ot[st]!==void 0?F[M](ce[st],ot[st]):F[M](ce[st])),W.onerror=le;else for(st=0;st<J;++st)ve.push(W=F[M](ce[st])),W.onerror=le}function Da(lt){lt=lt.target.result,ve.forEach(function(rn,Xo){return rn.error!=null&&(ge[Xo]=rn.error)}),q({numFailures:yt,failures:ge,results:M==="delete"?T:ve.map(function(rn){return rn.result}),lastResult:lt})}W.onerror=function(lt){le(lt),Da(lt)},W.onsuccess=Da})},getMany:function(R){var C=R.trans,M=R.keys;return new Promise(function(T,B){T=$e(T);for(var N,q=C.objectStore(O),z=M.length,F=new Array(z),H=0,V=0,W=function(ve){ve=ve.target,F[ve._pos]=ve.result,++V===H&&T(F)},J=Gt(B),le=0;le<z;++le)M[le]!=null&&((N=q.get(M[le]))._pos=le,N.onsuccess=W,N.onerror=J,++H);H===0&&T(F)})},get:function(R){var C=R.trans,M=R.key;return new Promise(function(T,B){T=$e(T);var N=C.objectStore(O).get(M);N.onsuccess=function(q){return T(q.target.result)},N.onerror=Gt(B)})},query:(k=I,function(R){return new Promise(function(C,M){C=$e(C);var T,B,N,H=R.trans,q=R.values,z=R.limit,W=R.query,F=z===1/0?void 0:z,V=W.index,W=W.range,H=H.objectStore(O),V=V.isPrimaryKey?H:H.index(V.name),W=f(W);if(z===0)return C({result:[]});k?((F=q?V.getAll(W,F):V.getAllKeys(W,F)).onsuccess=function(J){return C({result:J.target.result})},F.onerror=Gt(M)):(T=0,B=!q&&"openKeyCursor"in V?V.openKeyCursor(W):V.openCursor(W),N=[],B.onsuccess=function(J){var le=B.result;return le?(N.push(q?le.value:le.primaryKey),++T===z?C({result:N}):void le.continue()):C({result:N})},B.onerror=Gt(M))})}),openCursor:function(R){var C=R.trans,M=R.values,T=R.query,B=R.reverse,N=R.unique;return new Promise(function(q,z){q=$e(q);var V=T.index,F=T.range,H=C.objectStore(O),H=V.isPrimaryKey?H:H.index(V.name),V=B?N?"prevunique":"prev":N?"nextunique":"next",W=!M&&"openKeyCursor"in H?H.openKeyCursor(f(F),V):H.openCursor(f(F),V);W.onerror=Gt(z),W.onsuccess=$e(function(J){var le,ve,ge,yt,ce=W.result;ce?(ce.___id=++sh,ce.done=!1,le=ce.continue.bind(ce),ve=(ve=ce.continuePrimaryKey)&&ve.bind(ce),ge=ce.advance.bind(ce),yt=function(){throw new Error("Cursor not stopped")},ce.trans=C,ce.stop=ce.continue=ce.continuePrimaryKey=ce.advance=function(){throw new Error("Cursor not started")},ce.fail=$e(z),ce.next=function(){var ot=this,st=1;return this.start(function(){return st--?ot.continue():ot.stop()}).then(function(){return ot})},ce.start=function(ot){function st(){if(W.result)try{ot()}catch(lt){ce.fail(lt)}else ce.done=!0,ce.start=function(){throw new Error("Cursor behind last entry")},ce.stop()}var Da=new Promise(function(lt,rn){lt=$e(lt),W.onerror=Gt(rn),ce.fail=rn,ce.stop=function(Xo){ce.stop=ce.continue=ce.continuePrimaryKey=ce.advance=yt,lt(Xo)}});return W.onsuccess=$e(function(lt){W.onsuccess=st,st()}),ce.continue=le,ce.continuePrimaryKey=ve,ce.advance=ge,st(),Da},q(ce)):q(null)},z)})},count:function(R){var C=R.query,M=R.trans,T=C.index,B=C.range;return new Promise(function(N,q){var z=M.objectStore(O),F=T.isPrimaryKey?z:z.index(T.name),z=f(B),F=z?F.count(z):F.count();F.onsuccess=$e(function(H){return N(H.target.result)}),F.onerror=Gt(q)})}}}var p,y,b,P=(y=x,b=Hc((p=a).objectStoreNames),{schema:{name:p.name,tables:b.map(function(L){return y.objectStore(L)}).map(function(L){var k=L.keyPath,C=L.autoIncrement,O=l(k),R={},C={name:L.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:k==null,compound:O,keyPath:k,autoIncrement:C,unique:!0,extractKey:Mo(k)},indexes:Hc(L.indexNames).map(function(M){return L.index(M)}).map(function(N){var T=N.name,B=N.unique,q=N.multiEntry,N=N.keyPath,q={name:T,compound:l(N),keyPath:N,unique:B,multiEntry:q,extractKey:Mo(N)};return R[ci(N)]=q}),getIndexByKeyPath:function(M){return R[ci(M)]}};return R[":id"]=C.primaryKey,k!=null&&(R[ci(k)]=C.primaryKey),C})},hasGetAll:0<b.length&&"getAll"in y.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),x=P.schema,I=P.hasGetAll,P=x.tables.map(h),w={};return P.forEach(function(L){return w[L.name]=L}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(L){if(!w[L])throw new Error("Table '".concat(L,"' not found"));return w[L]},MIN_KEY:-1/0,MAX_KEY:si(s),schema:x}}function uh(a,s,u,f){var h=u.IDBKeyRange;return u.indexedDB,{dbcore:(f=ch(s,h,f),a.dbcore.reduce(function(p,y){return y=y.create,n(n({},p),y(p))},f))}}function va(a,f){var u=f.db,f=uh(a._middlewares,u,a._deps,f);a.core=f.dbcore,a.tables.forEach(function(h){var p=h.name;a.core.schema.tables.some(function(y){return y.name===p})&&(h.core=a.core.table(p),a[p]instanceof a.Table&&(a[p].core=h.core))})}function ga(a,s,u,f){u.forEach(function(h){var p=f[h];s.forEach(function(y){var b=function x(I,P){return A(I,P)||(I=v(I))&&x(I,P)}(y,h);(!b||"value"in b&&b.value===void 0)&&(y===a.Transaction.prototype||y instanceof a.Transaction?_(y,h,{get:function(){return this.table(h)},set:function(x){E(this,h,{value:x,writable:!0,configurable:!0,enumerable:!0})}}):y[h]=new a.Table(h,p))})})}function To(a,s){s.forEach(function(u){for(var f in u)u[f]instanceof a.Table&&delete u[f]})}function lh(a,s){return a._cfg.version-s._cfg.version}function fh(a,s,u,f){var h=a._dbSchema;u.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=$o("$meta",Wc("")[0],[]),a._storeNames.push("$meta"));var p=a._createTransaction("readwrite",a._storeNames,h);p.create(u),p._completion.catch(f);var y=p._reject.bind(p),b=re.transless||re;kr(function(){return re.trans=p,re.transless=b,s!==0?(va(a,u),I=s,((x=p).storeNames.includes("$meta")?x.table("$meta").get("version").then(function(P){return P??I}):G.resolve(I)).then(function(P){return L=P,k=p,O=u,R=[],P=(w=a)._versions,C=w._dbSchema=ba(0,w.idbdb,O),(P=P.filter(function(M){return M._cfg.version>=L})).length!==0?(P.forEach(function(M){R.push(function(){var T=C,B=M._cfg.dbschema;wa(w,T,O),wa(w,B,O),C=w._dbSchema=B;var N=Ao(T,B);N.add.forEach(function(V){Bo(O,V[0],V[1].primKey,V[1].indexes)}),N.change.forEach(function(V){if(V.recreate)throw new $.Upgrade("Not yet support for changing primary key");var W=O.objectStore(V.name);V.add.forEach(function(J){return ya(W,J)}),V.change.forEach(function(J){W.deleteIndex(J.name),ya(W,J)}),V.del.forEach(function(J){return W.deleteIndex(J)})});var q=M._cfg.contentUpgrade;if(q&&M._cfg.version>L){va(w,O),k._memoizedTables={};var z=me(B);N.del.forEach(function(V){z[V]=T[V]}),To(w,[w.Transaction.prototype]),ga(w,[w.Transaction.prototype],c(z),z),k.schema=z;var F,H=Se(q);return H&&Sn(),N=G.follow(function(){var V;(F=q(k))&&H&&(V=Ir.bind(null,null),F.then(V,V))}),F&&typeof F.then=="function"?G.resolve(F):N.then(function(){return F})}}),R.push(function(T){var B,N,q=M._cfg.dbschema;B=q,N=T,[].slice.call(N.db.objectStoreNames).forEach(function(z){return B[z]==null&&N.db.deleteObjectStore(z)}),To(w,[w.Transaction.prototype]),ga(w,[w.Transaction.prototype],w._storeNames,w._dbSchema),k.schema=w._dbSchema}),R.push(function(T){w.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(w.idbdb.version/10)===M._cfg.version?(w.idbdb.deleteObjectStore("$meta"),delete w._dbSchema.$meta,w._storeNames=w._storeNames.filter(function(B){return B!=="$meta"})):T.objectStore("$meta").put(M._cfg.version,"version"))})}),function M(){return R.length?G.resolve(R.shift()(k.idbtrans)).then(M):G.resolve()}().then(function(){Uc(C,O)})):G.resolve();var w,L,k,O,R,C}).catch(y)):(c(h).forEach(function(P){Bo(u,P,h[P].primKey,h[P].indexes)}),va(a,u),void G.follow(function(){return a.on.populate.fire(p)}).catch(y));var x,I})}function dh(a,s){Uc(a._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var u=ba(0,a.idbdb,s);wa(a,a._dbSchema,s);for(var f=0,h=Ao(u,a._dbSchema).change;f<h.length;f++){var p=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var b=s.objectStore(y.name);y.add.forEach(function(x){Ae&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(x.src)),ya(b,x)})}(h[f]);if(typeof p=="object")return p.value}}function Ao(a,s){var u,f={del:[],add:[],change:[]};for(u in a)s[u]||f.del.push(u);for(u in s){var h=a[u],p=s[u];if(h){var y={name:u,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||h.primKey.auto!==p.primKey.auto)y.recreate=!0,f.change.push(y);else{var b=h.idxByName,x=p.idxByName,I=void 0;for(I in b)x[I]||y.del.push(I);for(I in x){var P=b[I],w=x[I];P?P.src!==w.src&&y.change.push(w):y.add.push(w)}(0<y.del.length||0<y.add.length||0<y.change.length)&&f.change.push(y)}}else f.add.push([u,p])}return f}function Bo(a,s,u,f){var h=a.db.createObjectStore(s,u.keyPath?{keyPath:u.keyPath,autoIncrement:u.auto}:{autoIncrement:u.auto});return f.forEach(function(p){return ya(h,p)}),h}function Uc(a,s){c(a).forEach(function(u){s.db.objectStoreNames.contains(u)||(Ae&&console.debug("Dexie: Creating missing table",u),Bo(s,u,a[u].primKey,a[u].indexes))})}function ya(a,s){a.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function ba(a,s,u){var f={};return K(s.objectStoreNames,0).forEach(function(h){for(var p=u.objectStore(h),y=Lo(Kc(I=p.keyPath),I||"",!0,!1,!!p.autoIncrement,I&&typeof I!="string",!0),b=[],x=0;x<p.indexNames.length;++x){var P=p.index(p.indexNames[x]),I=P.keyPath,P=Lo(P.name,I,!!P.unique,!!P.multiEntry,!1,I&&typeof I!="string",!1);b.push(P)}f[h]=$o(h,y,b)}),f}function wa(a,s,u){for(var f=u.db.objectStoreNames,h=0;h<f.length;++h){var p=f[h],y=u.objectStore(p);a._hasGetAll="getAll"in y;for(var b=0;b<y.indexNames.length;++b){var x=y.indexNames[b],I=y.index(x).keyPath,P=typeof I=="string"?I:"["+K(I).join("+")+"]";!s[p]||(I=s[p].idxByName[P])&&(I.name=x,delete s[p].idxByName[P],s[p].idxByName[x]=I)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function Wc(a){return a.split(",").map(function(s,u){var f=(s=s.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return Lo(f,h||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),l(h),u===0)})}var hh=(_a.prototype._parseStoresSpec=function(a,s){c(a).forEach(function(u){if(a[u]!==null){var f=Wc(a[u]),h=f.shift();if(h.unique=!0,h.multi)throw new $.Schema("Primary key cannot be multi-valued");f.forEach(function(p){if(p.auto)throw new $.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new $.Schema("Index must have a name and cannot be an empty string")}),s[u]=$o(u,h,f)}})},_a.prototype.stores=function(u){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?d(this._cfg.storesSource,u):u;var u=s._versions,f={},h={};return u.forEach(function(p){d(f,p._cfg.storesSource),h=p._cfg.dbschema={},p._parseStoresSpec(f,h)}),s._dbSchema=h,To(s,[s._allTables,s,s.Transaction.prototype]),ga(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],c(h),h),s._storeNames=c(h),this},_a.prototype.upgrade=function(a){return this._cfg.contentUpgrade=Qt(this._cfg.contentUpgrade||U,a),this},_a);function _a(){}function No(a,s){var u=a._dbNamesDB;return u||(u=a._dbNamesDB=new cr(fa,{addons:[],indexedDB:a,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),u.table("dbnames")}function jo(a){return a&&typeof a.databases=="function"}function qo(a){return kr(function(){return re.letThrough=!0,a()})}function Fo(a){return!("from"in a)}var at=function(a,s){if(!this){var u=new at;return a&&"d"in a&&d(u,a),u}d(this,arguments.length?{d:1,from:a,to:1<arguments.length?s:a}:{d:0})};function ui(a,s,u){var f=we(s,u);if(!isNaN(f)){if(0<f)throw RangeError();if(Fo(a))return d(a,{from:s,to:u,d:1});var h=a.l,f=a.r;if(we(u,a.from)<0)return h?ui(h,s,u):a.l={from:s,to:u,d:1,l:null,r:null},Vc(a);if(0<we(s,a.to))return f?ui(f,s,u):a.r={from:s,to:u,d:1,l:null,r:null},Vc(a);we(s,a.from)<0&&(a.from=s,a.l=null,a.d=f?f.d+1:1),0<we(u,a.to)&&(a.to=u,a.r=null,a.d=a.l?a.l.d+1:1),u=!a.r,h&&!a.l&&li(a,h),f&&u&&li(a,f)}}function li(a,s){Fo(s)||function u(f,x){var p=x.from,y=x.to,b=x.l,x=x.r;ui(f,p,y),b&&u(f,b),x&&u(f,x)}(a,s)}function zc(a,s){var u=Ea(s),f=u.next();if(f.done)return!1;for(var h=f.value,p=Ea(a),y=p.next(h.from),b=y.value;!f.done&&!y.done;){if(we(b.from,h.to)<=0&&0<=we(b.to,h.from))return!0;we(h.from,b.from)<0?h=(f=u.next(b.from)).value:b=(y=p.next(h.from)).value}return!1}function Ea(a){var s=Fo(a)?null:{s:0,n:a};return{next:function(u){for(var f=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,f)for(;s.n.l&&we(u,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!f||we(u,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function Vc(a){var s,u,f=(((s=a.r)===null||s===void 0?void 0:s.d)||0)-(((u=a.l)===null||u===void 0?void 0:u.d)||0),h=1<f?"r":f<-1?"l":"";h&&(s=h=="r"?"l":"r",u=n({},a),f=a[h],a.from=f.from,a.to=f.to,a[h]=f[h],u[h]=f[s],(a[s]=u).d=Qc(u)),a.d=Qc(a)}function Qc(u){var s=u.r,u=u.l;return(s?u?Math.max(s.d,u.d):s.d:u?u.d:0)+1}function Sa(a,s){return c(s).forEach(function(u){a[u]?li(a[u],s[u]):a[u]=function f(h){var p,y,b={};for(p in h)g(h,p)&&(y=h[p],b[p]=!y||typeof y!="object"||Pe.has(y.constructor)?y:f(y));return b}(s[u])}),a}function Ko(a,s){return a.all||s.all||Object.keys(a).some(function(u){return s[u]&&zc(s[u],a[u])})}S(at.prototype,((Dt={add:function(a){return li(this,a),this},addKey:function(a){return ui(this,a,a),this},addKeys:function(a){var s=this;return a.forEach(function(u){return ui(s,u,u)}),this},hasKey:function(a){var s=Ea(this).next(a).value;return s&&we(s.from,a)<=0&&0<=we(s.to,a)}})[et]=function(){return Ea(this)},Dt));var en={},Ho={},Uo=!1;function xa(a){Sa(Ho,a),Uo||(Uo=!0,setTimeout(function(){Uo=!1,Wo(Ho,!(Ho={}))},0))}function Wo(a,s){s===void 0&&(s=!1);var u=new Set;if(a.all)for(var f=0,h=Object.values(en);f<h.length;f++)Gc(y=h[f],a,u,s);else for(var p in a){var y,b=/^idb\:\/\/(.*)\/(.*)\//.exec(p);b&&(p=b[1],b=b[2],(y=en["idb://".concat(p,"/").concat(b)])&&Gc(y,a,u,s))}u.forEach(function(x){return x()})}function Gc(a,s,u,f){for(var h=[],p=0,y=Object.entries(a.queries.query);p<y.length;p++){for(var b=y[p],x=b[0],I=[],P=0,w=b[1];P<w.length;P++){var L=w[P];Ko(s,L.obsSet)?L.subscribers.forEach(function(C){return u.add(C)}):f&&I.push(L)}f&&h.push([x,I])}if(f)for(var k=0,O=h;k<O.length;k++){var R=O[k],x=R[0],I=R[1];a.queries.query[x]=I}}function mh(a){var s=a._state,u=a._deps.indexedDB;if(s.isBeingOpened||a.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?qe(s.dbOpenError):a});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var f=s.openCanceller,h=Math.round(10*a.verno),p=!1;function y(){if(s.openCanceller!==f)throw new $.DatabaseClosed("db.open() was cancelled")}function b(){return new G(function(L,k){if(y(),!u)throw new $.MissingAPI;var O=a.name,R=s.autoSchema||!h?u.open(O):u.open(O,h);if(!R)throw new $.MissingAPI;R.onerror=Gt(k),R.onblocked=$e(a._fireOnBlocked),R.onupgradeneeded=$e(function(C){var M;P=R.transaction,s.autoSchema&&!a._options.allowEmptyDB?(R.onerror=ai,P.abort(),R.result.close(),(M=u.deleteDatabase(O)).onsuccess=M.onerror=$e(function(){k(new $.NoSuchDatabase("Database ".concat(O," doesnt exist")))})):(P.onerror=Gt(k),C=C.oldVersion>Math.pow(2,62)?0:C.oldVersion,w=C<1,a.idbdb=R.result,p&&dh(a,P),fh(a,C/10,P,k))},k),R.onsuccess=$e(function(){P=null;var C,M,T,B,N,q=a.idbdb=R.result,z=K(q.objectStoreNames);if(0<z.length)try{var F=q.transaction((B=z).length===1?B[0]:B,"readonly");if(s.autoSchema)M=q,T=F,(C=a).verno=M.version/10,T=C._dbSchema=ba(0,M,T),C._storeNames=K(M.objectStoreNames,0),ga(C,[C._allTables],c(T),T);else if(wa(a,a._dbSchema,F),((N=Ao(ba(0,(N=a).idbdb,F),N._dbSchema)).add.length||N.change.some(function(H){return H.add.length||H.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),q.close(),h=q.version+1,p=!0,L(b());va(a,F)}catch{}xn.push(a),q.onversionchange=$e(function(H){s.vcFired=!0,a.on("versionchange").fire(H)}),q.onclose=$e(function(H){a.on("close").fire(H)}),w&&(N=a._deps,F=O,q=N.indexedDB,N=N.IDBKeyRange,jo(q)||F===fa||No(q,N).put({name:F}).catch(U)),L()},k)}).catch(function(L){switch(L==null?void 0:L.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),b();break;case"VersionError":if(0<h)return h=0,b()}return G.reject(L)})}var x,I=s.dbReadyResolve,P=null,w=!1;return G.race([f,(typeof navigator>"u"?G.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(L){function k(){return indexedDB.databases().finally(L)}x=setInterval(k,100),k()}).finally(function(){return clearInterval(x)}):Promise.resolve()).then(b)]).then(function(){return y(),s.onReadyBeingFired=[],G.resolve(qo(function(){return a.on.ready.fire(a.vip)})).then(function L(){if(0<s.onReadyBeingFired.length){var k=s.onReadyBeingFired.reduce(Qt,U);return s.onReadyBeingFired=[],G.resolve(qo(function(){return k(a.vip)})).then(L)}})}).finally(function(){s.openCanceller===f&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(L){s.dbOpenError=L;try{P&&P.abort()}catch{}return f===s.openCanceller&&a._close(),qe(L)}).finally(function(){s.openComplete=!0,I()}).then(function(){var L;return w&&(L={},a.tables.forEach(function(k){k.schema.indexes.forEach(function(O){O.name&&(L["idb://".concat(a.name,"/").concat(k.name,"/").concat(O.name)]=new at(-1/0,[[[]]]))}),L["idb://".concat(a.name,"/").concat(k.name,"/")]=L["idb://".concat(a.name,"/").concat(k.name,"/:dels")]=new at(-1/0,[[[]]])}),Or(oi).fire(L),Wo(L,!0)),a})}function zo(a){function s(p){return a.next(p)}var u=h(s),f=h(function(p){return a.throw(p)});function h(p){return function(x){var b=p(x),x=b.value;return b.done?x:x&&typeof x.then=="function"?x.then(u,f):l(x)?Promise.all(x).then(u,f):u(x)}}return h(s)()}function ka(a,s,u){for(var f=l(a)?a.slice():[a],h=0;h<u;++h)f.push(s);return f}var ph={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return n(n({},a),{table:function(s){var u=a.table(s),f=u.schema,h={},p=[];function y(w,L,k){var O=ci(w),R=h[O]=h[O]||[],C=w==null?0:typeof w=="string"?1:w.length,M=0<L,M=n(n({},k),{name:M?"".concat(O,"(virtual-from:").concat(k.name,")"):k.name,lowLevelIndex:k,isVirtual:M,keyTail:L,keyLength:C,extractKey:Mo(w),unique:!M&&k.unique});return R.push(M),M.isPrimaryKey||p.push(M),1<C&&y(C===2?w[0]:w.slice(0,C-1),L+1,k),R.sort(function(T,B){return T.keyTail-B.keyTail}),M}s=y(f.primaryKey.keyPath,0,f.primaryKey),h[":id"]=[s];for(var b=0,x=f.indexes;b<x.length;b++){var I=x[b];y(I.keyPath,0,I)}function P(w){var L,k=w.query.index;return k.isVirtual?n(n({},w),{query:{index:k.lowLevelIndex,range:(L=w.query.range,k=k.keyTail,{type:L.type===1?2:L.type,lower:ka(L.lower,L.lowerOpen?a.MAX_KEY:a.MIN_KEY,k),lowerOpen:!0,upper:ka(L.upper,L.upperOpen?a.MIN_KEY:a.MAX_KEY,k),upperOpen:!0})}}):w}return n(n({},u),{schema:n(n({},f),{primaryKey:s,indexes:p,getIndexByKeyPath:function(w){return(w=h[ci(w)])&&w[0]}}),count:function(w){return u.count(P(w))},query:function(w){return u.query(P(w))},openCursor:function(w){var L=w.query.index,k=L.keyTail,O=L.isVirtual,R=L.keyLength;return O?u.openCursor(P(w)).then(function(M){return M&&C(M)}):u.openCursor(w);function C(M){return Object.create(M,{continue:{value:function(T){T!=null?M.continue(ka(T,w.reverse?a.MAX_KEY:a.MIN_KEY,k)):w.unique?M.continue(M.key.slice(0,R).concat(w.reverse?a.MIN_KEY:a.MAX_KEY,k)):M.continue()}},continuePrimaryKey:{value:function(T,B){M.continuePrimaryKey(ka(T,a.MAX_KEY,k),B)}},primaryKey:{get:function(){return M.primaryKey}},key:{get:function(){var T=M.key;return R===1?T[0]:T.slice(0,R)}},value:{get:function(){return M.value}}})}}})}})}};function Vo(a,s,u,f){return u=u||{},f=f||"",c(a).forEach(function(h){var p,y,b;g(s,h)?(p=a[h],y=s[h],typeof p=="object"&&typeof y=="object"&&p&&y?(b=Le(p))!==Le(y)?u[f+h]=s[h]:b==="Object"?Vo(p,y,u,f+h+"."):p!==y&&(u[f+h]=s[h]):p!==y&&(u[f+h]=s[h])):u[f+h]=void 0}),c(s).forEach(function(h){g(a,h)||(u[f+h]=s[h])}),u}function Qo(a,s){return s.type==="delete"?s.keys:s.keys||s.values.map(a.extractKey)}var vh={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return n(n({},a),{table:function(s){var u=a.table(s),f=u.schema.primaryKey;return n(n({},u),{mutate:function(h){var p=re.trans,y=p.table(s).hook,b=y.deleting,x=y.creating,I=y.updating;switch(h.type){case"add":if(x.fire===U)break;return p._promise("readwrite",function(){return P(h)},!0);case"put":if(x.fire===U&&I.fire===U)break;return p._promise("readwrite",function(){return P(h)},!0);case"delete":if(b.fire===U)break;return p._promise("readwrite",function(){return P(h)},!0);case"deleteRange":if(b.fire===U)break;return p._promise("readwrite",function(){return function w(L,k,O){return u.query({trans:L,values:!1,query:{index:f,range:k},limit:O}).then(function(R){var C=R.result;return P({type:"delete",keys:C,trans:L}).then(function(M){return 0<M.numFailures?Promise.reject(M.failures[0]):C.length<O?{failures:[],numFailures:0,lastResult:void 0}:w(L,n(n({},k),{lower:C[C.length-1],lowerOpen:!0}),O)})})}(h.trans,h.range,1e4)},!0)}return u.mutate(h);function P(w){var L,k,O,R=re.trans,C=w.keys||Qo(f,w);if(!C)throw new Error("Keys missing");return(w=w.type==="add"||w.type==="put"?n(n({},w),{keys:C}):n({},w)).type!=="delete"&&(w.values=i([],w.values)),w.keys&&(w.keys=i([],w.keys)),L=u,O=C,((k=w).type==="add"?Promise.resolve([]):L.getMany({trans:k.trans,keys:O,cache:"immutable"})).then(function(M){var T=C.map(function(B,N){var q,z,F,H=M[N],V={onerror:null,onsuccess:null};return w.type==="delete"?b.fire.call(V,B,H,R):w.type==="add"||H===void 0?(q=x.fire.call(V,B,w.values[N],R),B==null&&q!=null&&(w.keys[N]=B=q,f.outbound||ne(w.values[N],f.keyPath,B))):(q=Vo(H,w.values[N]),(z=I.fire.call(V,q,B,H,R))&&(F=w.values[N],Object.keys(z).forEach(function(W){g(F,W)?F[W]=z[W]:ne(F,W,z[W])}))),V});return u.mutate(w).then(function(B){for(var N=B.failures,q=B.results,z=B.numFailures,B=B.lastResult,F=0;F<C.length;++F){var H=(q||C)[F],V=T[F];H==null?V.onerror&&V.onerror(N[F]):V.onsuccess&&V.onsuccess(w.type==="put"&&M[F]?w.values[F]:H)}return{failures:N,results:q,numFailures:z,lastResult:B}}).catch(function(B){return T.forEach(function(N){return N.onerror&&N.onerror(B)}),Promise.reject(B)})})}}})}})}};function Yc(a,s,u){try{if(!s||s.keys.length<a.length)return null;for(var f=[],h=0,p=0;h<s.keys.length&&p<a.length;++h)we(s.keys[h],a[p])===0&&(f.push(u?Ie(s.values[h]):s.values[h]),++p);return f.length===a.length?f:null}catch{return null}}var gh={stack:"dbcore",level:-1,create:function(a){return{table:function(s){var u=a.table(s);return n(n({},u),{getMany:function(f){if(!f.cache)return u.getMany(f);var h=Yc(f.keys,f.trans._cache,f.cache==="clone");return h?G.resolve(h):u.getMany(f).then(function(p){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?Ie(p):p},p})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),u.mutate(f)}})}}}};function Jc(a,s){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function Xc(a,s){switch(a){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var yh={stack:"dbcore",level:0,name:"Observability",create:function(a){var s=a.schema.name,u=new at(a.MIN_KEY,a.MAX_KEY);return n(n({},a),{transaction:function(f,h,p){if(re.subscr&&h!=="readonly")throw new $.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(re.querier));return a.transaction(f,h,p)},table:function(f){var h=a.table(f),p=h.schema,y=p.primaryKey,w=p.indexes,b=y.extractKey,x=y.outbound,I=y.autoIncrement&&w.filter(function(k){return k.compound&&k.keyPath.includes(y.keyPath)}),P=n(n({},h),{mutate:function(k){function O(W){return W="idb://".concat(s,"/").concat(f,"/").concat(W),B[W]||(B[W]=new at)}var R,C,M,T=k.trans,B=k.mutatedParts||(k.mutatedParts={}),N=O(""),q=O(":dels"),z=k.type,V=k.type==="deleteRange"?[k.range]:k.type==="delete"?[k.keys]:k.values.length<50?[Qo(y,k).filter(function(W){return W}),k.values]:[],F=V[0],H=V[1],V=k.trans._cache;return l(F)?(N.addKeys(F),(V=z==="delete"||F.length===H.length?Yc(F,V):null)||q.addKeys(F),(V||H)&&(R=O,C=V,M=H,p.indexes.forEach(function(W){var J=R(W.name||"");function le(ge){return ge!=null?W.extractKey(ge):null}function ve(ge){return W.multiEntry&&l(ge)?ge.forEach(function(yt){return J.addKey(yt)}):J.addKey(ge)}(C||M).forEach(function(ge,ot){var ce=C&&le(C[ot]),ot=M&&le(M[ot]);we(ce,ot)!==0&&(ce!=null&&ve(ce),ot!=null&&ve(ot))})}))):F?(H={from:(H=F.lower)!==null&&H!==void 0?H:a.MIN_KEY,to:(H=F.upper)!==null&&H!==void 0?H:a.MAX_KEY},q.add(H),N.add(H)):(N.add(u),q.add(u),p.indexes.forEach(function(W){return O(W.name).add(u)})),h.mutate(k).then(function(W){return!F||k.type!=="add"&&k.type!=="put"||(N.addKeys(W.results),I&&I.forEach(function(J){for(var le=k.values.map(function(ce){return J.extractKey(ce)}),ve=J.keyPath.findIndex(function(ce){return ce===y.keyPath}),ge=0,yt=W.results.length;ge<yt;++ge)le[ge][ve]=W.results[ge];O(J.name).addKeys(le)})),T.mutatedParts=Sa(T.mutatedParts||{},B),W})}}),w=function(O){var R=O.query,O=R.index,R=R.range;return[O,new at((O=R.lower)!==null&&O!==void 0?O:a.MIN_KEY,(R=R.upper)!==null&&R!==void 0?R:a.MAX_KEY)]},L={get:function(k){return[y,new at(k.key)]},getMany:function(k){return[y,new at().addKeys(k.keys)]},count:w,query:w,openCursor:w};return c(L).forEach(function(k){P[k]=function(O){var R=re.subscr,C=!!R,M=Jc(re,h)&&Xc(k,O)?O.obsSet={}:R;if(C){var T=function(H){return H="idb://".concat(s,"/").concat(f,"/").concat(H),M[H]||(M[H]=new at)},B=T(""),N=T(":dels"),R=L[k](O),C=R[0],R=R[1];if((k==="query"&&C.isPrimaryKey&&!O.values?N:T(C.name||"")).add(R),!C.isPrimaryKey){if(k!=="count"){var q=k==="query"&&x&&O.values&&h.query(n(n({},O),{values:!1}));return h[k].apply(this,arguments).then(function(H){if(k==="query"){if(x&&O.values)return q.then(function(le){return le=le.result,B.addKeys(le),H});var V=O.values?H.result.map(b):H.result;(O.values?B:N).addKeys(V)}else if(k==="openCursor"){var W=H,J=O.values;return W&&Object.create(W,{key:{get:function(){return N.addKey(W.primaryKey),W.key}},primaryKey:{get:function(){var le=W.primaryKey;return N.addKey(le),le}},value:{get:function(){return J&&B.addKey(W.primaryKey),W.value}}})}return H})}N.add(u)}}return h[k].apply(this,arguments)}}),P}})}};function Zc(a,s,u){if(u.numFailures===0)return s;if(s.type==="deleteRange")return null;var f=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return u.numFailures===f?null:(s=n({},s),l(s.keys)&&(s.keys=s.keys.filter(function(h,p){return!(p in u.failures)})),"values"in s&&l(s.values)&&(s.values=s.values.filter(function(h,p){return!(p in u.failures)})),s)}function Go(a,s){return u=a,((f=s).lower===void 0||(f.lowerOpen?0<we(u,f.lower):0<=we(u,f.lower)))&&(a=a,(s=s).upper===void 0||(s.upperOpen?we(a,s.upper)<0:we(a,s.upper)<=0));var u,f}function eu(a,s,L,f,h,p){if(!L||L.length===0)return a;var y=s.query.index,b=y.multiEntry,x=s.query.range,I=f.schema.primaryKey.extractKey,P=y.extractKey,w=(y.lowLevelIndex||y).extractKey,L=L.reduce(function(k,O){var R=k,C=[];if(O.type==="add"||O.type==="put")for(var M=new at,T=O.values.length-1;0<=T;--T){var B,N=O.values[T],q=I(N);M.hasKey(q)||(B=P(N),(b&&l(B)?B.some(function(W){return Go(W,x)}):Go(B,x))&&(M.addKey(q),C.push(N)))}switch(O.type){case"add":var z=new at().addKeys(s.values?k.map(function(J){return I(J)}):k),R=k.concat(s.values?C.filter(function(J){return J=I(J),!z.hasKey(J)&&(z.addKey(J),!0)}):C.map(function(J){return I(J)}).filter(function(J){return!z.hasKey(J)&&(z.addKey(J),!0)}));break;case"put":var F=new at().addKeys(O.values.map(function(J){return I(J)}));R=k.filter(function(J){return!F.hasKey(s.values?I(J):J)}).concat(s.values?C:C.map(function(J){return I(J)}));break;case"delete":var H=new at().addKeys(O.keys);R=k.filter(function(J){return!H.hasKey(s.values?I(J):J)});break;case"deleteRange":var V=O.range;R=k.filter(function(J){return!Go(I(J),V)})}return R},a);return L===a?a:(L.sort(function(k,O){return we(w(k),w(O))||we(I(k),I(O))}),s.limit&&s.limit<1/0&&(L.length>s.limit?L.length=s.limit:a.length===s.limit&&L.length<s.limit&&(h.dirty=!0)),p?Object.freeze(L):L)}function tu(a,s){return we(a.lower,s.lower)===0&&we(a.upper,s.upper)===0&&!!a.lowerOpen==!!s.lowerOpen&&!!a.upperOpen==!!s.upperOpen}function bh(a,s){return function(u,f,h,p){if(u===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=we(u,f))===0){if(h&&p)return 0;if(h)return 1;if(p)return-1}return f}(a.lower,s.lower,a.lowerOpen,s.lowerOpen)<=0&&0<=function(u,f,h,p){if(u===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=we(u,f))===0){if(h&&p)return 0;if(h)return-1;if(p)return 1}return f}(a.upper,s.upper,a.upperOpen,s.upperOpen)}function wh(a,s,u,f){a.subscribers.add(u),f.addEventListener("abort",function(){var h,p;a.subscribers.delete(u),a.subscribers.size===0&&(h=a,p=s,setTimeout(function(){h.subscribers.size===0&&Te(p,h)},3e3))})}var _h={stack:"dbcore",level:0,name:"Cache",create:function(a){var s=a.schema.name;return n(n({},a),{transaction:function(u,f,h){var p,y,b=a.transaction(u,f,h);return f==="readwrite"&&(y=(p=new AbortController).signal,h=function(x){return function(){if(p.abort(),f==="readwrite"){for(var I=new Set,P=0,w=u;P<w.length;P++){var L=w[P],k=en["idb://".concat(s,"/").concat(L)];if(k){var O=a.table(L),R=k.optimisticOps.filter(function(J){return J.trans===b});if(b._explicit&&x&&b.mutatedParts)for(var C=0,M=Object.values(k.queries.query);C<M.length;C++)for(var T=0,B=(z=M[C]).slice();T<B.length;T++)Ko((F=B[T]).obsSet,b.mutatedParts)&&(Te(z,F),F.subscribers.forEach(function(J){return I.add(J)}));else if(0<R.length){k.optimisticOps=k.optimisticOps.filter(function(J){return J.trans!==b});for(var N=0,q=Object.values(k.queries.query);N<q.length;N++)for(var z,F,H,V=0,W=(z=q[N]).slice();V<W.length;V++)(F=W[V]).res!=null&&b.mutatedParts&&(x&&!F.dirty?(H=Object.isFrozen(F.res),H=eu(F.res,F.req,R,O,F,H),F.dirty?(Te(z,F),F.subscribers.forEach(function(J){return I.add(J)})):H!==F.res&&(F.res=H,F.promise=G.resolve({result:H}))):(F.dirty&&Te(z,F),F.subscribers.forEach(function(J){return I.add(J)})))}}}I.forEach(function(J){return J()})}}},b.addEventListener("abort",h(!1),{signal:y}),b.addEventListener("error",h(!1),{signal:y}),b.addEventListener("complete",h(!0),{signal:y})),b},table:function(u){var f=a.table(u),h=f.schema.primaryKey;return n(n({},f),{mutate:function(p){var y=re.trans;if(h.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return f.mutate(p);var b=en["idb://".concat(s,"/").concat(u)];return b?(y=f.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||Qo(h,p).some(function(x){return x==null}))?(b.optimisticOps.push(p),p.mutatedParts&&xa(p.mutatedParts),y.then(function(x){0<x.numFailures&&(Te(b.optimisticOps,p),(x=Zc(0,p,x))&&b.optimisticOps.push(x),p.mutatedParts&&xa(p.mutatedParts))}),y.catch(function(){Te(b.optimisticOps,p),p.mutatedParts&&xa(p.mutatedParts)})):y.then(function(x){var I=Zc(0,n(n({},p),{values:p.values.map(function(P,w){var L;return x.failures[w]?P:(P=(L=h.keyPath)!==null&&L!==void 0&&L.includes(".")?Ie(P):n({},P),ne(P,h.keyPath,x.results[w]),P)})}),x);b.optimisticOps.push(I),queueMicrotask(function(){return p.mutatedParts&&xa(p.mutatedParts)})}),y):f.mutate(p)},query:function(p){if(!Jc(re,f)||!Xc("query",p))return f.query(p);var y=((I=re.trans)===null||I===void 0?void 0:I.db._options.cache)==="immutable",w=re,b=w.requery,x=w.signal,I=function(O,R,C,M){var T=en["idb://".concat(O,"/").concat(R)];if(!T)return[];if(!(R=T.queries[C]))return[null,!1,T,null];var B=R[(M.query?M.query.index.name:null)||""];if(!B)return[null,!1,T,null];switch(C){case"query":var N=B.find(function(q){return q.req.limit===M.limit&&q.req.values===M.values&&tu(q.req.query.range,M.query.range)});return N?[N,!0,T,B]:[B.find(function(q){return("limit"in q.req?q.req.limit:1/0)>=M.limit&&(!M.values||q.req.values)&&bh(q.req.query.range,M.query.range)}),!1,T,B];case"count":return N=B.find(function(q){return tu(q.req.query.range,M.query.range)}),[N,!!N,T,B]}}(s,u,"query",p),P=I[0],w=I[1],L=I[2],k=I[3];return P&&w?P.obsSet=p.obsSet:(w=f.query(p).then(function(O){var R=O.result;if(P&&(P.res=R),y){for(var C=0,M=R.length;C<M;++C)Object.freeze(R[C]);Object.freeze(R)}else O.result=Ie(R);return O}).catch(function(O){return k&&P&&Te(k,P),Promise.reject(O)}),P={obsSet:p.obsSet,promise:w,subscribers:new Set,type:"query",req:p,dirty:!1},k?k.push(P):(k=[P],(L=L||(en["idb://".concat(s,"/").concat(u)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=k)),wh(P,k,b,x),P.promise.then(function(O){return{result:eu(O.result,p,L==null?void 0:L.optimisticOps,f,P,y)}})}})}})}};function Ia(a,s){return new Proxy(a,{get:function(u,f,h){return f==="db"?s:Reflect.get(u,f,h)}})}var cr=(Fe.prototype.version=function(a){if(isNaN(a)||a<.1)throw new $.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new $.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var s=this._versions,u=s.filter(function(f){return f._cfg.version===a})[0];return u||(u=new this.Version(a),s.push(u),s.sort(lh),u.stores({}),this._state.autoSchema=!1,u)},Fe.prototype._whenReady=function(a){var s=this;return this.idbdb&&(this._state.openComplete||re.letThrough||this._vip)?a():new G(function(u,f){if(s._state.openComplete)return f(new $.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void f(new $.DatabaseClosed);s.open().catch(U)}s._state.dbReadyPromise.then(u,f)}).then(a)},Fe.prototype.use=function(a){var s=a.stack,u=a.create,f=a.level,h=a.name;return h&&this.unuse({stack:s,name:h}),a=this._middlewares[s]||(this._middlewares[s]=[]),a.push({stack:s,create:u,level:f??10,name:h}),a.sort(function(p,y){return p.level-y.level}),this},Fe.prototype.unuse=function(a){var s=a.stack,u=a.name,f=a.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return f?h.create!==f:!!u&&h.name!==u})),this},Fe.prototype.open=function(){var a=this;return Jr(xr,function(){return mh(a)})},Fe.prototype._close=function(){var a=this._state,s=xn.indexOf(this);if(0<=s&&xn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new G(function(u){a.dbReadyResolve=u}),a.openCanceller=new G(function(u,f){a.cancelOpen=f}))},Fe.prototype.close=function(u){var s=(u===void 0?{disableAutoOpen:!0}:u).disableAutoOpen,u=this._state;s?(u.isBeingOpened&&u.cancelOpen(new $.DatabaseClosed),this._close(),u.autoOpen=!1,u.dbOpenError=new $.DatabaseClosed):(this._close(),u.autoOpen=this._options.autoOpen||u.isBeingOpened,u.openComplete=!1,u.dbOpenError=null)},Fe.prototype.delete=function(a){var s=this;a===void 0&&(a={disableAutoOpen:!0});var u=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new G(function(h,p){function y(){s.close(a);var b=s._deps.indexedDB.deleteDatabase(s.name);b.onsuccess=$e(function(){var x,I,P;x=s._deps,I=s.name,P=x.indexedDB,x=x.IDBKeyRange,jo(P)||I===fa||No(P,x).delete(I).catch(U),h()}),b.onerror=Gt(p),b.onblocked=s._fireOnBlocked}if(u)throw new $.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(y):y()})},Fe.prototype.backendDB=function(){return this.idbdb},Fe.prototype.isOpen=function(){return this.idbdb!==null},Fe.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},Fe.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Fe.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Fe.prototype,"tables",{get:function(){var a=this;return c(this._allTables).map(function(s){return a._allTables[s]})},enumerable:!1,configurable:!0}),Fe.prototype.transaction=function(){var a=(function(s,u,f){var h=arguments.length;if(h<2)throw new $.InvalidArgument("Too few arguments");for(var p=new Array(h-1);--h;)p[h-1]=arguments[h];return f=p.pop(),[s,Ne(p),f]}).apply(this,arguments);return this._transaction.apply(this,a)},Fe.prototype._transaction=function(a,s,u){var f=this,h=re.trans;h&&h.db===this&&a.indexOf("!")===-1||(h=null);var p,y,b=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(y=s.map(function(I){if(I=I instanceof f.Table?I.name:I,typeof I!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return I}),a=="r"||a===Io)p=Io;else{if(a!="rw"&&a!=Co)throw new $.InvalidArgument("Invalid transaction mode: "+a);p=Co}if(h){if(h.mode===Io&&p===Co){if(!b)throw new $.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&y.forEach(function(I){if(h&&h.storeNames.indexOf(I)===-1){if(!b)throw new $.SubTransaction("Table "+I+" not included in parent transaction.");h=null}}),b&&h&&!h.active&&(h=null)}}catch(I){return h?h._promise(null,function(P,w){w(I)}):qe(I)}var x=(function I(P,w,L,k,O){return G.resolve().then(function(){var R=re.transless||re,C=P._createTransaction(w,L,P._dbSchema,k);if(C.explicit=!0,R={trans:C,transless:R},k)C.idbtrans=k.idbtrans;else try{C.create(),C.idbtrans._explicit=!0,P._state.PR1398_maxLoop=3}catch(B){return B.name===zr.InvalidState&&P.isOpen()&&0<--P._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),P.close({disableAutoOpen:!1}),P.open().then(function(){return I(P,w,L,null,O)})):qe(B)}var M,T=Se(O);return T&&Sn(),R=G.follow(function(){var B;(M=O.call(C,C))&&(T?(B=Ir.bind(null,null),M.then(B,B)):typeof M.next=="function"&&typeof M.throw=="function"&&(M=zo(M)))},R),(M&&typeof M.then=="function"?G.resolve(M).then(function(B){return C.active?B:qe(new $.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):R.then(function(){return M})).then(function(B){return k&&C._resolve(),C._completion.then(function(){return B})}).catch(function(B){return C._reject(B),qe(B)})})}).bind(null,this,p,y,h,u);return h?h._promise(p,x,"lock"):re.trans?Jr(re.transless,function(){return f._whenReady(x)}):this._whenReady(x)},Fe.prototype.table=function(a){if(!g(this._allTables,a))throw new $.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},Fe);function Fe(a,s){var u=this;this._middlewares={},this.verno=0;var f=Fe.dependencies;this._options=s=n({addons:Fe.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},f=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,p,y,b,x,I={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:U,dbReadyPromise:null,cancelOpen:U,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};I.dbReadyPromise=new G(function(w){I.dbReadyResolve=w}),I.openCanceller=new G(function(w,L){I.cancelOpen=L}),this._state=I,this.name=a,this.on=ri(this,"populate","blocked","versionchange","close",{ready:[Qt,U]}),this.on.ready.subscribe=Y(this.on.ready.subscribe,function(w){return function(L,k){Fe.vip(function(){var O,R=u._state;R.openComplete?(R.dbOpenError||G.resolve().then(L),k&&w(L)):R.onReadyBeingFired?(R.onReadyBeingFired.push(L),k&&w(L)):(w(L),O=u,k||w(function C(){O.on.ready.unsubscribe(L),O.on.ready.unsubscribe(C)}))})}}),this.Collection=(h=this,ni(nh.prototype,function(M,C){this.db=h;var k=Lc,O=null;if(C)try{k=C()}catch(T){O=T}var R=M._ctx,C=R.table,M=C.hook.reading.fire;this._ctx={table:C,index:R.index,isPrimKey:!R.index||C.schema.primKey.keyPath&&R.index===C.schema.primKey.name,range:k,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:O,or:R.or,valueMapper:M!==ye?M:null}})),this.Table=(p=this,ni(Ac.prototype,function(w,L,k){this.db=p,this._tx=k,this.name=w,this.schema=L,this.hook=p._allTables[w]?p._allTables[w].hook:ri(null,{creating:[nr,U],reading:[pe,ye],updating:[ut,U],deleting:[ue,U]})})),this.Transaction=(y=this,ni(oh.prototype,function(w,L,k,O,R){var C=this;this.db=y,this.mode=w,this.storeNames=L,this.schema=k,this.chromeTransactionDurability=O,this.idbtrans=null,this.on=ri(this,"complete","error","abort"),this.parent=R||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new G(function(M,T){C._resolve=M,C._reject=T}),this._completion.then(function(){C.active=!1,C.on.complete.fire()},function(M){var T=C.active;return C.active=!1,C.on.error.fire(M),C.parent?C.parent._reject(M):T&&C.idbtrans&&C.idbtrans.abort(),qe(M)})})),this.Version=(b=this,ni(hh.prototype,function(w){this.db=b,this._cfg={version:w,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(x=this,ni(Fc.prototype,function(w,L,k){if(this.db=x,this._ctx={table:w,index:L===":id"?null:L,or:k},this._cmp=this._ascending=we,this._descending=function(O,R){return we(R,O)},this._max=function(O,R){return 0<we(O,R)?O:R},this._min=function(O,R){return we(O,R)<0?O:R},this._IDBKeyRange=x._deps.IDBKeyRange,!this._IDBKeyRange)throw new $.MissingAPI})),this.on("versionchange",function(w){0<w.newVersion?console.warn("Another connection wants to upgrade database '".concat(u.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(u.name,"'. Closing db now to resume the delete request.")),u.close({disableAutoOpen:!1})}),this.on("blocked",function(w){!w.newVersion||w.newVersion<w.oldVersion?console.warn("Dexie.delete('".concat(u.name,"') was blocked")):console.warn("Upgrade '".concat(u.name,"' blocked by other connection holding version ").concat(w.oldVersion/10))}),this._maxKey=si(s.IDBKeyRange),this._createTransaction=function(w,L,k,O){return new u.Transaction(w,L,k,u._options.chromeTransactionDurability,O)},this._fireOnBlocked=function(w){u.on("blocked").fire(w),xn.filter(function(L){return L.name===u.name&&L!==u&&!L._state.vcFired}).map(function(L){return L.on("versionchange").fire(w)})},this.use(gh),this.use(_h),this.use(yh),this.use(ph),this.use(vh);var P=new Proxy(this,{get:function(w,L,k){if(L==="_vip")return!0;if(L==="table")return function(R){return Ia(u.table(R),P)};var O=Reflect.get(w,L,k);return O instanceof Ac?Ia(O,P):L==="tables"?O.map(function(R){return Ia(R,P)}):L==="_createTransaction"?function(){return Ia(O.apply(this,arguments),P)}:O}});this.vip=P,f.forEach(function(w){return w(u)})}var Ca,Dt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Eh=(Yo.prototype.subscribe=function(a,s,u){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:s,complete:u})},Yo.prototype[Dt]=function(){return this},Yo);function Yo(a){this._subscribe=a}try{Ca={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{Ca={indexedDB:null,IDBKeyRange:null}}function ru(a){var s,u=!1,f=new Eh(function(h){var p=Se(a),y,b=!1,x={},I={},P={get closed(){return b},unsubscribe:function(){b||(b=!0,y&&y.abort(),w&&Or.storagemutated.unsubscribe(k))}};h.start&&h.start(P);var w=!1,L=function(){return ko(O)},k=function(R){Sa(x,R),Ko(I,x)&&L()},O=function(){var R,C,M;!b&&Ca.indexedDB&&(x={},R={},y&&y.abort(),y=new AbortController,M=function(T){var B=_n();try{p&&Sn();var N=kr(a,T);return N=p?N.finally(Ir):N}finally{B&&En()}}(C={subscr:R,signal:y.signal,requery:L,querier:a,trans:null}),Promise.resolve(M).then(function(T){u=!0,s=T,b||C.signal.aborted||(x={},function(B){for(var N in B)if(g(B,N))return;return 1}(I=R)||w||(Or(oi,k),w=!0),ko(function(){return!b&&h.next&&h.next(T)}))},function(T){u=!1,["DatabaseClosedError","AbortError"].includes(T==null?void 0:T.name)||b||ko(function(){b||h.error&&h.error(T)})}))};return setTimeout(L,0),P});return f.hasValue=function(){return u},f.getValue=function(){return s},f}var tn=cr;function Jo(a){var s=Pr;try{Pr=!0,Or.storagemutated.fire(a),Wo(a,!0)}finally{Pr=s}}S(tn,n(n({},te),{delete:function(a){return new tn(a,{addons:[]}).delete()},exists:function(a){return new tn(a,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return s=tn.dependencies,u=s.indexedDB,s=s.IDBKeyRange,(jo(u)?Promise.resolve(u.databases()).then(function(f){return f.map(function(h){return h.name}).filter(function(h){return h!==fa})}):No(u,s).toCollection().primaryKeys()).then(a)}catch{return qe(new $.MissingAPI)}var s,u},defineClass:function(){return function(a){d(this,a)}},ignoreTransaction:function(a){return re.trans?Jr(re.transless,a):a()},vip:qo,async:function(a){return function(){try{var s=zo(a.apply(this,arguments));return s&&typeof s.then=="function"?s:G.resolve(s)}catch(u){return qe(u)}}},spawn:function(a,s,u){try{var f=zo(a.apply(u,s||[]));return f&&typeof f.then=="function"?f:G.resolve(f)}catch(h){return qe(h)}},currentTransaction:{get:function(){return re.trans||null}},waitFor:function(a,s){return s=G.resolve(typeof a=="function"?tn.ignoreTransaction(a):a).timeout(s||6e4),re.trans?re.trans.waitFor(s):s},Promise:G,debug:{get:function(){return Ae},set:function(a){Vr(a)}},derive:D,extend:d,props:S,override:Y,Events:ri,on:Or,liveQuery:ru,extendObservabilitySet:Sa,getByKeyPath:ee,setByKeyPath:ne,delByKeyPath:function(a,s){typeof s=="string"?ne(a,s,void 0):"length"in s&&[].map.call(s,function(u){ne(a,u,void 0)})},shallowClone:me,deepClone:Ie,getObjectDiff:Vo,cmp:we,asap:ae,minKey:-1/0,addons:[],connections:xn,errnames:zr,dependencies:Ca,cache:en,semVer:"4.0.10",version:"4.0.10".split(".").map(function(a){return parseInt(a)}).reduce(function(a,s,u){return a+s/Math.pow(10,2*u)})})),tn.maxKey=si(tn.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Or(oi,function(a){Pr||(a=new CustomEvent(Ro,{detail:a}),Pr=!0,dispatchEvent(a),Pr=!1)}),addEventListener(Ro,function(a){a=a.detail,Pr||Jo(a)}));var Cn,Pr=!1,nu=function(){};return typeof BroadcastChannel<"u"&&((nu=function(){(Cn=new BroadcastChannel(Ro)).onmessage=function(a){return a.data&&Jo(a.data)}})(),typeof Cn.unref=="function"&&Cn.unref(),Or(oi,function(a){Pr||Cn.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!cr.disableBfCache&&a.persisted){Ae&&console.debug("Dexie: handling persisted pagehide"),Cn!=null&&Cn.close();for(var s=0,u=xn;s<u.length;s++)u[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!cr.disableBfCache&&a.persisted&&(Ae&&console.debug("Dexie: handling persisted pageshow"),nu(),Jo({all:new at(-1/0,[[]])}))})),G.rejectionMapper=function(a,s){return!a||a instanceof fe||a instanceof TypeError||a instanceof SyntaxError||!a.name||!X[a.name]?a:(s=new X[a.name](s||a.message,a),"stack"in a&&_(s,"stack",{get:function(){return this.inner.stack}}),s)},Vr(Ae),n(cr,Object.freeze({__proto__:null,Dexie:cr,liveQuery:ru,Entity:$c,cmp:we,PropModSymbol:sr,PropModification:ii,replacePrefix:function(a,s){return new ii({replacePrefix:[a,s]})},add:function(a){return new ii({add:a})},remove:function(a){return new ii({remove:a})},default:cr,RangeSet:at,mergeRanges:li,rangesOverlap:zc}),{default:cr}),cr})}(Fa)),Fa.exports}var Cb=Ib();const Fs=xb(Cb),Uu=Symbol.for("Dexie"),to=globalThis[Uu]||(globalThis[Uu]=Fs);if(Fs.semVer!==to.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Fs.semVer} and ${to.semVer}`);const{liveQuery:Zw,mergeRanges:e0,rangesOverlap:t0,RangeSet:r0,cmp:n0,Entity:i0,PropModSymbol:a0,PropModification:o0,replacePrefix:s0,add:c0,remove:u0}=to;var ro="docs",Db="changes",Wu="attachments",xd="dexie",zu=new Map,Ka=new Map;function Ob(e,t,r,n){var i="rxdb-dexie-"+e+"--"+n.version+"--"+t,o=Ut(zu,i,()=>{var c=(async()=>{var l=Be(r);l.autoOpen=!1;var d=new to(i,l);r.onCreate&&await r.onCreate(d,i);var v={[ro]:Lb(n),[Db]:"++sequence, id",[Wu]:"id"};return d.version(1).stores(v),await d.open(),{dexieDb:d,dexieTable:d[ro],dexieAttachmentsTable:d[Wu],booleanIndexes:$b(n)}})();return zu.set(i,o),Ka.set(o,0),c});return o}async function Pb(e){var t=await e,r=Ka.get(e),n=r-1;n===0?(t.dexieDb.close(),Ka.delete(e)):Ka.set(e,n)}var Ks="__";function Zn(e){var t=e.split(".");if(t.length>1)return t.map(n=>Zn(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return Ks+r}else return e}function kd(e){var t=e.split(".");if(t.length>1)return t.map(n=>kd(n)).join(".");if(e.startsWith(Ks)){var r=e.substring(Ks.length);return"|"+r}else return e}function Rb(e,t){if(!t)return t;var r=Be(t);return r=Hs(r),e.forEach(n=>{var i=Kr(t,n),o=i?"1":"0",c=Zn(n);xl(r,c,o)}),r}function Id(e,t){return t&&(t=Be(t),t=Us(t),e.forEach(r=>{var n=Kr(t,r),i=n==="1";xl(t,r,i)}),t)}function Hs(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Hs(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=Hs(n)),t[Zn(r)]=n}),t}}function Us(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Us(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=Us(n)),t[kd(r)]=n}),t}}function Lb(e){var t=[],r=St(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(o=>{var c=Ys(o);t.push(c)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(o=>o.map(c=>Zn(c)));var n=t.map(o=>o.length===1?o[0]:"["+o.join("+")+"]");n=n.filter((o,c,l)=>l.indexOf(o)===c);var i=n.join(", ");return i}async function Vu(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(i=>Id(r.booleanIndexes,i))}function La(e,t){return e+"||"+t}function $b(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var i=Ys(n);i.forEach(o=>{if(!t.has(o)){t.add(o);var c=Fn(e,o);c.type==="boolean"&&r.push(o)}})}),r.push("_deleted"),Ph(r)):r}function Qu(e){return e===$n?-1/0:e}function Gu(e,t,r){if(e.includes(t)){var n=r===Ln||r===!0?"1":"0";return n}else return r}function Cd(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((c,l)=>{var d=t.index[l];return Gu(e,d,c)}).map(Qu),i=t.endKeys.map((c,l)=>{var d=t.index[l];return Gu(e,d,c)}).map(Qu),o=r.bound(n,i,!t.inclusiveStart,!t.inclusiveEnd);return o}async function Yu(e,t){var r=await e.internals,n=t.query,i=n.skip?n.skip:0,o=n.limit?n.limit:1/0,c=i+o,l=t.queryPlan,d=!1;l.selectorSatisfiedByIndex||(d=lc(e.schema,t.query));var v=Cd(r.booleanIndexes,l,r.dexieDb._options.IDBKeyRange),m=l.index,g=[];if(await r.dexieDb.transaction("r",r.dexieTable,async E=>{var _=E.idbtrans,D=_.objectStore(ro),A,j;j="["+m.map(Y=>Zn(Y)).join("+")+"]",A=D.index(j);var K=A.openCursor(v);await new Promise(Y=>{K.onsuccess=function(se){var ae=se.target.result;if(ae){var ee=Id(r.booleanIndexes,ae.value);(!d||d(ee))&&g.push(ee),l.sortSatisfiedByIndex&&g.length===c?Y():ae.continue()}else Y()}})}),!l.sortSatisfiedByIndex){var S=jf(e.schema,t.query);g=g.sort(S)}return g=g.slice(i,c),{documents:g}}async function Mb(e,t){var r=await e.internals,n=t.queryPlan,i=n.index,o=Cd(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),c=-1;return await r.dexieDb.transaction("r",r.dexieTable,async l=>{var d=l.idbtrans,v=d.objectStore(ro),m,g;g="["+i.map(E=>Zn(E)).join("+")+"]",m=v.index(g);var S=m.count(o);c=await new Promise((E,_)=>{S.onsuccess=function(){E(S.result)},S.onerror=D=>_(D)})}),c}var Tb=Et(),ms=!1,Ab=function(){function e(r,n,i,o,c,l,d,v){this.changes$=new Tt,this.instanceId=Tb++,this.storage=r,this.databaseName=n,this.collectionName=i,this.schema=o,this.internals=c,this.options=l,this.settings=d,this.devMode=v,this.primaryPath=St(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,i){nn(this),!ms&&!await Il()&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium/?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),ms=!0,n.forEach(m=>{if(!m.document._rev||m.previous&&!m.previous._rev)throw Z("SNH",{args:{row:m}})});var o=await this.internals,c={error:[]};this.devMode&&(n=n.map(m=>{var g=Zi(m.document);return{previous:m.previous,document:g}}));var l=n.map(m=>m.document[this.primaryPath]),d;if(await o.dexieDb.transaction("rw",o.dexieTable,o.dexieAttachmentsTable,async()=>{var m=new Map,g=await Vu(this.internals,l);g.forEach(_=>{var D=_;return D&&m.set(D[this.primaryPath],D),D}),d=hv(this,this.primaryPath,m,n,i),c.error=d.errors;var S=[];d.bulkInsertDocs.forEach(_=>{S.push(_.document)}),d.bulkUpdateDocs.forEach(_=>{S.push(_.document)}),S=S.map(_=>Rb(o.booleanIndexes,_)),S.length>0&&await o.dexieTable.bulkPut(S);var E=[];d.attachmentsAdd.forEach(_=>{E.push({id:La(_.documentId,_.attachmentId),data:_.attachmentData.data})}),d.attachmentsUpdate.forEach(_=>{E.push({id:La(_.documentId,_.attachmentId),data:_.attachmentData.data})}),await o.dexieAttachmentsTable.bulkPut(E),await o.dexieAttachmentsTable.bulkDelete(d.attachmentsRemove.map(_=>La(_.documentId,_.attachmentId)))}),d=de(d),d.eventBulk.events.length>0){var v=de(d.newestRow).document;d.eventBulk.checkpoint={id:v[this.primaryPath],lwt:v._meta.lwt},this.changes$.next(d.eventBulk)}return c},t.findDocumentsById=async function(n,i){nn(this);var o=await this.internals,c=[];return await o.dexieDb.transaction("r",o.dexieTable,async()=>{var l=await Vu(this.internals,n);l.forEach(d=>{d&&(!d._deleted||i)&&c.push(d)})}),c},t.query=function(n){return nn(this),Yu(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var i=await Mb(this,n);return{count:i,mode:"fast"}}else{var o=await Yu(this,n);return{count:o.documents.length,mode:"slow"}}},t.changeStream=function(){return nn(this),this.changes$.asObservable()},t.cleanup=async function(n){nn(this);var i=await this.internals;return await i.dexieDb.transaction("rw",i.dexieTable,async()=>{var o=Et()-n,c=await i.dexieTable.where("_meta.lwt").below(o).toArray(),l=[];c.forEach(d=>{d._deleted==="1"&&l.push(d[this.primaryPath])}),await i.dexieTable.bulkDelete(l)}),!0},t.getAttachmentData=async function(n,i,o){nn(this);var c=await this.internals,l=La(n,i);return await c.dexieDb.transaction("r",c.dexieAttachmentsTable,async()=>{var d=await c.dexieAttachmentsTable.get(l);if(d)return d.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+i)})},t.remove=async function(){nn(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await Pb(this.internals)})(),this.closed)},e}();async function Bb(e,t,r){var n=Ob(t.databaseName,t.collectionName,r,t.schema),i=new Ab(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await Eb(xd,t,i),Promise.resolve(i)}function nn(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var Nb=function(){function e(r){this.name=xd,this.rxdbVersion=kl,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){if(vv(n),n.schema.indexes){var i=n.schema.indexes.flat();i.filter(o=>!o.includes(".")).forEach(o=>{if(!n.schema.required||!n.schema.required.includes(o))throw Z("DXE1",{field:o,schema:n.schema})})}return Bb(this,n,this.settings)},e}();function jb(e={}){var t=new Nb(e);return t}var qb=["__proto__","constructor","prototype"];function hi(e,t){Object.keys(t).forEach(r=>{qb.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:gi(t[r])?hi(e[r],t[r]):e[r]=t[r])})}function gi(e){return e.toString()==="[object Object]"}var vo=function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var i=this;r.selector&&i.find(r.selector),r.limit&&i.limit(r.limit),r.skip&&i.skip(r.skip),r.sort&&r.sort.forEach(o=>i.sort(o))}}var t=e.prototype;return t.where=function(n,i){if(!arguments.length)return this;var o=typeof arguments[0];if(o==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(o==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw Lt("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var i=this._path;return this._conditions[i]=n,this},t.eq=function(n){this._ensurePath("eq");var i=this._path;return this._conditions[i]=n,this},t.or=function(n){var i=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.nor=function(n){var i=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.and=function(n){var i=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.mod=function(n,i){var o,c;arguments.length===1?(this._ensurePath("mod"),o=arguments[0],c=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),o=arguments.slice(),c=this._path):arguments.length===3?(o=arguments.slice(1),c=arguments[0]):(o=arguments[1],c=arguments[0]);var l=this._conditions[c]||(this._conditions[c]={});return l.$mod=o,this},t.exists=function(n,i){var o,c;arguments.length===0?(this._ensurePath("exists"),o=this._path,c=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),o=this._path,c=arguments[0]):(o=arguments[0],c=!0):arguments.length===2&&(o=arguments[0],c=arguments[1]);var l=this._conditions[o]||(this._conditions[o]={});return l.$exists=c,this},t.elemMatch=function(n,i){if(arguments[0]===null)throw Lt("MQ2");var o,c,l;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),c=this._path,o=arguments[0];else if(gi(arguments[0]))this._ensurePath("elemMatch"),c=this._path,l=arguments[0];else if(typeof arguments[1]=="function")c=arguments[0],o=arguments[1];else if(arguments[1]&&gi(arguments[1]))c=arguments[0],l=arguments[1];else throw Lt("MQ2");o&&(l=new e,o(l),l=l._conditions);var d=this._conditions[c]||(this._conditions[c]={});return d.$elemMatch=l,this},t.sort=function(n){if(!n)return this;var i,o=typeof n;if(Array.isArray(n)){i=n.length;for(var c=0;c<n.length;++c)Kb(this.options,n[c][0],n[c][1]);return this}if(arguments.length===1&&o==="string"){n=n.split(/\s+/),i=n.length;for(var l=0;l<i;++l){var d=n[l];if(d){var v=d[0]==="-"?-1:1;v===-1&&(d=d.substring(1)),Ju(this.options,d,v)}}return this}if(gi(n)){var m=Object.keys(n);return m.forEach(g=>Ju(this.options,g,n[g])),this}throw Lt("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!Xu(n))throw Lt("MQ4",{source:n});return n instanceof e?(n._conditions&&hi(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),hi(this._fields,n._fields)),n.options&&(this.options||(this.options={}),hi(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(hi(this._conditions,n),this)},t.find=function(n){return Xu(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw Z("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=Fb(this.options.sort)),{query:n,path:this._path}},e}();function Fb(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",i={[t]:n};return i})}var Dd=["limit","skip","maxScan","batchSize","comment"];Dd.forEach(function(e){vo.prototype[e]=function(t){return this.options[e]=t,this}});var Od=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];Od.forEach(function(e){vo.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw Z("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function Ju(e,t,r){if(Array.isArray(e.sort))throw Lt("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var i=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(i))throw Array.isArray(r)&&(r="["+r+"]"),Lt("MQ7",{field:t,value:r});var o=e.sort||(e.sort={}),c=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");o[t]=parseInt(c,10)}function Kb(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw Lt("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function Xu(e){return e instanceof vo||gi(e)}function Hb(e,t){return new vo(e,t)}var Zu="queryBuilderPath";function Ub(e,t,r){var n=Hb(ft(e.mangoQuery),e.other[Zu]);n[t](r);var i=n.toJSON();return On(e.op,i.query,e.collection,{...e.other,[Zu]:i.path})}function ps(e,t){e[t]=function(r){if(xe.isDevMode()&&this.op==="findByIds")throw Z("QU17",{collection:this.collection.name,query:this.mangoQuery});return Ub(this,t,r)}}var Wb={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{ps(e,t)}),Dd.forEach(t=>{ps(e,t)}),Od.forEach(t=>{ps(e,t)})}}};async function Pd(e){var t=om(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>Vn(n,hn)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function zb(e,t,r){var n=Be(r._attachments),i=ft(r),o=i._meta;delete i._meta,i._attachments=n;for(var c=t+1,l=Promise.resolve(i),d=function(){var v=c;l=l.then(m=>Vb(e,v,m)),c++};c<=e.schema.version;)d();return l.then(v=>v===null?Xs:(v._meta=o,v))}function Vb(e,t,r){if(r===null)return Xs;var n=e.migrationStrategies[t](r,e),i=Nh(n);return i}async function Rd(e){if(e.collection.schema.version===0)return br;var t=await Pd(e);return!!t}var Qb=200,Ld=new WeakMap;function Gb(e){var t=$d(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function $d(e){return Ut(Ld,e,()=>new Lr([]))}function Yb(e){var t=Ld.get(e);t&&t.complete()}var Jb=function(){function e(r,n,i=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=jh,this.collection=r,this.migrationStrategies=n,this.statusDocKey=i,this.database=r.database,this.oldCollectionMeta=Pd(this),this.mustMigrate=Rd(this),this.statusDocId=Vn(this.statusDocKey,Na),Gb(this),this.$=dv(this.database.internalStore,this.statusDocId).pipe(De(o=>!!o),Ue(o=>de(o).data),Qi(Hi))}var t=e.prototype;return t.getStatus=function(){return dn(this.$)},t.startMigration=async function(n=Qb){var i=await this.mustMigrate;if(i){if(this.started)throw Z("DM1");this.started=!0;var o=void 0;if(this.database.multiInstance){o=new po(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var c=wb(o);await c.awaitLeadership()}var l=await this.oldCollectionMeta,d=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:l.data.schema,password:this.database.password,devMode:xe.isDevMode()}),v=await this.getConnectedStorageInstances(),m=await this.countAllDoucments([d].concat(v.map(g=>g.oldStorage)));await this.updateStatus(g=>(g.count.total=m,g));try{await Promise.all(v.map(async g=>{await Tg(this.collection,g.newStorage.collectionName,g.newStorage.schema),await this.migrateStorage(g.oldStorage,g.newStorage,n),await g.newStorage.close()})),await this.migrateStorage(d,this.collection.storageInstance.originalStorageInstance,n)}catch(g){await d.close(),await this.updateStatus(S=>(S.status="ERROR",S.error=Wh(g),S));return}await Mi(this.database.internalStore,{previous:l,document:Object.assign({},l,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(g=>(g.status="DONE",g)),o&&await o.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var i=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var o=await Xi(this.database.internalStore,this.statusDocId),c=ft(o);o||(c={id:this.statusDocId,key:this.statusDocKey,context:Na,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:Yn(),_rev:Ht(),_attachments:{}});var l=de(c).data;for(var d of i)l=d(l);if(l.count.percent=Math.round(l.count.handled/l.count.total*100),c&&o&&Si(c.data,o.data))break;try{await Mi(this.database.internalStore,{previous:o,document:de(c)},Na);break}catch(v){if(!oo(v))throw v}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,i,o){var c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:Au(n.schema,$s(n.schema)),password:this.database.password,devMode:xe.isDevMode()}),l=uy(i,Ya,this.database.token,!0),d=oy({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async m=>{m=await Promise.all(m.map(async S=>{var E=S.newDocumentState;if(i.schema.title===qa&&(E=S.newDocumentState.docData,S.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:S.newDocumentState};var _=await zb(this.collection,n.schema.version,E),D={assumedMasterState:void 0,newDocumentState:i.schema.title===qa?Object.assign({},S.newDocumentState,{docData:_}):_};return D})),m=m.filter(S=>!!S.newDocumentState);var g=await l.masterWrite(m);return g},masterChangeStream$:new Tt().asObservable()},forkInstance:n,metaInstance:c,pushBatchSize:o,pullBatchSize:0,conflictHandler:Ya,hashFunction:this.database.hashFunction}),v=!1;if(d.events.error.subscribe(m=>v=m),d.events.processed.up.subscribe(()=>{this.updateStatus(m=>(m.count.handled=m.count.handled+1,m))}),await sy(d),await cy(d),await ly(d),await this.updateStatusQueue,v)throw await c.close(),v;await Promise.all([n.remove(),c.remove()])},t.countAllDoucments=async function(n){var i=0;return await Promise.all(n.map(async o=>{var c=fo(o.schema,Tn(o.schema,{selector:{}})),l=await o.count(c);i+=l.count})),i},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,i=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async o=>{if(o.schema.title!==qa)throw new Error("unknown migration handling for schema");var c=Au(ft(this.collection.schema.jsonSchema),$s(o.schema));c.version=this.collection.schema.version;var[l,d]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:xe.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:o.schema,password:this.database.password,collectionName:o.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:xe.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:c,password:this.database.password,collectionName:o.collectionName})]);i.push({oldStorage:l,newStorage:d})}))),i},t.migratePromise=async function(n){this.startMigration(n);var i=await this.mustMigrate;if(!i)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var o=await Promise.race([dn(this.$.pipe(De(c=>c.status==="DONE"))),dn(this.$.pipe(De(c=>c.status==="ERROR")))]);if(o.status==="ERROR")throw Z("DM4",{collection:this.collection.name,error:o.error});return o},e}(),Xb=Hf(),Zb=function(e){function t(r,n,i){var o;return o=e.call(this,null,n)||this,o.id=r,o.parent=i,o}return Zs(t,e),t}(Xb),yi={get isLocal(){return!0},get allAttachments$(){throw Z("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=qn(Ws,this.parent),r=this.primary;return e.parent.eventBulks$.pipe(De(n=>!!n.isLocal),Ue(n=>n.events.find(i=>i.documentId===r)),De(n=>!!n),Ue(n=>Xl(de(n))),Gi(t.docCache.getLatestDocumentData(this.primary)),Ii((n,i)=>n._rev===i._rev),Ue(n=>t.docCache.getCachedRxDocument(n)),Qi(Hi))},get $$(){var e=this,t=vs(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=vs(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=qn(Ws,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw Lt("LD2",{objPath:e});var t=Kr(this._data,e);return t=xe.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,xe.isDevMode()){if(e.includes(".item."))throw Z("LD3",{objPath:e});if(e===this.primaryPath)throw Z("LD4")}return this.$.pipe(Ue(t=>t._data),Ue(t=>Kr(t,e)),Ii())},get$$(e){var t=vs(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await bi(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await bi(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(i=>{if(i.error[0])throw i.error[0];var o=Bt(this.collection.schema.primaryPath,n,i)[0];e=Be(e),e._rev=o._rev})},async remove(){var e=await bi(this.parent),t=Be(this._data);return t._deleted=!0,Mi(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},el=!1,ew=()=>{if(!el){el=!0;var e=ho,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var i=Object.getOwnPropertyDescriptor(yi,n);if(!i){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(yi,n,o)}});var r=n=>()=>{throw Z("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>yi[n]=r(n))}};function tw(e,t){ew();var r=new Zb(e.id,e,t);return Object.setPrototypeOf(r,yi),r.prototype=yi,r}function vs(e){var t=e.parent;return Zg(t)?t:t.database}var no=new WeakMap,Ws=new WeakMap;function tl(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var i=await Md(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);i=fc(t,i,Td);var o=new Yf("id",t.eventBulks$.pipe(De(m=>{var g=!1;return(r===""&&!m.collectionName||r!==""&&m.collectionName===r)&&(g=!0),g&&m.isLocal}),Ue(m=>m.events)),m=>tw(m,e)),c=new Kf(i,"id",()=>{},()=>{}),l=await t.storageToken,d=i.changeStream().subscribe(m=>{for(var g=new Array(m.events.length),S=m.events,E=e.database?e.name:void 0,_=0;_<S.length;_++){var D=S[_];g[_]={documentId:D.documentId,collectionName:E,isLocal:!0,operation:D.operation,documentData:xe.deepFreezeWhenDevMode(D.documentData),previousDocumentData:xe.deepFreezeWhenDevMode(D.previousDocumentData)}}var A={id:m.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:l,events:g,databaseToken:t.token,checkpoint:m.checkpoint,context:m.context};t.$emit(A)});e._subs.push(d);var v={database:t,parent:e,storageInstance:i,docCache:o,incrementalWriteQueue:c};return Ws.set(e,v),v})();no.set(e,n)}function bi(e){var t=no.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw Z("LD8",{database:r.name,collection:n})}return t}function Md(e,t,r,n,i,o){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:rw(n),schema:Td,options:i,multiInstance:o,devMode:xe.isDevMode()})}function rl(e){var t=no.get(e);if(t)return no.delete(e),t.then(r=>r.storageInstance.close())}async function nl(e,t,r){var n=Ki(10),i=await Md(n,e,t,r,{},!1);await i.remove()}function rw(e){return"plugin-local-documents-"+e}var Td=so({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function il(e,t){var r=await bi(this),n={id:e,data:t,_deleted:!1,_meta:Yn(),_rev:Ht(),_attachments:{}};return Mi(r.storageInstance,{document:n},"local-document-insert").then(i=>r.docCache.getCachedRxDocument(i))}function al(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function ol(e){var t=await bi(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):Xi(t.storageInstance,e).then(i=>i?t.docCache.getCachedRxDocument(i):null)}function sl(e){return this.$.pipe(Gi(null),_r(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),_r(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),De(t=>t.use),Ue(t=>t.doc))}var nw={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=il,e.upsertLocal=al,e.getLocal=ol,e.getLocal$=sl},RxDatabase:e=>{e.insertLocal=il,e.upsertLocal=al,e.getLocal=ol,e.getLocal$=sl}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&tl(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&tl(e.collection)}},preCloseRxDatabase:{after:e=>rl(e)},postCloseRxCollection:{after:e=>rl(e)},postRemoveRxDatabase:{after:e=>nl(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>nl(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},iw=new WeakMap,aw={name:"migration-schema",rxdb:!0,init(){ja(nw)},hooks:{preCloseRxDatabase:{after:Yb}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return $d(this).pipe(Qi(Hi))}},RxCollection:e=>{e.getMigrationState=function(){return Ut(iw,this,()=>new Jb(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?br:Rd(this.getMigrationState())}}}},ow=aw;const go=e=>dt((t,r,n)=>{let i=0;if(be(r))for(const o of r)i=i|1<<o;else i=r;return e(t&i,i)}),sw=go((e,t)=>e==0),cw=go((e,t)=>e==t),uw=go((e,t)=>e<t),lw=go((e,t)=>e>0),fw=Object.freeze(Object.defineProperty({__proto__:null,$all:uv,$and:Ef,$bitsAllClear:sw,$bitsAllSet:cw,$bitsAnyClear:uw,$bitsAnySet:lw,$elemMatch:Tf,$eq:kf,$exists:Bf,$expr:ov,$gt:If,$gte:Cf,$in:Df,$jsonSchema:sv,$lt:Of,$lte:Pf,$mod:$f,$ne:Rf,$nin:Lf,$nor:Sf,$not:xf,$or:uc,$regex:Mf,$size:Af,$type:Nf,$where:cv},Symbol.toStringTag,{value:"Module"})),ht={cloneMode:"copy",queryOptions:uf({context:yn.init().addQueryOps(fw).addExpressionOps(Gp).addExpressionOps(nv)})},xc=(e,t)=>{switch(e){case"deep":return zn(t);case"copy":return Un(t)?new Date(t):be(t)?[...t]:We(t)?{...t}:pr(t)?new RegExp(t):t;default:return t}},dw=/^[a-z]+[a-zA-Z0-9]*$/;function Ad(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),i=e.substring(t+3,r);ke(i===""||dw.test(i),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const o=e.substring(r+2),[c,l]=o?Ad(o):[];return[{selector:e,parent:n,child:i||"$",next:c},[i,...l||[]].filter(Boolean)]}const vt=(e,t,r,n,i)=>{const{parent:o,child:c,next:l}=t;if(!c){let v=!1;return Pi(e,o,(g,S)=>v=!!n(g,S)||v,i),v}const d=tr(e,o);return be(d)?d.map((v,m)=>r[c]&&!r[c].test({[c]:v})?!1:l?vt(v,l,r,n,i):n(d,m)).some(Boolean):!1};function kt(e,t,r,n){const i=[];for(const[o,c]of Object.entries(e)){const[l,d]=Ad(o);if(!d.length)n(c,l,{})&&i.push(l.parent);else{const v={};t.forEach(g=>{Object.keys(g).forEach(S=>{d.forEach(E=>{(S===E||S.startsWith(E+"."))&&(v[E]=v[E]||{},Object.assign(v[E],{[S]:g[S]}))})})});const m={};for(const[g,S]of Object.entries(v))m[g]=new Wr(S,r.queryOptions);n(c,l,m)&&i.push(l.parent)}}return i}const hw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>{const l={$each:[i]};return We(i)&&zt(i,"$each")&&Object.assign(l,i),vt(e,o,c,(d,v)=>{const m=d[v]||(d[v]=[]);return af([m,l.$each]).length===l.$each.length?!1:(d[v]=xc(n.cloneMode,yp(m.concat(l.$each))),!0)},{buildGraph:!0})}),mw=new Set(["and","or","xor"]),pw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>{const l=Object.keys(i);return ke(l.length===1&&mw.has(l[0]),`Invalid bit operator '${l[0]}'. Must be one of 'and', 'or', or 'xor'.`),vt(e,o,c,(d,v)=>{let m=d[v];const g=i[l[0]];if(m!==void 0&&!(Ze(m)&&Ze(g)))return!1;switch(m=m||0,l[0]){case"and":d[v]=m&g;break;case"or":d[v]=m|g;break;case"xor":d[v]=m^g;break}return d[v]!==m},{buildGraph:!0})}),vw=(e,t,r=[],n=ht)=>{const i=Date.now();return kt(t,r,n,(o,c,l)=>vt(e,c,l,(d,v)=>(d[v]=i,!0),{buildGraph:!0}))},gw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>{if(!o.child){const l=tr(e,o.parent);ke(l===void 0||Ze(l),"cannot apply $inc to a value of non-numeric type")}return vt(e,o,c,(l,d)=>(l[d]=(l[d]||(l[d]=0))+i,!0),{buildGraph:!0})}),yw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>vt(e,o,c,(l,d)=>l[d]!==void 0&&At(l[d],i)>-1?!1:(l[d]=i,!0),{buildGraph:!0})),bw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>vt(e,o,c,(l,d)=>l[d]!==void 0&&At(l[d],i)<1?!1:(l[d]=i,!0),{buildGraph:!0})),ww=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>vt(e,o,c,(l,d)=>{const v=l[d];return l[d]=l[d]===void 0?0:l[d]*i,l[d]!==v},{buildGraph:!0})),_w=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>vt(e,o,c,(l,d)=>{const v=l[d];return ke(be(v),`path '${o.selector}' contains an element of non-array type.`),v.length?(i===-1?v.splice(0,1):v.pop(),!0):!1})),Bd=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>{const l=!We(i)||Object.keys(i).some(Ur),d=new Wr(l?{k:i}:i,n.queryOptions),v=l?m=>d.test({k:m}):m=>d.test(m);return vt(e,o,c,(m,g)=>{const S=m[g],E=new Array;return S.map(D=>{const A=v(D);return A||E.push(D),A}).some(Boolean)?(m[g]=E,!0):!1})}),Ew=(e,t,r=[],n=ht)=>{const i={};return Object.entries(t).forEach(([o,c])=>{i[o]={$in:c}}),Bd(e,i,r,n)},Sw=Object.freeze(["$each","$slice","$sort","$position"]),xw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>{const l={$each:[i]};return We(i)&&Sw.some(d=>zt(i,d))&&Object.assign(l,i),vt(e,o,c,(d,v)=>{const m=d[v]||(d[v]=[]),g=m.slice(0,l.$slice||m.length),S=m.length,E=Ze(l.$position)?l.$position:m.length;if(m.splice(E,0,...xc(n.cloneMode,l.$each)),l.$sort){const _=We(l.$sort)?Object.keys(l.$sort||{}).pop():"",D=_?l.$sort[_]:l.$sort,A=_?j=>tr(j,_):j=>j;m.sort((j,K)=>D*At(A(j),A(K)))}return Ze(l.$slice)&&(l.$slice<0?m.splice(0,m.length+l.$slice):m.splice(l.$slice)),S!=m.length||!Kt(g,m)},{descendArray:!0,buildGraph:!0})}),Nd=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>vt(e,o,c,(l,d)=>Kt(l[d],i)?!1:(l[d]=xc(n.cloneMode,i),!0),{buildGraph:!0})),kw=(e,t,r=[],n=ht)=>{const i=[],o=kt(t,r,n,(c,l,d)=>vt(e,l,d,(v,m)=>zt(v,m)?(i.push(...Nd(e,{[c]:v[m]},r,n)),delete v[m],!0):!1));return Array.from(new Set(o.concat(i)))},Iw=(e,t,r=[],n=ht)=>kt(t,r,n,(i,o,c)=>vt(e,o,c,(l,d)=>zt(l,d)?(be(l)?l[d]=null:delete l[d],!0):!1)),cl=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:hw,$bit:pw,$currentDate:vw,$inc:gw,$max:yw,$min:bw,$mul:ww,$pop:_w,$pull:Bd,$pullAll:Ew,$push:xw,$rename:kw,$set:Nd,$unset:Iw},Symbol.toStringTag,{value:"Module"}));function jd(e){return e=e??ht,(t,r,n=[],i={},o=e)=>{const c=Object.entries(r);ke(c.length===1,"Update expression must contain only one operator.");const[l,d]=c[0];ke(zt(cl,l),`Update operator '${l}' is not supported.`);const v=cl[l];return Object.keys(i).length&&!new Wr(i,o.queryOptions).test(t)?[]:v(t,d,n,o)}}jd();var gs;function qd(e,t){if(!gs){var r=jd({cloneMode:"none"});gs=(n,i)=>{var o=ft(n);return r(o,i),o}}return gs(e,t)}function Cw(e){return this.incrementalModify(t=>{var r=qd(t,e);return r})}function Dw(e){var t=this._data,r=qd(t,e);return this._saveData(r,t)}async function Ow(e){return Dn(this.asRxQuery,t=>t.update(e))}var Pw={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=Dw,e.incrementalUpdate=Cw},RxQuery:e=>{e.update=Ow}}};let wi=null,Me=null,zs;const Vt=new Promise(e=>{zs=e}),Rw={title:"chat history schema",version:2,description:"Stores chat sessions",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100},tabId:{type:"number"},timestamp:{type:"number"},title:{type:"string"},messages:{type:"array",items:{type:"object",properties:{messageId:{type:"string",maxLength:100},sender:{type:"string"},text:{type:"string"},timestamp:{type:"number"},isLoading:{type:"boolean",default:!1}},required:["messageId","sender","text","timestamp"]}},isStarred:{type:"boolean",default:!1}},required:["id","timestamp","messages"],indexes:["timestamp"]},Lw={1:function(e){return e.isStarred=e.isStarred||!1,e},2:function(e){return e.messages=e.messages.map((t,r)=>({...t,messageId:`${e.id}-msg-${r}-${Date.now()}`,timestamp:e.timestamp||Date.now(),isLoading:!1})),e.timestamp=e.timestamp||Date.now(),e}},$w=async()=>{console.log("DB: Starting RxDB initialization...");try{ja(Wb),console.log("DB: RxDBQueryBuilderPlugin added."),ja(ow),console.log("DB: RxDBMigrationSchemaPlugin added."),ja(Pw),console.log("DB: RxDBUpdatePlugin added.");let e=jb();console.log("DB: Creating RxDB database (tabagentdb)..."),wi=await Jg({name:"tabagentdb",storage:e}),console.log("DB: RxDB database created successfully:",wi.name),console.log("DB: Adding chatHistory collection (version 2)...");const t=await wi.addCollections({chatHistory:{schema:Rw,migrationStrategies:Lw}});if(console.log("DB: Collections object obtained."),Me=t.chatHistory,!Me)throw new Error("DB: chatHistory collection is null or undefined after addCollections");return console.log("DB: chatHistory collection assigned successfully"),zs(!0),console.log("DB: RxDB initialization finished successfully."),!0}catch(e){return console.error("-------------------------------------------"),console.error("DB: HIGH-LEVEL RxDB INITIALIZATION FAILED:",e),console.error("Error Name:",e.name),console.error("Error Message:",e.message),e.code&&console.error("RxDB Error Code:",e.code),e.parameters&&console.error("RxDB Error Parameters:",e.parameters),e.rxdb&&console.error("RxDB Specific Flag:",e.rxdb),console.error("Stack Trace:",e.stack),console.error("-------------------------------------------"),zs(!1),!1}};function Qn(e){return`${e}-msg-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}async function Vs(e){console.log("DB: Creating new chat session...");try{if(!await Vt||!Me)throw new Error("Database not ready");const r=`chat_${Date.now()}`,n=Date.now(),i={...e,messageId:Qn(r),timestamp:n},o={id:r,tabId:null,timestamp:n,title:(i.text||"New Chat").substring(0,40)+"...",messages:[i],isStarred:!1};return console.log("DB: Inserting new chat session:",o),await Me.insert(o),console.log("DB: New chat session created successfully with ID:",r),r}catch(t){throw console.error("DB: Error creating new chat session:",t),t}}async function jr(e,t){console.log(`DB: Adding message to chat ID: ${e}`);try{if(!await Vt||!Me)throw new Error("Database not ready");if(!e||!t)throw new Error("Invalid input: chatId and messageObject are required.");const n=await Me.findOne(e).exec();if(!n)throw new Error(`Chat session with ID ${e} not found`);const i={...t,messageId:t.messageId||Qn(e),timestamp:t.timestamp||Date.now(),isLoading:t.isLoading===void 0?!1:t.isLoading};return await n.update({$push:{messages:i}}),console.log(`DB: Message added successfully to chat ${e}. New message ID: ${i.messageId}`),i.messageId}catch(r){throw console.error(`DB: Error adding message to chat ${e}:`,r),r}}async function Ai(e,t,r){console.log(`DB: Updating message ID: ${t} in chat ID: ${e}`);try{if(!await Vt||!Me)throw new Error("Database not ready");if(!e||!t||!r)throw new Error("Invalid input: chatId, messageId, and updates are required.");const i=await Me.findOne(e).exec();if(!i)throw new Error(`Chat session with ID ${e} not found`);await i.incrementalModify(o=>{const c=o.messages.findIndex(l=>l.messageId===t);if(c!==-1){const l=o.messages[c];o.messages[c]={...l,...r,messageId:l.messageId},o.timestamp=Date.now(),console.log(`DB: Message ${t} updated in session ${e}.`)}else console.warn(`DB: Message with ID ${t} not found in chat ${e} for update.`);return o})}catch(n){throw console.error(`DB: Error updating message ${t} in chat ${e}:`,n),n}}async function Fd(){console.log("DB: Loading all history from DB...");try{if(!await Vt||!Me)throw new Error("Chat history database is not initialized");const t=await Me.find().sort({timestamp:"desc"}).exec();return console.log(`DB: Loaded ${t.length} history entries.`),t.map(r=>r.toJSON())}catch(e){throw console.error("DB: Error loading chat history:",e),e}}async function Gn(e){console.log(`DB: Getting chat session by ID: ${e}`);try{if(!await Vt||!Me)throw new Error("Database not initialized");const r=await Me.findOne(e).exec();return r?r.toJSON():(console.warn(`DB: Chat session with ID ${e} not found.`),null)}catch(t){throw console.error(`DB: Error getting chat session ${e}:`,t),t}}async function Kd(e){console.log(`DB: Toggling starred status for item ID: ${e}`);try{if(!await Vt||!Me)throw new Error("Database not initialized");const r=await Me.findOne(e).exec();if(!r)throw new Error(`History item with ID ${e} not found`);const n=r.get("isStarred")||!1,i=await r.patch({isStarred:!n});return console.log(`DB: Starred status for ${e} toggled to ${!n}`),i.toJSON()}catch(t){throw console.error(`DB: Error toggling starred status for item ${e}:`,t),t}}async function Hd(e){console.log(`DB: Deleting history item with ID: ${e}`);try{if(!await Vt||!Me)throw new Error("Database not initialized");const r=await Me.findOne(e).exec();if(!r){console.warn(`DB: History item with ID ${e} not found for deletion.`);return}await r.remove(),console.log(`DB: History item ${e} deleted successfully.`)}catch(t){throw console.error(`DB: Error deleting history item ${e}:`,t),t}}async function Mw(e,t){console.log(`DB: Renaming history item ID: ${e} to "${t}"`);try{if(!await Vt||!Me)throw new Error("Database not initialized");const n=await Me.findOne(e).exec();if(!n)throw new Error(`History item with ID ${e} not found for rename.`);await n.patch({title:t}),console.log(`DB: Item ${e} renamed successfully.`)}catch(r){throw console.error(`DB: Error renaming history item ${e}:`,r),r}}async function ul(e,t){console.log(`DB: Loading history from DB with limit: ${e}, skip: ${t}`);try{if(!await Vt||!Me)throw new Error("Chat history database is not initialized");const n=await Me.find().sort({timestamp:"desc"}).skip(t).limit(e).exec();return console.log(`DB: Loaded ${n.length} history entries (page).`),n.map(i=>i.toJSON())}catch(r){throw console.error("DB: Error loading paginated chat history:",r),r}}async function Tw(){console.log("DB: Getting total history count...");try{if(!await Vt||!Me)throw new Error("Chat history database is not initialized");const r=(await Me.find().exec()).length;return console.log(`DB: Total history count is ${r}.`),r}catch(e){throw console.error("DB: Error getting chat history count:",e),e}}async function Aw(e){console.log(`DB: Searching history for term: "${e}"`);try{if(!await Vt||!Me)throw new Error("Chat history database is not initialized");if(!e)return Fd();const r=e.toLowerCase(),n=await Me.find({selector:{title:{$regex:new RegExp(r,"i")}}}).sort({timestamp:"desc"}).exec();return console.log(`DB: Found ${n.length} history entries matching "${e}".`),n.map(i=>i.toJSON())}catch(t){throw console.error(`DB: Error searching chat history for "${e}":`,t),t}}const Ud=$w(),Bw=async(e,t)=>{if(await Ud,!wi||!e||!t)return console.error("deleteMessageFromChat: Missing sessionId or messageId"),!1;console.log(`DB: Attempting to delete message ID: ${t} from chat ID: ${e}`);try{const r=await wi.chatHistory.findOne(e).exec();if(!r)return console.warn(`DB: Cannot delete message, session ${e} not found.`),!1;const n=r.messages.findIndex(o=>o.messageId===t);if(n===-1)return console.warn(`DB: Cannot delete message, message ID ${t} not found in session ${e}.`),!1;const i=[...r.messages.slice(0,n),...r.messages.slice(n+1)];return await r.incrementalModify(o=>(o.messages=i,o)),console.log(`DB: Message ${t} deleted successfully from session ${e}.`),!0}catch(r){throw console.error(`DB: Error deleting message ${t} from session ${e}:`,r),r}};function Nw(){var e;console.log("Discover Page Initialized (Placeholder)"),(e=document.getElementById("page-discover"))==null||e.querySelector("p")}let cn;function qt(e,t="info",r=4e3){const n=document.getElementById("notification-banner");if(!n){console.error("Notification banner element (#notification-banner) not found in the DOM."),alert(`(${t.toUpperCase()}) ${e}`);return}cn&&(clearTimeout(cn),cn=null),n.textContent=e,n.className="notification visible",t==="error"?n.classList.add("error"):t==="success"?n.classList.add("success"):n.classList.add("info"),r>0&&(cn=setTimeout(()=>{ll()},r)),n.onclick=ll}function ll(){const e=document.getElementById("notification-banner");e&&e.classList.remove("visible"),cn&&(clearTimeout(cn),cn=null),e&&(e.onclick=null)}let ie,nt,Pt,$a,er,hr=null,Ft=!1,kc=null;const jw="1054233721282-tvskc3gdni8v4h2u1k2767a9ngbf4ong.apps.googleusercontent.com";jw.split("-")[0];function gr(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="100",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}async function ct(e){if(Pt){if(console.log(`Home: Rendering chat session ID: ${e}`),Pt.innerHTML="",!e){Ha();return}try{const t=await Gn(e);if(!t||!t.messages||t.messages.length===0)console.log(`Home: Session ${e} is empty or not found. Showing welcome.`),Ha();else{console.log(`Home: Rendering ${t.messages.length} messages for session ${e}.`);const r=Pt.scrollHeight-Pt.clientHeight<=Pt.scrollTop+1;t.messages.forEach(n=>Wd(n)),Pt.scrollTop=Pt.scrollHeight}}catch(t){console.error(`Home: Error fetching/rendering chat session ${e}:`,t),gr(`Failed to load chat: ${t.message}`),Ha()}}}const Wd=e=>{if(!Pt)return;const t=document.createElement("div");t.classList.add("flex","mb-2"),t.id=e.messageId||`msg-fallback-${Date.now()}-${Math.random()}`;const r=document.createElement("div");r.classList.add("rounded-lg","break-words","relative","group"),r.classList.add("max-w-4xl");const n=document.createElement("div");n.className="copy-button-container absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity";const i=document.createElement("button");i.innerHTML='<svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>',i.className="copy-button p-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600",i.title="Copy text",i.onclick=c=>{c.stopPropagation();let l="";l=(r.querySelector("pre code")||r.querySelector(".prose")||r).textContent||"",navigator.clipboard.writeText(l).then(()=>qt("Copied!","success",1500)).catch(v=>{console.error("Failed to copy:",v),qt("Copy failed","error",1500)})},n.appendChild(i),r.appendChild(n);let o=null;if(e.metadata&&e.metadata.type==="scrape_result"){t.classList.add("justify-start"),r.classList.add("bg-gray-200","dark:bg-gray-600","p-2");const c=document.createElement("div");c.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300"),c.textContent=`Scraped (${e.metadata.method||"Unknown"}): ${e.metadata.title||e.metadata.url||"Content"}`,r.appendChild(c);const l=document.createElement("div");l.classList.add("overflow-y-auto","max-h-64","text-sm","prose","prose-sm","dark:prose-invert","whitespace-pre-wrap"),l.textContent=e.text,r.appendChild(l)}else if(e.metadata&&e.metadata.type==="scrape_stage_result"){t.classList.add("justify-start"),r.classList.add("p-2");const c=document.createElement("div");if(c.classList.add("text-xs","font-semibold","mb-1"),e.metadata.success){r.classList.add("bg-gray-100","dark:bg-gray-700"),r.classList.add("border","border-gray-300","dark:border-gray-600"),c.classList.add("text-gray-700","dark:text-gray-300"),c.textContent=`[Stage ${e.metadata.stage} - ${e.metadata.method||"Unknown"} - Success] Length: ${e.metadata.length||0}`,r.appendChild(c);const l=document.createElement("div");l.classList.add("overflow-y-auto","max-h-64","mt-1");const d=document.createElement("pre");d.classList.add("bg-gray-800","rounded","p-2"),o=document.createElement("code"),o.className="language-json";const v={title:e.metadata.title||"N/A",segments:e.metadata.segments};o.textContent=JSON.stringify(v,null,2),d.appendChild(o),l.appendChild(d),r.appendChild(l)}else r.classList.add("bg-red-100","dark:bg-red-900"),c.classList.add("text-red-700","dark:text-red-300"),c.textContent=`[Stage ${e.metadata.stage} - Failed] Error: ${e.metadata.error||"Unknown"}`,r.appendChild(c)}else r.classList.add("p-2"),r.textContent=e.text,e.isLoading?(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-500","dark:text-gray-400","italic")):e.sender==="user"?(t.classList.add("justify-end"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-900","dark:text-gray-100","p-2")):e.sender==="error"?(t.classList.add("justify-start"),r.classList.add("bg-red-100","dark:bg-red-900","text-red-700","dark:text-red-300","p-2")):(t.classList.add("justify-start"),r.classList.add("bg-green-100","dark:bg-green-900","text-green-900","dark:text-green-100","p-2"));if(t.appendChild(r),Pt.appendChild(t),o&&window.Prism)try{Prism.highlightElement(o)}catch(c){console.error("Prism highlighting failed:",c)}},Ha=()=>{if(!Pt)return;Pt.innerHTML="",Wd({messageId:"welcome-msg",sender:"ai",text:"Welcome to Tab Agent! Ask me anything or paste a URL to scrape.",isLoading:!1}),ie&&(ie.disabled=!1),nt&&(nt.disabled=!0),it()},it=()=>{if(!ie)return;ie.style.height="auto";const e=150,t=ie.scrollHeight;ie.style.height=`${Math.min(t,e)}px`,nt&&(nt.disabled=ie.value.trim()===""||ie.disabled)};async function qw(e,t){var o,c;let r=Xt(),n=null,i=null;console.log(`Home: Handling URL Scrape Request for URL: ${e}. Active Session: ${r}`);try{const l={sender:"user",text:e,timestamp:Date.now(),isLoading:!1};r?(n=await jr(r,l),await ct(r)):(console.log("Home: No active session, creating new one for URL message."),r=await Vs(l),hr?hr(r):console.error("Home: onSessionCreatedCallback is not defined in handleUrlScrapeRequest!"),await ct(r),n=r?(c=(o=await Gn(r))==null?void 0:o.messages[0])==null?void 0:c.messageId:null);const d={messageId:Qn(r),sender:"system",text:`â³ Scraping ${e}...`,timestamp:Date.now(),isLoading:!0};i=await jr(r,d),await ct(r),ie.value="",it(),ie.disabled=!0,nt.disabled=!0,console.log(`Home: Sending TEMP_SCRAPE_URL request to background. ChatID: ${r}, MessageID: ${i}`),chrome.runtime.sendMessage({type:"TEMP_SCRAPE_URL",url:e,tabId:t,chatId:r,messageId:i})}catch(l){console.error("Home: Error processing URL scrape request:",l),gr(`Error saving/starting scrape: ${l.message}`),i&&r&&Ai(r,i,{isLoading:!1,sender:"error",text:`Failed to initiate scrape: ${l.message}`}).then(()=>ct(r)).catch(d=>console.error("DB update failed on initial error:",d)),ie.disabled=!1,it(),nt.disabled=ie.value.trim()===""}}const Fw=/^(https?):\/\/[^\s/$.?#].[^\s]*$/i;function Kw(){return new Promise((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError)return t(chrome.runtime.lastError);r&&r.length>0?e(r[0]):e(null)})})}const zd=async e=>{var c;if(Ft){console.log("Home: Already sending message, preventing double execution.");return}Ft=!0;const t=ie.value.trim();if(!t||ie.disabled){Ft=!1;return}let r=Xt(),n=null,i=null;if(console.log(`Home: Sending message. Text: "${t}". Active Session: ${r}`),Fw.test(t)){try{const l=await Kw(),d=l?l.url:null,v=S=>S?S.replace(/\/$/,""):null,m=v(t),g=v(d);if(l&&l.id&&m===g){console.log("URL matches active tab. Sending SCRAPE_ACTIVE_TAB to content script.");const S={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};r?(n=await jr(r,S),await ct(r)):(r=await Vs(S),hr?hr(r):console.error("Home: onSessionCreatedCallback is not defined! (Content Script Path)"),await ct(r));const E={messageId:Qn(r),sender:"system",text:`â³ Scraping active tab: ${t}...`,timestamp:Date.now(),isLoading:!0};i=await jr(r,E),await ct(r),ie.value="",it(),ie.disabled=!0,nt.disabled=!0,chrome.tabs.sendMessage(l.id,{type:"SCRAPE_ACTIVE_TAB"},async _=>{let D={isLoading:!1,sender:"ai"},A=!1;if(chrome.runtime.lastError)console.error("Error sending/receiving SCRAPE_ACTIVE_TAB:",chrome.runtime.lastError.message),D.sender="error",D.text=`Error scraping active tab: ${chrome.runtime.lastError.message}`;else if(_!=null&&_.success)console.log("Received successful scrape from active tab:",_),D.text=_.textContent||_.excerpt||"No text content found.",D.metadata={type:"scrape_result",method:"contentScript",url:m,title:_.title||m},A=!0;else{const j=(_==null?void 0:_.error)||"Unknown error from content script.";console.error("Content script reported scrape failure:",j),D.sender="error",D.text=`Scraping active tab failed: ${j}`}try{await Ai(r,i,D),await ct(r)}catch(j){console.error("Home: DB Error updating content script scrape result:",j),gr("Failed to save scrape result.")}ie.disabled=!1,it(),ie.focus(),Ft=!1})}else console.log("URL does not match active tab. Using background scrape."),qw(t,e)}catch(l){console.error("Error checking active tab or processing URL:",l),gr(`Error processing URL: ${l.message}`),ie.disabled=!1,it(),Ft=!1}return}try{const l={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};r?(n=await jr(r,l),await ct(r)):(r=await Vs(l),hr?hr(r):console.error("Home: onSessionCreatedCallback is not defined! (Query Path)"),await ct(r));const d={messageId:Qn(r),sender:"ai",text:"Thinking...",timestamp:Date.now(),isLoading:!0};i=await jr(r,d),await ct(r),ie.disabled=!0,nt.disabled=!0,ie.value="",it();const v={type:"query",tabId:e,text:t,model:((c=document.getElementById("model-selector"))==null?void 0:c.value)||"default",chatId:r,messageId:i};console.log("Home: Sending query to background:",v),chrome.runtime.sendMessage(v,m=>{chrome.runtime.lastError?(console.error("Home: Error sending query:",chrome.runtime.lastError.message),Ai(r,i,{isLoading:!1,sender:"error",text:`Error: Could not connect. ${chrome.runtime.lastError.message}`}).then(()=>{r===Xt()&&ct(r)}),ie.disabled=!1,it(),Ft=!1):console.log("Home: Query message sent successfully.",m)})}catch(l){console.error("Home: Error processing chat query:",l),gr(`Error sending message: ${l.message}`),ie.disabled=!1,it(),Ft=!1}};async function fl(e){if(!e.target.files||e.target.files.length===0){console.log("No file selected.");return}const t=e.target.files[0];console.log(`File selected: ${t.name}, Type: ${t.type}, Size: ${t.size} bytes`);let r=Xt();if(!r){gr("Please start a chat before attaching a file."),er&&(er.value="");return}const n={sender:"system",text:`ð Attached file: ${t.name}`,timestamp:Date.now(),isLoading:!1};try{await jr(r,n),await ct(r)}catch(i){console.error("Error adding file attachment message to chat:",i),gr("Failed to add file attachment message.")}er&&(er.value="")}function Hw(e,t){console.log(`[HomeInit] Initializing Home Page elements and listeners. Context TabID: ${e}`),kc=e,!hr&&typeof t=="function"?(console.log("[HomeInit] Storing onSessionCreatedCallback."),hr=t):typeof t!="function"&&!hr&&console.warn("[HomeInit] onSessionCreated callback was not provided or already set."),ie=document.getElementById("query-input"),nt=document.getElementById("send-button"),Pt=document.getElementById("chat-body"),$a=document.getElementById("attach-button"),er=document.getElementById("file-input"),document.getElementById("drive-button"),document.getElementById("drive-viewer-modal"),document.getElementById("drive-viewer-close"),document.getElementById("drive-viewer-list"),document.getElementById("drive-viewer-cancel"),document.getElementById("drive-viewer-insert"),document.getElementById("drive-viewer-search"),document.getElementById("drive-viewer-selected-area"),document.getElementById("drive-viewer-breadcrumbs"),document.getElementById("drive-viewer-back"),ie==null||ie.removeEventListener("input",it),ie==null||ie.addEventListener("input",it),ie==null||ie.removeEventListener("keydown",dl),ie==null||ie.addEventListener("keydown",dl),nt==null||nt.removeEventListener("click",hl),nt==null||nt.addEventListener("click",hl),$a&&er?($a.removeEventListener("click",ml),$a.addEventListener("click",ml),er.removeEventListener("change",fl),er.addEventListener("change",fl)):console.warn("Attach button or file input element not found."),console.log("Home Page Elements & Listeners Initialized."+Date.now())}function dl(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),zd(kc))}function hl(){zd(kc)}function ml(){er&&er.click()}chrome.runtime.onMessage.addListener(async(e,t,r)=>{var n;if(console.log("Home: Received message:",e,"from sender:",t),e.type!=="query"){if(e.type!=="getTabId"){if(e.type!=="popupCreated"){if(e.type!=="getPopupForTab"){if(e.type==="response"&&e.chatId&&e.messageId){const{chatId:i,messageId:o,text:c}=e;console.log(`Home: Received 'response' for chat ${i}, message ${o}`);const l={isLoading:!1,sender:"ai",text:c||"Received empty response."};(async()=>{try{await Ai(i,o,l),console.log(`Home: Updated message ${o} in chat ${i} with AI response.`),i===Xt()&&(await ct(i),ie&&(ie.disabled=!1,it(),ie.focus()),nt&&(nt.disabled=ie.value.trim()==="")),console.log("Home: Resetting isSendingMessage after processing 'response' message."),Ft=!1}catch(d){console.error(`Home: DB Error updating message ${o} for 'response' type:`,d),gr("Failed to update chat with response."),console.log("Home: Resetting isSendingMessage after DB error on 'response' message."),Ft=!1,ie&&i===Xt()&&(ie.disabled=!1,it())}})()}else if(!(e.type==="error"&&e.chatId&&e.messageId))if(e.type==="STAGE_SCRAPE_RESULT"&&e.payload){const{stage:i,success:o,chatId:c,messageId:l,error:d,...v}=e.payload;console.log(`Home: Received STAGE_SCRAPE_RESULT for Stage ${i}, chatId: ${c}, placeholderId: ${l}`);const m={messageId:Qn(c),sender:"system",timestamp:Date.now(),isLoading:!1,metadata:{type:"scrape_stage_result",stage:i,originalPlaceholderId:l,success:o}};return o?(m.text=`Stage ${i} Success (See JSON)`,m.metadata.title=v.title||v.url||"Unknown Title",m.metadata.length=((n=v.text)==null?void 0:n.length)||0,m.metadata.method=v.method,m.metadata.segments=v.segments||[],m.metadata.links=v.links||[]):(m.sender="error",m.text=`Stage ${i} Failed: ${d||"Unknown error."}`,m.metadata.error=d||"Unknown error."),(async()=>{try{i===1&&(await Ai(c,l,{text:"Scraping stages running..."}),console.log(`Home: Updated placeholder ${l} text.`)),await jr(c,m),console.log(`Home: Added stage ${i} result message to DB for chat ${c}.`),i===4&&(console.log(`Home: Deleting original placeholder message ${l} after Stage 4.`),await Bw(c,l),console.log("Home: Resetting isSendingMessage after processing Stage 4 result."),Ft=!1,ie&&c===Xt()&&(ie.disabled=!1,it(),ie.focus())),c===Xt()&&await ct(c)}catch(g){console.error(`Home: DB Error handling STAGE_SCRAPE_RESULT (Stage ${i}):`,g),gr(`Failed to record result for Stage ${i}.`),i===4&&(console.log("Home: Resetting isSendingMessage after DB error on Stage 4."),Ft=!1,ie&&c===Xt()&&(ie.disabled=!1,it()))}})(),!1}else return console.log("Home: Received message not handled by primary handlers:",e.type),!1}}}}});async function Qs(e){if(console.log(`Home: loadAndRenderChat called for session ID: ${e}`),!ie){console.warn("Home: Cannot load chat, UI elements not ready.");return}await ct(e),ie.disabled=!1,it(),ie.focus()}function ys(){console.log("Home: Resetting UI to welcome state."),Ha(),ie&&(ie.value=""),it(),ie&&ie.focus()}function Vd(e){if(!e)return"";const t=e.title||"Chat Session",r=(e.messages||[]).map(i=>{const o=i.sender==="user"?"user-message":"other-message",c=i.sender==="user"?"You":i.sender==="ai"?"Agent":"System",d=i.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return`
            <div class="message-row ${o==="user-message"?"row-user":"row-other"}">
                <div class="message-bubble ${o}">
                    <span class="sender-label">${c}:</span>
                    <div class="message-text">${d}</div>
                </div>
            </div>
        `}).join(`
`);return`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</title>
            <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: 20px auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-top: 0; }
        .chat-body { margin-top: 20px; }
        .message-row { margin-bottom: 15px; overflow: hidden; /* Clear floats */ }
        .row-user { text-align: right; }
        .row-other { text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; max-width: 75%; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; /* Align right */ }
        .other-message { background-color: #e9ecef; color: #343a40; margin-right: auto; /* Align left */ }
        .sender-label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: inherit; }
        .message-text { margin-top: 5px; }
    </style>
        </head>
        <body>
            <div class="container">
                <h1>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</h1>
                <div class="chat-body">
                    ${r}
                </div>
            </div>
        </body>
        </html>
    `}function Qd(e,t,r){try{const n=new Blob([e],{type:"text/html"}),i=URL.createObjectURL(n);console.log(`Initiating download for: ${t} (prompting user)`),chrome.downloads.download({url:i,filename:t,saveAs:!0},o=>{const c=chrome.runtime.lastError;if(setTimeout(()=>URL.revokeObjectURL(i),100),c){const l=c.message;console.error("Download API error:",l),!l||!l.toLowerCase().includes("cancel")?r?r(`Download failed: ${l||"Unknown error"}`):(console.error("No error handler provided for download failure."),alert(`Download failed: ${l||"Unknown error"}. Ensure extension has permissions.`)):console.log("Download cancelled by user.")}else console.log(o?`Download initiated (or dialog opened) with ID: ${o}`:"Download cancelled by user (no downloadId assigned).")})}catch(n){console.error("Error creating blob or initiating download:",n),r?r("An error occurred while preparing the download."):(console.error("No error handler provided for download preparation error."),alert("An error occurred while preparing the download."))}}async function Gd(){console.log("Library Page Initializing...");const e=document.getElementById("starred-list"),t=document.getElementById("library-search");if(!e){console.error("Library Page: Could not find #starred-list element.");return}const r=async(i="")=>{console.log(`Library: Rendering with filter "${i}"`);try{let c=(await Fd()).filter(l=>l.isStarred);if(i){const l=i.toLowerCase();c=c.filter(d=>(d.title||"").toLowerCase().includes(l))}if(e.innerHTML="",c.length===0){const l=i?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items match "${i}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items yet.</p>';e.innerHTML=l;return}c.sort((l,d)=>d.timestamp-l.timestamp),c.forEach(l=>{const d=Ua(l);e.appendChild(d)}),console.log(`Library Page Initialized/Refreshed: Rendered ${c.length} starred items.`)}catch(o){console.error("Library Page: Error loading or rendering starred history:",o),e.innerHTML='<div class="error-message p-4">Error loading starred items.</div>'}},n=Uw(r,300);r(),t?t.addEventListener("input",i=>{n(i.target.value.trim())}):console.warn("Library search input not found."),e.addEventListener("click",async i=>{const o=i.target,c=o.closest("button[data-action], span[data-action]"),l=o.closest(".history-item");if(!l||l.classList.contains("is-editing"))return;const d=l.dataset.id;if(!d)return;const v=c?c.dataset.action:null;if(v==="load-chat"||o.classList.contains("action-load-chat")){i.stopPropagation(),console.log(`Library: Load button clicked for ${d}`);try{Jd(d),await Qs(d),Bi("page-home")}catch(m){console.error("Library Load Error:",m),alert("Error loading chat.")}return}else if(v==="toggle-star"||o.classList.contains("history-item-star-toggle")){i.stopPropagation(),console.log(`Library: Toggling star for item ${d}`);try{await Kd(d),await r((t==null?void 0:t.value.trim())||"")}catch(m){console.error("Library Star Toggle Error:",m),alert("Error updating star status.")}return}else if(v==="delete-chat"){if(i.stopPropagation(),console.log(`Library: Delete action clicked for ${d}`),confirm("Are you sure you want to delete this chat history item? This cannot be undone."))try{await Hd(d),await r((t==null?void 0:t.value.trim())||"")}catch(m){console.error(`Library: Error deleting item ${d}:`,m),alert("Error deleting item")}return}else if(v==="share-chat"){i.stopPropagation(),console.log(`Library: Share action clicked for ${d}`),alert("Share functionality coming soon!");return}else if(v==="download-chat"){i.stopPropagation(),console.log(`Library: Download action clicked for ${d}`);try{o.textContent="...",o.disabled=!0;const m=await Gn(d);if(!m)throw new Error("Chat session not found.");const g=Vd(m),S=`${m.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()||"chat"}_${d.substring(0,5)}.html`;Qd(g,S)}catch(m){console.error(`Error preparing download for ${d}:`,m),qt(`Failed to prepare download: ${m.message}`,"error"),o.textContent="â",o.disabled=!1}return}else if(o.classList.contains("history-item-actions-btn")){i.stopPropagation(),console.log(`Library: Preview action clicked for ${d}`);try{const m=await Gn(d);if(!m||!m.messages){alert("Could not load chat data for preview.");return}const g=m.messages.slice(0,5).map(S=>`${S.sender==="user"?"You":"Agent"}: ${S.text.substring(0,100)}${S.text.length>100?"...":""}`).join(`
`);alert(`Preview of "${m.title}":
--------------------
${g}`)}catch(m){console.error("Library Preview error:",m),alert("Error loading preview.")}return}}),console.log("Library Page Initialization Complete.")}function Uw(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}function Ww(){var t;console.log("Settings Page Initialized (Placeholder)");const e=(t=document.getElementById("page-settings"))==null?void 0:t.querySelector("p");if(e){e.textContent="Settings controls will be added here.";const r=document.createElement("button");r.className="p-2 border rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 mt-2";const n=()=>{const i=document.documentElement.classList.contains("dark");r.textContent=i?"Switch to Light Mode":"Switch to Dark Mode"};r.onclick=()=>{const i=document.documentElement,o=i.classList.contains("dark");console.log(`[SettingsToggle] Before toggle - isDark: ${o}`),o?(i.classList.remove("dark"),localStorage.setItem("theme","light"),console.log("[SettingsToggle] Removed dark class, set localStorage to light")):(i.classList.add("dark"),localStorage.setItem("theme","dark"),console.log("[SettingsToggle] Added dark class, set localStorage to dark")),n(),setTimeout(()=>{const c=window.getComputedStyle(document.body),l=document.getElementById("query-input"),d=l?window.getComputedStyle(l):null,v=document.documentElement.classList.contains("dark")?"dark":"light";console.log(`[ComputedStyles - ${v} mode] body bg: ${c.getPropertyValue("background-color")}, body color: ${c.getPropertyValue("color")}`),d&&console.log(`[ComputedStyles - ${v} mode] #query-input bg: ${d.getPropertyValue("background-color")}, color: ${d.getPropertyValue("color")}`)},0)},e.parentNode.appendChild(r),n()}}function zw(){var e;console.log("Spaces Page Initialized (Placeholder)"),(e=document.getElementById("page-spaces"))==null||e.querySelector("p")}let Yd=[],Gs=[],mi=null;const bs=new Set,pl={"page-home":"Tab Agent","page-discover":"Discover","page-spaces":"Spaces","page-library":"Library","page-settings":"Settings"},vl={"page-discover":Nw,"page-library":Gd,"page-settings":Ww,"page-spaces":zw};async function Bi(e){console.log(`Navigating to ${e}`),Yd.forEach(n=>{n.classList.add("hidden"),n.classList.remove("active-page")});const t=document.getElementById(e);if(t)t.classList.remove("hidden"),t.classList.add("active-page");else{console.error(`Navigation error: Page with ID ${e} not found. Showing home.`);const n=document.getElementById("page-home");n&&(n.classList.remove("hidden"),n.classList.add("active-page")),e="page-home"}if(mi&&pl[e]?mi.textContent=pl[e]:mi&&(mi.textContent="Tab Agent"),Gs.forEach(n=>{n.dataset.page===e?n.classList.add("active"):n.classList.remove("active")}),vl[e]&&!bs.has(e))try{console.log(`Initializing ${e}...`),await vl[e](),bs.add(e),console.log(`${e} initialized.`)}catch(n){console.error(`Error initializing ${e}:`,n)}else if(e==="page-library"&&bs.has(e))try{console.log(`Re-initializing ${e} to refresh content...`),await Gd()}catch(n){console.error(`Error re-initializing ${e}:`,n)}const r=document.getElementById("query-input");e==="page-home"&&r&&r.focus()}function Vw(){console.log("Initializing navigation..."),Yd=document.querySelectorAll(".page-container"),Gs=document.querySelectorAll(".nav-button"),mi=document.querySelector("#header h1"),Gs.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&Bi(t)})}),Bi("page-home"),console.log("Navigation initialized.")}let Rt=null,Jt=null,ws=!1,gl=null,an,rt,Ma,fi,Je,Rr;function yl(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}function Mr(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="100",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function Qw(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(e.classList.add("is-editing"),t.style.display="none",r.style.display="block",r.value=t.textContent,r.focus(),r.select())}async function _s(e,t,r=!1){if(!e||!t)return;const n=e.querySelector(".history-item-preview"),i=e.querySelector(".history-item-rename-input");if(!n||!i)return;const o=i.value.trim(),c=n.textContent;if(!r&&o&&o!==c)try{console.log(`Attempting to rename item ${t} to "${o}"`),await Mw(t,o),n.textContent=o,n.title=o,console.log(`Item ${t} renamed successfully in UI.`)}catch(l){console.error(`Error renaming item ${t}:`,l),Mr(`Failed to rename chat: ${l.message}`)}else i.value=n.textContent;i.style.display="none",n.style.display="block",e.classList.remove("is-editing")}function Ua(e){const t=document.createElement("div");t.className="history-item group relative mb-2",t.dataset.id=e.id,e.isStarred&&t.classList.add("starred");const n=new Date(e.timestamp).toLocaleString(),i=e.title||(e.messages&&e.messages.length>0?(e.messages[0].text||"").substring(0,50)+"...":"Empty chat"),o='<svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 17.8798 20.1818C17.1169 21 15.8356 21 13.2731 21H10.7269C8.16438 21 6.8831 21 6.12019 20.1818C5.35728 19.3671 5.27811 18.0864 5.11973 15.5251L4.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M3 5.5H21M16.5 5.5L16.1733 3.57923C16.0596 2.8469 15.9989 2.48073 15.8184 2.21449C15.638 1.94825 15.362 1.75019 15.039 1.67153C14.7158 1.59286 14.3501 1.59286 13.6186 1.59286H10.3814C9.64993 1.59286 9.28419 1.59286 8.96099 1.67153C8.63796 1.75019 8.36201 1.94825 8.18156 2.21449C8.00111 2.48073 7.9404 2.8469 7.82672 3.57923L7.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M14 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',c='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>';t.innerHTML=`
        <div class="chat-card bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-3 flex flex-col justify-between min-h-[100px]">
            <div>
                <div class="card-header flex justify-between items-center mb-2">
                    <button data-action="toggle-star" class="action-button history-item-star-toggle ${e.isStarred?"starred":"unstarred"}" title="Toggle Star">
                         <img src="icons/star-alt-svgrepo-com.svg" alt="Star" class="w-4 h-4 action-icon-img">
                    </button>
                    <div class="actions flex items-center space-x-1">
                         <button data-action="download-chat" class="action-button" title="Download">
                              <img src="icons/download-icon-template.svg" alt="Download" class="w-4 h-4 action-icon-img"> <!-- Placeholder: Create or find a download icon -->
                         </button>
                         <button data-action="share-chat" class="action-button" title="Share">
                              <img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">
                         </button>
                         <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${o}</button>
                         <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${c}</button>
                    </div>
                </div>
                <div class="card-body mb-1 cursor-pointer" data-action="load-chat-body">
                    <div class="history-item-preview font-semibold text-sm truncate" title="${i}">${i}</div>
                    <input type="text" class="history-item-rename-input w-full text-sm p-1 border rounded" value="${i}" style="display: none;"/>
                </div>
                <!-- Hidden Preview Content Area -->
                <div class="history-item-preview-content hidden mt-2 p-2 border-t border-gray-200 dark:border-gray-600 text-xs max-h-24 overflow-y-auto">
                    <!-- Preview messages will be injected here -->
                </div>
            </div>
            <div class="card-footer mt-auto">
                 <span class="history-item-date text-xs text-gray-500 dark:text-gray-400">${n}</span>
            </div>
        </div>
    `;const l=t.querySelector(".history-item-preview"),d=t.querySelector(".history-item-rename-input");l&&d&&(l.addEventListener("dblclick",g=>{g.stopPropagation(),Qw(t)}),d.addEventListener("blur",()=>_s(t,e.id,!1)),d.addEventListener("keydown",g=>{g.key==="Enter"?(g.preventDefault(),_s(t,e.id,!1)):g.key==="Escape"&&(g.preventDefault(),_s(t,e.id,!0))}));const v=t.querySelector('[data-action="load-chat-body"]');v&&v.addEventListener("click",async()=>{t.classList.contains("is-editing")||console.log(`Card Body: Load action clicked for ${itemId}`)});const m=t.querySelector('[data-action="toggle-star"] img');return m&&(e.isStarred||m.classList.add("icon-unstarred")),t}async function Gw(){if(!Rt){console.error("Cannot detach: Missing tab ID"),Mr("Cannot detach: Missing tab ID");return}const e=Xt();try{const t=await chrome.runtime.sendMessage({type:"getPopupForTab",tabId:Rt});if(t&&t.popupId){await chrome.windows.update(t.popupId,{focused:!0});return}const r=`detachedSessionId_${Rt}`;await chrome.storage.local.set({[r]:e}),console.log(`Sidepanel: Saved session ID ${e} for detach key ${r}.`);const n=await chrome.windows.create({url:chrome.runtime.getURL(`sidepanel.html?context=popup&originalTabId=${Rt}`),type:"popup",width:400,height:600});if(n!=null&&n.id)await chrome.runtime.sendMessage({type:"popupCreated",tabId:Rt,popupId:n.id});else throw new Error("Failed to create popup window.")}catch(t){console.error("Error during detach:",t),Mr(`Error detaching chat: ${t.message}`)}}function Jd(e){console.log(`Sidepanel: Setting activeChatSessionId to ${e}`),Jt=e}function Yw(e){console.log(`Sidepanel: Updating activeChatSessionId from null to ${e}`),Jt=e}function Xt(){return Jt}document.addEventListener("DOMContentLoaded",async()=>{console.log("Sidepanel DOM Loaded. Initializing..."),an=document.getElementById("history-button"),rt=document.getElementById("history-popup"),Ma=document.getElementById("close-history"),fi=document.getElementById("history-search"),Je=document.getElementById("history-list"),Rr=document.getElementById("detach-button");const e=document.getElementById("drive-button"),t=document.getElementById("drive-viewer-modal"),r=document.getElementById("drive-viewer-list"),n=document.getElementById("drive-viewer-close"),i=document.getElementById("drive-viewer-cancel"),o=document.getElementById("drive-viewer-search"),c=document.getElementById("drive-viewer-selected-area"),l=document.getElementById("drive-viewer-breadcrumbs"),d=document.getElementById("drive-viewer-back");let v=!1,m=!1;const g=10;let S=0,E=0,_=!1,D="root",A=[{id:"root",name:"Root"}],j={},K={},Y=!1,se="";function ae(){v||t&&(m&&Se(),console.log("Sidepanel: Showing Drive Viewer modal."),D="root",A=[{id:"root",name:"Root"}],K={},j={},se="",o&&(o.value=""),et(),Re(),_e("root"),t.classList.remove("hidden"),v=!0)}function ee(){v&&t&&(console.log("Sidepanel: Hiding Drive Viewer modal."),t.classList.add("hidden"),v=!1,r&&(r.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>'))}const ne="application/vnd.google-apps.folder";function me($){if(!r)return;r.innerHTML="";const X=se.toLowerCase(),te=se?$.filter(U=>U.name.toLowerCase().includes(X)):$;if(!te||te.length===0){r.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 p-4">${se?"No results found.":"Folder is empty."}</div>`;return}te.forEach(U=>{const ye=U.mimeType===ne,pe=document.createElement("div");pe.className="drive-viewer-item flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer",pe.dataset.id=U.id,pe.dataset.name=U.name,pe.dataset.mimeType=U.mimeType,pe.dataset.iconLink=U.iconLink||"";const ze=document.createElement("div");ze.className="flex-shrink-0 w-6 h-6 mr-3 flex items-center justify-center",U.iconLink?ze.innerHTML=`<img src="${U.iconLink}" alt="${ye?"Folder":"File"}" class="w-5 h-5">`:ze.innerHTML=oe(U.mimeType);const nr=document.createElement("span");nr.className="flex-grow truncate",nr.textContent=U.name,nr.title=U.name,pe.appendChild(ze),pe.appendChild(nr),K[U.id]&&pe.classList.add("selected"),pe.addEventListener("click",Ne),r.appendChild(pe)})}function _e($){if(!(!r||Y)){if(Y=!0,console.log(`Sidepanel: Fetching Drive content for folder: ${$}`),Pe(),tt(),r.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>',j[$]){console.log(`Sidepanel: Using cached content for folder: ${$}`),me(j[$]),Y=!1;return}chrome.runtime.sendMessage({type:"getDriveFileList",folderId:$},X=>{chrome.runtime.lastError?(console.error("Sidepanel: Error sending getDriveFileList message:",chrome.runtime.lastError.message),Mr(`Error fetching folder content: ${chrome.runtime.lastError.message}`),r&&(r.innerHTML='<div class="text-center text-red-500 p-4">Error sending request.</div>'),Y=!1):console.log(`Sidepanel: Sent getDriveFileList request for ${$}. Waiting for response...`)})}}function Ne($){const X=$.currentTarget,te=X.dataset.id,U=X.dataset.name,ye=X.dataset.mimeType,pe=X.dataset.iconLink;if(!te||!ye){console.error("Sidepanel: Clicked Drive item missing ID or mimeType.");return}ye===ne?(console.log(`Sidepanel: Navigating into folder: ${U} (${te})`),D=te,A.push({id:te,name:U}),_e(te)):(console.log(`Sidepanel: Toggling selection for file: ${U} (${te})`),Ie(te,X,{id:te,name:U,mimeType:ye,iconLink:pe}))}function Pe(){l&&(l.innerHTML="",A.forEach(($,X)=>{const te=document.createElement(X===A.length-1?"span":"button");if(te.textContent=$.name,te.dataset.id=$.id,te.dataset.index=X,X<A.length-1){te.className="text-blue-600 hover:underline dark:text-blue-400 cursor-pointer",te.addEventListener("click",he);const U=document.createElement("span");U.textContent=" / ",U.className="mx-1 text-gray-400",l.appendChild(te),l.appendChild(U)}else te.className="font-semibold",l.appendChild(te)}))}function he($){const X=parseInt($.currentTarget.dataset.index,10),te=$.currentTarget.dataset.id;if(isNaN(X)||!te){console.error("Sidepanel: Invalid breadcrumb data.");return}te!==D&&(console.log(`Sidepanel: Breadcrumb click - Navigating to index ${X} (${te})`),A=A.slice(0,X+1),D=te,_e(te))}function Ie($,X,te){K[$]?(delete K[$],X==null||X.classList.remove("selected")):(K[$]=te,X==null||X.classList.add("selected")),Re(),et()}function Re(){if(!c)return;const $=Object.keys(K),X=c.querySelector(".flex-wrap")||c;X.innerHTML="",$.length===0?c.classList.add("hidden"):(c.classList.remove("hidden"),$.forEach(te=>{const U=K[te],ye=document.createElement("span");ye.className="selected-file-item inline-flex items-center bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-100 text-xs font-medium mr-2 mb-1 px-2.5 py-0.5 rounded-full",U.iconLink?ye.innerHTML=`<img src="${U.iconLink}" alt="" class="w-3 h-3 mr-1.5"> ${U.name} `:ye.textContent=U.name+" ";const pe=document.createElement("button");pe.className="selected-file-remove ml-1.5 inline-flex items-center justify-center h-4 w-4 rounded-full bg-blue-200 dark:bg-blue-700 hover:bg-blue-300 dark:hover:bg-blue-600 focus:outline-none",pe.innerHTML="&times;",pe.dataset.id=te,pe.addEventListener("click",Le),ye.appendChild(pe),X.appendChild(ye)}))}function Le($){const X=$.currentTarget.dataset.id;if(X&&K[X]){delete K[X],Re(),et();const te=r==null?void 0:r.querySelector(`.drive-viewer-item[data-id="${X}"]`);te==null||te.classList.remove("selected")}}function et(){const $=document.getElementById("drive-viewer-insert");if(!$)return;const X=Object.keys(K).length;$.disabled=X===0,$.textContent=`Insert (${X})`}const Nt=yl($=>{se=$.target.value.trim(),console.log(`Sidepanel: Filtering Drive items by term: "${se}"`),j[D]?me(j[D]):r.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Enter search term...</div>'},300);function Te(){if(A.length<=1)return;const $=A[A.length-2];A.pop(),D=$.id,console.log(`Sidepanel: Back button click - Navigating to ${$.name} (${$.id})`),_e($.id)}function tt(){d&&(A.length>1?d.classList.remove("hidden"):d.classList.add("hidden"))}function oe($){return $===ne?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'}function Se(){m&&rt&&(console.log("Hiding History popup."),rt.classList.add("hidden"),m=!1)}async function Qe(){if(_)return;const $=document.getElementById("load-more-history-btn");$&&($.textContent="Loading...",$.disabled=!0),_=!0,console.log(`Sidepanel: Loading more history items. Current skip: ${S}`);try{const X=S;console.log(`Calculated next skip: ${X}`);const te=await ul(g,X);if(!Je){_=!1;return}te.forEach(U=>{const ye=Ua(U);Je.appendChild(ye)}),S+=te.length,console.log(`Sidepanel: Updated history skip to: ${S}`),fe(te.length)}catch(X){console.error("Sidepanel: Error loading more history items:",X),Mr("Failed to load more history"),$&&$.remove()}finally{_=!1;const X=document.getElementById("load-more-history-btn");X&&(X.textContent="Load Older Chats")}}function fe($){const X=document.getElementById("load-more-history-btn");X&&X.remove();const te=(Je==null?void 0:Je.querySelectorAll(".history-item").length)||0;if(console.log(`Updating Load More button: Loaded this page: ${$}, Displayed total: ${te}, DB total count: ${E}`),te<E){const U=document.createElement("button");U.id="load-more-history-btn",U.textContent="Load Older Chats",U.className="load-more-button w-full text-center py-2 mt-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",U.addEventListener("click",Qe);const ye=rt==null?void 0:rt.querySelector(".history-content");ye?ye.appendChild(U):console.warn("Could not find .history-content to append load more button.")}else console.log("Load More button condition not met or all items loaded.")}async function je($=""){if(console.log(`Sidepanel: Rendering history list with filter: "${$}"`),!Je){console.error("History list element not found, cannot render.");return}if(_){console.log("History is already loading, skipping concurrent render request.");return}_=!0;const X=$.trim()!=="",te=document.getElementById("load-more-history-btn");te&&te.remove(),Je.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">Loading...</div>';try{if(X){console.log("Performing history search..."),S=0;const U=await Aw($);E=U.length,Je.innerHTML="",U.length===0?Je.innerHTML=`<div class="p-4 text-center text-gray-500 dark:text-gray-400">No results for "${$}"</div>`:(console.log(`Displaying ${U.length} search results.`),U.forEach(ye=>{const pe=Ua(ye);Je.appendChild(pe)}))}else{console.log("Performing initial history load."),S=0,E=await Tw();const U=await ul(g,S);Je.innerHTML="",E===0?Je.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">No chat history found</div>':(console.log(`Displaying first page: ${U.length} of ${E} items.`),U.forEach(ye=>{const pe=Ua(ye);Je.appendChild(pe)}),S=U.length,console.log(`Sidepanel: Updated history skip after initial load to: ${S}`),fe(U.length))}}catch(U){console.error("Sidepanel: Error rendering history list:",U),Je.innerHTML='<div class="p-4 text-center text-red-500">Error loading chat history</div>',Mr("Failed to render chat history")}finally{_=!1}}const mt=yl(je,300),It=new URLSearchParams(window.location.search);if(It.get("context")==="popup"&&It.has("originalTabId")){ws=!0,gl=parseInt(It.get("originalTabId"),10),Rt=gl,console.log(`Sidepanel: Running in POPUP mode for original tab ${Rt}`),Rr.style.display="none";try{const $=`detachedSessionId_${Rt}`,X=await chrome.storage.local.get([$]);if(X[$]){const te=X[$];console.log(`Sidepanel: Found detached session ID ${te} for popup (tab ${Rt})`),Jt=te,await chrome.storage.local.remove($)}else console.warn(`Sidepanel: No detached session ID found in storage for key ${$}. Popup might not load correctly.`)}catch($){console.error("Sidepanel: Error loading detached session state for popup:",$)}}else{ws=!1,console.log("Sidepanel: Running in SIDE PANEL mode.");try{const $=await chrome.runtime.sendMessage({type:"getTabId"});$!=null&&$.tabId?(Rt=$.tabId,console.log(`Sidepanel: Received currentTabId = ${Rt}`),Rr.disabled=!1):(console.error("Sidepanel: Could not get tab ID from background.",$),Rr.disabled=!0)}catch($){console.error("Sidepanel: Error requesting tab ID:",$),Rr.disabled=!0}}console.log(`[SidepanelInit] Initial documentElement className: "${document.documentElement.className}"`);try{if(console.log("Sidepanel: Waiting for DB initialization..."),!await Ud)throw new Error("Database initialization failed.");console.log("Sidepanel: DB is ready.")}catch($){console.error("Sidepanel: CRITICAL - Error during DB initialization wait:",$),Mr("Failed to initialize database. History features disabled."),an.disabled=!0;return}Vw();const zr=document.getElementById("new-chat-button");Hw(Rt,Yw),Jt?(console.log(`Sidepanel: Loading initial chat session: ${Jt}`),Qs(Jt)):ws?(console.warn("Sidepanel: Popup context loaded without an active session ID. Showing welcome/error state."),ys()):(console.log("Sidepanel: No active session ID found, showing welcome message."),ys()),an==null||an.addEventListener("click",async()=>{if(console.log(`[HistoryBtn] Clicked. isHistoryOpen: ${m}, isDriveOpen: ${v}`),m)console.log("[HistoryBtn] History is open, hiding."),Se();else{v&&(console.log("[HistoryBtn] Drive is open, attempting to hide."),ee()),console.log("[HistoryBtn] Proceeding to show history."),fi.value="";try{await je(),console.log("[HistoryBtn] Removing hidden class from historyPopup."),rt==null||rt.classList.remove("hidden"),m=!0,console.log(`[HistoryBtn] State set. isHistoryOpen: ${m}`)}catch{}}}),Ma==null||Ma.addEventListener("click",()=>{Se()}),document.addEventListener("click",$=>{m&&rt&&!rt.contains($.target)&&an&&!an.contains($.target)&&Se(),v&&t&&!t.contains($.target)&&e&&!e.contains($.target)&&ee()}),fi==null||fi.addEventListener("input",$=>{mt($.target.value.trim())}),Rr==null||Rr.addEventListener("click",Gw),zr==null||zr.addEventListener("click",()=>{if(console.log("Sidepanel: New Chat button clicked."),Jt===null){console.log("Sidepanel: Already in a new chat state.");return}Jt=null,ys(),Bi("page-home"),console.log("Sidepanel: Active session ID reset to null, UI cleared.")}),e==null||e.removeEventListener("click",ae);const ra=$=>{$.stopPropagation(),ae()};e==null||e.removeEventListener("click",ra),e==null||e.addEventListener("click",ra),n==null||n.addEventListener("click",ee),i==null||i.addEventListener("click",ee),o==null||o.addEventListener("input",Nt),d==null||d.addEventListener("click",Te),chrome.runtime.onMessage.addListener(($,X,te)=>{if(console.log("Sidepanel received message from background:",$),$.type==="driveFileListResponse"){if(console.log(`Sidepanel: Handling driveFileListResponse for folder: ${$.folderId}`),Y=!1,!v||$.folderId!==D)return console.warn(`Sidepanel: Ignoring driveFileListResponse for folder ${$.folderId}. Current: ${D}, IsOpen: ${v}`),!1;if($.success&&$.files)j[$.folderId]=$.files,me($.files);else{const U=$.error||"Unknown error fetching files.";console.error(`Sidepanel: Drive file list error for ${$.folderId}: ${U}`),Mr(`Error fetching folder content: ${U}`),r&&(r.innerHTML=`<div class="text-center text-red-500 p-4">Error loading content: ${U}</div>`)}}return!1}),console.log("Sidepanel Initialization Complete.");try{const $=document.createElement("script");$.src="assets/prism.js",$.onload=()=>{console.log("Prism Core loaded.");const X=document.createElement("script");X.src="assets/prism-json.min.js",X.onload=()=>console.log("Prism JSON component loaded."),X.onerror=()=>console.error("Failed to load Prism JSON component."),document.body.appendChild(X)},$.onerror=()=>console.error("Failed to load Prism Core."),document.body.appendChild($)}catch($){console.error("Error loading Prism scripts:",$)}Je.addEventListener("click",async $=>{var nr;const X=$.target,te=X.closest("button"),U=(te==null?void 0:te.closest("[data-action]"))||X.closest("[data-action]"),ye=X.closest(".history-item");if(!ye||ye.classList.contains("is-editing"))return;const pe=ye.dataset.id;if(!pe)return;const ze=U?U.dataset.action:null;if(ze==="toggle-star"){$.stopPropagation(),console.log(`History: Toggling star for item ${pe}`);try{const ue=await Kd(pe);ye.classList.toggle("starred",ue.isStarred);const ut=ye.querySelector(".history-item-star-toggle");ut&&(ut.classList.toggle("starred",ue.isStarred),ut.classList.toggle("unstarred",!ue.isStarred)),qt(ue.isStarred?"Chat starred.":"Chat unstarred.","success",2e3)}catch(ue){console.error("Star Toggle Error:",ue),qt(`Error starring chat: ${ue.message}`,"error")}return}else if(ze==="delete-chat"){if($.stopPropagation(),console.log(`History: Delete action clicked for ${pe}`),confirm("Are you sure you want to delete this chat history item?"))try{await Hd(pe),ye.remove(),E--,qt("Chat deleted successfully.","success"),Je.children.length===0&&E===0&&(Je.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">No chat history found</div>'),fe(0)}catch(ue){console.error(`Error deleting item ${pe}:`,ue),qt(`Error deleting chat: ${ue.message}`,"error")}return}else if(ze==="share-chat"){$.stopPropagation(),console.log(`History: Share action clicked for ${pe}`),qt("Share functionality coming soon!","info",2e3);return}else if(ze==="download-chat"){$.stopPropagation(),console.log(`History: Download action clicked for ${pe}`);const ue=U;try{const ut=ue.querySelector("img"),jt=ut?ut.src:null;ue.innerHTML="...",ue.disabled=!0;const Qt=await Gn(pe);if(!Qt)throw new Error("Chat session not found.");const Ae=Vd(Qt),Ct=`${(Qt.title||"Chat_Session").replace(/[^a-z0-9_\-\.]/gi,"_").replace(/_{2,}/g,"_")}_${pe.substring(0,8)}.html`;Qd(Ae,Ct,ir=>{qt(ir,"error"),jt?ue.innerHTML=`<img src="${jt}" alt="Download" class="w-4 h-4 action-icon-img">`:ue.innerHTML="â",ue.disabled=!1})}catch(ut){console.error(`Error preparing download for ${pe}:`,ut),qt(`Failed to prepare download: ${ut.message}`,"error");const jt=ue.querySelector("img");if(jt&&jt.getAttribute("data-original-src"),ue){const Qt=((nr=ue.querySelector("img"))==null?void 0:nr.getAttribute("src"))||"icons/download-icon-template.svg";ue.innerHTML=`<img src="${Qt}" alt="Download" class="w-4 h-4 action-icon-img">`,ue.disabled=!1}}return}else if(ze==="preview-chat"){$.stopPropagation(),console.log(`History: Preview action clicked for ${pe}`);const ue=ye.querySelector(".history-item-preview-content"),jt=U;if(!ue)return;if(!ue.classList.contains("hidden"))ue.classList.add("hidden"),ue.innerHTML="",ye.classList.remove("preview-active"),jt.innerHTML=previewIconSvg;else{document.querySelectorAll(".history-item.preview-active").forEach(Ae=>{const Vr=Ae.querySelector(".history-item-preview-content"),Ct=Ae.querySelector('[data-action="preview-chat"]');Vr&&Vr.classList.add("hidden"),Ae.classList.remove("preview-active"),Ct&&(Ct.innerHTML=previewIconSvg)}),ue.innerHTML='<span class="text-gray-500">Loading preview...</span>',ue.classList.remove("hidden"),ye.classList.add("preview-active"),jt.innerHTML='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>';try{const Ae=await Gn(pe);if(!Ae||!Ae.messages||Ae.messages.length===0){ue.innerHTML='<span class="text-gray-500">No messages in this chat.</span>';return}const Ct=Ae.messages.slice(0,3).map(ir=>{const Qr=ir.sender==="user"?"You":ir.sender==="ai"?"Agent":"System",ar=(ir.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").substring(0,100)+(ir.text.length>100?"...":"");return`<div class="preview-message"><span class="preview-sender">${Qr}:</span><span>${ar}</span></div>`}).join("");ue.innerHTML=Ct}catch(Ae){console.error("Preview error:",Ae),ue.innerHTML='<span class="text-red-500">Error loading preview.</span>',jt.innerHTML=previewIconSvg}}return}else if(ze==="load-chat-body"||!ze){if(X.closest(".history-item-rename-input"))return;const ue=ye.dataset.id;if(!ue){console.error("History Load Error: Could not get valid itemId from clicked item element.");return}if(console.log(`History: Item body clicked for ${ue}, loading chat.`),ue===Jt){console.log(`Chat ${ue} already active.`),rt==null||rt.classList.add("hidden");return}try{Jd(ue),await Qs(ue),Bi("page-home"),rt==null||rt.classList.add("hidden")}catch(ut){console.error(`Error loading chat ${ue} from history click:`,ut),qt(`Failed to load chat: ${ut.message}`,"error")}}})});
