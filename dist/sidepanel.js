var qh=Object.defineProperty;var bu=e=>{throw TypeError(e)};var Hh=(e,t,r)=>t in e?qh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var La=(e,t,r)=>Hh(e,typeof t!="symbol"?t+"":t,r),wu=(e,t,r)=>t.has(e)||bu("Cannot "+r);var V=(e,t,r)=>(wu(e,t,"read from private field"),r?r.call(e):t.get(e)),Ue=(e,t,r)=>t.has(e)?bu("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),ze=(e,t,r,n)=>(wu(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);function Di(e){"@babel/helpers - typeof";return Di=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Di(e)}function Kh(e,t){if(Di(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(Di(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function Uh(e){var t=Kh(e,"string");return Di(t)=="symbol"?t:t+""}function zh(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Uh(n.key),n)}}function Ur(e,t,r){return t&&zh(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function Wh(e){return e[e.length-1]}function uc(e){return Array.isArray(e)?e.slice(0):[e]}function Vh(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Xa(e){return Array.isArray(e)}function ls(e,t){var r=0,n=-1;for(var i of e){n=n+1;var o=t(i,n);if(o)r=r+1;else break}return r}function hn(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var i=0;i<r;++i)e[n+i]=t[i]}}function Qh(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Hr(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function br(e,t){var r=t?Hr(t._rev)+1:1;return r+"-"+e}function Gh(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var i=n,o=0;o<r;++o){var c=t[o];if(i=i[c],typeof i>"u")return i}return i}}function je(e){return Object.assign({},e)}function Yh(e){return Object.keys(e)[0]}function Za(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,i)=>typeof n=="string"&&typeof i=="string"?n.localeCompare(i):typeof n=="object"?1:-1).map(n=>Za(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,i)=>n.localeCompare(i)).forEach(n=>{r[n]=Za(e[n],t)}),r}return e}function Ms(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=Ms(e[r]);return t}var n={};for(var i in e)n[i]=Ms(e[i]);return n}var dt=Ms;function pr(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var lc=1;function Jn(){return{lwt:lc}}function zt(){return""}function Jh(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function Xh(e,t,r){if(t.length!==r.length)return!1;for(var n=0,i=t.length;n<i;){var o=t[n],c=r[n];if(n++,o._rev!==c._rev||o[e]!==c[e])return!1}return!0}async function Zh(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),i=>("00"+i.toString(16)).slice(-2)).join("");return n}var Ml=Zh;function ep(){return new Promise(e=>setTimeout(e,0))}function tp(e=0){return new Promise(t=>setTimeout(t,e))}function rp(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var np=Promise.resolve(!0),wr=Promise.resolve(!1),fc=Promise.resolve(null),At=Promise.resolve();function bo(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):tp(0)}var fs=At;function ip(e=void 0){return fs=fs.then(()=>bo(e)),fs}function ap(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var op=/\./g,_u="abcdefghijklmnopqrstuvwxyz";function Qi(e=10){for(var t="",r=0;r<e;r++)t+=_u.charAt(Math.floor(Math.random()*_u.length));return t}function $l(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function mi(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function Oi(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!Oi(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var i=Object.keys(e);if(r=i.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,i[n]))return!1;for(n=r;n--!==0;){var o=i[n];if(!Oi(e[o],t[o]))return!1}return!0}return e!==e&&t!==t}var $s=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},ds=new Set(["__proto__","prototype","constructor"]),sp=new Set("0123456789");function Ll(e){var t=[],r="",n="start",i=!1;for(var o of e)switch(o){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");i&&(r+=o),n="property",i=!i;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(i){i=!1,r+=o;break}if(ds.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(i){i=!1,r+=o;break}if(n==="property"){if(ds.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!sp.has(o))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),i&&(i=!1,r+="\\"),r+=o}}switch(i&&(r+="\\"),n){case"property":{if(ds.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function Tl(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function cp(e,t){if(Tl(e,t))throw new Error("Cannot use string index")}function Kr(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!$s(e)||typeof t!="string")return r===void 0?e:r;var n=Ll(t);if(n.length===0)return r;for(var i=0;i<n.length;i++){var o=n[i];if(Tl(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function Al(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!$s(e)||typeof t!="string")return e;for(var n=e,i=Ll(t),o=0;o<i.length;o++){var c=i[o];cp(e,c),o===i.length-1?e[c]=r:$s(e[c])||(e[c]=typeof i[o+1]=="number"?[]:{}),e=e[c]}return n}function Hn(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function Wt(e,t,r,n){var i=e.get(t);return typeof i>"u"&&(i=r(),e.set(t,i)),i}function Oe(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=$l(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function up(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var hs=0;function Ct(){var e=Date.now();e=e+.01,e<=hs&&(e=hs+.01);var t=parseFloat(e.toFixed(2));return hs=t,t}function he(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var Gi={bufferSize:1,refCount:!0},Bl="16.11.0",ps={},lp="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",Eu=16,ms=wr,Su=!1;async function Nl(){return Su||(Su=!0,ms=(async()=>!!(ps.premium&&typeof ps.premium=="string"&&await Ml(ps.premium)===lp))()),ms}function Pi(e,t){return Pi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},Pi(e,t)}function dc(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Pi(e,t)}function Ls(e){return Ls=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Ls(e)}function fp(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function jl(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(jl=function(){return!!e})()}function dp(e,t,r){if(jl())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&Pi(i,r.prototype),i}function eo(e){var t=typeof Map=="function"?new Map:void 0;return eo=function(n){if(n===null||!fp(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,i)}function i(){return dp(n,arguments,Ls(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),Pi(i,n)},eo(e)}var Ce={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return`
        RxDB Error-Code: `+e+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function hp(e){var t="";return Object.keys(e).length===0||(t+="-".repeat(20)+`
`,t+=`Parameters:
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(i=>JSON.stringify(i,Object.getOwnPropertyNames(i))):n=JSON.stringify(e[r],function(i,o){return o===void 0?null:o},2)}catch{}return r+": "+n}).join(`
`),t+=`
`),t}function Fl(e,t,r){return`
`+e+`
`+hp(r)}var pp=function(e){function t(n,i,o={}){var c,l=Fl(i,n,o);return c=e.call(this,l)||this,c.code=n,c.message=l,c.url=hc(n),c.parameters=o,c.rxdb=!0,c}dc(t,e);var r=t.prototype;return r.toString=function(){return this.message},Ur(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(eo(Error)),mp=function(e){function t(n,i,o={}){var c,l=Fl(i,n,o);return c=e.call(this,l)||this,c.code=n,c.message=l,c.url=hc(n),c.parameters=o,c.rxdb=!0,c}dc(t,e);var r=t.prototype;return r.toString=function(){return this.message},Ur(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])}(eo(TypeError));function hc(e){return"https://rxdb.info/errors.html?console=errors#"+e}function ql(e){return`
Find out more about this error here: `+hc(e)+` 
`}function Z(e,t){return new pp(e,Ce.tunnelErrorMessage(e)+ql(e),t)}function Lt(e,t){return new mp(e,Ce.tunnelErrorMessage(e)+ql(e),t)}function wo(e){return e&&e.status===409?e:!1}var vp={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function Hl(e){return Z("COL20",{name:vp[e.status],document:e.documentId,writeError:e})}var Ri={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function gt(e,t){Ri[e].length>0&&Ri[e].forEach(r=>r(t))}async function Yi(e,t){for(var r of Ri[e])await r(t)}function Kn(e,t){var r=t;r=r.replace(op,".properties."),r="properties."+r,r=mi(r);var n=Kr(e,r);return n}function gp(e,t,r){if(typeof t.primaryKey=="string")return r;var n=gn(t,r),i=r[e];if(i&&i!==n)throw Z("DOC19",{args:{documentData:r,existingPrimary:i,newPrimary:n},schema:t});return r[e]=n,r}function It(e){return typeof e=="string"?e:e.key}function yp(e){var t=It(e.primaryKey),r=Kn(e,t);return he(r.maxLength)}function gn(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var i=Kr(t,n);if(typeof i>"u")throw Z("DOC18",{args:{field:n,documentData:t}});return i}).join(r.separator)}function bp(e){var t=Za(e,!0);return t}function wp(e){return["_deleted",e]}function _o(e){e=je(e);var t=It(e.primaryKey);e.properties=je(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=_p,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=Kl(e);hn(e.required,r),e.required=e.required.filter(o=>!o.includes(".")).filter((o,c,l)=>l.indexOf(o)===c),e.version=e.version||0;var n=e.indexes.map(o=>{var c=Xa(o)?o.slice(0):[o];return c.includes(t)||c.push(t),c[0]!=="_deleted"&&c.unshift("_deleted"),c});n.length===0&&n.push(wp(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(o=>{n.push(o)});var i=new Set;return n.filter(o=>{var c=o.join(",");return i.has(c)?!1:(i.add(c),!0)}),e.indexes=n,e}var _p={type:"object",properties:{lwt:{type:"number",minimum:lc,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Kl(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=It(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function Ep(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var i=r[n];(!Object.prototype.hasOwnProperty.call(t,i)||typeof t[i]>"u")&&(t[i]=e.defaultValues[i])}return t}var Ul=function(){function e(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=Sp(this.jsonSchema),this.primaryPath=It(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw Z("SC39",{schema:r});this.finalFields=Kl(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,i){this.finalFields.forEach(o=>{if(!Oi(n[o],i[o]))throw Z("DOC9",{dataBefore:n,dataAfter:i,fieldName:o,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},i=Kn(this.jsonSchema,"");return Object.keys(i).forEach(o=>{var c=o;n.__defineGetter__(o,function(){if(!(!this.get||typeof this.get!="function")){var l=this.get(c);return l}}),Object.defineProperty(n,o+"$",{get:function(){return this.get$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"$$",{get:function(){return this.get$$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,o+"_",{get:function(){return this.populate(c)},enumerable:!1,configurable:!1})}),pr(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return gn(this.jsonSchema,n)},Ur(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,i])=>r[n]=i.default),pr(this,"defaultValues",r)}},{key:"hash",get:function(){return pr(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])}();function Sp(e){return(e.indexes||[]).map(t=>Xa(t)?t:[t])}function xp(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function kp(e,t,r=!0){r&&gt("preCreateRxSchema",e);var n=_o(e);n=bp(n),Ce.deepFreezeWhenDevMode(n);var i=new Ul(n,t);return gt("createRxSchema",i),i}function Ge(e){return typeof e=="function"}function Cp(e){return Ge(e==null?void 0:e.lift)}function ir(e){return function(t){if(Cp(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var Ts=function(e,t){return Ts=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},Ts(e,t)};function yn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Ts(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function Ip(e,t,r,n){function i(o){return o instanceof r?o:new r(function(c){c(o)})}return new(r||(r=Promise))(function(o,c){function l(m){try{v(n.next(m))}catch(g){c(g)}}function d(m){try{v(n.throw(m))}catch(g){c(g)}}function v(m){m.done?o(m.value):i(m.value).then(l,d)}v((n=n.apply(e,t||[])).next())})}function zl(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=l(0),c.throw=l(1),c.return=l(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(v){return function(m){return d([v,m])}}function d(v){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,v[0]&&(r=0)),r;)try{if(n=1,i&&(o=v[0]&2?i.return:v[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,v[1])).done)return o;switch(i=0,o&&(v=[v[0]&2,o.value]),v[0]){case 0:case 1:o=v;break;case 4:return r.label++,{value:v[1],done:!1};case 5:r.label++,i=v[1],v=[0];continue;case 7:v=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(v[0]===6||v[0]===2)){r=0;continue}if(v[0]===3&&(!o||v[1]>o[0]&&v[1]<o[3])){r.label=v[1];break}if(v[0]===6&&r.label<o[1]){r.label=o[1],o=v;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(v);break}o[2]&&r.ops.pop(),r.trys.pop();continue}v=t.call(e,r)}catch(m){v=[6,m],i=0}finally{n=o=0}if(v[0]&5)throw v[1];return{value:v[0]?v[1]:void 0,done:!0}}}function Un(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function pn(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,o=[],c;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(l){c={error:l}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return o}function mn(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}function Rn(e){return this instanceof Rn?(this.v=e,this):new Rn(e)}function Dp(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,o=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),l("next"),l("throw"),l("return",c),i[Symbol.asyncIterator]=function(){return this},i;function c(_){return function(S){return Promise.resolve(S).then(_,g)}}function l(_,S){n[_]&&(i[_]=function(P){return new Promise(function(B,j){o.push([_,P,B,j])>1||d(_,P)})},S&&(i[_]=S(i[_])))}function d(_,S){try{v(n[_](S))}catch(P){E(o[0][3],P)}}function v(_){_.value instanceof Rn?Promise.resolve(_.value.v).then(m,g):E(o[0][2],_)}function m(_){d("next",_)}function g(_){d("throw",_)}function E(_,S){_(S),o.shift(),o.length&&d(o[0][0],o[0][1])}}function Op(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof Un=="function"?Un(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(o){r[o]=e[o]&&function(c){return new Promise(function(l,d){c=e[o](c),i(l,d,c.done,c.value)})}}function i(o,c,l,d){Promise.resolve(d).then(function(v){o({value:v,done:l})},c)}}var Wl=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function Vl(e){return Ge(e==null?void 0:e.then)}function pc(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var vs=pc(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function As(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Eo=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,i,o;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var l=Un(c),d=l.next();!d.done;d=l.next()){var v=d.value;v.remove(this)}}catch(P){t={error:P}}finally{try{d&&!d.done&&(r=l.return)&&r.call(l)}finally{if(t)throw t.error}}else c.remove(this);var m=this.initialTeardown;if(Ge(m))try{m()}catch(P){o=P instanceof vs?P.errors:[P]}var g=this._finalizers;if(g){this._finalizers=null;try{for(var E=Un(g),_=E.next();!_.done;_=E.next()){var S=_.value;try{xu(S)}catch(P){o=o??[],P instanceof vs?o=mn(mn([],pn(o)),pn(P.errors)):o.push(P)}}}catch(P){n={error:P}}finally{try{_&&!_.done&&(i=E.return)&&i.call(E)}finally{if(n)throw n.error}}}if(o)throw new vs(o)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)xu(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&As(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&As(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),Ql=Eo.EMPTY;function Gl(e){return e instanceof Eo||e&&"closed"in e&&Ge(e.remove)&&Ge(e.add)&&Ge(e.unsubscribe)}function xu(e){Ge(e)?e():e.unsubscribe()}var Pp={Promise:void 0},Rp={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,mn([e,t],pn(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Yl(e){Rp.setTimeout(function(){throw e})}function ku(){}function ja(e){e()}var mc=function(e){yn(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,Gl(r)&&r.add(n)):n.destination=Lp,n}return t.create=function(r,n,i){return new zn(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Eo),Mp=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){Ta(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){Ta(n)}else Ta(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){Ta(r)}},e}(),zn=function(e){yn(t,e);function t(r,n,i){var o=e.call(this)||this,c;return Ge(r)||!r?c={next:r??void 0,error:n??void 0,complete:i??void 0}:c=r,o.destination=new Mp(c),o}return t}(mc);function Ta(e){Yl(e)}function $p(e){throw e}var Lp={closed:!0,next:ku,error:$p,complete:ku},vc=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Ji(e){return e}function Tp(e){return e.length===0?Ji:e.length===1?e[0]:function(r){return e.reduce(function(n,i){return i(n)},r)}}var xt=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var i=this,o=Bp(t)?t:new zn(t,r,n);return ja(function(){var c=i,l=c.operator,d=c.source;o.add(l?l.call(o,d):d?i._subscribe(o):i._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=Cu(r),new r(function(i,o){var c=new zn({next:function(l){try{t(l)}catch(d){o(d),c.unsubscribe()}},error:o,complete:i});n.subscribe(c)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[vc]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Tp(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=Cu(t),new t(function(n,i){var o;r.subscribe(function(c){return o=c},function(c){return i(c)},function(){return n(o)})})},e.create=function(t){return new e(t)},e}();function Cu(e){var t;return(t=e??Pp.Promise)!==null&&t!==void 0?t:Promise}function Ap(e){return e&&Ge(e.next)&&Ge(e.error)&&Ge(e.complete)}function Bp(e){return e&&e instanceof mc||Ap(e)&&Gl(e)}function Jl(e){return Ge(e[vc])}function Xl(e){return Symbol.asyncIterator&&Ge(e==null?void 0:e[Symbol.asyncIterator])}function Zl(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Np(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var ef=Np();function tf(e){return Ge(e==null?void 0:e[ef])}function rf(e){return Dp(this,arguments,function(){var r,n,i,o;return zl(this,function(c){switch(c.label){case 0:r=e.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,Rn(r.read())];case 3:return n=c.sent(),i=n.value,o=n.done,o?[4,Rn(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,Rn(i)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function nf(e){return Ge(e==null?void 0:e.getReader)}function xr(e){if(e instanceof xt)return e;if(e!=null){if(Jl(e))return jp(e);if(Wl(e))return Fp(e);if(Vl(e))return qp(e);if(Xl(e))return af(e);if(tf(e))return Hp(e);if(nf(e))return Kp(e)}throw Zl(e)}function jp(e){return new xt(function(t){var r=e[vc]();if(Ge(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Fp(e){return new xt(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function qp(e){return new xt(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Yl)})}function Hp(e){return new xt(function(t){var r,n;try{for(var i=Un(e),o=i.next();!o.done;o=i.next()){var c=o.value;if(t.next(c),t.closed)return}}catch(l){r={error:l}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}t.complete()})}function af(e){return new xt(function(t){Up(e,t).catch(function(r){return t.error(r)})})}function Kp(e){return af(rf(e))}function Up(e,t){var r,n,i,o;return Ip(this,void 0,void 0,function(){var c,l;return zl(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),r=Op(e),d.label=1;case 1:return[4,r.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(c=n.value,t.next(c),t.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=d.sent(),i={error:l},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(o=r.return)?[4,o.call(r)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function _r(e,t,r,n,i){return new zp(e,t,r,n,i)}var zp=function(e){yn(t,e);function t(r,n,i,o,c,l){var d=e.call(this,r)||this;return d.onFinalize=c,d.shouldUnsubscribe=l,d._next=n?function(v){try{n(v)}catch(m){r.error(m)}}:e.prototype._next,d._error=o?function(v){try{o(v)}catch(m){r.error(m)}finally{this.unsubscribe()}}:e.prototype._error,d._complete=i?function(){try{i()}catch(v){r.error(v)}finally{this.unsubscribe()}}:e.prototype._complete,d}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(mc),of={now:function(){return(of.delegate||Date).now()},delegate:void 0};function Wp(e){return e&&Ge(e.schedule)}function gc(e){return e[e.length-1]}function Vp(e){return Ge(gc(e))?e.pop():void 0}function Xi(e){return Wp(gc(e))?e.pop():void 0}function sf(e,t){return typeof gc(e)=="number"?e.pop():t}function qr(e,t,r,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var o=t.schedule(function(){r(),i?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(o),!i)return o}var Qp=Array.isArray,Gp=Object.getPrototypeOf,Yp=Object.prototype,Jp=Object.keys;function Xp(e){if(e.length===1){var t=e[0];if(Qp(t))return{args:t,keys:null};if(Zp(t)){var r=Jp(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function Zp(e){return e&&typeof e=="object"&&Gp(e)===Yp}function cf(e,t){return t===void 0&&(t=0),ir(function(r,n){r.subscribe(_r(n,function(i){return qr(n,e,function(){return n.next(i)},t)},function(){return qr(n,e,function(){return n.complete()},t)},function(i){return qr(n,e,function(){return n.error(i)},t)}))})}function uf(e,t){return t===void 0&&(t=0),ir(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function em(e,t){return xr(e).pipe(uf(t),cf(t))}function tm(e,t){return xr(e).pipe(uf(t),cf(t))}function rm(e,t){return new xt(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function nm(e,t){return new xt(function(r){var n;return qr(r,t,function(){n=e[ef](),qr(r,t,function(){var i,o,c;try{i=n.next(),o=i.value,c=i.done}catch(l){r.error(l);return}c?r.complete():r.next(o)},0,!0)}),function(){return Ge(n==null?void 0:n.return)&&n.return()}})}function lf(e,t){if(!e)throw new Error("Iterable cannot be null");return new xt(function(r){qr(r,t,function(){var n=e[Symbol.asyncIterator]();qr(r,t,function(){n.next().then(function(i){i.done?r.complete():r.next(i.value)})},0,!0)})})}function im(e,t){return lf(rf(e),t)}function am(e,t){if(e!=null){if(Jl(e))return em(e,t);if(Wl(e))return rm(e,t);if(Vl(e))return tm(e,t);if(Xl(e))return lf(e,t);if(tf(e))return nm(e,t);if(nf(e))return im(e,t)}throw Zl(e)}function Zi(e,t){return t?am(e,t):xr(e)}function We(e,t){return ir(function(r,n){var i=0;r.subscribe(_r(n,function(o){n.next(e.call(t,o,i++))}))})}var om=Array.isArray;function sm(e,t){return om(t)?e.apply(void 0,mn([],pn(t))):e(t)}function cm(e){return We(function(t){return sm(e,t)})}function um(e,t){return e.reduce(function(r,n,i){return r[n]=t[i],r},{})}function lm(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Xi(e),n=Vp(e),i=Xp(e),o=i.args,c=i.keys;if(o.length===0)return Zi([],r);var l=new xt(fm(o,r,c?function(d){return um(c,d)}:Ji));return n?l.pipe(cm(n)):l}function fm(e,t,r){return r===void 0&&(r=Ji),function(n){Iu(t,function(){for(var i=e.length,o=new Array(i),c=i,l=i,d=function(m){Iu(t,function(){var g=Zi(e[m],t),E=!1;g.subscribe(_r(n,function(_){o[m]=_,E||(E=!0,l--),l||n.next(r(o.slice()))},function(){--c||n.complete()}))},n)},v=0;v<i;v++)d(v)},n)}}function Iu(e,t,r){e?qr(r,e,t):t()}function dm(e,t,r,n,i,o,c,l){var d=[],v=0,m=0,g=!1,E=function(){g&&!d.length&&!v&&t.complete()},_=function(P){return v<n?S(P):d.push(P)},S=function(P){v++;var B=!1;xr(r(P,m++)).subscribe(_r(t,function(j){t.next(j)},function(){B=!0},void 0,function(){if(B)try{v--;for(var j=function(){var H=d.shift();c||S(H)};d.length&&v<n;)j();E()}catch(H){t.error(H)}}))};return e.subscribe(_r(t,_,function(){g=!0,E()})),function(){}}function Er(e,t,r){return r===void 0&&(r=1/0),Ge(t)?Er(function(n,i){return We(function(o,c){return t(n,o,i,c)})(xr(e(n,i)))},r):(typeof t=="number"&&(r=t),ir(function(n,i){return dm(n,i,e,r)}))}function yc(e){return e===void 0&&(e=1/0),Er(Ji,e)}function hm(){return yc(1)}var pm=pc(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Bt=function(e){yn(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new Du(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new pm},t.prototype.next=function(r){var n=this;ja(function(){var i,o;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var c=Un(n.currentObservers),l=c.next();!l.done;l=c.next()){var d=l.value;d.next(r)}}catch(v){i={error:v}}finally{try{l&&!l.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}}})},t.prototype.error=function(r){var n=this;ja(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var i=n.observers;i.length;)i.shift().error(r)}})},t.prototype.complete=function(){var r=this;ja(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,i=this,o=i.hasError,c=i.isStopped,l=i.observers;return o||c?Ql:(this.currentObservers=null,l.push(r),new Eo(function(){n.currentObservers=null,As(l,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,i=n.hasError,o=n.thrownError,c=n.isStopped;i?r.error(o):c&&r.complete()},t.prototype.asObservable=function(){var r=new xt;return r.source=this,r},t.create=function(r,n){return new Du(r,n)},t}(xt),Du=function(e){yn(t,e);function t(r,n){var i=e.call(this)||this;return i.destination=r,i.source=n,i}return t.prototype.next=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.next)===null||i===void 0||i.call(n,r)},t.prototype.error=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.error)===null||i===void 0||i.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,i;return(i=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&i!==void 0?i:Ql},t}(Bt);function Ou(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return hm()(Zi(e,Xi(e)))}var mm=new xt(function(e){return e.complete()});function Mi(e,t){return t===void 0&&(t=Ji),e=e??vm,ir(function(r,n){var i,o=!0;r.subscribe(_r(n,function(c){var l=t(c);(o||!e(i,l))&&(o=!1,i=l,n.next(c))}))})}function vm(e,t){return e===t}function Pe(e,t){return ir(function(r,n){var i=0;r.subscribe(_r(n,function(o){return e.call(t,o,i++)&&n.next(o)}))})}var gm=pc(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function ym(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Xi(e),n=sf(e,1/0);return ir(function(i,o){yc(n)(Zi(mn([i],pn(e)),r)).subscribe(o)})}function bm(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ym.apply(void 0,mn([],pn(e)))}var Lr=function(e){yn(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,i=r.thrownError,o=r._value;if(n)throw i;return this._throwIfClosed(),o},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(Bt),wm=function(e){yn(t,e);function t(r,n,i){r===void 0&&(r=1/0),n===void 0&&(n=1/0),i===void 0&&(i=of);var o=e.call(this)||this;return o._bufferSize=r,o._windowTime=n,o._timestampProvider=i,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=n===1/0,o._bufferSize=Math.max(1,r),o._windowTime=Math.max(1,n),o}return t.prototype.next=function(r){var n=this,i=n.isStopped,o=n._buffer,c=n._infiniteTimeWindow,l=n._timestampProvider,d=n._windowTime;i||(o.push(r),!c&&o.push(l.now()+d)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),i=this,o=i._infiniteTimeWindow,c=i._buffer,l=c.slice(),d=0;d<l.length&&!r.closed;d+=o?1:2)r.next(l[d]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,i=r._timestampProvider,o=r._buffer,c=r._infiniteTimeWindow,l=(c?1:2)*n;if(n<1/0&&l<o.length&&o.splice(0,o.length-l),!c){for(var d=i.now(),v=0,m=1;m<o.length&&o[m]<=d;m+=2)v=m;v&&o.splice(0,v+1)}},t}(Bt);function _m(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new Bt}:t,n=e.resetOnError,i=n===void 0?!0:n,o=e.resetOnComplete,c=o===void 0?!0:o,l=e.resetOnRefCountZero,d=l===void 0?!0:l;return function(v){var m,g,E,_=0,S=!1,P=!1,B=function(){g==null||g.unsubscribe(),g=void 0},j=function(){B(),m=E=void 0,S=P=!1},H=function(){var Y=m;j(),Y==null||Y.unsubscribe()};return ir(function(Y,ce){_++,!P&&!S&&B();var oe=E=E??r();ce.add(function(){_--,_===0&&!P&&!S&&(g=gs(H,d))}),oe.subscribe(ce),!m&&_>0&&(m=new zn({next:function(ee){return oe.next(ee)},error:function(ee){P=!0,B(),g=gs(j,i,ee),oe.error(ee)},complete:function(){S=!0,B(),g=gs(j,c),oe.complete()}}),xr(Y).subscribe(m))})(v)}}function gs(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var i=new zn({next:function(){i.unsubscribe(),e()}});return xr(t.apply(void 0,mn([],pn(r)))).subscribe(i)}}function ea(e,t,r){var n,i,o,c,l=!1;return e&&typeof e=="object"?(n=e.bufferSize,c=n===void 0?1/0:n,i=e.windowTime,t=i===void 0?1/0:i,o=e.refCount,l=o===void 0?!1:o,r=e.scheduler):c=e??1/0,_m({connector:function(){return new wm(c,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:l})}function ta(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Xi(e);return ir(function(n,i){(r?Ou(e,n,r):Ou(e,n)).subscribe(i)})}function Em(e,t){return ir(function(r,n){var i=null,o=0,c=!1,l=function(){return c&&!i&&n.complete()};r.subscribe(_r(n,function(d){i==null||i.unsubscribe();var v=0,m=o++;xr(e(d,m)).subscribe(i=_r(n,function(g){return n.next(t?t(d,g,m,v++):g)},function(){i=null,l()}))},function(){c=!0,l()}))})}function ff(e){return e.documentData?e.documentData:e.previousDocumentData}function Sm(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:Ce.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var xm=new Map;function df(e){return Wt(xm,e,()=>{for(var t=new Array(e.events.length),r=e.events,n=e.collectionName,i=e.isLocal,o=Ce.deepFreezeWhenDevMode,c=0;c<r.length;c++){var l=r[c];t[c]={documentId:l.documentId,collectionName:n,isLocal:i,operation:l.operation,documentData:o(l.documentData),previousDocumentData:o(l.previousDocumentData)}}return t})}function un(e,t){return new Promise(function(r,n){var i=new zn({next:function(o){r(o),i.unsubscribe()},error:n,complete:function(){n(new gm)}});e.subscribe(i)})}function km(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Xi(e),n=sf(e,1/0),i=e;return i.length?i.length===1?xr(i[0]):yc(n)(Zi(i,r)):mm}var Mn="￿",$n=Number.MIN_SAFE_INTEGER;function Cm(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var i=!!t.sort.find(m=>Object.values(m)[0]==="desc"),o=new Set;Object.keys(r).forEach(m=>{var g=Kn(e,m);g&&g.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[m],"$eq")&&o.add(m)});var c=t.sort.map(m=>Object.keys(m)[0]),l=c.filter(m=>!o.has(m)).join(","),d=-1,v;if(n.forEach(m=>{var g=!0,E=!0,_=m.map(H=>{var Y=r[H],ce=Y?Object.keys(Y):[],oe={};if(!Y||!ce.length){var ee=E?$n:Mn;oe={startKey:ee,endKey:g?Mn:$n,inclusiveStart:!0,inclusiveEnd:!0}}else ce.forEach(ie=>{if(bc.has(ie)){var me=Y[ie],we=Pm(ie,me);oe=Object.assign(oe,we)}});return typeof oe.startKey>"u"&&(oe.startKey=$n),typeof oe.endKey>"u"&&(oe.endKey=Mn),typeof oe.inclusiveStart>"u"&&(oe.inclusiveStart=!0),typeof oe.inclusiveEnd>"u"&&(oe.inclusiveEnd=!0),E&&!oe.inclusiveStart&&(E=!1),g&&!oe.inclusiveEnd&&(g=!1),oe}),S=_.map(H=>H.startKey),P=_.map(H=>H.endKey),B={index:m,startKeys:S,endKeys:P,inclusiveEnd:g,inclusiveStart:E,sortSatisfiedByIndex:!i&&l===m.filter(H=>!o.has(H)).join(","),selectorSatisfiedByIndex:Om(m,t.selector,S,P)},j=Rm(e,t,B);(j>=d||t.index)&&(d=j,v=B)}),!v)throw Z("SNH",{query:t});return v}var bc=new Set(["$eq","$gt","$gte","$lt","$lte"]),Im=new Set(["$eq","$gt","$gte"]),Dm=new Set(["$eq","$lt","$lte"]);function Om(e,t,r,n){var i=Object.entries(t),o=i.find(([ie,me])=>{if(!e.includes(ie))return!0;var we=Object.entries(me).find(([Fe,Le])=>!bc.has(Fe));return we});if(o||t.$and||t.$or)return!1;var c=[],l=new Set;for(var[d,v]of Object.entries(t)){if(!e.includes(d))return!1;var m=Object.keys(v).filter(ie=>Im.has(ie));if(m.length>1)return!1;var g=m[0];if(g&&l.add(d),g!=="$eq"){if(c.length>0)return!1;c.push(g)}}var E=[],_=new Set;for(var[S,P]of Object.entries(t)){if(!e.includes(S))return!1;var B=Object.keys(P).filter(ie=>Dm.has(ie));if(B.length>1)return!1;var j=B[0];if(j&&_.add(S),j!=="$eq"){if(E.length>0)return!1;E.push(j)}}var H=0;for(var Y of e){for(var ce of[l,_]){if(!ce.has(Y)&&ce.size>0)return!1;ce.delete(Y)}var oe=r[H],ee=n[H];if(oe!==ee&&l.size>0&&_.size>0)return!1;H++}return!0}function Pm(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function Rm(e,t,r){var n=0,i=m=>{m>0&&(n=n+m)},o=10,c=ls(r.startKeys,m=>m!==$n&&m!==Mn);i(c*o);var l=ls(r.startKeys,m=>m!==Mn&&m!==$n);i(l*o);var d=ls(r.startKeys,(m,g)=>m===r.endKeys[g]);i(d*o*1.5);var v=r.sortSatisfiedByIndex?5:0;return i(v),n}class ra extends Error{}const $i=Symbol("missing"),hf=Object.freeze(new Error("mingo: cycle detected while processing object/array")),na=e=>{const t=Fa(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},Fr=e=>typeof e!="object"&&typeof e!="function"||e===null,pf=e=>Fr(e)||Wn(e)||mr(e),mf={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},jt=(e,t)=>{e===$i&&(e=void 0),t===$i&&(t=void 0);const[r,n]=[e,t].map(i=>mf[Ti(i)]||0);return r!==n?r-n:Ut(e,t)?0:e<t?-1:e>t?1:0};var Ui,lr,on;const qc=class qc extends Map{constructor(){super();Ue(this,Ui,na);Ue(this,lr,new Map);Ue(this,on,r=>{const n=V(this,Ui).call(this,r);return[(V(this,lr).get(n)||[]).find(i=>Ut(i,r)),n]})}static init(r){const n=new qc;return r&&ze(n,Ui,r),n}clear(){super.clear(),V(this,lr).clear()}delete(r){if(Fr(r))return super.delete(r);const[n,i]=V(this,on).call(this,r);return super.delete(n)?(V(this,lr).set(i,V(this,lr).get(i).filter(o=>!Ut(o,n))),!0):!1}get(r){if(Fr(r))return super.get(r);const[n,i]=V(this,on).call(this,r);return super.get(n)}has(r){if(Fr(r))return super.has(r);const[n,i]=V(this,on).call(this,r);return super.has(n)}set(r,n){if(Fr(r))return super.set(r,n);const[i,o]=V(this,on).call(this,r);if(super.has(i))super.set(i,n);else{super.set(r,n);const c=V(this,lr).get(o)||[];c.push(r),V(this,lr).set(o,c)}return this}get size(){return super.size}};Ui=new WeakMap,lr=new WeakMap,on=new WeakMap;let Li=qc;function Ie(e,t){if(!e)throw new ra(t)}const Mm=Object.keys(mf).reduce((e,t)=>(e["[object "+t[0].toUpperCase()+t.substring(1)+"]"]=t,e),{});function Ti(e){var r,n;const t=Object.prototype.toString.call(e);return t==="[object Object]"?((n=(r=e==null?void 0:e.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":Mm[t]||t.substring(8,t.length-1).toLowerCase()}const Ln=e=>typeof e=="boolean",Vt=e=>typeof e=="string",$m=e=>typeof e=="symbol",nt=e=>!isNaN(e)&&typeof e=="number",ye=Array.isArray;function Ve(e){if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&Ti(e)==="object"}const vf=e=>!Fr(e),Wn=e=>e instanceof Date,mr=e=>e instanceof RegExp,So=e=>typeof e=="function",kt=e=>e==null,Vn=(e,t=!0)=>!!e||t&&e==="",wc=e=>kt(e)||Vt(e)&&!e||ye(e)&&e.length===0||Ve(e)&&Object.keys(e).length===0,Xn=e=>ye(e)?e:[e],Qt=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),Lm=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),Qn=(e,t)=>{if(kt(e)||Ln(e)||nt(e)||Vt(e))return e;if(Wn(e))return new Date(e);if(mr(e))return new RegExp(e);if(Lm(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw hf;t.add(e);try{if(ye(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=Qn(e[n],t);return r}if(Ve(e)){const r={};for(const n of Object.keys(e))r[n]=Qn(e[n],t);return r}}finally{t.delete(e)}return e},Pu=e=>e===$i;function Bs(e,t){if(Pu(e)||kt(e))return t;if(Pu(t)||kt(t))return e;if(Fr(e)||Fr(t))return t;ye(e)&&ye(t)&&Ie(e.length===t.length,"arrays must be of equal length to merge.");for(const r of Object.keys(t))e[r]=Bs(e[r],t[r]);return e}function gf(e,t=na){const r=[Li.init(t),Li.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(i=>{r[0].has(i)&&r[1].set(i,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function yf(e,t=1){const r=new Array;function n(i,o){for(let c=0,l=i.length;c<l;c++)ye(i[c])&&(o>0||o<0)?n(i[c],Math.max(-1,o-1)):r.push(i[c])}return n(e,t),r}function Tm(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}function bf(e){for(;e;){if(Object.getOwnPropertyNames(e).includes("toString"))return e.toString!==Object.prototype.toString;e=Object.getPrototypeOf(e)}return!1}function Ut(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object"||e.constructor!==t.constructor)return!1;if(e instanceof Date)return+e==+t;if(e instanceof RegExp)return e.toString()===t.toString();const r=e.constructor;if(r===Array||r===Object){const n=Object.keys(e).sort(),i=Object.keys(t).sort();if(n.length!==i.length)return!1;for(let o=0,c=n[o];o<n.length;c=n[++o])if(c!==i[o]||!Ut(e[c],t[c]))return!1;return!0}return bf(e)&&e.toString()===t.toString()}function Am(e,t=na){const r=Li.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}const Fa=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";if(Vt(e)||nt(e)||Ln(e))return JSON.stringify(e);if(Wn(e))return e.toISOString();if(mr(e)||$m(e)||So(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw hf;try{if(t.add(e),ye(e))return"["+e.map(n=>Fa(n,t)).join(",")+"]";if(Ve(e))return"{"+Object.keys(e).sort().map(i=>`${i}:${Fa(e[i],t)}`).join()+"}";const r=bf(e)?e.toString():Fa(Tm(e),t);return Ti(e)+"("+r+")"}finally{t.delete(e)}};function Bm(e,t){return kt(e)?null:(t=t||na,t(e))}function Nm(e,t,r=na){if(e.length<1)return new Map;const n=new Map,i=new Map;for(let o=0;o<e.length;o++){const c=e[o],l=t(c,o),d=Bm(l,r);if(d===null)i.has(null)?i.get(null).push(c):i.set(null,[c]);else{const v=n.has(d)?n.get(d).find(m=>Ut(m,l)):null;kt(v)?(i.set(l,[c]),n.has(d)?n.get(d).push(l):n.set(d,[l])):i.get(v).push(c)}}return i}function Ns(e,t){return vf(e)?e[t]:void 0}function jm(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function nr(e,t,r){let n=0;function i(c,l){let d=c;for(let v=0;v<l.length;v++){const m=l[v];if(/^\d+$/.exec(m)===null&&ye(d)){if(v===0&&n>0)break;n+=1;const E=l.slice(v);d=d.reduce((_,S)=>{const P=i(S,E);return P!==void 0&&_.push(P),_},[]);break}else d=Ns(d,m);if(d===void 0)break}return d}const o=pf(e)?e:i(e,t.split("."));return ye(o)&&(r!=null&&r.unwrapArray)?jm(o,n):o}function bi(e,t,r){const n=t.indexOf("."),i=n==-1?t:t.substring(0,n),o=t.substring(n+1),c=n!=-1;if(ye(e)){const v=/^\d+$/.test(i),m=v&&(r!=null&&r.preserveIndex)?[...e]:[];if(v){const g=parseInt(i);let E=Ns(e,g);c&&(E=bi(E,o,r)),r!=null&&r.preserveIndex?m[g]=E:m.push(E)}else for(const g of e){const E=bi(g,t,r);r!=null&&r.preserveMissing?m.push(E??$i):(E!=null||r!=null&&r.preserveIndex)&&m.push(E)}return m}const l=r!=null&&r.preserveKeys?{...e}:{};let d=Ns(e,i);if(c&&(d=bi(d,o,r)),d!==void 0)return l[i]=d,l}function js(e){if(ye(e))for(let t=e.length-1;t>=0;t--)e[t]===$i?e.splice(t,1):js(e[t]);else if(Ve(e))for(const t in e)Qt(e,t)&&js(e[t])}const Ru=/^\d+$/;function Ai(e,t,r,n){const i=t.split("."),o=i[0],c=i.slice(1).join(".");if(i.length===1)(Ve(e)||ye(e)&&Ru.test(o))&&r(e,o);else{n!=null&&n.buildGraph&&kt(e[o])&&(e[o]={});const l=e[o];if(!l)return;const d=!!(i.length>1&&Ru.test(i[1]));ye(l)&&(n!=null&&n.descendArray)&&!d?l.forEach(v=>Ai(v,c,r,n)):Ai(l,c,r,n)}}function Fm(e,t,r){Ai(e,t,(n,i)=>{n[i]=So(r)?r(n[i]):r},{buildGraph:!0})}function Mu(e,t,r){Ai(e,t,(n,i)=>{if(ye(n)){if(/^\d+$/.test(i))n.splice(parseInt(i),1);else if(r&&r.descendArray)for(const o of n)Ve(o)&&delete o[i]}else Ve(n)&&delete n[i]},r)}const qm=/^\$[a-zA-Z0-9_]+$/;function zr(e){return qm.test(e)}function wf(e){if(pf(e))return mr(e)?{$regex:e}:{$eq:e};if(vf(e)){if(!Object.keys(e).some(zr))return{$eq:e};if(Qt(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var Fs=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(Fs||{}),rt,zi,fr;const Ii=class Ii{constructor(t,r,n){Ue(this,rt);Ue(this,zi);Ue(this,fr);ze(this,rt,t),this.update(r,n)}static init(t,r,n){var i;return t instanceof Ii?new Ii(V(t,rt),t.root??r,{...V(t,fr),...n,variables:Object.assign({},(i=V(t,fr))==null?void 0:i.variables,n==null?void 0:n.variables)}):new Ii(t,r,n)}update(t,r){var i;ze(this,zi,t);const n=Object.assign({},(i=V(this,fr))==null?void 0:i.variables,r==null?void 0:r.variables);return Object.keys(n).length?ze(this,fr,{...r,variables:n}):ze(this,fr,r??{}),this}getOptions(){return Object.freeze({...V(this,rt),context:vn.from(V(this,rt).context)})}get root(){return V(this,zi)}get local(){return V(this,fr)}get idKey(){return V(this,rt).idKey}get collation(){var t;return(t=V(this,rt))==null?void 0:t.collation}get processingMode(){var t;return((t=V(this,rt))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=V(this,rt))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=V(this,rt))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=V(this,rt))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=V(this,rt))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=V(this,rt))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=V(this,rt))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=V(this,rt))==null?void 0:t.variables}get context(){var t;return(t=V(this,rt))==null?void 0:t.context}};rt=new WeakMap,zi=new WeakMap,fr=new WeakMap;let Bi=Ii;function _f(e){return e instanceof Bi?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:e!=null&&e.context?vn.from(e==null?void 0:e.context):vn.init()})}var qs=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(qs||{}),Br;const yo=class yo{constructor(){Ue(this,Br,new Map)}static init(){return new yo}static from(t){const r=yo.init();return kt(t)||V(t,Br).forEach((n,i)=>r.addOperators(i,n)),r}addOperators(t,r){V(this,Br).has(t)||V(this,Br).set(t,{});for(const[n,i]of Object.entries(r))this.getOperator(t,n)||(V(this,Br).get(t)[n]=i);return this}getOperator(t,r){return(V(this,Br).get(t)??{})[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};Br=new WeakMap;let vn=yo;const nn=vn.init();function $u(e,t){for(const[r,n]of Object.entries(t)){Ie(So(n)&&zr(r),`'${r}' is not a valid operator`);const i=Ni(e,r,null);Ie(!i||n===i,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":nn.addAccumulatorOps(t);break;case"expression":nn.addExpressionOps(t);break;case"pipeline":nn.addPipelineOps(t);break;case"projection":nn.addProjectionOps(t);break;case"query":nn.addQueryOps(t);break;case"window":nn.addWindowOps(t);break}}function Ni(e,t,r){const{context:n,useGlobalContext:i}=r||{},o=n?n.getOperator(e,t):null;return!o&&i?nn.getOperator(e,t):o}function Tt(e,t,r,n){const i=Bi.init(n,e);return r&&zr(r)?Ef(e,t,r,i):to(e,t,i)}const Hm=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function to(e,t,r){var n;if(Vt(t)&&t.length>0&&t[0]==="$"){if(Km.includes(t))return t;let i=r.root;const o=t.split(".");if(Hm.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":i=e;break;case"$$REMOVE":i=void 0;break;case"$$NOW":i=new Date;break}t=t.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){i=Object.assign({},r.variables,{this:e},(n=r==null?void 0:r.local)==null?void 0:n.variables);const c=o[0].slice(2);Ie(Qt(i,c),`Use of undefined variable: ${c}`),t=t.slice(2)}else t=t.slice(1);return t===""?i:nr(i,t)}if(ye(t))return t.map(i=>to(e,i,r));if(Ve(t)){const i={},o=Object.entries(t);for(const[c,l]of o){if(zr(c))return Ie(o.length==1,"expression must have single operator."),Ef(e,l,c,r);i[c]=to(e,l,r)}return i}return t}function Ef(e,t,r,n){const i=Ni("expression",r,n);if(i)return i(e,t,n);const o=Ni("accumulator",r,n);return Ie(!!o,`accumulator '${r}' is not registered.`),ye(e)||(e=to(e,t,n),t=null),Ie(ye(e),`arguments must resolve to array for ${r}.`),o(e,t,n)}const Km=["$$KEEP","$$PRUNE","$$DESCEND"];function ji(e){return e instanceof Lu?e:new Lu(e)}function Um(...e){let t=0;return ji(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function zm(e){return!!e&&typeof e=="object"&&(e==null?void 0:e.next)instanceof Function}function Wm(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const Hs=new Error;function Vm(e,t,r){let n=!1,i=-1,o=0;return function(c){try{e:for(;!n;){let l=e();i++;let d=-1;const v=t.length;let m=!1;for(;++d<v;){const g=t[d];switch(g.action){case 0:l=g.func(l,i);break;case 1:if(!g.func(l,i))continue e;break;case 2:--g.count,g.count||(m=!0);break;case 3:--g.count,g.count||Wm(t,d);continue e;default:break e}}if(n=m,c)r[o++]=l;else return{value:l,done:!1}}}catch(l){if(l!==Hs)throw l}return n=!0,{done:n}}}var sn,Nn,jn,Rl;let Lu=(Rl=class{constructor(t){Ue(this,sn);Ue(this,Nn);Ue(this,jn);ze(this,sn,[]),ze(this,Nn,[]),this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),zm(t)){const n=t;r=()=>{const i=n.next();if(i.done)throw Hs;return i.value}}else if(ye(t)){const n=t,i=n.length;let o=0;r=()=>{if(o<i)return n[o++];throw Hs}}else if(!(t instanceof Function))throw new ra("Lazy must be initialized with an array, generator, or function.");ze(this,jn,Vm(r,V(this,sn),V(this,Nn)))}push(t,r){return typeof r=="function"?V(this,sn).push({action:t,func:r}):typeof r=="number"&&V(this,sn).push({action:t,count:r}),this}next(){return V(this,jn).call(this)}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return ji(()=>(n||(n=ji(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=V(this,jn).call(this,!0).done),V(this,Nn)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}},sn=new WeakMap,Nn=new WeakMap,jn=new WeakMap,Rl);const Qm=(e,t,r)=>e.take(t),Sf=(e,t,r)=>wc(t)?e:(kf(t,r),e.map(xf(t,Bi.init(r))));function xf(e,t,r=!0){const n=t.idKey,i=Object.keys(e),o=new Array,c=new Array,l={};for(const _ of i){const S=e[_];if(nt(S)||Ln(S))S?c.push(_):o.push(_);else if(ye(S))l[_]=P=>S.map(B=>Tt(P,B,null,t.update(P))??null);else if(Ve(S)){const P=Object.keys(S),B=P.length==1?P[0]:"",j=Ni("projection",B,t);j?B==="$slice"&&!Xn(S[B]).every(nt)?l[_]=Y=>Tt(Y,S,_,t.update(Y)):l[_]=Y=>j(Y,S[B],_,t.update(Y)):zr(B)?l[_]=H=>Tt(H,S[B],B,t):(kf(S,t),l[_]=H=>{if(!Qt(H,_))return Tt(H,S,null,t);r&&t.update(H);const Y=nr(H,_),ce=xf(S,t,!1);return ye(Y)?Y.map(ce):Ve(Y)?ce(Y):ce(H)})}else l[_]=Vt(S)&&S[0]==="$"?P=>Tt(P,S,_,t):P=>S}const d=Object.keys(l),v=o.includes(n);if(r&&v&&o.length===1&&!c.length&&!d.length)return _=>{const S={..._};return delete S[n],S};const g=r&&!v&&!c.includes(n),E={preserveMissing:!0};return _=>{const S={};if(o.length&&!c.length){Bs(S,_);for(const P of o)Mu(S,P,{descendArray:!0})}for(const P of c){const B=bi(_,P,E)??{};Bs(S,B)}c.length&&js(S);for(const P of d){const B=l[P](_);B===void 0?Mu(S,P,{descendArray:!0}):Fm(S,P,B)}return g&&Qt(_,n)&&(S[n]=nr(_,n)),S}}function kf(e,t){let r=!1,n=!1;for(const[i,o]of Object.entries(e))Ie(!i.startsWith("$"),"Field names may not start with '$'."),Ie(!i.endsWith(".$"),"Positional projection operator '$' is not supported."),i!==(t==null?void 0:t.idKey)&&(o===0||o===!1?r=!0:(o===1||o===!0)&&(n=!0),Ie(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const Gm=(e,t,r)=>e.drop(t),Cf=(e,t,r)=>{if(wc(t)||!Ve(t))return e;let n=jt;const i=r.collation;return Ve(i)&&Vt(i.locale)&&(n=Jm(i)),e.transform(o=>{const c=Object.keys(t);for(const l of c.reverse()){const d=Nm(o,g=>nr(g,l),r.hashFunction),v=Array.from(d.keys()).sort(n);t[l]===-1&&v.reverse();let m=0;for(const g of v)for(const E of d.get(g))o[m++]=E;Ie(m==o.length,"bug: counter must match collection size.")}return o})},Ym={1:"base",2:"accent",3:"variant"};function Jm(e){const t={sensitivity:Ym[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,i)=>{if(!Vt(n)||!Vt(i))return jt(n,i);const o=r.compare(n,i);return o<0?-1:o>0?1:0}}const Xm={$sort:Cf,$skip:Gm,$limit:Qm};var Wi,Vi,Fn,dr,Nr,Et,hr;class Zm{constructor(t,r,n,i){Ue(this,Wi);Ue(this,Vi);Ue(this,Fn);Ue(this,dr);Ue(this,Nr,{});Ue(this,Et,null);Ue(this,hr,[]);ze(this,Wi,t),ze(this,Vi,r),ze(this,Fn,n),ze(this,dr,i)}fetch(){if(V(this,Et))return V(this,Et);ze(this,Et,ji(V(this,Wi)).filter(V(this,Vi)));const t=V(this,dr).processingMode;t&Fs.CLONE_INPUT&&V(this,Et).map(Qn);for(const r of["$sort","$skip","$limit"])Qt(V(this,Nr),r)&&ze(this,Et,Xm[r](V(this,Et),V(this,Nr)[r],V(this,dr)));return Object.keys(V(this,Fn)).length&&ze(this,Et,Sf(V(this,Et),V(this,Fn),V(this,dr))),t&Fs.CLONE_OUTPUT&&V(this,Et).map(Qn),V(this,Et)}fetchAll(){const t=ji([...V(this,hr)]);return ze(this,hr,[]),Um(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return V(this,Nr).$skip=t,this}limit(t){return V(this,Nr).$limit=t,this}sort(t){return V(this,Nr).$sort=t,this}collation(t){return ze(this,dr,{...V(this,dr),collation:t}),this}next(){if(V(this,hr).length>0)return V(this,hr).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(V(this,hr).length>0)return!0;const t=this.fetch().next();return t.done?!1:(V(this,hr).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}Wi=new WeakMap,Vi=new WeakMap,Fn=new WeakMap,dr=new WeakMap,Nr=new WeakMap,Et=new WeakMap,hr=new WeakMap;const ev=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));var qn,jr,cn;class Wr{constructor(t,r){Ue(this,qn);Ue(this,jr);Ue(this,cn);ze(this,cn,Qn(t)),ze(this,jr,_f(r)),ze(this,qn,[]),this.compile()}compile(){Ie(Ve(V(this,cn)),`query criteria must be an object: ${JSON.stringify(V(this,cn))}`);const t={};for(const[r,n]of Object.entries(V(this,cn))){if(r==="$where")Ie(V(this,jr).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(ev.has(r))this.processOperator(r,r,n);else{Ie(!zr(r),`unknown top level operator: ${r}`);for(const[i,o]of Object.entries(wf(n)))this.processOperator(r,i,o)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const i=Ni("query",r,V(this,jr));Ie(!!i,`unknown query operator ${r}`),V(this,qn).push(i(t,n,V(this,jr)))}test(t){return V(this,qn).every(r=>r(t))}find(t,r){return new Zm(t,n=>this.test(n),r||{},V(this,jr))}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}qn=new WeakMap,jr=new WeakMap,cn=new WeakMap;const tv=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(tv);function ht(e){return(r,n,i)=>{const o={unwrapArray:!0},c=Math.max(1,r.split(".").length-1);return l=>{const d=nr(l,r,o);return e(d,n,{...i,depth:c})}}}function Zn(e){return(t,r,n)=>{const i=Tt(t,r,null,n);return e(...i)}}function _c(e,t,r){return Ut(e,t)||kt(e)&&kt(t)?!0:ye(e)?e.some(n=>Ut(n,t))||yf(e,r==null?void 0:r.depth).some(n=>Ut(n,t)):!1}function If(e,t,r){return!_c(e,t,r)}function Df(e,t,r){return kt(e)?t.some(n=>n===null):gf([Xn(e),t],r==null?void 0:r.hashFunction).length>0}function rv(e,t,r){return!Df(e,t,r)}function Of(e,t,r){return xo(e,t,(n,i)=>jt(n,i)<0)}function Pf(e,t,r){return xo(e,t,(n,i)=>jt(n,i)<=0)}function Rf(e,t,r){return xo(e,t,(n,i)=>jt(n,i)>0)}function Mf(e,t,r){return xo(e,t,(n,i)=>jt(n,i)>=0)}function nv(e,t,r){return Xn(e).some(n=>t.length===2&&n%t[0]===t[1])}function iv(e,t,r){const n=Xn(e),i=o=>Vt(o)&&Vn(t.exec(o),r==null?void 0:r.useStrictMode);return n.some(i)||yf(n,1).some(i)}function av(e,t,r){if(!ye(e)||!ye(t)||!e.length||!t.length)return!1;let n=!0;for(const i of t){if(!n)break;Ve(i)&&Object.keys(i).includes("$elemMatch")?n=$f(e,i.$elemMatch,r):mr(i)?n=e.some(o=>typeof o=="string"&&i.test(o)):n=e.some(o=>Ut(i,o))}return n}function ov(e,t,r){return Array.isArray(e)&&e.length===t}function sv(e){return zr(e)&&["$and","$or","$nor"].indexOf(e)===-1}function $f(e,t,r){if(ye(e)&&!wc(e)){let n=c=>c,i=t;Object.keys(t).every(sv)&&(i={temp:t},n=c=>({temp:c}));const o=new Wr(i,r);for(let c=0,l=e.length;c<l;c++)if(o.test(n(e[c])))return!0}return!1}const Tu=e=>e===null,cv={array:ye,boolean:Ln,bool:Ln,date:Wn,number:nt,int:nt,long:nt,double:nt,decimal:nt,null:Tu,object:Ve,regexp:mr,regex:mr,string:Vt,undefined:kt,function:e=>{throw new ra("unsupported type key `function`.")},1:nt,2:Vt,3:Ve,4:ye,6:kt,8:Ln,9:Wn,10:Tu,11:mr,16:nt,18:nt,19:nt};function Au(e,t,r){const n=cv[t];return n?n(e):!1}function uv(e,t,r){return ye(t)?t.findIndex(n=>Au(e,n))>=0:Au(e,t)}function xo(e,t,r){return Xn(e).some(n=>Ti(n)===Ti(t)&&r(n,t))}const lv=(e,t,r)=>{const n=Tt(e,t,null,r);return Vn(n,r.useStrictMode)&&n.every(i=>Vn(i,r.useStrictMode))},fv=(e,t,r)=>{const n=Xn(t);return n.length==0?!1:(Ie(n.length==1,"Expression $not takes exactly 1 argument"),!Tt(e,n[0],null,r))},dv=(e,t,r)=>{const n=Tt(e,t,null,r),i=r.useStrictMode;return Vn(n,i)&&n.some(o=>Vn(o,i))},hv=Object.freeze(Object.defineProperty({__proto__:null,$and:lv,$not:fv,$or:dv},Symbol.toStringTag,{value:"Module"})),pv=(e,t,r)=>{const n=Tt(e,t,null,r);return Ie(ye(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),jt(n[0],n[1])},mv=Zn(_c),vv=Zn(Rf),gv=Zn(Mf),yv=Zn(Of),bv=Zn(Pf),wv=Zn(If),_v=Object.freeze(Object.defineProperty({__proto__:null,$cmp:pv,$eq:mv,$gt:vv,$gte:gv,$lt:yv,$lte:bv,$ne:wv},Symbol.toStringTag,{value:"Module"})),Bu=(e,t)=>{const r={};return e.split("").forEach((n,i)=>r[n]=t*(i+1)),r};({...Bu("ABCDEFGHIKLM",1),...Bu("NOPQRSTUVWXY",-1)});const Nu={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function Dt(e,t=Nu){const r=Object.assign({},Nu,t),n=new Set(Object.keys(r));return(i,o,c)=>{const l=Tt(i,o,null,c);if(n.has(`${l}`)){const d=r[`${l}`];if(d instanceof Error)throw new ra(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return d}return e(l)}}Dt(Math.acos,{Infinity:1/0,0:new Error});Dt(Math.acosh,{Infinity:1/0,0:new Error});Dt(Math.asin);Dt(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});Dt(Math.atan);Dt(Math.atanh,{1:1/0,"-1":-1/0});Dt(Math.cos);Dt(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const Ev=Math.PI/180;Dt(e=>e*Ev,{Infinity:1/0,"-Infinity":1/0});const Sv=180/Math.PI;Dt(e=>e*Sv,{Infinity:1/0,"-Infinity":-1/0});Dt(Math.sin);Dt(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});Dt(Math.tan);const Lf=(e,t,r)=>{Ie(ye(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(i=>new Wr(i,r));return i=>n.every(o=>o.test(i))},Ec=(e,t,r)=>{Ie(ye(t),"Invalid expression. $or expects value to be an Array");const n=t.map(i=>new Wr(i,r));return i=>n.some(o=>o.test(i))},Tf=(e,t,r)=>{Ie(ye(t),"Invalid expression. $nor expects value to be an array.");const n=Ec("$or",t,r);return i=>!n(i)},Af=(e,t,r)=>{const n={};n[e]=wf(t);const i=new Wr(n,r);return o=>!i.test(o)},Bf=ht(_c),Nf=ht(Rf),jf=ht(Mf),Ff=ht(Df),qf=ht(Of),Hf=ht(Pf),Kf=ht(If),Uf=ht(rv);function xv(e,t,r){return n=>Tt(n,t,null,r)}function kv(e,t,r){if(!(r!=null&&r.jsonSchemaValidator))throw new ra("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return i=>n(i)}const zf=ht(nv),Wf=ht(iv);function Cv(e,t,r){Ie(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return Ie(So(n),"$where only accepts a Function object"),i=>Vn(n.call(i),r==null?void 0:r.useStrictMode)}const Iv=ht(av),Vf=ht($f),Qf=ht(ov),Gf=(e,t,r)=>{const n=e.includes("."),i=!!t;return!n||e.match(/\.\d+$/)?o=>nr(o,e)!==void 0===i:o=>{const c=bi(o,e,{preserveIndex:!0}),l=nr(c,e.substring(0,e.lastIndexOf(".")));return ye(l)?l.some(d=>d!==void 0)===i:l!==void 0===i}},Yf=ht(uv);var ju=!1;function Dv(e){return ju||($u(qs.PIPELINE,{$sort:Cf,$project:Sf}),$u(qs.QUERY,{$and:Lf,$eq:Bf,$elemMatch:Vf,$exists:Gf,$gt:Nf,$gte:jf,$in:Ff,$lt:qf,$lte:Hf,$ne:Kf,$nin:Uf,$mod:zf,$nor:Tf,$not:Af,$or:Ec,$regex:Wf,$size:Qf,$type:Yf}),ju=!0),new Wr(e)}function Tn(e,t){var r=It(e.primaryKey);t=je(t);var n=dt(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([g,E])=>{(typeof E!="object"||E===null)&&(n.selector[g]={$eq:E})})):n.selector={},n.index){var i=uc(n.index);i.includes(r)||i.push(r),n.index=i}if(n.sort){var m=n.sort.find(g=>Yh(g)===r);m||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(g=>({[g]:"asc"}));else{if(e.indexes){var o=new Set;Object.entries(n.selector).forEach(([g,E])=>{var _=!1;typeof E=="object"&&E!==null?_=!!Object.keys(E).find(S=>bc.has(S)):_=!0,_&&o.add(g)});var c=-1,l;e.indexes.forEach(g=>{var E=Xa(g)?g:[g],_=E.findIndex(S=>!o.has(S));_>0&&_>c&&(c=_,l=E)}),l&&(n.sort=l.map(g=>({[g]:"asc"})))}if(!n.sort)if(e.indexes&&e.indexes.length>0){var d=e.indexes[0],v=Xa(d)?d:[d];n.sort=v.map(g=>({[g]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function Jf(e,t){if(!t.sort)throw Z("SNH",{query:t});var r=[];t.sort.forEach(i=>{var o=Object.keys(i)[0],c=Object.values(i)[0];r.push({key:o,direction:c,getValueFn:Gh(o)})});var n=(i,o)=>{for(var c=0;c<r.length;++c){var l=r[c],d=l.getValueFn(i),v=l.getValueFn(o);if(d!==v){var m=l.direction==="asc"?jt(d,v):jt(v,d);return m}}};return n}function Sc(e,t){if(!t.sort)throw Z("SNH",{query:t});var r=Dv(t.selector),n=i=>r.test(i);return n}async function Dn(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(i=>t(i)));if(r instanceof Map)return Promise.all([...r.values()].map(i=>t(i)));var n=await t(r);return n}function ko(e,t){if(!t.sort)throw Z("SNH",{query:t});var r=Cm(e,t);return{query:t,queryPlan:r}}var Ov="_rxdb_internal";async function ia(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function Fi(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var i=n.error[0];throw i}else{var o=It(e.schema.primaryKey),c=Ft(o,[t],n),l=c[0];return l}}function Pv(e,t){var r=ia(e,t),n=e.changeStream().pipe(We(i=>i.events.find(o=>o.documentId===t)),Pe(i=>!!i),We(i=>Promise.resolve(he(i).documentData)),ta(r),Em(i=>i),Pe(i=>!!i));return n}function qi(e){return Object.assign({},...e)}function ro(e,t,r,n){if(n)throw n.status===409?Z("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?Z("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function Rv(e,t,r,n,i,o,c){for(var l=!!e.schema.attachments,d=[],v=[],m=[],g=Qi(10),E={id:g,events:[],checkpoint:null,context:i},_=E.events,S=[],P=[],B=[],j=r.size>0,H,Y=n.length,ce=function(){var ee=n[oe],ie=ee.document,me=ee.previous,we=ie[t],Fe=ie._deleted,Le=me&&me._deleted,pe=void 0;j&&(pe=r.get(we));var De;if(pe){var Xe=pe._rev;if(!me||me&&Xe!==me._rev){var qt={isError:!0,status:409,documentId:we,writeRow:ee,documentInDb:pe};return m.push(qt),1}var Ne=l?ys(ee):ee;l&&(Fe?me&&Object.keys(me._attachments).forEach(fe=>{P.push({documentId:we,attachmentId:fe,digest:he(me)._attachments[fe].digest})}):(Object.entries(ie._attachments).find(([fe,Me])=>{var mt=me?me._attachments[fe]:void 0;return!mt&&!Me.data&&(De={documentId:we,documentInDb:pe,isError:!0,status:510,writeRow:ee,attachmentId:fe}),!0}),De||Object.entries(ie._attachments).forEach(([fe,Me])=>{var mt=me?me._attachments[fe]:void 0;if(!mt)S.push({documentId:we,attachmentId:fe,attachmentData:Me,digest:Me.digest});else{var Pt=Ne.document._attachments[fe].digest;Me.data&&mt.digest!==Pt&&B.push({documentId:we,attachmentId:fe,attachmentData:Me,digest:Me.digest})}}))),De?m.push(De):(l?v.push(ys(Ne)):v.push(Ne),H=Ne);var it=null,se=null,_e=null;if(Le&&!Fe)_e="INSERT",it=l?tr(ie):ie;else if(me&&!Le&&!Fe)_e="UPDATE",it=l?tr(ie):ie,se=me;else if(Fe)_e="DELETE",it=he(ie),se=me;else throw Z("SNH",{args:{writeRow:ee}});var Ye={documentId:we,documentData:it,previousDocumentData:se,operation:_e};_.push(Ye)}else{var Re=!!Fe;if(l&&Object.entries(ie._attachments).forEach(([fe,Me])=>{Me.data?S.push({documentId:we,attachmentId:fe,attachmentData:Me,digest:Me.digest}):(De={documentId:we,isError:!0,status:510,writeRow:ee,attachmentId:fe},m.push(De))}),De||(l?d.push(ys(ee)):d.push(ee),H=ee),!Re){var Te={documentId:we,operation:"INSERT",documentData:l?tr(ie):ie,previousDocumentData:l&&me?tr(me):me};_.push(Te)}}},oe=0;oe<Y;oe++)ce();return{bulkInsertDocs:d,bulkUpdateDocs:v,newestRow:H,errors:m,eventBulk:E,attachmentsAdd:S,attachmentsRemove:P,attachmentsUpdate:B}}function ys(e){return{previous:e.previous,document:tr(e.document)}}function Mv(e){return atob(e).length}function $v(e){var t=e.data;if(!t)return e;var r={length:Mv(t),digest:e.digest,type:e.type};return r}function tr(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=je(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=$v(n)}),t}function aa(e){return Object.assign({},e,{_meta:je(e._meta)})}function xc(e,t,r){Ce.deepFreezeWhenDevMode(r);var n=It(t.schema.primaryKey),i={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,async bulkWrite(o,c){for(var l=e.token,d=new Array(o.length),v=Ct(),m=0;m<o.length;m++){var g=o[m],E=aa(g.document);E._meta.lwt=v;var _=g.previous;E._rev=br(l,_),d[m]={document:E,previous:_}}gt("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:d});var S=await e.lockedRun(()=>t.bulkWrite(d,c)),P={error:[]};Zf.set(P,d);var B=S.error.length===0?[]:S.error.filter(ee=>ee.status===409&&!ee.writeRow.previous&&!ee.writeRow.document._deleted&&he(ee.documentInDb)._deleted?!0:(P.error.push(ee),!1));if(B.length>0){var j=new Set,H=B.map(ee=>(j.add(ee.documentId),{previous:ee.documentInDb,document:Object.assign({},ee.writeRow.document,{_rev:br(e.token,ee.documentInDb)})})),Y=await e.lockedRun(()=>t.bulkWrite(H,c));hn(P.error,Y.error);var ce=Ft(n,d,P,j),oe=Ft(n,H,Y);return hn(ce,oe),P}return P},query(o){return e.lockedRun(()=>t.query(o))},count(o){return e.lockedRun(()=>t.count(o))},findDocumentsById(o,c){return e.lockedRun(()=>t.findDocumentsById(o,c))},getAttachmentData(o,c,l){return e.lockedRun(()=>t.getAttachmentData(o,c,l))},getChangedDocumentsSince:t.getChangedDocumentsSince?(o,c)=>e.lockedRun(()=>t.getChangedDocumentsSince(he(o),c)):void 0,cleanup(o){return e.lockedRun(()=>t.cleanup(o))},remove(){return e.storageInstances.delete(i),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(i),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()}};return e.storageInstances.add(i),i}function Lv(e){if(e.schema.keyCompression)throw Z("UT5",{args:{params:e}});if(Ks(e.schema))throw Z("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw Z("UT7",{args:{params:e}})}function Ks(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function Tv(e,t,r){var n=It(e.schema.primaryKey),i=r?r.lwt:lc,o=r?r.id:"";return Tn(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:i}},{"_meta.lwt":{$eq:i},[n]:{$gt:r?o:""}}],"_meta.lwt":{$gte:i}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function Xf(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=It(e.schema.primaryKey),i=ko(e.schema,Tv(e,t,r)),o=await e.query(i),c=o.documents,l=Wh(c);return{documents:c,checkpoint:l?{id:l[n],lwt:l._meta.lwt}:r||{id:"",lwt:0}}}var Zf=new WeakMap,Av=new WeakMap;function Ft(e,t,r,n){return Wt(Av,r,()=>{var i=[],o=Zf.get(r);if(o||(o=t),r.error.length>0||n){for(var c=n||new Set,l=0;l<r.error.length;l++){var d=r.error[l];c.add(d.documentId)}for(var v=0;v<o.length;v++){var m=o[v].document;c.has(m[e])||i.push(tr(m))}}else{i.length=t.length-r.error.length;for(var g=0;g<o.length;g++){var E=o[g].document;i[g]=tr(E)}}return i})}var ed=function(){function e(r,n,i,o){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=i,this.postWrite=o}var t=e.prototype;return t.addWrite=function(n,i){var o=n[this.primaryPath],c=Wt(this.queueByDocId,o,()=>[]),l=new Promise((d,v)=>{var m={lastKnownDocumentState:n,modifier:i,resolve:d,reject:v};he(c).push(m),this.triggerRun()});return l},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],i=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(i.entries()).map(async([c,l])=>{var d=Bv(l.map(g=>g.lastKnownDocumentState)),v=d;for(var m of l)try{v=await m.modifier(dt(v))}catch(g){m.reject(g),m.reject=()=>{},m.resolve=()=>{}}try{await this.preWrite(v,d)}catch(g){l.forEach(E=>E.reject(g));return}n.push({previous:d,document:v})}));var o=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(Ft(this.primaryPath,n,o).map(c=>{var l=c[this.primaryPath];this.postWrite(c);var d=Hn(i,l);d.forEach(v=>v.resolve(c))})),o.error.forEach(c=>{var l=c.documentId,d=Hn(i,l),v=wo(c);if(v){var m=Wt(this.queueByDocId,l,()=>[]);d.reverse().forEach(E=>{E.lastKnownDocumentState=he(v.documentInDb),he(m).unshift(E)})}else{var g=Hl(c);d.forEach(E=>E.reject(g))}}),this.isRunning=!1,this.triggerRun()}},e}();function Fu(e){var t=async r=>{var n=Jh(r);n._deleted=r._deleted;var i=await e(n),o=Object.assign({},i,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof i._deleted<"u"?i._deleted:r._deleted});return typeof o._deleted>"u"&&(o._deleted=!1),o};return t}function Bv(e){var t=e[0],r=Hr(t._rev);return e.forEach(n=>{var i=Hr(n._rev);i>r&&(t=n,r=i)}),t}var Co={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(We(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,t=this.primary;return e.collection.eventBulks$.pipe(Pe(r=>!r.isLocal),We(r=>r.events.find(n=>n.documentId===t)),Pe(r=>!!r),We(r=>ff(he(r))),ta(e.collection._docCache.getLatestDocumentData(t)),Mi((r,n)=>r._rev===n._rev),We(r=>this.collection._docCache.getCachedRxDocument(r)),ea(Gi))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(Ce.isDevMode()){if(e.includes(".item."))throw Z("DOC1",{path:e});if(e===this.primaryPath)throw Z("DOC2");if(this.collection.schema.finalFields.includes(e))throw Z("DOC3",{path:e});var t=Kn(this.collection.schema.jsonSchema,e);if(!t)throw Z("DOC4",{path:e})}return this.$.pipe(We(r=>Kr(r,e)),Mi())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=Kn(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return fc;if(!t)throw Z("DOC5",{path:e});if(!t.ref)throw Z("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw Z("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(i=>{var o=i.values();return Array.from(o)}):n.findOne(r).exec()},get(e){return nd(this,e)},toJSON(e=!1){if(e)return Ce.deepFreezeWhenDevMode(this._data);var t=je(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,Ce.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return dt(this.toJSON(e))},update(e){throw Oe("update")},incrementalUpdate(e){throw Oe("update")},updateCRDT(e){throw Oe("crdt")},putAttachment(){throw Oe("attachments")},getAttachment(){throw Oe("attachments")},allAttachments(){throw Oe("attachments")},get allAttachments$(){throw Oe("attachments")},async modify(e,t){var r=this._data,n=await Fu(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,Fu(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=dt(t);return Object.entries(e).forEach(([n,i])=>{r[n]=i}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=je(e),this._data._deleted)throw Z("DOC11",{id:this.primary,document:this});await rd(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),i=n.error[0];return ro(this.collection,this.primary,e,i),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(Ft(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(Z("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var t=e.error[0];ro(this.collection,this.primary,this._data,t)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw Z("DOC14")}};function td(e=Co){var t=function(n,i){this.collection=n,this._data=i,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function Nv(e,t,r){var n=new e(t,r);return gt("createRxDocument",n),n}function rd(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),Ce.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function nd(e,t){return Wt(e._propertyCache,t,()=>{var r=Kr(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return Ce.deepFreezeWhenDevMode(r);var n=new Proxy(je(r),{get(i,o){if(typeof o!="string")return i[o];var c=o.charAt(o.length-1);if(c==="$")if(o.endsWith("$$")){var l=o.slice(0,-2);return e.get$$(mi(t+"."+l))}else{var d=o.slice(0,-1);return e.get$(mi(t+"."+d))}else if(c==="_"){var v=o.slice(0,-1);return e.populate(mi(t+"."+v))}else{var m=i[o];return typeof m=="number"||typeof m=="string"||typeof m=="boolean"?m:nd(e,mi(t+"."+o))}}});return n})}function kc(e){return e[e.length-1]}function jv(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function qu(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!jv(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let i=0;i<n.length;i++){const o=n[i];if(Fv(e,o)?e=i===n.length-1?void 0:null:e=e[o],e==null){if(i!==n.length-1)return r;break}}return e===void 0?r:e}function Fv(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const id=e=>!!e.queryParams.limit,qv=e=>e.queryParams.limit===1,Hv=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),Kv=e=>e.changeEvent.operation==="DELETE",Uv=e=>e.changeEvent.operation==="INSERT",zv=e=>e.changeEvent.operation==="UPDATE",Wv=e=>id(e)&&e.previousResults.length>=e.queryParams.limit,Vv=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let i=0;i<t.length;i++){const o=t[i],c=qu(r,o),l=qu(n,o);if(c!==l)return!0}return!1},Qv=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===t)return!0;return!1}},Gv=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},Yv=e=>{const t=kc(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},Jv=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Xv=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=kc(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Zv=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},eg=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=kc(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},tg=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},rg=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},ng=e=>e.previousResults.length===0,ig={0:Uv,1:zv,2:Kv,3:id,4:qv,5:Hv,6:ng,7:Wv,8:Gv,9:Yv,10:Vv,11:Qv,12:Jv,13:Xv,14:Zv,15:eg,16:tg,17:rg};function ag(e,t,r,n){var i=e.length,o=i-1,c=0;if(i===0)return e.push(t),0;for(var l;n<=o;)c=n+(o-n>>1),l=e[c],r(l,t)<=0?n=c+1:o=c-1;return r(l,t)<=0&&c++,e.splice(c,0,t),c}const og=e=>{},Cc=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Ic=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Dc=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Oc=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},sg=e=>{Dc(e),Ic(e)},cg=e=>{Oc(e),Cc(e)},ug=e=>{Dc(e),Cc(e)},lg=e=>{Oc(e),Ic(e)},ad=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},fg=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let i=0;i<n.length;i++)if(n[i][r]===e.changeEvent.id){n[i]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},dg=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},od=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(i=>i[e.queryParams.primaryKey]===t))return;ag(e.previousResults,r,e.queryParams.sortComparator,0)},hg=e=>{ad(e),od(e)},pg=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},mg=e=>{throw new Error("Action unknownAction should never be called")},vg=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],gg={doNothing:og,insertFirst:Cc,insertLast:Ic,removeFirstItem:Dc,removeLastItem:Oc,removeFirstInsertLast:sg,removeLastInsertFirst:cg,removeFirstInsertFirst:ug,removeLastInsertLast:lg,removeExisting:ad,replaceExisting:fg,alwaysWrong:dg,insertAtSortPosition:od,removeExistingAndInsertAtSortPosition:hg,runFullQueryAgain:pg,unknownAction:mg},yg=40;function bs(e){return e.charCodeAt(0)-yg}function bg(e){return e?"1":"0"}function Hu(e,t){const r=[];for(let n=0,i=e.length;n<i;n+=t)r.push(e.substring(n,n+t));return r}function wg(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,i=e.substring(2,n),o=Hu(i,2);for(let P=0;P<o.length;P++){const B=o[P],j=B.charAt(0),H=bs(B.charAt(1));t.set(j,H)}const c=e.substring(n,e.length-3),l=Hu(c,4);for(let P=0;P<l.length;P++){const B=l[P],j=B.charAt(0),H=B.charAt(1),Y=B.charAt(2),ce=bs(B.charAt(3));if(!t.has(H))throw new Error("missing node with id "+H);if(!t.has(Y))throw new Error("missing node with id "+Y);const oe=t.get(H),ee=t.get(Y),ie={l:ce,0:oe,1:ee};t.set(j,ie)}const d=e.slice(-3),v=d.charAt(0),m=d.charAt(1),g=bs(d.charAt(2)),E=t.get(v),_=t.get(m);return{l:g,0:E,1:_}}function _g(e,t,r){let n=e,i=e.l;for(;;){const o=t[i](r),c=bg(o);if(n=n[c],typeof n=="number"||typeof n=="string")return n;i=n.l}}const Eg="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9¡bf9¢bq9£cg9¤ck9¥cn9¦nd9§np9¨nq9©nf9ªng9«nm9¬nk9­mr9®ms9¯mt9°mj9±mk9²ml9³mn9´mc8µ³{8¶¯}8·°¤8¸³§8¹mn8º³«8»³m8¼m´4½z²4¾³w4¿zµ4À¯¶4Á°·4Â³º4Ã³¸4Äm¹4Åv¤7Æyn7ÇÀÁ7È~7É¥¤7ÊÃÄ7Ë¨n7Ìº¹7Í­°7Î®m7Ï¯°7Ð±m7Ñ³m7Ò¼m5ÓÄm5Ô¹m5Õ½°5Ö¾m5×¿°5ØÇÏ5ÙÂm5ÚÊÑ5Û±m5Üºm5ÝÌÑ5ÞÕÍ2ß|2à¡u2á£Å2âÖÎ2ã¦Æ2ä©x2åªÆ2æ×Ø2ç|È2è¡¢2é£É2ê¤¥2ëÙÚ2ì¦Ë2í©n2îªn2ïÛÐ2ðÜÝ2ñ¬n2òÒÓ/óan/ôbn/õcn/öÞâ/÷ßã/øàä/ùáå/úæë/ûçì/üèí/ýéî/þÍÎ/ÿÏÑ/ĀòÔ,ācn,Ăöï,ă¤ñ,Ąúð,ąêñ,ĆþÐ,ćÿÑ,Ĉac0ĉbc0Ċóõ0ċôā0Čßá0čà¤0Ďçé0ďèê0Đ÷ù0đøă0Ēûý0ēüą0ĔmÒ-ĕmĀ-ĖÞæ-ėČĎ-Ęčď-ęĂĄ-ĚĐĒ-ěđē-Ĝ²»-ĝÍÏ-ĞĆć-ğ²³-ĠĔĈ3ġĕĊ3ĢĖė3ģęĚ3ĤĢĝ(ĥĜğ(ĦģĞ(ħĠġ+Ĩĉċ+ĩĤĦ+ĪĘě+īħĨ1ĬĩĪ1ĭĬī*Įĥm*ĭĮ.";let ws;function Sg(){return ws||(ws=wg(Eg)),ws}const xg=e=>_g(Sg(),ig,e);function kg(e){const t=xg(e);return vg[t]}function Cg(e,t,r,n,i){const o=gg[e];return o({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:i}),n}function Ig(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var Dg=new WeakMap;function Og(e){return Wt(Dg,e,()=>{var t=e.collection,r=Tn(t.storageInstance.schema,dt(e.mangoQuery)),n=t.schema.primaryPath,i=Jf(t.schema.jsonSchema,r),o=(v,m)=>{var g={docA:v,docB:m};return i(g.docA,g.docB)},c=Sc(t.schema.jsonSchema,r),l=v=>{var m={doc:v};return c(m.doc)},d={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:Ig(n,r),sortComparator:o,queryMatcher:l};return d})}function Pg(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=Og(e),n=he(e._result).docsData.slice(0),i=he(e._result).docsDataMap,o=!1,c=[],l=0;l<t.length;l++){var d=t[l],v=Sm(d);v&&c.push(v)}var m=c.find(g=>{var E={queryParams:r,changeEvent:g,previousResults:n,keyDocumentMap:i},_=kg(E);if(_==="runFullQueryAgain")return!0;if(_!=="doNothing")return o=!0,Cg(_,r,g,n,i),!1});return m?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:o,newResults:n}}var Rg=function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var i=n.toString(),o=Wt(this._map,i,()=>n);return o},e}();function Mg(){return new Rg}function Ku(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function $g(e){return e.refCount$.observers.length}var Lg=100,Tg=30*1e3,Ag=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var i=Ct()-t,o=[],c=Array.from(n._map.values());for(var l of c)if(!($g(l)>0)){if(l._lastEnsureEqual===0&&l._creationTime<i){Ku(n,l);continue}o.push(l)}var d=o.length-e;if(!(d<=0)){var v=o.sort((g,E)=>g._lastEnsureEqual-E._lastEnsureEqual),m=v.slice(0,d);m.forEach(g=>Ku(n,g))}}},sd=Ag(Lg,Tg),_s=new WeakSet;function Bg(e){_s.has(e)||(_s.add(e),ep().then(()=>ip(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),_s.delete(e)}))}var cd=function(){function e(r,n,i){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(o=>{var c=o.docId,l=this.cacheItemByDocId.get(c);l&&(l[0].delete(o.revisionHeight),l[0].size===0&&this.cacheItemByDocId.delete(c))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=i,n.subscribe(o=>{this.tasks.add(()=>{for(var c=this.cacheItemByDocId,l=0;l<o.length;l++){var d=o[l],v=c.get(d.documentId);if(v){var m=d.documentData;m||(m=d.previousDocumentData),v[1]=m}}}),this.tasks.size<=1&&bo().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var i=Hn(this.cacheItemByDocId,n);return i[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var i=this.cacheItemByDocId.get(n);if(i)return i[1]},Ur(e,[{key:"getCachedRxDocuments",get:function(){var r=Uu(this);return pr(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=Uu(this);return pr(this,"getCachedRxDocument",n=>r([n])[0])}}])}();function Uu(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,i=Ce.deepFreezeWhenDevMode,o=e.documentCreator,c=l=>{for(var d=new Array(l.length),v=[],m=0;m<l.length;m++){var g=l[m],E=g[t],_=Hr(g._rev),S=void 0,P=void 0,B=r.get(E);B?(S=B[0],P=S.get(_)):(S=new Map,B=[S,g],r.set(E,B));var j=P?P.deref():void 0;j||(g=i(g),j=o(g),S.set(_,jg(j)),n&&v.push(j)),d[m]=j}return v.length>0&&n&&(e.tasks.add(()=>{for(var H=0;H<v.length;H++){var Y=v[H];n.register(Y,{docId:Y.primary,revisionHeight:Hr(Y.revision)})}}),e.tasks.size<=1&&bo().then(()=>{e.processTasks()})),d};return c}function Us(e,t){var r=e.getCachedRxDocuments;return r(t)}var Ng=typeof WeakRef=="function",jg=Ng?Fg:qg;function Fg(e){return new WeakRef(e)}function qg(e){return{deref(){return e}}}var zu=function(){function e(r,n,i){this.time=Ct(),this.query=r,this.count=i,this.documents=Us(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var i=this.query.op;if(i==="count")return this.count;if(i==="findOne"){var o=this.documents.length===0?null:this.documents[0];if(!o&&n)throw Z("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:i});return o}else return i==="findByIds"?this.docsMap:this.documents.slice(0)},Ur(e,[{key:"docsData",get:function(){return pr(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),pr(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,i=0;i<n.length;i++){var o=n[i];r.set(o.primary,o)}return pr(this,"docsMap",r)}}])}(),Hg=0,Kg=function(){return++Hg},ud=function(){function e(r,n,i,o={}){this.id=Kg(),this._execOverDatabaseCount=0,this._creationTime=Ct(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new Lr(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=wr,this.op=r,this.mangoQuery=n,this.collection=i,this.other=o,n||(this.mangoQuery=qa()),this.isFindOneByIdQuery=Vg(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw Z("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new zu(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var i=new zu(this,n,n.length);this._result=i},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var n=this.getPreparedQuery(),i=await this.collection.storageInstance.count(n);if(i.mode==="slow"&&!this.collection.database.allowSlowCount)throw Z("QU14",{collection:this.collection,queryObj:this.mangoQuery});return i.count}if(this.op==="findByIds"){var o=he(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,c=new Map,l=[];if(o.forEach(m=>{var g=this.collection._docCache.getLatestDocumentDataIfExists(m);if(g){if(!g._deleted){var E=this.collection._docCache.getCachedRxDocument(g);c.set(m,E)}}else l.push(m)}),l.length>0){var d=await this.collection.storageInstance.findDocumentsById(l,!1);d.forEach(m=>{var g=this.collection._docCache.getCachedRxDocument(m);c.set(g.primary,g)})}return c}var v=Wg(this);return v.then(m=>m)},t.exec=async function(n){if(n&&this.op!=="findOne")throw Z("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await Wu(this);var i=he(this._result);return i.getValue(n)},t.toString=function(){var n=Za({op:this.op,query:Tn(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),i=JSON.stringify(n);return this.toString=()=>i,i},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:Tn(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),gt("prePrepareQuery",n);var i=ko(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>i,i},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=async function(){var n=await this.exec();if(Array.isArray(n)){var i=await this.collection.bulkRemove(n);if(i.error.length>0)throw Hl(i.error[0]);return i.success}else return n.remove()},t.incrementalRemove=function(){return Dn(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw Oe("update")},t.patch=function(n){return Dn(this.asRxQuery,i=>i.patch(n))},t.incrementalPatch=function(n){return Dn(this.asRxQuery,i=>i.incrementalPatch(n))},t.modify=function(n){return Dn(this.asRxQuery,i=>i.modify(n))},t.incrementalModify=function(n){return Dn(this.asRxQuery,i=>i.incrementalModify(n))},t.where=function(n){throw Oe("query-builder")},t.sort=function(n){throw Oe("query-builder")},t.skip=function(n){throw Oe("query-builder")},t.limit=function(n){throw Oe("query-builder")},Ur(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(Pe(n=>!n.isLocal),ta(null),Er(()=>Wu(this)),We(()=>this._result),ea(Gi),Mi((n,i)=>!!(n&&n.time===he(i).time)),Pe(n=>!!n),We(n=>he(n).getValue()));this._$=km(r,this.refCount$.pipe(Pe(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=Tn(this.collection.schema.jsonSchema,this.mangoQuery);return pr(this,"queryMatcher",Sc(r,n))}},{key:"asRxQuery",get:function(){return this}}])}();function qa(){return{selector:{}}}function Ug(e){return e.collection._queryCache.getByQuery(e)}function On(e,t,r,n){gt("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var i=new ud(e,t,r,n);return i=Ug(i),Bg(r),i}function ld(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function Wu(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.closed||ld(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>zg(e)),e._ensureEqualQueue)}function zg(e){if(e._lastEnsureEqual=Ct(),e.collection.database.closed||ld(e))return wr;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var i=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var o=he(e._result).count,c=o;i.forEach(d=>{var v=d.previousDocumentData&&e.doesDocumentDataMatch(d.previousDocumentData),m=e.doesDocumentDataMatch(d.documentData);!v&&m&&c++,v&&!m&&c--}),c!==o&&(t=!0,e._setResultData(c))}else{var l=Pg(e,i);l.runFullQueryAgain?r=!0:l.changed&&(t=!0,e._setResultData(l.newResults))}}}return r?e._execOverDatabase().then(d=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof d=="number"?((!e._result||d!==e._result.count)&&(t=!0,e._setResultData(d)),t):((!e._result||!Xh(e.collection.schema.primaryPath,d,e._result.docsData))&&(t=!0,e._setResultData(d)),t))):Promise.resolve(t)}async function Wg(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(m=>{var g=e.collection._docCache.getLatestDocumentDataIfExists(m);return g?(g._deleted||t.push(g),!1):!0}),n.length>0){var i=await r.storageInstance.findDocumentsById(n,!1);hn(t,i)}}else{var o=e.isFindOneByIdQuery,c=e.collection._docCache.getLatestDocumentDataIfExists(o);if(!c){var l=await r.storageInstance.findDocumentsById([o],!1);l[0]&&(c=l[0])}c&&!c._deleted&&t.push(c)}else{var d=e.getPreparedQuery(),v=await r.storageInstance.query(d);t=v.documents}return t}function Vg(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var ln="collection",Pc="storage-token",Ha="rx-migration-status",Qg="rx-pipeline-checkpoint",Gg="RxInternalDocument",Rc=_o({version:0,title:Gg,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[ln,Pc,Ha,Qg,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function Gn(e,t){return gn(Rc,{key:e,context:t})}async function fd(e){var t=ko(e.schema,{selector:{context:ln,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var dd="storageToken",Yg=Gn(dd,Pc);async function Jg(e){var t=Qi(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:Yg,context:Pc,key:dd,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:Jn(),_rev:zt(),_attachments:{}},i=[{document:n}],o=await e.internalStore.bulkWrite(i,"internal-add-storage-token");if(!o.error[0])return Ft("id",i,o)[0];var c=he(o.error[0]);if(c.isError&&wo(c)){var l=c;if(!Xg(l.documentInDb.data.rxdbVersion,e.rxdbVersion))throw Z("DM5",{args:{database:e.name,databaseStateVersion:l.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==l.documentInDb.data.passwordHash)throw Z("DB1",{passwordHash:r,existingPasswordHash:l.documentInDb.data.passwordHash});var d=l.documentInDb;return he(d)}throw c}function Xg(e,t){if(!e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r==="15"&&n==="16"?!0:r===n}async function Zg(e,t,r){if(e.schema.version!==r.version)throw Z("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=zs(e.name,e.schema.jsonSchema),i=Gn(n,ln);;){var o=await ia(e.database.internalStore,i),c=dt(he(o)),l=c.data.connectedStorages.find(d=>d.collectionName===t&&d.schema.version===r.version);if(l)return;c.data.connectedStorages.push({collectionName:t,schema:r});try{await Fi(e.database.internalStore,{previous:he(o),document:c},"add-connected-storage-to-collection")}catch(d){if(!wo(d))throw d}}}function zs(e,t){return e+"-"+t.version}function Aa(e,t){return t=je(t),t=Ep(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=gp(e.primaryPath,e.jsonSchema,t)),t._meta=Jn(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=zt()),t}async function ey(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function hd(e,t,r,n,i,o,c,l){var d=await fd(t),v=d.filter(_=>_.data.name===i),m=[];v.forEach(_=>{m.push({collectionName:_.data.name,schema:_.data.schema,isCollection:!0}),_.data.connectedStorages.forEach(S=>m.push({collectionName:S.collectionName,isCollection:!1,schema:S.schema}))});var g=new Set;if(m=m.filter(_=>{var S=_.collectionName+"||"+_.schema.version;return g.has(S)?!1:(g.add(S),!0)}),await Promise.all(m.map(async _=>{var S=await e.createStorageInstance({collectionName:_.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:o,options:{},schema:_.schema,password:c,devMode:Ce.isDevMode()});await S.remove(),_.isCollection&&await Yi("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:i})})),l){var E=v.map(_=>{var S=aa(_);return S._deleted=!0,S._meta.lwt=Ct(),S._rev=br(r,_),{previous:_,document:S}});await t.bulkWrite(E,"rx-database-remove-collection-all")}}function Mt(e){if(e.closed)throw Z("COL21",{collection:e.name,version:e.schema.version})}var ty=function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(Pe(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&bo().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(i=>i()),this.tasks.clear()}},t._handleChangeEvents=function(n){var i=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(hn(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var o=i+1,c=this.eventCounterMap,l=0;l<n.length;l++){var d=n[l];c.set(d,o+l)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var i=this.buffer[0],o=this.eventCounterMap.get(i);if(n<o)return null;var c=n-o;return c},t.getFrom=function(n){this.processTasks();var i=[],o=this.getArrayIndexByPointer(n);if(o===null)return null;for(;;){var c=this.buffer[o];if(o++,c)i.push(c);else return i}},t.runFrom=function(n,i){this.processTasks();var o=this.getFrom(n);if(o===null)throw new Error("out of bounds");o.forEach(c=>i(c))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.close=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e}();function ry(e){return new ty(e)}var ny=new WeakMap;function iy(e){var t=e.schema.getDocumentPrototype(),r=sy(e),n=Co,i={};return[t,r,n].forEach(o=>{var c=Object.getOwnPropertyNames(o);c.forEach(l=>{var d=Object.getOwnPropertyDescriptor(o,l),v=!0;(l.startsWith("_")||l.endsWith("_")||l.startsWith("$")||l.endsWith("$"))&&(v=!1),typeof d.value=="function"?Object.defineProperty(i,l,{get(){return d.value.bind(this)},enumerable:v,configurable:!1}):(d.enumerable=v,d.configurable=!1,d.writable&&(d.writable=!1),Object.defineProperty(i,l,d))})}),i}function ay(e){return Wt(ny,e,()=>td(iy(e)))}function oy(e,t,r){var n=Nv(t,e,Ce.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),gt("postCreateRxDocument",n),n}function sy(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}var no={isEqual(e,t){return Oi(tr(e),tr(t))},resolve(e){return e.realMasterState}},pd=["pre","post"],md=["insert","save","remove","create"],Vu=!1,Pn=new Set,vd=function(){function e(r,n,i,o,c={},l={},d={},v={},m={},g=sd,E={},_=no){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=Mg(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=i,this.internalStorageInstance=o,this.instanceCreationOptions=c,this.migrationStrategies=l,this.methods=d,this.attachments=v,this.options=m,this.cacheReplacementPolicy=g,this.statics=E,this.conflictHandler=_,cy(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(Pe(S=>S.collectionName===this.name))),this.database&&Pn.add(this)}var t=e.prototype;return t.prepare=async function(){if(!await Nl()){for(var n=0;n<10&&Pn.size>Eu;)n++,await this.promiseWait(30);if(Pn.size>Eu)throw Z("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(Pn.values()).map(d=>({db:d.database?d.database.name:"",c:d.name}))}})}this.storageInstance=xc(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new ed(this.storageInstance,this.schema.primaryPath,(d,v)=>rd(this,d,v),d=>this._runHooks("post","save",d)),this.$=this.eventBulks$.pipe(Er(d=>df(d))),this.checkpoint$=this.eventBulks$.pipe(We(d=>d.checkpoint)),this._changeEventBuffer=ry(this.asRxCollection);var i;this._docCache=new cd(this.schema.primaryPath,this.eventBulks$.pipe(Pe(d=>!d.isLocal),We(d=>d.events)),d=>(i||(i=ay(this.asRxCollection)),oy(this.asRxCollection,i,d)));var o=this.database.internalStore.changeStream().pipe(Pe(d=>{var v=this.name+"-"+this.schema.version,m=d.events.find(g=>g.documentData.context==="collection"&&g.documentData.key===v&&g.operation==="DELETE");return!!m})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(d=>d()))});this._subs.push(o);var c=await this.database.storageToken,l=this.storageInstance.changeStream().subscribe(d=>{var v={id:d.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:c,events:d.events,databaseToken:this.database.token,checkpoint:d.checkpoint,context:d.context};this.database.$emit(v)});return this._subs.push(l),At},t.cleanup=function(n){throw Mt(this),Oe("cleanup")},t.migrationNeeded=function(){throw Oe("migration-schema")},t.getMigrationState=function(){throw Oe("migration-schema")},t.startMigration=function(n=10){return Mt(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){Mt(this);var i=await this.bulkInsert([n]),o=i.error[0];ro(this,n[this.schema.primaryPath],n,o);var c=he(i.success[0]);return c},t.insertIfNotExists=async function(n){var i=await this.bulkInsert([n]);if(i.error.length>0){var o=i.error[0];if(o.status===409){var c=o.documentInDb;return Us(this._docCache,[c])[0]}else throw o}return i.success[0]},t.bulkInsert=async function(n){if(Mt(this),n.length===0)return{success:[],error:[]};var i=this.schema.primaryPath,o=new Set,c;if(this.hasHooks("pre","insert"))c=await Promise.all(n.map(B=>{var j=Aa(this.schema,B);return this._runHooks("pre","insert",j).then(()=>(o.add(j[i]),{document:j}))}));else{c=new Array(n.length);for(var l=this.schema,d=0;d<n.length;d++){var v=n[d],m=Aa(l,v);o.add(m[i]),c[d]={document:m}}}if(o.size!==n.length)throw Z("COL22",{collection:this.name,args:{documents:n}});var g=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-insert"),E,_=this,S={get success(){if(!E){var B=Ft(_.schema.primaryPath,c,g);E=Us(_._docCache,B)}return E},error:g.error};if(this.hasHooks("post","insert")){var P=new Map;c.forEach(B=>{var j=B.document;P.set(j[i],j)}),await Promise.all(S.success.map(B=>this._runHooks("post","insert",P.get(B.primary),B)))}return S},t.bulkRemove=async function(n){Mt(this);var i=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var o;typeof n[0]=="string"?o=await this.findByIds(n).exec():(o=new Map,n.forEach(_=>o.set(_.primary,_)));var c=[],l=new Map;Array.from(o.values()).forEach(_=>{var S=_.toMutableJSON(!0);c.push(S),l.set(_.primary,S)}),await Promise.all(c.map(_=>{var S=_[this.schema.primaryPath];return this._runHooks("pre","remove",_,o.get(S))}));var d=c.map(_=>{var S=je(_);return S._deleted=!0,{previous:_,document:S}}),v=await this.storageInstance.bulkWrite(d,"rx-collection-bulk-remove"),m=Ft(this.schema.primaryPath,d,v),g=[],E=m.map(_=>{var S=_[i],P=this._docCache.getCachedRxDocument(_);return g.push(P),S});return await Promise.all(E.map(_=>this._runHooks("post","remove",l.get(_),o.get(_)))),{success:g,error:v.error}},t.bulkUpsert=async function(n){Mt(this);var i=[],o=new Map;n.forEach(v=>{var m=Aa(this.schema,v),g=m[this.schema.primaryPath];if(!g)throw Z("COL3",{primaryPath:this.schema.primaryPath,data:m,schema:this.schema.jsonSchema});o.set(g,m),i.push(m)});var c=await this.bulkInsert(i),l=c.success.slice(0),d=[];return await Promise.all(c.error.map(async v=>{if(v.status!==409)d.push(v);else{var m=v.documentId,g=Hn(o,m),E=he(v.documentInDb),_=this._docCache.getCachedRxDocuments([E])[0],S=await _.incrementalModify(()=>g);l.push(S)}})),{error:d,success:l}},t.upsert=async function(n){Mt(this);var i=await this.bulkUpsert([n]);return ro(this.asRxCollection,n[this.schema.primaryPath],n,i.error[0]),i.success[0]},t.incrementalUpsert=function(n){Mt(this);var i=Aa(this.schema,n),o=i[this.schema.primaryPath];if(!o)throw Z("COL4",{data:n});var c=this._incrementalUpsertQueues.get(o);return c||(c=At),c=c.then(()=>ly(this,o,i)).then(l=>l.inserted?l.doc:uy(l.doc,i)),this._incrementalUpsertQueues.set(o,c),c},t.find=function(n){Mt(this),gt("prePrepareRxQuery",{op:"find",queryObj:n,collection:this}),n||(n=qa());var i=On("find",n,this);return i},t.findOne=function(n){Mt(this),gt("prePrepareRxQuery",{op:"findOne",queryObj:n,collection:this});var i;if(typeof n=="string")i=On("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=qa()),n.limit)throw Z("QU6");n=je(n),n.limit=1,i=On("findOne",n,this)}return i},t.count=function(n){Mt(this),n||(n=qa());var i=On("count",n,this);return i},t.findByIds=function(n){Mt(this);var i={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},o=On("findByIds",i,this);return o},t.exportJSON=function(){throw Oe("json-dump")},t.importJSON=function(n){throw Oe("json-dump")},t.insertCRDT=function(n){throw Oe("crdt")},t.addPipeline=function(n){throw Oe("pipeline")},t.addHook=function(n,i,o,c=!1){if(typeof o!="function")throw Lt("COL7",{key:i,when:n});if(!pd.includes(n))throw Lt("COL8",{key:i,when:n});if(!md.includes(i))throw Z("COL9",{key:i});if(n==="post"&&i==="create"&&c===!0)throw Z("COL10",{when:n,key:i,parallel:c});var l=o.bind(this),d=c?"parallel":"series";this.hooks[i]=this.hooks[i]||{},this.hooks[i][n]=this.hooks[i][n]||{series:[],parallel:[]},this.hooks[i][n][d].push(l)},t.getHooks=function(n,i){return!this.hooks[i]||!this.hooks[i][n]?{series:[],parallel:[]}:this.hooks[i][n]},t.hasHooks=function(n,i){if(!this.hooks[i]||!this.hooks[i][n])return!1;var o=this.getHooks(n,i);return o?o.series.length>0||o.parallel.length>0:!1},t._runHooks=function(n,i,o,c){var l=this.getHooks(n,i);if(!l)return At;var d=l.series.map(v=>()=>v(o,c));return ap(d).then(()=>Promise.all(l.parallel.map(v=>v(o,c))))},t._runHooksSync=function(n,i,o,c){if(this.hasHooks(n,i)){var l=this.getHooks(n,i);l&&l.series.forEach(d=>d(o,c))}},t.promiseWait=function(n){var i=new Promise(o=>{var c=setTimeout(()=>{this.timeouts.delete(c),o()},n);this.timeouts.add(c)});return i},t.close=async function(){return this.closed?wr:(Pn.delete(this),await Promise.all(this.onClose.map(n=>n())),this.closed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],Yi("postCloseRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(n=>n())),await hd(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},Ur(e,[{key:"insert$",get:function(){return this.$.pipe(Pe(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(Pe(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(Pe(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])}();function cy(e){if(!Vu){Vu=!0;var t=Object.getPrototypeOf(e);md.forEach(r=>{pd.map(n=>{var i=n+$l(r);t[i]=function(o,c){return this.addHook(n,r,o,c)}})})}}function uy(e,t){return e.incrementalModify(r=>t)}function ly(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(i=>i?{doc:i,inserted:!1}:e.insert(r).then(o=>({doc:o,inserted:!0})))}function fy({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:i={},autoMigrate:o=!0,statics:c={},methods:l={},attachments:d={},options:v={},localDocuments:m=!1,cacheReplacementPolicy:g=sd,conflictHandler:E=no}){var _={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:Ce.isDevMode()};return gt("preCreateRxStorageInstance",_),ey(e,_).then(S=>{var P=new vd(e,t,r,S,n,i,l,d,v,g,c,E);return P.prepare().then(()=>{Object.entries(c).forEach(([j,H])=>{Object.defineProperty(P,j,{get:()=>H.bind(P)})});var B=At;return o&&P.schema.version!==0&&(B=P.migratePromise()),B}).then(()=>(gt("createRxCollection",{collection:P,creator:{name:t,schema:r,storageInstance:S,instanceCreationOptions:n,migrationStrategies:i,methods:l,attachments:d,options:v,cacheReplacementPolicy:g,localDocuments:m,statics:c}}),P)).catch(B=>(Pn.delete(P),S.close().then(()=>Promise.reject(B))))})}var gd=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};gd.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,Ws(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(i){throw this.unlock(),i}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(i){return r.unlock(),i}).catch(function(i){throw r.unlock(),i})},requestIdlePromise:function(t){var r=this;t=t||{};var n,i=new Promise(function(l){return n=l}),o=function(){Es(r,i),n()};if(i._manRes=o,t.timeout){var c=setTimeout(function(){i._manRes()},t.timeout);i._timeoutObj=c}return this._iC.add(i),Ws(this),i},cancelIdlePromise:function(t){Es(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,i=this.requestIdlePromise(r);return this._hPM.set(n,i),this._pHM.set(i,n),i.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return Es(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function dy(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return Ws(e)},0)}}function Es(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function Ws(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}dy(e),e._tryIR=!1},0)},0))}class Mc{constructor(t){La(this,"ttl");La(this,"map",new Map);La(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,yd()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,hy(this)},0))}clear(){this.map.clear()}}function hy(e){const t=yd()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const i=n[0];if(n[1]<t)e.map.delete(i);else return}}function yd(){return Date.now()}var Vs=new Set,Qu=new Map,$c=function(){function e(r,n,i,o,c,l,d=!1,v={},m,g,E,_,S,P){this.idleQueue=new gd,this.rxdbVersion=Bl,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new Bt,this.closePromise=null,this.observable$=this.eventBulks$.pipe(Er(B=>df(B))),this.storageToken=wr,this.storageTokenDocument=wr,this.emittedEventBulkIds=new Mc(60*1e3),this.name=r,this.token=n,this.storage=i,this.instanceCreationOptions=o,this.password=c,this.multiInstance=l,this.eventReduce=d,this.options=v,this.internalStore=m,this.hashFunction=g,this.cleanupPolicy=E,this.allowSlowCount=_,this.reactivity=S,this.onClosed=P,this.name!=="pseudoInstance"&&(this.internalStore=xc(this.asRxDatabase,m,Rc),this.storageTokenDocument=Jg(this.asRxDatabase).catch(B=>this.startupErrors.push(B)),this.storageToken=this.storageTokenDocument.then(B=>B.data.token).catch(B=>this.startupErrors.push(B)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw Z("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,i){var o=await ia(this.internalStore,Gn(zs(n,i),ln));if(!o)throw Z("SNH",{name:n,schema:i});var c=aa(o);c._deleted=!0,await this.internalStore.bulkWrite([{document:c,previous:o}],"rx-database-remove-collection")},t.addCollections=async function(n){var i={},o={},c=[],l={};await Promise.all(Object.entries(n).map(async([m,g])=>{var E=m,_=g.schema;i[E]=_;var S=kp(_,this.hashFunction);if(o[E]=S,this.collections[m])throw Z("DB3",{name:m});var P=zs(m,_),B={id:Gn(P,ln),key:P,context:ln,data:{name:E,schemaHash:await S.hash,schema:S.jsonSchema,version:S.version,connectedStorages:[]},_deleted:!1,_meta:Jn(),_rev:zt(),_attachments:{}};c.push({document:B});var j=Object.assign({},g,{name:E,schema:S,database:this}),H=je(g);H.database=this,H.name=m,gt("preCreateRxCollection",H),j.conflictHandler=H.conflictHandler,l[E]=j}));var d=await this.internalStore.bulkWrite(c,"rx-database-add-collection");await yy(this),await Promise.all(d.error.map(async m=>{if(m.status!==409)throw Z("DB12",{database:this.name,writeError:m});var g=he(m.documentInDb),E=g.data.name,_=o[E];if(g.data.schemaHash!==await _.hash)throw Z("DB6",{database:this.name,collection:E,previousSchemaHash:g.data.schemaHash,schemaHash:await _.hash,previousSchema:g.data.schema,schema:he(i[E])})}));var v={};return await Promise.all(Object.keys(n).map(async m=>{var g=l[m],E=await fy(g);v[m]=E,this.collections[m]=E,this[m]||Object.defineProperty(this,m,{get:()=>this.collections[m]})})),v},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw Oe("json-dump")},t.addState=function(n){throw Oe("state")},t.importJSON=function(n){throw Oe("json-dump")},t.backup=function(n){throw Oe("backup")},t.leaderElector=function(){throw Oe("leader-election")},t.isLeader=function(){throw Oe("leader-election")},t.waitForLeadership=function(){throw Oe("leader-election")},t.migrationStates=function(){throw Oe("migration-schema")},t.close=function(){if(this.closePromise)return this.closePromise;var{promise:n,resolve:i}=bd(),o=c=>{this.onClosed&&this.onClosed(),this.closed=!0,i(c)};return this.closePromise=n,(async()=>{if(await Yi("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(c=>c.unsubscribe()),this.name==="pseudoInstance"){o(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(c=>c()))).then(()=>Promise.all(Object.keys(this.collections).map(c=>this.collections[c]).map(c=>c.close()))).then(()=>this.internalStore.close()).then(()=>o(!0))})(),n},t.remove=function(){return this.close().then(()=>vy(this.name,this.storage,this.multiInstance,this.password))},Ur(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])}();function py(e,t){if(Vs.has(wd(e,t)))throw Z("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function bd(){var e,t,r=new Promise((n,i)=>{e=n,t=i});return{promise:r,resolve:e,reject:t}}function wd(e,t){return t.name+"|"+e}async function _d(e,t,r,n,i,o){var c=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:Ov,schema:Rc,options:n,multiInstance:i,password:o,devMode:Ce.isDevMode()});return c}function my({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i=!0,eventReduce:o=!0,ignoreDuplicate:c=!1,options:l={},cleanupPolicy:d,closeDuplicates:v=!1,allowSlowCount:m=!1,localDocuments:g=!1,hashFunction:E=Ml,reactivity:_}){gt("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:l,localDocuments:g});var S=wd(r,e),P=Qu.get(S)||new Set,B=bd(),j=Array.from(P),H=()=>{P.delete(B.promise),Vs.delete(S)};return P.add(B.promise),Qu.set(S,P),(async()=>{if(v&&await Promise.all(j.map(ee=>ee.catch(()=>null).then(ie=>ie&&ie.close()))),c){if(!Ce.isDevMode())throw Z("DB9",{database:r})}else py(r,e);Vs.add(S);var Y=Qi(10),ce=await _d(Y,e,r,t,i,n),oe=new $c(r,Y,e,t,n,i,o,l,ce,E,d,m,_,H);return await Yi("createRxDatabase",{database:oe,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:i,eventReduce:o,ignoreDuplicate:c,options:l,localDocuments:g}}),oe})().then(Y=>{B.resolve(Y)}).catch(Y=>{B.reject(Y),H()}),B.promise}async function vy(e,t,r=!0,n){var i=Qi(10),o=await _d(i,t,e,{},r,n),c=await fd(o),l=new Set;c.forEach(v=>l.add(v.data.name));var d=Array.from(l);return await Promise.all(d.map(v=>hd(t,o,i,e,v,r,n))),await Yi("postRemoveRxDatabase",{databaseName:e,storage:t}),await o.remove(),d}function gy(e){return e instanceof $c}async function yy(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var by={RxSchema:Ul.prototype,RxDocument:Co,RxQuery:ud.prototype,RxCollection:vd.prototype,RxDatabase:$c.prototype},Ss=new Set,Gu=new Set;function Ka(e){if(gt("preAddRxPlugin",{plugin:e,plugins:Ss}),!Ss.has(e)){{if(Gu.has(e.name))throw Z("PL3",{name:e.name,plugin:e});Ss.add(e),Gu.add(e.name)}if(!e.rxdb)throw Lt("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(by[t])),e.overwritable&&Object.assign(Ce,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&Ri[t].push(r.after),r.before&&Ri[t].unshift(r.before)})}}async function io(e,t){var r=gn(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),i=n[0];if(e.lastCheckpointDoc[t]=i,i)return i.checkpointData}async function ao(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var i={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:Jn(),_rev:zt()};for(i.id=gn(e.input.metaInstance.schema,i);!e.events.canceled.getValue();){if(n&&(i.checkpointData=qi([n.checkpointData,i.checkpointData])),i._meta.lwt=Ct(),i._rev=br(await e.checkpointKey,n),e.events.canceled.getValue())return;var o=[{previous:n,document:i}],c=await e.input.metaInstance.bulkWrite(o,"replication-set-checkpoint"),l=Ft(e.primaryPath,o,c)[0];if(l){e.lastCheckpointDoc[t]=l;return}else{var d=c.error[0];if(d.status!==409)throw d;n=he(d.documentInDb),i._rev=br(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function wy(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function Yu(e,t,r,n,i){var o=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},i?i._meta:{},{lwt:Ct()}),_rev:r?n._rev:zt()});return o._rev||(o._rev=br(e,i)),o}function Tr(e,t,r){var n=je(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function Qs(e,t){return e.hasAttachments?t.map(r=>{var n=dt(r.document);return n.docData=tr(n.docData),{document:n,previous:r.previous}}):t}function Gs(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Ua="RxReplicationProtocolMetaData";function Ju(e,t){var r=yp(e),n={title:Ua,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var i=_o(n);return i}function Ed(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=gn(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(i=>{n[i.itemId]={docData:i.docData,metaDocument:i}}),n})}async function oo(e,t,r,n){var i=t[e.primaryPath],o=r?aa(r):{id:"",isCheckpoint:"0",itemId:i,docData:t,_attachments:{},_deleted:!1,_rev:zt(),_meta:{lwt:0}};o.docData=t,n&&(o.isResolvedConflict=n),o._meta.lwt=Ct(),o.id=gn(e.input.metaInstance.schema,o),o._rev=br(await e.checkpointKey,r);var c={previous:r,document:o};return c}async function _y(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await io(e,"down");t||await ao(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,i=0,o=[];function c(S){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var P={time:i++,task:S};o.push(P),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var B=[];o.length>0;){e.events.active.down.next(!0);var j=he(o.shift());if(!(j.time<d)){if(j.task==="RESYNC")if(B.length===0){B.push(j.task);break}else break;B.push(j.task)}}if(B.length!==0)return B[0]==="RESYNC"?v():m(B)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(c("RESYNC"),!e.events.canceled.getValue()){var l=n.masterChangeStream$.pipe(Er(async S=>(await un(e.events.active.up.pipe(Pe(P=>!P))),S))).subscribe(S=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,c(S)});un(e.events.canceled.pipe(Pe(S=>!!S))).then(()=>l.unsubscribe())}var d=-1;async function v(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>io(e,"down"));for(var S=await e.checkpointQueue,P=[];!e.events.canceled.getValue();){d=i++;var B=await n.masterChangesSince(S,e.input.pullBatchSize);if(B.documents.length===0||(S=qi([S,B.checkpoint]),P.push(_(B.documents,S)),B.documents.length<e.input.pullBatchSize))break}await Promise.all(P)}}function m(S){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var P=[],B=null;return S.forEach(j=>{if(j==="RESYNC")throw new Error("SNH");hn(P,j.documents),B=qi([B,j.checkpoint])}),_(P,he(B))}var g=At,E={docs:{}};function _(S,P){var B=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,S.forEach(j=>{var H=j[B];E.docs[H]=j}),E.checkpoint=P,g=g.then(()=>{var j=E.docs;E.docs={};var H=E.checkpoint,Y=Object.keys(j);if(e.events.canceled.getValue()||Y.length===0)return At;var ce=[],oe={},ee={},ie=[];return Promise.all([e.input.forkInstance.findDocumentsById(Y,!0),Ed(e,Y)]).then(([me,we])=>{var Fe=new Map;return me.forEach(Le=>Fe.set(Le[B],Le)),Promise.all(Y.map(async Le=>{var pe=Fe.get(Le),De=pe?Tr(pe,e.hasAttachments,!1):void 0,Re=j[Le],Te=we[Le];Te&&pe&&Te.metaDocument.isResolvedConflict===pe._rev&&await e.streamQueue.up;var Xe=!Te||!De?!1:e.input.conflictHandler.isEqual(Te.docData,De,"downstream-check-if-equal-0");if(!Xe&&Te&&Te.docData._rev&&pe&&pe._meta[e.input.identifier]&&Hr(pe._rev)===pe._meta[e.input.identifier]&&(Xe=!0),pe&&Te&&Xe===!1||pe&&!Te)return At;var qt=De?e.input.conflictHandler.isEqual(Re,De,"downstream-check-if-equal-1"):!1;if(De&&qt)return(!Te||Xe===!1)&&ie.push(await oo(e,De,Te?Te.metaDocument:void 0)),At;var Ne=Object.assign({},Re,pe?{_meta:je(pe._meta),_attachments:e.hasAttachments&&Re._attachments?Re._attachments:{},_rev:zt()}:{_meta:{lwt:Ct()},_rev:zt(),_attachments:e.hasAttachments&&Re._attachments?Re._attachments:{}});if(Re._rev){var it=pe?Hr(pe._rev)+1:1;Ne._meta[e.input.identifier]=it,e.input.keepMeta&&(Ne._rev=Re._rev)}e.input.keepMeta&&Re._meta&&(Ne._meta=Re._meta);var se={previous:pe,document:Ne};se.document._rev=se.document._rev?se.document._rev:br(r,se.previous),ce.push(se),oe[Le]=se,ee[Le]=await oo(e,Re,Te?Te.metaDocument:void 0)}))}).then(async()=>{if(ce.length>0)return e.input.forkInstance.bulkWrite(ce,await e.downstreamBulkWriteFlag).then(me=>{var we=Ft(e.primaryPath,ce,me);we.forEach(Le=>{var pe=Le[B];e.events.processed.down.next(oe[pe]),ie.push(ee[pe])});var Fe;if(me.error.forEach(Le=>{if(Le.status!==409){var pe=Z("RC_PULL",{writeError:Le});e.events.error.next(pe),Fe=pe}}),Fe)throw Fe})}).then(()=>{if(ie.length>0)return e.input.metaInstance.bulkWrite(Qs(e,ie),"replication-down-write-meta").then(me=>{me.error.forEach(we=>{e.events.error.next(Z("RC_PULL",{id:we.documentId,writeError:we}))})})}).then(()=>{ao(e,"down",H)})}).catch(j=>e.events.error.next(j)),g}}async function Ey(e,t,r){var n=e.input.conflictHandler,i=n.isEqual(t.realMasterState,t.newDocumentState,"replication-resolve-conflict");if(!i){var o=await n.resolve(t,"replication-resolve-conflict"),c=Object.assign({},o,{_meta:je(r._meta),_rev:zt(),_attachments:je(r._attachments)});return c._meta.lwt=Ct(),c._rev=br(await e.checkpointKey,r),c}}async function Ys(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var i=r[e],o=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([c,l])=>{if((!o.has(c)||n&&he(n._attachments)[c].digest!==l.digest)&&!l.data){var d=await t.getAttachmentData(i,c,l.digest);l.data=d}})),r}async function Sy(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await io(e,"up");t||await ao(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>m().then(()=>g()));var n=0,i=-1,o=[],c=wr,l={docs:{}},d=e.input.forkInstance.changeStream().subscribe(_=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,o.push({task:_,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>g()):g()}),v=r.masterChangeStream$.pipe(Pe(_=>_==="RESYNC")).subscribe(()=>{o.push({task:"RESYNC",time:n++}),g()});un(e.events.canceled.pipe(Pe(_=>!!_))).then(()=>{d.unsubscribe(),v.unsubscribe()});async function m(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>io(e,"up"));for(var _=await e.checkpointQueue,S=new Set,P=async function(){i=n++,S.size>3&&await Promise.race(Array.from(S));var H=await Xf(e.input.forkInstance,e.input.pushBatchSize,_);if(H.documents.length===0)return 1;_=qi([_,H.checkpoint]);var Y=E(H.documents,he(_));S.add(Y),Y.catch().then(()=>S.delete(Y))};!e.events.canceled.getValue()&&!await P(););var B=await Promise.all(S),j=B.find(H=>!!H);j?await m():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function g(){if(e.events.canceled.getValue()||o.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var _=[],S={};o.length>0;){var P=he(o.shift());if(!(P.time<i)){if(P.task==="RESYNC"){e.events.active.up.next(!1),await m();return}P.task.context!==await e.downstreamBulkWriteFlag&&hn(_,P.task.events.map(B=>B.documentData)),S=qi([S,P.task.checkpoint])}}if(await E(_,S),o.length===0)e.events.active.up.next(!1);else return g()})}function E(_,S){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,_.forEach(P=>{var B=P[e.primaryPath];l.docs[B]=P}),l.checkpoint=S,c=c.then(async()=>{if(e.events.canceled.getValue())return!1;var P=l.docs;l.docs={};var B=l.checkpoint,j=Object.keys(P);function H(){return ao(e,"up",B)}if(j.length===0)return H(),!1;var Y=await Ed(e,j),ce={},oe=[],ee={},ie={};if(await Promise.all(j.map(async se=>{var _e=P[se];ie[se]=_e;var Ye=Tr(_e,e.hasAttachments,!!e.input.keepMeta),fe=Y[se];fe&&fe.metaDocument.isResolvedConflict!==_e._rev&&e.input.conflictHandler.isEqual(fe.docData,Ye,"upstream-check-if-equal")||fe&&fe.docData._rev&&Hr(_e._rev)===_e._meta[e.input.identifier]||(oe.push(se),ce[se]={assumedMasterState:fe?fe.docData:void 0,newDocumentState:Ye},ee[se]=await oo(e,Ye,fe?fe.metaDocument:void 0))})),oe.length===0)return H(),!1;var me=Object.values(ce),we=new Set,Fe={},Le=Vh(me,e.input.pushBatchSize);await Promise.all(Le.map(async se=>{e.hasAttachments&&await Promise.all(se.map(async Ye=>{Ye.newDocumentState=await Ys(e.primaryPath,e.input.forkInstance,dt(Ye.newDocumentState),Ye.assumedMasterState)}));var _e=await r.masterWrite(se);_e.forEach(Ye=>{var fe=Ye[e.primaryPath];we.add(fe),Fe[fe]=Ye})}));var pe=[];if(oe.forEach(se=>{we.has(se)||(e.events.processed.up.next(ce[se]),pe.push(ee[se]))}),e.events.canceled.getValue())return!1;pe.length>0&&await e.input.metaInstance.bulkWrite(Qs(e,pe),"replication-up-write-meta");var De=!1;if(we.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var Re=[],Te={};if(await Promise.all(Object.entries(Fe).map(([se,_e])=>{var Ye=ce[se],fe={newDocumentState:Ye.newDocumentState,assumedMasterState:Ye.assumedMasterState,realMasterState:_e};return Ey(e,fe,ie[se]).then(async Me=>{if(Me){e.events.resolvedConflicts.next({input:fe,output:Me}),Re.push({previous:ie[se],document:Me});var mt=Y[se];Te[se]=await oo(e,he(_e),mt?mt.metaDocument:void 0,Me._rev)}})})),Re.length>0){De=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var Xe=await e.input.forkInstance.bulkWrite(Re,"replication-up-write-conflict"),qt;if(Xe.error.forEach(se=>{if(se.status!==409){var _e=Z("RC_PUSH",{writeError:se});e.events.error.next(_e),qt=_e}}),qt)throw qt;var Ne=[],it=Ft(e.primaryPath,Re,Xe);it.forEach(se=>{var _e=se[e.primaryPath];Ne.push(Te[_e])}),Ne.length>0&&await e.input.metaInstance.bulkWrite(Qs(e,Ne),"replication-up-write-conflict-meta")}}return H(),De}).catch(P=>(e.events.error.next(P),!1)),c}}function xy(e){e=je(e),e.forkInstance=Gs(e.forkInstance),e.metaInstance=Gs(e.metaInstance);var t=wy(e),r={primaryPath:It(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new Lr(!1),paused:new Lr(!1),active:{down:new Lr(!0),up:new Lr(!0)},processed:{down:new Bt,up:new Bt},resolvedConflicts:new Bt,error:new Bt},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new Lr(!1),up:new Lr(!1)},streamQueue:{down:At,up:At},checkpointQueue:At,lastCheckpointDoc:{}};return _y(r),Sy(r),r}function ky(e){return un(lm([e.firstSyncDone.down.pipe(Pe(t=>!!t)),e.firstSyncDone.up.pipe(Pe(t=>!!t))])).then(()=>{})}function Cy(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function Iy(e,t,r,n=!1){e=Gs(e);var i=!!e.schema.attachments,o=It(e.schema.primaryKey),c={masterChangeStream$:e.changeStream().pipe(Er(async l=>{var d={checkpoint:l.checkpoint,documents:await Promise.all(l.events.map(async v=>{var m=Tr(v.documentData,i,n);return i&&(m=await Ys(o,e,dt(m),void 0)),m}))};return d})),masterChangesSince(l,d){return Xf(e,d,l).then(async v=>({checkpoint:v.documents.length>0?v.checkpoint:l,documents:await Promise.all(v.documents.map(async m=>{var g=Tr(m,i,n);return i&&(g=await Ys(o,e,dt(g),void 0)),g}))}))},async masterWrite(l){var d={};l.forEach(P=>{var B=P.newDocumentState[o];d[B]=P});var v=Object.keys(d),m=await e.findDocumentsById(v,!0),g=new Map;m.forEach(P=>g.set(P[o],P));var E=[],_=[];if(await Promise.all(Object.entries(d).map(([P,B])=>{var j=g.get(P);j?j&&!B.assumedMasterState?E.push(Tr(j,i,n)):t.isEqual(Tr(j,i,n),he(B.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?_.push({previous:j,document:Yu(r,i,n,B.newDocumentState,j)}):E.push(Tr(j,i,n)):_.push({document:Yu(r,i,n,B.newDocumentState)})})),_.length>0){var S=await e.bulkWrite(_,"replication-master-write");S.error.forEach(P=>{if(P.status!==409)throw Z("SNH",{name:"non conflict error",error:P});E.push(Tr(he(P.documentInDb),i,n))})}return E}};return c}async function Dy(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}function Oy(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var Py=Promise.resolve(!0),vr=Promise.resolve();function an(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function Ry(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function oa(){return Math.random().toString(36).substring(2)}var xs=0;function sa(){var e=Date.now()*1e3;return e<=xs&&(e=xs+1),xs=e,e}function My(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var $y=sa,Ly="native";function Ty(e){var t={time:sa(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function Ay(e){e.bc.close(),e.subFns=[]}function By(e,t){try{return e.bc.postMessage(t,!1),vr}catch(r){return Promise.reject(r)}}function Ny(e,t){e.messagesCallback=t}function jy(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Fy(){return 150}var qy={create:Ty,close:Ay,onMessage:Ny,postMessage:By,canBeUsed:jy,type:Ly,averageResponseTime:Fy,microSeconds:$y};function Lc(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var Hy=sa,Ky="pubkey.broadcast-channel-0-",Sr="messages",Io={durability:"relaxed"},Uy="idb";function Sd(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function Tc(e){e.commit&&e.commit()}function zy(e){var t=Sd(),r=Ky+e,n=t.open(r);return n.onupgradeneeded=function(i){var o=i.target.result;o.createObjectStore(Sr,{keyPath:"id",autoIncrement:!0})},new Promise(function(i,o){n.onerror=function(c){return o(c)},n.onsuccess=function(){i(n.result)}})}function Wy(e,t,r){var n=Date.now(),i={uuid:t,time:n,data:r},o=e.transaction([Sr],"readwrite",Io);return new Promise(function(c,l){o.oncomplete=function(){return c()},o.onerror=function(v){return l(v)};var d=o.objectStore(Sr);d.add(i),Tc(o)})}function Vy(e,t){var r=e.transaction(Sr,"readonly",Io),n=r.objectStore(Sr),i=[],o=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var c=n.getAll(o);return new Promise(function(d,v){c.onerror=function(m){return v(m)},c.onsuccess=function(m){d(m.target.result)}})}function l(){try{return o=IDBKeyRange.bound(t+1,1/0),n.openCursor(o)}catch{return n.openCursor()}}return new Promise(function(d,v){var m=l();m.onerror=function(g){return v(g)},m.onsuccess=function(g){var E=g.target.result;E?E.value.id<t+1?E.continue(t+1):(i.push(E.value),E.continue()):(Tc(r),d(i))}})}function Qy(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(Sr,"readwrite",Io),n=r.objectStore(Sr);return Promise.all(t.map(function(i){var o=n.delete(i);return new Promise(function(c){o.onsuccess=function(){return c()}})}))}function Gy(e,t){var r=Date.now()-t,n=e.transaction(Sr,"readonly",Io),i=n.objectStore(Sr),o=[];return new Promise(function(c){i.openCursor().onsuccess=function(l){var d=l.target.result;if(d){var v=d.value;v.time<r?(o.push(v),d.continue()):(Tc(n),c(o))}else c(o)}})}function Yy(e){return Gy(e.db,e.options.idb.ttl).then(function(t){return Qy(e,t.map(function(r){return r.id}))})}function Jy(e,t){return t=Lc(t),zy(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:oa(),eMIs:new Mc(t.idb.ttl*2),writeBlockPromise:vr,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},xd(n),n})}function xd(e){e.closed||kd(e).then(function(){return an(e.options.idb.fallbackInterval)}).then(function(){return xd(e)})}function Xy(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function kd(e){return e.closed||!e.messagesCallback?vr:Vy(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return Xy(n,e)}).sort(function(n,i){return n.time-i.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),vr})}function Zy(e){e.closed=!0,e.db.close()}function eb(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return Wy(e.db,e.uuid,t)}).then(function(){Ry(0,10)===0&&Yy(e)}),e.writeBlockPromise}function tb(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,kd(e)}function rb(){return!!Sd()}function nb(e){return e.idb.fallbackInterval*2}var ib={create:Jy,close:Zy,onMessage:tb,postMessage:eb,canBeUsed:rb,type:Uy,averageResponseTime:nb,microSeconds:Hy},ab=sa,ob="pubkey.broadcastChannel-",sb="localstorage";function Cd(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function Id(e){return ob+e}function cb(e,t){return new Promise(function(r){an().then(function(){var n=Id(e.channelName),i={token:oa(),time:Date.now(),data:t,uuid:e.uuid},o=JSON.stringify(i);Cd().setItem(n,o);var c=document.createEvent("Event");c.initEvent("storage",!0,!0),c.key=n,c.newValue=o,window.dispatchEvent(c),r()})})}function ub(e,t){var r=Id(e),n=function(o){o.key===r&&t(JSON.parse(o.newValue))};return window.addEventListener("storage",n),n}function lb(e){window.removeEventListener("storage",e)}function fb(e,t){if(t=Lc(t),!Dd())throw new Error("BroadcastChannel: localstorage cannot be used");var r=oa(),n=new Mc(t.localstorage.removeTimeout),i={channelName:e,uuid:r,eMIs:n};return i.listener=ub(e,function(o){i.messagesCallback&&o.uuid!==r&&(!o.token||n.has(o.token)||o.data.time&&o.data.time<i.messagesCallbackTime||(n.add(o.token),i.messagesCallback(o.data)))}),i}function db(e){lb(e.listener)}function hb(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function Dd(){var e=Cd();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function pb(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var mb={create:fb,close:db,onMessage:hb,postMessage:cb,canBeUsed:Dd,type:sb,averageResponseTime:pb,microSeconds:ab},Od=sa,vb="simulate",Ac=new Set;function gb(e){var t={time:Od(),name:e,messagesCallback:null};return Ac.add(t),t}function yb(e){Ac.delete(e)}var Pd=5;function bb(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(Ac);n.forEach(function(i){i.name===e.name&&i!==e&&i.messagesCallback&&i.time<t.time&&i.messagesCallback(t)}),r()},Pd)})}function wb(e,t){e.messagesCallback=t}function _b(){return!0}function Eb(){return Pd}var Sb={create:gb,close:yb,onMessage:wb,postMessage:bb,canBeUsed:_b,type:vb,averageResponseTime:Eb,microSeconds:Od},Xu=[qy,ib,mb];function xb(e){var t=[].concat(e.methods,Xu).filter(Boolean);if(e.type){if(e.type==="simulate")return Sb;var r=t.find(function(i){return i.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(i){return i.type!=="idb"}));var n=t.find(function(i){return i.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(Xu.map(function(i){return i.type})))}var Rd=new Set,kb=0,Do=function(t,r){this.id=kb++,Rd.add(this),this.name=t,this.options=Lc(r),this.method=xb(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,Cb(this)};Do._pubkey=!0;Do.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return Zu(this,"message",t)},postInternal:function(t){return Zu(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};tl(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,el(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),i={time:n,fn:r};el(this,t,i)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(i){return i.fn===r});tl(this,t,n)},close:function(){var t=this;if(!this.closed){Rd.delete(this),this.closed=!0;var r=this._prepP?this._prepP:vr;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function Zu(e,t,r){var n=e.method.microSeconds(),i={time:n,type:t,data:r},o=e._prepP?e._prepP:vr;return o.then(function(){var c=e.method.postMessage(e._state,i);return e._uMP.add(c),c.catch().then(function(){return e._uMP.delete(c)}),c})}function Cb(e){var t=e.method.create(e.name,e.options);Oy(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function Md(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function el(e,t,r){e._addEL[t].push(r),Ib(e)}function tl(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),Db(e)}function Ib(e){if(!e._iL&&Md(e)){var t=function(i){e._addEL[i.type].forEach(function(o){i.time>=o.time&&o.fn(i.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function Db(e){if(e._iL&&!Md(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function Ob(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function Pb(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var Rb=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",Mb=Rb?Pb:Ob,wi=new Set,rl=!1;function $b(){rl||(rl=!0,Mb(Tb))}function Lb(e){if($b(),typeof e!="function")throw new Error("Listener is no function");wi.add(e);var t={remove:function(){return wi.delete(e)},run:function(){return wi.delete(e),e()}};return t}function Tb(){var e=[];return wi.forEach(function(t){e.push(t()),wi.delete(t)}),Promise.all(e)}function fn(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function $d(e){e.isLeader=!0,e._hasLeader=!0;var t=Lb(function(){return e.die()});e._unl.push(t);var r=function(i){i.context==="leader"&&i.action==="apply"&&fn(e,"tell"),i.context==="leader"&&i.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),fn(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),fn(e,"tell")}var Ld=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=oa(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};Ld.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(i){return i.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,i){t._wKMC.res=n,t._wKMC.rej=i});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,$d(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),fn(this,"death")}};var Td=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=oa(),this._aplQ=vr,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=function(c){c.context==="leader"&&(c.action==="death"&&(n._hasLeader=!1),c.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};Td.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return an(0,!0);if(this.isDead)return an(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return Py;var o=!1,c,l=new Promise(function(m){c=function(){o=!0,m()}}),d=function(g){g.context==="leader"&&g.token!=r.token&&(g.action==="apply"&&g.token>r.token&&c(),g.action==="tell"&&(c(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",d);var v=t?r._options.responseTime*4:r._options.responseTime;return fn(r,"apply").then(function(){return Promise.race([an(v),l.then(function(){return Promise.reject(new Error)})])}).then(function(){return fn(r,"apply")}).then(function(){return Promise.race([an(v),l.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",d),o?!1:$d(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=Ab(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,fn(this,"death")}};function Ab(e){return e.isLeader?vr:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",o),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var i=function(){return an(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():i()})})};i();var o=function(l){l.context==="leader"&&l.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)})}function Bb(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function Nb(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=Bb(t,e);var r=My()?new Ld(e,t):new Td(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var so=new Map;function jb(e,t,r,n){var i=so.get(t);return i||(i={bc:new Do(["RxDB:",e,r].join("|")),refs:new Set},so.set(t,i)),i.refs.add(n),i.bc}function nl(e,t){var r=so.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return so.delete(e),r.bc.close()}function Fb(e,t,r,n){if(t.multiInstance){var i=jb(e,t.databaseInstanceToken,r.databaseName,r),o=new Bt,c=E=>{E.storageName===e&&E.databaseName===t.databaseName&&E.collectionName===t.collectionName&&E.version===t.schema.version&&o.next(E.eventBulk)};i.addEventListener("message",c);var l=r.changeStream(),d=!1,v=l.subscribe(E=>{d||i.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:E})});r.changeStream=function(){return o.asObservable().pipe(bm(l))};var m=r.close.bind(r);r.close=async function(){return d=!0,v.unsubscribe(),i.removeEventListener("message",c),await nl(t.databaseInstanceToken,r),m()};var g=r.remove.bind(r);r.remove=async function(){return d=!0,v.unsubscribe(),i.removeEventListener("message",c),await nl(t.databaseInstanceToken,r),g()}}}var qb=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Hb(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var za={exports:{}},Kb=za.exports,il;function Ub(){return il||(il=1,function(e,t){(function(r,n){e.exports=n()})(Kb,function(){var r=function(a,s){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,f){u.__proto__=f}||function(u,f){for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(u[h]=f[h])})(a,s)},n=function(){return(n=Object.assign||function(a){for(var s,u=1,f=arguments.length;u<f;u++)for(var h in s=arguments[u])Object.prototype.hasOwnProperty.call(s,h)&&(a[h]=s[h]);return a}).apply(this,arguments)};function i(a,s,u){for(var f,h=0,p=s.length;h<p;h++)!f&&h in s||((f=f||Array.prototype.slice.call(s,0,h))[h]=s[h]);return a.concat(f||Array.prototype.slice.call(s))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:qb,c=Object.keys,l=Array.isArray;function d(a,s){return typeof s!="object"||c(s).forEach(function(u){a[u]=s[u]}),a}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var v=Object.getPrototypeOf,m={}.hasOwnProperty;function g(a,s){return m.call(a,s)}function E(a,s){typeof s=="function"&&(s=s(v(a))),(typeof Reflect>"u"?c:Reflect.ownKeys)(s).forEach(function(u){S(a,u,s[u])})}var _=Object.defineProperty;function S(a,s,u,f){_(a,s,d(u&&g(u,"get")&&typeof u.get=="function"?{get:u.get,set:u.set,configurable:!0}:{value:u,configurable:!0,writable:!0},f))}function P(a){return{from:function(s){return a.prototype=Object.create(s.prototype),S(a.prototype,"constructor",a),{extend:E.bind(null,a.prototype)}}}}var B=Object.getOwnPropertyDescriptor,j=[].slice;function H(a,s,u){return j.call(a,s,u)}function Y(a,s){return s(a)}function ce(a){if(!a)throw new Error("Assertion Failed")}function oe(a){o.setImmediate?setImmediate(a):setTimeout(a,0)}function ee(a,s){if(typeof s=="string"&&g(a,s))return a[s];if(!s)return a;if(typeof s!="string"){for(var u=[],f=0,h=s.length;f<h;++f){var p=ee(a,s[f]);u.push(p)}return u}var y=s.indexOf(".");if(y!==-1){var b=a[s.substr(0,y)];return b==null?void 0:ee(b,s.substr(y+1))}}function ie(a,s,u){if(a&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof s!="string"&&"length"in s){ce(typeof u!="string"&&"length"in u);for(var f=0,h=s.length;f<h;++f)ie(a,s[f],u[f])}else{var p,y,b=s.indexOf(".");b!==-1?(p=s.substr(0,b),(y=s.substr(b+1))===""?u===void 0?l(a)&&!isNaN(parseInt(p))?a.splice(p,1):delete a[p]:a[p]=u:ie(b=!(b=a[p])||!g(a,p)?a[p]={}:b,y,u)):u===void 0?l(a)&&!isNaN(parseInt(s))?a.splice(s,1):delete a[s]:a[s]=u}}function me(a){var s,u={};for(s in a)g(a,s)&&(u[s]=a[s]);return u}var we=[].concat;function Fe(a){return we.apply([],a)}var cr="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Fe([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(s){return s+a+"Array"})}))).filter(function(a){return o[a]}),Le=new Set(cr.map(function(a){return o[a]})),pe=null;function De(a){return pe=new WeakMap,a=function s(u){if(!u||typeof u!="object")return u;var f=pe.get(u);if(f)return f;if(l(u)){f=[],pe.set(u,f);for(var h=0,p=u.length;h<p;++h)f.push(s(u[h]))}else if(Le.has(u.constructor))f=u;else{var y,b=v(u);for(y in f=b===Object.prototype?{}:Object.create(b),pe.set(u,f),u)g(u,y)&&(f[y]=s(u[y]))}return f}(a),pe=null,a}var Re={}.toString;function Te(a){return Re.call(a).slice(8,-1)}var Xe=typeof Symbol<"u"?Symbol.iterator:"@@iterator",qt=typeof Xe=="symbol"?function(a){var s;return a!=null&&(s=a[Xe])&&s.apply(a)}:function(){return null};function Ne(a,s){return s=a.indexOf(s),0<=s&&a.splice(s,1),0<=s}var it={};function se(a){var s,u,f,h;if(arguments.length===1){if(l(a))return a.slice();if(this===it&&typeof a=="string")return[a];if(h=qt(a)){for(u=[];!(f=h.next()).done;)u.push(f.value);return u}if(a==null)return[a];if(typeof(s=a.length)!="number")return[a];for(u=new Array(s);s--;)u[s]=a[s];return u}for(s=arguments.length,u=new Array(s);s--;)u[s]=arguments[s];return u}var _e=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Ht=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Rt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Ht),Ye={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function fe(a,s){this.name=a,this.message=s}function Me(a,s){return a+". Errors: "+Object.keys(s).map(function(u){return s[u].toString()}).filter(function(u,f,h){return h.indexOf(u)===f}).join(`
`)}function mt(a,s,u,f){this.failures=s,this.failedKeys=f,this.successCount=u,this.message=Me(a,s)}function Pt(a,s){this.name="BulkError",this.failures=Object.keys(s).map(function(u){return s[u]}),this.failuresByPos=s,this.message=Me(a,this.failures)}P(fe).from(Error).extend({toString:function(){return this.name+": "+this.message}}),P(mt).from(fe),P(Pt).from(fe);var ar=Rt.reduce(function(a,s){return a[s]=s+"Error",a},{}),bn=fe,ne=Rt.reduce(function(a,s){var u=s+"Error";function f(h,p){this.name=u,h?typeof h=="string"?(this.message="".concat(h).concat(p?`
 `+p:""),this.inner=p||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=Ye[s]||u,this.inner=null)}return P(f).from(bn),a[s]=f,a},{});ne.Syntax=SyntaxError,ne.Type=TypeError,ne.Range=RangeError;var ri=Ht.reduce(function(a,s){return a[s+"Error"]=ne[s],a},{}),kr=Rt.reduce(function(a,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(a[s+"Error"]=ne[s]),a},{});function L(){}function Q(a){return a}function te(a,s){return a==null||a===Q?s:function(u){return s(a(u))}}function X(a,s){return function(){a.apply(this,arguments),s.apply(this,arguments)}}function de(a,s){return a===L?s:function(){var u=a.apply(this,arguments);u!==void 0&&(arguments[0]=u);var f=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var p=s.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?X(f,this.onsuccess):f),h&&(this.onerror=this.onerror?X(h,this.onerror):h),p!==void 0?p:u}}function xe(a,s){return a===L?s:function(){a.apply(this,arguments);var u=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?X(u,this.onsuccess):u),f&&(this.onerror=this.onerror?X(f,this.onerror):f)}}function ke(a,s){return a===L?s:function(u){var f=a.apply(this,arguments);d(u,f);var h=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,u=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?X(h,this.onsuccess):h),p&&(this.onerror=this.onerror?X(p,this.onerror):p),f===void 0?u===void 0?void 0:u:d(f,u)}}function qe(a,s){return a===L?s:function(){return s.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function wn(a,s){return a===L?s:function(){var u=a.apply(this,arguments);if(u&&typeof u.then=="function"){for(var f=this,h=arguments.length,p=new Array(h);h--;)p[h]=arguments[h];return u.then(function(){return s.apply(f,p)})}return s.apply(this,arguments)}}kr.ModifyError=mt,kr.DexieError=fe,kr.BulkError=Pt;var ae=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Qe(a){ae=a}var ct={},Je=100,cr=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,v(a),a];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,v(s),a]}(),Ht=cr[0],Rt=cr[1],cr=cr[2],Rt=Rt&&Rt.then,bt=Ht&&Ht.constructor,Yt=!!cr,or=function(a,s){ii.push([a,s]),ca&&(queueMicrotask(gh),ca=!1)},ni=!0,ca=!0,Vr=[],ua=[],Ro=Q,Cr={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:L,pgp:!1,env:{},finalize:L},re=Cr,ii=[],Qr=0,la=[];function G(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=re;if(typeof a!="function"){if(a!==ct)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&$o(this,this._value))}this._state=null,this._value=null,++s.ref,function u(f,h){try{h(function(p){if(f._state===null){if(p===f)throw new TypeError("A promise cannot be resolved with itself.");var y=f._lib&&_n();p&&typeof p.then=="function"?u(f,function(b,x){p instanceof G?p._then(b,x):p.then(b,x)}):(f._state=!0,f._value=p,Kc(f)),y&&En()}},$o.bind(null,f))}catch(p){$o(f,p)}}(this,a)}var Mo={get:function(){var a=re,s=pa;function u(f,h){var p=this,y=!a.global&&(a!==re||s!==pa),b=y&&!Dr(),x=new G(function(C,O){Lo(p,new Hc(zc(f,a,y,b),zc(h,a,y,b),C,O,a))});return this._consoleTask&&(x._consoleTask=this._consoleTask),x}return u.prototype=ct,u},set:function(a){S(this,"then",a&&a.prototype===ct?Mo:{get:function(){return a},set:Mo.set})}};function Hc(a,s,u,f,h){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof s=="function"?s:null,this.resolve=u,this.reject=f,this.psd=h}function $o(a,s){var u,f;ua.push(s),a._state===null&&(u=a._lib&&_n(),s=Ro(s),a._state=!1,a._value=s,f=a,Vr.some(function(h){return h._value===f._value})||Vr.push(f),Kc(a),u&&En())}function Kc(a){var s=a._listeners;a._listeners=[];for(var u=0,f=s.length;u<f;++u)Lo(a,s[u]);var h=a._PSD;--h.ref||h.finalize(),Qr===0&&(++Qr,or(function(){--Qr==0&&To()},[]))}function Lo(a,s){if(a._state!==null){var u=a._state?s.onFulfilled:s.onRejected;if(u===null)return(a._state?s.resolve:s.reject)(a._value);++s.psd.ref,++Qr,or(vh,[u,a,s])}else a._listeners.push(s)}function vh(a,s,u){try{var f,h=s._value;!s._state&&ua.length&&(ua=[]),f=ae&&s._consoleTask?s._consoleTask.run(function(){return a(h)}):a(h),s._state||ua.indexOf(h)!==-1||function(p){for(var y=Vr.length;y;)if(Vr[--y]._value===p._value)return Vr.splice(y,1)}(s),u.resolve(f)}catch(p){u.reject(p)}finally{--Qr==0&&To(),--u.psd.ref||u.psd.finalize()}}function gh(){Gr(Cr,function(){_n()&&En()})}function _n(){var a=ni;return ca=ni=!1,a}function En(){var a,s,u;do for(;0<ii.length;)for(a=ii,ii=[],u=a.length,s=0;s<u;++s){var f=a[s];f[0].apply(null,f[1])}while(0<ii.length);ca=ni=!0}function To(){var a=Vr;Vr=[],a.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var s=la.slice(0),u=s.length;u;)s[--u]()}function fa(a){return new G(ct,!1,a)}function Ae(a,s){var u=re;return function(){var f=_n(),h=re;try{return Or(u,!0),a.apply(this,arguments)}catch(p){s&&s(p)}finally{Or(h,!1),f&&En()}}}E(G.prototype,{then:Mo,_then:function(a,s){Lo(this,new Hc(null,null,a,s,re))},catch:function(a){if(arguments.length===1)return this.then(null,a);var s=a,u=arguments[1];return typeof s=="function"?this.then(null,function(f){return(f instanceof s?u:fa)(f)}):this.then(null,function(f){return(f&&f.name===s?u:fa)(f)})},finally:function(a){return this.then(function(s){return G.resolve(a()).then(function(){return s})},function(s){return G.resolve(a()).then(function(){return fa(s)})})},timeout:function(a,s){var u=this;return a<1/0?new G(function(f,h){var p=setTimeout(function(){return h(new ne.Timeout(s))},a);u.then(f,h).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&S(G.prototype,Symbol.toStringTag,"Dexie.Promise"),Cr.env=Uc(),E(G,{all:function(){var a=se.apply(null,arguments).map(ma);return new G(function(s,u){a.length===0&&s([]);var f=a.length;a.forEach(function(h,p){return G.resolve(h).then(function(y){a[p]=y,--f||s(a)},u)})})},resolve:function(a){return a instanceof G?a:a&&typeof a.then=="function"?new G(function(s,u){a.then(s,u)}):new G(ct,!0,a)},reject:fa,race:function(){var a=se.apply(null,arguments).map(ma);return new G(function(s,u){a.map(function(f){return G.resolve(f).then(s,u)})})},PSD:{get:function(){return re},set:function(a){return re=a}},totalEchoes:{get:function(){return pa}},newPSD:Ir,usePSD:Gr,scheduler:{get:function(){return or},set:function(a){or=a}},rejectionMapper:{get:function(){return Ro},set:function(a){Ro=a}},follow:function(a,s){return new G(function(u,f){return Ir(function(h,p){var y=re;y.unhandleds=[],y.onunhandled=p,y.finalize=X(function(){var b,x=this;b=function(){x.unhandleds.length===0?h():p(x.unhandleds[0])},la.push(function C(){b(),la.splice(la.indexOf(C),1)}),++Qr,or(function(){--Qr==0&&To()},[])},y.finalize),a()},s,u,f)})}}),bt&&(bt.allSettled&&S(G,"allSettled",function(){var a=se.apply(null,arguments).map(ma);return new G(function(s){a.length===0&&s([]);var u=a.length,f=new Array(u);a.forEach(function(h,p){return G.resolve(h).then(function(y){return f[p]={status:"fulfilled",value:y}},function(y){return f[p]={status:"rejected",reason:y}}).then(function(){return--u||s(f)})})})}),bt.any&&typeof AggregateError<"u"&&S(G,"any",function(){var a=se.apply(null,arguments).map(ma);return new G(function(s,u){a.length===0&&u(new AggregateError([]));var f=a.length,h=new Array(f);a.forEach(function(p,y){return G.resolve(p).then(function(b){return s(b)},function(b){h[y]=b,--f||u(new AggregateError(h))})})})}),bt.withResolvers&&(G.withResolvers=bt.withResolvers));var Ze={awaits:0,echoes:0,id:0},yh=0,da=[],ha=0,pa=0,bh=0;function Ir(a,s,u,f){var h=re,p=Object.create(h);return p.parent=h,p.ref=0,p.global=!1,p.id=++bh,Cr.env,p.env=Yt?{Promise:G,PromiseProp:{value:G,configurable:!0,writable:!0},all:G.all,race:G.race,allSettled:G.allSettled,any:G.any,resolve:G.resolve,reject:G.reject}:{},s&&d(p,s),++h.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},f=Gr(p,a,u,f),p.ref===0&&p.finalize(),f}function Sn(){return Ze.id||(Ze.id=++yh),++Ze.awaits,Ze.echoes+=Je,Ze.id}function Dr(){return!!Ze.awaits&&(--Ze.awaits==0&&(Ze.id=0),Ze.echoes=Ze.awaits*Je,!0)}function ma(a){return Ze.echoes&&a&&a.constructor===bt?(Sn(),a.then(function(s){return Dr(),s},function(s){return Dr(),He(s)})):a}function wh(){var a=da[da.length-1];da.pop(),Or(a,!1)}function Or(a,s){var u,f=re;(s?!Ze.echoes||ha++&&a===re:!ha||--ha&&a===re)||queueMicrotask(s?(function(h){++pa,Ze.echoes&&--Ze.echoes!=0||(Ze.echoes=Ze.awaits=Ze.id=0),da.push(re),Or(h,!0)}).bind(null,a):wh),a!==re&&(re=a,f===Cr&&(Cr.env=Uc()),Yt&&(u=Cr.env.Promise,s=a.env,(f.global||a.global)&&(Object.defineProperty(o,"Promise",s.PromiseProp),u.all=s.all,u.race=s.race,u.resolve=s.resolve,u.reject=s.reject,s.allSettled&&(u.allSettled=s.allSettled),s.any&&(u.any=s.any))))}function Uc(){var a=o.Promise;return Yt?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function Gr(a,s,u,f,h){var p=re;try{return Or(a,!0),s(u,f,h)}finally{Or(p,!1)}}function zc(a,s,u,f){return typeof a!="function"?a:function(){var h=re;u&&Sn(),Or(s,!0);try{return a.apply(this,arguments)}finally{Or(h,!1),f&&queueMicrotask(Dr)}}}function Ao(a){Promise===bt&&Ze.echoes===0?ha===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+Rt).indexOf("[native code]")===-1&&(Sn=Dr=L);var He=G.reject,Yr="￿",sr="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Wc="String expected.",xn=[],va="__dbnames",Bo="readonly",No="readwrite";function Jr(a,s){return a?s?function(){return a.apply(this,arguments)&&s.apply(this,arguments)}:a:s}var Vc={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function ga(a){return typeof a!="string"||/\./.test(a)?function(s){return s}:function(s){return s[a]===void 0&&a in s&&delete(s=De(s))[a],s}}function Qc(){throw ne.Type()}function be(a,s){try{var u=Gc(a),f=Gc(s);if(u!==f)return u==="Array"?1:f==="Array"?-1:u==="binary"?1:f==="binary"?-1:u==="string"?1:f==="string"?-1:u==="Date"?1:f!=="Date"?NaN:-1;switch(u){case"number":case"Date":case"string":return s<a?1:a<s?-1:0;case"binary":return function(h,p){for(var y=h.length,b=p.length,x=y<b?y:b,C=0;C<x;++C)if(h[C]!==p[C])return h[C]<p[C]?-1:1;return y===b?0:y<b?-1:1}(Yc(a),Yc(s));case"Array":return function(h,p){for(var y=h.length,b=p.length,x=y<b?y:b,C=0;C<x;++C){var O=be(h[C],p[C]);if(O!==0)return O}return y===b?0:y<b?-1:1}(a,s)}}catch{}return NaN}function Gc(a){var s=typeof a;return s!="object"?s:ArrayBuffer.isView(a)?"binary":(a=Te(a),a==="ArrayBuffer"?"binary":a)}function Yc(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}var Jc=($e.prototype._trans=function(a,s,u){var f=this._tx||re.trans,h=this.name,p=ae&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function y(C,O,w){if(!w.schema[h])throw new ne.NotFound("Table "+h+" not part of transaction");return s(w.idbtrans,w)}var b=_n();try{var x=f&&f.db._novip===this.db._novip?f===re.trans?f._promise(a,y,u):Ir(function(){return f._promise(a,y,u)},{trans:f,transless:re.transless||re}):function C(O,w,M,k){if(O.idbdb&&(O._state.openComplete||re.letThrough||O._vip)){var D=O._createTransaction(w,M,O._dbSchema);try{D.create(),O._state.PR1398_maxLoop=3}catch(R){return R.name===ar.InvalidState&&O.isOpen()&&0<--O._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),O.close({disableAutoOpen:!1}),O.open().then(function(){return C(O,w,M,k)})):He(R)}return D._promise(w,function(R,I){return Ir(function(){return re.trans=D,k(R,I,D)})}).then(function(R){if(w==="readwrite")try{D.idbtrans.commit()}catch{}return w==="readonly"?R:D._completion.then(function(){return R})})}if(O._state.openComplete)return He(new ne.DatabaseClosed(O._state.dbOpenError));if(!O._state.isBeingOpened){if(!O._state.autoOpen)return He(new ne.DatabaseClosed);O.open().catch(L)}return O._state.dbReadyPromise.then(function(){return C(O,w,M,k)})}(this.db,a,[this.name],y);return p&&(x._consoleTask=p,x=x.catch(function(C){return console.trace(C),He(C)})),x}finally{b&&En()}},$e.prototype.get=function(a,s){var u=this;return a&&a.constructor===Object?this.where(a).first(s):a==null?He(new ne.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return u.core.get({trans:f,key:a}).then(function(h){return u.hook.reading.fire(h)})}).then(s)},$e.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(l(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var s=c(a);if(s.length===1)return this.where(s[0]).equals(a[s[0]]);var u=this.schema.indexes.concat(this.schema.primKey).filter(function(b){if(b.compound&&s.every(function(C){return 0<=b.keyPath.indexOf(C)})){for(var x=0;x<s.length;++x)if(s.indexOf(b.keyPath[x])===-1)return!1;return!0}return!1}).sort(function(b,x){return b.keyPath.length-x.keyPath.length})[0];if(u&&this.db._maxKey!==Yr){var p=u.keyPath.slice(0,s.length);return this.where(p).equals(p.map(function(x){return a[x]}))}!u&&ae&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var f=this.schema.idxByName;function h(b,x){return be(b,x)===0}var y=s.reduce(function(w,x){var C=w[0],O=w[1],w=f[x],M=a[x];return[C||w,C||!w?Jr(O,w&&w.multi?function(k){return k=ee(k,x),l(k)&&k.some(function(D){return h(M,D)})}:function(k){return h(M,ee(k,x))}):O]},[null,null]),p=y[0],y=y[1];return p?this.where(p.name).equals(a[p.keyPath]).filter(y):u?this.filter(y):this.where(s).equals("")},$e.prototype.filter=function(a){return this.toCollection().and(a)},$e.prototype.count=function(a){return this.toCollection().count(a)},$e.prototype.offset=function(a){return this.toCollection().offset(a)},$e.prototype.limit=function(a){return this.toCollection().limit(a)},$e.prototype.each=function(a){return this.toCollection().each(a)},$e.prototype.toArray=function(a){return this.toCollection().toArray(a)},$e.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},$e.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,l(a)?"[".concat(a.join("+"),"]"):a))},$e.prototype.reverse=function(){return this.toCollection().reverse()},$e.prototype.mapToClass=function(a){var s,u=this.db,f=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof Qc&&(function(x,C){if(typeof C!="function"&&C!==null)throw new TypeError("Class extends value "+String(C)+" is not a constructor or null");function O(){this.constructor=x}r(x,C),x.prototype=C===null?Object.create(C):(O.prototype=C.prototype,new O)}(h,s=a),Object.defineProperty(h.prototype,"db",{get:function(){return u},enumerable:!1,configurable:!0}),h.prototype.table=function(){return f},a=h);for(var p=new Set,y=a.prototype;y;y=v(y))Object.getOwnPropertyNames(y).forEach(function(x){return p.add(x)});function b(x){if(!x)return x;var C,O=Object.create(a.prototype);for(C in x)if(!p.has(C))try{O[C]=x[C]}catch{}return O}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=b,this.hook("reading",b),a},$e.prototype.defineClass=function(){return this.mapToClass(function(a){d(this,a)})},$e.prototype.add=function(a,s){var u=this,f=this.schema.primKey,h=f.auto,p=f.keyPath,y=a;return p&&h&&(y=ga(p)(a)),this._trans("readwrite",function(b){return u.core.mutate({trans:b,type:"add",keys:s!=null?[s]:null,values:[y]})}).then(function(b){return b.numFailures?G.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{ie(a,p,b)}catch{}return b})},$e.prototype.update=function(a,s){return typeof a!="object"||l(a)?this.where(":id").equals(a).modify(s):(a=ee(a,this.schema.primKey.keyPath),a===void 0?He(new ne.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(s))},$e.prototype.put=function(a,s){var u=this,f=this.schema.primKey,h=f.auto,p=f.keyPath,y=a;return p&&h&&(y=ga(p)(a)),this._trans("readwrite",function(b){return u.core.mutate({trans:b,type:"put",values:[y],keys:s!=null?[s]:null})}).then(function(b){return b.numFailures?G.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{ie(a,p,b)}catch{}return b})},$e.prototype.delete=function(a){var s=this;return this._trans("readwrite",function(u){return s.core.mutate({trans:u,type:"delete",keys:[a]})}).then(function(u){return u.numFailures?G.reject(u.failures[0]):void 0})},$e.prototype.clear=function(){var a=this;return this._trans("readwrite",function(s){return a.core.mutate({trans:s,type:"deleteRange",range:Vc})}).then(function(s){return s.numFailures?G.reject(s.failures[0]):void 0})},$e.prototype.bulkGet=function(a){var s=this;return this._trans("readonly",function(u){return s.core.getMany({keys:a,trans:u}).then(function(f){return f.map(function(h){return s.hook.reading.fire(h)})})})},$e.prototype.bulkAdd=function(a,s,u){var f=this,h=Array.isArray(s)?s:void 0,p=(u=u||(h?void 0:s))?u.allKeys:void 0;return this._trans("readwrite",function(y){var C=f.schema.primKey,b=C.auto,C=C.keyPath;if(C&&h)throw new ne.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new ne.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,C=C&&b?a.map(ga(C)):a;return f.core.mutate({trans:y,type:"add",keys:h,values:C,wantResults:p}).then(function(D){var w=D.numFailures,M=D.results,k=D.lastResult,D=D.failures;if(w===0)return p?M:k;throw new Pt("".concat(f.name,".bulkAdd(): ").concat(w," of ").concat(x," operations failed"),D)})})},$e.prototype.bulkPut=function(a,s,u){var f=this,h=Array.isArray(s)?s:void 0,p=(u=u||(h?void 0:s))?u.allKeys:void 0;return this._trans("readwrite",function(y){var C=f.schema.primKey,b=C.auto,C=C.keyPath;if(C&&h)throw new ne.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new ne.InvalidArgument("Arguments objects and keys must have the same length");var x=a.length,C=C&&b?a.map(ga(C)):a;return f.core.mutate({trans:y,type:"put",keys:h,values:C,wantResults:p}).then(function(D){var w=D.numFailures,M=D.results,k=D.lastResult,D=D.failures;if(w===0)return p?M:k;throw new Pt("".concat(f.name,".bulkPut(): ").concat(w," of ").concat(x," operations failed"),D)})})},$e.prototype.bulkUpdate=function(a){var s=this,u=this.core,f=a.map(function(y){return y.key}),h=a.map(function(y){return y.changes}),p=[];return this._trans("readwrite",function(y){return u.getMany({trans:y,keys:f,cache:"clone"}).then(function(b){var x=[],C=[];a.forEach(function(w,M){var k=w.key,D=w.changes,R=b[M];if(R){for(var I=0,$=Object.keys(D);I<$.length;I++){var T=$[I],A=D[T];if(T===s.schema.primKey.keyPath){if(be(A,k)!==0)throw new ne.Constraint("Cannot update primary key in bulkUpdate()")}else ie(R,T,A)}p.push(M),x.push(k),C.push(R)}});var O=x.length;return u.mutate({trans:y,type:"put",keys:x,values:C,updates:{keys:f,changeSpecs:h}}).then(function(w){var M=w.numFailures,k=w.failures;if(M===0)return O;for(var D=0,R=Object.keys(k);D<R.length;D++){var I,$=R[D],T=p[Number($)];T!=null&&(I=k[$],delete k[$],k[T]=I)}throw new Pt("".concat(s.name,".bulkUpdate(): ").concat(M," of ").concat(O," operations failed"),k)})})})},$e.prototype.bulkDelete=function(a){var s=this,u=a.length;return this._trans("readwrite",function(f){return s.core.mutate({trans:f,type:"delete",keys:a})}).then(function(y){var h=y.numFailures,p=y.lastResult,y=y.failures;if(h===0)return p;throw new Pt("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(u," operations failed"),y)})},$e);function $e(){}function ai(a){function s(y,b){if(b){for(var x=arguments.length,C=new Array(x-1);--x;)C[x-1]=arguments[x];return u[y].subscribe.apply(null,C),a}if(typeof y=="string")return u[y]}var u={};s.addEventType=p;for(var f=1,h=arguments.length;f<h;++f)p(arguments[f]);return s;function p(y,b,x){if(typeof y!="object"){var C;b=b||qe;var O={subscribers:[],fire:x=x||L,subscribe:function(w){O.subscribers.indexOf(w)===-1&&(O.subscribers.push(w),O.fire=b(O.fire,w))},unsubscribe:function(w){O.subscribers=O.subscribers.filter(function(M){return M!==w}),O.fire=O.subscribers.reduce(b,x)}};return u[y]=s[y]=O}c(C=y).forEach(function(w){var M=C[w];if(l(M))p(w,C[w][0],C[w][1]);else{if(M!=="asap")throw new ne.InvalidArgument("Invalid event config");var k=p(w,Q,function(){for(var D=arguments.length,R=new Array(D);D--;)R[D]=arguments[D];k.subscribers.forEach(function(I){oe(function(){I.apply(null,R)})})})}})}}function oi(a,s){return P(s).from({prototype:a}),s}function kn(a,s){return!(a.filter||a.algorithm||a.or)&&(s?a.justLimit:!a.replayFilter)}function jo(a,s){a.filter=Jr(a.filter,s)}function Fo(a,s,u){var f=a.replayFilter;a.replayFilter=f?function(){return Jr(f(),s())}:s,a.justLimit=u&&!f}function ya(a,s){if(a.isPrimKey)return s.primaryKey;var u=s.getIndexByKeyPath(a.index);if(!u)throw new ne.Schema("KeyPath "+a.index+" on object store "+s.name+" is not indexed");return u}function Xc(a,s,u){var f=ya(a,s.schema);return s.openCursor({trans:u,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:f,range:a.range}})}function ba(a,s,u,f){var h=a.replayFilter?Jr(a.filter,a.replayFilter()):a.filter;if(a.or){var p={},y=function(b,x,C){var O,w;h&&!h(x,C,function(M){return x.stop(M)},function(M){return x.fail(M)})||((w=""+(O=x.primaryKey))=="[object ArrayBuffer]"&&(w=""+new Uint8Array(O)),g(p,w)||(p[w]=!0,s(b,x,C)))};return Promise.all([a.or._iterate(y,u),Zc(Xc(a,f,u),a.algorithm,y,!a.keysOnly&&a.valueMapper)])}return Zc(Xc(a,f,u),Jr(a.algorithm,h),s,!a.keysOnly&&a.valueMapper)}function Zc(a,s,u,f){var h=Ae(f?function(p,y,b){return u(f(p),y,b)}:u);return a.then(function(p){if(p)return p.start(function(){var y=function(){return p.continue()};s&&!s(p,function(b){return y=b},function(b){p.stop(b),y=L},function(b){p.fail(b),y=L})||h(p.value,p,function(b){return y=b}),y()})})}var cr=Symbol(),si=(eu.prototype.execute=function(a){if(this.add!==void 0){var s=this.add;if(l(s))return i(i([],l(a)?a:[],!0),s).sort();if(typeof s=="number")return(Number(a)||0)+s;if(typeof s=="bigint")try{return BigInt(a)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(this.remove!==void 0){var u=this.remove;if(l(u))return l(a)?a.filter(function(f){return!u.includes(f)}).sort():[];if(typeof u=="number")return Number(a)-u;if(typeof u=="bigint")try{return BigInt(a)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return s=(s=this.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof a=="string"&&a.startsWith(s)?this.replacePrefix[1]+a.substring(s.length):a},eu);function eu(a){Object.assign(this,a)}var _h=(Ee.prototype._read=function(a,s){var u=this._ctx;return u.error?u.table._trans(null,He.bind(null,u.error)):u.table._trans("readonly",a).then(s)},Ee.prototype._write=function(a){var s=this._ctx;return s.error?s.table._trans(null,He.bind(null,s.error)):s.table._trans("readwrite",a,"locked")},Ee.prototype._addAlgorithm=function(a){var s=this._ctx;s.algorithm=Jr(s.algorithm,a)},Ee.prototype._iterate=function(a,s){return ba(this._ctx,a,s,this._ctx.table.core)},Ee.prototype.clone=function(a){var s=Object.create(this.constructor.prototype),u=Object.create(this._ctx);return a&&d(u,a),s._ctx=u,s},Ee.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ee.prototype.each=function(a){var s=this._ctx;return this._read(function(u){return ba(s,a,u,s.table.core)})},Ee.prototype.count=function(a){var s=this;return this._read(function(u){var f=s._ctx,h=f.table.core;if(kn(f,!0))return h.count({trans:u,query:{index:ya(f,h.schema),range:f.range}}).then(function(y){return Math.min(y,f.limit)});var p=0;return ba(f,function(){return++p,!1},u,h).then(function(){return p})}).then(a)},Ee.prototype.sortBy=function(a,s){var u=a.split(".").reverse(),f=u[0],h=u.length-1;function p(x,C){return C?p(x[u[C]],C-1):x[f]}var y=this._ctx.dir==="next"?1:-1;function b(x,C){return be(p(x,h),p(C,h))*y}return this.toArray(function(x){return x.sort(b)}).then(s)},Ee.prototype.toArray=function(a){var s=this;return this._read(function(u){var f=s._ctx;if(f.dir==="next"&&kn(f,!0)&&0<f.limit){var h=f.valueMapper,p=ya(f,f.table.core.schema);return f.table.core.query({trans:u,limit:f.limit,values:!0,query:{index:p,range:f.range}}).then(function(b){return b=b.result,h?b.map(h):b})}var y=[];return ba(f,function(b){return y.push(b)},u,f.table.core).then(function(){return y})},a)},Ee.prototype.offset=function(a){var s=this._ctx;return a<=0||(s.offset+=a,kn(s)?Fo(s,function(){var u=a;return function(f,h){return u===0||(u===1?--u:h(function(){f.advance(u),u=0}),!1)}}):Fo(s,function(){var u=a;return function(){return--u<0}})),this},Ee.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),Fo(this._ctx,function(){var s=a;return function(u,f,h){return--s<=0&&f(h),0<=s}},!0),this},Ee.prototype.until=function(a,s){return jo(this._ctx,function(u,f,h){return!a(u.value)||(f(h),s)}),this},Ee.prototype.first=function(a){return this.limit(1).toArray(function(s){return s[0]}).then(a)},Ee.prototype.last=function(a){return this.reverse().first(a)},Ee.prototype.filter=function(a){var s;return jo(this._ctx,function(u){return a(u.value)}),(s=this._ctx).isMatch=Jr(s.isMatch,a),this},Ee.prototype.and=function(a){return this.filter(a)},Ee.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},Ee.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ee.prototype.desc=function(){return this.reverse()},Ee.prototype.eachKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(u,f){a(f.key,f)})},Ee.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},Ee.prototype.eachPrimaryKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(u,f){a(f.primaryKey,f)})},Ee.prototype.keys=function(a){var s=this._ctx;s.keysOnly=!s.isMatch;var u=[];return this.each(function(f,h){u.push(h.key)}).then(function(){return u}).then(a)},Ee.prototype.primaryKeys=function(a){var s=this._ctx;if(s.dir==="next"&&kn(s,!0)&&0<s.limit)return this._read(function(f){var h=ya(s,s.table.core.schema);return s.table.core.query({trans:f,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(f){return f.result}).then(a);s.keysOnly=!s.isMatch;var u=[];return this.each(function(f,h){u.push(h.primaryKey)}).then(function(){return u}).then(a)},Ee.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},Ee.prototype.firstKey=function(a){return this.limit(1).keys(function(s){return s[0]}).then(a)},Ee.prototype.lastKey=function(a){return this.reverse().firstKey(a)},Ee.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var s={};return jo(this._ctx,function(h){var f=h.primaryKey.toString(),h=g(s,f);return s[f]=!0,!h}),this},Ee.prototype.modify=function(a){var s=this,u=this._ctx;return this._write(function(f){var h,p,y;y=typeof a=="function"?a:(h=c(a),p=h.length,function(I){for(var $=!1,T=0;T<p;++T){var A=h[T],N=a[A],F=ee(I,A);N instanceof si?(ie(I,A,N.execute(F)),$=!0):F!==N&&(ie(I,A,N),$=!0)}return $});var b=u.table.core,w=b.schema.primaryKey,x=w.outbound,C=w.extractKey,O=200,w=s.db._options.modifyChunkSize;w&&(O=typeof w=="object"?w[b.name]||w["*"]||200:w);function M(I,A){var T=A.failures,A=A.numFailures;D+=I-A;for(var N=0,F=c(T);N<F.length;N++){var z=F[N];k.push(T[z])}}var k=[],D=0,R=[];return s.clone().primaryKeys().then(function(I){function $(A){var N=Math.min(O,I.length-A);return b.getMany({trans:f,keys:I.slice(A,A+N),cache:"immutable"}).then(function(F){for(var z=[],q=[],K=x?[]:null,W=[],U=0;U<N;++U){var J=F[U],le={value:De(J),primKey:I[A+U]};y.call(le,le.value,le)!==!1&&(le.value==null?W.push(I[A+U]):x||be(C(J),C(le.value))===0?(q.push(le.value),x&&K.push(I[A+U])):(W.push(I[A+U]),z.push(le.value)))}return Promise.resolve(0<z.length&&b.mutate({trans:f,type:"add",values:z}).then(function(ve){for(var ge in ve.failures)W.splice(parseInt(ge),1);M(z.length,ve)})).then(function(){return(0<q.length||T&&typeof a=="object")&&b.mutate({trans:f,type:"put",keys:K,values:q,criteria:T,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<A}).then(function(ve){return M(q.length,ve)})}).then(function(){return(0<W.length||T&&a===qo)&&b.mutate({trans:f,type:"delete",keys:W,criteria:T,isAdditionalChunk:0<A}).then(function(ve){return M(W.length,ve)})}).then(function(){return I.length>A+N&&$(A+O)})})}var T=kn(u)&&u.limit===1/0&&(typeof a!="function"||a===qo)&&{index:u.index,range:u.range};return $(0).then(function(){if(0<k.length)throw new mt("Error modifying one or more objects",k,D,R);return I.length})})})},Ee.prototype.delete=function(){var a=this._ctx,s=a.range;return kn(a)&&(a.isPrimKey||s.type===3)?this._write(function(u){var f=a.table.core.schema.primaryKey,h=s;return a.table.core.count({trans:u,query:{index:f,range:h}}).then(function(p){return a.table.core.mutate({trans:u,type:"deleteRange",range:h}).then(function(y){var b=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new mt("Could not delete some values",Object.keys(b).map(function(x){return b[x]}),p-y);return p-y})})}):this.modify(qo)},Ee);function Ee(){}var qo=function(a,s){return s.value=null};function Eh(a,s){return a<s?-1:a===s?0:1}function Sh(a,s){return s<a?-1:a===s?0:1}function wt(a,s,u){return a=a instanceof ru?new a.Collection(a):a,a._ctx.error=new(u||TypeError)(s),a}function Cn(a){return new a.Collection(a,function(){return tu("")}).limit(0)}function wa(a,s,u,f){var h,p,y,b,x,C,O,w=u.length;if(!u.every(function(D){return typeof D=="string"}))return wt(a,Wc);function M(D){h=D==="next"?function(I){return I.toUpperCase()}:function(I){return I.toLowerCase()},p=D==="next"?function(I){return I.toLowerCase()}:function(I){return I.toUpperCase()},y=D==="next"?Eh:Sh;var R=u.map(function(I){return{lower:p(I),upper:h(I)}}).sort(function(I,$){return y(I.lower,$.lower)});b=R.map(function(I){return I.upper}),x=R.map(function(I){return I.lower}),O=(C=D)==="next"?"":f}M("next"),a=new a.Collection(a,function(){return Pr(b[0],x[w-1]+f)}),a._ondirectionchange=function(D){M(D)};var k=0;return a._addAlgorithm(function(D,R,I){var $=D.key;if(typeof $!="string")return!1;var T=p($);if(s(T,x,k))return!0;for(var A=null,N=k;N<w;++N){var F=function(z,q,K,W,U,J){for(var le=Math.min(z.length,W.length),ve=-1,ge=0;ge<le;++ge){var _t=q[ge];if(_t!==W[ge])return U(z[ge],K[ge])<0?z.substr(0,ge)+K[ge]+K.substr(ge+1):U(z[ge],W[ge])<0?z.substr(0,ge)+W[ge]+K.substr(ge+1):0<=ve?z.substr(0,ve)+q[ve]+K.substr(ve+1):null;U(z[ge],_t)<0&&(ve=ge)}return le<W.length&&J==="next"?z+K.substr(z.length):le<z.length&&J==="prev"?z.substr(0,K.length):ve<0?null:z.substr(0,ve)+W[ve]+K.substr(ve+1)}($,T,b[N],x[N],y,C);F===null&&A===null?k=N+1:(A===null||0<y(A,F))&&(A=F)}return R(A!==null?function(){D.continue(A+O)}:I),!1}),a}function Pr(a,s,u,f){return{type:2,lower:a,upper:s,lowerOpen:u,upperOpen:f}}function tu(a){return{type:1,lower:a,upper:a}}var ru=(Object.defineProperty(et.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),et.prototype.between=function(a,s,u,f){u=u!==!1,f=f===!0;try{return 0<this._cmp(a,s)||this._cmp(a,s)===0&&(u||f)&&(!u||!f)?Cn(this):new this.Collection(this,function(){return Pr(a,s,!u,!f)})}catch{return wt(this,sr)}},et.prototype.equals=function(a){return a==null?wt(this,sr):new this.Collection(this,function(){return tu(a)})},et.prototype.above=function(a){return a==null?wt(this,sr):new this.Collection(this,function(){return Pr(a,void 0,!0)})},et.prototype.aboveOrEqual=function(a){return a==null?wt(this,sr):new this.Collection(this,function(){return Pr(a,void 0,!1)})},et.prototype.below=function(a){return a==null?wt(this,sr):new this.Collection(this,function(){return Pr(void 0,a,!1,!0)})},et.prototype.belowOrEqual=function(a){return a==null?wt(this,sr):new this.Collection(this,function(){return Pr(void 0,a)})},et.prototype.startsWith=function(a){return typeof a!="string"?wt(this,Wc):this.between(a,a+Yr,!0,!0)},et.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):wa(this,function(s,u){return s.indexOf(u[0])===0},[a],Yr)},et.prototype.equalsIgnoreCase=function(a){return wa(this,function(s,u){return s===u[0]},[a],"")},et.prototype.anyOfIgnoreCase=function(){var a=se.apply(it,arguments);return a.length===0?Cn(this):wa(this,function(s,u){return u.indexOf(s)!==-1},a,"")},et.prototype.startsWithAnyOfIgnoreCase=function(){var a=se.apply(it,arguments);return a.length===0?Cn(this):wa(this,function(s,u){return u.some(function(f){return s.indexOf(f)===0})},a,Yr)},et.prototype.anyOf=function(){var a=this,s=se.apply(it,arguments),u=this._cmp;try{s.sort(u)}catch{return wt(this,sr)}if(s.length===0)return Cn(this);var f=new this.Collection(this,function(){return Pr(s[0],s[s.length-1])});f._ondirectionchange=function(p){u=p==="next"?a._ascending:a._descending,s.sort(u)};var h=0;return f._addAlgorithm(function(p,y,b){for(var x=p.key;0<u(x,s[h]);)if(++h===s.length)return y(b),!1;return u(x,s[h])===0||(y(function(){p.continue(s[h])}),!1)}),f},et.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},et.prototype.noneOf=function(){var a=se.apply(it,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return wt(this,sr)}var s=a.reduce(function(u,f){return u?u.concat([[u[u.length-1][1],f]]):[[-1/0,f]]},null);return s.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},et.prototype.inAnyRange=function($,s){var u=this,f=this._cmp,h=this._ascending,p=this._descending,y=this._min,b=this._max;if($.length===0)return Cn(this);if(!$.every(function(T){return T[0]!==void 0&&T[1]!==void 0&&h(T[0],T[1])<=0}))return wt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ne.InvalidArgument);var x=!s||s.includeLowers!==!1,C=s&&s.includeUppers===!0,O,w=h;function M(T,A){return w(T[0],A[0])}try{(O=$.reduce(function(T,A){for(var N=0,F=T.length;N<F;++N){var z=T[N];if(f(A[0],z[1])<0&&0<f(A[1],z[0])){z[0]=y(z[0],A[0]),z[1]=b(z[1],A[1]);break}}return N===F&&T.push(A),T},[])).sort(M)}catch{return wt(this,sr)}var k=0,D=C?function(T){return 0<h(T,O[k][1])}:function(T){return 0<=h(T,O[k][1])},R=x?function(T){return 0<p(T,O[k][0])}:function(T){return 0<=p(T,O[k][0])},I=D,$=new this.Collection(this,function(){return Pr(O[0][0],O[O.length-1][1],!x,!C)});return $._ondirectionchange=function(T){w=T==="next"?(I=D,h):(I=R,p),O.sort(M)},$._addAlgorithm(function(T,A,N){for(var F,z=T.key;I(z);)if(++k===O.length)return A(N),!1;return!D(F=z)&&!R(F)||(u._cmp(z,O[k][1])===0||u._cmp(z,O[k][0])===0||A(function(){w===h?T.continue(O[k][0]):T.continue(O[k][1])}),!1)}),$},et.prototype.startsWithAnyOf=function(){var a=se.apply(it,arguments);return a.every(function(s){return typeof s=="string"})?a.length===0?Cn(this):this.inAnyRange(a.map(function(s){return[s,s+Yr]})):wt(this,"startsWithAnyOf() only works with strings")},et);function et(){}function Jt(a){return Ae(function(s){return ci(s),a(s.target.error),!1})}function ci(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var ui="storagemutated",Ho="x-storagemutated-1",Rr=ai(null,ui),xh=(Xt.prototype._lock=function(){return ce(!re.global),++this._reculock,this._reculock!==1||re.global||(re.lockOwnerFor=this),this},Xt.prototype._unlock=function(){if(ce(!re.global),--this._reculock==0)for(re.global||(re.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{Gr(a[1],a[0])}catch{}}return this},Xt.prototype._locked=function(){return this._reculock&&re.lockOwnerFor!==this},Xt.prototype.create=function(a){var s=this;if(!this.mode)return this;var u=this.db.idbdb,f=this.db._state.dbOpenError;if(ce(!this.idbtrans),!a&&!u)switch(f&&f.name){case"DatabaseClosedError":throw new ne.DatabaseClosed(f);case"MissingAPIError":throw new ne.MissingAPI(f.message,f);default:throw new ne.OpenFailed(f)}if(!this.active)throw new ne.TransactionInactive;return ce(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||u).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Ae(function(h){ci(h),s._reject(a.error)}),a.onabort=Ae(function(h){ci(h),s.active&&s._reject(new ne.Abort(a.error)),s.active=!1,s.on("abort").fire(h)}),a.oncomplete=Ae(function(){s.active=!1,s._resolve(),"mutatedParts"in a&&Rr.storagemutated.fire(a.mutatedParts)}),this},Xt.prototype._promise=function(a,s,u){var f=this;if(a==="readwrite"&&this.mode!=="readwrite")return He(new ne.ReadOnly("Transaction is readonly"));if(!this.active)return He(new ne.TransactionInactive);if(this._locked())return new G(function(p,y){f._blockedFuncs.push([function(){f._promise(a,s,u).then(p,y)},re])});if(u)return Ir(function(){var p=new G(function(y,b){f._lock();var x=s(y,b,f);x&&x.then&&x.then(y,b)});return p.finally(function(){return f._unlock()}),p._lib=!0,p});var h=new G(function(p,y){var b=s(p,y,f);b&&b.then&&b.then(p,y)});return h._lib=!0,h},Xt.prototype._root=function(){return this.parent?this.parent._root():this},Xt.prototype.waitFor=function(a){var s,u=this._root(),f=G.resolve(a);u._waitingFor?u._waitingFor=u._waitingFor.then(function(){return f}):(u._waitingFor=f,u._waitingQueue=[],s=u.idbtrans.objectStore(u.storeNames[0]),function p(){for(++u._spinCount;u._waitingQueue.length;)u._waitingQueue.shift()();u._waitingFor&&(s.get(-1/0).onsuccess=p)}());var h=u._waitingFor;return new G(function(p,y){f.then(function(b){return u._waitingQueue.push(Ae(p.bind(null,b)))},function(b){return u._waitingQueue.push(Ae(y.bind(null,b)))}).finally(function(){u._waitingFor===h&&(u._waitingFor=null)})})},Xt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ne.Abort))},Xt.prototype.table=function(a){var s=this._memoizedTables||(this._memoizedTables={});if(g(s,a))return s[a];var u=this.schema[a];if(!u)throw new ne.NotFound("Table "+a+" not part of transaction");return u=new this.db.Table(a,u,this),u.core=this.db.core.table(a),s[a]=u},Xt);function Xt(){}function Ko(a,s,u,f,h,p,y){return{name:a,keyPath:s,unique:u,multi:f,auto:h,compound:p,src:(u&&!y?"&":"")+(f?"*":"")+(h?"++":"")+nu(s)}}function nu(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function Uo(a,s,u){return{name:a,primKey:s,indexes:u,mappedClass:null,idxByName:(f=function(h){return[h.name,h]},u.reduce(function(h,p,y){return y=f(p,y),y&&(h[y[0]]=y[1]),h},{}))};var f}var li=function(a){try{return a.only([[]]),li=function(){return[[]]},[[]]}catch{return li=function(){return Yr},Yr}};function zo(a){return a==null?function(){}:typeof a=="string"?(s=a).split(".").length===1?function(u){return u[s]}:function(u){return ee(u,s)}:function(u){return ee(u,a)};var s}function iu(a){return[].slice.call(a)}var kh=0;function fi(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function Ch(a,s,x){function f(I){if(I.type===3)return null;if(I.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var k=I.lower,D=I.upper,R=I.lowerOpen,I=I.upperOpen;return k===void 0?D===void 0?null:s.upperBound(D,!!I):D===void 0?s.lowerBound(k,!!R):s.bound(k,D,!!R,!!I)}function h(M){var k,D=M.name;return{name:D,schema:M,mutate:function(R){var I=R.trans,$=R.type,T=R.keys,A=R.values,N=R.range;return new Promise(function(F,z){F=Ae(F);var q=I.objectStore(D),K=q.keyPath==null,W=$==="put"||$==="add";if(!W&&$!=="delete"&&$!=="deleteRange")throw new Error("Invalid operation type: "+$);var U,J=(T||A||{length:1}).length;if(T&&A&&T.length!==A.length)throw new Error("Given keys array must have same length as given values array.");if(J===0)return F({numFailures:0,failures:{},results:[],lastResult:void 0});function le(ut){++_t,ci(ut)}var ve=[],ge=[],_t=0;if($==="deleteRange"){if(N.type===4)return F({numFailures:_t,failures:ge,results:[],lastResult:void 0});N.type===3?ve.push(U=q.clear()):ve.push(U=q.delete(f(N)))}else{var K=W?K?[A,T]:[A,null]:[T,null],ue=K[0],ot=K[1];if(W)for(var st=0;st<J;++st)ve.push(U=ot&&ot[st]!==void 0?q[$](ue[st],ot[st]):q[$](ue[st])),U.onerror=le;else for(st=0;st<J;++st)ve.push(U=q[$](ue[st])),U.onerror=le}function $a(ut){ut=ut.target.result,ve.forEach(function(en,us){return en.error!=null&&(ge[us]=en.error)}),F({numFailures:_t,failures:ge,results:$==="delete"?T:ve.map(function(en){return en.result}),lastResult:ut})}U.onerror=function(ut){le(ut),$a(ut)},U.onsuccess=$a})},getMany:function(R){var I=R.trans,$=R.keys;return new Promise(function(T,A){T=Ae(T);for(var N,F=I.objectStore(D),z=$.length,q=new Array(z),K=0,W=0,U=function(ve){ve=ve.target,q[ve._pos]=ve.result,++W===K&&T(q)},J=Jt(A),le=0;le<z;++le)$[le]!=null&&((N=F.get($[le]))._pos=le,N.onsuccess=U,N.onerror=J,++K);K===0&&T(q)})},get:function(R){var I=R.trans,$=R.key;return new Promise(function(T,A){T=Ae(T);var N=I.objectStore(D).get($);N.onsuccess=function(F){return T(F.target.result)},N.onerror=Jt(A)})},query:(k=C,function(R){return new Promise(function(I,$){I=Ae(I);var T,A,N,K=R.trans,F=R.values,z=R.limit,U=R.query,q=z===1/0?void 0:z,W=U.index,U=U.range,K=K.objectStore(D),W=W.isPrimaryKey?K:K.index(W.name),U=f(U);if(z===0)return I({result:[]});k?((q=F?W.getAll(U,q):W.getAllKeys(U,q)).onsuccess=function(J){return I({result:J.target.result})},q.onerror=Jt($)):(T=0,A=!F&&"openKeyCursor"in W?W.openKeyCursor(U):W.openCursor(U),N=[],A.onsuccess=function(J){var le=A.result;return le?(N.push(F?le.value:le.primaryKey),++T===z?I({result:N}):void le.continue()):I({result:N})},A.onerror=Jt($))})}),openCursor:function(R){var I=R.trans,$=R.values,T=R.query,A=R.reverse,N=R.unique;return new Promise(function(F,z){F=Ae(F);var W=T.index,q=T.range,K=I.objectStore(D),K=W.isPrimaryKey?K:K.index(W.name),W=A?N?"prevunique":"prev":N?"nextunique":"next",U=!$&&"openKeyCursor"in K?K.openKeyCursor(f(q),W):K.openCursor(f(q),W);U.onerror=Jt(z),U.onsuccess=Ae(function(J){var le,ve,ge,_t,ue=U.result;ue?(ue.___id=++kh,ue.done=!1,le=ue.continue.bind(ue),ve=(ve=ue.continuePrimaryKey)&&ve.bind(ue),ge=ue.advance.bind(ue),_t=function(){throw new Error("Cursor not stopped")},ue.trans=I,ue.stop=ue.continue=ue.continuePrimaryKey=ue.advance=function(){throw new Error("Cursor not started")},ue.fail=Ae(z),ue.next=function(){var ot=this,st=1;return this.start(function(){return st--?ot.continue():ot.stop()}).then(function(){return ot})},ue.start=function(ot){function st(){if(U.result)try{ot()}catch(ut){ue.fail(ut)}else ue.done=!0,ue.start=function(){throw new Error("Cursor behind last entry")},ue.stop()}var $a=new Promise(function(ut,en){ut=Ae(ut),U.onerror=Jt(en),ue.fail=en,ue.stop=function(us){ue.stop=ue.continue=ue.continuePrimaryKey=ue.advance=_t,ut(us)}});return U.onsuccess=Ae(function(ut){U.onsuccess=st,st()}),ue.continue=le,ue.continuePrimaryKey=ve,ue.advance=ge,st(),$a},F(ue)):F(null)},z)})},count:function(R){var I=R.query,$=R.trans,T=I.index,A=I.range;return new Promise(function(N,F){var z=$.objectStore(D),q=T.isPrimaryKey?z:z.index(T.name),z=f(A),q=z?q.count(z):q.count();q.onsuccess=Ae(function(K){return N(K.target.result)}),q.onerror=Jt(F)})}}}var p,y,b,O=(y=x,b=iu((p=a).objectStoreNames),{schema:{name:p.name,tables:b.map(function(M){return y.objectStore(M)}).map(function(M){var k=M.keyPath,I=M.autoIncrement,D=l(k),R={},I={name:M.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:k==null,compound:D,keyPath:k,autoIncrement:I,unique:!0,extractKey:zo(k)},indexes:iu(M.indexNames).map(function($){return M.index($)}).map(function(N){var T=N.name,A=N.unique,F=N.multiEntry,N=N.keyPath,F={name:T,compound:l(N),keyPath:N,unique:A,multiEntry:F,extractKey:zo(N)};return R[fi(N)]=F}),getIndexByKeyPath:function($){return R[fi($)]}};return R[":id"]=I.primaryKey,k!=null&&(R[fi(k)]=I.primaryKey),I})},hasGetAll:0<b.length&&"getAll"in y.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),x=O.schema,C=O.hasGetAll,O=x.tables.map(h),w={};return O.forEach(function(M){return w[M.name]=M}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(M){if(!w[M])throw new Error("Table '".concat(M,"' not found"));return w[M]},MIN_KEY:-1/0,MAX_KEY:li(s),schema:x}}function Ih(a,s,u,f){var h=u.IDBKeyRange;return u.indexedDB,{dbcore:(f=Ch(s,h,f),a.dbcore.reduce(function(p,y){return y=y.create,n(n({},p),y(p))},f))}}function _a(a,f){var u=f.db,f=Ih(a._middlewares,u,a._deps,f);a.core=f.dbcore,a.tables.forEach(function(h){var p=h.name;a.core.schema.tables.some(function(y){return y.name===p})&&(h.core=a.core.table(p),a[p]instanceof a.Table&&(a[p].core=h.core))})}function Ea(a,s,u,f){u.forEach(function(h){var p=f[h];s.forEach(function(y){var b=function x(C,O){return B(C,O)||(C=v(C))&&x(C,O)}(y,h);(!b||"value"in b&&b.value===void 0)&&(y===a.Transaction.prototype||y instanceof a.Transaction?S(y,h,{get:function(){return this.table(h)},set:function(x){_(this,h,{value:x,writable:!0,configurable:!0,enumerable:!0})}}):y[h]=new a.Table(h,p))})})}function Wo(a,s){s.forEach(function(u){for(var f in u)u[f]instanceof a.Table&&delete u[f]})}function Dh(a,s){return a._cfg.version-s._cfg.version}function Oh(a,s,u,f){var h=a._dbSchema;u.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=Uo("$meta",ou("")[0],[]),a._storeNames.push("$meta"));var p=a._createTransaction("readwrite",a._storeNames,h);p.create(u),p._completion.catch(f);var y=p._reject.bind(p),b=re.transless||re;Ir(function(){return re.trans=p,re.transless=b,s!==0?(_a(a,u),C=s,((x=p).storeNames.includes("$meta")?x.table("$meta").get("version").then(function(O){return O??C}):G.resolve(C)).then(function(O){return M=O,k=p,D=u,R=[],O=(w=a)._versions,I=w._dbSchema=xa(0,w.idbdb,D),(O=O.filter(function($){return $._cfg.version>=M})).length!==0?(O.forEach(function($){R.push(function(){var T=I,A=$._cfg.dbschema;ka(w,T,D),ka(w,A,D),I=w._dbSchema=A;var N=Vo(T,A);N.add.forEach(function(W){Qo(D,W[0],W[1].primKey,W[1].indexes)}),N.change.forEach(function(W){if(W.recreate)throw new ne.Upgrade("Not yet support for changing primary key");var U=D.objectStore(W.name);W.add.forEach(function(J){return Sa(U,J)}),W.change.forEach(function(J){U.deleteIndex(J.name),Sa(U,J)}),W.del.forEach(function(J){return U.deleteIndex(J)})});var F=$._cfg.contentUpgrade;if(F&&$._cfg.version>M){_a(w,D),k._memoizedTables={};var z=me(A);N.del.forEach(function(W){z[W]=T[W]}),Wo(w,[w.Transaction.prototype]),Ea(w,[w.Transaction.prototype],c(z),z),k.schema=z;var q,K=_e(F);return K&&Sn(),N=G.follow(function(){var W;(q=F(k))&&K&&(W=Dr.bind(null,null),q.then(W,W))}),q&&typeof q.then=="function"?G.resolve(q):N.then(function(){return q})}}),R.push(function(T){var A,N,F=$._cfg.dbschema;A=F,N=T,[].slice.call(N.db.objectStoreNames).forEach(function(z){return A[z]==null&&N.db.deleteObjectStore(z)}),Wo(w,[w.Transaction.prototype]),Ea(w,[w.Transaction.prototype],w._storeNames,w._dbSchema),k.schema=w._dbSchema}),R.push(function(T){w.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(w.idbdb.version/10)===$._cfg.version?(w.idbdb.deleteObjectStore("$meta"),delete w._dbSchema.$meta,w._storeNames=w._storeNames.filter(function(A){return A!=="$meta"})):T.objectStore("$meta").put($._cfg.version,"version"))})}),function $(){return R.length?G.resolve(R.shift()(k.idbtrans)).then($):G.resolve()}().then(function(){au(I,D)})):G.resolve();var w,M,k,D,R,I}).catch(y)):(c(h).forEach(function(O){Qo(u,O,h[O].primKey,h[O].indexes)}),_a(a,u),void G.follow(function(){return a.on.populate.fire(p)}).catch(y));var x,C})}function Ph(a,s){au(a._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var u=xa(0,a.idbdb,s);ka(a,a._dbSchema,s);for(var f=0,h=Vo(u,a._dbSchema).change;f<h.length;f++){var p=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var b=s.objectStore(y.name);y.add.forEach(function(x){ae&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(x.src)),Sa(b,x)})}(h[f]);if(typeof p=="object")return p.value}}function Vo(a,s){var u,f={del:[],add:[],change:[]};for(u in a)s[u]||f.del.push(u);for(u in s){var h=a[u],p=s[u];if(h){var y={name:u,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||h.primKey.auto!==p.primKey.auto)y.recreate=!0,f.change.push(y);else{var b=h.idxByName,x=p.idxByName,C=void 0;for(C in b)x[C]||y.del.push(C);for(C in x){var O=b[C],w=x[C];O?O.src!==w.src&&y.change.push(w):y.add.push(w)}(0<y.del.length||0<y.add.length||0<y.change.length)&&f.change.push(y)}}else f.add.push([u,p])}return f}function Qo(a,s,u,f){var h=a.db.createObjectStore(s,u.keyPath?{keyPath:u.keyPath,autoIncrement:u.auto}:{autoIncrement:u.auto});return f.forEach(function(p){return Sa(h,p)}),h}function au(a,s){c(a).forEach(function(u){s.db.objectStoreNames.contains(u)||(ae&&console.debug("Dexie: Creating missing table",u),Qo(s,u,a[u].primKey,a[u].indexes))})}function Sa(a,s){a.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function xa(a,s,u){var f={};return H(s.objectStoreNames,0).forEach(function(h){for(var p=u.objectStore(h),y=Ko(nu(C=p.keyPath),C||"",!0,!1,!!p.autoIncrement,C&&typeof C!="string",!0),b=[],x=0;x<p.indexNames.length;++x){var O=p.index(p.indexNames[x]),C=O.keyPath,O=Ko(O.name,C,!!O.unique,!!O.multiEntry,!1,C&&typeof C!="string",!1);b.push(O)}f[h]=Uo(h,y,b)}),f}function ka(a,s,u){for(var f=u.db.objectStoreNames,h=0;h<f.length;++h){var p=f[h],y=u.objectStore(p);a._hasGetAll="getAll"in y;for(var b=0;b<y.indexNames.length;++b){var x=y.indexNames[b],C=y.index(x).keyPath,O=typeof C=="string"?C:"["+H(C).join("+")+"]";!s[p]||(C=s[p].idxByName[O])&&(C.name=x,delete s[p].idxByName[O],s[p].idxByName[x]=C)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function ou(a){return a.split(",").map(function(s,u){var f=(s=s.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return Ko(f,h||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),l(h),u===0)})}var Rh=(Ca.prototype._parseStoresSpec=function(a,s){c(a).forEach(function(u){if(a[u]!==null){var f=ou(a[u]),h=f.shift();if(h.unique=!0,h.multi)throw new ne.Schema("Primary key cannot be multi-valued");f.forEach(function(p){if(p.auto)throw new ne.Schema("Only primary key can be marked as autoIncrement (++)");if(!p.keyPath)throw new ne.Schema("Index must have a name and cannot be an empty string")}),s[u]=Uo(u,h,f)}})},Ca.prototype.stores=function(u){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?d(this._cfg.storesSource,u):u;var u=s._versions,f={},h={};return u.forEach(function(p){d(f,p._cfg.storesSource),h=p._cfg.dbschema={},p._parseStoresSpec(f,h)}),s._dbSchema=h,Wo(s,[s._allTables,s,s.Transaction.prototype]),Ea(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],c(h),h),s._storeNames=c(h),this},Ca.prototype.upgrade=function(a){return this._cfg.contentUpgrade=wn(this._cfg.contentUpgrade||L,a),this},Ca);function Ca(){}function Go(a,s){var u=a._dbNamesDB;return u||(u=a._dbNamesDB=new ur(va,{addons:[],indexedDB:a,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),u.table("dbnames")}function Yo(a){return a&&typeof a.databases=="function"}function Jo(a){return Ir(function(){return re.letThrough=!0,a()})}function Xo(a){return!("from"in a)}var at=function(a,s){if(!this){var u=new at;return a&&"d"in a&&d(u,a),u}d(this,arguments.length?{d:1,from:a,to:1<arguments.length?s:a}:{d:0})};function di(a,s,u){var f=be(s,u);if(!isNaN(f)){if(0<f)throw RangeError();if(Xo(a))return d(a,{from:s,to:u,d:1});var h=a.l,f=a.r;if(be(u,a.from)<0)return h?di(h,s,u):a.l={from:s,to:u,d:1,l:null,r:null},cu(a);if(0<be(s,a.to))return f?di(f,s,u):a.r={from:s,to:u,d:1,l:null,r:null},cu(a);be(s,a.from)<0&&(a.from=s,a.l=null,a.d=f?f.d+1:1),0<be(u,a.to)&&(a.to=u,a.r=null,a.d=a.l?a.l.d+1:1),u=!a.r,h&&!a.l&&hi(a,h),f&&u&&hi(a,f)}}function hi(a,s){Xo(s)||function u(f,x){var p=x.from,y=x.to,b=x.l,x=x.r;di(f,p,y),b&&u(f,b),x&&u(f,x)}(a,s)}function su(a,s){var u=Ia(s),f=u.next();if(f.done)return!1;for(var h=f.value,p=Ia(a),y=p.next(h.from),b=y.value;!f.done&&!y.done;){if(be(b.from,h.to)<=0&&0<=be(b.to,h.from))return!0;be(h.from,b.from)<0?h=(f=u.next(b.from)).value:b=(y=p.next(h.from)).value}return!1}function Ia(a){var s=Xo(a)?null:{s:0,n:a};return{next:function(u){for(var f=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,f)for(;s.n.l&&be(u,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!f||be(u,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function cu(a){var s,u,f=(((s=a.r)===null||s===void 0?void 0:s.d)||0)-(((u=a.l)===null||u===void 0?void 0:u.d)||0),h=1<f?"r":f<-1?"l":"";h&&(s=h=="r"?"l":"r",u=n({},a),f=a[h],a.from=f.from,a.to=f.to,a[h]=f[h],u[h]=f[s],(a[s]=u).d=uu(u)),a.d=uu(a)}function uu(u){var s=u.r,u=u.l;return(s?u?Math.max(s.d,u.d):s.d:u?u.d:0)+1}function Da(a,s){return c(s).forEach(function(u){a[u]?hi(a[u],s[u]):a[u]=function f(h){var p,y,b={};for(p in h)g(h,p)&&(y=h[p],b[p]=!y||typeof y!="object"||Le.has(y.constructor)?y:f(y));return b}(s[u])}),a}function Zo(a,s){return a.all||s.all||Object.keys(a).some(function(u){return s[u]&&su(s[u],a[u])})}E(at.prototype,((Rt={add:function(a){return hi(this,a),this},addKey:function(a){return di(this,a,a),this},addKeys:function(a){var s=this;return a.forEach(function(u){return di(s,u,u)}),this},hasKey:function(a){var s=Ia(this).next(a).value;return s&&be(s.from,a)<=0&&0<=be(s.to,a)}})[Xe]=function(){return Ia(this)},Rt));var Xr={},es={},ts=!1;function Oa(a){Da(es,a),ts||(ts=!0,setTimeout(function(){ts=!1,rs(es,!(es={}))},0))}function rs(a,s){s===void 0&&(s=!1);var u=new Set;if(a.all)for(var f=0,h=Object.values(Xr);f<h.length;f++)lu(y=h[f],a,u,s);else for(var p in a){var y,b=/^idb\:\/\/(.*)\/(.*)\//.exec(p);b&&(p=b[1],b=b[2],(y=Xr["idb://".concat(p,"/").concat(b)])&&lu(y,a,u,s))}u.forEach(function(x){return x()})}function lu(a,s,u,f){for(var h=[],p=0,y=Object.entries(a.queries.query);p<y.length;p++){for(var b=y[p],x=b[0],C=[],O=0,w=b[1];O<w.length;O++){var M=w[O];Zo(s,M.obsSet)?M.subscribers.forEach(function(I){return u.add(I)}):f&&C.push(M)}f&&h.push([x,C])}if(f)for(var k=0,D=h;k<D.length;k++){var R=D[k],x=R[0],C=R[1];a.queries.query[x]=C}}function Mh(a){var s=a._state,u=a._deps.indexedDB;if(s.isBeingOpened||a.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?He(s.dbOpenError):a});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var f=s.openCanceller,h=Math.round(10*a.verno),p=!1;function y(){if(s.openCanceller!==f)throw new ne.DatabaseClosed("db.open() was cancelled")}function b(){return new G(function(M,k){if(y(),!u)throw new ne.MissingAPI;var D=a.name,R=s.autoSchema||!h?u.open(D):u.open(D,h);if(!R)throw new ne.MissingAPI;R.onerror=Jt(k),R.onblocked=Ae(a._fireOnBlocked),R.onupgradeneeded=Ae(function(I){var $;O=R.transaction,s.autoSchema&&!a._options.allowEmptyDB?(R.onerror=ci,O.abort(),R.result.close(),($=u.deleteDatabase(D)).onsuccess=$.onerror=Ae(function(){k(new ne.NoSuchDatabase("Database ".concat(D," doesnt exist")))})):(O.onerror=Jt(k),I=I.oldVersion>Math.pow(2,62)?0:I.oldVersion,w=I<1,a.idbdb=R.result,p&&Ph(a,O),Oh(a,I/10,O,k))},k),R.onsuccess=Ae(function(){O=null;var I,$,T,A,N,F=a.idbdb=R.result,z=H(F.objectStoreNames);if(0<z.length)try{var q=F.transaction((A=z).length===1?A[0]:A,"readonly");if(s.autoSchema)$=F,T=q,(I=a).verno=$.version/10,T=I._dbSchema=xa(0,$,T),I._storeNames=H($.objectStoreNames,0),Ea(I,[I._allTables],c(T),T);else if(ka(a,a._dbSchema,q),((N=Vo(xa(0,(N=a).idbdb,q),N._dbSchema)).add.length||N.change.some(function(K){return K.add.length||K.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),F.close(),h=F.version+1,p=!0,M(b());_a(a,q)}catch{}xn.push(a),F.onversionchange=Ae(function(K){s.vcFired=!0,a.on("versionchange").fire(K)}),F.onclose=Ae(function(K){a.on("close").fire(K)}),w&&(N=a._deps,q=D,F=N.indexedDB,N=N.IDBKeyRange,Yo(F)||q===va||Go(F,N).put({name:q}).catch(L)),M()},k)}).catch(function(M){switch(M==null?void 0:M.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),b();break;case"VersionError":if(0<h)return h=0,b()}return G.reject(M)})}var x,C=s.dbReadyResolve,O=null,w=!1;return G.race([f,(typeof navigator>"u"?G.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(M){function k(){return indexedDB.databases().finally(M)}x=setInterval(k,100),k()}).finally(function(){return clearInterval(x)}):Promise.resolve()).then(b)]).then(function(){return y(),s.onReadyBeingFired=[],G.resolve(Jo(function(){return a.on.ready.fire(a.vip)})).then(function M(){if(0<s.onReadyBeingFired.length){var k=s.onReadyBeingFired.reduce(wn,L);return s.onReadyBeingFired=[],G.resolve(Jo(function(){return k(a.vip)})).then(M)}})}).finally(function(){s.openCanceller===f&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(M){s.dbOpenError=M;try{O&&O.abort()}catch{}return f===s.openCanceller&&a._close(),He(M)}).finally(function(){s.openComplete=!0,C()}).then(function(){var M;return w&&(M={},a.tables.forEach(function(k){k.schema.indexes.forEach(function(D){D.name&&(M["idb://".concat(a.name,"/").concat(k.name,"/").concat(D.name)]=new at(-1/0,[[[]]]))}),M["idb://".concat(a.name,"/").concat(k.name,"/")]=M["idb://".concat(a.name,"/").concat(k.name,"/:dels")]=new at(-1/0,[[[]]])}),Rr(ui).fire(M),rs(M,!0)),a})}function ns(a){function s(p){return a.next(p)}var u=h(s),f=h(function(p){return a.throw(p)});function h(p){return function(x){var b=p(x),x=b.value;return b.done?x:x&&typeof x.then=="function"?x.then(u,f):l(x)?Promise.all(x).then(u,f):u(x)}}return h(s)()}function Pa(a,s,u){for(var f=l(a)?a.slice():[a],h=0;h<u;++h)f.push(s);return f}var $h={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return n(n({},a),{table:function(s){var u=a.table(s),f=u.schema,h={},p=[];function y(w,M,k){var D=fi(w),R=h[D]=h[D]||[],I=w==null?0:typeof w=="string"?1:w.length,$=0<M,$=n(n({},k),{name:$?"".concat(D,"(virtual-from:").concat(k.name,")"):k.name,lowLevelIndex:k,isVirtual:$,keyTail:M,keyLength:I,extractKey:zo(w),unique:!$&&k.unique});return R.push($),$.isPrimaryKey||p.push($),1<I&&y(I===2?w[0]:w.slice(0,I-1),M+1,k),R.sort(function(T,A){return T.keyTail-A.keyTail}),$}s=y(f.primaryKey.keyPath,0,f.primaryKey),h[":id"]=[s];for(var b=0,x=f.indexes;b<x.length;b++){var C=x[b];y(C.keyPath,0,C)}function O(w){var M,k=w.query.index;return k.isVirtual?n(n({},w),{query:{index:k.lowLevelIndex,range:(M=w.query.range,k=k.keyTail,{type:M.type===1?2:M.type,lower:Pa(M.lower,M.lowerOpen?a.MAX_KEY:a.MIN_KEY,k),lowerOpen:!0,upper:Pa(M.upper,M.upperOpen?a.MIN_KEY:a.MAX_KEY,k),upperOpen:!0})}}):w}return n(n({},u),{schema:n(n({},f),{primaryKey:s,indexes:p,getIndexByKeyPath:function(w){return(w=h[fi(w)])&&w[0]}}),count:function(w){return u.count(O(w))},query:function(w){return u.query(O(w))},openCursor:function(w){var M=w.query.index,k=M.keyTail,D=M.isVirtual,R=M.keyLength;return D?u.openCursor(O(w)).then(function($){return $&&I($)}):u.openCursor(w);function I($){return Object.create($,{continue:{value:function(T){T!=null?$.continue(Pa(T,w.reverse?a.MAX_KEY:a.MIN_KEY,k)):w.unique?$.continue($.key.slice(0,R).concat(w.reverse?a.MIN_KEY:a.MAX_KEY,k)):$.continue()}},continuePrimaryKey:{value:function(T,A){$.continuePrimaryKey(Pa(T,a.MAX_KEY,k),A)}},primaryKey:{get:function(){return $.primaryKey}},key:{get:function(){var T=$.key;return R===1?T[0]:T.slice(0,R)}},value:{get:function(){return $.value}}})}}})}})}};function is(a,s,u,f){return u=u||{},f=f||"",c(a).forEach(function(h){var p,y,b;g(s,h)?(p=a[h],y=s[h],typeof p=="object"&&typeof y=="object"&&p&&y?(b=Te(p))!==Te(y)?u[f+h]=s[h]:b==="Object"?is(p,y,u,f+h+"."):p!==y&&(u[f+h]=s[h]):p!==y&&(u[f+h]=s[h])):u[f+h]=void 0}),c(s).forEach(function(h){g(a,h)||(u[f+h]=s[h])}),u}function as(a,s){return s.type==="delete"?s.keys:s.keys||s.values.map(a.extractKey)}var Lh={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return n(n({},a),{table:function(s){var u=a.table(s),f=u.schema.primaryKey;return n(n({},u),{mutate:function(h){var p=re.trans,y=p.table(s).hook,b=y.deleting,x=y.creating,C=y.updating;switch(h.type){case"add":if(x.fire===L)break;return p._promise("readwrite",function(){return O(h)},!0);case"put":if(x.fire===L&&C.fire===L)break;return p._promise("readwrite",function(){return O(h)},!0);case"delete":if(b.fire===L)break;return p._promise("readwrite",function(){return O(h)},!0);case"deleteRange":if(b.fire===L)break;return p._promise("readwrite",function(){return function w(M,k,D){return u.query({trans:M,values:!1,query:{index:f,range:k},limit:D}).then(function(R){var I=R.result;return O({type:"delete",keys:I,trans:M}).then(function($){return 0<$.numFailures?Promise.reject($.failures[0]):I.length<D?{failures:[],numFailures:0,lastResult:void 0}:w(M,n(n({},k),{lower:I[I.length-1],lowerOpen:!0}),D)})})}(h.trans,h.range,1e4)},!0)}return u.mutate(h);function O(w){var M,k,D,R=re.trans,I=w.keys||as(f,w);if(!I)throw new Error("Keys missing");return(w=w.type==="add"||w.type==="put"?n(n({},w),{keys:I}):n({},w)).type!=="delete"&&(w.values=i([],w.values)),w.keys&&(w.keys=i([],w.keys)),M=u,D=I,((k=w).type==="add"?Promise.resolve([]):M.getMany({trans:k.trans,keys:D,cache:"immutable"})).then(function($){var T=I.map(function(A,N){var F,z,q,K=$[N],W={onerror:null,onsuccess:null};return w.type==="delete"?b.fire.call(W,A,K,R):w.type==="add"||K===void 0?(F=x.fire.call(W,A,w.values[N],R),A==null&&F!=null&&(w.keys[N]=A=F,f.outbound||ie(w.values[N],f.keyPath,A))):(F=is(K,w.values[N]),(z=C.fire.call(W,F,A,K,R))&&(q=w.values[N],Object.keys(z).forEach(function(U){g(q,U)?q[U]=z[U]:ie(q,U,z[U])}))),W});return u.mutate(w).then(function(A){for(var N=A.failures,F=A.results,z=A.numFailures,A=A.lastResult,q=0;q<I.length;++q){var K=(F||I)[q],W=T[q];K==null?W.onerror&&W.onerror(N[q]):W.onsuccess&&W.onsuccess(w.type==="put"&&$[q]?w.values[q]:K)}return{failures:N,results:F,numFailures:z,lastResult:A}}).catch(function(A){return T.forEach(function(N){return N.onerror&&N.onerror(A)}),Promise.reject(A)})})}}})}})}};function fu(a,s,u){try{if(!s||s.keys.length<a.length)return null;for(var f=[],h=0,p=0;h<s.keys.length&&p<a.length;++h)be(s.keys[h],a[p])===0&&(f.push(u?De(s.values[h]):s.values[h]),++p);return f.length===a.length?f:null}catch{return null}}var Th={stack:"dbcore",level:-1,create:function(a){return{table:function(s){var u=a.table(s);return n(n({},u),{getMany:function(f){if(!f.cache)return u.getMany(f);var h=fu(f.keys,f.trans._cache,f.cache==="clone");return h?G.resolve(h):u.getMany(f).then(function(p){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?De(p):p},p})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),u.mutate(f)}})}}}};function du(a,s){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function hu(a,s){switch(a){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Ah={stack:"dbcore",level:0,name:"Observability",create:function(a){var s=a.schema.name,u=new at(a.MIN_KEY,a.MAX_KEY);return n(n({},a),{transaction:function(f,h,p){if(re.subscr&&h!=="readonly")throw new ne.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(re.querier));return a.transaction(f,h,p)},table:function(f){var h=a.table(f),p=h.schema,y=p.primaryKey,w=p.indexes,b=y.extractKey,x=y.outbound,C=y.autoIncrement&&w.filter(function(k){return k.compound&&k.keyPath.includes(y.keyPath)}),O=n(n({},h),{mutate:function(k){function D(U){return U="idb://".concat(s,"/").concat(f,"/").concat(U),A[U]||(A[U]=new at)}var R,I,$,T=k.trans,A=k.mutatedParts||(k.mutatedParts={}),N=D(""),F=D(":dels"),z=k.type,W=k.type==="deleteRange"?[k.range]:k.type==="delete"?[k.keys]:k.values.length<50?[as(y,k).filter(function(U){return U}),k.values]:[],q=W[0],K=W[1],W=k.trans._cache;return l(q)?(N.addKeys(q),(W=z==="delete"||q.length===K.length?fu(q,W):null)||F.addKeys(q),(W||K)&&(R=D,I=W,$=K,p.indexes.forEach(function(U){var J=R(U.name||"");function le(ge){return ge!=null?U.extractKey(ge):null}function ve(ge){return U.multiEntry&&l(ge)?ge.forEach(function(_t){return J.addKey(_t)}):J.addKey(ge)}(I||$).forEach(function(ge,ot){var ue=I&&le(I[ot]),ot=$&&le($[ot]);be(ue,ot)!==0&&(ue!=null&&ve(ue),ot!=null&&ve(ot))})}))):q?(K={from:(K=q.lower)!==null&&K!==void 0?K:a.MIN_KEY,to:(K=q.upper)!==null&&K!==void 0?K:a.MAX_KEY},F.add(K),N.add(K)):(N.add(u),F.add(u),p.indexes.forEach(function(U){return D(U.name).add(u)})),h.mutate(k).then(function(U){return!q||k.type!=="add"&&k.type!=="put"||(N.addKeys(U.results),C&&C.forEach(function(J){for(var le=k.values.map(function(ue){return J.extractKey(ue)}),ve=J.keyPath.findIndex(function(ue){return ue===y.keyPath}),ge=0,_t=U.results.length;ge<_t;++ge)le[ge][ve]=U.results[ge];D(J.name).addKeys(le)})),T.mutatedParts=Da(T.mutatedParts||{},A),U})}}),w=function(D){var R=D.query,D=R.index,R=R.range;return[D,new at((D=R.lower)!==null&&D!==void 0?D:a.MIN_KEY,(R=R.upper)!==null&&R!==void 0?R:a.MAX_KEY)]},M={get:function(k){return[y,new at(k.key)]},getMany:function(k){return[y,new at().addKeys(k.keys)]},count:w,query:w,openCursor:w};return c(M).forEach(function(k){O[k]=function(D){var R=re.subscr,I=!!R,$=du(re,h)&&hu(k,D)?D.obsSet={}:R;if(I){var T=function(K){return K="idb://".concat(s,"/").concat(f,"/").concat(K),$[K]||($[K]=new at)},A=T(""),N=T(":dels"),R=M[k](D),I=R[0],R=R[1];if((k==="query"&&I.isPrimaryKey&&!D.values?N:T(I.name||"")).add(R),!I.isPrimaryKey){if(k!=="count"){var F=k==="query"&&x&&D.values&&h.query(n(n({},D),{values:!1}));return h[k].apply(this,arguments).then(function(K){if(k==="query"){if(x&&D.values)return F.then(function(le){return le=le.result,A.addKeys(le),K});var W=D.values?K.result.map(b):K.result;(D.values?A:N).addKeys(W)}else if(k==="openCursor"){var U=K,J=D.values;return U&&Object.create(U,{key:{get:function(){return N.addKey(U.primaryKey),U.key}},primaryKey:{get:function(){var le=U.primaryKey;return N.addKey(le),le}},value:{get:function(){return J&&A.addKey(U.primaryKey),U.value}}})}return K})}N.add(u)}}return h[k].apply(this,arguments)}}),O}})}};function pu(a,s,u){if(u.numFailures===0)return s;if(s.type==="deleteRange")return null;var f=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return u.numFailures===f?null:(s=n({},s),l(s.keys)&&(s.keys=s.keys.filter(function(h,p){return!(p in u.failures)})),"values"in s&&l(s.values)&&(s.values=s.values.filter(function(h,p){return!(p in u.failures)})),s)}function os(a,s){return u=a,((f=s).lower===void 0||(f.lowerOpen?0<be(u,f.lower):0<=be(u,f.lower)))&&(a=a,(s=s).upper===void 0||(s.upperOpen?be(a,s.upper)<0:be(a,s.upper)<=0));var u,f}function mu(a,s,M,f,h,p){if(!M||M.length===0)return a;var y=s.query.index,b=y.multiEntry,x=s.query.range,C=f.schema.primaryKey.extractKey,O=y.extractKey,w=(y.lowLevelIndex||y).extractKey,M=M.reduce(function(k,D){var R=k,I=[];if(D.type==="add"||D.type==="put")for(var $=new at,T=D.values.length-1;0<=T;--T){var A,N=D.values[T],F=C(N);$.hasKey(F)||(A=O(N),(b&&l(A)?A.some(function(U){return os(U,x)}):os(A,x))&&($.addKey(F),I.push(N)))}switch(D.type){case"add":var z=new at().addKeys(s.values?k.map(function(J){return C(J)}):k),R=k.concat(s.values?I.filter(function(J){return J=C(J),!z.hasKey(J)&&(z.addKey(J),!0)}):I.map(function(J){return C(J)}).filter(function(J){return!z.hasKey(J)&&(z.addKey(J),!0)}));break;case"put":var q=new at().addKeys(D.values.map(function(J){return C(J)}));R=k.filter(function(J){return!q.hasKey(s.values?C(J):J)}).concat(s.values?I:I.map(function(J){return C(J)}));break;case"delete":var K=new at().addKeys(D.keys);R=k.filter(function(J){return!K.hasKey(s.values?C(J):J)});break;case"deleteRange":var W=D.range;R=k.filter(function(J){return!os(C(J),W)})}return R},a);return M===a?a:(M.sort(function(k,D){return be(w(k),w(D))||be(C(k),C(D))}),s.limit&&s.limit<1/0&&(M.length>s.limit?M.length=s.limit:a.length===s.limit&&M.length<s.limit&&(h.dirty=!0)),p?Object.freeze(M):M)}function vu(a,s){return be(a.lower,s.lower)===0&&be(a.upper,s.upper)===0&&!!a.lowerOpen==!!s.lowerOpen&&!!a.upperOpen==!!s.upperOpen}function Bh(a,s){return function(u,f,h,p){if(u===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=be(u,f))===0){if(h&&p)return 0;if(h)return 1;if(p)return-1}return f}(a.lower,s.lower,a.lowerOpen,s.lowerOpen)<=0&&0<=function(u,f,h,p){if(u===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=be(u,f))===0){if(h&&p)return 0;if(h)return-1;if(p)return 1}return f}(a.upper,s.upper,a.upperOpen,s.upperOpen)}function Nh(a,s,u,f){a.subscribers.add(u),f.addEventListener("abort",function(){var h,p;a.subscribers.delete(u),a.subscribers.size===0&&(h=a,p=s,setTimeout(function(){h.subscribers.size===0&&Ne(p,h)},3e3))})}var jh={stack:"dbcore",level:0,name:"Cache",create:function(a){var s=a.schema.name;return n(n({},a),{transaction:function(u,f,h){var p,y,b=a.transaction(u,f,h);return f==="readwrite"&&(y=(p=new AbortController).signal,h=function(x){return function(){if(p.abort(),f==="readwrite"){for(var C=new Set,O=0,w=u;O<w.length;O++){var M=w[O],k=Xr["idb://".concat(s,"/").concat(M)];if(k){var D=a.table(M),R=k.optimisticOps.filter(function(J){return J.trans===b});if(b._explicit&&x&&b.mutatedParts)for(var I=0,$=Object.values(k.queries.query);I<$.length;I++)for(var T=0,A=(z=$[I]).slice();T<A.length;T++)Zo((q=A[T]).obsSet,b.mutatedParts)&&(Ne(z,q),q.subscribers.forEach(function(J){return C.add(J)}));else if(0<R.length){k.optimisticOps=k.optimisticOps.filter(function(J){return J.trans!==b});for(var N=0,F=Object.values(k.queries.query);N<F.length;N++)for(var z,q,K,W=0,U=(z=F[N]).slice();W<U.length;W++)(q=U[W]).res!=null&&b.mutatedParts&&(x&&!q.dirty?(K=Object.isFrozen(q.res),K=mu(q.res,q.req,R,D,q,K),q.dirty?(Ne(z,q),q.subscribers.forEach(function(J){return C.add(J)})):K!==q.res&&(q.res=K,q.promise=G.resolve({result:K}))):(q.dirty&&Ne(z,q),q.subscribers.forEach(function(J){return C.add(J)})))}}}C.forEach(function(J){return J()})}}},b.addEventListener("abort",h(!1),{signal:y}),b.addEventListener("error",h(!1),{signal:y}),b.addEventListener("complete",h(!0),{signal:y})),b},table:function(u){var f=a.table(u),h=f.schema.primaryKey;return n(n({},f),{mutate:function(p){var y=re.trans;if(h.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return f.mutate(p);var b=Xr["idb://".concat(s,"/").concat(u)];return b?(y=f.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||as(h,p).some(function(x){return x==null}))?(b.optimisticOps.push(p),p.mutatedParts&&Oa(p.mutatedParts),y.then(function(x){0<x.numFailures&&(Ne(b.optimisticOps,p),(x=pu(0,p,x))&&b.optimisticOps.push(x),p.mutatedParts&&Oa(p.mutatedParts))}),y.catch(function(){Ne(b.optimisticOps,p),p.mutatedParts&&Oa(p.mutatedParts)})):y.then(function(x){var C=pu(0,n(n({},p),{values:p.values.map(function(O,w){var M;return x.failures[w]?O:(O=(M=h.keyPath)!==null&&M!==void 0&&M.includes(".")?De(O):n({},O),ie(O,h.keyPath,x.results[w]),O)})}),x);b.optimisticOps.push(C),queueMicrotask(function(){return p.mutatedParts&&Oa(p.mutatedParts)})}),y):f.mutate(p)},query:function(p){if(!du(re,f)||!hu("query",p))return f.query(p);var y=((C=re.trans)===null||C===void 0?void 0:C.db._options.cache)==="immutable",w=re,b=w.requery,x=w.signal,C=function(D,R,I,$){var T=Xr["idb://".concat(D,"/").concat(R)];if(!T)return[];if(!(R=T.queries[I]))return[null,!1,T,null];var A=R[($.query?$.query.index.name:null)||""];if(!A)return[null,!1,T,null];switch(I){case"query":var N=A.find(function(F){return F.req.limit===$.limit&&F.req.values===$.values&&vu(F.req.query.range,$.query.range)});return N?[N,!0,T,A]:[A.find(function(F){return("limit"in F.req?F.req.limit:1/0)>=$.limit&&(!$.values||F.req.values)&&Bh(F.req.query.range,$.query.range)}),!1,T,A];case"count":return N=A.find(function(F){return vu(F.req.query.range,$.query.range)}),[N,!!N,T,A]}}(s,u,"query",p),O=C[0],w=C[1],M=C[2],k=C[3];return O&&w?O.obsSet=p.obsSet:(w=f.query(p).then(function(D){var R=D.result;if(O&&(O.res=R),y){for(var I=0,$=R.length;I<$;++I)Object.freeze(R[I]);Object.freeze(R)}else D.result=De(R);return D}).catch(function(D){return k&&O&&Ne(k,O),Promise.reject(D)}),O={obsSet:p.obsSet,promise:w,subscribers:new Set,type:"query",req:p,dirty:!1},k?k.push(O):(k=[O],(M=M||(Xr["idb://".concat(s,"/").concat(u)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=k)),Nh(O,k,b,x),O.promise.then(function(D){return{result:mu(D.result,p,M==null?void 0:M.optimisticOps,f,O,y)}})}})}})}};function Ra(a,s){return new Proxy(a,{get:function(u,f,h){return f==="db"?s:Reflect.get(u,f,h)}})}var ur=(Ke.prototype.version=function(a){if(isNaN(a)||a<.1)throw new ne.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new ne.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var s=this._versions,u=s.filter(function(f){return f._cfg.version===a})[0];return u||(u=new this.Version(a),s.push(u),s.sort(Dh),u.stores({}),this._state.autoSchema=!1,u)},Ke.prototype._whenReady=function(a){var s=this;return this.idbdb&&(this._state.openComplete||re.letThrough||this._vip)?a():new G(function(u,f){if(s._state.openComplete)return f(new ne.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void f(new ne.DatabaseClosed);s.open().catch(L)}s._state.dbReadyPromise.then(u,f)}).then(a)},Ke.prototype.use=function(a){var s=a.stack,u=a.create,f=a.level,h=a.name;return h&&this.unuse({stack:s,name:h}),a=this._middlewares[s]||(this._middlewares[s]=[]),a.push({stack:s,create:u,level:f??10,name:h}),a.sort(function(p,y){return p.level-y.level}),this},Ke.prototype.unuse=function(a){var s=a.stack,u=a.name,f=a.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return f?h.create!==f:!!u&&h.name!==u})),this},Ke.prototype.open=function(){var a=this;return Gr(Cr,function(){return Mh(a)})},Ke.prototype._close=function(){var a=this._state,s=xn.indexOf(this);if(0<=s&&xn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new G(function(u){a.dbReadyResolve=u}),a.openCanceller=new G(function(u,f){a.cancelOpen=f}))},Ke.prototype.close=function(u){var s=(u===void 0?{disableAutoOpen:!0}:u).disableAutoOpen,u=this._state;s?(u.isBeingOpened&&u.cancelOpen(new ne.DatabaseClosed),this._close(),u.autoOpen=!1,u.dbOpenError=new ne.DatabaseClosed):(this._close(),u.autoOpen=this._options.autoOpen||u.isBeingOpened,u.openComplete=!1,u.dbOpenError=null)},Ke.prototype.delete=function(a){var s=this;a===void 0&&(a={disableAutoOpen:!0});var u=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new G(function(h,p){function y(){s.close(a);var b=s._deps.indexedDB.deleteDatabase(s.name);b.onsuccess=Ae(function(){var x,C,O;x=s._deps,C=s.name,O=x.indexedDB,x=x.IDBKeyRange,Yo(O)||C===va||Go(O,x).delete(C).catch(L),h()}),b.onerror=Jt(p),b.onblocked=s._fireOnBlocked}if(u)throw new ne.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(y):y()})},Ke.prototype.backendDB=function(){return this.idbdb},Ke.prototype.isOpen=function(){return this.idbdb!==null},Ke.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},Ke.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Ke.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Ke.prototype,"tables",{get:function(){var a=this;return c(this._allTables).map(function(s){return a._allTables[s]})},enumerable:!1,configurable:!0}),Ke.prototype.transaction=function(){var a=(function(s,u,f){var h=arguments.length;if(h<2)throw new ne.InvalidArgument("Too few arguments");for(var p=new Array(h-1);--h;)p[h-1]=arguments[h];return f=p.pop(),[s,Fe(p),f]}).apply(this,arguments);return this._transaction.apply(this,a)},Ke.prototype._transaction=function(a,s,u){var f=this,h=re.trans;h&&h.db===this&&a.indexOf("!")===-1||(h=null);var p,y,b=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(y=s.map(function(C){if(C=C instanceof f.Table?C.name:C,typeof C!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return C}),a=="r"||a===Bo)p=Bo;else{if(a!="rw"&&a!=No)throw new ne.InvalidArgument("Invalid transaction mode: "+a);p=No}if(h){if(h.mode===Bo&&p===No){if(!b)throw new ne.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&y.forEach(function(C){if(h&&h.storeNames.indexOf(C)===-1){if(!b)throw new ne.SubTransaction("Table "+C+" not included in parent transaction.");h=null}}),b&&h&&!h.active&&(h=null)}}catch(C){return h?h._promise(null,function(O,w){w(C)}):He(C)}var x=(function C(O,w,M,k,D){return G.resolve().then(function(){var R=re.transless||re,I=O._createTransaction(w,M,O._dbSchema,k);if(I.explicit=!0,R={trans:I,transless:R},k)I.idbtrans=k.idbtrans;else try{I.create(),I.idbtrans._explicit=!0,O._state.PR1398_maxLoop=3}catch(A){return A.name===ar.InvalidState&&O.isOpen()&&0<--O._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),O.close({disableAutoOpen:!1}),O.open().then(function(){return C(O,w,M,null,D)})):He(A)}var $,T=_e(D);return T&&Sn(),R=G.follow(function(){var A;($=D.call(I,I))&&(T?(A=Dr.bind(null,null),$.then(A,A)):typeof $.next=="function"&&typeof $.throw=="function"&&($=ns($)))},R),($&&typeof $.then=="function"?G.resolve($).then(function(A){return I.active?A:He(new ne.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):R.then(function(){return $})).then(function(A){return k&&I._resolve(),I._completion.then(function(){return A})}).catch(function(A){return I._reject(A),He(A)})})}).bind(null,this,p,y,h,u);return h?h._promise(p,x,"lock"):re.trans?Gr(re.transless,function(){return f._whenReady(x)}):this._whenReady(x)},Ke.prototype.table=function(a){if(!g(this._allTables,a))throw new ne.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},Ke);function Ke(a,s){var u=this;this._middlewares={},this.verno=0;var f=Ke.dependencies;this._options=s=n({addons:Ke.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},f=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,p,y,b,x,C={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:L,dbReadyPromise:null,cancelOpen:L,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};C.dbReadyPromise=new G(function(w){C.dbReadyResolve=w}),C.openCanceller=new G(function(w,M){C.cancelOpen=M}),this._state=C,this.name=a,this.on=ai(this,"populate","blocked","versionchange","close",{ready:[wn,L]}),this.on.ready.subscribe=Y(this.on.ready.subscribe,function(w){return function(M,k){Ke.vip(function(){var D,R=u._state;R.openComplete?(R.dbOpenError||G.resolve().then(M),k&&w(M)):R.onReadyBeingFired?(R.onReadyBeingFired.push(M),k&&w(M)):(w(M),D=u,k||w(function I(){D.on.ready.unsubscribe(M),D.on.ready.unsubscribe(I)}))})}}),this.Collection=(h=this,oi(_h.prototype,function($,I){this.db=h;var k=Vc,D=null;if(I)try{k=I()}catch(T){D=T}var R=$._ctx,I=R.table,$=I.hook.reading.fire;this._ctx={table:I,index:R.index,isPrimKey:!R.index||I.schema.primKey.keyPath&&R.index===I.schema.primKey.name,range:k,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:D,or:R.or,valueMapper:$!==Q?$:null}})),this.Table=(p=this,oi(Jc.prototype,function(w,M,k){this.db=p,this._tx=k,this.name=w,this.schema=M,this.hook=p._allTables[w]?p._allTables[w].hook:ai(null,{creating:[de,L],reading:[te,Q],updating:[ke,L],deleting:[xe,L]})})),this.Transaction=(y=this,oi(xh.prototype,function(w,M,k,D,R){var I=this;this.db=y,this.mode=w,this.storeNames=M,this.schema=k,this.chromeTransactionDurability=D,this.idbtrans=null,this.on=ai(this,"complete","error","abort"),this.parent=R||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new G(function($,T){I._resolve=$,I._reject=T}),this._completion.then(function(){I.active=!1,I.on.complete.fire()},function($){var T=I.active;return I.active=!1,I.on.error.fire($),I.parent?I.parent._reject($):T&&I.idbtrans&&I.idbtrans.abort(),He($)})})),this.Version=(b=this,oi(Rh.prototype,function(w){this.db=b,this._cfg={version:w,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(x=this,oi(ru.prototype,function(w,M,k){if(this.db=x,this._ctx={table:w,index:M===":id"?null:M,or:k},this._cmp=this._ascending=be,this._descending=function(D,R){return be(R,D)},this._max=function(D,R){return 0<be(D,R)?D:R},this._min=function(D,R){return be(D,R)<0?D:R},this._IDBKeyRange=x._deps.IDBKeyRange,!this._IDBKeyRange)throw new ne.MissingAPI})),this.on("versionchange",function(w){0<w.newVersion?console.warn("Another connection wants to upgrade database '".concat(u.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(u.name,"'. Closing db now to resume the delete request.")),u.close({disableAutoOpen:!1})}),this.on("blocked",function(w){!w.newVersion||w.newVersion<w.oldVersion?console.warn("Dexie.delete('".concat(u.name,"') was blocked")):console.warn("Upgrade '".concat(u.name,"' blocked by other connection holding version ").concat(w.oldVersion/10))}),this._maxKey=li(s.IDBKeyRange),this._createTransaction=function(w,M,k,D){return new u.Transaction(w,M,k,u._options.chromeTransactionDurability,D)},this._fireOnBlocked=function(w){u.on("blocked").fire(w),xn.filter(function(M){return M.name===u.name&&M!==u&&!M._state.vcFired}).map(function(M){return M.on("versionchange").fire(w)})},this.use(Th),this.use(jh),this.use(Ah),this.use($h),this.use(Lh);var O=new Proxy(this,{get:function(w,M,k){if(M==="_vip")return!0;if(M==="table")return function(R){return Ra(u.table(R),O)};var D=Reflect.get(w,M,k);return D instanceof Jc?Ra(D,O):M==="tables"?D.map(function(R){return Ra(R,O)}):M==="_createTransaction"?function(){return Ra(D.apply(this,arguments),O)}:D}});this.vip=O,f.forEach(function(w){return w(u)})}var Ma,Rt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Fh=(ss.prototype.subscribe=function(a,s,u){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:s,complete:u})},ss.prototype[Rt]=function(){return this},ss);function ss(a){this._subscribe=a}try{Ma={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{Ma={indexedDB:null,IDBKeyRange:null}}function gu(a){var s,u=!1,f=new Fh(function(h){var p=_e(a),y,b=!1,x={},C={},O={get closed(){return b},unsubscribe:function(){b||(b=!0,y&&y.abort(),w&&Rr.storagemutated.unsubscribe(k))}};h.start&&h.start(O);var w=!1,M=function(){return Ao(D)},k=function(R){Da(x,R),Zo(C,x)&&M()},D=function(){var R,I,$;!b&&Ma.indexedDB&&(x={},R={},y&&y.abort(),y=new AbortController,$=function(T){var A=_n();try{p&&Sn();var N=Ir(a,T);return N=p?N.finally(Dr):N}finally{A&&En()}}(I={subscr:R,signal:y.signal,requery:M,querier:a,trans:null}),Promise.resolve($).then(function(T){u=!0,s=T,b||I.signal.aborted||(x={},function(A){for(var N in A)if(g(A,N))return;return 1}(C=R)||w||(Rr(ui,k),w=!0),Ao(function(){return!b&&h.next&&h.next(T)}))},function(T){u=!1,["DatabaseClosedError","AbortError"].includes(T==null?void 0:T.name)||b||Ao(function(){b||h.error&&h.error(T)})}))};return setTimeout(M,0),O});return f.hasValue=function(){return u},f.getValue=function(){return s},f}var Zr=ur;function cs(a){var s=Mr;try{Mr=!0,Rr.storagemutated.fire(a),rs(a,!0)}finally{Mr=s}}E(Zr,n(n({},kr),{delete:function(a){return new Zr(a,{addons:[]}).delete()},exists:function(a){return new Zr(a,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return s=Zr.dependencies,u=s.indexedDB,s=s.IDBKeyRange,(Yo(u)?Promise.resolve(u.databases()).then(function(f){return f.map(function(h){return h.name}).filter(function(h){return h!==va})}):Go(u,s).toCollection().primaryKeys()).then(a)}catch{return He(new ne.MissingAPI)}var s,u},defineClass:function(){return function(a){d(this,a)}},ignoreTransaction:function(a){return re.trans?Gr(re.transless,a):a()},vip:Jo,async:function(a){return function(){try{var s=ns(a.apply(this,arguments));return s&&typeof s.then=="function"?s:G.resolve(s)}catch(u){return He(u)}}},spawn:function(a,s,u){try{var f=ns(a.apply(u,s||[]));return f&&typeof f.then=="function"?f:G.resolve(f)}catch(h){return He(h)}},currentTransaction:{get:function(){return re.trans||null}},waitFor:function(a,s){return s=G.resolve(typeof a=="function"?Zr.ignoreTransaction(a):a).timeout(s||6e4),re.trans?re.trans.waitFor(s):s},Promise:G,debug:{get:function(){return ae},set:function(a){Qe(a)}},derive:P,extend:d,props:E,override:Y,Events:ai,on:Rr,liveQuery:gu,extendObservabilitySet:Da,getByKeyPath:ee,setByKeyPath:ie,delByKeyPath:function(a,s){typeof s=="string"?ie(a,s,void 0):"length"in s&&[].map.call(s,function(u){ie(a,u,void 0)})},shallowClone:me,deepClone:De,getObjectDiff:is,cmp:be,asap:oe,minKey:-1/0,addons:[],connections:xn,errnames:ar,dependencies:Ma,cache:Xr,semVer:"4.0.10",version:"4.0.10".split(".").map(function(a){return parseInt(a)}).reduce(function(a,s,u){return a+s/Math.pow(10,2*u)})})),Zr.maxKey=li(Zr.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Rr(ui,function(a){Mr||(a=new CustomEvent(Ho,{detail:a}),Mr=!0,dispatchEvent(a),Mr=!1)}),addEventListener(Ho,function(a){a=a.detail,Mr||cs(a)}));var In,Mr=!1,yu=function(){};return typeof BroadcastChannel<"u"&&((yu=function(){(In=new BroadcastChannel(Ho)).onmessage=function(a){return a.data&&cs(a.data)}})(),typeof In.unref=="function"&&In.unref(),Rr(ui,function(a){Mr||In.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!ur.disableBfCache&&a.persisted){ae&&console.debug("Dexie: handling persisted pagehide"),In!=null&&In.close();for(var s=0,u=xn;s<u.length;s++)u[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!ur.disableBfCache&&a.persisted&&(ae&&console.debug("Dexie: handling persisted pageshow"),yu(),cs({all:new at(-1/0,[[]])}))})),G.rejectionMapper=function(a,s){return!a||a instanceof fe||a instanceof TypeError||a instanceof SyntaxError||!a.name||!ri[a.name]?a:(s=new ri[a.name](s||a.message,a),"stack"in a&&S(s,"stack",{get:function(){return this.inner.stack}}),s)},Qe(ae),n(ur,Object.freeze({__proto__:null,Dexie:ur,liveQuery:gu,Entity:Qc,cmp:be,PropModSymbol:cr,PropModification:si,replacePrefix:function(a,s){return new si({replacePrefix:[a,s]})},add:function(a){return new si({add:a})},remove:function(a){return new si({remove:a})},default:ur,RangeSet:at,mergeRanges:hi,rangesOverlap:su}),{default:ur}),ur})}(za)),za.exports}var zb=Ub();const Js=Hb(zb),al=Symbol.for("Dexie"),co=globalThis[al]||(globalThis[al]=Js);if(Js.semVer!==co.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Js.semVer} and ${co.semVer}`);const{liveQuery:O0,mergeRanges:P0,rangesOverlap:R0,RangeSet:M0,cmp:$0,Entity:L0,PropModSymbol:T0,PropModification:A0,replacePrefix:B0,add:N0,remove:j0}=co;var uo="docs",Wb="changes",ol="attachments",Ad="dexie",sl=new Map,Wa=new Map;function Vb(e,t,r,n){var i="rxdb-dexie-"+e+"--"+n.version+"--"+t,o=Wt(sl,i,()=>{var c=(async()=>{var l=je(r);l.autoOpen=!1;var d=new co(i,l);r.onCreate&&await r.onCreate(d,i);var v={[uo]:Yb(n),[Wb]:"++sequence, id",[ol]:"id"};return d.version(1).stores(v),await d.open(),{dexieDb:d,dexieTable:d[uo],dexieAttachmentsTable:d[ol],booleanIndexes:Jb(n)}})();return sl.set(i,o),Wa.set(o,0),c});return o}async function Qb(e){var t=await e,r=Wa.get(e),n=r-1;n===0?(t.dexieDb.close(),Wa.delete(e)):Wa.set(e,n)}var Xs="__";function ei(e){var t=e.split(".");if(t.length>1)return t.map(n=>ei(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return Xs+r}else return e}function Bd(e){var t=e.split(".");if(t.length>1)return t.map(n=>Bd(n)).join(".");if(e.startsWith(Xs)){var r=e.substring(Xs.length);return"|"+r}else return e}function Gb(e,t){if(!t)return t;var r=je(t);return r=Zs(r),e.forEach(n=>{var i=Kr(t,n),o=i?"1":"0",c=ei(n);Al(r,c,o)}),r}function Nd(e,t){return t&&(t=je(t),t=ec(t),e.forEach(r=>{var n=Kr(t,r),i=n==="1";Al(t,r,i)}),t)}function Zs(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>Zs(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=Zs(n)),t[ei(r)]=n}),t}}function ec(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>ec(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=ec(n)),t[Bd(r)]=n}),t}}function Yb(e){var t=[],r=It(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(o=>{var c=uc(o);t.push(c)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(o=>o.map(c=>ei(c)));var n=t.map(o=>o.length===1?o[0]:"["+o.join("+")+"]");n=n.filter((o,c,l)=>l.indexOf(o)===c);var i=n.join(", ");return i}async function cl(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(i=>Nd(r.booleanIndexes,i))}function Ba(e,t){return e+"||"+t}function Jb(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var i=uc(n);i.forEach(o=>{if(!t.has(o)){t.add(o);var c=Kn(e,o);c.type==="boolean"&&r.push(o)}})}),r.push("_deleted"),Qh(r)):r}function ul(e){return e===$n?-1/0:e}function ll(e,t,r){if(e.includes(t)){var n=r===Mn||r===!0?"1":"0";return n}else return r}function jd(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((c,l)=>{var d=t.index[l];return ll(e,d,c)}).map(ul),i=t.endKeys.map((c,l)=>{var d=t.index[l];return ll(e,d,c)}).map(ul),o=r.bound(n,i,!t.inclusiveStart,!t.inclusiveEnd);return o}async function fl(e,t){var r=await e.internals,n=t.query,i=n.skip?n.skip:0,o=n.limit?n.limit:1/0,c=i+o,l=t.queryPlan,d=!1;l.selectorSatisfiedByIndex||(d=Sc(e.schema,t.query));var v=jd(r.booleanIndexes,l,r.dexieDb._options.IDBKeyRange),m=l.index,g=[];if(await r.dexieDb.transaction("r",r.dexieTable,async _=>{var S=_.idbtrans,P=S.objectStore(uo),B,j;j="["+m.map(Y=>ei(Y)).join("+")+"]",B=P.index(j);var H=B.openCursor(v);await new Promise(Y=>{H.onsuccess=function(ce){var oe=ce.target.result;if(oe){var ee=Nd(r.booleanIndexes,oe.value);(!d||d(ee))&&g.push(ee),l.sortSatisfiedByIndex&&g.length===c?Y():oe.continue()}else Y()}})}),!l.sortSatisfiedByIndex){var E=Jf(e.schema,t.query);g=g.sort(E)}return g=g.slice(i,c),{documents:g}}async function Xb(e,t){var r=await e.internals,n=t.queryPlan,i=n.index,o=jd(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),c=-1;return await r.dexieDb.transaction("r",r.dexieTable,async l=>{var d=l.idbtrans,v=d.objectStore(uo),m,g;g="["+i.map(_=>ei(_)).join("+")+"]",m=v.index(g);var E=m.count(o);c=await new Promise((_,S)=>{E.onsuccess=function(){_(E.result)},E.onerror=P=>S(P)})}),c}var Zb=Ct(),ks=!1,ew=function(){function e(r,n,i,o,c,l,d,v){this.changes$=new Bt,this.instanceId=Zb++,this.storage=r,this.databaseName=n,this.collectionName=i,this.schema=o,this.internals=c,this.options=l,this.settings=d,this.devMode=v,this.primaryPath=It(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,i){tn(this),!ks&&!await Nl()&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium/?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),ks=!0,n.forEach(m=>{if(!m.document._rev||m.previous&&!m.previous._rev)throw Z("SNH",{args:{row:m}})});var o=await this.internals,c={error:[]};this.devMode&&(n=n.map(m=>{var g=aa(m.document);return{previous:m.previous,document:g}}));var l=n.map(m=>m.document[this.primaryPath]),d;if(await o.dexieDb.transaction("rw",o.dexieTable,o.dexieAttachmentsTable,async()=>{var m=new Map,g=await cl(this.internals,l);g.forEach(S=>{var P=S;return P&&m.set(P[this.primaryPath],P),P}),d=Rv(this,this.primaryPath,m,n,i),c.error=d.errors;var E=[];d.bulkInsertDocs.forEach(S=>{E.push(S.document)}),d.bulkUpdateDocs.forEach(S=>{E.push(S.document)}),E=E.map(S=>Gb(o.booleanIndexes,S)),E.length>0&&await o.dexieTable.bulkPut(E);var _=[];d.attachmentsAdd.forEach(S=>{_.push({id:Ba(S.documentId,S.attachmentId),data:S.attachmentData.data})}),d.attachmentsUpdate.forEach(S=>{_.push({id:Ba(S.documentId,S.attachmentId),data:S.attachmentData.data})}),await o.dexieAttachmentsTable.bulkPut(_),await o.dexieAttachmentsTable.bulkDelete(d.attachmentsRemove.map(S=>Ba(S.documentId,S.attachmentId)))}),d=he(d),d.eventBulk.events.length>0){var v=he(d.newestRow).document;d.eventBulk.checkpoint={id:v[this.primaryPath],lwt:v._meta.lwt},this.changes$.next(d.eventBulk)}return c},t.findDocumentsById=async function(n,i){tn(this);var o=await this.internals,c=[];return await o.dexieDb.transaction("r",o.dexieTable,async()=>{var l=await cl(this.internals,n);l.forEach(d=>{d&&(!d._deleted||i)&&c.push(d)})}),c},t.query=function(n){return tn(this),fl(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var i=await Xb(this,n);return{count:i,mode:"fast"}}else{var o=await fl(this,n);return{count:o.documents.length,mode:"slow"}}},t.changeStream=function(){return tn(this),this.changes$.asObservable()},t.cleanup=async function(n){tn(this);var i=await this.internals;return await i.dexieDb.transaction("rw",i.dexieTable,async()=>{var o=Ct()-n,c=await i.dexieTable.where("_meta.lwt").below(o).toArray(),l=[];c.forEach(d=>{d._deleted==="1"&&l.push(d[this.primaryPath])}),await i.dexieTable.bulkDelete(l)}),!0},t.getAttachmentData=async function(n,i,o){tn(this);var c=await this.internals,l=Ba(n,i);return await c.dexieDb.transaction("r",c.dexieAttachmentsTable,async()=>{var d=await c.dexieAttachmentsTable.get(l);if(d)return d.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+i)})},t.remove=async function(){tn(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await Qb(this.internals)})(),this.closed)},e}();async function tw(e,t,r){var n=Vb(t.databaseName,t.collectionName,r,t.schema),i=new ew(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await Fb(Ad,t,i),Promise.resolve(i)}function tn(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var rw=function(){function e(r){this.name=Ad,this.rxdbVersion=Bl,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){if(Lv(n),n.schema.indexes){var i=n.schema.indexes.flat();i.filter(o=>!o.includes(".")).forEach(o=>{if(!n.schema.required||!n.schema.required.includes(o))throw Z("DXE1",{field:o,schema:n.schema})})}return tw(this,n,this.settings)},e}();function nw(e={}){var t=new rw(e);return t}var iw=["__proto__","constructor","prototype"];function vi(e,t){Object.keys(t).forEach(r=>{iw.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:_i(t[r])?vi(e[r],t[r]):e[r]=t[r])})}function _i(e){return e.toString()==="[object Object]"}var Oo=function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var i=this;r.selector&&i.find(r.selector),r.limit&&i.limit(r.limit),r.skip&&i.skip(r.skip),r.sort&&r.sort.forEach(o=>i.sort(o))}}var t=e.prototype;return t.where=function(n,i){if(!arguments.length)return this;var o=typeof arguments[0];if(o==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(o==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw Lt("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var i=this._path;return this._conditions[i]=n,this},t.eq=function(n){this._ensurePath("eq");var i=this._path;return this._conditions[i]=n,this},t.or=function(n){var i=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.nor=function(n){var i=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.and=function(n){var i=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),i.push.apply(i,n),this},t.mod=function(n,i){var o,c;arguments.length===1?(this._ensurePath("mod"),o=arguments[0],c=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),o=arguments.slice(),c=this._path):arguments.length===3?(o=arguments.slice(1),c=arguments[0]):(o=arguments[1],c=arguments[0]);var l=this._conditions[c]||(this._conditions[c]={});return l.$mod=o,this},t.exists=function(n,i){var o,c;arguments.length===0?(this._ensurePath("exists"),o=this._path,c=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),o=this._path,c=arguments[0]):(o=arguments[0],c=!0):arguments.length===2&&(o=arguments[0],c=arguments[1]);var l=this._conditions[o]||(this._conditions[o]={});return l.$exists=c,this},t.elemMatch=function(n,i){if(arguments[0]===null)throw Lt("MQ2");var o,c,l;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),c=this._path,o=arguments[0];else if(_i(arguments[0]))this._ensurePath("elemMatch"),c=this._path,l=arguments[0];else if(typeof arguments[1]=="function")c=arguments[0],o=arguments[1];else if(arguments[1]&&_i(arguments[1]))c=arguments[0],l=arguments[1];else throw Lt("MQ2");o&&(l=new e,o(l),l=l._conditions);var d=this._conditions[c]||(this._conditions[c]={});return d.$elemMatch=l,this},t.sort=function(n){if(!n)return this;var i,o=typeof n;if(Array.isArray(n)){i=n.length;for(var c=0;c<n.length;++c)ow(this.options,n[c][0],n[c][1]);return this}if(arguments.length===1&&o==="string"){n=n.split(/\s+/),i=n.length;for(var l=0;l<i;++l){var d=n[l];if(d){var v=d[0]==="-"?-1:1;v===-1&&(d=d.substring(1)),dl(this.options,d,v)}}return this}if(_i(n)){var m=Object.keys(n);return m.forEach(g=>dl(this.options,g,n[g])),this}throw Lt("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!hl(n))throw Lt("MQ4",{source:n});return n instanceof e?(n._conditions&&vi(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),vi(this._fields,n._fields)),n.options&&(this.options||(this.options={}),vi(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(vi(this._conditions,n),this)},t.find=function(n){return hl(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw Z("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=aw(this.options.sort)),{query:n,path:this._path}},e}();function aw(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",i={[t]:n};return i})}var Fd=["limit","skip","maxScan","batchSize","comment"];Fd.forEach(function(e){Oo.prototype[e]=function(t){return this.options[e]=t,this}});var qd=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];qd.forEach(function(e){Oo.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw Z("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function dl(e,t,r){if(Array.isArray(e.sort))throw Lt("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var i=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(i))throw Array.isArray(r)&&(r="["+r+"]"),Lt("MQ7",{field:t,value:r});var o=e.sort||(e.sort={}),c=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");o[t]=parseInt(c,10)}function ow(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw Lt("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function hl(e){return e instanceof Oo||_i(e)}function sw(e,t){return new Oo(e,t)}var pl="queryBuilderPath";function cw(e,t,r){var n=sw(dt(e.mangoQuery),e.other[pl]);n[t](r);var i=n.toJSON();return On(e.op,i.query,e.collection,{...e.other,[pl]:i.path})}function Cs(e,t){e[t]=function(r){if(Ce.isDevMode()&&this.op==="findByIds")throw Z("QU17",{collection:this.collection.name,query:this.mangoQuery});return cw(this,t,r)}}var uw={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{Cs(e,t)}),Fd.forEach(t=>{Cs(e,t)}),qd.forEach(t=>{Cs(e,t)})}}};async function Hd(e){var t=xp(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>Gn(n,ln)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function lw(e,t,r){var n=je(r._attachments),i=dt(r),o=i._meta;delete i._meta,i._attachments=n;for(var c=t+1,l=Promise.resolve(i),d=function(){var v=c;l=l.then(m=>fw(e,v,m)),c++};c<=e.schema.version;)d();return l.then(v=>v===null?fc:(v._meta=o,v))}function fw(e,t,r){if(r===null)return fc;var n=e.migrationStrategies[t](r,e),i=rp(n);return i}async function Kd(e){if(e.collection.schema.version===0)return wr;var t=await Hd(e);return!!t}var dw=200,Ud=new WeakMap;function hw(e){var t=zd(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function zd(e){return Wt(Ud,e,()=>new Lr([]))}function pw(e){var t=Ud.get(e);t&&t.complete()}var mw=function(){function e(r,n,i=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=np,this.collection=r,this.migrationStrategies=n,this.statusDocKey=i,this.database=r.database,this.oldCollectionMeta=Hd(this),this.mustMigrate=Kd(this),this.statusDocId=Gn(this.statusDocKey,Ha),hw(this),this.$=Pv(this.database.internalStore,this.statusDocId).pipe(Pe(o=>!!o),We(o=>he(o).data),ea(Gi))}var t=e.prototype;return t.getStatus=function(){return un(this.$)},t.startMigration=async function(n=dw){var i=await this.mustMigrate;if(i){if(this.started)throw Z("DM1");this.started=!0;var o=void 0;if(this.database.multiInstance){o=new Do(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var c=Nb(o);await c.awaitLeadership()}var l=await this.oldCollectionMeta,d=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:l.data.schema,password:this.database.password,devMode:Ce.isDevMode()}),v=await this.getConnectedStorageInstances(),m=await this.countAllDoucments([d].concat(v.map(g=>g.oldStorage)));await this.updateStatus(g=>(g.count.total=m,g));try{await Promise.all(v.map(async g=>{await Zg(this.collection,g.newStorage.collectionName,g.newStorage.schema),await this.migrateStorage(g.oldStorage,g.newStorage,n),await g.newStorage.close()})),await this.migrateStorage(d,this.collection.storageInstance.originalStorageInstance,n)}catch(g){await d.close(),await this.updateStatus(E=>(E.status="ERROR",E.error=up(g),E));return}await Fi(this.database.internalStore,{previous:l,document:Object.assign({},l,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(g=>(g.status="DONE",g)),o&&await o.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var i=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var o=await ia(this.database.internalStore,this.statusDocId),c=dt(o);o||(c={id:this.statusDocId,key:this.statusDocKey,context:Ha,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:Jn(),_rev:zt(),_attachments:{}});var l=he(c).data;for(var d of i)l=d(l);if(l.count.percent=Math.round(l.count.handled/l.count.total*100),c&&o&&Oi(c.data,o.data))break;try{await Fi(this.database.internalStore,{previous:o,document:he(c)},Ha);break}catch(v){if(!wo(v))throw v}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,i,o){var c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:Ju(n.schema,Ks(n.schema)),password:this.database.password,devMode:Ce.isDevMode()}),l=Iy(i,no,this.database.token,!0),d=xy({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async m=>{m=await Promise.all(m.map(async E=>{var _=E.newDocumentState;if(i.schema.title===Ua&&(_=E.newDocumentState.docData,E.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:E.newDocumentState};var S=await lw(this.collection,n.schema.version,_),P={assumedMasterState:void 0,newDocumentState:i.schema.title===Ua?Object.assign({},E.newDocumentState,{docData:S}):S};return P})),m=m.filter(E=>!!E.newDocumentState);var g=await l.masterWrite(m);return g},masterChangeStream$:new Bt().asObservable()},forkInstance:n,metaInstance:c,pushBatchSize:o,pullBatchSize:0,conflictHandler:no,hashFunction:this.database.hashFunction}),v=!1;if(d.events.error.subscribe(m=>v=m),d.events.processed.up.subscribe(()=>{this.updateStatus(m=>(m.count.handled=m.count.handled+1,m))}),await ky(d),await Cy(d),await Dy(d),await this.updateStatusQueue,v)throw await c.close(),v;await Promise.all([n.remove(),c.remove()])},t.countAllDoucments=async function(n){var i=0;return await Promise.all(n.map(async o=>{var c=ko(o.schema,Tn(o.schema,{selector:{}})),l=await o.count(c);i+=l.count})),i},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,i=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async o=>{if(o.schema.title!==Ua)throw new Error("unknown migration handling for schema");var c=Ju(dt(this.collection.schema.jsonSchema),Ks(o.schema));c.version=this.collection.schema.version;var[l,d]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Ce.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:o.schema,password:this.database.password,collectionName:o.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Ce.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:c,password:this.database.password,collectionName:o.collectionName})]);i.push({oldStorage:l,newStorage:d})}))),i},t.migratePromise=async function(n){this.startMigration(n);var i=await this.mustMigrate;if(!i)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var o=await Promise.race([un(this.$.pipe(Pe(c=>c.status==="DONE"))),un(this.$.pipe(Pe(c=>c.status==="ERROR")))]);if(o.status==="ERROR")throw Z("DM4",{collection:this.collection.name,error:o.error});return o},e}(),vw=td(),gw=function(e){function t(r,n,i){var o;return o=e.call(this,null,n)||this,o.id=r,o.parent=i,o}return dc(t,e),t}(vw),Ei={get isLocal(){return!0},get allAttachments$(){throw Z("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=Hn(tc,this.parent),r=this.primary;return e.parent.eventBulks$.pipe(Pe(n=>!!n.isLocal),We(n=>n.events.find(i=>i.documentId===r)),Pe(n=>!!n),We(n=>ff(he(n))),ta(t.docCache.getLatestDocumentData(this.primary)),Mi((n,i)=>n._rev===i._rev),We(n=>t.docCache.getCachedRxDocument(n)),ea(Gi))},get $$(){var e=this,t=Is(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=Is(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=Hn(tc,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw Lt("LD2",{objPath:e});var t=Kr(this._data,e);return t=Ce.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,Ce.isDevMode()){if(e.includes(".item."))throw Z("LD3",{objPath:e});if(e===this.primaryPath)throw Z("LD4")}return this.$.pipe(We(t=>t._data),We(t=>Kr(t,e)),Mi())},get$$(e){var t=Is(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await Si(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await Si(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(i=>{if(i.error[0])throw i.error[0];var o=Ft(this.collection.schema.primaryPath,n,i)[0];e=je(e),e._rev=o._rev})},async remove(){var e=await Si(this.parent),t=je(this._data);return t._deleted=!0,Fi(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},ml=!1,yw=()=>{if(!ml){ml=!0;var e=Co,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var i=Object.getOwnPropertyDescriptor(Ei,n);if(!i){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(Ei,n,o)}});var r=n=>()=>{throw Z("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>Ei[n]=r(n))}};function bw(e,t){yw();var r=new gw(e.id,e,t);return Object.setPrototypeOf(r,Ei),r.prototype=Ei,r}function Is(e){var t=e.parent;return gy(t)?t:t.database}var lo=new WeakMap,tc=new WeakMap;function vl(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var i=await Wd(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);i=xc(t,i,Vd);var o=new cd("id",t.eventBulks$.pipe(Pe(m=>{var g=!1;return(r===""&&!m.collectionName||r!==""&&m.collectionName===r)&&(g=!0),g&&m.isLocal}),We(m=>m.events)),m=>bw(m,e)),c=new ed(i,"id",()=>{},()=>{}),l=await t.storageToken,d=i.changeStream().subscribe(m=>{for(var g=new Array(m.events.length),E=m.events,_=e.database?e.name:void 0,S=0;S<E.length;S++){var P=E[S];g[S]={documentId:P.documentId,collectionName:_,isLocal:!0,operation:P.operation,documentData:Ce.deepFreezeWhenDevMode(P.documentData),previousDocumentData:Ce.deepFreezeWhenDevMode(P.previousDocumentData)}}var B={id:m.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:l,events:g,databaseToken:t.token,checkpoint:m.checkpoint,context:m.context};t.$emit(B)});e._subs.push(d);var v={database:t,parent:e,storageInstance:i,docCache:o,incrementalWriteQueue:c};return tc.set(e,v),v})();lo.set(e,n)}function Si(e){var t=lo.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw Z("LD8",{database:r.name,collection:n})}return t}function Wd(e,t,r,n,i,o){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:ww(n),schema:Vd,options:i,multiInstance:o,devMode:Ce.isDevMode()})}function gl(e){var t=lo.get(e);if(t)return lo.delete(e),t.then(r=>r.storageInstance.close())}async function yl(e,t,r){var n=Qi(10),i=await Wd(n,e,t,r,{},!1);await i.remove()}function ww(e){return"plugin-local-documents-"+e}var Vd=_o({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function bl(e,t){var r=await Si(this),n={id:e,data:t,_deleted:!1,_meta:Jn(),_rev:zt(),_attachments:{}};return Fi(r.storageInstance,{document:n},"local-document-insert").then(i=>r.docCache.getCachedRxDocument(i))}function wl(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function _l(e){var t=await Si(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):ia(t.storageInstance,e).then(i=>i?t.docCache.getCachedRxDocument(i):null)}function El(e){return this.$.pipe(ta(null),Er(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),Er(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),Pe(t=>t.use),We(t=>t.doc))}var _w={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=bl,e.upsertLocal=wl,e.getLocal=_l,e.getLocal$=El},RxDatabase:e=>{e.insertLocal=bl,e.upsertLocal=wl,e.getLocal=_l,e.getLocal$=El}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&vl(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&vl(e.collection)}},preCloseRxDatabase:{after:e=>gl(e)},postCloseRxCollection:{after:e=>gl(e)},postRemoveRxDatabase:{after:e=>yl(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>yl(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},Ew=new WeakMap,Sw={name:"migration-schema",rxdb:!0,init(){Ka(_w)},hooks:{preCloseRxDatabase:{after:pw}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return zd(this).pipe(ea(Gi))}},RxCollection:e=>{e.getMigrationState=function(){return Wt(Ew,this,()=>new mw(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?wr:Kd(this.getMigrationState())}}}},xw=Sw;const Po=e=>ht((t,r,n)=>{let i=0;if(ye(r))for(const o of r)i=i|1<<o;else i=r;return e(t&i,i)}),kw=Po((e,t)=>e==0),Cw=Po((e,t)=>e==t),Iw=Po((e,t)=>e<t),Dw=Po((e,t)=>e>0),Ow=Object.freeze(Object.defineProperty({__proto__:null,$all:Iv,$and:Lf,$bitsAllClear:kw,$bitsAllSet:Cw,$bitsAnyClear:Iw,$bitsAnySet:Dw,$elemMatch:Vf,$eq:Bf,$exists:Gf,$expr:xv,$gt:Nf,$gte:jf,$in:Ff,$jsonSchema:kv,$lt:qf,$lte:Hf,$mod:zf,$ne:Kf,$nin:Uf,$nor:Tf,$not:Af,$or:Ec,$regex:Wf,$size:Qf,$type:Yf,$where:Cv},Symbol.toStringTag,{value:"Module"})),pt={cloneMode:"copy",queryOptions:_f({context:vn.init().addQueryOps(Ow).addExpressionOps(hv).addExpressionOps(_v)})},Bc=(e,t)=>{switch(e){case"deep":return Qn(t);case"copy":return Wn(t)?new Date(t):ye(t)?[...t]:Ve(t)?{...t}:mr(t)?new RegExp(t):t;default:return t}},Pw=/^[a-z]+[a-zA-Z0-9]*$/;function Qd(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),i=e.substring(t+3,r);Ie(i===""||Pw.test(i),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const o=e.substring(r+2),[c,l]=o?Qd(o):[];return[{selector:e,parent:n,child:i||"$",next:c},[i,...l||[]].filter(Boolean)]}const yt=(e,t,r,n,i)=>{const{parent:o,child:c,next:l}=t;if(!c){let v=!1;return Ai(e,o,(g,E)=>v=!!n(g,E)||v,i),v}const d=nr(e,o);return ye(d)?d.map((v,m)=>r[c]&&!r[c].test({[c]:v})?!1:l?yt(v,l,r,n,i):n(d,m)).some(Boolean):!1};function Ot(e,t,r,n){const i=[];for(const[o,c]of Object.entries(e)){const[l,d]=Qd(o);if(!d.length)n(c,l,{})&&i.push(l.parent);else{const v={};t.forEach(g=>{Object.keys(g).forEach(E=>{d.forEach(_=>{(E===_||E.startsWith(_+"."))&&(v[_]=v[_]||{},Object.assign(v[_],{[E]:g[E]}))})})});const m={};for(const[g,E]of Object.entries(v))m[g]=new Wr(E,r.queryOptions);n(c,l,m)&&i.push(l.parent)}}return i}const Rw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>{const l={$each:[i]};return Ve(i)&&Qt(i,"$each")&&Object.assign(l,i),yt(e,o,c,(d,v)=>{const m=d[v]||(d[v]=[]);return gf([m,l.$each]).length===l.$each.length?!1:(d[v]=Bc(n.cloneMode,Am(m.concat(l.$each))),!0)},{buildGraph:!0})}),Mw=new Set(["and","or","xor"]),$w=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>{const l=Object.keys(i);return Ie(l.length===1&&Mw.has(l[0]),`Invalid bit operator '${l[0]}'. Must be one of 'and', 'or', or 'xor'.`),yt(e,o,c,(d,v)=>{let m=d[v];const g=i[l[0]];if(m!==void 0&&!(nt(m)&&nt(g)))return!1;switch(m=m||0,l[0]){case"and":d[v]=m&g;break;case"or":d[v]=m|g;break;case"xor":d[v]=m^g;break}return d[v]!==m},{buildGraph:!0})}),Lw=(e,t,r=[],n=pt)=>{const i=Date.now();return Ot(t,r,n,(o,c,l)=>yt(e,c,l,(d,v)=>(d[v]=i,!0),{buildGraph:!0}))},Tw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>{if(!o.child){const l=nr(e,o.parent);Ie(l===void 0||nt(l),"cannot apply $inc to a value of non-numeric type")}return yt(e,o,c,(l,d)=>(l[d]=(l[d]||(l[d]=0))+i,!0),{buildGraph:!0})}),Aw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>yt(e,o,c,(l,d)=>l[d]!==void 0&&jt(l[d],i)>-1?!1:(l[d]=i,!0),{buildGraph:!0})),Bw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>yt(e,o,c,(l,d)=>l[d]!==void 0&&jt(l[d],i)<1?!1:(l[d]=i,!0),{buildGraph:!0})),Nw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>yt(e,o,c,(l,d)=>{const v=l[d];return l[d]=l[d]===void 0?0:l[d]*i,l[d]!==v},{buildGraph:!0})),jw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>yt(e,o,c,(l,d)=>{const v=l[d];return Ie(ye(v),`path '${o.selector}' contains an element of non-array type.`),v.length?(i===-1?v.splice(0,1):v.pop(),!0):!1})),Gd=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>{const l=!Ve(i)||Object.keys(i).some(zr),d=new Wr(l?{k:i}:i,n.queryOptions),v=l?m=>d.test({k:m}):m=>d.test(m);return yt(e,o,c,(m,g)=>{const E=m[g],_=new Array;return E.map(P=>{const B=v(P);return B||_.push(P),B}).some(Boolean)?(m[g]=_,!0):!1})}),Fw=(e,t,r=[],n=pt)=>{const i={};return Object.entries(t).forEach(([o,c])=>{i[o]={$in:c}}),Gd(e,i,r,n)},qw=Object.freeze(["$each","$slice","$sort","$position"]),Hw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>{const l={$each:[i]};return Ve(i)&&qw.some(d=>Qt(i,d))&&Object.assign(l,i),yt(e,o,c,(d,v)=>{const m=d[v]||(d[v]=[]),g=m.slice(0,l.$slice||m.length),E=m.length,_=nt(l.$position)?l.$position:m.length;if(m.splice(_,0,...Bc(n.cloneMode,l.$each)),l.$sort){const S=Ve(l.$sort)?Object.keys(l.$sort||{}).pop():"",P=S?l.$sort[S]:l.$sort,B=S?j=>nr(j,S):j=>j;m.sort((j,H)=>P*jt(B(j),B(H)))}return nt(l.$slice)&&(l.$slice<0?m.splice(0,m.length+l.$slice):m.splice(l.$slice)),E!=m.length||!Ut(g,m)},{descendArray:!0,buildGraph:!0})}),Yd=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>yt(e,o,c,(l,d)=>Ut(l[d],i)?!1:(l[d]=Bc(n.cloneMode,i),!0),{buildGraph:!0})),Kw=(e,t,r=[],n=pt)=>{const i=[],o=Ot(t,r,n,(c,l,d)=>yt(e,l,d,(v,m)=>Qt(v,m)?(i.push(...Yd(e,{[c]:v[m]},r,n)),delete v[m],!0):!1));return Array.from(new Set(o.concat(i)))},Uw=(e,t,r=[],n=pt)=>Ot(t,r,n,(i,o,c)=>yt(e,o,c,(l,d)=>Qt(l,d)?(ye(l)?l[d]=null:delete l[d],!0):!1)),Sl=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:Rw,$bit:$w,$currentDate:Lw,$inc:Tw,$max:Aw,$min:Bw,$mul:Nw,$pop:jw,$pull:Gd,$pullAll:Fw,$push:Hw,$rename:Kw,$set:Yd,$unset:Uw},Symbol.toStringTag,{value:"Module"}));function Jd(e){return e=e??pt,(t,r,n=[],i={},o=e)=>{const c=Object.entries(r);Ie(c.length===1,"Update expression must contain only one operator.");const[l,d]=c[0];Ie(Qt(Sl,l),`Update operator '${l}' is not supported.`);const v=Sl[l];return Object.keys(i).length&&!new Wr(i,o.queryOptions).test(t)?[]:v(t,d,n,o)}}Jd();var Ds;function Xd(e,t){if(!Ds){var r=Jd({cloneMode:"none"});Ds=(n,i)=>{var o=dt(n);return r(o,i),o}}return Ds(e,t)}function zw(e){return this.incrementalModify(t=>{var r=Xd(t,e);return r})}function Ww(e){var t=this._data,r=Xd(t,e);return this._saveData(r,t)}async function Vw(e){return Dn(this.asRxQuery,t=>t.update(e))}var Qw={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=Ww,e.incrementalUpdate=zw},RxQuery:e=>{e.update=Vw}}};let xi=null,Be=null,rc;const Gt=new Promise(e=>{rc=e}),Gw={title:"chat history schema",version:2,description:"Stores chat sessions",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100},tabId:{type:"number"},timestamp:{type:"number"},title:{type:"string"},messages:{type:"array",items:{type:"object",properties:{messageId:{type:"string",maxLength:100},sender:{type:"string"},text:{type:"string"},timestamp:{type:"number"},isLoading:{type:"boolean",default:!1}},required:["messageId","sender","text","timestamp"]}},isStarred:{type:"boolean",default:!1}},required:["id","timestamp","messages"],indexes:["timestamp"]},Yw={1:function(e){return e.isStarred=e.isStarred||!1,e},2:function(e){return e.messages=e.messages.map((t,r)=>({...t,messageId:`${e.id}-msg-${r}-${Date.now()}`,timestamp:e.timestamp||Date.now(),isLoading:!1})),e.timestamp=e.timestamp||Date.now(),e}},Jw=async()=>{console.log("DB: Starting RxDB initialization...");try{Ka(uw),console.log("DB: RxDBQueryBuilderPlugin added."),Ka(xw),console.log("DB: RxDBMigrationSchemaPlugin added."),Ka(Qw),console.log("DB: RxDBUpdatePlugin added.");let e=nw();console.log("DB: Creating RxDB database (tabagentdb)..."),xi=await my({name:"tabagentdb",storage:e}),console.log("DB: RxDB database created successfully:",xi.name),console.log("DB: Adding chatHistory collection (version 2)...");const t=await xi.addCollections({chatHistory:{schema:Gw,migrationStrategies:Yw}});if(console.log("DB: Collections object obtained."),Be=t.chatHistory,!Be)throw new Error("DB: chatHistory collection is null or undefined after addCollections");return console.log("DB: chatHistory collection assigned successfully"),rc(!0),console.log("DB: RxDB initialization finished successfully."),!0}catch(e){return console.error("-------------------------------------------"),console.error("DB: HIGH-LEVEL RxDB INITIALIZATION FAILED:",e),console.error("Error Name:",e.name),console.error("Error Message:",e.message),e.code&&console.error("RxDB Error Code:",e.code),e.parameters&&console.error("RxDB Error Parameters:",e.parameters),e.rxdb&&console.error("RxDB Specific Flag:",e.rxdb),console.error("Stack Trace:",e.stack),console.error("-------------------------------------------"),rc(!1),!1}};function Nc(e){return`${e}-msg-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}async function Xw(e){console.log("DB: Creating new chat session...");try{if(!await Gt||!Be)throw new Error("Database not ready");const r=`chat_${Date.now()}`,n=Date.now(),i={...e,messageId:Nc(r),timestamp:n},o={id:r,tabId:null,timestamp:n,title:(i.text||"New Chat").substring(0,40)+"...",messages:[i],isStarred:!1};return console.log("DB: Inserting new chat session:",o),await Be.insert(o),console.log("DB: New chat session created successfully with ID:",r),r}catch(t){throw console.error("DB: Error creating new chat session:",t),t}}async function Zw(e,t){console.log(`DB: Adding message to chat ID: ${e}`);try{if(!await Gt||!Be)throw new Error("Database not ready");if(!e||!t)throw new Error("Invalid input: chatId and messageObject are required.");const n=await Be.findOne(e).exec();if(!n)throw new Error(`Chat session with ID ${e} not found`);const i={...t,messageId:t.messageId||Nc(e),timestamp:t.timestamp||Date.now(),isLoading:t.isLoading===void 0?!1:t.isLoading};return await n.update({$push:{messages:i}}),console.log(`DB: Message added successfully to chat ${e}. New message ID: ${i.messageId}`),i.messageId}catch(r){throw console.error(`DB: Error adding message to chat ${e}:`,r),r}}async function e0(e,t,r){console.log(`DB: Updating message ID: ${t} in chat ID: ${e}`);try{if(!await Gt||!Be)throw new Error("Database not ready");if(!e||!t||!r)throw new Error("Invalid input: chatId, messageId, and updates are required.");const i=await Be.findOne(e).exec();if(!i)throw new Error(`Chat session with ID ${e} not found`);await i.incrementalModify(o=>{const c=o.messages.findIndex(l=>l.messageId===t);if(c!==-1){const l=o.messages[c];o.messages[c]={...l,...r,messageId:l.messageId},o.timestamp=Date.now(),console.log(`DB: Message ${t} updated in session ${e}.`)}else console.warn(`DB: Message with ID ${t} not found in chat ${e} for update.`);return o})}catch(n){throw console.error(`DB: Error updating message ${t} in chat ${e}:`,n),n}}async function Zd(){console.log("DB: Loading all history from DB...");try{if(!await Gt||!Be)throw new Error("Chat history database is not initialized");const t=await Be.find().sort({timestamp:"desc"}).exec();return console.log(`DB: Loaded ${t.length} history entries.`),t.map(r=>r.toJSON())}catch(e){throw console.error("DB: Error loading chat history:",e),e}}async function An(e){console.log(`DB: Getting chat session by ID: ${e}`);try{if(!await Gt||!Be)throw new Error("Database not initialized");const r=await Be.findOne(e).exec();return r?r.toJSON():(console.warn(`DB: Chat session with ID ${e} not found.`),null)}catch(t){throw console.error(`DB: Error getting chat session ${e}:`,t),t}}async function eh(e){console.log(`DB: Toggling starred status for item ID: ${e}`);try{if(!await Gt||!Be)throw new Error("Database not initialized");const r=await Be.findOne(e).exec();if(!r)throw new Error(`History item with ID ${e} not found`);const n=r.get("isStarred")||!1,i=await r.patch({isStarred:!n});return console.log(`DB: Starred status for ${e} toggled to ${!n}`),i.toJSON()}catch(t){throw console.error(`DB: Error toggling starred status for item ${e}:`,t),t}}async function th(e){console.log(`DB: Deleting history item with ID: ${e}`);try{if(!await Gt||!Be)throw new Error("Database not initialized");const r=await Be.findOne(e).exec();if(!r){console.warn(`DB: History item with ID ${e} not found for deletion.`);return}await r.remove(),console.log(`DB: History item ${e} deleted successfully.`)}catch(t){throw console.error(`DB: Error deleting history item ${e}:`,t),t}}async function t0(e,t){console.log(`DB: Renaming history item ID: ${e} to "${t}"`);try{if(!await Gt||!Be)throw new Error("Database not initialized");const n=await Be.findOne(e).exec();if(!n)throw new Error(`History item with ID ${e} not found for rename.`);await n.patch({title:t}),console.log(`DB: Item ${e} renamed successfully.`)}catch(r){throw console.error(`DB: Error renaming history item ${e}:`,r),r}}async function xl(e,t){console.log(`DB: Loading history from DB with limit: ${e}, skip: ${t}`);try{if(!await Gt||!Be)throw new Error("Chat history database is not initialized");const n=await Be.find().sort({timestamp:"desc"}).skip(t).limit(e).exec();return console.log(`DB: Loaded ${n.length} history entries (page).`),n.map(i=>i.toJSON())}catch(r){throw console.error("DB: Error loading paginated chat history:",r),r}}async function r0(){console.log("DB: Getting total history count...");try{if(!await Gt||!Be)throw new Error("Chat history database is not initialized");const r=(await Be.find().exec()).length;return console.log(`DB: Total history count is ${r}.`),r}catch(e){throw console.error("DB: Error getting chat history count:",e),e}}async function n0(e){console.log(`DB: Searching history for term: "${e}"`);try{if(!await Gt||!Be)throw new Error("Chat history database is not initialized");if(!e)return Zd();const r=e.toLowerCase(),n=await Be.find({selector:{title:{$regex:new RegExp(r,"i")}}}).sort({timestamp:"desc"}).exec();return console.log(`DB: Found ${n.length} history entries matching "${e}".`),n.map(i=>i.toJSON())}catch(t){throw console.error(`DB: Error searching chat history for "${e}":`,t),t}}const rh=Jw(),i0=async(e,t)=>{if(await rh,!xi||!e||!t)return console.error("deleteMessageFromChat: Missing sessionId or messageId"),!1;console.log(`DB: Attempting to delete message ID: ${t} from chat ID: ${e}`);try{const r=await xi.chatHistory.findOne(e).exec();if(!r)return console.warn(`DB: Cannot delete message, session ${e} not found.`),!1;const n=r.messages.findIndex(o=>o.messageId===t);if(n===-1)return console.warn(`DB: Cannot delete message, message ID ${t} not found in session ${e}.`),!1;const i=[...r.messages.slice(0,n),...r.messages.slice(n+1)];return await r.incrementalModify(o=>(o.messages=i,o)),console.log(`DB: Message ${t} deleted successfully from session ${e}.`),!0}catch(r){throw console.error(`DB: Error deleting message ${t} from session ${e}:`,r),r}};function a0(){var e;console.log("Discover Page Initialized (Placeholder)"),(e=document.getElementById("page-discover"))==null||e.querySelector("p")}function Zt(e,t="info",r=3e3){console.log(`[Notification] ${t.toUpperCase()}: ${e} (Duration: ${r}ms)`)}function Nt(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="1000",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}const o0=/^(https?):\/\/[^\s/$.?#].[^\s]*$/i;function s0(){return new Promise((e,t)=>{if(typeof chrome>"u"||!chrome.tabs)return console.warn("Utils: Chrome tabs API not available. Cannot get active tab."),e(null);chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError)return console.error("Utils: Error querying active tab:",chrome.runtime.lastError.message),e(null);r&&r.length>0?e(r[0]):e(null)})})}let rr=null;function nh(e){if(!e){console.error("ChatRenderer: chatBody element is required for initialization.");return}rr=e,console.log("[ChatRenderer] Initialized with chat body element.")}function jc(e){var c,l;if(!rr)return;const t=document.createElement("div");t.classList.add("flex","mb-2"),t.id=e.messageId||`msg-fallback-${Date.now()}-${Math.random().toString(36).substring(2)}`;const r=document.createElement("div");r.classList.add("rounded-lg","break-words","relative","group","p-2"),r.classList.add("max-w-4xl");const n=document.createElement("div");n.className="copy-button-container absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity";const i=document.createElement("button");i.innerHTML='<svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>',i.className="copy-button p-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600",i.title="Copy text",i.onclick=d=>{d.stopPropagation();const v=r.querySelector("pre code")||r.querySelector(".prose")||r,m=(v==null?void 0:v.textContent)||"";navigator.clipboard.writeText(m).then(()=>Zt("Copied!","success",1500)).catch(g=>{console.error("Failed to copy:",g),Zt("Copy failed","error",1500)})},n.appendChild(i),r.appendChild(n);let o=null;if(((c=e.metadata)==null?void 0:c.type)==="scrape_result"){t.classList.add("justify-start"),r.classList.add("bg-gray-200","dark:bg-gray-600");const d=document.createElement("div");d.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),d.textContent=`Scraped (${e.metadata.method||"N/A"}): ${e.metadata.title||e.metadata.url||"Content"}`,r.appendChild(d);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-64","text-sm","prose","prose-sm","dark:prose-invert","whitespace-pre-wrap","mt-1"),v.textContent=e.text||"",r.appendChild(v)}else if(((l=e.metadata)==null?void 0:l.type)==="scrape_stage_result"){t.classList.add("justify-start"),r.classList.add("border","border-gray-300","dark:border-gray-600");const d=document.createElement("div");if(d.classList.add("text-xs","font-semibold","mb-1","pr-6"),e.metadata.success){r.classList.add("bg-gray-100","dark:bg-gray-700"),d.classList.add("text-gray-700","dark:text-gray-300"),d.textContent=`[Stage ${e.metadata.stage} - ${e.metadata.method||"?"} - OK] Len: ${e.metadata.length||0}`,r.appendChild(d);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-64","mt-1");const m=document.createElement("pre");m.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),o=document.createElement("code"),o.className="language-json";const g={title:e.metadata.title||"N/A",links:e.metadata.links};o.textContent=JSON.stringify(g,null,2),m.appendChild(o),v.appendChild(m),r.appendChild(v)}else r.classList.add("bg-red-100","dark:bg-red-900"),d.classList.add("text-red-700","dark:text-red-300"),d.textContent=`[Stage ${e.metadata.stage} - Failed] ${e.metadata.error||"Unknown"}`,r.appendChild(d)}else r.textContent=e.text||"",e.isLoading?(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-500","dark:text-gray-400","italic")):e.sender==="user"?(t.classList.add("justify-end"),r.classList.add("bg-blue-500/20","dark:bg-blue-600/40","text-gray-900","dark:text-gray-100")):e.sender==="error"?(t.classList.add("justify-start"),r.classList.add("bg-red-100","dark:bg-red-900","text-red-700","dark:text-red-300")):(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-900","dark:text-gray-100"));if(t.appendChild(r),rr.appendChild(t),o&&window.Prism)try{Prism.highlightElement(o)}catch(d){console.warn("Prism highlighting failed:",d)}}function dn(){if(!rr)return;rr.innerHTML="",jc({messageId:"welcome-msg",sender:"system",text:"Welcome to Tab Agent! Ask me anything or paste a URL to scrape.",isLoading:!1})}async function Hi(e){if(rr){if(console.log(`ChatRenderer: Rendering session ID: ${e}`),rr.innerHTML="",!e){console.log("ChatRenderer: No session ID provided, showing welcome message."),dn();return}try{const t=await An(e);!t||!t.messages||t.messages.length===0?(console.log(`ChatRenderer: Session ${e} empty or not found. Showing welcome.`),dn()):(console.log(`ChatRenderer: Rendering ${t.messages.length} messages for ${e}.`),t.messages.forEach(r=>jc(r)),ih())}catch(t){console.error(`ChatRenderer: Error fetching/rendering session ${e}:`,t),Nt(`Failed to load chat: ${t.message}`),dn()}}}function ih(){rr&&(rr.scrollTop=rr.scrollHeight)}const kl=Object.freeze(Object.defineProperty({__proto__:null,displayMessage:jc,displayWelcomeMessage:dn,initializeRenderer:nh,renderChatSession:Hi,scrollToBottom:ih},Symbol.toStringTag,{value:"Module"}));function ah(e){if(!e)return"";const t=e.title||"Chat Session",r=(e.messages||[]).map(i=>{const o=i.sender==="user"?"user-message":"other-message",c=i.sender==="user"?"You":i.sender==="ai"?"Agent":"System",d=i.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return`
            <div class="message-row ${o==="user-message"?"row-user":"row-other"}">
                <div class="message-bubble ${o}">
                    <span class="sender-label">${c}:</span>
                    <div class="message-text">${d}</div>
                </div>
            </div>
        `}).join(`
`);return`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</title>
            <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: 20px auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-top: 0; }
        .chat-body { margin-top: 20px; }
        .message-row { margin-bottom: 15px; overflow: hidden; /* Clear floats */ }
        .row-user { text-align: right; }
        .row-other { text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; max-width: 75%; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; /* Align right */ }
        .other-message { background-color: #e9ecef; color: #343a40; margin-right: auto; /* Align left */ }
        .sender-label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: inherit; }
        .message-text { margin-top: 5px; }
    </style>
        </head>
        <body>
            <div class="container">
                <h1>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</h1>
                <div class="chat-body">
                    ${r}
                </div>
            </div>
        </body>
        </html>
    `}function oh(e,t,r){try{const n=new Blob([e],{type:"text/html"}),i=URL.createObjectURL(n);console.log(`Initiating download for: ${t} (prompting user)`),chrome.downloads.download({url:i,filename:t,saveAs:!0},o=>{const c=chrome.runtime.lastError;if(setTimeout(()=>URL.revokeObjectURL(i),100),c){const l=c.message;console.error("Download API error:",l),!l||!l.toLowerCase().includes("cancel")?r?r(`Download failed: ${l||"Unknown error"}`):(console.error("No error handler provided for download failure."),alert(`Download failed: ${l||"Unknown error"}. Ensure extension has permissions.`)):console.log("Download cancelled by user.")}else console.log(o?`Download initiated (or dialog opened) with ID: ${o}`:"Download cancelled by user (no downloadId assigned).")})}catch(n){console.error("Error creating blob or initiating download:",n),r?r("An error occurred while preparing the download."):(console.error("No error handler provided for download preparation error."),alert("An error occurred while preparing the download."))}}async function sh(){console.log("Library Page Initializing...");const e=document.getElementById("starred-list"),t=document.getElementById("library-search");if(!e){console.error("Library Page: Could not find #starred-list element.");return}const r=async(i="")=>{console.log(`Library: Rendering with filter "${i}"`);try{let c=(await Zd()).filter(l=>l.isStarred);if(i){const l=i.toLowerCase();c=c.filter(d=>(d.title||"").toLowerCase().includes(l))}if(e.innerHTML="",c.length===0){const l=i?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items match "${i}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items yet.</p>';e.innerHTML=l;return}c.sort((l,d)=>d.timestamp-l.timestamp),c.forEach(l=>{const d=Ya(l);e.appendChild(d)}),console.log(`Library Page Initialized/Refreshed: Rendered ${c.length} starred items.`)}catch(o){console.error("Library Page: Error loading or rendering starred history:",o),e.innerHTML='<div class="error-message p-4">Error loading starred items.</div>'}},n=c0(r,300);r(),t?t.addEventListener("input",i=>{n(i.target.value.trim())}):console.warn("Library search input not found."),e.addEventListener("click",async i=>{const o=i.target,c=o.closest("button[data-action], span[data-action]"),l=o.closest(".history-item");if(!l||l.classList.contains("is-editing"))return;const d=l.dataset.id;if(!d)return;const v=c?c.dataset.action:null;if(v==="load-chat"||o.classList.contains("action-load-chat")){i.stopPropagation(),console.log(`Library: Load button clicked for ${d}`);try{Fc(d),await Hi(d),fo("page-home")}catch(m){console.error("Library Load Error:",m),alert("Error loading chat.")}return}else if(v==="toggle-star"||o.classList.contains("history-item-star-toggle")){i.stopPropagation(),console.log(`Library: Toggling star for item ${d}`);try{await eh(d),await r((t==null?void 0:t.value.trim())||"")}catch(m){console.error("Library Star Toggle Error:",m),alert("Error updating star status.")}return}else if(v==="delete-chat"){if(i.stopPropagation(),console.log(`Library: Delete action clicked for ${d}`),confirm("Are you sure you want to delete this chat history item? This cannot be undone."))try{await th(d),await r((t==null?void 0:t.value.trim())||"")}catch(m){console.error(`Library: Error deleting item ${d}:`,m),alert("Error deleting item")}return}else if(v==="share-chat"){i.stopPropagation(),console.log(`Library: Share action clicked for ${d}`),alert("Share functionality coming soon!");return}else if(v==="download-chat"){i.stopPropagation(),console.log(`Library: Download action clicked for ${d}`);try{o.textContent="...",o.disabled=!0;const m=await An(d);if(!m)throw new Error("Chat session not found.");const g=ah(m),E=`${m.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()||"chat"}_${d.substring(0,5)}.html`;oh(g,E)}catch(m){console.error(`Error preparing download for ${d}:`,m),Zt(`Failed to prepare download: ${m.message}`,"error"),o.textContent="↓",o.disabled=!1}return}else if(o.classList.contains("history-item-actions-btn")){i.stopPropagation(),console.log(`Library: Preview action clicked for ${d}`);try{const m=await An(d);if(!m||!m.messages){alert("Could not load chat data for preview.");return}const g=m.messages.slice(0,5).map(E=>`${E.sender==="user"?"You":"Agent"}: ${E.text.substring(0,100)}${E.text.length>100?"...":""}`).join(`
`);alert(`Preview of "${m.title}":
--------------------
${g}`)}catch(m){console.error("Library Preview error:",m),alert("Error loading preview.")}return}}),console.log("Library Page Initialization Complete.")}function c0(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}function u0(){var t;console.log("Settings Page Initialized (Placeholder)");const e=(t=document.getElementById("page-settings"))==null?void 0:t.querySelector("p");if(e){e.textContent="Settings controls will be added here.";const r=document.createElement("button");r.className="p-2 border rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 mt-2";const n=()=>{const i=document.documentElement.classList.contains("dark");r.textContent=i?"Switch to Light Mode":"Switch to Dark Mode"};r.onclick=()=>{const i=document.documentElement,o=i.classList.contains("dark");console.log(`[SettingsToggle] Before toggle - isDark: ${o}`),o?(i.classList.remove("dark"),localStorage.setItem("theme","light"),console.log("[SettingsToggle] Removed dark class, set localStorage to light")):(i.classList.add("dark"),localStorage.setItem("theme","dark"),console.log("[SettingsToggle] Added dark class, set localStorage to dark")),n(),setTimeout(()=>{const c=window.getComputedStyle(document.body),l=document.getElementById("query-input"),d=l?window.getComputedStyle(l):null,v=document.documentElement.classList.contains("dark")?"dark":"light";console.log(`[ComputedStyles - ${v} mode] body bg: ${c.getPropertyValue("background-color")}, body color: ${c.getPropertyValue("color")}`),d&&console.log(`[ComputedStyles - ${v} mode] #query-input bg: ${d.getPropertyValue("background-color")}, color: ${d.getPropertyValue("color")}`)},0)},e.parentNode.appendChild(r),n()}}function l0(){var e;console.log("Spaces Page Initialized (Placeholder)"),(e=document.getElementById("page-spaces"))==null||e.querySelector("p")}let ch=[],nc=[],gi=null;const Os=new Set,Cl={"page-home":"Tab Agent","page-discover":"Discover","page-spaces":"Spaces","page-library":"Library","page-settings":"Settings"},Il={"page-discover":a0,"page-library":sh,"page-settings":u0,"page-spaces":l0};async function fo(e){console.log(`Navigating to ${e}`),ch.forEach(n=>{n.classList.add("hidden"),n.classList.remove("active-page")});const t=document.getElementById(e);if(t)t.classList.remove("hidden"),t.classList.add("active-page");else{console.error(`Navigation error: Page with ID ${e} not found. Showing home.`);const n=document.getElementById("page-home");n&&(n.classList.remove("hidden"),n.classList.add("active-page")),e="page-home"}if(gi&&Cl[e]?gi.textContent=Cl[e]:gi&&(gi.textContent="Tab Agent"),nc.forEach(n=>{n.dataset.page===e?n.classList.add("active"):n.classList.remove("active")}),Il[e]&&!Os.has(e))try{console.log(`Initializing ${e}...`),await Il[e](),Os.add(e),console.log(`${e} initialized.`)}catch(n){console.error(`Error initializing ${e}:`,n)}else if(e==="page-library"&&Os.has(e))try{console.log(`Re-initializing ${e} to refresh content...`),await sh()}catch(n){console.error(`Error re-initializing ${e}:`,n)}const r=document.getElementById("query-input");e==="page-home"&&r&&r.focus()}function f0(){console.log("Initializing navigation..."),ch=document.querySelectorAll(".page-container"),nc=document.querySelectorAll(".nav-button"),gi=document.querySelector("#header h1"),nc.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&fo(t)})}),fo("page-home"),console.log("Navigation initialized.")}let Se,St,ic,gr,Bn,Va=!1,Ki=null,ac=null;function d0(){return Se=document.getElementById("query-input"),St=document.getElementById("send-button"),ic=document.getElementById("chat-body"),gr=document.getElementById("attach-button"),Bn=document.getElementById("file-input"),!Se||!St||!ic||!gr||!Bn?(console.error("UIController: One or more essential elements not found!"),!1):!0}function h0(){Se==null||Se.addEventListener("input",ti),Se==null||Se.addEventListener("keydown",uh),St==null||St.addEventListener("click",lh),gr==null||gr.addEventListener("click",fh)}function p0(){Se==null||Se.removeEventListener("input",ti),Se==null||Se.removeEventListener("keydown",uh),St==null||St.removeEventListener("click",lh),gr==null||gr.removeEventListener("click",fh)}function uh(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Ki&&Ki())}function lh(){Ki&&Ki()}function fh(){ac&&ac()}function ti(){if(!Se)return;Se.style.height="auto";const e=150,t=Se.scrollHeight;Se.style.height=`${Math.min(t,e)}px`,St&&(St.disabled=Se.value.trim()===""||Se.disabled)}function dh(e){return console.log("[UIController] Initializing..."),Va&&(console.warn("[UIController] Already initialized. Removing old listeners."),p0()),d0()?(Ki=e==null?void 0:e.onSendMessage,ac=e==null?void 0:e.onAttachFile,h0(),ti(),Va=!0,console.log("[UIController] Initialized successfully."),{queryInput:Se,sendButton:St,chatBody:ic,attachButton:gr,fileInput:Bn}):(Va=!1,null)}function ki(){return Va}function hh(){return(Se==null?void 0:Se.value.trim())||""}function ph(){console.log("[UIController] Entering clearInput function."),Se&&(Se.value="",ti())}function m0(){console.log("[UIController] Entering disableInput function."),Se&&(Se.disabled=!0),St&&(St.disabled=!0)}function Qa(){ki()&&(Se.disabled=!1,ti())}function Ga(){Se==null||Se.focus()}function v0(){Bn==null||Bn.click()}const Dl=Object.freeze(Object.defineProperty({__proto__:null,adjustTextareaHeight:ti,checkInitialized:ki,clearInput:ph,disableInput:m0,enableInput:Qa,focusInput:Ga,getInputValue:hh,initializeUI:dh,triggerFileInputClick:v0},Symbol.toStringTag,{value:"Module"}));let lt=null,ft=null,vt=null,Yn=null,ho=null,po=null,yr=!1;function g0(e){lt=e.dbFunctions,ft=e.uiController,vt=e.chatRenderer,Yn=e.getActiveSessionIdFunc,ho=e.onSessionCreatedCallback,po=e.getCurrentTabIdFunc,!lt||!ft||!vt||!Yn||!ho||!po?console.error("MessageHandler: Missing one or more dependencies during initialization!"):console.log("[MessageHandler] Initialized with dependencies.")}async function y0(e){if(yr){console.warn("MessageHandler: Already processing a message.");return}if(!e){console.warn("MessageHandler: Attempted to send empty message.");return}if(!lt||!ft||!vt||!Yn||!po){Nt("Cannot send message: Handler not properly initialized.");return}yr=!0,ft.disableInput();let t=Yn();const r=po();let n=null;console.log(`MessageHandler: Processing message. Text: "${e}". Session: ${t}`);const i=o0.test(e);try{const o={sender:"user",text:e,timestamp:Date.now(),isLoading:!1};t?(console.log(`MessageHandler: Adding user message to existing session ${t}.`),n=await lt.addMessageToChat(t,o),vt.displayMessage(o),vt.scrollToBottom()):(console.log("MessageHandler: No active session, creating new one."),t=await lt.createChatSession(o),ho?ho(t):console.error("MessageHandler: onSessionCreatedCallback is missing!"),await vt.renderChatSession(t)),i?await b0(t,e,r):await w0(t,e,r),ft.clearInput()}catch(o){console.error("MessageHandler: Error processing message:",o),Nt(`Error: ${o.message}`),ft.enableInput(),yr=!1}}async function b0(e,t,r){console.log(`MessageHandler: Entering processUrl for session ${e}, url: ${t}`);let n=null;try{const i=await s0(),o=i==null?void 0:i.url,c=g=>g?g.replace(/\/$/,""):null,l=c(t),d=c(o),v=i&&i.id&&l===d?`⏳ Scraping active tab: ${t}...`:`⏳ Scraping ${t}...`,m={messageId:lt.generateMessageId(e),sender:"system",text:v,timestamp:Date.now(),isLoading:!0};n=await lt.addMessageToChat(e,m),vt.displayMessage(m),vt.scrollToBottom(),i&&i.id&&l===d?(console.log("MessageHandler: URL matches active tab. Using content script."),chrome.tabs.sendMessage(i.id,{type:"SCRAPE_ACTIVE_TAB"},async g=>{chrome.runtime.lastError?(console.error("MessageHandler: Error sending SCRAPE_ACTIVE_TAB:",chrome.runtime.lastError.message),await cc(e,n,!1,`Error sending request: ${chrome.runtime.lastError.message}`)):console.log("MessageHandler: SCRAPE_ACTIVE_TAB message sent.")})):(console.log("MessageHandler: URL differs from active tab or no active tab. Using background scrape."),chrome.runtime.sendMessage({type:"TEMP_SCRAPE_URL",url:t,tabId:r,chatId:e,messageId:n},g=>{chrome.runtime.lastError?(console.error("MessageHandler: Error sending TEMP_SCRAPE_URL:",chrome.runtime.lastError.message),sc(e,n,`Error initiating scrape: ${chrome.runtime.lastError.message}`)):console.log("MessageHandler: TEMP_SCRAPE_URL message sent successfully.")}))}catch(i){throw console.error("MessageHandler: Error in processUrl:",i),n?await cc(e,n,!1,`Error processing URL: ${i.message}`):(Nt(`Error processing URL: ${i.message}`),ft.enableInput(),yr=!1),i}}async function w0(e,t,r){console.log(`MessageHandler: Entering processQuery for session ${e}, text: ${t}`);let n=null;try{const i={messageId:lt.generateMessageId(e),sender:"ai",text:"Thinking...",timestamp:Date.now(),isLoading:!0};n=await lt.addMessageToChat(e,i),vt.displayMessage(i),vt.scrollToBottom();const o={type:"query",tabId:r,text:t,chatId:e,messageId:n};console.log("MessageHandler: Sending query to background:",o),chrome.runtime.sendMessage(o,c=>{chrome.runtime.lastError?(console.error("MessageHandler: Error sending query:",chrome.runtime.lastError.message),sc(e,n,`Connection error: ${chrome.runtime.lastError.message}`)):console.log("MessageHandler: Query message sent successfully.")})}catch(i){throw console.error("MessageHandler: Error in processQuery:",i),n?await sc(e,n,`Error processing query: ${i.message}`):(Nt(`Error processing query: ${i.message}`),ft.enableInput(),yr=!1),i}}function _0(){chrome.runtime.onMessage.addListener(async(e,t,r)=>{if(console.log("MessageHandler received message:",e),!lt||!ft||!vt||!Yn)return console.error("MessageHandler listener: Dependencies not initialized!"),!1;if(Yn(),e.type==="response"&&e.chatId&&e.messageId){const{chatId:n,messageId:i,text:o}=e;console.log(`MessageHandler: Handling 'response' for chat ${n}, message ${i}`),await oc(n,i,{isLoading:!1,sender:"ai",text:o||"Received empty response."})}else if(e.type==="error"&&e.chatId&&e.messageId){const{chatId:n,messageId:i,error:o}=e;console.error(`MessageHandler: Handling 'error' for chat ${n}, message ${i}:`,o),await oc(n,i,{isLoading:!1,sender:"error",text:`Error: ${o||"Unknown error occurred."}`})}else if(e.type==="STAGE_SCRAPE_RESULT"&&e.payload){const{stage:n,success:i,chatId:o,messageId:c,error:l,...d}=e.payload;console.log(`MessageHandler: Handling STAGE_SCRAPE_RESULT Stage ${n}, chatId: ${o}`);const v={messageId:lt.generateMessageId(o),sender:i?"system":"error",timestamp:Date.now(),isLoading:!1,metadata:{type:"scrape_stage_result",stage:n,originalPlaceholderId:c,success:i,...i?d:{error:l||"Unknown"}}};v.text=i?`Stage ${n} (${d.method||"?"}) OK`:`Stage ${n} Failed: ${l||"Unknown"}`;try{if(await lt.addMessageToChat(o,v),console.log(`MessageHandler: Added stage ${n} result message to DB.`),i||n===4){console.log(`MessageHandler: Final update for scrape (Stage ${n}, Success: ${i}). Cleaning up placeholder ${c}.`);try{await lt.deleteMessageFromChat(o,c)}catch(g){console.error(`MessageHandler: Failed to delete placeholder ${c}, continuing.`,g)}console.log(`MessageHandler: Attempting to re-enable UI after final scrape update for chat ${o}.`);try{ft.enableInput(),ft.focusInput(),console.log(`MessageHandler: Successfully called enableInput and focusInput for chat ${o}.`)}catch(g){console.error(`MessageHandler: Error during UI enable/focus for chat ${o}:`,g),Nt("Error updating UI state after scrape.")}yr=!1,console.log("MessageHandler: UI re-enabled, isSendingMessage reset.")}console.log(`MessageHandler: Attempting to re-render chat ${o} after stage result.`);try{await vt.renderChatSession(o),console.log(`MessageHandler: Successfully re-rendered chat ${o} after stage result.`)}catch(g){console.error(`MessageHandler: Error re-rendering chat ${o} after stage result:`,g),Nt("Error displaying latest chat messages.")}}catch(m){if(console.error(`MessageHandler: DB Error handling STAGE_SCRAPE_RESULT (Stage ${n}):`,m),Nt(`Failed to record result for Stage ${n}.`),isFinalUpdate){console.log(`MessageHandler: Attempting to re-enable UI after DB error during final scrape update for chat ${o}.`);try{ft.enableInput(),console.log(`MessageHandler: Successfully called enableInput after DB error for chat ${o}.`)}catch(g){console.error(`MessageHandler: Error during UI enable after DB error for chat ${o}:`,g),Nt("Error updating UI state after DB error.")}yr=!1}}}else if(e.type==="scrapeResult"&&e.chatId&&e.messageId){const{chatId:n,messageId:i,success:o,error:c,...l}=e;console.log(`MessageHandler: Handling direct 'scrapeResult' for chat ${n}, message ${i}`),await cc(n,i,o,c,l)}return!1})}async function oc(e,t,r){console.log(`MessageHandler: Entering handleBackgroundResponse for chat ${e}, message ${t}`);try{await lt.updateMessageInChat(e,t,r),console.log(`MessageHandler: Updated message ${t} in chat ${e}.`),await vt.renderChatSession(e),console.log(`MessageHandler: Attempting to re-enable UI after background response for chat ${e}.`),ft.enableInput(),ft.focusInput()}catch(n){console.error(`MessageHandler: DB Error updating message ${t} for background response:`,n)}finally{yr=!1,console.log("MessageHandler: isSendingMessage reset after background response.")}}async function sc(e,t,r){console.log(`MessageHandler: Entering handleBackgroundResponseError for chat ${e}, message ${t}`);try{await lt.updateMessageInChat(e,t,{isLoading:!1,sender:"error",text:r}),await vt.renderChatSession(e)}catch(n){console.error(`MessageHandler: DB Error updating message ${t} on background error:`,n),Nt("Failed to update chat with error status.")}console.log(`MessageHandler: Attempting to re-enable UI after background response error for chat ${e}.`),ft.enableInput(),yr=!1}async function cc(e,t,r,n,i={}){console.log(`MessageHandler: Entering handleScrapeResponse for chat ${e}, message ${t}, Success: ${r}`);const o={isLoading:!1};r?(o.sender="system",o.text=i.text||i.excerpt||"Scraped content (no text found).",o.metadata={type:"scrape_result",method:i.method||"unknown",url:i.url,title:i.title}):(o.sender="error",o.text=`Scraping failed: ${n||"Unknown error."}`),console.log(`MessageHandler: Calling handleBackgroundResponse from handleScrapeResponse for chat ${e}`),await oc(e,t,o)}let mo=null,vo=null,Ci=null,go=null;function E0(e){mo=e.dbFunctions,vo=e.chatRenderer,Ci=e.getActiveSessionIdFunc,go=e.uiController,!mo||!vo||!Ci||!go?console.error("FileHandler: Missing one or more dependencies during initialization!"):console.log("[FileHandler] Initialized.")}async function S0(e){if(!mo||!vo||!Ci){console.error("FileHandler: Not initialized properly.");return}const t=e.target.files;if(!t||t.length===0){console.log("FileHandler: No file selected.");return}const r=t[0];console.log(`FileHandler: File selected - ${r.name}, Type: ${r.type}, Size: ${r.size}`);const n=Ci();if(!n){Nt("Please start or select a chat before attaching a file."),e.target.value="";return}const i={sender:"system",text:`📎 Attached file: ${r.name}`,timestamp:Date.now(),isLoading:!1};try{await mo.addMessageToChat(n,i),n===Ci()&&await vo.renderChatSession(n)}catch(o){console.error("FileHandler: Error adding file attachment message:",o),Nt("Failed to add file attachment message.")}finally{e.target.value=""}}function x0(){if(!go){console.error("FileHandler: UI Controller not available to trigger file input.");return}console.log("FileHandler: Triggering file input click."),go.triggerFileInputClick()}let $t=null,Ar=null,Ps=!1,Ol=null,rn,Kt,Na,pi,tt,$r;function Pl(e,t){let r;return function(...i){const o=()=>{clearTimeout(r),e(...i)};clearTimeout(r),r=setTimeout(o,t)}}function er(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="100",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function k0(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(e.classList.add("is-editing"),t.style.display="none",r.style.display="block",r.value=t.textContent,r.focus(),r.select())}async function Rs(e,t,r=!1){if(!e||!t)return;const n=e.querySelector(".history-item-preview"),i=e.querySelector(".history-item-rename-input");if(!n||!i)return;const o=i.value.trim(),c=n.textContent;if(!r&&o&&o!==c)try{console.log(`Attempting to rename item ${t} to "${o}"`),await t0(t,o),n.textContent=o,n.title=o,console.log(`Item ${t} renamed successfully in UI.`)}catch(l){console.error(`Error renaming item ${t}:`,l),er(`Failed to rename chat: ${l.message}`)}else i.value=n.textContent;i.style.display="none",n.style.display="block",e.classList.remove("is-editing")}const yi='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>',mh='<svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 17.8798 20.1818C17.1169 21 15.8356 21 13.2731 21H10.7269C8.16438 21 6.8831 21 6.12019 20.1818C5.35728 19.3671 5.27811 18.0864 5.11973 15.5251L4.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M3 5.5H21M16.5 5.5L16.1733 3.57923C16.0596 2.8469 15.9989 2.48073 15.8184 2.21449C15.638 1.94825 15.362 1.75019 15.039 1.67153C14.7158 1.59286 14.3501 1.59286 13.6186 1.59286H10.3814C9.64993 1.59286 9.28419 1.59286 8.96099 1.67153C8.63796 1.75019 8.36201 1.94825 8.18156 2.21449C8.00111 2.48073 7.9404 2.8469 7.82672 3.57923L7.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M14 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';function Ya(e,t){const r=document.createElement("div");r.className="history-item group relative mb-2",r.dataset.id=e.id,e.isStarred&&r.classList.add("starred");const i=new Date(e.timestamp).toLocaleString(),o=e.title||(e.messages&&e.messages.length>0?(e.messages[0].text||"").substring(0,50)+"...":"Empty chat"),c=e.isStarred?"icons/StarFilled.png":"icons/StarHollow.png";r.innerHTML=`
        <div class="chat-card bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-3 flex flex-col justify-between min-h-[100px]">
            <div>
                <div class="card-header flex justify-between items-center mb-2">
                    <button data-action="toggle-star" class="action-button history-item-star-toggle ${e.isStarred?"starred":"unstarred"}" title="Toggle Star">
                         <!-- Use dynamic src -->
                         <img src="${c}" alt="Star" class="w-4 h-4 action-icon-img">
                    </button>
                    <div class="actions flex items-center space-x-1">
                         <button data-action="download-chat" class="action-button" title="Download">
                              <!-- <img src="icons/download-icon-template.svg" alt="Download" class="w-4 h-4 action-icon-img"> Placeholder: Create or find a download icon -->
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 action-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> <!-- Using a fallback SVG icon -->
                         </button>
                         <button data-action="share-chat" class="action-button" title="Share">
                              <img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">
                         </button>
                         <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${mh}</button>
                         <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${yi}</button>
                    </div>
                </div>
                <div class="card-body mb-1" data-action="load-chat-body">
                    <div class="history-item-preview font-semibold text-sm truncate" title="${o}">${o}</div>
                    <input type="text" class="history-item-rename-input w-full text-sm p-1 border rounded" value="${o}" style="display: none;"/>
                </div>
                <!-- Hidden Preview Content Area -->
                <div class="history-item-preview-content hidden mt-2 p-2 border-t border-gray-200 dark:border-gray-600 text-xs max-h-24 overflow-y-auto">
                    <!-- Preview messages will be injected here -->
                </div>
            </div>
            <div class="card-footer mt-auto flex justify-between items-center">
                 <span class="history-item-date text-xs text-gray-500 dark:text-gray-400">${i}</span>
                 <button class="history-item-load-btn text-xs p-0.5 rounded" data-action="load-chat" title="Load Chat"> <!-- Removed hover:bg-* classes -->
                    <img src="icons/Load.png" alt="Load" class="h-6 w-auto"> <!-- Changed h-4 to h-6 -->
                 </button>
            </div>
        </div>
    `;const l=r.querySelector(".history-item-preview"),d=r.querySelector(".history-item-rename-input");l&&d&&(l.addEventListener("dblclick",g=>{g.stopPropagation(),k0(r)}),d.addEventListener("blur",()=>Rs(r,e.id,!1)),d.addEventListener("keydown",g=>{g.key==="Enter"?(g.preventDefault(),Rs(r,e.id,!1)):g.key==="Escape"&&(g.preventDefault(),Rs(r,e.id,!0))}));const v=r.querySelector(".history-item-load-btn");v&&v.addEventListener("click",async g=>{g.stopPropagation();const E=r.dataset.id;console.log(`Load Button: Load action clicked for ${E}`),Fc(E),await Hi(E),typeof t=="function"?t():console.warn("hidePopupFunc not provided to renderSingleHistoryItem")});const m=r.querySelector('[data-action="toggle-star"] img');return m&&(e.isStarred||m.classList.add("icon-unstarred")),r}async function C0(){if(!$t){console.error("Cannot detach: Missing tab ID"),er("Cannot detach: Missing tab ID");return}const e=Ja();try{const t=await chrome.runtime.sendMessage({type:"getPopupForTab",tabId:$t});if(t&&t.popupId){await chrome.windows.update(t.popupId,{focused:!0});return}const r=`detachedSessionId_${$t}`;await chrome.storage.local.set({[r]:e}),console.log(`Sidepanel: Saved session ID ${e} for detach key ${r}.`);const n=await chrome.windows.create({url:chrome.runtime.getURL(`sidepanel.html?context=popup&originalTabId=${$t}`),type:"popup",width:400,height:600});if(n!=null&&n.id)await chrome.runtime.sendMessage({type:"popupCreated",tabId:$t,popupId:n.id});else throw new Error("Failed to create popup window.")}catch(t){console.error("Error during detach:",t),er(`Error detaching chat: ${t.message}`)}}function Fc(e){console.log(`Sidepanel: Setting activeChatSessionId to ${e}`),Ar=e}function Ja(){return Ar}document.addEventListener("DOMContentLoaded",async()=>{console.log("Sidepanel DOM Loaded. Initializing..."),rn=document.getElementById("history-button"),Kt=document.getElementById("history-popup"),Na=document.getElementById("close-history"),pi=document.getElementById("history-search"),tt=document.getElementById("history-list"),$r=document.getElementById("detach-button");const e=document.getElementById("drive-button"),t=document.getElementById("drive-viewer-modal"),r=document.getElementById("drive-viewer-list"),n=document.getElementById("drive-viewer-close"),i=document.getElementById("drive-viewer-cancel"),o=document.getElementById("drive-viewer-search"),c=document.getElementById("drive-viewer-selected-area"),l=document.getElementById("drive-viewer-breadcrumbs"),d=document.getElementById("drive-viewer-back");let v=!1,m=!1;const g=10;let E=0,_=0,S=!1,P="root",B=[{id:"root",name:"Root"}],j={},H={},Y=!1,ce="";function oe(){v||t&&(m&&_e(),console.log("Sidepanel: Showing Drive Viewer modal."),P="root",B=[{id:"root",name:"Root"}],H={},j={},ce="",o&&(o.value=""),Xe(),Re(),we("root"),t.classList.remove("hidden"),v=!0)}function ee(){v&&t&&(console.log("Sidepanel: Hiding Drive Viewer modal."),t.classList.add("hidden"),v=!1,r&&(r.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>'))}const ie="application/vnd.google-apps.folder";function me(L){if(!r)return;r.innerHTML="";const Q=ce.toLowerCase(),te=ce?L.filter(X=>X.name.toLowerCase().includes(Q)):L;if(!te||te.length===0){r.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 p-4">${ce?"No results found.":"Folder is empty."}</div>`;return}te.forEach(X=>{const de=X.mimeType===ie,xe=document.createElement("div");xe.className="drive-viewer-item flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer",xe.dataset.id=X.id,xe.dataset.name=X.name,xe.dataset.mimeType=X.mimeType,xe.dataset.iconLink=X.iconLink||"";const ke=document.createElement("div");ke.className="flex-shrink-0 w-6 h-6 mr-3 flex items-center justify-center",X.iconLink?ke.innerHTML=`<img src="${X.iconLink}" alt="${de?"Folder":"File"}" class="w-5 h-5">`:ke.innerHTML=se(X.mimeType);const qe=document.createElement("span");qe.className="flex-grow truncate",qe.textContent=X.name,qe.title=X.name,xe.appendChild(ke),xe.appendChild(qe),H[X.id]&&xe.classList.add("selected"),xe.addEventListener("click",Fe),r.appendChild(xe)})}function we(L){if(!(!r||Y)){if(Y=!0,console.log(`Sidepanel: Fetching Drive content for folder: ${L}`),Le(),it(),r.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>',j[L]){console.log(`Sidepanel: Using cached content for folder: ${L}`),me(j[L]),Y=!1;return}chrome.runtime.sendMessage({type:"getDriveFileList",folderId:L},Q=>{chrome.runtime.lastError?(console.error("Sidepanel: Error sending getDriveFileList message:",chrome.runtime.lastError.message),er(`Error fetching folder content: ${chrome.runtime.lastError.message}`),r&&(r.innerHTML='<div class="text-center text-red-500 p-4">Error sending request.</div>'),Y=!1):console.log(`Sidepanel: Sent getDriveFileList request for ${L}. Waiting for response...`)})}}function Fe(L){L.stopPropagation();const Q=L.currentTarget,te=Q.dataset.id,X=Q.dataset.name,de=Q.dataset.mimeType,xe=Q.dataset.iconLink;if(!te||!de){console.error("Sidepanel: Clicked Drive item missing ID or mimeType.");return}de===ie?(console.log(`Sidepanel: Navigating into folder: ${X} (${te})`),P=te,B.push({id:te,name:X}),we(te)):(console.log(`Sidepanel: Toggling selection for file: ${X} (${te})`),De(te,Q,{id:te,name:X,mimeType:de,iconLink:xe}))}function Le(){l&&(l.innerHTML="",B.forEach((L,Q)=>{const te=document.createElement(Q===B.length-1?"span":"button");if(te.textContent=L.name,te.dataset.id=L.id,te.dataset.index=Q,Q<B.length-1){te.className="text-blue-600 hover:underline dark:text-blue-400 cursor-pointer",te.addEventListener("click",pe);const X=document.createElement("span");X.textContent=" / ",X.className="mx-1 text-gray-400",l.appendChild(te),l.appendChild(X)}else te.className="font-semibold",l.appendChild(te)}))}function pe(L){const Q=parseInt(L.currentTarget.dataset.index,10),te=L.currentTarget.dataset.id;if(isNaN(Q)||!te){console.error("Sidepanel: Invalid breadcrumb data.");return}te!==P&&(console.log(`Sidepanel: Breadcrumb click - Navigating to index ${Q} (${te})`),B=B.slice(0,Q+1),P=te,we(te))}function De(L,Q,te){H[L]?(delete H[L],Q==null||Q.classList.remove("selected")):(H[L]=te,Q==null||Q.classList.add("selected")),Re(),Xe()}function Re(){if(!c)return;const L=Object.keys(H),Q=c.querySelector(".flex-wrap")||c;Q.innerHTML="",L.length===0?c.classList.add("hidden"):(c.classList.remove("hidden"),L.forEach(te=>{const X=H[te],de=document.createElement("span");de.className="selected-file-item inline-flex items-center bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-100 text-xs font-medium mr-2 mb-1 px-2.5 py-0.5 rounded-full",X.iconLink?de.innerHTML=`<img src="${X.iconLink}" alt="" class="w-3 h-3 mr-1.5"> ${X.name} `:de.textContent=X.name+" ";const xe=document.createElement("button");xe.className="selected-file-remove ml-1.5 inline-flex items-center justify-center h-4 w-4 rounded-full bg-blue-200 dark:bg-blue-700 hover:bg-blue-300 dark:hover:bg-blue-600 focus:outline-none",xe.innerHTML="&times;",xe.dataset.id=te,xe.addEventListener("click",Te),de.appendChild(xe),Q.appendChild(de)}))}function Te(L){const Q=L.currentTarget.dataset.id;if(Q&&H[Q]){delete H[Q],Re(),Xe();const te=r==null?void 0:r.querySelector(`.drive-viewer-item[data-id="${Q}"]`);te==null||te.classList.remove("selected")}}function Xe(){const L=document.getElementById("drive-viewer-insert");if(!L)return;const Q=Object.keys(H).length;L.disabled=Q===0,L.textContent=`Insert (${Q})`}const qt=Pl(L=>{ce=L.target.value.trim(),console.log(`Sidepanel: Filtering Drive items by term: "${ce}"`),j[P]?me(j[P]):r.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Enter search term...</div>'},300);function Ne(){if(B.length<=1)return;const L=B[B.length-2];B.pop(),P=L.id,console.log(`Sidepanel: Back button click - Navigating to ${L.name} (${L.id})`),we(L.id)}function it(){d&&(B.length>1?d.classList.remove("hidden"):d.classList.add("hidden"))}function se(L){return L===ie?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'}function _e(){m&&Kt&&(console.log("Hiding History popup."),Kt.classList.add("hidden"),m=!1)}async function Ye(){if(S)return;const L=document.getElementById("load-more-history-btn");L&&(L.textContent="Loading...",L.disabled=!0),S=!0,console.log(`Sidepanel: Loading more history items. Current skip: ${E}`);try{const Q=E;console.log(`Calculated next skip: ${Q}`);const te=await xl(g,Q);if(!tt){S=!1;return}te.forEach(X=>{const de=Ya(X,_e);tt.appendChild(de)}),E+=te.length,console.log(`Sidepanel: Updated history skip to: ${E}`),fe(te.length)}catch(Q){console.error("Sidepanel: Error loading more history items:",Q),er("Failed to load more history"),L&&L.remove()}finally{S=!1;const Q=document.getElementById("load-more-history-btn");Q&&(Q.textContent="Load Older Chats")}}function fe(L){const Q=document.getElementById("load-more-history-btn");Q&&Q.remove();const te=(tt==null?void 0:tt.querySelectorAll(".history-item").length)||0;if(console.log(`Updating Load More button: Loaded this page: ${L}, Displayed total: ${te}, DB total count: ${_}`),te<_){const X=document.createElement("button");X.id="load-more-history-btn",X.textContent="Load Older Chats",X.className="load-more-button w-full text-center py-2 mt-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",X.addEventListener("click",Ye);const de=Kt==null?void 0:Kt.querySelector(".history-content");de?de.appendChild(X):console.warn("Could not find .history-content to append load more button.")}else console.log("Load More button condition not met or all items loaded.")}async function Me(L=""){if(console.log(`Sidepanel: Rendering history list with filter: "${L}"`),!tt){console.error("History list element not found, cannot render.");return}if(S){console.log("History is already loading, skipping concurrent render request.");return}S=!0;const Q=L.trim()!=="",te=document.getElementById("load-more-history-btn");te&&te.remove(),tt.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">Loading...</div>';try{if(Q){console.log("Performing history search..."),E=0;const X=await n0(L);_=X.length,tt.innerHTML="",X.length===0?tt.innerHTML=`<div class="p-4 text-center text-gray-500 dark:text-gray-400">No results for "${L}"</div>`:(console.log(`Displaying ${X.length} search results.`),X.forEach(de=>{const xe=Ya(de,_e);tt.appendChild(xe)}))}else{console.log("Performing initial history load."),E=0,_=await r0();const X=await xl(g,E);tt.innerHTML="",_===0?tt.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">No chat history found</div>':(console.log(`Displaying first page: ${X.length} of ${_} items.`),X.forEach(de=>{const xe=Ya(de,_e);tt.appendChild(xe)}),E=X.length,console.log(`Sidepanel: Updated history skip after initial load to: ${E}`),fe(X.length))}}catch(X){console.error("Sidepanel: Error rendering history list:",X),tt.innerHTML='<div class="p-4 text-center text-red-500">Error loading chat history</div>',er("Failed to render chat history")}finally{S=!1}}const mt=Pl(Me,300),Pt=new URLSearchParams(window.location.search);if(Pt.get("context")==="popup"&&Pt.has("originalTabId")){Ps=!0,Ol=parseInt(Pt.get("originalTabId"),10),$t=Ol,console.log(`Sidepanel: Running in POPUP mode for original tab ${$t}`),$r.style.display="none";try{const L=`detachedSessionId_${$t}`,Q=await chrome.storage.local.get([L]);if(Q[L]){const te=Q[L];console.log(`Sidepanel: Found detached session ID ${te} for popup (tab ${$t})`),Ar=te,await chrome.storage.local.remove(L)}else console.warn(`Sidepanel: No detached session ID found in storage for key ${L}. Popup might not load correctly.`)}catch(L){console.error("Sidepanel: Error loading detached session state for popup:",L)}}else{Ps=!1,console.log("Sidepanel: Running in SIDE PANEL mode.");try{const L=await chrome.runtime.sendMessage({type:"getTabId"});L!=null&&L.tabId?($t=L.tabId,console.log(`Sidepanel: Received currentTabId = ${$t}`),$r.disabled=!1):(console.error("Sidepanel: Could not get tab ID from background.",L),$r.disabled=!0)}catch(L){console.error("Sidepanel: Error requesting tab ID:",L),$r.disabled=!0}}console.log(`[SidepanelInit] Initial documentElement className: "${document.documentElement.className}"`);try{if(console.log("Sidepanel: Waiting for DB initialization..."),!await rh)throw new Error("Database initialization failed.");console.log("Sidepanel: DB is ready.")}catch(L){console.error("Sidepanel: CRITICAL - Error during DB initialization wait:",L),er("Failed to initialize database. History features disabled."),rn.disabled=!0;return}f0();const ar={createChatSession:Xw,addMessageToChat:Zw,updateMessageInChat:e0,generateMessageId:Nc,deleteMessageFromChat:i0,getChatSessionById:An},bn=dh({onSendMessage:()=>{const L=hh();L&&y0(L)},onAttachFile:()=>{x0()}});if(!bn){er("Failed to initialize UI components.");return}nh(bn.chatBody),g0({dbFunctions:ar,uiController:Dl,chatRenderer:kl,getActiveSessionIdFunc:Ja,onSessionCreatedCallback:Me,getCurrentTabIdFunc:()=>$t}),E0({dbFunctions:ar,chatRenderer:kl,getActiveSessionIdFunc:Ja,uiController:Dl}),bn.fileInput?bn.fileInput.addEventListener("change",S0):console.warn("File input element not found after UI initialization."),_0();const ne=document.getElementById("new-chat-button");Ar?(console.log(`Sidepanel: Loading initial chat session: ${Ar}`),await Hi(Ar)):Ps?(console.warn("Sidepanel: Popup context loaded without an active session ID. Showing welcome/error state."),dn(),ki()&&(Qa(),Ga())):(console.log("Sidepanel: No active session ID found, showing welcome message."),dn(),ki()&&(Qa(),Ga())),rn==null||rn.addEventListener("click",async()=>{if(console.log(`[HistoryBtn] Clicked. isHistoryOpen: ${m}, isDriveOpen: ${v}`),m)console.log("[HistoryBtn] History is open, hiding."),_e();else{v&&(console.log("[HistoryBtn] Drive is open, attempting to hide."),ee()),console.log("[HistoryBtn] Proceeding to show history."),pi.value="";try{await Me(),console.log("[HistoryBtn] Removing hidden class from historyPopup."),Kt==null||Kt.classList.remove("hidden"),m=!0,console.log(`[HistoryBtn] State set. isHistoryOpen: ${m}`)}catch{}}}),Na==null||Na.addEventListener("click",()=>{_e()}),document.addEventListener("click",L=>{m&&Kt&&!Kt.contains(L.target)&&rn&&!rn.contains(L.target)&&_e(),v&&t&&!t.contains(L.target)&&e&&!e.contains(L.target)&&ee()}),pi==null||pi.addEventListener("input",L=>{mt(L.target.value.trim())}),$r==null||$r.addEventListener("click",C0),ne==null||ne.addEventListener("click",()=>{if(console.log("Sidepanel: New Chat button clicked."),Ar===null){console.log("Sidepanel: Already in a new chat state.");return}Ar=null,dn(),ki()&&(ph(),Qa(),Ga()),fo("page-home"),console.log("Sidepanel: Active session ID reset to null, UI cleared.")}),e==null||e.removeEventListener("click",oe);const ri=L=>{L.stopPropagation(),oe()};e==null||e.removeEventListener("click",ri),e==null||e.addEventListener("click",ri),n==null||n.addEventListener("click",ee),i==null||i.addEventListener("click",ee);const kr=document.getElementById("drive-viewer-insert");kr==null||kr.addEventListener("click",async()=>{const L=Object.values(H);if(L.length===0){console.warn("Drive Insert clicked, but no files selected.");return}let Q=Ja(),te=!1;console.log(`Inserting ${L.length} Drive files. Current session: ${Q}`);const de=`📎 Attached Drive files: ${L.map(ke=>ke.name).join(", ")}`,xe={type:"drive_attachments",files:L.map(ke=>({id:ke.id,name:ke.name,mimeType:ke.mimeType,iconLink:ke.iconLink}))};try{if(Q){console.log(`Adding attachment message to existing session ${Q}`);const ke={messageId:ar.generateMessageId(Q),sender:"system",text:de,timestamp:Date.now(),isLoading:!1,metadata:xe};await ar.addMessageToChat(Q,ke)}else{te=!0,console.log("No active session, creating a new one for Drive attachment.");const ke={sender:"system",text:de,timestamp:Date.now(),isLoading:!1,metadata:xe};Q=await ar.createChatSession(ke),Fc(Q),typeof Me=="function"?await Me():console.warn("renderHistoryList function not found when creating session from Drive insert."),console.log(`New session ${Q} created.`)}await Hi(Q),H={},Re(),Xe(),ee()}catch(ke){console.error("Error adding Drive attachment message:",ke),er("Failed to add Drive attachment message.")}}),o==null||o.addEventListener("input",qt),d==null||d.addEventListener("click",Ne),chrome.runtime.onMessage.addListener((L,Q,te)=>{if(console.log("Sidepanel received message from background:",L),L.type==="driveFileListResponse"){if(console.log(`Sidepanel: Handling driveFileListResponse for folder: ${L.folderId}`),Y=!1,!v||L.folderId!==P)return console.warn(`Sidepanel: Ignoring driveFileListResponse for folder ${L.folderId}. Current: ${P}, IsOpen: ${v}`),!1;if(L.success&&L.files)j[L.folderId]=L.files,me(L.files);else{const X=L.error||"Unknown error fetching files.";console.error(`Sidepanel: Drive file list error for ${L.folderId}: ${X}`),er(`Error fetching folder content: ${X}`),r&&(r.innerHTML=`<div class="text-center text-red-500 p-4">Error loading content: ${X}</div>`)}}return!1}),console.log("Sidepanel Initialization Complete.");try{const L=document.createElement("script");L.src="assets/prism.js",L.onload=()=>{console.log("Prism Core loaded.");const Q=document.createElement("script");Q.src="assets/prism-json.min.js",Q.onload=()=>console.log("Prism JSON component loaded."),Q.onerror=()=>console.error("Failed to load Prism JSON component."),document.body.appendChild(Q)},L.onerror=()=>console.error("Failed to load Prism Core."),document.body.appendChild(L)}catch(L){console.error("Error loading Prism scripts:",L)}tt.addEventListener("click",async L=>{var wn;const Q=L.target,te=Q.closest("button"),X=(te==null?void 0:te.closest("[data-action]"))||Q.closest("[data-action]"),de=Q.closest(".history-item");if(!de)return;const xe=de.classList.contains("is-confirming-delete"),ke=X?X.dataset.action:null;if(xe&&ke!=="confirm-delete"&&ke!=="cancel-delete"){console.log("Ignoring action while delete confirmation is active.");return}if(de.classList.contains("is-editing"))return;const qe=de.dataset.id;if(qe){if(ke==="confirm-delete"){L.stopPropagation(),console.log(`History: Confirm Delete action clicked for ${qe}`);try{await th(qe),de.remove(),_--,Zt("Chat deleted successfully.","success"),tt.children.length===0&&_===0&&(tt.innerHTML='<div class="p-4 text-center text-gray-500 dark:text-gray-400">No chat history found</div>'),fe(0)}catch(ae){console.error(`Error deleting item ${qe}:`,ae),Zt(`Error deleting chat: ${ae.message}`,"error")}return}else if(ke==="cancel-delete"){L.stopPropagation(),console.log(`History: Cancel Delete action clicked for ${qe}`);const ae=de.querySelector(".actions");if(ae){const Qe=`
                    <button data-action="download-chat" class="action-button" title="Download">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 action-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </button>
                    <button data-action="share-chat" class="action-button" title="Share">
                        <img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">
                    </button>
                    <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${mh}</button>
                    <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${yi}</button>
                 `;ae.innerHTML=Qe}de.classList.remove("is-confirming-delete");return}else if(ke==="toggle-star"){L.stopPropagation(),console.log(`History: Toggling star for item ${qe}`);try{const ae=await eh(qe);de.classList.toggle("starred",ae.isStarred);const Qe=de.querySelector(".history-item-star-toggle");if(Qe){Qe.classList.toggle("starred",ae.isStarred),Qe.classList.toggle("unstarred",!ae.isStarred);const ct=Qe.querySelector("img");ct&&(ct.src=ae.isStarred?"icons/StarFilled.png":"icons/StarHollow.png")}Zt(ae.isStarred?"Chat starred.":"Chat unstarred.","success",2e3)}catch(ae){console.error("Star Toggle Error:",ae),Zt(`Error starring chat: ${ae.message}`,"error")}return}else if(ke==="delete-chat"){L.stopPropagation(),console.log(`History: Delete action clicked for ${qe}, showing inline confirmation.`);const ae=de.querySelector(".actions");ae&&(ae.innerHTML=`
                    <!-- Removed <span class='text-xs text-red-600 dark:text-red-400 mr-2 font-semibold flex-grow text-right'>Delete?</span> -->
                    <button data-action='confirm-delete' title="Confirm Delete" class='action-button p-1 rounded bg-red-100 hover:bg-red-200 dark:bg-red-800 dark:hover:bg-red-700 text-red-700 dark:text-red-200 ml-auto'> <!-- Added ml-auto -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </button>
                    <button data-action='cancel-delete' title="Cancel Delete" class='action-button p-1 rounded bg-gray-100 hover:bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 ml-1'>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                `),de.classList.add("is-confirming-delete");return}else if(ke==="share-chat"){L.stopPropagation(),console.log(`History: Share action clicked for ${qe}`),Zt("Share functionality coming soon!","info",2e3);return}else if(ke==="download-chat"){L.stopPropagation(),console.log(`History: Download action clicked for ${qe}`);const ae=X;try{const Qe=ae.querySelector("img"),ct=Qe?Qe.src:null;ae.innerHTML="...",ae.disabled=!0;const Je=await An(qe);if(!Je)throw new Error("Chat session not found.");const Ht=ah(Je),Yt=`${(Je.title||"Chat_Session").replace(/[^a-z0-9_\-\.]/gi,"_").replace(/_{2,}/g,"_")}_${qe.substring(0,8)}.html`;oh(Ht,Yt,or=>{Zt(or,"error"),ct?ae.innerHTML=`<img src="${ct}" alt="Download" class="w-4 h-4 action-icon-img">`:ae.innerHTML="↓",ae.disabled=!1})}catch(Qe){console.error(`Error preparing download for ${qe}:`,Qe),Zt(`Failed to prepare download: ${Qe.message}`,"error");const ct=ae.querySelector("img");if(ct&&ct.getAttribute("data-original-src"),ae){const Je=((wn=ae.querySelector("img"))==null?void 0:wn.getAttribute("src"))||"icons/download-icon-template.svg";ae.innerHTML=`<img src="${Je}" alt="Download" class="w-4 h-4 action-icon-img">`,ae.disabled=!1}}return}else if(ke==="preview-chat"){L.stopPropagation(),console.log(`History: Preview action clicked for ${qe}`);const ae=de.querySelector(".history-item-preview-content"),Qe=X;if(!ae||!Qe)return;if(!ae.classList.contains("hidden"))ae.classList.add("hidden"),ae.innerHTML="",de.classList.remove("preview-active"),Qe.innerHTML=yi;else{document.querySelectorAll(".history-item.preview-active").forEach(Je=>{const Ht=Je.querySelector(".history-item-preview-content"),bt=Je.querySelector('[data-action="preview-chat"]');Ht&&Ht.classList.add("hidden"),Je.classList.remove("preview-active"),bt&&(bt.innerHTML=yi)}),ae.innerHTML='<span class="text-gray-500">Loading preview...</span>',ae.classList.remove("hidden"),de.classList.add("preview-active"),Qe.innerHTML='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>';try{const Je=await An(qe);if(!Je||!Je.messages||Je.messages.length===0){ae.innerHTML='<span class="text-gray-500">No messages in this chat.</span>';return}const bt=Je.messages.slice(0,3).map(Yt=>{const or=Yt.sender==="user"?"You":Yt.sender==="ai"?"Agent":"System",ni=(Yt.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").substring(0,100)+(Yt.text.length>100?"...":"");return`<div class="preview-message"><span class="preview-sender">${or}:</span><span>${ni}</span></div>`}).join("");ae.innerHTML=bt}catch(Je){console.error("Preview error:",Je),ae.innerHTML='<span class="text-red-500">Error loading preview.</span>',Qe.innerHTML=yi}}return}}})});
