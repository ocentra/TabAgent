var $m=Object.defineProperty;var jl=e=>{throw TypeError(e)};var Am=(e,t,r)=>t in e?$m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var fa=(e,t,r)=>Am(e,typeof t!="symbol"?t+"":t,r),Kl=(e,t,r)=>t.has(e)||jl("Cannot "+r);var V=(e,t,r)=>(Kl(e,t,"read from private field"),r?r.call(e):t.get(e)),Ue=(e,t,r)=>t.has(e)?jl("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),je=(e,t,r,n)=>(Kl(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);import{e as j,D as ct,a as ei,b as Wr,c as qr,d as ti,f as lo,g as Xe,h as Bt,i as Pc,j as $c,k as Ac,l as Mc,m as Tc,n as Nc,o as qc,p as ri,q as Bc,r as $a,s as Fc,t as Aa,u as Uc,v as ni,w as jc,x as oi,y as Kc,z as Mm,A as Tm,B as Hc,C as Hl,E as zl,F as Wl,G as Vl,H as Ql,I as Qn,J as Gl,K as Yl,L as Jl,M as Xl}from"./assets/_commonjsHelpers-CcizWAex.js";const Nm="modulepreload",qm=function(e){return"/"+e},Zl={},yf=function(t,r,n){let o=Promise.resolve();if(r&&r.length>0){let c=function(p){return Promise.all(p.map(m=>Promise.resolve(m).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));o=c(r.map(p=>{if(p=qm(p),p in Zl)return;Zl[p]=!0;const m=p.endsWith(".css"),v=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${v}`))return;const b=document.createElement("link");if(b.rel=m?"stylesheet":Nm,m||(b.as="script"),b.crossOrigin="",b.href=p,d&&b.setAttribute("nonce",d),document.head.appendChild(b),m)return new Promise((_,I)=>{b.addEventListener("load",_),b.addEventListener("error",()=>I(new Error(`Unable to preload CSS for ${p}`)))})}))}function i(c){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=c,window.dispatchEvent(u),!u.defaultPrevented)throw c}return o.then(c=>{for(const u of c||[])u.status==="rejected"&&i(u.reason);return t().catch(i)})};let bf=[],zc=[],Ko=null;const ed={"page-home":"Tab Agent","page-spaces":"Spaces","page-library":"Library","page-settings":"Settings"};async function Ma(e){console.log(`Navigating to ${e}`),bf.forEach(o=>{o.classList.add("hidden"),o.classList.remove("active-page")});const t=document.getElementById(e);if(t)t.classList.remove("hidden"),t.classList.add("active-page");else{console.error(`Navigation error: Page with ID ${e} not found. Showing home.`);const o=document.getElementById("page-home");o&&(o.classList.remove("hidden"),o.classList.add("active-page")),e="page-home"}Ko&&ed[e]?Ko.textContent=ed[e]:Ko&&(Ko.textContent="Tab Agent"),zc.forEach(o=>{o.dataset.page===e?o.classList.add("active"):o.classList.remove("active")});const{eventBus:r}=await yf(async()=>{const{eventBus:o}=await import("./assets/_commonjsHelpers-CcizWAex.js").then(i=>i.N);return{eventBus:o}},[]);r.publish("navigation:pageChanged",{pageId:e}),console.log(`[Navigation] Published navigation:pageChanged event for ${e}`);const n=document.getElementById("query-input");e==="page-home"&&n&&n.focus()}function Bm(){console.log("Initializing navigation..."),bf=document.querySelectorAll(".page-container"),zc=document.querySelectorAll(".nav-button"),Ko=document.querySelector("#header h1"),zc.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page;t&&Ma(t)})}),Ma("page-home"),console.log("Navigation initialized.")}function $e(e,t="info",r=3e3){console.log(`[Notification] ${t.toUpperCase()}: ${e} (Duration: ${r}ms)`)}function ut(e){console.error("UI Error:",e);const t=document.createElement("div");t.style.position="fixed",t.style.bottom="10px",t.style.left="10px",t.style.backgroundColor="red",t.style.color="white",t.style.padding="10px",t.style.borderRadius="5px",t.style.zIndex="1000",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}function Iu(e,t){let r;return function(...o){const i=()=>{clearTimeout(r),e(...o)};clearTimeout(r),r=setTimeout(i,t)}}const Fm=/^(https?):\/\/[^\s/$.?#].[^\s]*$/i;function Wc(){return new Promise((e,t)=>{if(typeof chrome>"u"||!chrome.tabs)return console.warn("Utils: Chrome tabs API not available. Cannot get active tab."),e(null);chrome.tabs.query({active:!0,currentWindow:!0},r=>{if(chrome.runtime.lastError)return console.error("Utils: Error querying active tab:",chrome.runtime.lastError.message),e(null);r&&r.length>0?e(r[0]):e(null)})})}let Te=null,Jn=null,Vc=null,ha=null;const wf="temp-status-message";function Um(e,t){if(!e){console.error("[ChatRenderer] chatBody element is required for initialization.");return}if(!t){console.error("[ChatRenderer] requestDbAndWait function is required for initialization.");return}Te=e,Vc=t,console.log("[ChatRenderer] Initialized with chat body element and DB request function."),j.subscribe(ct.name,Hm),console.log("[ChatRenderer] Subscribed to DbMessagesUpdatedNotification."),j.subscribe(ei.name,zm),console.log("[ChatRenderer] Subscribed to DbSessionUpdatedNotification."),Vm()}function jm(e){console.log(`[ChatRenderer] Setting active session ID to: ${e}`),Jn=e,Te&&(Te.innerHTML=""),e?(console.log(`[ChatRenderer] Proactively loading messages for new session: ${e}`),Km(e)):Vo()}function Vo(){if(!Te)return;Te.innerHTML="";const e={messageId:"welcome-msg",sender:"system",text:"Welcome to Tab Agent! Ask me anything or paste a URL to scrape.",timestamp:Date.now(),isLoading:!1};Cu(e)}function ss(){Te&&requestAnimationFrame(()=>{Te.scrollTop=Te.scrollHeight})}async function Km(e){if(!Vc){console.error("[ChatRenderer] Cannot load messages: requestDbAndWait function not available."),Te&&(Te.innerHTML='<div class="p-4 text-red-500">Error: Cannot load chat messages.</div>');return}if(!e){console.warn("[ChatRenderer] loadAndRenderMessages called with null sessionId. Displaying welcome."),Vo();return}console.log(`[ChatRenderer] Requesting messages for session ${e}...`);try{const t=new Wr(e),r=await Vc(t);r&&r.messages?(console.log(`[ChatRenderer] Received ${r.messages.length} messages for ${e}. Rendering.`),Te&&(Te.innerHTML=""),r.messages.length===0?Vo():(r.messages.forEach(n=>Cu(n)),ss())):(console.warn(`[ChatRenderer] No messages found in session data for ${e}. Displaying welcome.`,r),Vo())}catch(t){console.error(`[ChatRenderer] Failed to load messages for session ${e}:`,t),ut(`Failed to load chat: ${t.message}`),Te&&(Te.innerHTML=`<div class="p-4 text-red-500">Failed to load chat: ${t.message}</div>`)}}function Hm(e){if(!(!e||!e.sessionId||!e.payload)&&e.sessionId===Jn){console.log(`[ChatRenderer] Received message update notification for active session ${Jn}. Rendering.`);let t=e.payload.messages;if(!Array.isArray(t))if(Array.isArray(e.payload))console.warn("[ChatRenderer] Payload did not have .messages, using payload directly as array."),t=e.payload;else{console.error("[ChatRenderer] Invalid messages structure: Expected array, got:",e.payload);return}if(console.log("[ChatRenderer] Messages array received:",JSON.stringify(t)),!Te)return;Te.innerHTML="",t.length===0?(console.log(`[ChatRenderer] Active session ${Jn} has no messages. Displaying welcome.`),Vo()):(t.forEach(r=>Cu(r)),ss())}}function zm(e){var t;if(!(!e||!e.sessionId||!((t=e.payload)!=null&&t.session))&&e.sessionId===Jn){const r=e.payload.session;console.log(`[ChatRenderer] Received metadata update for active session ${Jn}. New Title: ${r.title}, Starred: ${r.isStarred}`),Wm(r)}}function Wm(e){console.log(e?`[ChatRenderer] Updating chat header for ${e.id}. Title: ${e.title}, Starred: ${e.isStarred}`:"[ChatRenderer] Clearing chat header (no active session).")}function Cu(e){var c,u,d,p;if(!Te)return;const t=document.createElement("div");t.classList.add("flex","mb-2"),t.id=e.messageId||`msg-fallback-${Date.now()}-${Math.random().toString(36).substring(2)}`;const r=document.createElement("div");r.classList.add("rounded-lg","break-words","relative","group","p-2","max-w-4xl");const n=document.createElement("div");n.className="copy-button-container absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity";const o=document.createElement("button");o.innerHTML='<svg class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>',o.className="copy-button p-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600",o.title="Copy text",o.onclick=m=>{m.stopPropagation();const v=r.querySelector("pre code")||r.querySelector(".prose")||r,b=(v==null?void 0:v.textContent)||"";navigator.clipboard.writeText(b).then(()=>$e("Copied!","success",1500)).catch(_=>{console.error("Failed to copy:",_),$e("Copy failed","error",1500)})},n.appendChild(o),r.appendChild(n);let i=null;if(((c=e.metadata)==null?void 0:c.type)==="scrape_result"){t.classList.add("justify-start"),r.classList.add("bg-gray-200","dark:bg-gray-600");const m=document.createElement("div");m.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),m.textContent=`Scraped (${e.metadata.method||"N/A"}): ${e.metadata.title||e.metadata.url||"Content"}`,r.appendChild(m);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-64","text-sm","prose","prose-sm","dark:prose-invert","whitespace-pre-wrap","mt-1"),v.textContent=e.text||"",r.appendChild(v)}else if(((u=e.metadata)==null?void 0:u.type)==="scrape_stage_result"){t.classList.add("justify-start"),r.classList.add("border","border-gray-300","dark:border-gray-600");const m=document.createElement("div");if(m.classList.add("text-xs","font-semibold","mb-1","pr-6"),e.metadata.success){r.classList.add("bg-gray-100","dark:bg-gray-700"),m.classList.add("text-gray-700","dark:text-gray-300"),m.textContent=`[Stage ${e.metadata.stage} - ${e.metadata.method||"?"} - OK] Len: ${e.metadata.length||0}`,r.appendChild(m);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-64","mt-1");const b=document.createElement("pre");b.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),i=document.createElement("code"),i.className="language-json";const _={title:e.metadata.title||"N/A",links:e.metadata.links};i.textContent=JSON.stringify(_,null,2),b.appendChild(i),v.appendChild(b),r.appendChild(v)}else r.classList.add("bg-red-100","dark:bg-red-900"),m.classList.add("text-red-700","dark:text-red-300"),m.textContent=`[Stage ${e.metadata.stage} - Failed] ${e.metadata.error||"Unknown"}`,r.appendChild(m)}else if(((d=e.metadata)==null?void 0:d.type)==="scrape_result_full"){t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","border","border-gray-300","dark:border-gray-600");const m=document.createElement("div");m.classList.add("text-xs","font-semibold","mb-1","text-gray-700","dark:text-gray-300","pr-6"),m.textContent=`Full Scrape Result: ${((p=e.metadata.scrapeData)==null?void 0:p.title)||"No Title"}`,r.appendChild(m);const v=document.createElement("div");v.classList.add("overflow-y-auto","max-h-96","mt-1");const b=document.createElement("pre");b.classList.add("bg-gray-800","dark:bg-gray-900","rounded","p-2","text-xs"),i=document.createElement("code"),i.className="language-json";try{i.textContent=JSON.stringify(e.metadata.scrapeData||{error:"No scrape data found"},null,2)}catch(_){console.error("Error stringifying scrapeData:",_),i.textContent=JSON.stringify({error:"Failed to stringify scrape data",details:_.message},null,2)}b.appendChild(i),v.appendChild(b),r.appendChild(v)}else r.textContent=e.text||"",e.isLoading?(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-500","dark:text-gray-400","italic")):e.sender==="user"?(t.classList.add("justify-end"),r.classList.add("bg-blue-500/20","dark:bg-blue-600/40","text-gray-900","dark:text-gray-100")):e.sender==="error"?(t.classList.add("justify-start"),r.classList.add("bg-red-100","dark:bg-red-900","text-red-700","dark:text-red-300")):(t.classList.add("justify-start"),r.classList.add("bg-gray-100","dark:bg-gray-700","text-gray-900","dark:text-gray-100"));if(t.appendChild(r),Te.appendChild(t),i&&window.Prism)try{Prism.highlightElement(i)}catch(m){console.warn("Prism highlighting failed:",m)}}function Gn(e,t){if(!Te)return;e!=="system"&&console.log(`[ChatRenderer] Rendering temporary message (${e}): ${t}`);const r=document.createElement("div");r.classList.add("message",`message-${e}`,wf),r.style.padding="8px 12px",r.style.borderRadius="8px",r.style.marginBottom="10px",r.style.maxWidth="90%",r.style.alignSelf="center",r.style.backgroundColor=e==="error"?"#fee2e2":e==="success"?"#dcfce7":"#f3f4f6",r.style.color=e==="error"?"#b91c1c":e==="success"?"#166534":"#374151",document.documentElement.classList.contains("dark")&&(r.style.backgroundColor=e==="error"?"#450a0a":e==="success"?"#14532d":"#374151",r.style.color=e==="error"?"#fca5a5":e==="success"?"#bbf7d0":"#d1d5db"),r.textContent=t,Te.appendChild(r),ss()}function ii(){if(!Te)return;console.log("[ChatRenderer] Clearing temporary status messages."),Te.querySelectorAll(`.${wf}`).forEach(t=>t.remove())}function Vm(){ha&&ha.disconnect(),ha=new MutationObserver(e=>{e.forEach(t=>{t.type==="childList"&&t.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="PRE"){const n=r.querySelector('code[class*="language-"]');n&&window.Prism&&Prism.highlightElement(n)}else r.nodeType===Node.ELEMENT_NODE&&r.querySelectorAll('pre code[class*="language-"]').forEach(o=>{o.classList.contains("prism-highlighted")||(window.Prism&&Prism.highlightElement(o),o.classList.add("prism-highlighted"))})})})}),Te?(ha.observe(Te,{childList:!0,subtree:!0}),console.log("[ChatRenderer] MutationObserver initialized and observing chat body.")):console.error("[ChatRenderer] Cannot initialize MutationObserver: chatBody is null.")}let de,tt,Ta,dr,_n,Ke,Ft=!1,Qc=null,_f=null;const Gc={"Xenova/Qwen1.5-1.8B-Chat":"Qwen 1.8B Chat (Quantized)","Xenova/Phi-3-mini-4k-instruct":"Phi-3 Mini Instruct (Quantized)","HuggingFaceTB/SmolLM-1.7B-Instruct":"SmolLM 1.7B Instruct","HuggingFaceTB/SmolLM2-1.7B":"SmolLM2 1.7B","google/gemma-3-4b-it-qat-q4_0-gguf":"Gemma 3 4B IT Q4 (GGUF)","bubblspace/Bubbl-P4-multimodal-instruct":"Bubbl-P4 Instruct (Multimodal)","microsoft/Phi-4-multimodal-instruct":"Phi-4 Instruct (Multimodal)","microsoft/Phi-4-mini-instruct":"Phi-4 Mini Instruct","Qwen/Qwen3-4B":"Qwen/Qwen3-4B","google/gemma-3-1b-pt":"google/gemma-3-1b-pt","HuggingFaceTB/SmolLM2-360M":"HuggingFaceTB/SmolLM2-360M"};function Qm(){return de=document.getElementById("query-input"),tt=document.getElementById("send-button"),Ta=document.getElementById("chat-body"),dr=document.getElementById("attach-button"),_n=document.getElementById("file-input"),document.getElementById("loading-indicator"),!de||!tt||!Ta||!dr||!_n?(console.error("UIController: One or more essential elements not found (excluding session list)!"),!1):!0}function Gm(){de==null||de.addEventListener("input",_o),de==null||de.addEventListener("keydown",Sf),tt==null||tt.addEventListener("click",If),dr==null||dr.addEventListener("click",Cf)}function Ym(){de==null||de.removeEventListener("input",_o),de==null||de.removeEventListener("keydown",Sf),tt==null||tt.removeEventListener("click",If),dr==null||dr.removeEventListener("click",Cf)}function Sf(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const t=Du();t&&!de.disabled?(console.log("[UIController] Enter key pressed. Publishing ui:querySubmitted"),j.publish("ui:querySubmitted",{text:t}),cs()):console.log("[UIController] Enter key pressed, but input is empty or disabled.")}}function If(){const e=Du();e&&!de.disabled?(console.log("[UIController] Send button clicked. Publishing ui:querySubmitted"),j.publish("ui:querySubmitted",{text:e}),cs()):console.log("[UIController] Send button clicked, but input is empty or disabled.")}function Cf(){Qc&&Qc()}function _o(){if(!de)return;de.style.height="auto";const e=150,t=de.scrollHeight;de.style.height=`${Math.min(t,e)}px`,tt&&(tt.disabled=de.value.trim()===""||de.disabled)}function Eu(e){if(console.log(`[UIController] setInputStateInternal called with status: ${e}`),!(!Ft||!de||!tt)){switch(e){case"processing":de.disabled=!0,tt.disabled=!0;break;case"error":case"idle":case"complete":default:de.disabled=!1,_o();break}console.log(`[UIController] Input disabled state: ${de.disabled}`)}}function td(e){!Ft||!e||!e.sessionId||!e.payload||e.sessionId===_f&&Eu(e.payload.status||"idle")}function rd(e){if(!Ft||!e)return;console.warn("[UIController] Model load progress bar not found.");const{status:t,file:r,progress:n,model:o}=e;let i=t;t==="progress"?(i=`Downloading ${r}... ${Math.round(n)}%`,Gn("system",i),Br("loading",`Down: ${Math.round(n)}%`)):t==="download"||t==="ready"?(i=`Loading ${r}...`,Gn("system",i),Br("loading",`Loading ${r}`)):t==="done"?(i=`${r} loaded. Preparing pipeline...`,Gn("system",i),Br("loading","Preparing...")):(Gn("system",i),Br("loading",t))}async function Ef(e){if(console.log("[UIController] Initializing..."),Ft&&(console.warn("[UIController] Already initialized. Removing old listeners and subscriptions."),Ym(),j.unsubscribe(qr.name,td),j.unsubscribe("ui:loadingStatusUpdate",rd)),!Qm())return Ft=!1,null;Qc=e==null?void 0:e.onAttachFile,Gm();const t=document.getElementById("new-chat-button");t&&(e!=null&&e.onNewChat)&&t.addEventListener("click",e.onNewChat),j.subscribe(qr.name,td),j.subscribe("ui:loadingStatusUpdate",rd),console.log("[UIController] Subscribed to DB Status & Loading Status notifications."),Ft=!0,Eu("idle"),_o(),console.log("[UIController] Initialized successfully."),console.log(`[UIController] Returning elements: chatBody is ${Ta?"found":"NULL"}, fileInput is ${_n?"found":"NULL"}`),ii(),Ke=document.getElementById("load-model-button"),Ke?Ke.addEventListener("click",Zm):console.error("[UIController] Load Model button not found!"),xu("Model not loaded. Click 'Load'."),Br("idle"),console.log("[UIController] Initializing UI elements..."),console.log("[UIController] Attempting to find model selector...");const r=document.getElementById("model-selector");if(console.log(r?"[UIController] Model selector found.":"[UIController] WARNING: Model selector NOT found!"),r){r.innerHTML="",console.log("[UIController] Populating model selector. Available models:",Gc);for(const[n,o]of Object.entries(Gc)){console.log(`[UIController] Adding option: ${o} (${n})`);const i=document.createElement("option");i.value=n,i.textContent=o,r.appendChild(i)}}else console.warn("[UIController] Model selector dropdown not found.");return console.log("[UIController] UI Initialization complete."),{chatBody:Ta,queryInput:de,sendButton:tt,attachButton:dr,fileInput:_n}}function Df(e){console.log(`[UIController] Setting active session for UI state: ${e}`),_f=e,e||Eu("idle")}function Jm(){return Ft}function Du(){return(de==null?void 0:de.value.trim())||""}function cs(){console.log("[UIController] Entering clearInput function."),de&&(de.value="",_o())}function xf(){de==null||de.focus()}function Xm(){_n==null||_n.click()}function Zm(){if(!Ft)return;console.log("[UIController] Load Model button clicked.");const e=document.getElementById("model-selector"),t=e==null?void 0:e.value;if(!t){console.error("[UIController] Cannot load: No model selected or selector not found."),showNotification("Error: Please select a model.","error");return}console.log(`[UIController] Requesting load for model: ${t}`),Br("loading"),xu(`Loading ${Gc[t]||t}...`),j.publish("ui:requestModelLoad",{modelId:t})}function Br(e,t="Load"){if(!(!Ft||!Ke))switch(e){case"idle":Ke.disabled=!1,Ke.textContent=t,Ke.classList.replace("bg-yellow-500","bg-green-500"),Ke.classList.replace("bg-gray-500","bg-green-500");break;case"loading":Ke.disabled=!0,Ke.textContent=t==="Load"?"Loading...":t,Ke.classList.replace("bg-green-500","bg-yellow-500"),Ke.classList.replace("bg-gray-500","bg-yellow-500");break;case"loaded":Ke.disabled=!0,Ke.textContent="Loaded",Ke.classList.replace("bg-green-500","bg-gray-500"),Ke.classList.replace("bg-yellow-500","bg-gray-500");break;case"error":Ke.disabled=!1,Ke.textContent="Load Failed",Ke.classList.replace("bg-yellow-500","bg-red-500"),Ke.classList.replace("bg-green-500","bg-red-500"),Ke.classList.replace("bg-gray-500","bg-red-500");break}}function xu(e="Processing..."){!Ft||!de||!tt||(de.disabled=!0,de.placeholder=e,tt.disabled=!0)}function eg(){!Ft||!de||!tt||(de.disabled=!1,de.placeholder="Ask Tab Agent...",tt.disabled=de.value.trim()==="")}j.subscribe("worker:ready",e=>{console.log("[UIController] Received worker:ready signal",e),ii(),Gn("success",`Model ${(e==null?void 0:e.model)||""} ready.`),eg(),Br("loaded")});j.subscribe("worker:error",e=>{console.error("[UIController] Received worker:error signal",e),ii(),Gn("error",`Model load failed: ${e}`),Br("error"),xu("Model load failed. Check logs.")});const tg=Object.freeze(Object.defineProperty({__proto__:null,adjustTextareaHeight:_o,checkInitialized:Jm,clearInput:cs,focusInput:xf,getInputValue:Du,initializeUI:Ef,setActiveSession:Df,triggerFileInputClick:Xm},Symbol.toStringTag,{value:"Module"}));let Na=null,qa=null,Yc=null,qt=!1;const sc=new Map;function Oe(e,t=5e3){return new Promise((r,n)=>{const{requestId:o,type:i}=e,c=p=>{p&&p.requestId===o&&(console.log(`[Orchestrator] Received DB response for ${i} (Req ID: ${o})`),console.log(`[Orchestrator] RAW Received Response Event Object (Req ID: ${o}):`,JSON.stringify(p)),j.unsubscribe(d,c),sc.delete(o),clearTimeout(u),p.success?r(p.data):n(new Error(p.error||`DB operation ${i} failed`)))},u=setTimeout(()=>{console.error(`[Orchestrator] DB request timed out for ${i} (Req ID: ${o})`),j.unsubscribe(d,c),sc.delete(o),n(new Error(`DB request timed out for ${i}`))},t);let d;if(i===ti.name)d=Pc.name;else if(i===lo.name)d=$c.name;else if(i===Wr.name)d=Ac.name;else if(i===Bt.name)d=Mc.name;else if(i===Tc.name)d=Nc.name;else if(i===Xe.name)d=qc.name;else if(i===ri.name)d=Bc.name;else if(i===$a.name)d=Fc.name;else if(i===Aa.name)d=Uc.name;else if(i===ni.name)d=jc.name;else if(i===oi.name)d=Kc.name;else if(console.error(`[Orchestrator] Unknown request type for response mapping: ${i}`),d=i.replace("Request","Response"),d===i){n(new Error(`Cannot determine response event type for request: ${i}`));return}console.log(`[Orchestrator] Subscribing responseHandler for ReqID ${o} to event type: ${d}`),j.subscribe(d,c),sc.set(o,{handler:c,timeoutId:u}),j.publish(e.type,e)})}function rg(e){if(Na=e.getActiveSessionIdFunc,qa=e.onSessionCreatedCallback,Yc=e.getCurrentTabIdFunc,!Na||!qa||!Yc){console.error("Orchestrator: Missing one or more dependencies during initialization!");return}console.log("[Orchestrator] Initializing and subscribing to application events..."),j.subscribe("ui:querySubmitted",ng),j.subscribe("background:responseReceived",og),j.subscribe("background:errorReceived",ig),j.subscribe("background:scrapeStageResult",ag),j.subscribe("background:scrapeResultReceived",sg),console.log("[Orchestrator] Event subscriptions complete.")}async function ng(e){const{text:t}=e;if(console.log(`Orchestrator: handleQuerySubmit received event with text: "${t}"`),qt){console.warn("Orchestrator: Already processing a previous submission.");return}qt=!0;let r=Na();const n=Yc();let o=null;console.log(`Orchestrator: Processing submission. Text: "${t}". Session: ${r}`);const i=Fm.test(t);try{ii();const c={sender:"user",text:t,timestamp:Date.now(),isLoading:!1};if(r){console.log(`Orchestrator: Adding user message to existing session ${r} via event.`),ii();const v=new lo(r,c);await Oe(v)}else{console.log("Orchestrator: No active session, creating new one via event.");const v=new ti(c);if(r=(await Oe(v)).newSessionId,qa)qa(r);else throw console.error("Orchestrator: onSessionCreatedCallback is missing!"),new Error("Configuration error: Cannot notify about new session.")}console.log(`[Orchestrator] Setting session ${r} status to 'processing' via event`);const u=new Xe(r,"processing");await Oe(u);let d;if(i){const v=await Wc(),b=v==null?void 0:v.url,_=q=>q?q.replace("/$",""):null,I=_(t),k=_(b);d={sender:"system",text:v&&v.id&&I===k?`â³ Scraping active tab: ${t}...`:`â³ Scraping ${t}...`,timestamp:Date.now(),isLoading:!0}}else d={sender:"ai",text:"Thinking...",timestamp:Date.now(),isLoading:!0};console.log(`[Orchestrator] Adding placeholder to session ${r} via event.`);const p=new lo(r,d);if(o=(await Oe(p)).newMessageId,i){const v=await Wc(),b=v==null?void 0:v.url,_=A=>A?A.replace("/$",""):null,I=_(t),k=_(b);v&&v.id&&I===k?(console.log("Orchestrator: Triggering content script scrape."),chrome.tabs.sendMessage(v.id,{type:"SCRAPE_ACTIVE_TAB"},A=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending SCRAPE_ACTIVE_TAB:",chrome.runtime.lastError.message);const q=new Bt(r,o,{isLoading:!1,sender:"error",text:`Failed to send scrape request: ${chrome.runtime.lastError.message}`});Oe(q).catch(U=>console.error("Failed to update placeholder on send error:",U)),Oe(new Xe(r,"error")).catch(U=>console.error("Failed to set session status on send error:",U)),qt=!1}else console.log("Orchestrator: SCRAPE_ACTIVE_TAB message sent.")})):(console.log("Orchestrator: Triggering background scrape."),chrome.runtime.sendMessage({type:"TEMP_SCRAPE_URL",url:t,tabId:n,chatId:r,messageId:o},A=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending TEMP_SCRAPE_URL:",chrome.runtime.lastError.message);const q=new Bt(r,o,{isLoading:!1,sender:"error",text:`Failed to initiate scrape: ${chrome.runtime.lastError.message}`});Oe(q).catch(U=>console.error("Failed to update placeholder on send error:",U)),Oe(new Xe(r,"error")).catch(U=>console.error("Failed to set session status on send error:",U)),qt=!1}else console.log("Orchestrator: TEMP_SCRAPE_URL message sent successfully.")}))}else{const v={type:"query",tabId:n,text:t,chatId:r,messageId:o};console.log("Orchestrator: Sending query to background:",v),chrome.runtime.sendMessage(v,b=>{if(chrome.runtime.lastError){console.error("Orchestrator: Error sending query:",chrome.runtime.lastError.message);const _={isLoading:!1,sender:"error",text:`Failed to send query: ${chrome.runtime.lastError.message}`},I=new Bt(r,o,_);Oe(I).catch(k=>console.error("Failed to update placeholder on send error:",k)),Oe(new Xe(r,"error")).catch(k=>console.error("Failed to set session status on send error:",k)),qt=!1}else{console.log("Orchestrator: Received direct response from background for query:",b);let _={},I="idle";b&&b.success?(_={isLoading:!1,sender:"ai",text:b.data||"Received empty successful response."},I="idle"):(_={isLoading:!1,sender:"error",text:`Error: ${(b==null?void 0:b.error)||"Unknown error from background."}`},I="error",console.error("Orchestrator: Background query processing failed:",b==null?void 0:b.error));const k=new Bt(r,o,_);Oe(k).then(()=>(console.log(`[Orchestrator] Setting session ${r} status to '${I}' after query response via event`),Oe(new Xe(r,I)))).catch(A=>{console.error("Failed to update placeholder/status after query response:",A),Oe(new Xe(r,"error")).catch(q=>console.error("Failed to set fallback error status:",q))}).finally(()=>{qt=!1})}})}}catch(c){console.error("Orchestrator: Error processing query submission:",c),ut(`Error: ${c.message||c}`),r?(console.log(`[Orchestrator] Setting session ${r} status to 'error' due to processing failure via event`),Oe(new Xe(r,"error")).catch(u=>console.error("Failed to set session status on processing error:",u))):console.error("Orchestrator: Error occurred before session ID was established."),qt=!1}}async function og(e){const{chatId:t,messageId:r,text:n}=e;console.log(`Orchestrator: handleBackgroundMsgResponse for chat ${t}, placeholder ${r}`);try{const o={isLoading:!1,sender:"ai",text:n||"Received empty response."},i=new Bt(t,r,o);await Oe(i),console.log(`[Orchestrator] Setting session ${t} status to 'idle' after response via event`);const c=new Xe(t,"idle");await Oe(c)}catch(o){console.error(`Orchestrator: Error handling background response for chat ${t}:`,o),ut(`Failed to update chat with response: ${o.message||o}`);const i=new Xe(t,"error");Oe(i).catch(c=>console.error("Failed to set session status on response processing error:",c))}finally{qt=!1}}async function ig(e){console.error(`Orchestrator: Received error for chat ${e.chatId}, placeholder ${e.messageId}: ${e.error}`),ut(`Error processing request: ${e.error}`);const t=Na();if(t&&e.chatId===t&&e.messageId){console.log(`Orchestrator: Attempting to update message ${e.messageId} in active session ${t} with error.`);const r={isLoading:!1,sender:"error",text:`Error: ${e.error}`},n=new Bt(t,e.messageId,r),o=new Xe(t,"error");try{await Oe(n),console.log(`Orchestrator: Error message update successful for session ${t}.`),await Oe(o),console.log(`Orchestrator: Session ${t} status set to 'error'.`)}catch(i){console.error("Orchestrator: Error updating chat/status on background error:",i),ut(`Failed to update chat with error status: ${i.message}`);try{await Oe(new Xe(t,"error"))}catch(c){console.error("Failed to set session status on error handling error:",c)}}}else console.warn(`Orchestrator: Received error, but no active session ID (${t}) or message ID (${e.messageId}) matches the error context (${e.chatId}). Not updating DB.`);qt=!1}async function ag(e){const{stage:t,success:r,chatId:n,messageId:o,error:i,...c}=e;console.log(`Orchestrator: handleBackgroundScrapeStage Stage ${t}, chatId: ${n}, Success: ${r}`);let u={},d="idle";if(r)console.log(`Orchestrator: Scrape stage ${t} succeeded for chat ${n}.`),u={isLoading:!1,sender:"system",text:`Full Scrape Result: ${c.title||"No Title"}`,metadata:{type:"scrape_result_full",scrapeData:c}},d="idle";else{const p=i||`Scraping failed (Stage ${t}). Unknown error.`;console.error(`Orchestrator: Scrape stage ${t} failed for chat ${n}. Error: ${p}`),u={isLoading:!1,sender:"error",text:`Scraping failed (Stage ${t}): ${p}`},d="error"}try{console.log(`Orchestrator: Updating message ${o} for stage ${t} result.`);const p=new Bt(n,o,u);await Oe(p),console.log(`Orchestrator: Updated placeholder ${o} with stage ${t} result.`),console.log(`[Orchestrator] Setting session ${n} status to '${d}' after stage ${t} result via event`);const m=new Xe(n,d);await Oe(m)}catch(p){if(console.error(`Orchestrator: Failed to update DB after stage ${t} result:`,p),ut(`Failed to update chat with scrape result: ${p.message||p}`),d!=="error")try{const m=new Xe(n,"error");await Oe(m)}catch(m){console.error("Failed to set fallback error status:",m)}}finally{qt=!1,console.log("Orchestrator: Resetting isSendingMessage after processing scrape stage result.")}}async function sg(e){const{chatId:t,messageId:r,success:n,error:o,...i}=e;console.log(`Orchestrator: handleBackgroundDirectScrapeResult for chat ${t}, placeholder ${r}, Success: ${n}`);const c={isLoading:!1};n?(c.sender="system",c.text=i.text||i.excerpt||"Scraped content (no text found).",c.metadata={type:"scrape_result",method:i.method||"unknown",url:i.url,title:i.title}):(c.sender="error",c.text=`Scraping failed: ${o||"Unknown error."}`);try{const u=new Bt(t,r,c);await Oe(u);const d=n?"idle":"error";console.log(`[Orchestrator] Setting session ${t} status to '${d}' after direct scrape result via event`);const p=new Xe(t,d);await Oe(p)}catch(u){console.error(`Orchestrator: Error handling direct scrape result for chat ${t}:`,u),ut(`Failed to update chat with direct scrape result: ${u.message||u}`);const d=new Xe(t,"error");Oe(d).catch(p=>console.error("Failed to set session status on direct scrape processing error:",p))}finally{qt=!1}}let Ba=null,Fa=null;function cg(e){Ba=e.getActiveSessionIdFunc,Fa=e.uiController,!Ba||!Fa?console.error("FileHandler: Missing getActiveSessionIdFunc or uiController dependency!"):console.log("[FileHandler] Initialized (Note: DB/Renderer interaction via events assumed).")}async function ug(e){if(!Ba){console.error("FileHandler: Not initialized properly (missing getActiveSessionIdFunc).");return}const t=e.target.files;if(!t||t.length===0){console.log("FileHandler: No file selected.");return}const r=t[0];console.log(`FileHandler: File selected - ${r.name}, Type: ${r.type}, Size: ${r.size}`);const n=Ba();if(!n){ut("Please start or select a chat before attaching a file."),e.target.value="";return}const o={sender:"system",text:`ðŸ“Ž Attached file: ${r.name}`,timestamp:Date.now(),isLoading:!1};try{const i=new DbAddMessageRequest(n,o);eventBus.publish(DbAddMessageRequest.name,i),console.log("[FileHandler] Published DbAddMessageRequest for file attachment.")}catch(i){console.error("FileHandler: Error publishing file attachment message event:",i),ut("Failed to process file attachment.")}finally{e.target.value=""}}function lg(){if(!Fa){console.error("FileHandler: UI Controller not available to trigger file input.");return}console.log("FileHandler: Triggering file input click."),Fa.triggerFileInputClick()}const cc='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg>',dg='<svg class="w-4 h-4 action-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 17.8798 20.1818C17.1169 21 15.8356 21 13.2731 21H10.7269C8.16438 21 6.8831 21 6.12019 20.1818C5.35728 19.3671 5.27811 18.0864 5.11973 15.5251L4.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M3 5.5H21M16.5 5.5L16.1733 3.57923C16.0596 2.8469 15.9989 2.48073 15.8184 2.21449C15.638 1.94825 15.362 1.75019 15.039 1.67153C14.7158 1.59286 14.3501 1.59286 13.6186 1.59286H10.3814C9.64993 1.59286 9.28419 1.59286 8.96099 1.67153C8.63796 1.75019 8.36201 1.94825 8.18156 2.21449C8.00111 2.48073 7.9404 2.8469 7.82672 3.57923L7.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M14 10.5V15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',fg='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 action-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>',hg='<img src="icons/broken-link-chain-svgrepo-com.svg" alt="Share" class="w-4 h-4 action-icon-img">';function pg(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(e.classList.add("is-editing"),t.style.display="none",r.style.display="block",r.value=t.textContent,r.focus(),r.select())}function Uo(e){if(!e)return;const t=e.querySelector(".history-item-preview"),r=e.querySelector(".history-item-rename-input");!t||!r||(r.style.display="none",t.style.display="block",e.classList.remove("is-editing"))}function kf(e){const{entry:t,onStarClick:r=()=>{},onDownloadClick:n=()=>{},onDeleteClick:o=()=>{},onLoadClick:i=()=>{},onRenameSubmit:c=()=>{},onShareClick:u=()=>{},onPreviewClick:d=()=>{}}=e;if(!t||!t.id)return console.error("renderHistoryItemComponent: Invalid entry data provided",t),null;const p=document.createElement("div");p.className="history-item group relative mb-2",p.dataset.id=t.id,t.isStarred&&p.classList.add("starred");const v=new Date(t.timestamp).toLocaleString(),b=t.title||(t.messages&&t.messages.length>0?(t.messages[0].text||"").substring(0,50)+"...":"Empty chat"),_=t.isStarred?"icons/StarFilled.png":"icons/StarHollow.png",I=t.isStarred?"starred":"unstarred";p.innerHTML=`
        <div class="chat-card bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-3 flex flex-col justify-between min-h-[100px]">
            <div>
                <div class="card-header flex justify-between items-center mb-2">
                    <button data-action="toggle-star" class="action-button history-item-star-toggle ${I}" title="Toggle Star">
                         <img src="${_}" alt="Star" class="w-4 h-4 action-icon-img ${t.isStarred?"":"icon-unstarred"}">
                    </button>
                    <div class="actions flex items-center space-x-1">
                        <!-- Normal Actions (initially visible) -->
                        <div class="normal-actions flex items-center space-x-1" data-normal-container>
                             <button data-action="download-chat" class="action-button" title="Download">${fg}</button>
                             <button data-action="share-chat" class="action-button" title="Share">${hg}</button>
                             <button data-action="delete-chat" class="action-button text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" title="Delete">${dg}</button>
                             <button data-action="preview-chat" class="action-button history-item-preview-btn" title="Preview">${cc}</button>
                        </div>
                        <!-- Confirm Delete Actions (initially hidden) -->
                        <div class="confirm-delete-actions hidden flex items-center space-x-1" data-confirm-container>
                            <span class="text-xs text-red-600 dark:text-red-400 mr-1">Confirm?</span>
                            <button data-action="confirm-delete" class="action-button text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300" title="Confirm Delete">
                                <svg class="w-4 h-4 action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> <!-- Checkmark -->
                            </button>
                            <button data-action="cancel-delete" class="action-button text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" title="Cancel Delete">
                                <svg class="w-4 h-4 action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> <!-- X mark -->
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body mb-1">
                    <div class="history-item-preview font-semibold text-sm truncate" title="${b}">${b}</div>
                    <input type="text" class="history-item-rename-input w-full text-sm p-1 border rounded" value="${b}" style="display: none;"/>
                </div>
                <div class="history-item-preview-content hidden mt-2 p-2 border-t border-gray-200 dark:border-gray-600 text-xs max-h-24 overflow-y-auto">
                     <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="card-footer mt-auto flex justify-between items-center">
                 <span class="history-item-date text-xs text-gray-500 dark:text-gray-400">${v}</span>
                 <button class="history-item-load-btn text-xs p-0.5 rounded" data-action="load-chat" title="Load Chat">
                    <img src="icons/Load.png" alt="Load" class="h-6 w-auto">
                 </button>
            </div>
        </div>
    `;const k=p.querySelector(".history-item-preview"),A=p.querySelector(".history-item-rename-input");k&&A&&(k.addEventListener("dblclick",X=>{X.stopPropagation(),pg(p)}),A.addEventListener("blur",()=>{const X=A.value.trim(),we=k.textContent;X&&X!==we&&(c(t.id,X),k.textContent=X,k.title=X),Uo(p)}),A.addEventListener("keydown",X=>{if(X.key==="Enter"){X.preventDefault();const we=A.value.trim(),De=k.textContent;we&&we!==De?c(t.id,we):Uo(p)}else X.key==="Escape"&&(X.preventDefault(),Uo(p))}));const q=p.querySelector('[data-action="toggle-star"]');q&&q.addEventListener("click",X=>{X.stopPropagation(),r(t.id)});const U=p.querySelector('[data-action="download-chat"]');U&&U.addEventListener("click",X=>{X.stopPropagation(),n(t.id)});const G=p.querySelector('[data-action="share-chat"]');G&&G.addEventListener("click",X=>{X.stopPropagation(),u(t.id)});const ae=p.querySelector('[data-action="delete-chat"]'),oe=p.querySelector("[data-normal-container]"),te=p.querySelector("[data-confirm-container]"),Z=p.querySelector('[data-action="confirm-delete"]'),ce=p.querySelector('[data-action="cancel-delete"]');ae&&oe&&te&&ae.addEventListener("click",X=>{X.stopPropagation(),p.classList.contains("is-editing")&&Uo(p),p.classList.add("is-confirming-delete"),oe.classList.add("hidden"),te.classList.remove("hidden")}),ce&&oe&&te&&ce.addEventListener("click",X=>{X.stopPropagation(),p.classList.remove("is-confirming-delete"),oe.classList.remove("hidden"),te.classList.add("hidden")}),Z&&oe&&te&&Z.addEventListener("click",X=>{X.stopPropagation(),p.classList.remove("is-confirming-delete"),o(t.id,p)});const he=p.querySelector('[data-action="preview-chat"]'),Ee=p.querySelector(".history-item-preview-content");he&&Ee&&he.addEventListener("click",X=>{X.stopPropagation(),!Ee.classList.contains("hidden")?(Ee.classList.add("hidden"),Ee.innerHTML="",p.classList.remove("preview-active"),he.innerHTML=cc,console.log(`HistoryItem: Hiding preview for ${t.id}`)):(document.querySelectorAll(".history-item.preview-active").forEach(De=>{if(De!==p){const Re=De.querySelector(".history-item-preview-content"),rt=De.querySelector('[data-action="preview-chat"]');Re&&(Re.classList.add("hidden"),Re.innerHTML=""),De.classList.remove("preview-active"),rt&&(rt.innerHTML=cc)}}),p.classList.add("preview-active"),he.innerHTML='<svg class="w-4 h-4 action-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>',Ee.classList.remove("hidden"),console.log(`HistoryItem: Requesting preview for ${t.id}`),d(t.id,Ee))});const Le=p.querySelector('[data-action="load-chat"]');return Le&&Le.addEventListener("click",X=>{X.stopPropagation(),i(t.id)}),p.querySelector(".card-body"),p}function mg(e){if(!e)return"";const t=e.title||"Chat Session",r=(e.messages||[]).map(o=>{const i=o.sender==="user"?"user-message":"other-message",c=o.sender==="user"?"You":o.sender==="ai"?"Agent":"System",d=o.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return`
            <div class="message-row ${i==="user-message"?"row-user":"row-other"}">
                <div class="message-bubble ${i}">
                    <span class="sender-label">${c}:</span>
                    <div class="message-text">${d}</div>
                </div>
            </div>
        `}).join(`
`);return`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</title>
            <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 800px; margin: 20px auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-top: 0; }
        .chat-body { margin-top: 20px; }
        .message-row { margin-bottom: 15px; overflow: hidden; /* Clear floats */ }
        .row-user { text-align: right; }
        .row-other { text-align: left; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; max-width: 75%; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; /* Align right */ }
        .other-message { background-color: #e9ecef; color: #343a40; margin-right: auto; /* Align left */ }
        .sender-label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em; color: inherit; }
        .message-text { margin-top: 5px; }
    </style>
        </head>
        <body>
            <div class="container">
                <h1>${t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</h1>
                <div class="chat-body">
                    ${r}
                </div>
            </div>
        </body>
        </html>
    `}function gg(e,t,r){try{const n=new Blob([e],{type:"text/html"}),o=URL.createObjectURL(n);console.log(`Initiating download for: ${t} (prompting user)`),chrome.downloads.download({url:o,filename:t,saveAs:!0},i=>{const c=chrome.runtime.lastError;if(setTimeout(()=>URL.revokeObjectURL(o),100),c){const u=c.message;console.error("Download API error:",u),!u||!u.toLowerCase().includes("cancel")?r?r(`Download failed: ${u||"Unknown error"}`):(console.error("No error handler provided for download failure."),alert(`Download failed: ${u||"Unknown error"}. Ensure extension has permissions.`)):console.log("Download cancelled by user.")}else console.log(i?`Download initiated (or dialog opened) with ID: ${i}`:"Download cancelled by user (no downloadId assigned).")})}catch(n){console.error("Error creating blob or initiating download:",n),r?r("An error occurred while preparing the download."):(console.error("No error handler provided for download preparation error."),alert("An error occurred while preparing the download."))}}async function Rf(e,t,r){if(!e||!t||!r){console.error("[initiateChatDownload] Failed: Missing sessionId, requestDbAndWaitFunc, or showNotificationFunc."),r&&r("Download failed due to internal error.","error");return}console.log(`[initiateChatDownload] Preparing download for: ${e}`),r("Preparing download...","info");try{const n=await t(new Wr(e));if(!n)throw new Error("Chat session data not found.");const o=mg(n),c=`${(n.title||n.name||"Chat_Session").replace(/[^a-z0-9_\-\.]/gi,"_").replace(/_{2,}/g,"_")}_${e.substring(0,8)}.html`;gg(o,c,u=>{r(u,"error")})}catch(n){console.error(`[initiateChatDownload] Error preparing download for ${e}:`,n),r(`Failed to prepare download: ${n.message}`,"error")}}let xn=!1,jr=null,hn=null,nd=null,od=null,bt=null,lr=[],Kn="";function vg(e){if(!xn||!e||!e.sessionId||!e.payload){console.warn("[HistoryPopupController] Invalid session update notification received.",e);return}const t=e.payload.session,r=e.sessionId,n=e.payload.updateType||"update";if(!t){console.warn(`[HistoryPopupController] Session update notification for ${r} missing session data.`,e);return}console.log(`[HistoryPopupController] Received session update for ${r}. Type: ${n}, New starred: ${t.isStarred}`);const o=lr.findIndex(c=>c.id===r);let i=!1;n==="delete"?o!==-1&&(console.log(`[HistoryPopupController] Removing deleted session ${r} from local list.`),lr.splice(o,1),i=!0):o!==-1?(console.log(`[HistoryPopupController] Updating session ${r} in local list.`),lr[o]={...lr[o],...t},i=!0):(console.log(`[HistoryPopupController] Adding new/updated session ${r} to local list.`),lr.push(t),i=!0),i&&jr&&!jr.classList.contains("hidden")?(console.log("[HistoryPopupController] Popup visible and list changed, calling renderHistoryList()"),ku()):console.log("[HistoryPopupController] Popup not visible or list unchanged, skipping renderHistoryList()")}function ku(){if(!xn||!hn)return;console.log(`[HistoryPopupController] Rendering history list (Search: "${Kn}")...`);let e=lr;if(Kn){const t=Kn.toLowerCase();e=lr.filter(r=>(r.name||"").toLowerCase().includes(t)),console.log(`[HistoryPopupController] Filtered down to ${e.length} sessions.`)}else console.log(`[HistoryPopupController] Rendering all ${e.length} sessions (no search term).`);if(hn.innerHTML="",e.length===0){const t=Kn?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No history items match "${Kn}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No chat history yet.</p>';hn.innerHTML=t}else e.forEach(t=>{const r={entry:{id:t.id,name:t.title,title:t.title,timestamp:t.timestamp,isStarred:t.isStarred,messages:[]},onLoadClick:wg,onStarClick:_g,onDeleteClick:Sg,onRenameSubmit:Ig,onDownloadClick:Cg,onShareClick:Eg,onPreviewClick:Dg},n=kf(r);n&&hn.appendChild(n)});console.log("[HistoryPopupController] History list rendered.")}async function yg(){if(!(!xn||!jr||!bt)){console.log("[HistoryPopupController] Showing popup. Fetching latest history...");try{lr=await bt(new $a)||[],console.log(`[HistoryPopupController] Fetched ${lr.length} sessions.`),ku(),jr.classList.remove("hidden")}catch(e){console.error("[HistoryPopupController] Error fetching history list:",e),$e("Failed to load history.","error"),hn&&(hn.innerHTML='<p class="p-4 text-center text-red-500 dark:text-red-400">Error loading history. Please try again.</p>'),jr.classList.remove("hidden")}}}function Jc(){!xn||!jr||(console.log("[HistoryPopupController] Hiding popup."),jr.classList.add("hidden"))}function bg(e){xn&&(Kn=e.target.value.trim(),ku())}async function wg(e){if(console.log(`[HistoryPopupController] Load clicked: ${e}`),!!e)try{await chrome.storage.local.set({lastSessionId:e}),Ma("page-home"),Jc()}catch(t){console.error("[HistoryPopupController] Error setting storage or navigating:",t),$e("Failed to load chat.","error")}}async function _g(e){if(!(!e||!bt)){console.log(`[HistoryPopupController] Star clicked: ${e}`);try{await bt(new ri(e)),$e("Star toggled","success")}catch(t){console.error("[HistoryPopupController] Error toggling star:",t),$e(`Failed to toggle star: ${t.message}`,"error")}}}async function Sg(e,t){var o;if(!e||!t||!bt)return;console.log(`[HistoryPopupController] Delete confirmed inline for: ${e}. Applying deleting state.`),t.classList.add("is-deleting"),t.querySelectorAll("button").forEach(i=>i.disabled=!0);const r=t.querySelector(".card-footer"),n=r==null?void 0:r.querySelector(".deleting-message");if(r&&!n){const i=document.createElement("span");i.textContent="Deleting...",i.className="text-xs text-red-500 ml-2 deleting-message",r.appendChild(i)}try{await bt(new ni(e)),$e("Chat deletion initiated...","info")}catch(i){console.error("[HistoryPopupController] Error deleting chat:",i),$e(`Failed to delete chat: ${i.message}`,"error"),t.classList.remove("is-deleting"),t.querySelectorAll("button").forEach(d=>d.disabled=!1),(o=r==null?void 0:r.querySelector(".deleting-message"))==null||o.remove();const c=t.querySelector("[data-normal-container]");c&&c.classList.remove("hidden");const u=t.querySelector("[data-confirm-container]");u&&u.classList.add("hidden")}}async function Ig(e,t){if(!(!e||!t||!bt)){console.log(`[HistoryPopupController] Rename submitted: ${e} to "${t}"`);try{await bt(new oi(e,t)),$e("Rename successful","success")}catch(r){console.error("[HistoryPopupController] Error submitting rename:",r),$e(`Failed to rename chat: ${r.message}`,"error")}}}async function Cg(e){bt?Rf(e,bt,$e):(console.error("[HistoryPopupController] Cannot download: requestDbAndWaitFunc not available."),$e("Download failed: Internal setup error.","error"))}function Eg(e){}async function Dg(e,t){if(!e||!t||!bt){console.error("[HistoryPopupController] Preview failed: Missing sessionId, contentElement, or requestDbAndWaitFunc.");return}console.log(`[HistoryPopupController] Handling preview click for: ${e}`),t.innerHTML='<span class="text-gray-500 dark:text-gray-400 italic text-xs">Loading preview...</span>';try{const r=await bt(new Wr(e));if(!r||!r.messages||r.messages.length===0){t.innerHTML='<span class="text-gray-500 dark:text-gray-400 text-xs">No messages in this chat.</span>';return}const o=r.messages.slice(0,3).map(i=>{const c=i.sender==="user"?"You":i.sender==="ai"?"Agent":"System",u=(i.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").substring(0,100)+(i.text&&i.text.length>100?"...":"");return`<div class="preview-message mb-1 last:mb-0"><span class="font-medium">${c}:</span><span class="ml-1">${u}</span></div>`}).join("");t.innerHTML=o}catch(r){console.error(`[HistoryPopupController] Error fetching preview for ${e}:`,r),t.innerHTML=`<span class="text-red-500 text-xs">Error loading preview: ${r.message}</span>`}}function xg(e,t){if(console.log("[HistoryPopupController] Entering initializeHistoryPopup..."),!e||!e.popupContainer||!e.listContainer||!e.searchInput||!e.closeButton||!t)return console.error("[HistoryPopupController] Initialization failed: Missing required elements or request function.",{elements:e,requestFunc:t}),null;jr=e.popupContainer,hn=e.listContainer,nd=e.searchInput,od=e.closeButton,bt=t,console.log("[HistoryPopupController] Elements and request function assigned.");try{od.addEventListener("click",Jc);const r=Iu(bg,300);return nd.addEventListener("input",r),console.log("[HistoryPopupController] Event listeners attached."),j.subscribe(ei.name,vg),console.log("[HistoryPopupController] Subscribed to DbSessionUpdatedNotification for passive updates."),xn=!0,console.log("[HistoryPopupController] Initialization successful. History will be rendered when popup is shown."),{show:yg,hide:Jc}}catch(r){return console.error("[HistoryPopupController] Error during initialization listeners/subscriptions:",r),xn=!1,null}}function ai(e){"@babel/helpers - typeof";return ai=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ai(e)}function kg(e,t){if(ai(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t);if(ai(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function Rg(e){var t=kg(e,"string");return ai(t)=="symbol"?t:t+""}function Og(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Rg(n.key),n)}}function Gr(e,t,r){return t&&Og(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function Lg(e){return e[e.length-1]}function Ru(e){return Array.isArray(e)?e.slice(0):[e]}function Pg(e,t){e=e.slice(0);for(var r=[];e.length;){var n=e.splice(0,t);r.push(n)}return r}function Ua(e){return Array.isArray(e)}function uc(e,t){var r=0,n=-1;for(var o of e){n=n+1;var i=t(o,n);if(i)r=r+1;else break}return r}function kn(e,t){var r=t.length;if(r!==0){var n=e.length;e.length=n+t.length;for(var o=0;o<r;++o)e[n+o]=t[o]}}function $g(e){return e.filter(function(t,r,n){return n.indexOf(t)===r})}function Vr(e){for(var t="",r=0;r<e.length;r++){var n=e[r];if(n==="-")return parseInt(t,10);t+=n}throw new Error("malformatted revision: "+e)}function vr(e,t){var r=t?Vr(t._rev)+1:1;return r+"-"+e}function Ag(e){var t=e.split("."),r=t.length;return r===1?n=>n[e]:n=>{for(var o=n,i=0;i<r;++i){var c=t[i];if(o=o[c],typeof o>"u")return o}return o}}function Ne(e){return Object.assign({},e)}function Mg(e){return Object.keys(e)[0]}function ja(e,t=!1){if(!e)return e;if(!t&&Array.isArray(e))return e.sort((n,o)=>typeof n=="string"&&typeof o=="string"?n.localeCompare(o):typeof n=="object"?1:-1).map(n=>ja(n,t));if(typeof e=="object"&&!Array.isArray(e)){var r={};return Object.keys(e).sort((n,o)=>n.localeCompare(o)).forEach(n=>{r[n]=ja(e[n],t)}),r}return e}function Xc(e){if(!e||e===null||typeof e!="object")return e;if(Array.isArray(e)){for(var t=new Array(e.length),r=t.length;r--;)t[r]=Xc(e[r]);return t}var n={};for(var o in e)n[o]=Xc(e[o]);return n}var lt=Xc;function fr(e,t,r){return Object.defineProperty(e,t,{get:function(){return r}}),r}var Ou=1;function So(){return{lwt:Ou}}function jt(){return""}function Tg(e){return Object.assign({},e,{_meta:void 0,_deleted:void 0,_rev:void 0})}function Ng(e,t,r){if(t.length!==r.length)return!1;for(var n=0,o=t.length;n<o;){var i=t[n],c=r[n];if(n++,i._rev!==c._rev||i[e]!==c[e])return!1}return!0}async function qg(e){var t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t),n=Array.prototype.map.call(new Uint8Array(r),o=>("00"+o.toString(16)).slice(-2)).join("");return n}var Of=qg;function Bg(){return new Promise(e=>setTimeout(e,0))}function Fg(e=0){return new Promise(t=>setTimeout(t,e))}function Ug(e){return e&&typeof e.then=="function"?e:Promise.resolve(e)}var jg=Promise.resolve(!0),yr=Promise.resolve(!1),Lu=Promise.resolve(null),Lt=Promise.resolve();function us(e=1e4){return typeof requestIdleCallback=="function"?new Promise(t=>{requestIdleCallback(()=>t(),{timeout:e})}):Fg(0)}var lc=Lt;function Kg(e=void 0){return lc=lc.then(()=>us(e)),lc}function Hg(e,t){return e.reduce((r,n)=>r.then(n),Promise.resolve(t))}var zg=/\./g,id="abcdefghijklmnopqrstuvwxyz";function Ei(e=10){for(var t="",r=0;r<e;r++)t+=id.charAt(Math.floor(Math.random()*id.length));return t}function Lf(e){e+="";var t=e.charAt(0).toUpperCase();return t+e.substr(1)}function Ho(e){for(;e.charAt(0)===".";)e=e.substr(1);for(;e.slice(-1)===".";)e=e.slice(0,-1);return e}function si(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var r,n;if(Array.isArray(e)){if(r=e.length,r!==t.length)return!1;for(n=r;n--!==0;)if(!si(e[n],t[n]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();var o=Object.keys(e);if(r=o.length,r!==Object.keys(t).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(t,o[n]))return!1;for(n=r;n--!==0;){var i=o[n];if(!si(e[i],t[i]))return!1}return!0}return e!==e&&t!==t}var Zc=e=>{var t=typeof e;return e!==null&&(t==="object"||t==="function")},dc=new Set(["__proto__","prototype","constructor"]),Wg=new Set("0123456789");function Pf(e){var t=[],r="",n="start",o=!1;for(var i of e)switch(i){case"\\":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");o&&(r+=i),n="property",o=!o;break}case".":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="property";break}if(o){o=!1,r+=i;break}if(dc.has(r))return[];t.push(r),r="",n="property";break}case"[":{if(n==="index")throw new Error("Invalid character in an index");if(n==="indexEnd"){n="index";break}if(o){o=!1,r+=i;break}if(n==="property"){if(dc.has(r))return[];t.push(r),r=""}n="index";break}case"]":{if(n==="index"){t.push(Number.parseInt(r,10)),r="",n="indexEnd";break}if(n==="indexEnd")throw new Error("Invalid character after an index")}default:{if(n==="index"&&!Wg.has(i))throw new Error("Invalid character in an index");if(n==="indexEnd")throw new Error("Invalid character after an index");n==="start"&&(n="property"),o&&(o=!1,r+="\\"),r+=i}}switch(o&&(r+="\\"),n){case"property":{if(dc.has(r))return[];t.push(r);break}case"index":throw new Error("Index was not closed");case"start":{t.push("");break}}return t}function $f(e,t){if(typeof t!="number"&&Array.isArray(e)){var r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}function Vg(e,t){if($f(e,t))throw new Error("Cannot use string index")}function Qr(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!t.includes(".")&&!t.includes("["))return e[t];if(!Zc(e)||typeof t!="string")return r===void 0?e:r;var n=Pf(t);if(n.length===0)return r;for(var o=0;o<n.length;o++){var i=n[o];if($f(e,i)?e=o===n.length-1?void 0:null:e=e[i],e==null){if(o!==n.length-1)return r;break}}return e===void 0?r:e}function Af(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!Zc(e)||typeof t!="string")return e;for(var n=e,o=Pf(t),i=0;i<o.length;i++){var c=o[i];Vg(e,c),i===o.length-1?e[c]=r:Zc(e[c])||(e[c]=typeof o[i+1]=="number"?[]:{}),e=e[c]}return n}function fo(e,t){var r=e.get(t);if(typeof r>"u")throw new Error("missing value from map "+t);return r}function Kt(e,t,r,n){var o=e.get(t);return typeof o>"u"&&(o=r(),e.set(t,o)),o}function xe(e){var t=e.split("-"),r="RxDB";return t.forEach(n=>{r+=Lf(n)}),r+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+r+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+r+`);
        `)}function Qg(e){var t={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return t}var fc=0;function St(){var e=Date.now();e=e+.01,e<=fc&&(e=fc+.01);var t=parseFloat(e.toFixed(2));return fc=t,t}function fe(e,t){if(!e)throw t||(t=""),new Error("ensureNotFalsy() is falsy: "+t);return e}var Di={bufferSize:1,refCount:!0},Mf="16.11.0",hc={},Gg="6da4936d1425ff3a5c44c02342c6daf791d266be3ae8479b8ec59e261df41b93",ad=16,pc=yr,sd=!1;async function Tf(){return sd||(sd=!0,pc=(async()=>!!(hc.premium&&typeof hc.premium=="string"&&await Of(hc.premium)===Gg))()),pc}function ci(e,t){return ci=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,n){return r.__proto__=n,r},ci(e,t)}function Pu(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ci(e,t)}function eu(e){return eu=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},eu(e)}function Yg(e){try{return Function.toString.call(e).indexOf("[native code]")!==-1}catch{return typeof e=="function"}}function Nf(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Nf=function(){return!!e})()}function Jg(e,t,r){if(Nf())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var o=new(e.bind.apply(e,n));return r&&ci(o,r.prototype),o}function Ka(e){var t=typeof Map=="function"?new Map:void 0;return Ka=function(n){if(n===null||!Yg(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(t!==void 0){if(t.has(n))return t.get(n);t.set(n,o)}function o(){return Jg(n,arguments,eu(this).constructor)}return o.prototype=Object.create(n.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),ci(o,n)},Ka(e)}var Ie={isDevMode(){return!1},deepFreezeWhenDevMode(e){return e},tunnelErrorMessage(e){return`
        RxDB Error-Code: `+e+`.
        Hint: Error messages are not included in RxDB core to reduce build size.
        To show the full error messages and to ensure that you do not make any mistakes when using RxDB,
        use the dev-mode plugin when you are in development mode: https://rxdb.info/dev-mode.html?console=error
        `}};function Xg(e){var t="";return Object.keys(e).length===0||(t+="-".repeat(20)+`
`,t+=`Parameters:
`,t+=Object.keys(e).map(r=>{var n="[object Object]";try{r==="errors"?n=e[r].map(o=>JSON.stringify(o,Object.getOwnPropertyNames(o))):n=JSON.stringify(e[r],function(o,i){return i===void 0?null:i},2)}catch{}return r+": "+n}).join(`
`),t+=`
`),t}function qf(e,t,r){return`
`+e+`
`+Xg(r)}var Zg=function(e){function t(n,o,i={}){var c,u=qf(o,n,i);return c=e.call(this,u)||this,c.code=n,c.message=u,c.url=$u(n),c.parameters=i,c.rxdb=!0,c}Pu(t,e);var r=t.prototype;return r.toString=function(){return this.message},Gr(t,[{key:"name",get:function(){return"RxError ("+this.code+")"}},{key:"typeError",get:function(){return!1}}])}(Ka(Error)),ev=function(e){function t(n,o,i={}){var c,u=qf(o,n,i);return c=e.call(this,u)||this,c.code=n,c.message=u,c.url=$u(n),c.parameters=i,c.rxdb=!0,c}Pu(t,e);var r=t.prototype;return r.toString=function(){return this.message},Gr(t,[{key:"name",get:function(){return"RxTypeError ("+this.code+")"}},{key:"typeError",get:function(){return!0}}])}(Ka(TypeError));function $u(e){return"https://rxdb.info/errors.html?console=errors#"+e}function Bf(e){return`
Find out more about this error here: `+$u(e)+` 
`}function ee(e,t){return new Zg(e,Ie.tunnelErrorMessage(e)+Bf(e),t)}function Rt(e,t){return new ev(e,Ie.tunnelErrorMessage(e)+Bf(e),t)}function ls(e){return e&&e.status===409?e:!1}var tv={409:"document write conflict",422:"schema validation error",510:"attachment data missing"};function Ff(e){return ee("COL20",{name:tv[e.status],document:e.documentId,writeError:e})}var ui={preAddRxPlugin:[],preCreateRxDatabase:[],createRxDatabase:[],preCreateRxCollection:[],createRxCollection:[],createRxState:[],postCloseRxCollection:[],postRemoveRxCollection:[],preCreateRxSchema:[],createRxSchema:[],prePrepareRxQuery:[],preCreateRxQuery:[],prePrepareQuery:[],createRxDocument:[],postCreateRxDocument:[],preCreateRxStorageInstance:[],preStorageWrite:[],preMigrateDocument:[],postMigrateDocument:[],preCloseRxDatabase:[],postRemoveRxDatabase:[],postCleanup:[],preReplicationMasterWrite:[],preReplicationMasterWriteDocumentsHandle:[]};function pt(e,t){ui[e].length>0&&ui[e].forEach(r=>r(t))}async function xi(e,t){for(var r of ui[e])await r(t)}function ho(e,t){var r=t;r=r.replace(zg,".properties."),r="properties."+r,r=Ho(r);var n=Qr(e,r);return n}function rv(e,t,r){if(typeof t.primaryKey=="string")return r;var n=Pn(t,r),o=r[e];if(o&&o!==n)throw ee("DOC19",{args:{documentData:r,existingPrimary:o,newPrimary:n},schema:t});return r[e]=n,r}function It(e){return typeof e=="string"?e:e.key}function nv(e){var t=It(e.primaryKey),r=ho(e,t);return fe(r.maxLength)}function Pn(e,t){if(typeof e.primaryKey=="string")return t[e.primaryKey];var r=e.primaryKey;return r.fields.map(n=>{var o=Qr(t,n);if(typeof o>"u")throw ee("DOC18",{args:{field:n,documentData:t}});return o}).join(r.separator)}function ov(e){var t=ja(e,!0);return t}function iv(e){return["_deleted",e]}function ds(e){e=Ne(e);var t=It(e.primaryKey);e.properties=Ne(e.properties),e.additionalProperties=!1,Object.prototype.hasOwnProperty.call(e,"keyCompression")||(e.keyCompression=!1),e.indexes=e.indexes?e.indexes.slice(0):[],e.required=e.required?e.required.slice(0):[],e.encrypted=e.encrypted?e.encrypted.slice(0):[],e.properties._rev={type:"string",minLength:1},e.properties._attachments={type:"object"},e.properties._deleted={type:"boolean"},e.properties._meta=av,e.required=e.required?e.required.slice(0):[],e.required.push("_deleted"),e.required.push("_rev"),e.required.push("_meta"),e.required.push("_attachments");var r=Uf(e);kn(e.required,r),e.required=e.required.filter(i=>!i.includes(".")).filter((i,c,u)=>u.indexOf(i)===c),e.version=e.version||0;var n=e.indexes.map(i=>{var c=Ua(i)?i.slice(0):[i];return c.includes(t)||c.push(t),c[0]!=="_deleted"&&c.unshift("_deleted"),c});n.length===0&&n.push(iv(t)),n.push(["_meta.lwt",t]),e.internalIndexes&&e.internalIndexes.map(i=>{n.push(i)});var o=new Set;return n.filter(i=>{var c=i.join(",");return o.has(c)?!1:(o.add(c),!0)}),e.indexes=n,e}var av={type:"object",properties:{lwt:{type:"number",minimum:Ou,maximum:1e15,multipleOf:.01}},additionalProperties:!0,required:["lwt"]};function Uf(e){var t=Object.keys(e.properties).filter(n=>e.properties[n].final),r=It(e.primaryKey);return t.push(r),typeof e.primaryKey!="string"&&e.primaryKey.fields.forEach(n=>t.push(n)),t}function sv(e,t){for(var r=Object.keys(e.defaultValues),n=0;n<r.length;++n){var o=r[n];(!Object.prototype.hasOwnProperty.call(t,o)||typeof t[o]>"u")&&(t[o]=e.defaultValues[o])}return t}var jf=function(){function e(r,n){if(this.jsonSchema=r,this.hashFunction=n,this.indexes=cv(this.jsonSchema),this.primaryPath=It(this.jsonSchema.primaryKey),!r.properties[this.primaryPath].maxLength)throw ee("SC39",{schema:r});this.finalFields=Uf(this.jsonSchema)}var t=e.prototype;return t.validateChange=function(n,o){this.finalFields.forEach(i=>{if(!si(n[i],o[i]))throw ee("DOC9",{dataBefore:n,dataAfter:o,fieldName:i,schema:this.jsonSchema})})},t.getDocumentPrototype=function(){var n={},o=ho(this.jsonSchema,"");return Object.keys(o).forEach(i=>{var c=i;n.__defineGetter__(i,function(){if(!(!this.get||typeof this.get!="function")){var u=this.get(c);return u}}),Object.defineProperty(n,i+"$",{get:function(){return this.get$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,i+"$$",{get:function(){return this.get$$(c)},enumerable:!1,configurable:!1}),Object.defineProperty(n,i+"_",{get:function(){return this.populate(c)},enumerable:!1,configurable:!1})}),fr(this,"getDocumentPrototype",()=>n),n},t.getPrimaryOfDocumentData=function(n){return Pn(this.jsonSchema,n)},Gr(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var r={};return Object.entries(this.jsonSchema.properties).filter(([,n])=>Object.prototype.hasOwnProperty.call(n,"default")).forEach(([n,o])=>r[n]=o.default),fr(this,"defaultValues",r)}},{key:"hash",get:function(){return fr(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])}();function cv(e){return(e.indexes||[]).map(t=>Ua(t)?t:[t])}function uv(e){var t=e.version?e.version:0,r=0;return new Array(t).fill(0).map(()=>r++)}function lv(e,t,r=!0){r&&pt("preCreateRxSchema",e);var n=ds(e);n=ov(n),Ie.deepFreezeWhenDevMode(n);var o=new jf(n,t);return pt("createRxSchema",o),o}function We(e){return typeof e=="function"}function dv(e){return We(e==null?void 0:e.lift)}function er(e){return function(t){if(dv(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var tu=function(e,t){return tu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(r[o]=n[o])},tu(e,t)};function $n(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");tu(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function fv(e,t,r,n){function o(i){return i instanceof r?i:new r(function(c){c(i)})}return new(r||(r=Promise))(function(i,c){function u(m){try{p(n.next(m))}catch(v){c(v)}}function d(m){try{p(n.throw(m))}catch(v){c(v)}}function p(m){m.done?i(m.value):o(m.value).then(u,d)}p((n=n.apply(e,t||[])).next())})}function Kf(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=u(0),c.throw=u(1),c.return=u(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(p){return function(m){return d([p,m])}}function d(p){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,p[0]&&(r=0)),r;)try{if(n=1,o&&(i=p[0]&2?o.return:p[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,p[1])).done)return i;switch(o=0,i&&(p=[p[0]&2,i.value]),p[0]){case 0:case 1:i=p;break;case 4:return r.label++,{value:p[1],done:!1};case 5:r.label++,o=p[1],p=[0];continue;case 7:p=r.ops.pop(),r.trys.pop();continue;default:if(i=r.trys,!(i=i.length>0&&i[i.length-1])&&(p[0]===6||p[0]===2)){r=0;continue}if(p[0]===3&&(!i||p[1]>i[0]&&p[1]<i[3])){r.label=p[1];break}if(p[0]===6&&r.label<i[1]){r.label=i[1],i=p;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(p);break}i[2]&&r.ops.pop(),r.trys.pop();continue}p=t.call(e,r)}catch(m){p=[6,m],o=0}finally{n=i=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}function po(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Rn(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],c;try{for(;(t===void 0||t-- >0)&&!(o=n.next()).done;)i.push(o.value)}catch(u){c={error:u}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(c)throw c.error}}return i}function On(e,t,r){if(r||arguments.length===2)for(var n=0,o=t.length,i;n<o;n++)(i||!(n in t))&&(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return e.concat(i||Array.prototype.slice.call(t))}function Xn(e){return this instanceof Xn?(this.v=e,this):new Xn(e)}function hv(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),o,i=[];return o=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),u("next"),u("throw"),u("return",c),o[Symbol.asyncIterator]=function(){return this},o;function c(_){return function(I){return Promise.resolve(I).then(_,v)}}function u(_,I){n[_]&&(o[_]=function(k){return new Promise(function(A,q){i.push([_,k,A,q])>1||d(_,k)})},I&&(o[_]=I(o[_])))}function d(_,I){try{p(n[_](I))}catch(k){b(i[0][3],k)}}function p(_){_.value instanceof Xn?Promise.resolve(_.value.v).then(m,v):b(i[0][2],_)}function m(_){d("next",_)}function v(_){d("throw",_)}function b(_,I){_(I),i.shift(),i.length&&d(i[0][0],i[0][1])}}function pv(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof po=="function"?po(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(i){r[i]=e[i]&&function(c){return new Promise(function(u,d){c=e[i](c),o(u,d,c.done,c.value)})}}function o(i,c,u,d){Promise.resolve(d).then(function(p){i({value:p,done:u})},c)}}var Hf=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function zf(e){return We(e==null?void 0:e.then)}function Au(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var mc=Au(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,o){return o+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function ru(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var fs=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,o,i;if(!this.closed){this.closed=!0;var c=this._parentage;if(c)if(this._parentage=null,Array.isArray(c))try{for(var u=po(c),d=u.next();!d.done;d=u.next()){var p=d.value;p.remove(this)}}catch(k){t={error:k}}finally{try{d&&!d.done&&(r=u.return)&&r.call(u)}finally{if(t)throw t.error}}else c.remove(this);var m=this.initialTeardown;if(We(m))try{m()}catch(k){i=k instanceof mc?k.errors:[k]}var v=this._finalizers;if(v){this._finalizers=null;try{for(var b=po(v),_=b.next();!_.done;_=b.next()){var I=_.value;try{cd(I)}catch(k){i=i??[],k instanceof mc?i=On(On([],Rn(i)),Rn(k.errors)):i.push(k)}}}catch(k){n={error:k}}finally{try{_&&!_.done&&(o=b.return)&&o.call(b)}finally{if(n)throw n.error}}}if(i)throw new mc(i)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)cd(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&ru(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&ru(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),Wf=fs.EMPTY;function Vf(e){return e instanceof fs||e&&"closed"in e&&We(e.remove)&&We(e.add)&&We(e.unsubscribe)}function cd(e){We(e)?e():e.unsubscribe()}var mv={Promise:void 0},gv={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,On([e,t],Rn(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function Qf(e){gv.setTimeout(function(){throw e})}function ud(){}function Ca(e){e()}var Mu=function(e){$n(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,Vf(r)&&r.add(n)):n.destination=bv,n}return t.create=function(r,n,o){return new mo(r,n,o)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(fs),vv=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){pa(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){pa(n)}else pa(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){pa(r)}},e}(),mo=function(e){$n(t,e);function t(r,n,o){var i=e.call(this)||this,c;return We(r)||!r?c={next:r??void 0,error:n??void 0,complete:o??void 0}:c=r,i.destination=new vv(c),i}return t}(Mu);function pa(e){Qf(e)}function yv(e){throw e}var bv={closed:!0,next:ud,error:yv,complete:ud},Tu=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function ki(e){return e}function wv(e){return e.length===0?ki:e.length===1?e[0]:function(r){return e.reduce(function(n,o){return o(n)},r)}}var wt=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var o=this,i=Sv(t)?t:new mo(t,r,n);return Ca(function(){var c=o,u=c.operator,d=c.source;i.add(u?u.call(i,d):d?o._subscribe(i):o._trySubscribe(i))}),i},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=ld(r),new r(function(o,i){var c=new mo({next:function(u){try{t(u)}catch(d){i(d),c.unsubscribe()}},error:i,complete:o});n.subscribe(c)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[Tu]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return wv(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=ld(t),new t(function(n,o){var i;r.subscribe(function(c){return i=c},function(c){return o(c)},function(){return n(i)})})},e.create=function(t){return new e(t)},e}();function ld(e){var t;return(t=e??mv.Promise)!==null&&t!==void 0?t:Promise}function _v(e){return e&&We(e.next)&&We(e.error)&&We(e.complete)}function Sv(e){return e&&e instanceof Mu||_v(e)&&Vf(e)}function Gf(e){return We(e[Tu])}function Yf(e){return Symbol.asyncIterator&&We(e==null?void 0:e[Symbol.asyncIterator])}function Jf(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Iv(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Xf=Iv();function Zf(e){return We(e==null?void 0:e[Xf])}function eh(e){return hv(this,arguments,function(){var r,n,o,i;return Kf(this,function(c){switch(c.label){case 0:r=e.getReader(),c.label=1;case 1:c.trys.push([1,,9,10]),c.label=2;case 2:return[4,Xn(r.read())];case 3:return n=c.sent(),o=n.value,i=n.done,i?[4,Xn(void 0)]:[3,5];case 4:return[2,c.sent()];case 5:return[4,Xn(o)];case 6:return[4,c.sent()];case 7:return c.sent(),[3,2];case 8:return[3,10];case 9:return r.releaseLock(),[7];case 10:return[2]}})})}function th(e){return We(e==null?void 0:e.getReader)}function Sr(e){if(e instanceof wt)return e;if(e!=null){if(Gf(e))return Cv(e);if(Hf(e))return Ev(e);if(zf(e))return Dv(e);if(Yf(e))return rh(e);if(Zf(e))return xv(e);if(th(e))return kv(e)}throw Jf(e)}function Cv(e){return new wt(function(t){var r=e[Tu]();if(We(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Ev(e){return new wt(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function Dv(e){return new wt(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,Qf)})}function xv(e){return new wt(function(t){var r,n;try{for(var o=po(e),i=o.next();!i.done;i=o.next()){var c=i.value;if(t.next(c),t.closed)return}}catch(u){r={error:u}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}t.complete()})}function rh(e){return new wt(function(t){Rv(e,t).catch(function(r){return t.error(r)})})}function kv(e){return rh(eh(e))}function Rv(e,t){var r,n,o,i;return fv(this,void 0,void 0,function(){var c,u;return Kf(this,function(d){switch(d.label){case 0:d.trys.push([0,5,6,11]),r=pv(e),d.label=1;case 1:return[4,r.next()];case 2:if(n=d.sent(),!!n.done)return[3,4];if(c=n.value,t.next(c),t.closed)return[2];d.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return u=d.sent(),o={error:u},[3,11];case 6:return d.trys.push([6,,9,10]),n&&!n.done&&(i=r.return)?[4,i.call(r)]:[3,8];case 7:d.sent(),d.label=8;case 8:return[3,10];case 9:if(o)throw o.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function br(e,t,r,n,o){return new Ov(e,t,r,n,o)}var Ov=function(e){$n(t,e);function t(r,n,o,i,c,u){var d=e.call(this,r)||this;return d.onFinalize=c,d.shouldUnsubscribe=u,d._next=n?function(p){try{n(p)}catch(m){r.error(m)}}:e.prototype._next,d._error=i?function(p){try{i(p)}catch(m){r.error(m)}finally{this.unsubscribe()}}:e.prototype._error,d._complete=o?function(){try{o()}catch(p){r.error(p)}finally{this.unsubscribe()}}:e.prototype._complete,d}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(Mu),nh={now:function(){return(nh.delegate||Date).now()},delegate:void 0};function Lv(e){return e&&We(e.schedule)}function Nu(e){return e[e.length-1]}function Pv(e){return We(Nu(e))?e.pop():void 0}function Ri(e){return Lv(Nu(e))?e.pop():void 0}function oh(e,t){return typeof Nu(e)=="number"?e.pop():t}function Kr(e,t,r,n,o){n===void 0&&(n=0),o===void 0&&(o=!1);var i=t.schedule(function(){r(),o?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(i),!o)return i}var $v=Array.isArray,Av=Object.getPrototypeOf,Mv=Object.prototype,Tv=Object.keys;function Nv(e){if(e.length===1){var t=e[0];if($v(t))return{args:t,keys:null};if(qv(t)){var r=Tv(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function qv(e){return e&&typeof e=="object"&&Av(e)===Mv}function ih(e,t){return t===void 0&&(t=0),er(function(r,n){r.subscribe(br(n,function(o){return Kr(n,e,function(){return n.next(o)},t)},function(){return Kr(n,e,function(){return n.complete()},t)},function(o){return Kr(n,e,function(){return n.error(o)},t)}))})}function ah(e,t){return t===void 0&&(t=0),er(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function Bv(e,t){return Sr(e).pipe(ah(t),ih(t))}function Fv(e,t){return Sr(e).pipe(ah(t),ih(t))}function Uv(e,t){return new wt(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function jv(e,t){return new wt(function(r){var n;return Kr(r,t,function(){n=e[Xf](),Kr(r,t,function(){var o,i,c;try{o=n.next(),i=o.value,c=o.done}catch(u){r.error(u);return}c?r.complete():r.next(i)},0,!0)}),function(){return We(n==null?void 0:n.return)&&n.return()}})}function sh(e,t){if(!e)throw new Error("Iterable cannot be null");return new wt(function(r){Kr(r,t,function(){var n=e[Symbol.asyncIterator]();Kr(r,t,function(){n.next().then(function(o){o.done?r.complete():r.next(o.value)})},0,!0)})})}function Kv(e,t){return sh(eh(e),t)}function Hv(e,t){if(e!=null){if(Gf(e))return Bv(e,t);if(Hf(e))return Uv(e,t);if(zf(e))return Fv(e,t);if(Yf(e))return sh(e,t);if(Zf(e))return jv(e,t);if(th(e))return Kv(e,t)}throw Jf(e)}function Oi(e,t){return t?Hv(e,t):Sr(e)}function He(e,t){return er(function(r,n){var o=0;r.subscribe(br(n,function(i){n.next(e.call(t,i,o++))}))})}var zv=Array.isArray;function Wv(e,t){return zv(t)?e.apply(void 0,On([],Rn(t))):e(t)}function Vv(e){return He(function(t){return Wv(e,t)})}function Qv(e,t){return e.reduce(function(r,n,o){return r[n]=t[o],r},{})}function Gv(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ri(e),n=Pv(e),o=Nv(e),i=o.args,c=o.keys;if(i.length===0)return Oi([],r);var u=new wt(Yv(i,r,c?function(d){return Qv(c,d)}:ki));return n?u.pipe(Vv(n)):u}function Yv(e,t,r){return r===void 0&&(r=ki),function(n){dd(t,function(){for(var o=e.length,i=new Array(o),c=o,u=o,d=function(m){dd(t,function(){var v=Oi(e[m],t),b=!1;v.subscribe(br(n,function(_){i[m]=_,b||(b=!0,u--),u||n.next(r(i.slice()))},function(){--c||n.complete()}))},n)},p=0;p<o;p++)d(p)},n)}}function dd(e,t,r){e?Kr(r,e,t):t()}function Jv(e,t,r,n,o,i,c,u){var d=[],p=0,m=0,v=!1,b=function(){v&&!d.length&&!p&&t.complete()},_=function(k){return p<n?I(k):d.push(k)},I=function(k){p++;var A=!1;Sr(r(k,m++)).subscribe(br(t,function(q){t.next(q)},function(){A=!0},void 0,function(){if(A)try{p--;for(var q=function(){var U=d.shift();c||I(U)};d.length&&p<n;)q();b()}catch(U){t.error(U)}}))};return e.subscribe(br(t,_,function(){v=!0,b()})),function(){}}function wr(e,t,r){return r===void 0&&(r=1/0),We(t)?wr(function(n,o){return He(function(i,c){return t(n,i,o,c)})(Sr(e(n,o)))},r):(typeof t=="number"&&(r=t),er(function(n,o){return Jv(n,o,e,r)}))}function qu(e){return e===void 0&&(e=1/0),wr(ki,e)}function Xv(){return qu(1)}var Zv=Au(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Pt=function(e){$n(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new fd(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new Zv},t.prototype.next=function(r){var n=this;Ca(function(){var o,i;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var c=po(n.currentObservers),u=c.next();!u.done;u=c.next()){var d=u.value;d.next(r)}}catch(p){o={error:p}}finally{try{u&&!u.done&&(i=c.return)&&i.call(c)}finally{if(o)throw o.error}}}})},t.prototype.error=function(r){var n=this;Ca(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var o=n.observers;o.length;)o.shift().error(r)}})},t.prototype.complete=function(){var r=this;Ca(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,o=this,i=o.hasError,c=o.isStopped,u=o.observers;return i||c?Wf:(this.currentObservers=null,u.push(r),new fs(function(){n.currentObservers=null,ru(u,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,o=n.hasError,i=n.thrownError,c=n.isStopped;o?r.error(i):c&&r.complete()},t.prototype.asObservable=function(){var r=new wt;return r.source=this,r},t.create=function(r,n){return new fd(r,n)},t}(wt),fd=function(e){$n(t,e);function t(r,n){var o=e.call(this)||this;return o.destination=r,o.source=n,o}return t.prototype.next=function(r){var n,o;(o=(n=this.destination)===null||n===void 0?void 0:n.next)===null||o===void 0||o.call(n,r)},t.prototype.error=function(r){var n,o;(o=(n=this.destination)===null||n===void 0?void 0:n.error)===null||o===void 0||o.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,o;return(o=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&o!==void 0?o:Wf},t}(Pt);function hd(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Xv()(Oi(e,Ri(e)))}var ey=new wt(function(e){return e.complete()});function li(e,t){return t===void 0&&(t=ki),e=e??ty,er(function(r,n){var o,i=!0;r.subscribe(br(n,function(c){var u=t(c);(i||!e(o,u))&&(i=!1,o=u,n.next(c))}))})}function ty(e,t){return e===t}function ke(e,t){return er(function(r,n){var o=0;r.subscribe(br(n,function(i){return e.call(t,i,o++)&&n.next(i)}))})}var ry=Au(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function ny(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ri(e),n=oh(e,1/0);return er(function(o,i){qu(n)(Oi(On([o],Rn(e)),r)).subscribe(i)})}function oy(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ny.apply(void 0,On([],Rn(e)))}var Lr=function(e){$n(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,o=r.thrownError,i=r._value;if(n)throw o;return this._throwIfClosed(),i},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(Pt),iy=function(e){$n(t,e);function t(r,n,o){r===void 0&&(r=1/0),n===void 0&&(n=1/0),o===void 0&&(o=nh);var i=e.call(this)||this;return i._bufferSize=r,i._windowTime=n,i._timestampProvider=o,i._buffer=[],i._infiniteTimeWindow=!0,i._infiniteTimeWindow=n===1/0,i._bufferSize=Math.max(1,r),i._windowTime=Math.max(1,n),i}return t.prototype.next=function(r){var n=this,o=n.isStopped,i=n._buffer,c=n._infiniteTimeWindow,u=n._timestampProvider,d=n._windowTime;o||(i.push(r),!c&&i.push(u.now()+d)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),o=this,i=o._infiniteTimeWindow,c=o._buffer,u=c.slice(),d=0;d<u.length&&!r.closed;d+=i?1:2)r.next(u[d]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,o=r._timestampProvider,i=r._buffer,c=r._infiniteTimeWindow,u=(c?1:2)*n;if(n<1/0&&u<i.length&&i.splice(0,i.length-u),!c){for(var d=o.now(),p=0,m=1;m<i.length&&i[m]<=d;m+=2)p=m;p&&i.splice(0,p+1)}},t}(Pt);function ay(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new Pt}:t,n=e.resetOnError,o=n===void 0?!0:n,i=e.resetOnComplete,c=i===void 0?!0:i,u=e.resetOnRefCountZero,d=u===void 0?!0:u;return function(p){var m,v,b,_=0,I=!1,k=!1,A=function(){v==null||v.unsubscribe(),v=void 0},q=function(){A(),m=b=void 0,I=k=!1},U=function(){var G=m;q(),G==null||G.unsubscribe()};return er(function(G,ae){_++,!k&&!I&&A();var oe=b=b??r();ae.add(function(){_--,_===0&&!k&&!I&&(v=gc(U,d))}),oe.subscribe(ae),!m&&_>0&&(m=new mo({next:function(te){return oe.next(te)},error:function(te){k=!0,A(),v=gc(q,o,te),oe.error(te)},complete:function(){I=!0,A(),v=gc(q,c),oe.complete()}}),Sr(G).subscribe(m))})(p)}}function gc(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var o=new mo({next:function(){o.unsubscribe(),e()}});return Sr(t.apply(void 0,On([],Rn(r)))).subscribe(o)}}function Li(e,t,r){var n,o,i,c,u=!1;return e&&typeof e=="object"?(n=e.bufferSize,c=n===void 0?1/0:n,o=e.windowTime,t=o===void 0?1/0:o,i=e.refCount,u=i===void 0?!1:i,r=e.scheduler):c=e??1/0,ay({connector:function(){return new iy(c,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:u})}function Pi(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ri(e);return er(function(n,o){(r?hd(e,n,r):hd(e,n)).subscribe(o)})}function sy(e,t){return er(function(r,n){var o=null,i=0,c=!1,u=function(){return c&&!o&&n.complete()};r.subscribe(br(n,function(d){o==null||o.unsubscribe();var p=0,m=i++;Sr(e(d,m)).subscribe(o=br(n,function(v){return n.next(t?t(d,v,m,p++):v)},function(){o=null,u()}))},function(){c=!0,u()}))})}function ch(e){return e.documentData?e.documentData:e.previousDocumentData}function cy(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:Ie.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var uy=new Map;function uh(e){return Kt(uy,e,()=>{for(var t=new Array(e.events.length),r=e.events,n=e.collectionName,o=e.isLocal,i=Ie.deepFreezeWhenDevMode,c=0;c<r.length;c++){var u=r[c];t[c]={documentId:u.documentId,collectionName:n,isLocal:o,operation:u.operation,documentData:i(u.documentData),previousDocumentData:i(u.previousDocumentData)}}return t})}function Sn(e,t){return new Promise(function(r,n){var o=new mo({next:function(i){r(i),o.unsubscribe()},error:n,complete:function(){n(new ry)}});e.subscribe(o)})}function ly(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Ri(e),n=oh(e,1/0),o=e;return o.length?o.length===1?Sr(o[0]):qu(n)(Oi(o,r)):ey}var Zn="ï¿¿",eo=Number.MIN_SAFE_INTEGER;function dy(e,t){var r=t.selector,n=e.indexes?e.indexes.slice(0):[];t.index&&(n=[t.index]);var o=!!t.sort.find(m=>Object.values(m)[0]==="desc"),i=new Set;Object.keys(r).forEach(m=>{var v=ho(e,m);v&&v.type==="boolean"&&Object.prototype.hasOwnProperty.call(r[m],"$eq")&&i.add(m)});var c=t.sort.map(m=>Object.keys(m)[0]),u=c.filter(m=>!i.has(m)).join(","),d=-1,p;if(n.forEach(m=>{var v=!0,b=!0,_=m.map(U=>{var G=r[U],ae=G?Object.keys(G):[],oe={};if(!G||!ae.length){var te=b?eo:Zn;oe={startKey:te,endKey:v?Zn:eo,inclusiveStart:!0,inclusiveEnd:!0}}else ae.forEach(Z=>{if(Bu.has(Z)){var ce=G[Z],he=my(Z,ce);oe=Object.assign(oe,he)}});return typeof oe.startKey>"u"&&(oe.startKey=eo),typeof oe.endKey>"u"&&(oe.endKey=Zn),typeof oe.inclusiveStart>"u"&&(oe.inclusiveStart=!0),typeof oe.inclusiveEnd>"u"&&(oe.inclusiveEnd=!0),b&&!oe.inclusiveStart&&(b=!1),v&&!oe.inclusiveEnd&&(v=!1),oe}),I=_.map(U=>U.startKey),k=_.map(U=>U.endKey),A={index:m,startKeys:I,endKeys:k,inclusiveEnd:v,inclusiveStart:b,sortSatisfiedByIndex:!o&&u===m.filter(U=>!i.has(U)).join(","),selectorSatisfiedByIndex:py(m,t.selector,I,k)},q=gy(e,t,A);(q>=d||t.index)&&(d=q,p=A)}),!p)throw ee("SNH",{query:t});return p}var Bu=new Set(["$eq","$gt","$gte","$lt","$lte"]),fy=new Set(["$eq","$gt","$gte"]),hy=new Set(["$eq","$lt","$lte"]);function py(e,t,r,n){var o=Object.entries(t),i=o.find(([Z,ce])=>{if(!e.includes(Z))return!0;var he=Object.entries(ce).find(([Ee,Le])=>!Bu.has(Ee));return he});if(i||t.$and||t.$or)return!1;var c=[],u=new Set;for(var[d,p]of Object.entries(t)){if(!e.includes(d))return!1;var m=Object.keys(p).filter(Z=>fy.has(Z));if(m.length>1)return!1;var v=m[0];if(v&&u.add(d),v!=="$eq"){if(c.length>0)return!1;c.push(v)}}var b=[],_=new Set;for(var[I,k]of Object.entries(t)){if(!e.includes(I))return!1;var A=Object.keys(k).filter(Z=>hy.has(Z));if(A.length>1)return!1;var q=A[0];if(q&&_.add(I),q!=="$eq"){if(b.length>0)return!1;b.push(q)}}var U=0;for(var G of e){for(var ae of[u,_]){if(!ae.has(G)&&ae.size>0)return!1;ae.delete(G)}var oe=r[U],te=n[U];if(oe!==te&&u.size>0&&_.size>0)return!1;U++}return!0}function my(e,t){switch(e){case"$eq":return{startKey:t,endKey:t,inclusiveEnd:!0,inclusiveStart:!0};case"$lte":return{endKey:t,inclusiveEnd:!0};case"$gte":return{startKey:t,inclusiveStart:!0};case"$lt":return{endKey:t,inclusiveEnd:!1};case"$gt":return{startKey:t,inclusiveStart:!1};default:throw new Error("SNH")}}function gy(e,t,r){var n=0,o=m=>{m>0&&(n=n+m)},i=10,c=uc(r.startKeys,m=>m!==eo&&m!==Zn);o(c*i);var u=uc(r.startKeys,m=>m!==Zn&&m!==eo);o(u*i);var d=uc(r.startKeys,(m,v)=>m===r.endKeys[v]);o(d*i*1.5);var p=r.sortSatisfiedByIndex?5:0;return o(p),n}class $i extends Error{}const di=Symbol("missing"),lh=Object.freeze(new Error("mingo: cycle detected while processing object/array")),Ai=e=>{const t=Ea(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},Fr=e=>typeof e!="object"&&typeof e!="function"||e===null,dh=e=>Fr(e)||go(e)||hr(e),fh={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12},Tt=(e,t)=>{e===di&&(e=void 0),t===di&&(t=void 0);const[r,n]=[e,t].map(o=>fh[hi(o)]||0);return r!==n?r-n:Ut(e,t)?0:e<t?-1:e>t?1:0};var _i,ar,yn;const sl=class sl extends Map{constructor(){super();Ue(this,_i,Ai);Ue(this,ar,new Map);Ue(this,yn,r=>{const n=V(this,_i).call(this,r);return[(V(this,ar).get(n)||[]).find(o=>Ut(o,r)),n]})}static init(r){const n=new sl;return r&&je(n,_i,r),n}clear(){super.clear(),V(this,ar).clear()}delete(r){if(Fr(r))return super.delete(r);const[n,o]=V(this,yn).call(this,r);return super.delete(n)?(V(this,ar).set(o,V(this,ar).get(o).filter(i=>!Ut(i,n))),!0):!1}get(r){if(Fr(r))return super.get(r);const[n,o]=V(this,yn).call(this,r);return super.get(n)}has(r){if(Fr(r))return super.has(r);const[n,o]=V(this,yn).call(this,r);return super.has(n)}set(r,n){if(Fr(r))return super.set(r,n);const[o,i]=V(this,yn).call(this,r);if(super.has(o))super.set(o,n);else{super.set(r,n);const c=V(this,ar).get(i)||[];c.push(r),V(this,ar).set(i,c)}return this}get size(){return super.size}};_i=new WeakMap,ar=new WeakMap,yn=new WeakMap;let fi=sl;function Ce(e,t){if(!e)throw new $i(t)}const vy=Object.keys(fh).reduce((e,t)=>(e["[object "+t[0].toUpperCase()+t.substring(1)+"]"]=t,e),{});function hi(e){var r,n;const t=Object.prototype.toString.call(e);return t==="[object Object]"?((n=(r=e==null?void 0:e.constructor)==null?void 0:r.name)==null?void 0:n.toLowerCase())||"object":vy[t]||t.substring(8,t.length-1).toLowerCase()}const to=e=>typeof e=="boolean",Ht=e=>typeof e=="string",yy=e=>typeof e=="symbol",Je=e=>!isNaN(e)&&typeof e=="number",ge=Array.isArray;function ze(e){if(!e)return!1;const t=Object.getPrototypeOf(e);return(t===Object.prototype||t===null)&&hi(e)==="object"}const hh=e=>!Fr(e),go=e=>e instanceof Date,hr=e=>e instanceof RegExp,hs=e=>typeof e=="function",_t=e=>e==null,vo=(e,t=!0)=>!!e||t&&e==="",Fu=e=>_t(e)||Ht(e)&&!e||ge(e)&&e.length===0||ze(e)&&Object.keys(e).length===0,Io=e=>ge(e)?e:[e],zt=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),by=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),yo=(e,t)=>{if(_t(e)||to(e)||Je(e)||Ht(e))return e;if(go(e))return new Date(e);if(hr(e))return new RegExp(e);if(by(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw lh;t.add(e);try{if(ge(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=yo(e[n],t);return r}if(ze(e)){const r={};for(const n of Object.keys(e))r[n]=yo(e[n],t);return r}}finally{t.delete(e)}return e},pd=e=>e===di;function nu(e,t){if(pd(e)||_t(e))return t;if(pd(t)||_t(t))return e;if(Fr(e)||Fr(t))return t;ge(e)&&ge(t)&&Ce(e.length===t.length,"arrays must be of equal length to merge.");for(const r of Object.keys(t))e[r]=nu(e[r],t[r]);return e}function ph(e,t=Ai){const r=[fi.init(t),fi.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(o=>{r[0].has(o)&&r[1].set(o,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function mh(e,t=1){const r=new Array;function n(o,i){for(let c=0,u=o.length;c<u;c++)ge(o[c])&&(i>0||i<0)?n(o[c],Math.max(-1,i-1)):r.push(o[c])}return n(e,t),r}function wy(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}function gh(e){for(;e;){if(Object.getOwnPropertyNames(e).includes("toString"))return e.toString!==Object.prototype.toString;e=Object.getPrototypeOf(e)}return!1}function Ut(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object"||e.constructor!==t.constructor)return!1;if(e instanceof Date)return+e==+t;if(e instanceof RegExp)return e.toString()===t.toString();const r=e.constructor;if(r===Array||r===Object){const n=Object.keys(e).sort(),o=Object.keys(t).sort();if(n.length!==o.length)return!1;for(let i=0,c=n[i];i<n.length;c=n[++i])if(c!==o[i]||!Ut(e[c],t[c]))return!1;return!0}return gh(e)&&e.toString()===t.toString()}function _y(e,t=Ai){const r=fi.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}const Ea=(e,t)=>{if(e===null)return"null";if(e===void 0)return"undefined";if(Ht(e)||Je(e)||to(e))return JSON.stringify(e);if(go(e))return e.toISOString();if(hr(e)||yy(e)||hs(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw lh;try{if(t.add(e),ge(e))return"["+e.map(n=>Ea(n,t)).join(",")+"]";if(ze(e))return"{"+Object.keys(e).sort().map(o=>`${o}:${Ea(e[o],t)}`).join()+"}";const r=gh(e)?e.toString():Ea(wy(e),t);return hi(e)+"("+r+")"}finally{t.delete(e)}};function Sy(e,t){return _t(e)?null:(t=t||Ai,t(e))}function Iy(e,t,r=Ai){if(e.length<1)return new Map;const n=new Map,o=new Map;for(let i=0;i<e.length;i++){const c=e[i],u=t(c,i),d=Sy(u,r);if(d===null)o.has(null)?o.get(null).push(c):o.set(null,[c]);else{const p=n.has(d)?n.get(d).find(m=>Ut(m,u)):null;_t(p)?(o.set(u,[c]),n.has(d)?n.get(d).push(u):n.set(d,[u])):o.get(p).push(c)}}return o}function ou(e,t){return hh(e)?e[t]:void 0}function Cy(e,t){if(t<1)return e;for(;t--&&e.length===1;)e=e[0];return e}function Zt(e,t,r){let n=0;function o(c,u){let d=c;for(let p=0;p<u.length;p++){const m=u[p];if(/^\d+$/.exec(m)===null&&ge(d)){if(p===0&&n>0)break;n+=1;const b=u.slice(p);d=d.reduce((_,I)=>{const k=o(I,b);return k!==void 0&&_.push(k),_},[]);break}else d=ou(d,m);if(d===void 0)break}return d}const i=dh(e)?e:o(e,t.split("."));return ge(i)&&(r!=null&&r.unwrapArray)?Cy(i,n):i}function Qo(e,t,r){const n=t.indexOf("."),o=n==-1?t:t.substring(0,n),i=t.substring(n+1),c=n!=-1;if(ge(e)){const p=/^\d+$/.test(o),m=p&&(r!=null&&r.preserveIndex)?[...e]:[];if(p){const v=parseInt(o);let b=ou(e,v);c&&(b=Qo(b,i,r)),r!=null&&r.preserveIndex?m[v]=b:m.push(b)}else for(const v of e){const b=Qo(v,t,r);r!=null&&r.preserveMissing?m.push(b??di):(b!=null||r!=null&&r.preserveIndex)&&m.push(b)}return m}const u=r!=null&&r.preserveKeys?{...e}:{};let d=ou(e,o);if(c&&(d=Qo(d,i,r)),d!==void 0)return u[o]=d,u}function iu(e){if(ge(e))for(let t=e.length-1;t>=0;t--)e[t]===di?e.splice(t,1):iu(e[t]);else if(ze(e))for(const t in e)zt(e,t)&&iu(e[t])}const md=/^\d+$/;function pi(e,t,r,n){const o=t.split("."),i=o[0],c=o.slice(1).join(".");if(o.length===1)(ze(e)||ge(e)&&md.test(i))&&r(e,i);else{n!=null&&n.buildGraph&&_t(e[i])&&(e[i]={});const u=e[i];if(!u)return;const d=!!(o.length>1&&md.test(o[1]));ge(u)&&(n!=null&&n.descendArray)&&!d?u.forEach(p=>pi(p,c,r,n)):pi(u,c,r,n)}}function Ey(e,t,r){pi(e,t,(n,o)=>{n[o]=hs(r)?r(n[o]):r},{buildGraph:!0})}function gd(e,t,r){pi(e,t,(n,o)=>{if(ge(n)){if(/^\d+$/.test(o))n.splice(parseInt(o),1);else if(r&&r.descendArray)for(const i of n)ze(i)&&delete i[o]}else ze(n)&&delete n[o]},r)}const Dy=/^\$[a-zA-Z0-9_]+$/;function Yr(e){return Dy.test(e)}function vh(e){if(dh(e))return hr(e)?{$regex:e}:{$eq:e};if(hh(e)){if(!Object.keys(e).some(Yr))return{$eq:e};if(zt(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var au=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(au||{}),Ye,Si,sr;const Zo=class Zo{constructor(t,r,n){Ue(this,Ye);Ue(this,Si);Ue(this,sr);je(this,Ye,t),this.update(r,n)}static init(t,r,n){var o;return t instanceof Zo?new Zo(V(t,Ye),t.root??r,{...V(t,sr),...n,variables:Object.assign({},(o=V(t,sr))==null?void 0:o.variables,n==null?void 0:n.variables)}):new Zo(t,r,n)}update(t,r){var o;je(this,Si,t);const n=Object.assign({},(o=V(this,sr))==null?void 0:o.variables,r==null?void 0:r.variables);return Object.keys(n).length?je(this,sr,{...r,variables:n}):je(this,sr,r??{}),this}getOptions(){return Object.freeze({...V(this,Ye),context:Ln.from(V(this,Ye).context)})}get root(){return V(this,Si)}get local(){return V(this,sr)}get idKey(){return V(this,Ye).idKey}get collation(){var t;return(t=V(this,Ye))==null?void 0:t.collation}get processingMode(){var t;return((t=V(this,Ye))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=V(this,Ye))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=V(this,Ye))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=V(this,Ye))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=V(this,Ye))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=V(this,Ye))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=V(this,Ye))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=V(this,Ye))==null?void 0:t.variables}get context(){var t;return(t=V(this,Ye))==null?void 0:t.context}};Ye=new WeakMap,Si=new WeakMap,sr=new WeakMap;let mi=Zo;function yh(e){return e instanceof mi?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:e!=null&&e.context?Ln.from(e==null?void 0:e.context):Ln.init()})}var su=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(su||{}),Mr;const as=class as{constructor(){Ue(this,Mr,new Map)}static init(){return new as}static from(t){const r=as.init();return _t(t)||V(t,Mr).forEach((n,o)=>r.addOperators(o,n)),r}addOperators(t,r){V(this,Mr).has(t)||V(this,Mr).set(t,{});for(const[n,o]of Object.entries(r))this.getOperator(t,n)||(V(this,Mr).get(t)[n]=o);return this}getOperator(t,r){return(V(this,Mr).get(t)??{})[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};Mr=new WeakMap;let Ln=as;const ln=Ln.init();function vd(e,t){for(const[r,n]of Object.entries(t)){Ce(hs(n)&&Yr(r),`'${r}' is not a valid operator`);const o=gi(e,r,null);Ce(!o||n===o,`${r} already exists for '${e}' operators. Cannot change operator function once registered.`)}switch(e){case"accumulator":ln.addAccumulatorOps(t);break;case"expression":ln.addExpressionOps(t);break;case"pipeline":ln.addPipelineOps(t);break;case"projection":ln.addProjectionOps(t);break;case"query":ln.addQueryOps(t);break;case"window":ln.addWindowOps(t);break}}function gi(e,t,r){const{context:n,useGlobalContext:o}=r||{},i=n?n.getOperator(e,t):null;return!i&&o?ln.getOperator(e,t):i}function Ot(e,t,r,n){const o=mi.init(n,e);return r&&Yr(r)?bh(e,t,r,o):Ha(e,t,o)}const xy=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Ha(e,t,r){var n;if(Ht(t)&&t.length>0&&t[0]==="$"){if(ky.includes(t))return t;let o=r.root;const i=t.split(".");if(xy.includes(i[0])){switch(i[0]){case"$$ROOT":break;case"$$CURRENT":o=e;break;case"$$REMOVE":o=void 0;break;case"$$NOW":o=new Date;break}t=t.slice(i[0].length+1)}else if(i[0].slice(0,2)==="$$"){o=Object.assign({},r.variables,{this:e},(n=r==null?void 0:r.local)==null?void 0:n.variables);const c=i[0].slice(2);Ce(zt(o,c),`Use of undefined variable: ${c}`),t=t.slice(2)}else t=t.slice(1);return t===""?o:Zt(o,t)}if(ge(t))return t.map(o=>Ha(e,o,r));if(ze(t)){const o={},i=Object.entries(t);for(const[c,u]of i){if(Yr(c))return Ce(i.length==1,"expression must have single operator."),bh(e,u,c,r);o[c]=Ha(e,u,r)}return o}return t}function bh(e,t,r,n){const o=gi("expression",r,n);if(o)return o(e,t,n);const i=gi("accumulator",r,n);return Ce(!!i,`accumulator '${r}' is not registered.`),ge(e)||(e=Ha(e,t,n),t=null),Ce(ge(e),`arguments must resolve to array for ${r}.`),i(e,t,n)}const ky=["$$KEEP","$$PRUNE","$$DESCEND"];function vi(e){return e instanceof yd?e:new yd(e)}function Ry(...e){let t=0;return vi(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function Oy(e){return!!e&&typeof e=="object"&&(e==null?void 0:e.next)instanceof Function}function Ly(e,t){const r=e.slice(t+1);e.splice(t),Array.prototype.push.apply(e,r)}const cu=new Error;function Py(e,t,r){let n=!1,o=-1,i=0;return function(c){try{e:for(;!n;){let u=e();o++;let d=-1;const p=t.length;let m=!1;for(;++d<p;){const v=t[d];switch(v.action){case 0:u=v.func(u,o);break;case 1:if(!v.func(u,o))continue e;break;case 2:--v.count,v.count||(m=!0);break;case 3:--v.count,v.count||Ly(t,d);continue e;default:break e}}if(n=m,c)r[i++]=u;else return{value:u,done:!1}}}catch(u){if(u!==cu)throw u}return n=!0,{done:n}}}var bn,ao,so,vf;let yd=(vf=class{constructor(t){Ue(this,bn);Ue(this,ao);Ue(this,so);je(this,bn,[]),je(this,ao,[]),this.isDone=!1;let r;if(t instanceof Function&&(t={next:t}),Oy(t)){const n=t;r=()=>{const o=n.next();if(o.done)throw cu;return o.value}}else if(ge(t)){const n=t,o=n.length;let i=0;r=()=>{if(i<o)return n[i++];throw cu}}else if(!(t instanceof Function))throw new $i("Lazy must be initialized with an array, generator, or function.");je(this,so,Py(r,V(this,bn),V(this,ao)))}push(t,r){return typeof r=="function"?V(this,bn).push({action:t,func:r}):typeof r=="number"&&V(this,bn).push({action:t,count:r}),this}next(){return V(this,so).call(this)}map(t){return this.push(0,t)}filter(t){return this.push(1,t)}take(t){return t>0?this.push(2,t):this}drop(t){return t>0?this.push(3,t):this}transform(t){const r=this;let n;return vi(()=>(n||(n=vi(t(r.value()))),n.next()))}value(){return this.isDone||(this.isDone=V(this,so).call(this,!0).done),V(this,ao)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce((t,r)=>++t,0)}[Symbol.iterator](){return this}},bn=new WeakMap,ao=new WeakMap,so=new WeakMap,vf);const $y=(e,t,r)=>e.take(t),wh=(e,t,r)=>Fu(t)?e:(Sh(t,r),e.map(_h(t,mi.init(r))));function _h(e,t,r=!0){const n=t.idKey,o=Object.keys(e),i=new Array,c=new Array,u={};for(const _ of o){const I=e[_];if(Je(I)||to(I))I?c.push(_):i.push(_);else if(ge(I))u[_]=k=>I.map(A=>Ot(k,A,null,t.update(k))??null);else if(ze(I)){const k=Object.keys(I),A=k.length==1?k[0]:"",q=gi("projection",A,t);q?A==="$slice"&&!Io(I[A]).every(Je)?u[_]=G=>Ot(G,I,_,t.update(G)):u[_]=G=>q(G,I[A],_,t.update(G)):Yr(A)?u[_]=U=>Ot(U,I[A],A,t):(Sh(I,t),u[_]=U=>{if(!zt(U,_))return Ot(U,I,null,t);r&&t.update(U);const G=Zt(U,_),ae=_h(I,t,!1);return ge(G)?G.map(ae):ze(G)?ae(G):ae(U)})}else u[_]=Ht(I)&&I[0]==="$"?k=>Ot(k,I,_,t):k=>I}const d=Object.keys(u),p=i.includes(n);if(r&&p&&i.length===1&&!c.length&&!d.length)return _=>{const I={..._};return delete I[n],I};const v=r&&!p&&!c.includes(n),b={preserveMissing:!0};return _=>{const I={};if(i.length&&!c.length){nu(I,_);for(const k of i)gd(I,k,{descendArray:!0})}for(const k of c){const A=Qo(_,k,b)??{};nu(I,A)}c.length&&iu(I);for(const k of d){const A=u[k](_);A===void 0?gd(I,k,{descendArray:!0}):Ey(I,k,A)}return v&&zt(_,n)&&(I[n]=Zt(_,n)),I}}function Sh(e,t){let r=!1,n=!1;for(const[o,i]of Object.entries(e))Ce(!o.startsWith("$"),"Field names may not start with '$'."),Ce(!o.endsWith(".$"),"Positional projection operator '$' is not supported."),o!==(t==null?void 0:t.idKey)&&(i===0||i===!1?r=!0:(i===1||i===!0)&&(n=!0),Ce(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const Ay=(e,t,r)=>e.drop(t),Ih=(e,t,r)=>{if(Fu(t)||!ze(t))return e;let n=Tt;const o=r.collation;return ze(o)&&Ht(o.locale)&&(n=Ty(o)),e.transform(i=>{const c=Object.keys(t);for(const u of c.reverse()){const d=Iy(i,v=>Zt(v,u),r.hashFunction),p=Array.from(d.keys()).sort(n);t[u]===-1&&p.reverse();let m=0;for(const v of p)for(const b of d.get(v))i[m++]=b;Ce(m==i.length,"bug: counter must match collection size.")}return i})},My={1:"base",2:"accent",3:"variant"};function Ty(e){const t={sensitivity:My[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};(e.caseLevel||!1)===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,o)=>{if(!Ht(n)||!Ht(o))return Tt(n,o);const i=r.compare(n,o);return i<0?-1:i>0?1:0}}const Ny={$sort:Ih,$skip:Ay,$limit:$y};var Ii,Ci,co,cr,Tr,yt,ur;class qy{constructor(t,r,n,o){Ue(this,Ii);Ue(this,Ci);Ue(this,co);Ue(this,cr);Ue(this,Tr,{});Ue(this,yt,null);Ue(this,ur,[]);je(this,Ii,t),je(this,Ci,r),je(this,co,n),je(this,cr,o)}fetch(){if(V(this,yt))return V(this,yt);je(this,yt,vi(V(this,Ii)).filter(V(this,Ci)));const t=V(this,cr).processingMode;t&au.CLONE_INPUT&&V(this,yt).map(yo);for(const r of["$sort","$skip","$limit"])zt(V(this,Tr),r)&&je(this,yt,Ny[r](V(this,yt),V(this,Tr)[r],V(this,cr)));return Object.keys(V(this,co)).length&&je(this,yt,wh(V(this,yt),V(this,co),V(this,cr))),t&au.CLONE_OUTPUT&&V(this,yt).map(yo),V(this,yt)}fetchAll(){const t=vi([...V(this,ur)]);return je(this,ur,[]),Ry(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return V(this,Tr).$skip=t,this}limit(t){return V(this,Tr).$limit=t,this}sort(t){return V(this,Tr).$sort=t,this}collation(t){return je(this,cr,{...V(this,cr),collation:t}),this}next(){if(V(this,ur).length>0)return V(this,ur).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(V(this,ur).length>0)return!0;const t=this.fetch().next();return t.done?!1:(V(this,ur).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}Ii=new WeakMap,Ci=new WeakMap,co=new WeakMap,cr=new WeakMap,Tr=new WeakMap,yt=new WeakMap,ur=new WeakMap;const By=new Set(Array.from(["$and","$or","$nor","$expr","$jsonSchema"]));var uo,Nr,wn;class Jr{constructor(t,r){Ue(this,uo);Ue(this,Nr);Ue(this,wn);je(this,wn,yo(t)),je(this,Nr,yh(r)),je(this,uo,[]),this.compile()}compile(){Ce(ze(V(this,wn)),`query criteria must be an object: ${JSON.stringify(V(this,wn))}`);const t={};for(const[r,n]of Object.entries(V(this,wn))){if(r==="$where")Ce(V(this,Nr).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(By.has(r))this.processOperator(r,r,n);else{Ce(!Yr(r),`unknown top level operator: ${r}`);for(const[o,i]of Object.entries(vh(n)))this.processOperator(r,o,i)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const o=gi("query",r,V(this,Nr));Ce(!!o,`unknown query operator ${r}`),V(this,uo).push(o(t,n,V(this,Nr)))}test(t){return V(this,uo).every(r=>r(t))}find(t,r){return new qy(t,n=>this.test(n),r||{},V(this,Nr))}remove(t){return t.reduce((r,n)=>(this.test(n)||r.push(n),r),[])}}uo=new WeakMap,Nr=new WeakMap,wn=new WeakMap;const Fy=["monday","mon","tuesday","tue","wednesday","wed","thursday","thu","friday","fri","saturday","sat","sunday","sun"];new Set(Fy);function dt(e){return(r,n,o)=>{const i={unwrapArray:!0},c=Math.max(1,r.split(".").length-1);return u=>{const d=Zt(u,r,i);return e(d,n,{...o,depth:c})}}}function Co(e){return(t,r,n)=>{const o=Ot(t,r,null,n);return e(...o)}}function Uu(e,t,r){return Ut(e,t)||_t(e)&&_t(t)?!0:ge(e)?e.some(n=>Ut(n,t))||mh(e,r==null?void 0:r.depth).some(n=>Ut(n,t)):!1}function Ch(e,t,r){return!Uu(e,t,r)}function Eh(e,t,r){return _t(e)?t.some(n=>n===null):ph([Io(e),t],r==null?void 0:r.hashFunction).length>0}function Uy(e,t,r){return!Eh(e,t,r)}function Dh(e,t,r){return ps(e,t,(n,o)=>Tt(n,o)<0)}function xh(e,t,r){return ps(e,t,(n,o)=>Tt(n,o)<=0)}function kh(e,t,r){return ps(e,t,(n,o)=>Tt(n,o)>0)}function Rh(e,t,r){return ps(e,t,(n,o)=>Tt(n,o)>=0)}function jy(e,t,r){return Io(e).some(n=>t.length===2&&n%t[0]===t[1])}function Ky(e,t,r){const n=Io(e),o=i=>Ht(i)&&vo(t.exec(i),r==null?void 0:r.useStrictMode);return n.some(o)||mh(n,1).some(o)}function Hy(e,t,r){if(!ge(e)||!ge(t)||!e.length||!t.length)return!1;let n=!0;for(const o of t){if(!n)break;ze(o)&&Object.keys(o).includes("$elemMatch")?n=Oh(e,o.$elemMatch,r):hr(o)?n=e.some(i=>typeof i=="string"&&o.test(i)):n=e.some(i=>Ut(o,i))}return n}function zy(e,t,r){return Array.isArray(e)&&e.length===t}function Wy(e){return Yr(e)&&["$and","$or","$nor"].indexOf(e)===-1}function Oh(e,t,r){if(ge(e)&&!Fu(e)){let n=c=>c,o=t;Object.keys(t).every(Wy)&&(o={temp:t},n=c=>({temp:c}));const i=new Jr(o,r);for(let c=0,u=e.length;c<u;c++)if(i.test(n(e[c])))return!0}return!1}const bd=e=>e===null,Vy={array:ge,boolean:to,bool:to,date:go,number:Je,int:Je,long:Je,double:Je,decimal:Je,null:bd,object:ze,regexp:hr,regex:hr,string:Ht,undefined:_t,function:e=>{throw new $i("unsupported type key `function`.")},1:Je,2:Ht,3:ze,4:ge,6:_t,8:to,9:go,10:bd,11:hr,16:Je,18:Je,19:Je};function wd(e,t,r){const n=Vy[t];return n?n(e):!1}function Qy(e,t,r){return ge(t)?t.findIndex(n=>wd(e,n))>=0:wd(e,t)}function ps(e,t,r){return Io(e).some(n=>hi(n)===hi(t)&&r(n,t))}const Gy=(e,t,r)=>{const n=Ot(e,t,null,r);return vo(n,r.useStrictMode)&&n.every(o=>vo(o,r.useStrictMode))},Yy=(e,t,r)=>{const n=Io(t);return n.length==0?!1:(Ce(n.length==1,"Expression $not takes exactly 1 argument"),!Ot(e,n[0],null,r))},Jy=(e,t,r)=>{const n=Ot(e,t,null,r),o=r.useStrictMode;return vo(n,o)&&n.some(i=>vo(i,o))},Xy=Object.freeze(Object.defineProperty({__proto__:null,$and:Gy,$not:Yy,$or:Jy},Symbol.toStringTag,{value:"Module"})),Zy=(e,t,r)=>{const n=Ot(e,t,null,r);return Ce(ge(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),Tt(n[0],n[1])},eb=Co(Uu),tb=Co(kh),rb=Co(Rh),nb=Co(Dh),ob=Co(xh),ib=Co(Ch),ab=Object.freeze(Object.defineProperty({__proto__:null,$cmp:Zy,$eq:eb,$gt:tb,$gte:rb,$lt:nb,$lte:ob,$ne:ib},Symbol.toStringTag,{value:"Module"})),_d=(e,t)=>{const r={};return e.split("").forEach((n,o)=>r[n]=t*(o+1)),r};({..._d("ABCDEFGHIKLM",1),..._d("NOPQRSTUVWXY",-1)});const Sd={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error};function Ct(e,t=Sd){const r=Object.assign({},Sd,t),n=new Set(Object.keys(r));return(o,i,c)=>{const u=Ot(o,i,null,c);if(n.has(`${u}`)){const d=r[`${u}`];if(d instanceof Error)throw new $i(`cannot apply $${e.name} to -inf, value must in (-inf,inf)`);return d}return e(u)}}Ct(Math.acos,{Infinity:1/0,0:new Error});Ct(Math.acosh,{Infinity:1/0,0:new Error});Ct(Math.asin);Ct(Math.asinh,{Infinity:1/0,"-Infinity":-1/0});Ct(Math.atan);Ct(Math.atanh,{1:1/0,"-1":-1/0});Ct(Math.cos);Ct(Math.cosh,{"-Infinity":1/0,Infinity:1/0});const sb=Math.PI/180;Ct(e=>e*sb,{Infinity:1/0,"-Infinity":1/0});const cb=180/Math.PI;Ct(e=>e*cb,{Infinity:1/0,"-Infinity":-1/0});Ct(Math.sin);Ct(Math.sinh,{"-Infinity":-1/0,Infinity:1/0});Ct(Math.tan);const Lh=(e,t,r)=>{Ce(ge(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(o=>new Jr(o,r));return o=>n.every(i=>i.test(o))},ju=(e,t,r)=>{Ce(ge(t),"Invalid expression. $or expects value to be an Array");const n=t.map(o=>new Jr(o,r));return o=>n.some(i=>i.test(o))},Ph=(e,t,r)=>{Ce(ge(t),"Invalid expression. $nor expects value to be an array.");const n=ju("$or",t,r);return o=>!n(o)},$h=(e,t,r)=>{const n={};n[e]=vh(t);const o=new Jr(n,r);return i=>!o.test(i)},Ah=dt(Uu),Mh=dt(kh),Th=dt(Rh),Nh=dt(Eh),qh=dt(Dh),Bh=dt(xh),Fh=dt(Ch),Uh=dt(Uy);function ub(e,t,r){return n=>Ot(n,t,null,r)}function lb(e,t,r){if(!(r!=null&&r.jsonSchemaValidator))throw new $i("Missing option 'jsonSchemaValidator'. Configure to use '$jsonSchema' operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return o=>n(o)}const jh=dt(jy),Kh=dt(Ky);function db(e,t,r){Ce(r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true");const n=t;return Ce(hs(n),"$where only accepts a Function object"),o=>vo(n.call(o),r==null?void 0:r.useStrictMode)}const fb=dt(Hy),Hh=dt(Oh),zh=dt(zy),Wh=(e,t,r)=>{const n=e.includes("."),o=!!t;return!n||e.match(/\.\d+$/)?i=>Zt(i,e)!==void 0===o:i=>{const c=Qo(i,e,{preserveIndex:!0}),u=Zt(c,e.substring(0,e.lastIndexOf(".")));return ge(u)?u.some(d=>d!==void 0)===o:u!==void 0===o}},Vh=dt(Qy);var Id=!1;function hb(e){return Id||(vd(su.PIPELINE,{$sort:Ih,$project:wh}),vd(su.QUERY,{$and:Lh,$eq:Ah,$elemMatch:Hh,$exists:Wh,$gt:Mh,$gte:Th,$in:Nh,$lt:qh,$lte:Bh,$ne:Fh,$nin:Uh,$mod:jh,$nor:Ph,$not:$h,$or:ju,$regex:Kh,$size:zh,$type:Vh}),Id=!0),new Jr(e)}function ro(e,t){var r=It(e.primaryKey);t=Ne(t);var n=lt(t);if(typeof n.skip!="number"&&(n.skip=0),n.selector?(n.selector=n.selector,Object.entries(n.selector).forEach(([v,b])=>{(typeof b!="object"||b===null)&&(n.selector[v]={$eq:b})})):n.selector={},n.index){var o=Ru(n.index);o.includes(r)||o.push(r),n.index=o}if(n.sort){var m=n.sort.find(v=>Mg(v)===r);m||(n.sort=n.sort.slice(0),n.sort.push({[r]:"asc"}))}else if(n.index)n.sort=n.index.map(v=>({[v]:"asc"}));else{if(e.indexes){var i=new Set;Object.entries(n.selector).forEach(([v,b])=>{var _=!1;typeof b=="object"&&b!==null?_=!!Object.keys(b).find(I=>Bu.has(I)):_=!0,_&&i.add(v)});var c=-1,u;e.indexes.forEach(v=>{var b=Ua(v)?v:[v],_=b.findIndex(I=>!i.has(I));_>0&&_>c&&(c=_,u=b)}),u&&(n.sort=u.map(v=>({[v]:"asc"})))}if(!n.sort)if(e.indexes&&e.indexes.length>0){var d=e.indexes[0],p=Ua(d)?d:[d];n.sort=p.map(v=>({[v]:"asc"}))}else n.sort=[{[r]:"asc"}]}return n}function Qh(e,t){if(!t.sort)throw ee("SNH",{query:t});var r=[];t.sort.forEach(o=>{var i=Object.keys(o)[0],c=Object.values(o)[0];r.push({key:i,direction:c,getValueFn:Ag(i)})});var n=(o,i)=>{for(var c=0;c<r.length;++c){var u=r[c],d=u.getValueFn(o),p=u.getValueFn(i);if(d!==p){var m=u.direction==="asc"?Tt(d,p):Tt(p,d);return m}}};return n}function Ku(e,t){if(!t.sort)throw ee("SNH",{query:t});var r=hb(t.selector),n=o=>r.test(o);return n}async function Hn(e,t){var r=await e.exec();if(!r)return null;if(Array.isArray(r))return Promise.all(r.map(o=>t(o)));if(r instanceof Map)return Promise.all([...r.values()].map(o=>t(o)));var n=await t(r);return n}function ms(e,t){if(!t.sort)throw ee("SNH",{query:t});var r=dy(e,t);return{query:t,queryPlan:r}}var pb="_rxdb_internal";async function Mi(e,t){var r=await e.findDocumentsById([t],!1),n=r[0];if(n)return n}async function yi(e,t,r){var n=await e.bulkWrite([t],r);if(n.error.length>0){var o=n.error[0];throw o}else{var i=It(e.schema.primaryKey),c=Nt(i,[t],n),u=c[0];return u}}function mb(e,t){var r=Mi(e,t),n=e.changeStream().pipe(He(o=>o.events.find(i=>i.documentId===t)),ke(o=>!!o),He(o=>Promise.resolve(fe(o).documentData)),Pi(r),sy(o=>o),ke(o=>!!o));return n}function bi(e){return Object.assign({},...e)}function za(e,t,r,n){if(n)throw n.status===409?ee("CONFLICT",{collection:e.name,id:t,writeError:n,data:r}):n.status===422?ee("VD2",{collection:e.name,id:t,writeError:n,data:r}):n}function gb(e,t,r,n,o,i,c){for(var u=!!e.schema.attachments,d=[],p=[],m=[],v=Ei(10),b={id:v,events:[],checkpoint:null,context:o},_=b.events,I=[],k=[],A=[],q=r.size>0,U,G=n.length,ae=function(){var te=n[oe],Z=te.document,ce=te.previous,he=Z[t],Ee=Z._deleted,Le=ce&&ce._deleted,X=void 0;q&&(X=r.get(he));var we;if(X){var rt=X._rev;if(!ce||ce&&rt!==ce._rev){var tr={isError:!0,status:409,documentId:he,writeRow:te,documentInDb:X};return m.push(tr),1}var qe=u?vc(te):te;u&&(Ee?ce&&Object.keys(ce._attachments).forEach(ve=>{k.push({documentId:he,attachmentId:ve,digest:fe(ce)._attachments[ve].digest})}):(Object.entries(Z._attachments).find(([ve,Ve])=>{var Dt=ce?ce._attachments[ve]:void 0;return!Dt&&!Ve.data&&(we={documentId:he,documentInDb:X,isError:!0,status:510,writeRow:te,attachmentId:ve}),!0}),we||Object.entries(Z._attachments).forEach(([ve,Ve])=>{var Dt=ce?ce._attachments[ve]:void 0;if(!Dt)I.push({documentId:he,attachmentId:ve,attachmentData:Ve,digest:Ve.digest});else{var Ir=qe.document._attachments[ve].digest;Ve.data&&Dt.digest!==Ir&&A.push({documentId:he,attachmentId:ve,attachmentData:Ve,digest:Ve.digest})}}))),we?m.push(we):(u?p.push(vc(qe)):p.push(qe),U=qe);var at=null,se=null,Ae=null;if(Le&&!Ee)Ae="INSERT",at=u?Jt(Z):Z;else if(ce&&!Le&&!Ee)Ae="UPDATE",at=u?Jt(Z):Z,se=ce;else if(Ee)Ae="DELETE",at=fe(Z),se=ce;else throw ee("SNH",{args:{writeRow:te}});var Ze={documentId:he,documentData:at,previousDocumentData:se,operation:Ae};_.push(Ze)}else{var De=!!Ee;if(u&&Object.entries(Z._attachments).forEach(([ve,Ve])=>{Ve.data?I.push({documentId:he,attachmentId:ve,attachmentData:Ve,digest:Ve.digest}):(we={documentId:he,isError:!0,status:510,writeRow:te,attachmentId:ve},m.push(we))}),we||(u?d.push(vc(te)):d.push(te),U=te),!De){var Re={documentId:he,operation:"INSERT",documentData:u?Jt(Z):Z,previousDocumentData:u&&ce?Jt(ce):ce};_.push(Re)}}},oe=0;oe<G;oe++)ae();return{bulkInsertDocs:d,bulkUpdateDocs:p,newestRow:U,errors:m,eventBulk:b,attachmentsAdd:I,attachmentsRemove:k,attachmentsUpdate:A}}function vc(e){return{previous:e.previous,document:Jt(e.document)}}function vb(e){return atob(e).length}function yb(e){var t=e.data;if(!t)return e;var r={length:vb(t),digest:e.digest,type:e.type};return r}function Jt(e){if(!e._attachments||Object.keys(e._attachments).length===0)return e;var t=Ne(e);return t._attachments={},Object.entries(e._attachments).forEach(([r,n])=>{t._attachments[r]=yb(n)}),t}function Ti(e){return Object.assign({},e,{_meta:Ne(e._meta)})}function Hu(e,t,r){Ie.deepFreezeWhenDevMode(r);var n=It(t.schema.primaryKey),o={originalStorageInstance:t,schema:t.schema,internals:t.internals,collectionName:t.collectionName,databaseName:t.databaseName,options:t.options,async bulkWrite(i,c){for(var u=e.token,d=new Array(i.length),p=St(),m=0;m<i.length;m++){var v=i[m],b=Ti(v.document);b._meta.lwt=p;var _=v.previous;b._rev=vr(u,_),d[m]={document:b,previous:_}}pt("preStorageWrite",{storageInstance:this.originalStorageInstance,rows:d});var I=await e.lockedRun(()=>t.bulkWrite(d,c)),k={error:[]};Yh.set(k,d);var A=I.error.length===0?[]:I.error.filter(te=>te.status===409&&!te.writeRow.previous&&!te.writeRow.document._deleted&&fe(te.documentInDb)._deleted?!0:(k.error.push(te),!1));if(A.length>0){var q=new Set,U=A.map(te=>(q.add(te.documentId),{previous:te.documentInDb,document:Object.assign({},te.writeRow.document,{_rev:vr(e.token,te.documentInDb)})})),G=await e.lockedRun(()=>t.bulkWrite(U,c));kn(k.error,G.error);var ae=Nt(n,d,k,q),oe=Nt(n,U,G);return kn(ae,oe),k}return k},query(i){return e.lockedRun(()=>t.query(i))},count(i){return e.lockedRun(()=>t.count(i))},findDocumentsById(i,c){return e.lockedRun(()=>t.findDocumentsById(i,c))},getAttachmentData(i,c,u){return e.lockedRun(()=>t.getAttachmentData(i,c,u))},getChangedDocumentsSince:t.getChangedDocumentsSince?(i,c)=>e.lockedRun(()=>t.getChangedDocumentsSince(fe(i),c)):void 0,cleanup(i){return e.lockedRun(()=>t.cleanup(i))},remove(){return e.storageInstances.delete(o),e.lockedRun(()=>t.remove())},close(){return e.storageInstances.delete(o),e.lockedRun(()=>t.close())},changeStream(){return t.changeStream()}};return e.storageInstances.add(o),o}function bb(e){if(e.schema.keyCompression)throw ee("UT5",{args:{params:e}});if(uu(e.schema))throw ee("UT6",{args:{params:e}});if(e.schema.attachments&&e.schema.attachments.compression)throw ee("UT7",{args:{params:e}})}function uu(e){return!!(e.encrypted&&e.encrypted.length>0||e.attachments&&e.attachments.encrypted)}function wb(e,t,r){var n=It(e.schema.primaryKey),o=r?r.lwt:Ou,i=r?r.id:"";return ro(e.schema,{selector:{$or:[{"_meta.lwt":{$gt:o}},{"_meta.lwt":{$eq:o},[n]:{$gt:r?i:""}}],"_meta.lwt":{$gte:o}},sort:[{"_meta.lwt":"asc"},{[n]:"asc"}],skip:0,limit:t})}async function Gh(e,t,r){if(e.getChangedDocumentsSince)return e.getChangedDocumentsSince(t,r);var n=It(e.schema.primaryKey),o=ms(e.schema,wb(e,t,r)),i=await e.query(o),c=i.documents,u=Lg(c);return{documents:c,checkpoint:u?{id:u[n],lwt:u._meta.lwt}:r||{id:"",lwt:0}}}var Yh=new WeakMap,_b=new WeakMap;function Nt(e,t,r,n){return Kt(_b,r,()=>{var o=[],i=Yh.get(r);if(i||(i=t),r.error.length>0||n){for(var c=n||new Set,u=0;u<r.error.length;u++){var d=r.error[u];c.add(d.documentId)}for(var p=0;p<i.length;p++){var m=i[p].document;c.has(m[e])||o.push(Jt(m))}}else{o.length=t.length-r.error.length;for(var v=0;v<i.length;v++){var b=i[v].document;o[v]=Jt(b)}}return o})}var Jh=function(){function e(r,n,o,i){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=r,this.primaryPath=n,this.preWrite=o,this.postWrite=i}var t=e.prototype;return t.addWrite=function(n,o){var i=n[this.primaryPath],c=Kt(this.queueByDocId,i,()=>[]),u=new Promise((d,p)=>{var m={lastKnownDocumentState:n,modifier:o,resolve:d,reject:p};fe(c).push(m),this.triggerRun()});return u},t.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var n=[],o=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(o.entries()).map(async([c,u])=>{var d=Sb(u.map(v=>v.lastKnownDocumentState)),p=d;for(var m of u)try{p=await m.modifier(lt(p))}catch(v){m.reject(v),m.reject=()=>{},m.resolve=()=>{}}try{await this.preWrite(p,d)}catch(v){u.forEach(b=>b.reject(v));return}n.push({previous:d,document:p})}));var i=n.length>0?await this.storageInstance.bulkWrite(n,"incremental-write"):{error:[]};return await Promise.all(Nt(this.primaryPath,n,i).map(c=>{var u=c[this.primaryPath];this.postWrite(c);var d=fo(o,u);d.forEach(p=>p.resolve(c))})),i.error.forEach(c=>{var u=c.documentId,d=fo(o,u),p=ls(c);if(p){var m=Kt(this.queueByDocId,u,()=>[]);d.reverse().forEach(b=>{b.lastKnownDocumentState=fe(p.documentInDb),fe(m).unshift(b)})}else{var v=Ff(c);d.forEach(b=>b.reject(v))}}),this.isRunning=!1,this.triggerRun()}},e}();function Cd(e){var t=async r=>{var n=Tg(r);n._deleted=r._deleted;var o=await e(n),i=Object.assign({},o,{_meta:r._meta,_attachments:r._attachments,_rev:r._rev,_deleted:typeof o._deleted<"u"?o._deleted:r._deleted});return typeof i._deleted>"u"&&(i._deleted=!1),i};return t}function Sb(e){var t=e[0],r=Vr(t._rev);return e.forEach(n=>{var o=Vr(n._rev);o>r&&(t=n,r=o)}),t}var gs={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(He(t=>t._data._deleted))},get deleted$$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,t=this.primary;return e.collection.eventBulks$.pipe(ke(r=>!r.isLocal),He(r=>r.events.find(n=>n.documentId===t)),ke(r=>!!r),He(r=>ch(fe(r))),Pi(e.collection._docCache.getLatestDocumentData(t)),li((r,n)=>r._rev===n._rev),He(r=>this.collection._docCache.getCachedRxDocument(r)),Li(Di))},get $$(){var e=this,t=e.collection.database.getReactivityFactory();return t.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(Ie.isDevMode()){if(e.includes(".item."))throw ee("DOC1",{path:e});if(e===this.primaryPath)throw ee("DOC2");if(this.collection.schema.finalFields.includes(e))throw ee("DOC3",{path:e});var t=ho(this.collection.schema.jsonSchema,e);if(!t)throw ee("DOC4",{path:e})}return this.$.pipe(He(r=>Qr(r,e)),li())},get$$(e){var t=this.get$(e),r=this.collection.database.getReactivityFactory();return r.fromObservable(t,this.getLatest().get(e),this.collection.database)},populate(e){var t=ho(this.collection.schema.jsonSchema,e),r=this.get(e);if(!r)return Lu;if(!t)throw ee("DOC5",{path:e});if(!t.ref)throw ee("DOC6",{path:e,schemaObj:t});var n=this.collection.database.collections[t.ref];if(!n)throw ee("DOC7",{ref:t.ref,path:e,schemaObj:t});return t.type==="array"?n.findByIds(r).exec().then(o=>{var i=o.values();return Array.from(i)}):n.findOne(r).exec()},get(e){return ep(this,e)},toJSON(e=!1){if(e)return Ie.deepFreezeWhenDevMode(this._data);var t=Ne(this._data);return delete t._rev,delete t._attachments,delete t._deleted,delete t._meta,Ie.deepFreezeWhenDevMode(t)},toMutableJSON(e=!1){return lt(this.toJSON(e))},update(e){throw xe("update")},incrementalUpdate(e){throw xe("update")},updateCRDT(e){throw xe("crdt")},putAttachment(){throw xe("attachments")},getAttachment(){throw xe("attachments")},allAttachments(){throw xe("attachments")},get allAttachments$(){throw xe("attachments")},async modify(e,t){var r=this._data,n=await Cd(e)(r);return this._saveData(n,r)},incrementalModify(e,t){return this.collection.incrementalWriteQueue.addWrite(this._data,Cd(e)).then(r=>this.collection._docCache.getCachedRxDocument(r))},patch(e){var t=this._data,r=lt(t);return Object.entries(e).forEach(([n,o])=>{r[n]=o}),this._saveData(r,t)},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e,t){if(e=Ne(e),this._data._deleted)throw ee("DOC11",{id:this.primary,document:this});await Zh(this.collection,e,t);var r=[{previous:t,document:e}],n=await this.collection.storageInstance.bulkWrite(r,"rx-document-save-data"),o=n.error[0];return za(this.collection,this.primary,e,o),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(Nt(this.collection.schema.primaryPath,r,n)[0])},async remove(){if(this.deleted)return Promise.reject(ee("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var t=e.error[0];za(this.collection,this.primary,this._data,t)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw ee("DOC14")}};function Xh(e=gs){var t=function(n,o){this.collection=n,this._data=o,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return t.prototype=e,t}function Ib(e,t,r){var n=new e(t,r);return pt("createRxDocument",n),n}function Zh(e,t,r){return t._meta=Object.assign({},r._meta,t._meta),Ie.isDevMode()&&e.schema.validateChange(r,t),e._runHooks("pre","save",t,r)}function ep(e,t){return Kt(e._propertyCache,t,()=>{var r=Qr(e._data,t);if(typeof r!="object"||r===null||Array.isArray(r))return Ie.deepFreezeWhenDevMode(r);var n=new Proxy(Ne(r),{get(o,i){if(typeof i!="string")return o[i];var c=i.charAt(i.length-1);if(c==="$")if(i.endsWith("$$")){var u=i.slice(0,-2);return e.get$$(Ho(t+"."+u))}else{var d=i.slice(0,-1);return e.get$(Ho(t+"."+d))}else if(c==="_"){var p=i.slice(0,-1);return e.populate(Ho(t+"."+p))}else{var m=o[i];return typeof m=="number"||typeof m=="string"||typeof m=="boolean"?m:ep(e,Ho(t+"."+i))}}});return n})}function zu(e){return e[e.length-1]}function Cb(e){const t=typeof e;return e!==null&&(t==="object"||t==="function")}function Ed(e,t,r){if(Array.isArray(t)&&(t=t.join(".")),!Cb(e)||typeof t!="string")return e;const n=t.split(".");if(n.length===0)return r;for(let o=0;o<n.length;o++){const i=n[o];if(Eb(e,i)?e=o===n.length-1?void 0:null:e=e[i],e==null){if(o!==n.length-1)return r;break}}return e===void 0?r:e}function Eb(e,t){if(typeof t!="number"&&Array.isArray(e)){const r=Number.parseInt(t,10);return Number.isInteger(r)&&e[r]===e[t]}return!1}const tp=e=>!!e.queryParams.limit,Db=e=>e.queryParams.limit===1,xb=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),kb=e=>e.changeEvent.operation==="DELETE",Rb=e=>e.changeEvent.operation==="INSERT",Ob=e=>e.changeEvent.operation==="UPDATE",Lb=e=>tp(e)&&e.previousResults.length>=e.queryParams.limit,Pb=e=>{const t=e.queryParams.sortFields,r=e.changeEvent.previous,n=e.changeEvent.doc;if(!n)return!1;if(!r)return!0;for(let o=0;o<t.length;o++){const i=t[o],c=Ed(r,i),u=Ed(n,i);if(c!==u)return!0}return!1},$b=e=>{const t=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(t);{const r=e.queryParams.primaryKey,n=e.previousResults;for(let o=0;o<n.length;o++)if(n[o][r]===t)return!0;return!1}},Ab=e=>{const t=e.previousResults[0];return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},Mb=e=>{const t=zu(e.previousResults);return!!(t&&t[e.queryParams.primaryKey]===e.changeEvent.id)},Tb=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Nb=e=>{const t=e.changeEvent.previous;if(!t)return!1;const r=zu(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},qb=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=e.previousResults[0];return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)<0:!1},Bb=e=>{const t=e.changeEvent.doc;if(!t)return!1;const r=zu(e.previousResults);return r?r[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(t,r)>0:!1},Fb=e=>{const t=e.changeEvent.previous;return t?e.queryParams.queryMatcher(t):!1},Ub=e=>{const t=e.changeEvent.doc;return t?e.queryParams.queryMatcher(t):!1},jb=e=>e.previousResults.length===0,Kb={0:Rb,1:Ob,2:kb,3:tp,4:Db,5:xb,6:jb,7:Lb,8:Ab,9:Mb,10:Pb,11:$b,12:Tb,13:Nb,14:qb,15:Bb,16:Fb,17:Ub};function Hb(e,t,r,n){var o=e.length,i=o-1,c=0;if(o===0)return e.push(t),0;for(var u;n<=i;)c=n+(i-n>>1),u=e[c],r(u,t)<=0?n=c+1:i=c-1;return r(u,t)<=0&&c++,e.splice(c,0,t),c}const zb=e=>{},Wu=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Vu=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},Qu=e=>{const t=e.previousResults.shift();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Gu=e=>{const t=e.previousResults.pop();e.keyDocumentMap&&t&&e.keyDocumentMap.delete(t[e.queryParams.primaryKey])},Wb=e=>{Qu(e),Vu(e)},Vb=e=>{Gu(e),Wu(e)},Qb=e=>{Qu(e),Wu(e)},Gb=e=>{Gu(e),Vu(e)},rp=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const t=e.queryParams.primaryKey,r=e.previousResults;for(let n=0;n<r.length;n++)if(r[n][t]===e.changeEvent.id){r.splice(n,1);break}},Yb=e=>{const t=e.changeEvent.doc,r=e.queryParams.primaryKey,n=e.previousResults;for(let o=0;o<n.length;o++)if(n[o][r]===e.changeEvent.id){n[o]=t,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,t);break}},Jb=e=>{const t={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(t),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(t._id,t))},np=e=>{const t=e.changeEvent.id,r=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(t))return;e.keyDocumentMap.set(t,r)}else if(e.previousResults.find(o=>o[e.queryParams.primaryKey]===t))return;Hb(e.previousResults,r,e.queryParams.sortComparator,0)},Xb=e=>{rp(e),np(e)},Zb=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},ew=e=>{throw new Error("Action unknownAction should never be called")},tw=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],rw={doNothing:zb,insertFirst:Wu,insertLast:Vu,removeFirstItem:Qu,removeLastItem:Gu,removeFirstInsertLast:Wb,removeLastInsertFirst:Vb,removeFirstInsertFirst:Qb,removeLastInsertLast:Gb,removeExisting:rp,replaceExisting:Yb,alwaysWrong:Jb,insertAtSortPosition:np,removeExistingAndInsertAtSortPosition:Xb,runFullQueryAgain:Zb,unknownAction:ew},nw=40;function yc(e){return e.charCodeAt(0)-nw}function ow(e){return e?"1":"0"}function Dd(e,t){const r=[];for(let n=0,o=e.length;n<o;n+=t)r.push(e.substring(n,n+t));return r}function iw(e){const t=new Map,n=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,o=e.substring(2,n),i=Dd(o,2);for(let k=0;k<i.length;k++){const A=i[k],q=A.charAt(0),U=yc(A.charAt(1));t.set(q,U)}const c=e.substring(n,e.length-3),u=Dd(c,4);for(let k=0;k<u.length;k++){const A=u[k],q=A.charAt(0),U=A.charAt(1),G=A.charAt(2),ae=yc(A.charAt(3));if(!t.has(U))throw new Error("missing node with id "+U);if(!t.has(G))throw new Error("missing node with id "+G);const oe=t.get(U),te=t.get(G),Z={l:ae,0:oe,1:te};t.set(q,Z)}const d=e.slice(-3),p=d.charAt(0),m=d.charAt(1),v=yc(d.charAt(2)),b=t.get(p),_=t.get(m);return{l:v,0:b,1:_}}function aw(e,t,r){let n=e,o=e.l;for(;;){const i=t[o](r),c=ow(i);if(n=n[c],typeof n=="number"||typeof n=="string")return n;o=n.l}}const sw="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9Â¡bf9Â¢bq9Â£cg9Â¤ck9Â¥cn9Â¦nd9Â§np9Â¨nq9Â©nf9Âªng9Â«nm9Â¬nk9Â­mr9Â®ms9Â¯mt9Â°mj9Â±mk9Â²ml9Â³mn9Â´mc8ÂµÂ³{8Â¶Â¯}8Â·Â°Â¤8Â¸Â³Â§8Â¹mn8ÂºÂ³Â«8Â»Â³m8Â¼mÂ´4Â½zÂ²4Â¾Â³w4Â¿zÂµ4Ã€Â¯Â¶4ÃÂ°Â·4Ã‚Â³Âº4ÃƒÂ³Â¸4Ã„mÂ¹4Ã…vÂ¤7Ã†yn7Ã‡Ã€Ã7Ãˆ~7Ã‰Â¥Â¤7ÃŠÃƒÃ„7Ã‹Â¨n7ÃŒÂºÂ¹7ÃÂ­Â°7ÃŽÂ®m7ÃÂ¯Â°7ÃÂ±m7Ã‘Â³m7Ã’Â¼m5Ã“Ã„m5Ã”Â¹m5Ã•Â½Â°5Ã–Â¾m5Ã—Â¿Â°5Ã˜Ã‡Ã5Ã™Ã‚m5ÃšÃŠÃ‘5Ã›Â±m5ÃœÂºm5ÃÃŒÃ‘5ÃžÃ•Ã2ÃŸ|2Ã Â¡u2Ã¡Â£Ã…2Ã¢Ã–ÃŽ2Ã£Â¦Ã†2Ã¤Â©x2Ã¥ÂªÃ†2Ã¦Ã—Ã˜2Ã§|Ãˆ2Ã¨Â¡Â¢2Ã©Â£Ã‰2ÃªÂ¤Â¥2Ã«Ã™Ãš2Ã¬Â¦Ã‹2Ã­Â©n2Ã®Âªn2Ã¯Ã›Ã2Ã°ÃœÃ2Ã±Â¬n2Ã²Ã’Ã“/Ã³an/Ã´bn/Ãµcn/Ã¶ÃžÃ¢/Ã·ÃŸÃ£/Ã¸Ã Ã¤/Ã¹Ã¡Ã¥/ÃºÃ¦Ã«/Ã»Ã§Ã¬/Ã¼Ã¨Ã­/Ã½Ã©Ã®/Ã¾ÃÃŽ/Ã¿ÃÃ‘/Ä€Ã²Ã”,Äcn,Ä‚Ã¶Ã¯,ÄƒÂ¤Ã±,Ä„ÃºÃ°,Ä…ÃªÃ±,Ä†Ã¾Ã,Ä‡Ã¿Ã‘,Äˆac0Ä‰bc0ÄŠÃ³Ãµ0Ä‹Ã´Ä0ÄŒÃŸÃ¡0ÄÃ Â¤0ÄŽÃ§Ã©0ÄÃ¨Ãª0ÄÃ·Ã¹0Ä‘Ã¸Äƒ0Ä’Ã»Ã½0Ä“Ã¼Ä…0Ä”mÃ’-Ä•mÄ€-Ä–ÃžÃ¦-Ä—ÄŒÄŽ-Ä˜ÄÄ-Ä™Ä‚Ä„-ÄšÄÄ’-Ä›Ä‘Ä“-ÄœÂ²Â»-ÄÃÃ-ÄžÄ†Ä‡-ÄŸÂ²Â³-Ä Ä”Äˆ3Ä¡Ä•ÄŠ3Ä¢Ä–Ä—3Ä£Ä™Äš3Ä¤Ä¢Ä(Ä¥ÄœÄŸ(Ä¦Ä£Äž(Ä§Ä Ä¡+Ä¨Ä‰Ä‹+Ä©Ä¤Ä¦+ÄªÄ˜Ä›+Ä«Ä§Ä¨1Ä¬Ä©Äª1Ä­Ä¬Ä«*Ä®Ä¥m*Ä­Ä®.";let bc;function cw(){return bc||(bc=iw(sw)),bc}const uw=e=>aw(cw(),Kb,e);function lw(e){const t=uw(e);return tw[t]}function dw(e,t,r,n,o){const i=rw[e];return i({queryParams:t,changeEvent:r,previousResults:n,keyDocumentMap:o}),n}function fw(e,t){return!t.sort||t.sort.length===0?[e]:t.sort.map(r=>Object.keys(r)[0])}var hw=new WeakMap;function pw(e){return Kt(hw,e,()=>{var t=e.collection,r=ro(t.storageInstance.schema,lt(e.mangoQuery)),n=t.schema.primaryPath,o=Qh(t.schema.jsonSchema,r),i=(p,m)=>{var v={docA:p,docB:m};return o(v.docA,v.docB)},c=Ku(t.schema.jsonSchema,r),u=p=>{var m={doc:p};return c(m.doc)},d={primaryKey:e.collection.schema.primaryPath,skip:r.skip,limit:r.limit,sortFields:fw(n,r),sortComparator:i,queryMatcher:u};return d})}function mw(e,t){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var r=pw(e),n=fe(e._result).docsData.slice(0),o=fe(e._result).docsDataMap,i=!1,c=[],u=0;u<t.length;u++){var d=t[u],p=cy(d);p&&c.push(p)}var m=c.find(v=>{var b={queryParams:r,changeEvent:v,previousResults:n,keyDocumentMap:o},_=lw(b);if(_==="runFullQueryAgain")return!0;if(_!=="doNothing")return i=!0,dw(_,r,v,n,o),!1});return m?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:i,newResults:n}}var gw=function(){function e(){this._map=new Map}var t=e.prototype;return t.getByQuery=function(n){var o=n.toString(),i=Kt(this._map,o,()=>n);return i},e}();function vw(){return new gw}function xd(e,t){t.uncached=!0;var r=t.toString();e._map.delete(r)}function yw(e){return e.refCount$.observers.length}var bw=100,ww=30*1e3,_w=(e,t)=>(r,n)=>{if(!(n._map.size<e)){var o=St()-t,i=[],c=Array.from(n._map.values());for(var u of c)if(!(yw(u)>0)){if(u._lastEnsureEqual===0&&u._creationTime<o){xd(n,u);continue}i.push(u)}var d=i.length-e;if(!(d<=0)){var p=i.sort((v,b)=>v._lastEnsureEqual-b._lastEnsureEqual),m=p.slice(0,d);m.forEach(v=>xd(n,v))}}},op=_w(bw,ww),wc=new WeakSet;function Sw(e){wc.has(e)||(wc.add(e),Bg().then(()=>Kg(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),wc.delete(e)}))}var ip=function(){function e(r,n,o){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(i=>{var c=i.docId,u=this.cacheItemByDocId.get(c);u&&(u[0].delete(i.revisionHeight),u[0].size===0&&this.cacheItemByDocId.delete(c))}):void 0,this.primaryPath=r,this.changes$=n,this.documentCreator=o,n.subscribe(i=>{this.tasks.add(()=>{for(var c=this.cacheItemByDocId,u=0;u<i.length;u++){var d=i[u],p=c.get(d.documentId);if(p){var m=d.documentData;m||(m=d.previousDocumentData),p[1]=m}}}),this.tasks.size<=1&&us().then(()=>{this.processTasks()})})}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(o=>o()),this.tasks.clear()}},t.getLatestDocumentData=function(n){this.processTasks();var o=fo(this.cacheItemByDocId,n);return o[1]},t.getLatestDocumentDataIfExists=function(n){this.processTasks();var o=this.cacheItemByDocId.get(n);if(o)return o[1]},Gr(e,[{key:"getCachedRxDocuments",get:function(){var r=kd(this);return fr(this,"getCachedRxDocuments",r)}},{key:"getCachedRxDocument",get:function(){var r=kd(this);return fr(this,"getCachedRxDocument",n=>r([n])[0])}}])}();function kd(e){var t=e.primaryPath,r=e.cacheItemByDocId,n=e.registry,o=Ie.deepFreezeWhenDevMode,i=e.documentCreator,c=u=>{for(var d=new Array(u.length),p=[],m=0;m<u.length;m++){var v=u[m],b=v[t],_=Vr(v._rev),I=void 0,k=void 0,A=r.get(b);A?(I=A[0],k=I.get(_)):(I=new Map,A=[I,v],r.set(b,A));var q=k?k.deref():void 0;q||(v=o(v),q=i(v),I.set(_,Cw(q)),n&&p.push(q)),d[m]=q}return p.length>0&&n&&(e.tasks.add(()=>{for(var U=0;U<p.length;U++){var G=p[U];n.register(G,{docId:G.primary,revisionHeight:Vr(G.revision)})}}),e.tasks.size<=1&&us().then(()=>{e.processTasks()})),d};return c}function lu(e,t){var r=e.getCachedRxDocuments;return r(t)}var Iw=typeof WeakRef=="function",Cw=Iw?Ew:Dw;function Ew(e){return new WeakRef(e)}function Dw(e){return{deref(){return e}}}var Rd=function(){function e(r,n,o){this.time=St(),this.query=r,this.count=o,this.documents=lu(this.query.collection._docCache,n)}var t=e.prototype;return t.getValue=function(n){var o=this.query.op;if(o==="count")return this.count;if(o==="findOne"){var i=this.documents.length===0?null:this.documents[0];if(!i&&n)throw ee("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:o});return i}else return o==="findByIds"?this.docsMap:this.documents.slice(0)},Gr(e,[{key:"docsData",get:function(){return fr(this,"docsData",this.documents.map(r=>r._data))}},{key:"docsDataMap",get:function(){var r=new Map;return this.documents.forEach(n=>{r.set(n.primary,n._data)}),fr(this,"docsDataMap",r)}},{key:"docsMap",get:function(){for(var r=new Map,n=this.documents,o=0;o<n.length;o++){var i=n[o];r.set(i.primary,i)}return fr(this,"docsMap",r)}}])}(),xw=0,kw=function(){return++xw},ap=function(){function e(r,n,o,i={}){this.id=kw(),this._execOverDatabaseCount=0,this._creationTime=St(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new Lr(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=yr,this.op=r,this.mangoQuery=n,this.collection=o,this.other=i,n||(this.mangoQuery=Da()),this.isFindOneByIdQuery=Pw(this.collection.schema.primaryPath,n)}var t=e.prototype;return t._setResultData=function(n){if(typeof n>"u")throw ee("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof n=="number"){this._result=new Rd(this,[],n);return}else n instanceof Map&&(n=Array.from(n.values()));var o=new Rd(this,n,n.length);this._result=o},t._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var n=this.getPreparedQuery(),o=await this.collection.storageInstance.count(n);if(o.mode==="slow"&&!this.collection.database.allowSlowCount)throw ee("QU14",{collection:this.collection,queryObj:this.mangoQuery});return o.count}if(this.op==="findByIds"){var i=fe(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,c=new Map,u=[];if(i.forEach(m=>{var v=this.collection._docCache.getLatestDocumentDataIfExists(m);if(v){if(!v._deleted){var b=this.collection._docCache.getCachedRxDocument(v);c.set(m,b)}}else u.push(m)}),u.length>0){var d=await this.collection.storageInstance.findDocumentsById(u,!1);d.forEach(m=>{var v=this.collection._docCache.getCachedRxDocument(m);c.set(v.primary,v)})}return c}var p=Lw(this);return p.then(m=>m)},t.exec=async function(n){if(n&&this.op!=="findOne")throw ee("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await Od(this);var o=fe(this._result);return o.getValue(n)},t.toString=function(){var n=ja({op:this.op,query:ro(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),o=JSON.stringify(n);return this.toString=()=>o,o},t.getPreparedQuery=function(){var n={rxQuery:this,mangoQuery:ro(this.collection.schema.jsonSchema,this.mangoQuery)};n.mangoQuery.selector._deleted={$eq:!1},n.mangoQuery.index&&n.mangoQuery.index.unshift("_deleted"),pt("prePrepareQuery",n);var o=ms(this.collection.schema.jsonSchema,n.mangoQuery);return this.getPreparedQuery=()=>o,o},t.doesDocumentDataMatch=function(n){return n._deleted?!1:this.queryMatcher(n)},t.remove=async function(){var n=await this.exec();if(Array.isArray(n)){var o=await this.collection.bulkRemove(n);if(o.error.length>0)throw Ff(o.error[0]);return o.success}else return n.remove()},t.incrementalRemove=function(){return Hn(this.asRxQuery,n=>n.incrementalRemove())},t.update=function(n){throw xe("update")},t.patch=function(n){return Hn(this.asRxQuery,o=>o.patch(n))},t.incrementalPatch=function(n){return Hn(this.asRxQuery,o=>o.incrementalPatch(n))},t.modify=function(n){return Hn(this.asRxQuery,o=>o.modify(n))},t.incrementalModify=function(n){return Hn(this.asRxQuery,o=>o.incrementalModify(n))},t.where=function(n){throw xe("query-builder")},t.sort=function(n){throw xe("query-builder")},t.skip=function(n){throw xe("query-builder")},t.limit=function(n){throw xe("query-builder")},Gr(e,[{key:"$",get:function(){if(!this._$){var r=this.collection.eventBulks$.pipe(ke(n=>!n.isLocal),Pi(null),wr(()=>Od(this)),He(()=>this._result),Li(Di),li((n,o)=>!!(n&&n.time===fe(o).time)),ke(n=>!!n),He(n=>fe(n).getValue()));this._$=ly(r,this.refCount$.pipe(ke(()=>!1)))}return this._$}},{key:"$$",get:function(){var r=this.collection.database.getReactivityFactory();return r.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var r=this.collection.schema.jsonSchema,n=ro(this.collection.schema.jsonSchema,this.mangoQuery);return fr(this,"queryMatcher",Ku(r,n))}},{key:"asRxQuery",get:function(){return this}}])}();function Da(){return{selector:{}}}function Rw(e){return e.collection._queryCache.getByQuery(e)}function zn(e,t,r,n){pt("preCreateRxQuery",{op:e,queryObj:t,collection:r,other:n});var o=new ap(e,t,r,n);return o=Rw(o),Sw(r),o}function sp(e){var t=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=t}async function Od(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(t=>t())),e.collection.database.closed||sp(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>Ow(e)),e._ensureEqualQueue)}function Ow(e){if(e._lastEnsureEqual=St(),e.collection.database.closed||sp(e))return yr;var t=!1,r=!1;if(e._latestChangeEvent===-1&&(r=!0),!r){var n=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(n===null)r=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var o=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(n);if(e.op==="count"){var i=fe(e._result).count,c=i;o.forEach(d=>{var p=d.previousDocumentData&&e.doesDocumentDataMatch(d.previousDocumentData),m=e.doesDocumentDataMatch(d.documentData);!p&&m&&c++,p&&!m&&c--}),c!==i&&(t=!0,e._setResultData(c))}else{var u=mw(e,o);u.runFullQueryAgain?r=!0:u.changed&&(t=!0,e._setResultData(u.newResults))}}}return r?e._execOverDatabase().then(d=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof d=="number"?((!e._result||d!==e._result.count)&&(t=!0,e._setResultData(d)),t):((!e._result||!Ng(e.collection.schema.primaryPath,d,e._result.docsData))&&(t=!0,e._setResultData(d)),t))):Promise.resolve(t)}async function Lw(e){var t=[],r=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var n=e.isFindOneByIdQuery;if(n=n.filter(m=>{var v=e.collection._docCache.getLatestDocumentDataIfExists(m);return v?(v._deleted||t.push(v),!1):!0}),n.length>0){var o=await r.storageInstance.findDocumentsById(n,!1);kn(t,o)}}else{var i=e.isFindOneByIdQuery,c=e.collection._docCache.getLatestDocumentDataIfExists(i);if(!c){var u=await r.storageInstance.findDocumentsById([i],!1);u[0]&&(c=u[0])}c&&!c._deleted&&t.push(c)}else{var d=e.getPreparedQuery(),p=await r.storageInstance.query(d);t=p.documents}return t}function Pw(e,t){if(!t.skip&&t.selector&&Object.keys(t.selector).length===1&&t.selector[e]){var r=t.selector[e];if(typeof r=="string")return r;if(Object.keys(r).length===1&&typeof r.$eq=="string"||Object.keys(r).length===1&&Array.isArray(r.$eq)&&!r.$eq.find(n=>typeof n!="string"))return r.$eq}return!1}var In="collection",Yu="storage-token",xa="rx-migration-status",$w="rx-pipeline-checkpoint",Aw="RxInternalDocument",Ju=ds({version:0,title:Aw,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[In,Yu,xa,$w,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function bo(e,t){return Pn(Ju,{key:e,context:t})}async function cp(e){var t=ms(e.schema,{selector:{context:In,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),r=await e.query(t),n=r.documents;return n}var up="storageToken",Mw=bo(up,Yu);async function Tw(e){var t=Ei(10),r=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,n={id:Mw,context:Yu,key:up,data:{rxdbVersion:e.rxdbVersion,token:t,instanceToken:e.token,passwordHash:r},_deleted:!1,_meta:So(),_rev:jt(),_attachments:{}},o=[{document:n}],i=await e.internalStore.bulkWrite(o,"internal-add-storage-token");if(!i.error[0])return Nt("id",o,i)[0];var c=fe(i.error[0]);if(c.isError&&ls(c)){var u=c;if(!Nw(u.documentInDb.data.rxdbVersion,e.rxdbVersion))throw ee("DM5",{args:{database:e.name,databaseStateVersion:u.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(r&&r!==u.documentInDb.data.passwordHash)throw ee("DB1",{passwordHash:r,existingPasswordHash:u.documentInDb.data.passwordHash});var d=u.documentInDb;return fe(d)}throw c}function Nw(e,t){if(!e)return!1;var r=e.split(".")[0],n=t.split(".")[0];return r==="15"&&n==="16"?!0:r===n}async function qw(e,t,r){if(e.schema.version!==r.version)throw ee("SNH",{schema:r,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:t}});for(var n=du(e.name,e.schema.jsonSchema),o=bo(n,In);;){var i=await Mi(e.database.internalStore,o),c=lt(fe(i)),u=c.data.connectedStorages.find(d=>d.collectionName===t&&d.schema.version===r.version);if(u)return;c.data.connectedStorages.push({collectionName:t,schema:r});try{await yi(e.database.internalStore,{previous:fe(i),document:c},"add-connected-storage-to-collection")}catch(d){if(!ls(d))throw d}}}function du(e,t){return e+"-"+t.version}function ma(e,t){return t=Ne(t),t=sv(e,t),typeof e.jsonSchema.primaryKey!="string"&&(t=rv(e.primaryPath,e.jsonSchema,t)),t._meta=So(),Object.prototype.hasOwnProperty.call(t,"_deleted")||(t._deleted=!1),Object.prototype.hasOwnProperty.call(t,"_attachments")||(t._attachments={}),Object.prototype.hasOwnProperty.call(t,"_rev")||(t._rev=jt()),t}async function Bw(e,t){t.multiInstance=e.multiInstance;var r=await e.storage.createStorageInstance(t);return r}async function lp(e,t,r,n,o,i,c,u){var d=await cp(t),p=d.filter(_=>_.data.name===o),m=[];p.forEach(_=>{m.push({collectionName:_.data.name,schema:_.data.schema,isCollection:!0}),_.data.connectedStorages.forEach(I=>m.push({collectionName:I.collectionName,isCollection:!1,schema:I.schema}))});var v=new Set;if(m=m.filter(_=>{var I=_.collectionName+"||"+_.schema.version;return v.has(I)?!1:(v.add(I),!0)}),await Promise.all(m.map(async _=>{var I=await e.createStorageInstance({collectionName:_.collectionName,databaseInstanceToken:r,databaseName:n,multiInstance:i,options:{},schema:_.schema,password:c,devMode:Ie.isDevMode()});await I.remove(),_.isCollection&&await xi("postRemoveRxCollection",{storage:e,databaseName:n,collectionName:o})})),u){var b=p.map(_=>{var I=Ti(_);return I._deleted=!0,I._meta.lwt=St(),I._rev=vr(r,_),{previous:_,document:I}});await t.bulkWrite(b,"rx-database-remove-collection-all")}}function kt(e){if(e.closed)throw ee("COL21",{collection:e.name,version:e.schema.version})}var Fw=function(){function e(r){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=r,this.subs.push(this.collection.eventBulks$.pipe(ke(n=>!n.isLocal)).subscribe(n=>{this.tasks.add(()=>this._handleChangeEvents(n.events)),this.tasks.size<=1&&us().then(()=>{this.processTasks()})}))}var t=e.prototype;return t.processTasks=function(){if(this.tasks.size!==0){var n=Array.from(this.tasks);n.forEach(o=>o()),this.tasks.clear()}},t._handleChangeEvents=function(n){var o=this.counter;this.counter=this.counter+n.length,n.length>this.limit?this.buffer=n.slice(n.length*-1):(kn(this.buffer,n),this.buffer=this.buffer.slice(this.limit*-1));for(var i=o+1,c=this.eventCounterMap,u=0;u<n.length;u++){var d=n[u];c.set(d,i+u)}},t.getCounter=function(){return this.processTasks(),this.counter},t.getBuffer=function(){return this.processTasks(),this.buffer},t.getArrayIndexByPointer=function(n){this.processTasks();var o=this.buffer[0],i=this.eventCounterMap.get(o);if(n<i)return null;var c=n-i;return c},t.getFrom=function(n){this.processTasks();var o=[],i=this.getArrayIndexByPointer(n);if(i===null)return null;for(;;){var c=this.buffer[i];if(i++,c)o.push(c);else return o}},t.runFrom=function(n,o){this.processTasks();var i=this.getFrom(n);if(i===null)throw new Error("out of bounds");i.forEach(c=>o(c))},t.reduceByLastOfDoc=function(n){return this.processTasks(),n.slice(0)},t.close=function(){this.tasks.clear(),this.subs.forEach(n=>n.unsubscribe())},e}();function Uw(e){return new Fw(e)}var jw=new WeakMap;function Kw(e){var t=e.schema.getDocumentPrototype(),r=Ww(e),n=gs,o={};return[t,r,n].forEach(i=>{var c=Object.getOwnPropertyNames(i);c.forEach(u=>{var d=Object.getOwnPropertyDescriptor(i,u),p=!0;(u.startsWith("_")||u.endsWith("_")||u.startsWith("$")||u.endsWith("$"))&&(p=!1),typeof d.value=="function"?Object.defineProperty(o,u,{get(){return d.value.bind(this)},enumerable:p,configurable:!1}):(d.enumerable=p,d.configurable=!1,d.writable&&(d.writable=!1),Object.defineProperty(o,u,d))})}),o}function Hw(e){return Kt(jw,e,()=>Xh(Kw(e)))}function zw(e,t,r){var n=Ib(t,e,Ie.deepFreezeWhenDevMode(r));return e._runHooksSync("post","create",r,n),pt("postCreateRxDocument",n),n}function Ww(e){var t={};return Object.entries(e.methods).forEach(([r,n])=>{t[r]=n}),t}var Wa={isEqual(e,t){return si(Jt(e),Jt(t))},resolve(e){return e.realMasterState}},dp=["pre","post"],fp=["insert","save","remove","create"],Ld=!1,Wn=new Set,hp=function(){function e(r,n,o,i,c={},u={},d={},p={},m={},v=op,b={},_=Wa){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=vw(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=r,this.name=n,this.schema=o,this.internalStorageInstance=i,this.instanceCreationOptions=c,this.migrationStrategies=u,this.methods=d,this.attachments=p,this.options=m,this.cacheReplacementPolicy=v,this.statics=b,this.conflictHandler=_,Vw(this.asRxCollection),r&&(this.eventBulks$=r.eventBulks$.pipe(ke(I=>I.collectionName===this.name))),this.database&&Wn.add(this)}var t=e.prototype;return t.prepare=async function(){if(!await Tf()){for(var n=0;n<10&&Wn.size>ad;)n++,await this.promiseWait(30);if(Wn.size>ad)throw ee("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(Wn.values()).map(d=>({db:d.database?d.database.name:"",c:d.name}))}})}this.storageInstance=Hu(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new Jh(this.storageInstance,this.schema.primaryPath,(d,p)=>Zh(this,d,p),d=>this._runHooks("post","save",d)),this.$=this.eventBulks$.pipe(wr(d=>uh(d))),this.checkpoint$=this.eventBulks$.pipe(He(d=>d.checkpoint)),this._changeEventBuffer=Uw(this.asRxCollection);var o;this._docCache=new ip(this.schema.primaryPath,this.eventBulks$.pipe(ke(d=>!d.isLocal),He(d=>d.events)),d=>(o||(o=Hw(this.asRxCollection)),zw(this.asRxCollection,o,d)));var i=this.database.internalStore.changeStream().pipe(ke(d=>{var p=this.name+"-"+this.schema.version,m=d.events.find(v=>v.documentData.context==="collection"&&v.documentData.key===p&&v.operation==="DELETE");return!!m})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(d=>d()))});this._subs.push(i);var c=await this.database.storageToken,u=this.storageInstance.changeStream().subscribe(d=>{var p={id:d.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:c,events:d.events,databaseToken:this.database.token,checkpoint:d.checkpoint,context:d.context};this.database.$emit(p)});return this._subs.push(u),Lt},t.cleanup=function(n){throw kt(this),xe("cleanup")},t.migrationNeeded=function(){throw xe("migration-schema")},t.getMigrationState=function(){throw xe("migration-schema")},t.startMigration=function(n=10){return kt(this),this.getMigrationState().startMigration(n)},t.migratePromise=function(n=10){return this.getMigrationState().migratePromise(n)},t.insert=async function(n){kt(this);var o=await this.bulkInsert([n]),i=o.error[0];za(this,n[this.schema.primaryPath],n,i);var c=fe(o.success[0]);return c},t.insertIfNotExists=async function(n){var o=await this.bulkInsert([n]);if(o.error.length>0){var i=o.error[0];if(i.status===409){var c=i.documentInDb;return lu(this._docCache,[c])[0]}else throw i}return o.success[0]},t.bulkInsert=async function(n){if(kt(this),n.length===0)return{success:[],error:[]};var o=this.schema.primaryPath,i=new Set,c;if(this.hasHooks("pre","insert"))c=await Promise.all(n.map(A=>{var q=ma(this.schema,A);return this._runHooks("pre","insert",q).then(()=>(i.add(q[o]),{document:q}))}));else{c=new Array(n.length);for(var u=this.schema,d=0;d<n.length;d++){var p=n[d],m=ma(u,p);i.add(m[o]),c[d]={document:m}}}if(i.size!==n.length)throw ee("COL22",{collection:this.name,args:{documents:n}});var v=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-insert"),b,_=this,I={get success(){if(!b){var A=Nt(_.schema.primaryPath,c,v);b=lu(_._docCache,A)}return b},error:v.error};if(this.hasHooks("post","insert")){var k=new Map;c.forEach(A=>{var q=A.document;k.set(q[o],q)}),await Promise.all(I.success.map(A=>this._runHooks("post","insert",k.get(A.primary),A)))}return I},t.bulkRemove=async function(n){kt(this);var o=this.schema.primaryPath;if(n.length===0)return{success:[],error:[]};var i;typeof n[0]=="string"?i=await this.findByIds(n).exec():(i=new Map,n.forEach(_=>i.set(_.primary,_)));var c=[],u=new Map;Array.from(i.values()).forEach(_=>{var I=_.toMutableJSON(!0);c.push(I),u.set(_.primary,I)}),await Promise.all(c.map(_=>{var I=_[this.schema.primaryPath];return this._runHooks("pre","remove",_,i.get(I))}));var d=c.map(_=>{var I=Ne(_);return I._deleted=!0,{previous:_,document:I}}),p=await this.storageInstance.bulkWrite(d,"rx-collection-bulk-remove"),m=Nt(this.schema.primaryPath,d,p),v=[],b=m.map(_=>{var I=_[o],k=this._docCache.getCachedRxDocument(_);return v.push(k),I});return await Promise.all(b.map(_=>this._runHooks("post","remove",u.get(_),i.get(_)))),{success:v,error:p.error}},t.bulkUpsert=async function(n){kt(this);var o=[],i=new Map;n.forEach(p=>{var m=ma(this.schema,p),v=m[this.schema.primaryPath];if(!v)throw ee("COL3",{primaryPath:this.schema.primaryPath,data:m,schema:this.schema.jsonSchema});i.set(v,m),o.push(m)});var c=await this.bulkInsert(o),u=c.success.slice(0),d=[];return await Promise.all(c.error.map(async p=>{if(p.status!==409)d.push(p);else{var m=p.documentId,v=fo(i,m),b=fe(p.documentInDb),_=this._docCache.getCachedRxDocuments([b])[0],I=await _.incrementalModify(()=>v);u.push(I)}})),{error:d,success:u}},t.upsert=async function(n){kt(this);var o=await this.bulkUpsert([n]);return za(this.asRxCollection,n[this.schema.primaryPath],n,o.error[0]),o.success[0]},t.incrementalUpsert=function(n){kt(this);var o=ma(this.schema,n),i=o[this.schema.primaryPath];if(!i)throw ee("COL4",{data:n});var c=this._incrementalUpsertQueues.get(i);return c||(c=Lt),c=c.then(()=>Gw(this,i,o)).then(u=>u.inserted?u.doc:Qw(u.doc,o)),this._incrementalUpsertQueues.set(i,c),c},t.find=function(n){kt(this),pt("prePrepareRxQuery",{op:"find",queryObj:n,collection:this}),n||(n=Da());var o=zn("find",n,this);return o},t.findOne=function(n){kt(this),pt("prePrepareRxQuery",{op:"findOne",queryObj:n,collection:this});var o;if(typeof n=="string")o=zn("findOne",{selector:{[this.schema.primaryPath]:n},limit:1},this);else{if(n||(n=Da()),n.limit)throw ee("QU6");n=Ne(n),n.limit=1,o=zn("findOne",n,this)}return o},t.count=function(n){kt(this),n||(n=Da());var o=zn("count",n,this);return o},t.findByIds=function(n){kt(this);var o={selector:{[this.schema.primaryPath]:{$in:n.slice(0)}}},i=zn("findByIds",o,this);return i},t.exportJSON=function(){throw xe("json-dump")},t.importJSON=function(n){throw xe("json-dump")},t.insertCRDT=function(n){throw xe("crdt")},t.addPipeline=function(n){throw xe("pipeline")},t.addHook=function(n,o,i,c=!1){if(typeof i!="function")throw Rt("COL7",{key:o,when:n});if(!dp.includes(n))throw Rt("COL8",{key:o,when:n});if(!fp.includes(o))throw ee("COL9",{key:o});if(n==="post"&&o==="create"&&c===!0)throw ee("COL10",{when:n,key:o,parallel:c});var u=i.bind(this),d=c?"parallel":"series";this.hooks[o]=this.hooks[o]||{},this.hooks[o][n]=this.hooks[o][n]||{series:[],parallel:[]},this.hooks[o][n][d].push(u)},t.getHooks=function(n,o){return!this.hooks[o]||!this.hooks[o][n]?{series:[],parallel:[]}:this.hooks[o][n]},t.hasHooks=function(n,o){if(!this.hooks[o]||!this.hooks[o][n])return!1;var i=this.getHooks(n,o);return i?i.series.length>0||i.parallel.length>0:!1},t._runHooks=function(n,o,i,c){var u=this.getHooks(n,o);if(!u)return Lt;var d=u.series.map(p=>()=>p(i,c));return Hg(d).then(()=>Promise.all(u.parallel.map(p=>p(i,c))))},t._runHooksSync=function(n,o,i,c){if(this.hasHooks(n,o)){var u=this.getHooks(n,o);u&&u.series.forEach(d=>d(i,c))}},t.promiseWait=function(n){var o=new Promise(i=>{var c=setTimeout(()=>{this.timeouts.delete(c),i()},n);this.timeouts.add(c)});return o},t.close=async function(){return this.closed?yr:(Wn.delete(this),await Promise.all(this.onClose.map(n=>n())),this.closed=!0,Array.from(this.timeouts).forEach(n=>clearTimeout(n)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(n=>n.unsubscribe()),delete this.database.collections[this.name],xi("postCloseRxCollection",this).then(()=>!0))))},t.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(n=>n())),await lp(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},Gr(e,[{key:"insert$",get:function(){return this.$.pipe(ke(r=>r.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(ke(r=>r.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(ke(r=>r.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])}();function Vw(e){if(!Ld){Ld=!0;var t=Object.getPrototypeOf(e);fp.forEach(r=>{dp.map(n=>{var o=n+Lf(r);t[o]=function(i,c){return this.addHook(n,r,i,c)}})})}}function Qw(e,t){return e.incrementalModify(r=>t)}function Gw(e,t,r){var n=e._docCache.getLatestDocumentDataIfExists(t);return n?Promise.resolve({doc:e._docCache.getCachedRxDocuments([n])[0],inserted:!1}):e.findOne(t).exec().then(o=>o?{doc:o,inserted:!1}:e.insert(r).then(i=>({doc:i,inserted:!0})))}function Yw({database:e,name:t,schema:r,instanceCreationOptions:n={},migrationStrategies:o={},autoMigrate:i=!0,statics:c={},methods:u={},attachments:d={},options:p={},localDocuments:m=!1,cacheReplacementPolicy:v=op,conflictHandler:b=Wa}){var _={databaseInstanceToken:e.token,databaseName:e.name,collectionName:t,schema:r.jsonSchema,options:n,multiInstance:e.multiInstance,password:e.password,devMode:Ie.isDevMode()};return pt("preCreateRxStorageInstance",_),Bw(e,_).then(I=>{var k=new hp(e,t,r,I,n,o,u,d,p,v,c,b);return k.prepare().then(()=>{Object.entries(c).forEach(([q,U])=>{Object.defineProperty(k,q,{get:()=>U.bind(k)})});var A=Lt;return i&&k.schema.version!==0&&(A=k.migratePromise()),A}).then(()=>(pt("createRxCollection",{collection:k,creator:{name:t,schema:r,storageInstance:I,instanceCreationOptions:n,migrationStrategies:o,methods:u,attachments:d,options:p,cacheReplacementPolicy:v,localDocuments:m,statics:c}}),k)).catch(A=>(Wn.delete(k),I.close().then(()=>Promise.reject(A))))})}var pp=function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=t||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};pp.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,fu(this)},wrapCall:function(t){var r=this;this.lock();var n;try{n=t()}catch(o){throw this.unlock(),o}return!n.then||typeof n.then!="function"?(this.unlock(),n):n.then(function(o){return r.unlock(),o}).catch(function(o){throw r.unlock(),o})},requestIdlePromise:function(t){var r=this;t=t||{};var n,o=new Promise(function(u){return n=u}),i=function(){_c(r,o),n()};if(o._manRes=i,t.timeout){var c=setTimeout(function(){o._manRes()},t.timeout);o._timeoutObj=c}return this._iC.add(o),fu(this),o},cancelIdlePromise:function(t){_c(this,t)},requestIdleCallback:function(t,r){var n=this._lHN++,o=this.requestIdlePromise(r);return this._hPM.set(n,o),this._pHM.set(o,n),o.then(function(){return t()}),n},cancelIdleCallback:function(t){var r=this._hPM.get(t);this.cancelIdlePromise(r)},clear:function(){var t=this;this._iC.forEach(function(r){return _c(t,r)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function Jw(e){if(e._iC.size!==0){var t=e._iC.values(),r=t.next().value;r._manRes(),setTimeout(function(){return fu(e)},0)}}function _c(e,t){if(t){if(t._timeoutObj&&clearTimeout(t._timeoutObj),e._pHM.has(t)){var r=e._pHM.get(t);e._hPM.delete(r),e._pHM.delete(t)}e._iC.delete(t)}}function fu(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}Jw(e),e._tryIR=!1},0)},0))}class Xu{constructor(t){fa(this,"ttl");fa(this,"map",new Map);fa(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,mp()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Xw(this)},0))}clear(){this.map.clear()}}function Xw(e){const t=mp()-e.ttl,r=e.map[Symbol.iterator]();for(;;){const n=r.next().value;if(!n)return;const o=n[0];if(n[1]<t)e.map.delete(o);else return}}function mp(){return Date.now()}var hu=new Set,Pd=new Map,Zu=function(){function e(r,n,o,i,c,u,d=!1,p={},m,v,b,_,I,k){this.idleQueue=new pp,this.rxdbVersion=Mf,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new Pt,this.closePromise=null,this.observable$=this.eventBulks$.pipe(wr(A=>uh(A))),this.storageToken=yr,this.storageTokenDocument=yr,this.emittedEventBulkIds=new Xu(60*1e3),this.name=r,this.token=n,this.storage=o,this.instanceCreationOptions=i,this.password=c,this.multiInstance=u,this.eventReduce=d,this.options=p,this.internalStore=m,this.hashFunction=v,this.cleanupPolicy=b,this.allowSlowCount=_,this.reactivity=I,this.onClosed=k,this.name!=="pseudoInstance"&&(this.internalStore=Hu(this.asRxDatabase,m,Ju),this.storageTokenDocument=Tw(this.asRxDatabase).catch(A=>this.startupErrors.push(A)),this.storageToken=this.storageTokenDocument.then(A=>A.data.token).catch(A=>this.startupErrors.push(A)))}var t=e.prototype;return t.getReactivityFactory=function(){if(!this.reactivity)throw ee("DB14",{database:this.name});return this.reactivity},t.$emit=function(n){this.emittedEventBulkIds.has(n.id)||(this.emittedEventBulkIds.add(n.id),this.eventBulks$.next(n))},t.removeCollectionDoc=async function(n,o){var i=await Mi(this.internalStore,bo(du(n,o),In));if(!i)throw ee("SNH",{name:n,schema:o});var c=Ti(i);c._deleted=!0,await this.internalStore.bulkWrite([{document:c,previous:i}],"rx-database-remove-collection")},t.addCollections=async function(n){var o={},i={},c=[],u={};await Promise.all(Object.entries(n).map(async([m,v])=>{var b=m,_=v.schema;o[b]=_;var I=lv(_,this.hashFunction);if(i[b]=I,this.collections[m])throw ee("DB3",{name:m});var k=du(m,_),A={id:bo(k,In),key:k,context:In,data:{name:b,schemaHash:await I.hash,schema:I.jsonSchema,version:I.version,connectedStorages:[]},_deleted:!1,_meta:So(),_rev:jt(),_attachments:{}};c.push({document:A});var q=Object.assign({},v,{name:b,schema:I,database:this}),U=Ne(v);U.database=this,U.name=m,pt("preCreateRxCollection",U),q.conflictHandler=U.conflictHandler,u[b]=q}));var d=await this.internalStore.bulkWrite(c,"rx-database-add-collection");await r0(this),await Promise.all(d.error.map(async m=>{if(m.status!==409)throw ee("DB12",{database:this.name,writeError:m});var v=fe(m.documentInDb),b=v.data.name,_=i[b];if(v.data.schemaHash!==await _.hash)throw ee("DB6",{database:this.name,collection:b,previousSchemaHash:v.data.schemaHash,schemaHash:await _.hash,previousSchema:v.data.schema,schema:fe(o[b])})}));var p={};return await Promise.all(Object.keys(n).map(async m=>{var v=u[m],b=await Yw(v);p[m]=b,this.collections[m]=b,this[m]||Object.defineProperty(this,m,{get:()=>this.collections[m]})})),p},t.lockedRun=function(n){return this.idleQueue.wrapCall(n)},t.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},t.exportJSON=function(n){throw xe("json-dump")},t.addState=function(n){throw xe("state")},t.importJSON=function(n){throw xe("json-dump")},t.backup=function(n){throw xe("backup")},t.leaderElector=function(){throw xe("leader-election")},t.isLeader=function(){throw xe("leader-election")},t.waitForLeadership=function(){throw xe("leader-election")},t.migrationStates=function(){throw xe("migration-schema")},t.close=function(){if(this.closePromise)return this.closePromise;var{promise:n,resolve:o}=gp(),i=c=>{this.onClosed&&this.onClosed(),this.closed=!0,o(c)};return this.closePromise=n,(async()=>{if(await xi("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(c=>c.unsubscribe()),this.name==="pseudoInstance"){i(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(c=>c()))).then(()=>Promise.all(Object.keys(this.collections).map(c=>this.collections[c]).map(c=>c.close()))).then(()=>this.internalStore.close()).then(()=>i(!0))})(),n},t.remove=function(){return this.close().then(()=>e0(this.name,this.storage,this.multiInstance,this.password))},Gr(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])}();function Zw(e,t){if(hu.has(vp(e,t)))throw ee("DB8",{name:e,storage:t.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function gp(){var e,t,r=new Promise((n,o)=>{e=n,t=o});return{promise:r,resolve:e,reject:t}}function vp(e,t){return t.name+"|"+e}async function yp(e,t,r,n,o,i){var c=await t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:pb,schema:Ju,options:n,multiInstance:o,password:i,devMode:Ie.isDevMode()});return c}function $d({storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:o=!0,eventReduce:i=!0,ignoreDuplicate:c=!1,options:u={},cleanupPolicy:d,closeDuplicates:p=!1,allowSlowCount:m=!1,localDocuments:v=!1,hashFunction:b=Of,reactivity:_}){pt("preCreateRxDatabase",{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:o,eventReduce:i,ignoreDuplicate:c,options:u,localDocuments:v});var I=vp(r,e),k=Pd.get(I)||new Set,A=gp(),q=Array.from(k),U=()=>{k.delete(A.promise),hu.delete(I)};return k.add(A.promise),Pd.set(I,k),(async()=>{if(p&&await Promise.all(q.map(te=>te.catch(()=>null).then(Z=>Z&&Z.close()))),c){if(!Ie.isDevMode())throw ee("DB9",{database:r})}else Zw(r,e);hu.add(I);var G=Ei(10),ae=await yp(G,e,r,t,o,n),oe=new Zu(r,G,e,t,n,o,i,u,ae,b,d,m,_,U);return await xi("createRxDatabase",{database:oe,creator:{storage:e,instanceCreationOptions:t,name:r,password:n,multiInstance:o,eventReduce:i,ignoreDuplicate:c,options:u,localDocuments:v}}),oe})().then(G=>{A.resolve(G)}).catch(G=>{A.reject(G),U()}),A.promise}async function e0(e,t,r=!0,n){var o=Ei(10),i=await yp(o,t,e,{},r,n),c=await cp(i),u=new Set;c.forEach(p=>u.add(p.data.name));var d=Array.from(u);return await Promise.all(d.map(p=>lp(t,i,o,e,p,r,n))),await xi("postRemoveRxDatabase",{databaseName:e,storage:t}),await i.remove(),d}function t0(e){return e instanceof Zu}async function r0(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var n0={RxSchema:jf.prototype,RxDocument:gs,RxQuery:ap.prototype,RxCollection:hp.prototype,RxDatabase:Zu.prototype},Sc=new Set,Ad=new Set;function ka(e){if(pt("preAddRxPlugin",{plugin:e,plugins:Sc}),!Sc.has(e)){{if(Ad.has(e.name))throw ee("PL3",{name:e.name,plugin:e});Sc.add(e),Ad.add(e.name)}if(!e.rxdb)throw Rt("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([t,r])=>r(n0[t])),e.overwritable&&Object.assign(Ie,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([t,r])=>{r.after&&ui[t].push(r.after),r.before&&ui[t].unshift(r.before)})}}async function Va(e,t){var r=Pn(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:t}),n=await e.input.metaInstance.findDocumentsById([r],!1),o=n[0];if(e.lastCheckpointDoc[t]=o,o)return o.checkpointData}async function Qa(e,t,r){e.checkpointQueue=e.checkpointQueue.then(async()=>{var n=e.lastCheckpointDoc[t];if(r&&!e.events.canceled.getValue()&&(!n||JSON.stringify(n.checkpointData)!==JSON.stringify(r))){var o={id:"",isCheckpoint:"1",itemId:t,_deleted:!1,_attachments:{},checkpointData:r,_meta:So(),_rev:jt()};for(o.id=Pn(e.input.metaInstance.schema,o);!e.events.canceled.getValue();){if(n&&(o.checkpointData=bi([n.checkpointData,o.checkpointData])),o._meta.lwt=St(),o._rev=vr(await e.checkpointKey,n),e.events.canceled.getValue())return;var i=[{previous:n,document:o}],c=await e.input.metaInstance.bulkWrite(i,"replication-set-checkpoint"),u=Nt(e.primaryPath,i,c)[0];if(u){e.lastCheckpointDoc[t]=u;return}else{var d=c.error[0];if(d.status!==409)throw d;n=fe(d.documentInDb),o._rev=vr(await e.checkpointKey,n)}}}}),await e.checkpointQueue}async function o0(e){var t=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+t}function Md(e,t,r,n,o){var i=Object.assign({},n,{_attachments:t&&n._attachments?n._attachments:{},_meta:r?n._meta:Object.assign({},o?o._meta:{},{lwt:St()}),_rev:r?n._rev:jt()});return i._rev||(i._rev=vr(e,o)),i}function Pr(e,t,r){var n=Ne(e);return t||delete n._attachments,r||(delete n._meta,delete n._rev),n}function pu(e,t){return e.hasAttachments?t.map(r=>{var n=lt(r.document);return n.docData=Jt(n.docData),{document:n,previous:r.previous}}):t}function mu(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Ra="RxReplicationProtocolMetaData";function Td(e,t){var r=nv(e),n={title:Ra,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:r+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:r>4?r:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};t&&(n.encrypted=["docData"]);var o=ds(n);return o}function bp(e,t){return e.input.metaInstance.findDocumentsById(t.map(r=>{var n=Pn(e.input.metaInstance.schema,{itemId:r,isCheckpoint:"0"});return n}),!0).then(r=>{var n={};return Object.values(r).forEach(o=>{n[o.itemId]={docData:o.docData,metaDocument:o}}),n})}async function Ga(e,t,r,n){var o=t[e.primaryPath],i=r?Ti(r):{id:"",isCheckpoint:"0",itemId:o,docData:t,_attachments:{},_deleted:!1,_rev:jt(),_meta:{lwt:0}};i.docData=t,n&&(i.isResolvedConflict=n),i._meta.lwt=St(),i.id=Pn(e.input.metaInstance.schema,i),i._rev=vr(await e.checkpointKey,r);var c={previous:r,document:i};return c}async function i0(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var t=await Va(e,"down");t||await Qa(e,"down",e.input.initialCheckpoint.downstream)}var r=await e.input.hashFunction(e.input.identifier),n=e.input.replicationHandler,o=0,i=[];function c(I){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var k={time:o++,task:I};i.push(k),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var A=[];i.length>0;){e.events.active.down.next(!0);var q=fe(i.shift());if(!(q.time<d)){if(q.task==="RESYNC")if(A.length===0){A.push(q.task);break}else break;A.push(q.task)}}if(A.length!==0)return A[0]==="RESYNC"?p():m(A)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(c("RESYNC"),!e.events.canceled.getValue()){var u=n.masterChangeStream$.pipe(wr(async I=>(await Sn(e.events.active.up.pipe(ke(k=>!k))),I))).subscribe(I=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,c(I)});Sn(e.events.canceled.pipe(ke(I=>!!I))).then(()=>u.unsubscribe())}var d=-1;async function p(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Va(e,"down"));for(var I=await e.checkpointQueue,k=[];!e.events.canceled.getValue();){d=o++;var A=await n.masterChangesSince(I,e.input.pullBatchSize);if(A.documents.length===0||(I=bi([I,A.checkpoint]),k.push(_(A.documents,I)),A.documents.length<e.input.pullBatchSize))break}await Promise.all(k)}}function m(I){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var k=[],A=null;return I.forEach(q=>{if(q==="RESYNC")throw new Error("SNH");kn(k,q.documents),A=bi([A,q.checkpoint])}),_(k,fe(A))}var v=Lt,b={docs:{}};function _(I,k){var A=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,I.forEach(q=>{var U=q[A];b.docs[U]=q}),b.checkpoint=k,v=v.then(()=>{var q=b.docs;b.docs={};var U=b.checkpoint,G=Object.keys(q);if(e.events.canceled.getValue()||G.length===0)return Lt;var ae=[],oe={},te={},Z=[];return Promise.all([e.input.forkInstance.findDocumentsById(G,!0),bp(e,G)]).then(([ce,he])=>{var Ee=new Map;return ce.forEach(Le=>Ee.set(Le[A],Le)),Promise.all(G.map(async Le=>{var X=Ee.get(Le),we=X?Pr(X,e.hasAttachments,!1):void 0,De=q[Le],Re=he[Le];Re&&X&&Re.metaDocument.isResolvedConflict===X._rev&&await e.streamQueue.up;var rt=!Re||!we?!1:e.input.conflictHandler.isEqual(Re.docData,we,"downstream-check-if-equal-0");if(!rt&&Re&&Re.docData._rev&&X&&X._meta[e.input.identifier]&&Vr(X._rev)===X._meta[e.input.identifier]&&(rt=!0),X&&Re&&rt===!1||X&&!Re)return Lt;var tr=we?e.input.conflictHandler.isEqual(De,we,"downstream-check-if-equal-1"):!1;if(we&&tr)return(!Re||rt===!1)&&Z.push(await Ga(e,we,Re?Re.metaDocument:void 0)),Lt;var qe=Object.assign({},De,X?{_meta:Ne(X._meta),_attachments:e.hasAttachments&&De._attachments?De._attachments:{},_rev:jt()}:{_meta:{lwt:St()},_rev:jt(),_attachments:e.hasAttachments&&De._attachments?De._attachments:{}});if(De._rev){var at=X?Vr(X._rev)+1:1;qe._meta[e.input.identifier]=at,e.input.keepMeta&&(qe._rev=De._rev)}e.input.keepMeta&&De._meta&&(qe._meta=De._meta);var se={previous:X,document:qe};se.document._rev=se.document._rev?se.document._rev:vr(r,se.previous),ae.push(se),oe[Le]=se,te[Le]=await Ga(e,De,Re?Re.metaDocument:void 0)}))}).then(async()=>{if(ae.length>0)return e.input.forkInstance.bulkWrite(ae,await e.downstreamBulkWriteFlag).then(ce=>{var he=Nt(e.primaryPath,ae,ce);he.forEach(Le=>{var X=Le[A];e.events.processed.down.next(oe[X]),Z.push(te[X])});var Ee;if(ce.error.forEach(Le=>{if(Le.status!==409){var X=ee("RC_PULL",{writeError:Le});e.events.error.next(X),Ee=X}}),Ee)throw Ee})}).then(()=>{if(Z.length>0)return e.input.metaInstance.bulkWrite(pu(e,Z),"replication-down-write-meta").then(ce=>{ce.error.forEach(he=>{e.events.error.next(ee("RC_PULL",{id:he.documentId,writeError:he}))})})}).then(()=>{Qa(e,"down",U)})}).catch(q=>e.events.error.next(q)),v}}async function a0(e,t,r){var n=e.input.conflictHandler,o=n.isEqual(t.realMasterState,t.newDocumentState,"replication-resolve-conflict");if(!o){var i=await n.resolve(t,"replication-resolve-conflict"),c=Object.assign({},i,{_meta:Ne(r._meta),_rev:jt(),_attachments:Ne(r._attachments)});return c._meta.lwt=St(),c._rev=vr(await e.checkpointKey,r),c}}async function gu(e,t,r,n){if(!r._attachments||n&&!n._attachments)throw new Error("_attachments missing");var o=r[e],i=new Set(n&&n._attachments?Object.keys(n._attachments):[]);return await Promise.all(Object.entries(r._attachments).map(async([c,u])=>{if((!i.has(c)||n&&fe(n._attachments)[c].digest!==u.digest)&&!u.data){var d=await t.getAttachmentData(o,c,u.digest);u.data=d}})),r}async function s0(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var t=await Va(e,"up");t||await Qa(e,"up",e.input.initialCheckpoint.upstream)}var r=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>m().then(()=>v()));var n=0,o=-1,i=[],c=yr,u={docs:{}},d=e.input.forkInstance.changeStream().subscribe(_=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,i.push({task:_,time:n++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>v()):v()}),p=r.masterChangeStream$.pipe(ke(_=>_==="RESYNC")).subscribe(()=>{i.push({task:"RESYNC",time:n++}),v()});Sn(e.events.canceled.pipe(ke(_=>!!_))).then(()=>{d.unsubscribe(),p.unsubscribe()});async function m(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Va(e,"up"));for(var _=await e.checkpointQueue,I=new Set,k=async function(){o=n++,I.size>3&&await Promise.race(Array.from(I));var U=await Gh(e.input.forkInstance,e.input.pushBatchSize,_);if(U.documents.length===0)return 1;_=bi([_,U.checkpoint]);var G=b(U.documents,fe(_));I.add(G),G.catch().then(()=>I.delete(G))};!e.events.canceled.getValue()&&!await k(););var A=await Promise.all(I),q=A.find(U=>!!U);q?await m():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function v(){if(e.events.canceled.getValue()||i.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var _=[],I={};i.length>0;){var k=fe(i.shift());if(!(k.time<o)){if(k.task==="RESYNC"){e.events.active.up.next(!1),await m();return}k.task.context!==await e.downstreamBulkWriteFlag&&kn(_,k.task.events.map(A=>A.documentData)),I=bi([I,k.task.checkpoint])}}if(await b(_,I),i.length===0)e.events.active.up.next(!1);else return v()})}function b(_,I){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,_.forEach(k=>{var A=k[e.primaryPath];u.docs[A]=k}),u.checkpoint=I,c=c.then(async()=>{if(e.events.canceled.getValue())return!1;var k=u.docs;u.docs={};var A=u.checkpoint,q=Object.keys(k);function U(){return Qa(e,"up",A)}if(q.length===0)return U(),!1;var G=await bp(e,q),ae={},oe=[],te={},Z={};if(await Promise.all(q.map(async se=>{var Ae=k[se];Z[se]=Ae;var Ze=Pr(Ae,e.hasAttachments,!!e.input.keepMeta),ve=G[se];ve&&ve.metaDocument.isResolvedConflict!==Ae._rev&&e.input.conflictHandler.isEqual(ve.docData,Ze,"upstream-check-if-equal")||ve&&ve.docData._rev&&Vr(Ae._rev)===Ae._meta[e.input.identifier]||(oe.push(se),ae[se]={assumedMasterState:ve?ve.docData:void 0,newDocumentState:Ze},te[se]=await Ga(e,Ze,ve?ve.metaDocument:void 0))})),oe.length===0)return U(),!1;var ce=Object.values(ae),he=new Set,Ee={},Le=Pg(ce,e.input.pushBatchSize);await Promise.all(Le.map(async se=>{e.hasAttachments&&await Promise.all(se.map(async Ze=>{Ze.newDocumentState=await gu(e.primaryPath,e.input.forkInstance,lt(Ze.newDocumentState),Ze.assumedMasterState)}));var Ae=await r.masterWrite(se);Ae.forEach(Ze=>{var ve=Ze[e.primaryPath];he.add(ve),Ee[ve]=Ze})}));var X=[];if(oe.forEach(se=>{he.has(se)||(e.events.processed.up.next(ae[se]),X.push(te[se]))}),e.events.canceled.getValue())return!1;X.length>0&&await e.input.metaInstance.bulkWrite(pu(e,X),"replication-up-write-meta");var we=!1;if(he.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var De=[],Re={};if(await Promise.all(Object.entries(Ee).map(([se,Ae])=>{var Ze=ae[se],ve={newDocumentState:Ze.newDocumentState,assumedMasterState:Ze.assumedMasterState,realMasterState:Ae};return a0(e,ve,Z[se]).then(async Ve=>{if(Ve){e.events.resolvedConflicts.next({input:ve,output:Ve}),De.push({previous:Z[se],document:Ve});var Dt=G[se];Re[se]=await Ga(e,fe(Ae),Dt?Dt.metaDocument:void 0,Ve._rev)}})})),De.length>0){we=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var rt=await e.input.forkInstance.bulkWrite(De,"replication-up-write-conflict"),tr;if(rt.error.forEach(se=>{if(se.status!==409){var Ae=ee("RC_PUSH",{writeError:se});e.events.error.next(Ae),tr=Ae}}),tr)throw tr;var qe=[],at=Nt(e.primaryPath,De,rt);at.forEach(se=>{var Ae=se[e.primaryPath];qe.push(Re[Ae])}),qe.length>0&&await e.input.metaInstance.bulkWrite(pu(e,qe),"replication-up-write-conflict-meta")}}return U(),we}).catch(k=>(e.events.error.next(k),!1)),c}}function c0(e){e=Ne(e),e.forkInstance=mu(e.forkInstance),e.metaInstance=mu(e.metaInstance);var t=o0(e),r={primaryPath:It(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:t,downstreamBulkWriteFlag:t.then(n=>"replication-downstream-"+n),events:{canceled:new Lr(!1),paused:new Lr(!1),active:{down:new Lr(!0),up:new Lr(!0)},processed:{down:new Pt,up:new Pt},resolvedConflicts:new Pt,error:new Pt},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new Lr(!1),up:new Lr(!1)},streamQueue:{down:Lt,up:Lt},checkpointQueue:Lt,lastCheckpointDoc:{}};return i0(r),s0(r),r}function u0(e){return Sn(Gv([e.firstSyncDone.down.pipe(ke(t=>!!t)),e.firstSyncDone.up.pipe(ke(t=>!!t))])).then(()=>{})}function l0(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function d0(e,t,r,n=!1){e=mu(e);var o=!!e.schema.attachments,i=It(e.schema.primaryKey),c={masterChangeStream$:e.changeStream().pipe(wr(async u=>{var d={checkpoint:u.checkpoint,documents:await Promise.all(u.events.map(async p=>{var m=Pr(p.documentData,o,n);return o&&(m=await gu(i,e,lt(m),void 0)),m}))};return d})),masterChangesSince(u,d){return Gh(e,d,u).then(async p=>({checkpoint:p.documents.length>0?p.checkpoint:u,documents:await Promise.all(p.documents.map(async m=>{var v=Pr(m,o,n);return o&&(v=await gu(i,e,lt(v),void 0)),v}))}))},async masterWrite(u){var d={};u.forEach(k=>{var A=k.newDocumentState[i];d[A]=k});var p=Object.keys(d),m=await e.findDocumentsById(p,!0),v=new Map;m.forEach(k=>v.set(k[i],k));var b=[],_=[];if(await Promise.all(Object.entries(d).map(([k,A])=>{var q=v.get(k);q?q&&!A.assumedMasterState?b.push(Pr(q,o,n)):t.isEqual(Pr(q,o,n),fe(A.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?_.push({previous:q,document:Md(r,o,n,A.newDocumentState,q)}):b.push(Pr(q,o,n)):_.push({document:Md(r,o,n,A.newDocumentState)})})),_.length>0){var I=await e.bulkWrite(_,"replication-master-write");I.error.forEach(k=>{if(k.status!==409)throw ee("SNH",{name:"non conflict error",error:k});b.push(Pr(fe(k.documentInDb),o,n))})}return b}};return c}async function f0(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}function h0(e){return e&&typeof e.then=="function"}Promise.resolve(!1);var p0=Promise.resolve(!0),pr=Promise.resolve();function pn(e,t){return e||(e=0),new Promise(function(r){return setTimeout(function(){return r(t)},e)})}function m0(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function Ni(){return Math.random().toString(36).substring(2)}var Ic=0;function qi(){var e=Date.now()*1e3;return e<=Ic&&(e=Ic+1),Ic=e,e}function g0(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var v0=qi,y0="native";function b0(e){var t={time:qi(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(r){t.messagesCallback&&t.messagesCallback(r.data)},t}function w0(e){e.bc.close(),e.subFns=[]}function _0(e,t){try{return e.bc.postMessage(t,!1),pr}catch(r){return Promise.reject(r)}}function S0(e,t){e.messagesCallback=t}function I0(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function C0(){return 150}var E0={create:b0,close:w0,onMessage:S0,postMessage:_0,canBeUsed:I0,type:y0,averageResponseTime:C0,microSeconds:v0};function el(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=1e3*60*2),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),typeof t.node.useFastPath>"u"&&(t.node.useFastPath=!0),t}var D0=qi,x0="pubkey.broadcast-channel-0-",_r="messages",vs={durability:"relaxed"},k0="idb";function wp(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function tl(e){e.commit&&e.commit()}function R0(e){var t=wp(),r=x0+e,n=t.open(r);return n.onupgradeneeded=function(o){var i=o.target.result;i.createObjectStore(_r,{keyPath:"id",autoIncrement:!0})},new Promise(function(o,i){n.onerror=function(c){return i(c)},n.onsuccess=function(){o(n.result)}})}function O0(e,t,r){var n=Date.now(),o={uuid:t,time:n,data:r},i=e.transaction([_r],"readwrite",vs);return new Promise(function(c,u){i.oncomplete=function(){return c()},i.onerror=function(p){return u(p)};var d=i.objectStore(_r);d.add(o),tl(i)})}function L0(e,t){var r=e.transaction(_r,"readonly",vs),n=r.objectStore(_r),o=[],i=IDBKeyRange.bound(t+1,1/0);if(n.getAll){var c=n.getAll(i);return new Promise(function(d,p){c.onerror=function(m){return p(m)},c.onsuccess=function(m){d(m.target.result)}})}function u(){try{return i=IDBKeyRange.bound(t+1,1/0),n.openCursor(i)}catch{return n.openCursor()}}return new Promise(function(d,p){var m=u();m.onerror=function(v){return p(v)},m.onsuccess=function(v){var b=v.target.result;b?b.value.id<t+1?b.continue(t+1):(o.push(b.value),b.continue()):(tl(r),d(o))}})}function P0(e,t){if(e.closed)return Promise.resolve([]);var r=e.db.transaction(_r,"readwrite",vs),n=r.objectStore(_r);return Promise.all(t.map(function(o){var i=n.delete(o);return new Promise(function(c){i.onsuccess=function(){return c()}})}))}function $0(e,t){var r=Date.now()-t,n=e.transaction(_r,"readonly",vs),o=n.objectStore(_r),i=[];return new Promise(function(c){o.openCursor().onsuccess=function(u){var d=u.target.result;if(d){var p=d.value;p.time<r?(i.push(p),d.continue()):(tl(n),c(i))}else c(i)}})}function A0(e){return $0(e.db,e.options.idb.ttl).then(function(t){return P0(e,t.map(function(r){return r.id}))})}function M0(e,t){return t=el(t),R0(e).then(function(r){var n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:Ni(),eMIs:new Xu(t.idb.ttl*2),writeBlockPromise:pr,messagesCallback:null,readQueuePromises:[],db:r};return r.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},_p(n),n})}function _p(e){e.closed||Sp(e).then(function(){return pn(e.options.idb.fallbackInterval)}).then(function(){return _p(e)})}function T0(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function Sp(e){return e.closed||!e.messagesCallback?pr:L0(e.db,e.lastCursorId).then(function(t){var r=t.filter(function(n){return!!n}).map(function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n}).filter(function(n){return T0(n,e)}).sort(function(n,o){return n.time-o.time});return r.forEach(function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),pr})}function N0(e){e.closed=!0,e.db.close()}function q0(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return O0(e.db,e.uuid,t)}).then(function(){m0(0,10)===0&&A0(e)}),e.writeBlockPromise}function B0(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t,Sp(e)}function F0(){return!!wp()}function U0(e){return e.idb.fallbackInterval*2}var j0={create:M0,close:N0,onMessage:B0,postMessage:q0,canBeUsed:F0,type:k0,averageResponseTime:U0,microSeconds:D0},K0=qi,H0="pubkey.broadcastChannel-",z0="localstorage";function Ip(){var e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function Cp(e){return H0+e}function W0(e,t){return new Promise(function(r){pn().then(function(){var n=Cp(e.channelName),o={token:Ni(),time:Date.now(),data:t,uuid:e.uuid},i=JSON.stringify(o);Ip().setItem(n,i);var c=document.createEvent("Event");c.initEvent("storage",!0,!0),c.key=n,c.newValue=i,window.dispatchEvent(c),r()})})}function V0(e,t){var r=Cp(e),n=function(i){i.key===r&&t(JSON.parse(i.newValue))};return window.addEventListener("storage",n),n}function Q0(e){window.removeEventListener("storage",e)}function G0(e,t){if(t=el(t),!Ep())throw new Error("BroadcastChannel: localstorage cannot be used");var r=Ni(),n=new Xu(t.localstorage.removeTimeout),o={channelName:e,uuid:r,eMIs:n};return o.listener=V0(e,function(i){o.messagesCallback&&i.uuid!==r&&(!i.token||n.has(i.token)||i.data.time&&i.data.time<o.messagesCallbackTime||(n.add(i.token),o.messagesCallback(i.data)))}),o}function Y0(e){Q0(e.listener)}function J0(e,t,r){e.messagesCallbackTime=r,e.messagesCallback=t}function Ep(){var e=Ip();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function X0(){var e=120,t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?e*2:e}var Z0={create:G0,close:Y0,onMessage:J0,postMessage:W0,canBeUsed:Ep,type:z0,averageResponseTime:X0,microSeconds:K0},Dp=qi,e_="simulate",rl=new Set;function t_(e){var t={time:Dp(),name:e,messagesCallback:null};return rl.add(t),t}function r_(e){rl.delete(e)}var xp=5;function n_(e,t){return new Promise(function(r){return setTimeout(function(){var n=Array.from(rl);n.forEach(function(o){o.name===e.name&&o!==e&&o.messagesCallback&&o.time<t.time&&o.messagesCallback(t)}),r()},xp)})}function o_(e,t){e.messagesCallback=t}function i_(){return!0}function a_(){return xp}var s_={create:t_,close:r_,onMessage:o_,postMessage:n_,canBeUsed:i_,type:e_,averageResponseTime:a_,microSeconds:Dp},Nd=[E0,j0,Z0];function c_(e){var t=[].concat(e.methods,Nd).filter(Boolean);if(e.type){if(e.type==="simulate")return s_;var r=t.find(function(o){return o.type===e.type});if(r)return r;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(o){return o.type!=="idb"}));var n=t.find(function(o){return o.canBeUsed()});if(n)return n;throw new Error("No usable method found in "+JSON.stringify(Nd.map(function(o){return o.type})))}var kp=new Set,u_=0,ys=function(t,r){this.id=u_++,kp.add(this),this.name=t,this.options=el(r),this.method=c_(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,l_(this)};ys._pubkey=!0;ys.prototype={postMessage:function(t){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(t));return qd(this,"message",t)},postInternal:function(t){return qd(this,"internal",t)},set onmessage(e){var t=this.method.microSeconds(),r={time:t,fn:e};Fd(this,"message",this._onML),e&&typeof e=="function"?(this._onML=r,Bd(this,"message",r)):this._onML=null},addEventListener:function(t,r){var n=this.method.microSeconds(),o={time:n,fn:r};Bd(this,t,o)},removeEventListener:function(t,r){var n=this._addEL[t].find(function(o){return o.fn===r});Fd(this,t,n)},close:function(){var t=this;if(!this.closed){kp.delete(this),this.closed=!0;var r=this._prepP?this._prepP:pr;return this._onML=null,this._addEL.message=[],r.then(function(){return Promise.all(Array.from(t._uMP))}).then(function(){return Promise.all(t._befC.map(function(n){return n()}))}).then(function(){return t.method.close(t._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function qd(e,t,r){var n=e.method.microSeconds(),o={time:n,type:t,data:r},i=e._prepP?e._prepP:pr;return i.then(function(){var c=e.method.postMessage(e._state,o);return e._uMP.add(c),c.catch().then(function(){return e._uMP.delete(c)}),c})}function l_(e){var t=e.method.create(e.name,e.options);h0(t)?(e._prepP=t,t.then(function(r){e._state=r})):e._state=t}function Rp(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function Bd(e,t,r){e._addEL[t].push(r),d_(e)}function Fd(e,t,r){e._addEL[t]=e._addEL[t].filter(function(n){return n!==r}),f_(e)}function d_(e){if(!e._iL&&Rp(e)){var t=function(o){e._addEL[o.type].forEach(function(i){o.time>=i.time&&i.fn(o.data)})},r=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,r)}):(e._iL=!0,e.method.onMessage(e._state,t,r))}}function f_(e){if(e._iL&&!Rp(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function h_(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function p_(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var m_=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",g_=m_?p_:h_,Go=new Set,Ud=!1;function v_(){Ud||(Ud=!0,g_(b_))}function y_(e){if(v_(),typeof e!="function")throw new Error("Listener is no function");Go.add(e);var t={remove:function(){return Go.delete(e)},run:function(){return Go.delete(e),e()}};return t}function b_(){var e=[];return Go.forEach(function(t){e.push(t()),Go.delete(t)}),Promise.all(e)}function Cn(e,t){var r={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(r)}function Op(e){e.isLeader=!0,e._hasLeader=!0;var t=y_(function(){return e.die()});e._unl.push(t);var r=function(o){o.context==="leader"&&o.action==="apply"&&Cn(e,"tell"),o.context==="leader"&&o.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),Cn(e,"tell"))};return e.broadcastChannel.addEventListener("internal",r),e._lstns.push(r),Cn(e,"tell")}var Lp=function(t,r){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=r,this.isLeader=!1,this.isDead=!1,this.token=Ni(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};Lp.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(r){var n=r.held?r.held.filter(function(o){return o.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var r=new Promise(function(n,o){t._wKMC.res=n,t._wKMC.rej=o});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,Op(t),n(),r}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),Cn(this,"death")}};var Pp=function(t,r){var n=this;this.broadcastChannel=t,this._options=r,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=Ni(),this._aplQ=pr,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var o=function(c){c.context==="leader"&&(c.action==="death"&&(n._hasLeader=!1),c.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",o),this._lstns.push(o)};Pp.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var r=this;if(this.isLeader)return pn(0,!0);if(this.isDead)return pn(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(r.isLeader)return p0;var i=!1,c,u=new Promise(function(m){c=function(){i=!0,m()}}),d=function(v){v.context==="leader"&&v.token!=r.token&&(v.action==="apply"&&v.token>r.token&&c(),v.action==="tell"&&(c(),r._hasLeader=!0))};r.broadcastChannel.addEventListener("internal",d);var p=t?r._options.responseTime*4:r._options.responseTime;return Cn(r,"apply").then(function(){return Promise.race([pn(p),u.then(function(){return Promise.reject(new Error)})])}).then(function(){return Cn(r,"apply")}).then(function(){return Promise.race([pn(p),u.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return r.broadcastChannel.removeEventListener("internal",d),i?!1:Op(r).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){r._aplQC=r._aplQC-1}),this._aplQ.then(function(){return r.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=w_(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(r){return t.broadcastChannel.removeEventListener("internal",r)}),this._lstns=[],this._unl.forEach(function(r){return r.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,Cn(this,"death")}};function w_(e){return e.isLeader?pr:new Promise(function(t){var r=!1;function n(){r||(r=!0,e.broadcastChannel.removeEventListener("internal",i),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var o=function(){return pn(e._options.fallbackInterval).then(function(){if(!(e.isDead||r))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():o()})})};o();var i=function(u){u.context==="leader"&&u.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",i),e._lstns.push(i)})}function __(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function S_(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=__(t,e);var r=g0()?new Lp(e,t):new Pp(e,t);return e._befC.push(function(){return r.die()}),e._leaderElector=r,r}var Ya=new Map;function I_(e,t,r,n){var o=Ya.get(t);return o||(o={bc:new ys(["RxDB:",e,r].join("|")),refs:new Set},Ya.set(t,o)),o.refs.add(n),o.bc}function jd(e,t){var r=Ya.get(e);if(r&&(r.refs.delete(t),r.refs.size===0))return Ya.delete(e),r.bc.close()}function C_(e,t,r,n){if(t.multiInstance){var o=I_(e,t.databaseInstanceToken,r.databaseName,r),i=new Pt,c=b=>{b.storageName===e&&b.databaseName===t.databaseName&&b.collectionName===t.collectionName&&b.version===t.schema.version&&i.next(b.eventBulk)};o.addEventListener("message",c);var u=r.changeStream(),d=!1,p=u.subscribe(b=>{d||o.postMessage({storageName:e,databaseName:t.databaseName,collectionName:t.collectionName,version:t.schema.version,eventBulk:b})});r.changeStream=function(){return i.asObservable().pipe(oy(u))};var m=r.close.bind(r);r.close=async function(){return d=!0,p.unsubscribe(),o.removeEventListener("message",c),await jd(t.databaseInstanceToken,r),m()};var v=r.remove.bind(r);r.remove=async function(){return d=!0,p.unsubscribe(),o.removeEventListener("message",c),await jd(t.databaseInstanceToken,r),v()}}}var Oa={exports:{}},E_=Oa.exports,Kd;function D_(){return Kd||(Kd=1,function(e,t){(function(r,n){e.exports=n()})(E_,function(){var r=function(a,s){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,f){l.__proto__=f}||function(l,f){for(var h in f)Object.prototype.hasOwnProperty.call(f,h)&&(l[h]=f[h])})(a,s)},n=function(){return(n=Object.assign||function(a){for(var s,l=1,f=arguments.length;l<f;l++)for(var h in s=arguments[l])Object.prototype.hasOwnProperty.call(s,h)&&(a[h]=s[h]);return a}).apply(this,arguments)};function o(a,s,l){for(var f,h=0,g=s.length;h<g;h++)!f&&h in s||((f=f||Array.prototype.slice.call(s,0,h))[h]=s[h]);return a.concat(f||Array.prototype.slice.call(s))}var i=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Mm,c=Object.keys,u=Array.isArray;function d(a,s){return typeof s!="object"||c(s).forEach(function(l){a[l]=s[l]}),a}typeof Promise>"u"||i.Promise||(i.Promise=Promise);var p=Object.getPrototypeOf,m={}.hasOwnProperty;function v(a,s){return m.call(a,s)}function b(a,s){typeof s=="function"&&(s=s(p(a))),(typeof Reflect>"u"?c:Reflect.ownKeys)(s).forEach(function(l){I(a,l,s[l])})}var _=Object.defineProperty;function I(a,s,l,f){_(a,s,d(l&&v(l,"get")&&typeof l.get=="function"?{get:l.get,set:l.set,configurable:!0}:{value:l,configurable:!0,writable:!0},f))}function k(a){return{from:function(s){return a.prototype=Object.create(s.prototype),I(a.prototype,"constructor",a),{extend:b.bind(null,a.prototype)}}}}var A=Object.getOwnPropertyDescriptor,q=[].slice;function U(a,s,l){return q.call(a,s,l)}function G(a,s){return s(a)}function ae(a){if(!a)throw new Error("Assertion Failed")}function oe(a){i.setImmediate?setImmediate(a):setTimeout(a,0)}function te(a,s){if(typeof s=="string"&&v(a,s))return a[s];if(!s)return a;if(typeof s!="string"){for(var l=[],f=0,h=s.length;f<h;++f){var g=te(a,s[f]);l.push(g)}return l}var y=s.indexOf(".");if(y!==-1){var w=a[s.substr(0,y)];return w==null?void 0:te(w,s.substr(y+1))}}function Z(a,s,l){if(a&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof s!="string"&&"length"in s){ae(typeof l!="string"&&"length"in l);for(var f=0,h=s.length;f<h;++f)Z(a,s[f],l[f])}else{var g,y,w=s.indexOf(".");w!==-1?(g=s.substr(0,w),(y=s.substr(w+1))===""?l===void 0?u(a)&&!isNaN(parseInt(g))?a.splice(g,1):delete a[g]:a[g]=l:Z(w=!(w=a[g])||!v(a,g)?a[g]={}:w,y,l)):l===void 0?u(a)&&!isNaN(parseInt(s))?a.splice(s,1):delete a[s]:a[s]=l}}function ce(a){var s,l={};for(s in a)v(a,s)&&(l[s]=a[s]);return l}var he=[].concat;function Ee(a){return he.apply([],a)}var nr="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ee([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(s){return s+a+"Array"})}))).filter(function(a){return i[a]}),Le=new Set(nr.map(function(a){return i[a]})),X=null;function we(a){return X=new WeakMap,a=function s(l){if(!l||typeof l!="object")return l;var f=X.get(l);if(f)return f;if(u(l)){f=[],X.set(l,f);for(var h=0,g=l.length;h<g;++h)f.push(s(l[h]))}else if(Le.has(l.constructor))f=l;else{var y,w=p(l);for(y in f=w===Object.prototype?{}:Object.create(w),X.set(l,f),l)v(l,y)&&(f[y]=s(l[y]))}return f}(a),X=null,a}var De={}.toString;function Re(a){return De.call(a).slice(8,-1)}var rt=typeof Symbol<"u"?Symbol.iterator:"@@iterator",tr=typeof rt=="symbol"?function(a){var s;return a!=null&&(s=a[rt])&&s.apply(a)}:function(){return null};function qe(a,s){return s=a.indexOf(s),0<=s&&a.splice(s,1),0<=s}var at={};function se(a){var s,l,f,h;if(arguments.length===1){if(u(a))return a.slice();if(this===at&&typeof a=="string")return[a];if(h=tr(a)){for(l=[];!(f=h.next()).done;)l.push(f.value);return l}if(a==null)return[a];if(typeof(s=a.length)!="number")return[a];for(l=new Array(s);s--;)l[s]=a[s];return l}for(s=arguments.length,l=new Array(s);s--;)l[s]=arguments[s];return l}var Ae=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Ro=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],xt=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Ro),Ze={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function ve(a,s){this.name=a,this.message=s}function Ve(a,s){return a+". Errors: "+Object.keys(s).map(function(l){return s[l].toString()}).filter(function(l,f,h){return h.indexOf(l)===f}).join(`
`)}function Dt(a,s,l,f){this.failures=s,this.failedKeys=f,this.successCount=l,this.message=Ve(a,s)}function Ir(a,s){this.name="BulkError",this.failures=Object.keys(s).map(function(l){return s[l]}),this.failuresByPos=s,this.message=Ve(a,this.failures)}k(ve).from(Error).extend({toString:function(){return this.name+": "+this.message}}),k(Dt).from(ve),k(Ir).from(ve);var Cs=xt.reduce(function(a,s){return a[s]=s+"Error",a},{}),rm=ve,ie=xt.reduce(function(a,s){var l=s+"Error";function f(h,g){this.name=l,h?typeof h=="string"?(this.message="".concat(h).concat(g?`
 `+g:""),this.inner=g||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=Ze[s]||l,this.inner=null)}return k(f).from(rm),a[s]=f,a},{});ie.Syntax=SyntaxError,ie.Type=TypeError,ie.Range=RangeError;var cl=Ro.reduce(function(a,s){return a[s+"Error"]=ie[s],a},{}),Bi=xt.reduce(function(a,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(a[s+"Error"]=ie[s]),a},{});function Se(){}function xo(a){return a}function nm(a,s){return a==null||a===xo?s:function(l){return s(a(l))}}function Xr(a,s){return function(){a.apply(this,arguments),s.apply(this,arguments)}}function om(a,s){return a===Se?s:function(){var l=a.apply(this,arguments);l!==void 0&&(arguments[0]=l);var f=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var g=s.apply(this,arguments);return f&&(this.onsuccess=this.onsuccess?Xr(f,this.onsuccess):f),h&&(this.onerror=this.onerror?Xr(h,this.onerror):h),g!==void 0?g:l}}function im(a,s){return a===Se?s:function(){a.apply(this,arguments);var l=this.onsuccess,f=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),l&&(this.onsuccess=this.onsuccess?Xr(l,this.onsuccess):l),f&&(this.onerror=this.onerror?Xr(f,this.onerror):f)}}function am(a,s){return a===Se?s:function(l){var f=a.apply(this,arguments);d(l,f);var h=this.onsuccess,g=this.onerror;return this.onsuccess=null,this.onerror=null,l=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?Xr(h,this.onsuccess):h),g&&(this.onerror=this.onerror?Xr(g,this.onerror):g),f===void 0?l===void 0?void 0:l:d(f,l)}}function sm(a,s){return a===Se?s:function(){return s.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function Es(a,s){return a===Se?s:function(){var l=a.apply(this,arguments);if(l&&typeof l.then=="function"){for(var f=this,h=arguments.length,g=new Array(h);h--;)g[h]=arguments[h];return l.then(function(){return s.apply(f,g)})}return s.apply(this,arguments)}}Bi.ModifyError=Dt,Bi.DexieError=ve,Bi.BulkError=Ir;var Vt=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ul(a){Vt=a}var ko={},ll=100,nr=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,p(a),a];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,p(s),a]}(),Ro=nr[0],xt=nr[1],nr=nr[2],xt=xt&&xt.then,Zr=Ro&&Ro.constructor,Ds=!!nr,Oo=function(a,s){Lo.push([a,s]),Fi&&(queueMicrotask(um),Fi=!1)},xs=!0,Fi=!0,en=[],Ui=[],ks=xo,Cr={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Se,pgp:!1,env:{},finalize:Se},ne=Cr,Lo=[],tn=0,ji=[];function Q(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=ne;if(typeof a!="function"){if(a!==ko)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Os(this,this._value))}this._state=null,this._value=null,++s.ref,function l(f,h){try{h(function(g){if(f._state===null){if(g===f)throw new TypeError("A promise cannot be resolved with itself.");var y=f._lib&&Mn();g&&typeof g.then=="function"?l(f,function(w,C){g instanceof Q?g._then(w,C):g.then(w,C)}):(f._state=!0,f._value=g,fl(f)),y&&Tn()}},Os.bind(null,f))}catch(g){Os(f,g)}}(this,a)}var Rs={get:function(){var a=ne,s=Wi;function l(f,h){var g=this,y=!a.global&&(a!==ne||s!==Wi),w=y&&!Dr(),C=new Q(function(D,O){Ls(g,new dl(pl(f,a,y,w),pl(h,a,y,w),D,O,a))});return this._consoleTask&&(C._consoleTask=this._consoleTask),C}return l.prototype=ko,l},set:function(a){I(this,"then",a&&a.prototype===ko?Rs:{get:function(){return a},set:Rs.set})}};function dl(a,s,l,f,h){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof s=="function"?s:null,this.resolve=l,this.reject=f,this.psd=h}function Os(a,s){var l,f;Ui.push(s),a._state===null&&(l=a._lib&&Mn(),s=ks(s),a._state=!1,a._value=s,f=a,en.some(function(h){return h._value===f._value})||en.push(f),fl(a),l&&Tn())}function fl(a){var s=a._listeners;a._listeners=[];for(var l=0,f=s.length;l<f;++l)Ls(a,s[l]);var h=a._PSD;--h.ref||h.finalize(),tn===0&&(++tn,Oo(function(){--tn==0&&Ps()},[]))}function Ls(a,s){if(a._state!==null){var l=a._state?s.onFulfilled:s.onRejected;if(l===null)return(a._state?s.resolve:s.reject)(a._value);++s.psd.ref,++tn,Oo(cm,[l,a,s])}else a._listeners.push(s)}function cm(a,s,l){try{var f,h=s._value;!s._state&&Ui.length&&(Ui=[]),f=Vt&&s._consoleTask?s._consoleTask.run(function(){return a(h)}):a(h),s._state||Ui.indexOf(h)!==-1||function(g){for(var y=en.length;y;)if(en[--y]._value===g._value)return en.splice(y,1)}(s),l.resolve(f)}catch(g){l.reject(g)}finally{--tn==0&&Ps(),--l.psd.ref||l.psd.finalize()}}function um(){rn(Cr,function(){Mn()&&Tn()})}function Mn(){var a=xs;return Fi=xs=!1,a}function Tn(){var a,s,l;do for(;0<Lo.length;)for(a=Lo,Lo=[],l=a.length,s=0;s<l;++s){var f=a[s];f[0].apply(null,f[1])}while(0<Lo.length);Fi=xs=!0}function Ps(){var a=en;en=[],a.forEach(function(f){f._PSD.onunhandled.call(null,f._value,f)});for(var s=ji.slice(0),l=s.length;l;)s[--l]()}function Ki(a){return new Q(ko,!1,a)}function Me(a,s){var l=ne;return function(){var f=Mn(),h=ne;try{return xr(l,!0),a.apply(this,arguments)}catch(g){s&&s(g)}finally{xr(h,!1),f&&Tn()}}}b(Q.prototype,{then:Rs,_then:function(a,s){Ls(this,new dl(null,null,a,s,ne))},catch:function(a){if(arguments.length===1)return this.then(null,a);var s=a,l=arguments[1];return typeof s=="function"?this.then(null,function(f){return(f instanceof s?l:Ki)(f)}):this.then(null,function(f){return(f&&f.name===s?l:Ki)(f)})},finally:function(a){return this.then(function(s){return Q.resolve(a()).then(function(){return s})},function(s){return Q.resolve(a()).then(function(){return Ki(s)})})},timeout:function(a,s){var l=this;return a<1/0?new Q(function(f,h){var g=setTimeout(function(){return h(new ie.Timeout(s))},a);l.then(f,h).finally(clearTimeout.bind(null,g))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&I(Q.prototype,Symbol.toStringTag,"Dexie.Promise"),Cr.env=hl(),b(Q,{all:function(){var a=se.apply(null,arguments).map(Vi);return new Q(function(s,l){a.length===0&&s([]);var f=a.length;a.forEach(function(h,g){return Q.resolve(h).then(function(y){a[g]=y,--f||s(a)},l)})})},resolve:function(a){return a instanceof Q?a:a&&typeof a.then=="function"?new Q(function(s,l){a.then(s,l)}):new Q(ko,!0,a)},reject:Ki,race:function(){var a=se.apply(null,arguments).map(Vi);return new Q(function(s,l){a.map(function(f){return Q.resolve(f).then(s,l)})})},PSD:{get:function(){return ne},set:function(a){return ne=a}},totalEchoes:{get:function(){return Wi}},newPSD:Er,usePSD:rn,scheduler:{get:function(){return Oo},set:function(a){Oo=a}},rejectionMapper:{get:function(){return ks},set:function(a){ks=a}},follow:function(a,s){return new Q(function(l,f){return Er(function(h,g){var y=ne;y.unhandleds=[],y.onunhandled=g,y.finalize=Xr(function(){var w,C=this;w=function(){C.unhandleds.length===0?h():g(C.unhandleds[0])},ji.push(function D(){w(),ji.splice(ji.indexOf(D),1)}),++tn,Oo(function(){--tn==0&&Ps()},[])},y.finalize),a()},s,l,f)})}}),Zr&&(Zr.allSettled&&I(Q,"allSettled",function(){var a=se.apply(null,arguments).map(Vi);return new Q(function(s){a.length===0&&s([]);var l=a.length,f=new Array(l);a.forEach(function(h,g){return Q.resolve(h).then(function(y){return f[g]={status:"fulfilled",value:y}},function(y){return f[g]={status:"rejected",reason:y}}).then(function(){return--l||s(f)})})})}),Zr.any&&typeof AggregateError<"u"&&I(Q,"any",function(){var a=se.apply(null,arguments).map(Vi);return new Q(function(s,l){a.length===0&&l(new AggregateError([]));var f=a.length,h=new Array(f);a.forEach(function(g,y){return Q.resolve(g).then(function(w){return s(w)},function(w){h[y]=w,--f||l(new AggregateError(h))})})})}),Zr.withResolvers&&(Q.withResolvers=Zr.withResolvers));var Qe={awaits:0,echoes:0,id:0},lm=0,Hi=[],zi=0,Wi=0,dm=0;function Er(a,s,l,f){var h=ne,g=Object.create(h);return g.parent=h,g.ref=0,g.global=!1,g.id=++dm,Cr.env,g.env=Ds?{Promise:Q,PromiseProp:{value:Q,configurable:!0,writable:!0},all:Q.all,race:Q.race,allSettled:Q.allSettled,any:Q.any,resolve:Q.resolve,reject:Q.reject}:{},s&&d(g,s),++h.ref,g.finalize=function(){--this.parent.ref||this.parent.finalize()},f=rn(g,a,l,f),g.ref===0&&g.finalize(),f}function Nn(){return Qe.id||(Qe.id=++lm),++Qe.awaits,Qe.echoes+=ll,Qe.id}function Dr(){return!!Qe.awaits&&(--Qe.awaits==0&&(Qe.id=0),Qe.echoes=Qe.awaits*ll,!0)}function Vi(a){return Qe.echoes&&a&&a.constructor===Zr?(Nn(),a.then(function(s){return Dr(),s},function(s){return Dr(),Be(s)})):a}function fm(){var a=Hi[Hi.length-1];Hi.pop(),xr(a,!1)}function xr(a,s){var l,f=ne;(s?!Qe.echoes||zi++&&a===ne:!zi||--zi&&a===ne)||queueMicrotask(s?(function(h){++Wi,Qe.echoes&&--Qe.echoes!=0||(Qe.echoes=Qe.awaits=Qe.id=0),Hi.push(ne),xr(h,!0)}).bind(null,a):fm),a!==ne&&(ne=a,f===Cr&&(Cr.env=hl()),Ds&&(l=Cr.env.Promise,s=a.env,(f.global||a.global)&&(Object.defineProperty(i,"Promise",s.PromiseProp),l.all=s.all,l.race=s.race,l.resolve=s.resolve,l.reject=s.reject,s.allSettled&&(l.allSettled=s.allSettled),s.any&&(l.any=s.any))))}function hl(){var a=i.Promise;return Ds?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(i,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function rn(a,s,l,f,h){var g=ne;try{return xr(a,!0),s(l,f,h)}finally{xr(g,!1)}}function pl(a,s,l,f){return typeof a!="function"?a:function(){var h=ne;l&&Nn(),xr(s,!0);try{return a.apply(this,arguments)}finally{xr(h,!1),f&&queueMicrotask(Dr)}}}function $s(a){Promise===Zr&&Qe.echoes===0?zi===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+xt).indexOf("[native code]")===-1&&(Nn=Dr=Se);var Be=Q.reject,nn="ï¿¿",rr="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",ml="String expected.",qn=[],Qi="__dbnames",As="readonly",Ms="readwrite";function on(a,s){return a?s?function(){return a.apply(this,arguments)&&s.apply(this,arguments)}:a:s}var gl={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Gi(a){return typeof a!="string"||/\./.test(a)?function(s){return s}:function(s){return s[a]===void 0&&a in s&&delete(s=we(s))[a],s}}function vl(){throw ie.Type()}function ye(a,s){try{var l=yl(a),f=yl(s);if(l!==f)return l==="Array"?1:f==="Array"?-1:l==="binary"?1:f==="binary"?-1:l==="string"?1:f==="string"?-1:l==="Date"?1:f!=="Date"?NaN:-1;switch(l){case"number":case"Date":case"string":return s<a?1:a<s?-1:0;case"binary":return function(h,g){for(var y=h.length,w=g.length,C=y<w?y:w,D=0;D<C;++D)if(h[D]!==g[D])return h[D]<g[D]?-1:1;return y===w?0:y<w?-1:1}(bl(a),bl(s));case"Array":return function(h,g){for(var y=h.length,w=g.length,C=y<w?y:w,D=0;D<C;++D){var O=ye(h[D],g[D]);if(O!==0)return O}return y===w?0:y<w?-1:1}(a,s)}}catch{}return NaN}function yl(a){var s=typeof a;return s!="object"?s:ArrayBuffer.isView(a)?"binary":(a=Re(a),a==="ArrayBuffer"?"binary":a)}function bl(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}var wl=(Pe.prototype._trans=function(a,s,l){var f=this._tx||ne.trans,h=this.name,g=Vt&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function y(D,O,S){if(!S.schema[h])throw new ie.NotFound("Table "+h+" not part of transaction");return s(S.idbtrans,S)}var w=Mn();try{var C=f&&f.db._novip===this.db._novip?f===ne.trans?f._promise(a,y,l):Er(function(){return f._promise(a,y,l)},{trans:f,transless:ne.transless||ne}):function D(O,S,P,E){if(O.idbdb&&(O._state.openComplete||ne.letThrough||O._vip)){var R=O._createTransaction(S,P,O._dbSchema);try{R.create(),O._state.PR1398_maxLoop=3}catch(L){return L.name===Cs.InvalidState&&O.isOpen()&&0<--O._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),O.close({disableAutoOpen:!1}),O.open().then(function(){return D(O,S,P,E)})):Be(L)}return R._promise(S,function(L,x){return Er(function(){return ne.trans=R,E(L,x,R)})}).then(function(L){if(S==="readwrite")try{R.idbtrans.commit()}catch{}return S==="readonly"?L:R._completion.then(function(){return L})})}if(O._state.openComplete)return Be(new ie.DatabaseClosed(O._state.dbOpenError));if(!O._state.isBeingOpened){if(!O._state.autoOpen)return Be(new ie.DatabaseClosed);O.open().catch(Se)}return O._state.dbReadyPromise.then(function(){return D(O,S,P,E)})}(this.db,a,[this.name],y);return g&&(C._consoleTask=g,C=C.catch(function(D){return console.trace(D),Be(D)})),C}finally{w&&Tn()}},Pe.prototype.get=function(a,s){var l=this;return a&&a.constructor===Object?this.where(a).first(s):a==null?Be(new ie.Type("Invalid argument to Table.get()")):this._trans("readonly",function(f){return l.core.get({trans:f,key:a}).then(function(h){return l.hook.reading.fire(h)})}).then(s)},Pe.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(u(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var s=c(a);if(s.length===1)return this.where(s[0]).equals(a[s[0]]);var l=this.schema.indexes.concat(this.schema.primKey).filter(function(w){if(w.compound&&s.every(function(D){return 0<=w.keyPath.indexOf(D)})){for(var C=0;C<s.length;++C)if(s.indexOf(w.keyPath[C])===-1)return!1;return!0}return!1}).sort(function(w,C){return w.keyPath.length-C.keyPath.length})[0];if(l&&this.db._maxKey!==nn){var g=l.keyPath.slice(0,s.length);return this.where(g).equals(g.map(function(C){return a[C]}))}!l&&Vt&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var f=this.schema.idxByName;function h(w,C){return ye(w,C)===0}var y=s.reduce(function(S,C){var D=S[0],O=S[1],S=f[C],P=a[C];return[D||S,D||!S?on(O,S&&S.multi?function(E){return E=te(E,C),u(E)&&E.some(function(R){return h(P,R)})}:function(E){return h(P,te(E,C))}):O]},[null,null]),g=y[0],y=y[1];return g?this.where(g.name).equals(a[g.keyPath]).filter(y):l?this.filter(y):this.where(s).equals("")},Pe.prototype.filter=function(a){return this.toCollection().and(a)},Pe.prototype.count=function(a){return this.toCollection().count(a)},Pe.prototype.offset=function(a){return this.toCollection().offset(a)},Pe.prototype.limit=function(a){return this.toCollection().limit(a)},Pe.prototype.each=function(a){return this.toCollection().each(a)},Pe.prototype.toArray=function(a){return this.toCollection().toArray(a)},Pe.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Pe.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,u(a)?"[".concat(a.join("+"),"]"):a))},Pe.prototype.reverse=function(){return this.toCollection().reverse()},Pe.prototype.mapToClass=function(a){var s,l=this.db,f=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof vl&&(function(C,D){if(typeof D!="function"&&D!==null)throw new TypeError("Class extends value "+String(D)+" is not a constructor or null");function O(){this.constructor=C}r(C,D),C.prototype=D===null?Object.create(D):(O.prototype=D.prototype,new O)}(h,s=a),Object.defineProperty(h.prototype,"db",{get:function(){return l},enumerable:!1,configurable:!0}),h.prototype.table=function(){return f},a=h);for(var g=new Set,y=a.prototype;y;y=p(y))Object.getOwnPropertyNames(y).forEach(function(C){return g.add(C)});function w(C){if(!C)return C;var D,O=Object.create(a.prototype);for(D in C)if(!g.has(D))try{O[D]=C[D]}catch{}return O}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=w,this.hook("reading",w),a},Pe.prototype.defineClass=function(){return this.mapToClass(function(a){d(this,a)})},Pe.prototype.add=function(a,s){var l=this,f=this.schema.primKey,h=f.auto,g=f.keyPath,y=a;return g&&h&&(y=Gi(g)(a)),this._trans("readwrite",function(w){return l.core.mutate({trans:w,type:"add",keys:s!=null?[s]:null,values:[y]})}).then(function(w){return w.numFailures?Q.reject(w.failures[0]):w.lastResult}).then(function(w){if(g)try{Z(a,g,w)}catch{}return w})},Pe.prototype.update=function(a,s){return typeof a!="object"||u(a)?this.where(":id").equals(a).modify(s):(a=te(a,this.schema.primKey.keyPath),a===void 0?Be(new ie.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(s))},Pe.prototype.put=function(a,s){var l=this,f=this.schema.primKey,h=f.auto,g=f.keyPath,y=a;return g&&h&&(y=Gi(g)(a)),this._trans("readwrite",function(w){return l.core.mutate({trans:w,type:"put",values:[y],keys:s!=null?[s]:null})}).then(function(w){return w.numFailures?Q.reject(w.failures[0]):w.lastResult}).then(function(w){if(g)try{Z(a,g,w)}catch{}return w})},Pe.prototype.delete=function(a){var s=this;return this._trans("readwrite",function(l){return s.core.mutate({trans:l,type:"delete",keys:[a]})}).then(function(l){return l.numFailures?Q.reject(l.failures[0]):void 0})},Pe.prototype.clear=function(){var a=this;return this._trans("readwrite",function(s){return a.core.mutate({trans:s,type:"deleteRange",range:gl})}).then(function(s){return s.numFailures?Q.reject(s.failures[0]):void 0})},Pe.prototype.bulkGet=function(a){var s=this;return this._trans("readonly",function(l){return s.core.getMany({keys:a,trans:l}).then(function(f){return f.map(function(h){return s.hook.reading.fire(h)})})})},Pe.prototype.bulkAdd=function(a,s,l){var f=this,h=Array.isArray(s)?s:void 0,g=(l=l||(h?void 0:s))?l.allKeys:void 0;return this._trans("readwrite",function(y){var D=f.schema.primKey,w=D.auto,D=D.keyPath;if(D&&h)throw new ie.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var C=a.length,D=D&&w?a.map(Gi(D)):a;return f.core.mutate({trans:y,type:"add",keys:h,values:D,wantResults:g}).then(function(R){var S=R.numFailures,P=R.results,E=R.lastResult,R=R.failures;if(S===0)return g?P:E;throw new Ir("".concat(f.name,".bulkAdd(): ").concat(S," of ").concat(C," operations failed"),R)})})},Pe.prototype.bulkPut=function(a,s,l){var f=this,h=Array.isArray(s)?s:void 0,g=(l=l||(h?void 0:s))?l.allKeys:void 0;return this._trans("readwrite",function(y){var D=f.schema.primKey,w=D.auto,D=D.keyPath;if(D&&h)throw new ie.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new ie.InvalidArgument("Arguments objects and keys must have the same length");var C=a.length,D=D&&w?a.map(Gi(D)):a;return f.core.mutate({trans:y,type:"put",keys:h,values:D,wantResults:g}).then(function(R){var S=R.numFailures,P=R.results,E=R.lastResult,R=R.failures;if(S===0)return g?P:E;throw new Ir("".concat(f.name,".bulkPut(): ").concat(S," of ").concat(C," operations failed"),R)})})},Pe.prototype.bulkUpdate=function(a){var s=this,l=this.core,f=a.map(function(y){return y.key}),h=a.map(function(y){return y.changes}),g=[];return this._trans("readwrite",function(y){return l.getMany({trans:y,keys:f,cache:"clone"}).then(function(w){var C=[],D=[];a.forEach(function(S,P){var E=S.key,R=S.changes,L=w[P];if(L){for(var x=0,$=Object.keys(R);x<$.length;x++){var M=$[x],T=R[M];if(M===s.schema.primKey.keyPath){if(ye(T,E)!==0)throw new ie.Constraint("Cannot update primary key in bulkUpdate()")}else Z(L,M,T)}g.push(P),C.push(E),D.push(L)}});var O=C.length;return l.mutate({trans:y,type:"put",keys:C,values:D,updates:{keys:f,changeSpecs:h}}).then(function(S){var P=S.numFailures,E=S.failures;if(P===0)return O;for(var R=0,L=Object.keys(E);R<L.length;R++){var x,$=L[R],M=g[Number($)];M!=null&&(x=E[$],delete E[$],E[M]=x)}throw new Ir("".concat(s.name,".bulkUpdate(): ").concat(P," of ").concat(O," operations failed"),E)})})})},Pe.prototype.bulkDelete=function(a){var s=this,l=a.length;return this._trans("readwrite",function(f){return s.core.mutate({trans:f,type:"delete",keys:a})}).then(function(y){var h=y.numFailures,g=y.lastResult,y=y.failures;if(h===0)return g;throw new Ir("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(l," operations failed"),y)})},Pe);function Pe(){}function Po(a){function s(y,w){if(w){for(var C=arguments.length,D=new Array(C-1);--C;)D[C-1]=arguments[C];return l[y].subscribe.apply(null,D),a}if(typeof y=="string")return l[y]}var l={};s.addEventType=g;for(var f=1,h=arguments.length;f<h;++f)g(arguments[f]);return s;function g(y,w,C){if(typeof y!="object"){var D;w=w||sm;var O={subscribers:[],fire:C=C||Se,subscribe:function(S){O.subscribers.indexOf(S)===-1&&(O.subscribers.push(S),O.fire=w(O.fire,S))},unsubscribe:function(S){O.subscribers=O.subscribers.filter(function(P){return P!==S}),O.fire=O.subscribers.reduce(w,C)}};return l[y]=s[y]=O}c(D=y).forEach(function(S){var P=D[S];if(u(P))g(S,D[S][0],D[S][1]);else{if(P!=="asap")throw new ie.InvalidArgument("Invalid event config");var E=g(S,xo,function(){for(var R=arguments.length,L=new Array(R);R--;)L[R]=arguments[R];E.subscribers.forEach(function(x){oe(function(){x.apply(null,L)})})})}})}}function $o(a,s){return k(s).from({prototype:a}),s}function Bn(a,s){return!(a.filter||a.algorithm||a.or)&&(s?a.justLimit:!a.replayFilter)}function Ts(a,s){a.filter=on(a.filter,s)}function Ns(a,s,l){var f=a.replayFilter;a.replayFilter=f?function(){return on(f(),s())}:s,a.justLimit=l&&!f}function Yi(a,s){if(a.isPrimKey)return s.primaryKey;var l=s.getIndexByKeyPath(a.index);if(!l)throw new ie.Schema("KeyPath "+a.index+" on object store "+s.name+" is not indexed");return l}function _l(a,s,l){var f=Yi(a,s.schema);return s.openCursor({trans:l,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:f,range:a.range}})}function Ji(a,s,l,f){var h=a.replayFilter?on(a.filter,a.replayFilter()):a.filter;if(a.or){var g={},y=function(w,C,D){var O,S;h&&!h(C,D,function(P){return C.stop(P)},function(P){return C.fail(P)})||((S=""+(O=C.primaryKey))=="[object ArrayBuffer]"&&(S=""+new Uint8Array(O)),v(g,S)||(g[S]=!0,s(w,C,D)))};return Promise.all([a.or._iterate(y,l),Sl(_l(a,f,l),a.algorithm,y,!a.keysOnly&&a.valueMapper)])}return Sl(_l(a,f,l),on(a.algorithm,h),s,!a.keysOnly&&a.valueMapper)}function Sl(a,s,l,f){var h=Me(f?function(g,y,w){return l(f(g),y,w)}:l);return a.then(function(g){if(g)return g.start(function(){var y=function(){return g.continue()};s&&!s(g,function(w){return y=w},function(w){g.stop(w),y=Se},function(w){g.fail(w),y=Se})||h(g.value,g,function(w){return y=w}),y()})})}var nr=Symbol(),Ao=(Il.prototype.execute=function(a){if(this.add!==void 0){var s=this.add;if(u(s))return o(o([],u(a)?a:[],!0),s).sort();if(typeof s=="number")return(Number(a)||0)+s;if(typeof s=="bigint")try{return BigInt(a)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(this.remove!==void 0){var l=this.remove;if(u(l))return u(a)?a.filter(function(f){return!l.includes(f)}).sort():[];if(typeof l=="number")return Number(a)-l;if(typeof l=="bigint")try{return BigInt(a)-l}catch{return BigInt(0)-l}throw new TypeError("Invalid subtrahend ".concat(l))}return s=(s=this.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof a=="string"&&a.startsWith(s)?this.replacePrefix[1]+a.substring(s.length):a},Il);function Il(a){Object.assign(this,a)}var hm=(_e.prototype._read=function(a,s){var l=this._ctx;return l.error?l.table._trans(null,Be.bind(null,l.error)):l.table._trans("readonly",a).then(s)},_e.prototype._write=function(a){var s=this._ctx;return s.error?s.table._trans(null,Be.bind(null,s.error)):s.table._trans("readwrite",a,"locked")},_e.prototype._addAlgorithm=function(a){var s=this._ctx;s.algorithm=on(s.algorithm,a)},_e.prototype._iterate=function(a,s){return Ji(this._ctx,a,s,this._ctx.table.core)},_e.prototype.clone=function(a){var s=Object.create(this.constructor.prototype),l=Object.create(this._ctx);return a&&d(l,a),s._ctx=l,s},_e.prototype.raw=function(){return this._ctx.valueMapper=null,this},_e.prototype.each=function(a){var s=this._ctx;return this._read(function(l){return Ji(s,a,l,s.table.core)})},_e.prototype.count=function(a){var s=this;return this._read(function(l){var f=s._ctx,h=f.table.core;if(Bn(f,!0))return h.count({trans:l,query:{index:Yi(f,h.schema),range:f.range}}).then(function(y){return Math.min(y,f.limit)});var g=0;return Ji(f,function(){return++g,!1},l,h).then(function(){return g})}).then(a)},_e.prototype.sortBy=function(a,s){var l=a.split(".").reverse(),f=l[0],h=l.length-1;function g(C,D){return D?g(C[l[D]],D-1):C[f]}var y=this._ctx.dir==="next"?1:-1;function w(C,D){return ye(g(C,h),g(D,h))*y}return this.toArray(function(C){return C.sort(w)}).then(s)},_e.prototype.toArray=function(a){var s=this;return this._read(function(l){var f=s._ctx;if(f.dir==="next"&&Bn(f,!0)&&0<f.limit){var h=f.valueMapper,g=Yi(f,f.table.core.schema);return f.table.core.query({trans:l,limit:f.limit,values:!0,query:{index:g,range:f.range}}).then(function(w){return w=w.result,h?w.map(h):w})}var y=[];return Ji(f,function(w){return y.push(w)},l,f.table.core).then(function(){return y})},a)},_e.prototype.offset=function(a){var s=this._ctx;return a<=0||(s.offset+=a,Bn(s)?Ns(s,function(){var l=a;return function(f,h){return l===0||(l===1?--l:h(function(){f.advance(l),l=0}),!1)}}):Ns(s,function(){var l=a;return function(){return--l<0}})),this},_e.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),Ns(this._ctx,function(){var s=a;return function(l,f,h){return--s<=0&&f(h),0<=s}},!0),this},_e.prototype.until=function(a,s){return Ts(this._ctx,function(l,f,h){return!a(l.value)||(f(h),s)}),this},_e.prototype.first=function(a){return this.limit(1).toArray(function(s){return s[0]}).then(a)},_e.prototype.last=function(a){return this.reverse().first(a)},_e.prototype.filter=function(a){var s;return Ts(this._ctx,function(l){return a(l.value)}),(s=this._ctx).isMatch=on(s.isMatch,a),this},_e.prototype.and=function(a){return this.filter(a)},_e.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},_e.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},_e.prototype.desc=function(){return this.reverse()},_e.prototype.eachKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(l,f){a(f.key,f)})},_e.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},_e.prototype.eachPrimaryKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(l,f){a(f.primaryKey,f)})},_e.prototype.keys=function(a){var s=this._ctx;s.keysOnly=!s.isMatch;var l=[];return this.each(function(f,h){l.push(h.key)}).then(function(){return l}).then(a)},_e.prototype.primaryKeys=function(a){var s=this._ctx;if(s.dir==="next"&&Bn(s,!0)&&0<s.limit)return this._read(function(f){var h=Yi(s,s.table.core.schema);return s.table.core.query({trans:f,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(f){return f.result}).then(a);s.keysOnly=!s.isMatch;var l=[];return this.each(function(f,h){l.push(h.primaryKey)}).then(function(){return l}).then(a)},_e.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},_e.prototype.firstKey=function(a){return this.limit(1).keys(function(s){return s[0]}).then(a)},_e.prototype.lastKey=function(a){return this.reverse().firstKey(a)},_e.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var s={};return Ts(this._ctx,function(h){var f=h.primaryKey.toString(),h=v(s,f);return s[f]=!0,!h}),this},_e.prototype.modify=function(a){var s=this,l=this._ctx;return this._write(function(f){var h,g,y;y=typeof a=="function"?a:(h=c(a),g=h.length,function(x){for(var $=!1,M=0;M<g;++M){var T=h[M],N=a[T],B=te(x,T);N instanceof Ao?(Z(x,T,N.execute(B)),$=!0):B!==N&&(Z(x,T,N),$=!0)}return $});var w=l.table.core,S=w.schema.primaryKey,C=S.outbound,D=S.extractKey,O=200,S=s.db._options.modifyChunkSize;S&&(O=typeof S=="object"?S[w.name]||S["*"]||200:S);function P(x,T){var M=T.failures,T=T.numFailures;R+=x-T;for(var N=0,B=c(M);N<B.length;N++){var z=B[N];E.push(M[z])}}var E=[],R=0,L=[];return s.clone().primaryKeys().then(function(x){function $(T){var N=Math.min(O,x.length-T);return w.getMany({trans:f,keys:x.slice(T,T+N),cache:"immutable"}).then(function(B){for(var z=[],F=[],K=C?[]:null,W=[],H=0;H<N;++H){var J=B[H],le={value:we(J),primKey:x[T+H]};y.call(le,le.value,le)!==!1&&(le.value==null?W.push(x[T+H]):C||ye(D(J),D(le.value))===0?(F.push(le.value),C&&K.push(x[T+H])):(W.push(x[T+H]),z.push(le.value)))}return Promise.resolve(0<z.length&&w.mutate({trans:f,type:"add",values:z}).then(function(pe){for(var me in pe.failures)W.splice(parseInt(me),1);P(z.length,pe)})).then(function(){return(0<F.length||M&&typeof a=="object")&&w.mutate({trans:f,type:"put",keys:K,values:F,criteria:M,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<T}).then(function(pe){return P(F.length,pe)})}).then(function(){return(0<W.length||M&&a===qs)&&w.mutate({trans:f,type:"delete",keys:W,criteria:M,isAdditionalChunk:0<T}).then(function(pe){return P(W.length,pe)})}).then(function(){return x.length>T+N&&$(T+O)})})}var M=Bn(l)&&l.limit===1/0&&(typeof a!="function"||a===qs)&&{index:l.index,range:l.range};return $(0).then(function(){if(0<E.length)throw new Dt("Error modifying one or more objects",E,R,L);return x.length})})})},_e.prototype.delete=function(){var a=this._ctx,s=a.range;return Bn(a)&&(a.isPrimKey||s.type===3)?this._write(function(l){var f=a.table.core.schema.primaryKey,h=s;return a.table.core.count({trans:l,query:{index:f,range:h}}).then(function(g){return a.table.core.mutate({trans:l,type:"deleteRange",range:h}).then(function(y){var w=y.failures;if(y.lastResult,y.results,y=y.numFailures,y)throw new Dt("Could not delete some values",Object.keys(w).map(function(C){return w[C]}),g-y);return g-y})})}):this.modify(qs)},_e);function _e(){}var qs=function(a,s){return s.value=null};function pm(a,s){return a<s?-1:a===s?0:1}function mm(a,s){return s<a?-1:a===s?0:1}function gt(a,s,l){return a=a instanceof El?new a.Collection(a):a,a._ctx.error=new(l||TypeError)(s),a}function Fn(a){return new a.Collection(a,function(){return Cl("")}).limit(0)}function Xi(a,s,l,f){var h,g,y,w,C,D,O,S=l.length;if(!l.every(function(R){return typeof R=="string"}))return gt(a,ml);function P(R){h=R==="next"?function(x){return x.toUpperCase()}:function(x){return x.toLowerCase()},g=R==="next"?function(x){return x.toLowerCase()}:function(x){return x.toUpperCase()},y=R==="next"?pm:mm;var L=l.map(function(x){return{lower:g(x),upper:h(x)}}).sort(function(x,$){return y(x.lower,$.lower)});w=L.map(function(x){return x.upper}),C=L.map(function(x){return x.lower}),O=(D=R)==="next"?"":f}P("next"),a=new a.Collection(a,function(){return kr(w[0],C[S-1]+f)}),a._ondirectionchange=function(R){P(R)};var E=0;return a._addAlgorithm(function(R,L,x){var $=R.key;if(typeof $!="string")return!1;var M=g($);if(s(M,C,E))return!0;for(var T=null,N=E;N<S;++N){var B=function(z,F,K,W,H,J){for(var le=Math.min(z.length,W.length),pe=-1,me=0;me<le;++me){var vt=F[me];if(vt!==W[me])return H(z[me],K[me])<0?z.substr(0,me)+K[me]+K.substr(me+1):H(z[me],W[me])<0?z.substr(0,me)+W[me]+K.substr(me+1):0<=pe?z.substr(0,pe)+F[pe]+K.substr(pe+1):null;H(z[me],vt)<0&&(pe=me)}return le<W.length&&J==="next"?z+K.substr(z.length):le<z.length&&J==="prev"?z.substr(0,K.length):pe<0?null:z.substr(0,pe)+W[pe]+K.substr(pe+1)}($,M,w[N],C[N],y,D);B===null&&T===null?E=N+1:(T===null||0<y(T,B))&&(T=B)}return L(T!==null?function(){R.continue(T+O)}:x),!1}),a}function kr(a,s,l,f){return{type:2,lower:a,upper:s,lowerOpen:l,upperOpen:f}}function Cl(a){return{type:1,lower:a,upper:a}}var El=(Object.defineProperty(Ge.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Ge.prototype.between=function(a,s,l,f){l=l!==!1,f=f===!0;try{return 0<this._cmp(a,s)||this._cmp(a,s)===0&&(l||f)&&(!l||!f)?Fn(this):new this.Collection(this,function(){return kr(a,s,!l,!f)})}catch{return gt(this,rr)}},Ge.prototype.equals=function(a){return a==null?gt(this,rr):new this.Collection(this,function(){return Cl(a)})},Ge.prototype.above=function(a){return a==null?gt(this,rr):new this.Collection(this,function(){return kr(a,void 0,!0)})},Ge.prototype.aboveOrEqual=function(a){return a==null?gt(this,rr):new this.Collection(this,function(){return kr(a,void 0,!1)})},Ge.prototype.below=function(a){return a==null?gt(this,rr):new this.Collection(this,function(){return kr(void 0,a,!1,!0)})},Ge.prototype.belowOrEqual=function(a){return a==null?gt(this,rr):new this.Collection(this,function(){return kr(void 0,a)})},Ge.prototype.startsWith=function(a){return typeof a!="string"?gt(this,ml):this.between(a,a+nn,!0,!0)},Ge.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):Xi(this,function(s,l){return s.indexOf(l[0])===0},[a],nn)},Ge.prototype.equalsIgnoreCase=function(a){return Xi(this,function(s,l){return s===l[0]},[a],"")},Ge.prototype.anyOfIgnoreCase=function(){var a=se.apply(at,arguments);return a.length===0?Fn(this):Xi(this,function(s,l){return l.indexOf(s)!==-1},a,"")},Ge.prototype.startsWithAnyOfIgnoreCase=function(){var a=se.apply(at,arguments);return a.length===0?Fn(this):Xi(this,function(s,l){return l.some(function(f){return s.indexOf(f)===0})},a,nn)},Ge.prototype.anyOf=function(){var a=this,s=se.apply(at,arguments),l=this._cmp;try{s.sort(l)}catch{return gt(this,rr)}if(s.length===0)return Fn(this);var f=new this.Collection(this,function(){return kr(s[0],s[s.length-1])});f._ondirectionchange=function(g){l=g==="next"?a._ascending:a._descending,s.sort(l)};var h=0;return f._addAlgorithm(function(g,y,w){for(var C=g.key;0<l(C,s[h]);)if(++h===s.length)return y(w),!1;return l(C,s[h])===0||(y(function(){g.continue(s[h])}),!1)}),f},Ge.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Ge.prototype.noneOf=function(){var a=se.apply(at,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return gt(this,rr)}var s=a.reduce(function(l,f){return l?l.concat([[l[l.length-1][1],f]]):[[-1/0,f]]},null);return s.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},Ge.prototype.inAnyRange=function($,s){var l=this,f=this._cmp,h=this._ascending,g=this._descending,y=this._min,w=this._max;if($.length===0)return Fn(this);if(!$.every(function(M){return M[0]!==void 0&&M[1]!==void 0&&h(M[0],M[1])<=0}))return gt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",ie.InvalidArgument);var C=!s||s.includeLowers!==!1,D=s&&s.includeUppers===!0,O,S=h;function P(M,T){return S(M[0],T[0])}try{(O=$.reduce(function(M,T){for(var N=0,B=M.length;N<B;++N){var z=M[N];if(f(T[0],z[1])<0&&0<f(T[1],z[0])){z[0]=y(z[0],T[0]),z[1]=w(z[1],T[1]);break}}return N===B&&M.push(T),M},[])).sort(P)}catch{return gt(this,rr)}var E=0,R=D?function(M){return 0<h(M,O[E][1])}:function(M){return 0<=h(M,O[E][1])},L=C?function(M){return 0<g(M,O[E][0])}:function(M){return 0<=g(M,O[E][0])},x=R,$=new this.Collection(this,function(){return kr(O[0][0],O[O.length-1][1],!C,!D)});return $._ondirectionchange=function(M){S=M==="next"?(x=R,h):(x=L,g),O.sort(P)},$._addAlgorithm(function(M,T,N){for(var B,z=M.key;x(z);)if(++E===O.length)return T(N),!1;return!R(B=z)&&!L(B)||(l._cmp(z,O[E][1])===0||l._cmp(z,O[E][0])===0||T(function(){S===h?M.continue(O[E][0]):M.continue(O[E][1])}),!1)}),$},Ge.prototype.startsWithAnyOf=function(){var a=se.apply(at,arguments);return a.every(function(s){return typeof s=="string"})?a.length===0?Fn(this):this.inAnyRange(a.map(function(s){return[s,s+nn]})):gt(this,"startsWithAnyOf() only works with strings")},Ge);function Ge(){}function Qt(a){return Me(function(s){return Mo(s),a(s.target.error),!1})}function Mo(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var To="storagemutated",Bs="x-storagemutated-1",Rr=Po(null,To),gm=(Gt.prototype._lock=function(){return ae(!ne.global),++this._reculock,this._reculock!==1||ne.global||(ne.lockOwnerFor=this),this},Gt.prototype._unlock=function(){if(ae(!ne.global),--this._reculock==0)for(ne.global||(ne.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{rn(a[1],a[0])}catch{}}return this},Gt.prototype._locked=function(){return this._reculock&&ne.lockOwnerFor!==this},Gt.prototype.create=function(a){var s=this;if(!this.mode)return this;var l=this.db.idbdb,f=this.db._state.dbOpenError;if(ae(!this.idbtrans),!a&&!l)switch(f&&f.name){case"DatabaseClosedError":throw new ie.DatabaseClosed(f);case"MissingAPIError":throw new ie.MissingAPI(f.message,f);default:throw new ie.OpenFailed(f)}if(!this.active)throw new ie.TransactionInactive;return ae(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||l).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=Me(function(h){Mo(h),s._reject(a.error)}),a.onabort=Me(function(h){Mo(h),s.active&&s._reject(new ie.Abort(a.error)),s.active=!1,s.on("abort").fire(h)}),a.oncomplete=Me(function(){s.active=!1,s._resolve(),"mutatedParts"in a&&Rr.storagemutated.fire(a.mutatedParts)}),this},Gt.prototype._promise=function(a,s,l){var f=this;if(a==="readwrite"&&this.mode!=="readwrite")return Be(new ie.ReadOnly("Transaction is readonly"));if(!this.active)return Be(new ie.TransactionInactive);if(this._locked())return new Q(function(g,y){f._blockedFuncs.push([function(){f._promise(a,s,l).then(g,y)},ne])});if(l)return Er(function(){var g=new Q(function(y,w){f._lock();var C=s(y,w,f);C&&C.then&&C.then(y,w)});return g.finally(function(){return f._unlock()}),g._lib=!0,g});var h=new Q(function(g,y){var w=s(g,y,f);w&&w.then&&w.then(g,y)});return h._lib=!0,h},Gt.prototype._root=function(){return this.parent?this.parent._root():this},Gt.prototype.waitFor=function(a){var s,l=this._root(),f=Q.resolve(a);l._waitingFor?l._waitingFor=l._waitingFor.then(function(){return f}):(l._waitingFor=f,l._waitingQueue=[],s=l.idbtrans.objectStore(l.storeNames[0]),function g(){for(++l._spinCount;l._waitingQueue.length;)l._waitingQueue.shift()();l._waitingFor&&(s.get(-1/0).onsuccess=g)}());var h=l._waitingFor;return new Q(function(g,y){f.then(function(w){return l._waitingQueue.push(Me(g.bind(null,w)))},function(w){return l._waitingQueue.push(Me(y.bind(null,w)))}).finally(function(){l._waitingFor===h&&(l._waitingFor=null)})})},Gt.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new ie.Abort))},Gt.prototype.table=function(a){var s=this._memoizedTables||(this._memoizedTables={});if(v(s,a))return s[a];var l=this.schema[a];if(!l)throw new ie.NotFound("Table "+a+" not part of transaction");return l=new this.db.Table(a,l,this),l.core=this.db.core.table(a),s[a]=l},Gt);function Gt(){}function Fs(a,s,l,f,h,g,y){return{name:a,keyPath:s,unique:l,multi:f,auto:h,compound:g,src:(l&&!y?"&":"")+(f?"*":"")+(h?"++":"")+Dl(s)}}function Dl(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function Us(a,s,l){return{name:a,primKey:s,indexes:l,mappedClass:null,idxByName:(f=function(h){return[h.name,h]},l.reduce(function(h,g,y){return y=f(g,y),y&&(h[y[0]]=y[1]),h},{}))};var f}var No=function(a){try{return a.only([[]]),No=function(){return[[]]},[[]]}catch{return No=function(){return nn},nn}};function js(a){return a==null?function(){}:typeof a=="string"?(s=a).split(".").length===1?function(l){return l[s]}:function(l){return te(l,s)}:function(l){return te(l,a)};var s}function xl(a){return[].slice.call(a)}var vm=0;function qo(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function ym(a,s,C){function f(x){if(x.type===3)return null;if(x.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var E=x.lower,R=x.upper,L=x.lowerOpen,x=x.upperOpen;return E===void 0?R===void 0?null:s.upperBound(R,!!x):R===void 0?s.lowerBound(E,!!L):s.bound(E,R,!!L,!!x)}function h(P){var E,R=P.name;return{name:R,schema:P,mutate:function(L){var x=L.trans,$=L.type,M=L.keys,T=L.values,N=L.range;return new Promise(function(B,z){B=Me(B);var F=x.objectStore(R),K=F.keyPath==null,W=$==="put"||$==="add";if(!W&&$!=="delete"&&$!=="deleteRange")throw new Error("Invalid operation type: "+$);var H,J=(M||T||{length:1}).length;if(M&&T&&M.length!==T.length)throw new Error("Given keys array must have same length as given values array.");if(J===0)return B({numFailures:0,failures:{},results:[],lastResult:void 0});function le(st){++vt,Mo(st)}var pe=[],me=[],vt=0;if($==="deleteRange"){if(N.type===4)return B({numFailures:vt,failures:me,results:[],lastResult:void 0});N.type===3?pe.push(H=F.clear()):pe.push(H=F.delete(f(N)))}else{var K=W?K?[T,M]:[T,null]:[M,null],ue=K[0],ot=K[1];if(W)for(var it=0;it<J;++it)pe.push(H=ot&&ot[it]!==void 0?F[$](ue[it],ot[it]):F[$](ue[it])),H.onerror=le;else for(it=0;it<J;++it)pe.push(H=F[$](ue[it])),H.onerror=le}function da(st){st=st.target.result,pe.forEach(function(cn,ac){return cn.error!=null&&(me[ac]=cn.error)}),B({numFailures:vt,failures:me,results:$==="delete"?M:pe.map(function(cn){return cn.result}),lastResult:st})}H.onerror=function(st){le(st),da(st)},H.onsuccess=da})},getMany:function(L){var x=L.trans,$=L.keys;return new Promise(function(M,T){M=Me(M);for(var N,B=x.objectStore(R),z=$.length,F=new Array(z),K=0,W=0,H=function(pe){pe=pe.target,F[pe._pos]=pe.result,++W===K&&M(F)},J=Qt(T),le=0;le<z;++le)$[le]!=null&&((N=B.get($[le]))._pos=le,N.onsuccess=H,N.onerror=J,++K);K===0&&M(F)})},get:function(L){var x=L.trans,$=L.key;return new Promise(function(M,T){M=Me(M);var N=x.objectStore(R).get($);N.onsuccess=function(B){return M(B.target.result)},N.onerror=Qt(T)})},query:(E=D,function(L){return new Promise(function(x,$){x=Me(x);var M,T,N,K=L.trans,B=L.values,z=L.limit,H=L.query,F=z===1/0?void 0:z,W=H.index,H=H.range,K=K.objectStore(R),W=W.isPrimaryKey?K:K.index(W.name),H=f(H);if(z===0)return x({result:[]});E?((F=B?W.getAll(H,F):W.getAllKeys(H,F)).onsuccess=function(J){return x({result:J.target.result})},F.onerror=Qt($)):(M=0,T=!B&&"openKeyCursor"in W?W.openKeyCursor(H):W.openCursor(H),N=[],T.onsuccess=function(J){var le=T.result;return le?(N.push(B?le.value:le.primaryKey),++M===z?x({result:N}):void le.continue()):x({result:N})},T.onerror=Qt($))})}),openCursor:function(L){var x=L.trans,$=L.values,M=L.query,T=L.reverse,N=L.unique;return new Promise(function(B,z){B=Me(B);var W=M.index,F=M.range,K=x.objectStore(R),K=W.isPrimaryKey?K:K.index(W.name),W=T?N?"prevunique":"prev":N?"nextunique":"next",H=!$&&"openKeyCursor"in K?K.openKeyCursor(f(F),W):K.openCursor(f(F),W);H.onerror=Qt(z),H.onsuccess=Me(function(J){var le,pe,me,vt,ue=H.result;ue?(ue.___id=++vm,ue.done=!1,le=ue.continue.bind(ue),pe=(pe=ue.continuePrimaryKey)&&pe.bind(ue),me=ue.advance.bind(ue),vt=function(){throw new Error("Cursor not stopped")},ue.trans=x,ue.stop=ue.continue=ue.continuePrimaryKey=ue.advance=function(){throw new Error("Cursor not started")},ue.fail=Me(z),ue.next=function(){var ot=this,it=1;return this.start(function(){return it--?ot.continue():ot.stop()}).then(function(){return ot})},ue.start=function(ot){function it(){if(H.result)try{ot()}catch(st){ue.fail(st)}else ue.done=!0,ue.start=function(){throw new Error("Cursor behind last entry")},ue.stop()}var da=new Promise(function(st,cn){st=Me(st),H.onerror=Qt(cn),ue.fail=cn,ue.stop=function(ac){ue.stop=ue.continue=ue.continuePrimaryKey=ue.advance=vt,st(ac)}});return H.onsuccess=Me(function(st){H.onsuccess=it,it()}),ue.continue=le,ue.continuePrimaryKey=pe,ue.advance=me,it(),da},B(ue)):B(null)},z)})},count:function(L){var x=L.query,$=L.trans,M=x.index,T=x.range;return new Promise(function(N,B){var z=$.objectStore(R),F=M.isPrimaryKey?z:z.index(M.name),z=f(T),F=z?F.count(z):F.count();F.onsuccess=Me(function(K){return N(K.target.result)}),F.onerror=Qt(B)})}}}var g,y,w,O=(y=C,w=xl((g=a).objectStoreNames),{schema:{name:g.name,tables:w.map(function(P){return y.objectStore(P)}).map(function(P){var E=P.keyPath,x=P.autoIncrement,R=u(E),L={},x={name:P.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:E==null,compound:R,keyPath:E,autoIncrement:x,unique:!0,extractKey:js(E)},indexes:xl(P.indexNames).map(function($){return P.index($)}).map(function(N){var M=N.name,T=N.unique,B=N.multiEntry,N=N.keyPath,B={name:M,compound:u(N),keyPath:N,unique:T,multiEntry:B,extractKey:js(N)};return L[qo(N)]=B}),getIndexByKeyPath:function($){return L[qo($)]}};return L[":id"]=x.primaryKey,E!=null&&(L[qo(E)]=x.primaryKey),x})},hasGetAll:0<w.length&&"getAll"in y.objectStore(w[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),C=O.schema,D=O.hasGetAll,O=C.tables.map(h),S={};return O.forEach(function(P){return S[P.name]=P}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(P){if(!S[P])throw new Error("Table '".concat(P,"' not found"));return S[P]},MIN_KEY:-1/0,MAX_KEY:No(s),schema:C}}function bm(a,s,l,f){var h=l.IDBKeyRange;return l.indexedDB,{dbcore:(f=ym(s,h,f),a.dbcore.reduce(function(g,y){return y=y.create,n(n({},g),y(g))},f))}}function Zi(a,f){var l=f.db,f=bm(a._middlewares,l,a._deps,f);a.core=f.dbcore,a.tables.forEach(function(h){var g=h.name;a.core.schema.tables.some(function(y){return y.name===g})&&(h.core=a.core.table(g),a[g]instanceof a.Table&&(a[g].core=h.core))})}function ea(a,s,l,f){l.forEach(function(h){var g=f[h];s.forEach(function(y){var w=function C(D,O){return A(D,O)||(D=p(D))&&C(D,O)}(y,h);(!w||"value"in w&&w.value===void 0)&&(y===a.Transaction.prototype||y instanceof a.Transaction?I(y,h,{get:function(){return this.table(h)},set:function(C){_(this,h,{value:C,writable:!0,configurable:!0,enumerable:!0})}}):y[h]=new a.Table(h,g))})})}function Ks(a,s){s.forEach(function(l){for(var f in l)l[f]instanceof a.Table&&delete l[f]})}function wm(a,s){return a._cfg.version-s._cfg.version}function _m(a,s,l,f){var h=a._dbSchema;l.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=Us("$meta",Rl("")[0],[]),a._storeNames.push("$meta"));var g=a._createTransaction("readwrite",a._storeNames,h);g.create(l),g._completion.catch(f);var y=g._reject.bind(g),w=ne.transless||ne;Er(function(){return ne.trans=g,ne.transless=w,s!==0?(Zi(a,l),D=s,((C=g).storeNames.includes("$meta")?C.table("$meta").get("version").then(function(O){return O??D}):Q.resolve(D)).then(function(O){return P=O,E=g,R=l,L=[],O=(S=a)._versions,x=S._dbSchema=ra(0,S.idbdb,R),(O=O.filter(function($){return $._cfg.version>=P})).length!==0?(O.forEach(function($){L.push(function(){var M=x,T=$._cfg.dbschema;na(S,M,R),na(S,T,R),x=S._dbSchema=T;var N=Hs(M,T);N.add.forEach(function(W){zs(R,W[0],W[1].primKey,W[1].indexes)}),N.change.forEach(function(W){if(W.recreate)throw new ie.Upgrade("Not yet support for changing primary key");var H=R.objectStore(W.name);W.add.forEach(function(J){return ta(H,J)}),W.change.forEach(function(J){H.deleteIndex(J.name),ta(H,J)}),W.del.forEach(function(J){return H.deleteIndex(J)})});var B=$._cfg.contentUpgrade;if(B&&$._cfg.version>P){Zi(S,R),E._memoizedTables={};var z=ce(T);N.del.forEach(function(W){z[W]=M[W]}),Ks(S,[S.Transaction.prototype]),ea(S,[S.Transaction.prototype],c(z),z),E.schema=z;var F,K=Ae(B);return K&&Nn(),N=Q.follow(function(){var W;(F=B(E))&&K&&(W=Dr.bind(null,null),F.then(W,W))}),F&&typeof F.then=="function"?Q.resolve(F):N.then(function(){return F})}}),L.push(function(M){var T,N,B=$._cfg.dbschema;T=B,N=M,[].slice.call(N.db.objectStoreNames).forEach(function(z){return T[z]==null&&N.db.deleteObjectStore(z)}),Ks(S,[S.Transaction.prototype]),ea(S,[S.Transaction.prototype],S._storeNames,S._dbSchema),E.schema=S._dbSchema}),L.push(function(M){S.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(S.idbdb.version/10)===$._cfg.version?(S.idbdb.deleteObjectStore("$meta"),delete S._dbSchema.$meta,S._storeNames=S._storeNames.filter(function(T){return T!=="$meta"})):M.objectStore("$meta").put($._cfg.version,"version"))})}),function $(){return L.length?Q.resolve(L.shift()(E.idbtrans)).then($):Q.resolve()}().then(function(){kl(x,R)})):Q.resolve();var S,P,E,R,L,x}).catch(y)):(c(h).forEach(function(O){zs(l,O,h[O].primKey,h[O].indexes)}),Zi(a,l),void Q.follow(function(){return a.on.populate.fire(g)}).catch(y));var C,D})}function Sm(a,s){kl(a._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var l=ra(0,a.idbdb,s);na(a,a._dbSchema,s);for(var f=0,h=Hs(l,a._dbSchema).change;f<h.length;f++){var g=function(y){if(y.change.length||y.recreate)return console.warn("Unable to patch indexes of table ".concat(y.name," because it has changes on the type of index or primary key.")),{value:void 0};var w=s.objectStore(y.name);y.add.forEach(function(C){Vt&&console.debug("Dexie upgrade patch: Creating missing index ".concat(y.name,".").concat(C.src)),ta(w,C)})}(h[f]);if(typeof g=="object")return g.value}}function Hs(a,s){var l,f={del:[],add:[],change:[]};for(l in a)s[l]||f.del.push(l);for(l in s){var h=a[l],g=s[l];if(h){var y={name:l,def:g,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(g.primKey.keyPath||"")||h.primKey.auto!==g.primKey.auto)y.recreate=!0,f.change.push(y);else{var w=h.idxByName,C=g.idxByName,D=void 0;for(D in w)C[D]||y.del.push(D);for(D in C){var O=w[D],S=C[D];O?O.src!==S.src&&y.change.push(S):y.add.push(S)}(0<y.del.length||0<y.add.length||0<y.change.length)&&f.change.push(y)}}else f.add.push([l,g])}return f}function zs(a,s,l,f){var h=a.db.createObjectStore(s,l.keyPath?{keyPath:l.keyPath,autoIncrement:l.auto}:{autoIncrement:l.auto});return f.forEach(function(g){return ta(h,g)}),h}function kl(a,s){c(a).forEach(function(l){s.db.objectStoreNames.contains(l)||(Vt&&console.debug("Dexie: Creating missing table",l),zs(s,l,a[l].primKey,a[l].indexes))})}function ta(a,s){a.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function ra(a,s,l){var f={};return U(s.objectStoreNames,0).forEach(function(h){for(var g=l.objectStore(h),y=Fs(Dl(D=g.keyPath),D||"",!0,!1,!!g.autoIncrement,D&&typeof D!="string",!0),w=[],C=0;C<g.indexNames.length;++C){var O=g.index(g.indexNames[C]),D=O.keyPath,O=Fs(O.name,D,!!O.unique,!!O.multiEntry,!1,D&&typeof D!="string",!1);w.push(O)}f[h]=Us(h,y,w)}),f}function na(a,s,l){for(var f=l.db.objectStoreNames,h=0;h<f.length;++h){var g=f[h],y=l.objectStore(g);a._hasGetAll="getAll"in y;for(var w=0;w<y.indexNames.length;++w){var C=y.indexNames[w],D=y.index(C).keyPath,O=typeof D=="string"?D:"["+U(D).join("+")+"]";!s[g]||(D=s[g].idxByName[O])&&(D.name=C,delete s[g].idxByName[O],s[g].idxByName[C]=D)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&i.WorkerGlobalScope&&i instanceof i.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function Rl(a){return a.split(",").map(function(s,l){var f=(s=s.trim()).replace(/([&*]|\+\+)/g,""),h=/^\[/.test(f)?f.match(/^\[(.*)\]$/)[1].split("+"):f;return Fs(f,h||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),u(h),l===0)})}var Im=(oa.prototype._parseStoresSpec=function(a,s){c(a).forEach(function(l){if(a[l]!==null){var f=Rl(a[l]),h=f.shift();if(h.unique=!0,h.multi)throw new ie.Schema("Primary key cannot be multi-valued");f.forEach(function(g){if(g.auto)throw new ie.Schema("Only primary key can be marked as autoIncrement (++)");if(!g.keyPath)throw new ie.Schema("Index must have a name and cannot be an empty string")}),s[l]=Us(l,h,f)}})},oa.prototype.stores=function(l){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?d(this._cfg.storesSource,l):l;var l=s._versions,f={},h={};return l.forEach(function(g){d(f,g._cfg.storesSource),h=g._cfg.dbschema={},g._parseStoresSpec(f,h)}),s._dbSchema=h,Ks(s,[s._allTables,s,s.Transaction.prototype]),ea(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],c(h),h),s._storeNames=c(h),this},oa.prototype.upgrade=function(a){return this._cfg.contentUpgrade=Es(this._cfg.contentUpgrade||Se,a),this},oa);function oa(){}function Ws(a,s){var l=a._dbNamesDB;return l||(l=a._dbNamesDB=new or(Qi,{addons:[],indexedDB:a,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),l.table("dbnames")}function Vs(a){return a&&typeof a.databases=="function"}function Qs(a){return Er(function(){return ne.letThrough=!0,a()})}function Gs(a){return!("from"in a)}var nt=function(a,s){if(!this){var l=new nt;return a&&"d"in a&&d(l,a),l}d(this,arguments.length?{d:1,from:a,to:1<arguments.length?s:a}:{d:0})};function Bo(a,s,l){var f=ye(s,l);if(!isNaN(f)){if(0<f)throw RangeError();if(Gs(a))return d(a,{from:s,to:l,d:1});var h=a.l,f=a.r;if(ye(l,a.from)<0)return h?Bo(h,s,l):a.l={from:s,to:l,d:1,l:null,r:null},Ll(a);if(0<ye(s,a.to))return f?Bo(f,s,l):a.r={from:s,to:l,d:1,l:null,r:null},Ll(a);ye(s,a.from)<0&&(a.from=s,a.l=null,a.d=f?f.d+1:1),0<ye(l,a.to)&&(a.to=l,a.r=null,a.d=a.l?a.l.d+1:1),l=!a.r,h&&!a.l&&Fo(a,h),f&&l&&Fo(a,f)}}function Fo(a,s){Gs(s)||function l(f,C){var g=C.from,y=C.to,w=C.l,C=C.r;Bo(f,g,y),w&&l(f,w),C&&l(f,C)}(a,s)}function Ol(a,s){var l=ia(s),f=l.next();if(f.done)return!1;for(var h=f.value,g=ia(a),y=g.next(h.from),w=y.value;!f.done&&!y.done;){if(ye(w.from,h.to)<=0&&0<=ye(w.to,h.from))return!0;ye(h.from,w.from)<0?h=(f=l.next(w.from)).value:w=(y=g.next(h.from)).value}return!1}function ia(a){var s=Gs(a)?null:{s:0,n:a};return{next:function(l){for(var f=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,f)for(;s.n.l&&ye(l,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!f||ye(l,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function Ll(a){var s,l,f=(((s=a.r)===null||s===void 0?void 0:s.d)||0)-(((l=a.l)===null||l===void 0?void 0:l.d)||0),h=1<f?"r":f<-1?"l":"";h&&(s=h=="r"?"l":"r",l=n({},a),f=a[h],a.from=f.from,a.to=f.to,a[h]=f[h],l[h]=f[s],(a[s]=l).d=Pl(l)),a.d=Pl(a)}function Pl(l){var s=l.r,l=l.l;return(s?l?Math.max(s.d,l.d):s.d:l?l.d:0)+1}function aa(a,s){return c(s).forEach(function(l){a[l]?Fo(a[l],s[l]):a[l]=function f(h){var g,y,w={};for(g in h)v(h,g)&&(y=h[g],w[g]=!y||typeof y!="object"||Le.has(y.constructor)?y:f(y));return w}(s[l])}),a}function Ys(a,s){return a.all||s.all||Object.keys(a).some(function(l){return s[l]&&Ol(s[l],a[l])})}b(nt.prototype,((xt={add:function(a){return Fo(this,a),this},addKey:function(a){return Bo(this,a,a),this},addKeys:function(a){var s=this;return a.forEach(function(l){return Bo(s,l,l)}),this},hasKey:function(a){var s=ia(this).next(a).value;return s&&ye(s.from,a)<=0&&0<=ye(s.to,a)}})[rt]=function(){return ia(this)},xt));var an={},Js={},Xs=!1;function sa(a){aa(Js,a),Xs||(Xs=!0,setTimeout(function(){Xs=!1,Zs(Js,!(Js={}))},0))}function Zs(a,s){s===void 0&&(s=!1);var l=new Set;if(a.all)for(var f=0,h=Object.values(an);f<h.length;f++)$l(y=h[f],a,l,s);else for(var g in a){var y,w=/^idb\:\/\/(.*)\/(.*)\//.exec(g);w&&(g=w[1],w=w[2],(y=an["idb://".concat(g,"/").concat(w)])&&$l(y,a,l,s))}l.forEach(function(C){return C()})}function $l(a,s,l,f){for(var h=[],g=0,y=Object.entries(a.queries.query);g<y.length;g++){for(var w=y[g],C=w[0],D=[],O=0,S=w[1];O<S.length;O++){var P=S[O];Ys(s,P.obsSet)?P.subscribers.forEach(function(x){return l.add(x)}):f&&D.push(P)}f&&h.push([C,D])}if(f)for(var E=0,R=h;E<R.length;E++){var L=R[E],C=L[0],D=L[1];a.queries.query[C]=D}}function Cm(a){var s=a._state,l=a._deps.indexedDB;if(s.isBeingOpened||a.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?Be(s.dbOpenError):a});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var f=s.openCanceller,h=Math.round(10*a.verno),g=!1;function y(){if(s.openCanceller!==f)throw new ie.DatabaseClosed("db.open() was cancelled")}function w(){return new Q(function(P,E){if(y(),!l)throw new ie.MissingAPI;var R=a.name,L=s.autoSchema||!h?l.open(R):l.open(R,h);if(!L)throw new ie.MissingAPI;L.onerror=Qt(E),L.onblocked=Me(a._fireOnBlocked),L.onupgradeneeded=Me(function(x){var $;O=L.transaction,s.autoSchema&&!a._options.allowEmptyDB?(L.onerror=Mo,O.abort(),L.result.close(),($=l.deleteDatabase(R)).onsuccess=$.onerror=Me(function(){E(new ie.NoSuchDatabase("Database ".concat(R," doesnt exist")))})):(O.onerror=Qt(E),x=x.oldVersion>Math.pow(2,62)?0:x.oldVersion,S=x<1,a.idbdb=L.result,g&&Sm(a,O),_m(a,x/10,O,E))},E),L.onsuccess=Me(function(){O=null;var x,$,M,T,N,B=a.idbdb=L.result,z=U(B.objectStoreNames);if(0<z.length)try{var F=B.transaction((T=z).length===1?T[0]:T,"readonly");if(s.autoSchema)$=B,M=F,(x=a).verno=$.version/10,M=x._dbSchema=ra(0,$,M),x._storeNames=U($.objectStoreNames,0),ea(x,[x._allTables],c(M),M);else if(na(a,a._dbSchema,F),((N=Hs(ra(0,(N=a).idbdb,F),N._dbSchema)).add.length||N.change.some(function(K){return K.add.length||K.change.length}))&&!g)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),B.close(),h=B.version+1,g=!0,P(w());Zi(a,F)}catch{}qn.push(a),B.onversionchange=Me(function(K){s.vcFired=!0,a.on("versionchange").fire(K)}),B.onclose=Me(function(K){a.on("close").fire(K)}),S&&(N=a._deps,F=R,B=N.indexedDB,N=N.IDBKeyRange,Vs(B)||F===Qi||Ws(B,N).put({name:F}).catch(Se)),P()},E)}).catch(function(P){switch(P==null?void 0:P.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),w();break;case"VersionError":if(0<h)return h=0,w()}return Q.reject(P)})}var C,D=s.dbReadyResolve,O=null,S=!1;return Q.race([f,(typeof navigator>"u"?Q.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(P){function E(){return indexedDB.databases().finally(P)}C=setInterval(E,100),E()}).finally(function(){return clearInterval(C)}):Promise.resolve()).then(w)]).then(function(){return y(),s.onReadyBeingFired=[],Q.resolve(Qs(function(){return a.on.ready.fire(a.vip)})).then(function P(){if(0<s.onReadyBeingFired.length){var E=s.onReadyBeingFired.reduce(Es,Se);return s.onReadyBeingFired=[],Q.resolve(Qs(function(){return E(a.vip)})).then(P)}})}).finally(function(){s.openCanceller===f&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(P){s.dbOpenError=P;try{O&&O.abort()}catch{}return f===s.openCanceller&&a._close(),Be(P)}).finally(function(){s.openComplete=!0,D()}).then(function(){var P;return S&&(P={},a.tables.forEach(function(E){E.schema.indexes.forEach(function(R){R.name&&(P["idb://".concat(a.name,"/").concat(E.name,"/").concat(R.name)]=new nt(-1/0,[[[]]]))}),P["idb://".concat(a.name,"/").concat(E.name,"/")]=P["idb://".concat(a.name,"/").concat(E.name,"/:dels")]=new nt(-1/0,[[[]]])}),Rr(To).fire(P),Zs(P,!0)),a})}function ec(a){function s(g){return a.next(g)}var l=h(s),f=h(function(g){return a.throw(g)});function h(g){return function(C){var w=g(C),C=w.value;return w.done?C:C&&typeof C.then=="function"?C.then(l,f):u(C)?Promise.all(C).then(l,f):l(C)}}return h(s)()}function ca(a,s,l){for(var f=u(a)?a.slice():[a],h=0;h<l;++h)f.push(s);return f}var Em={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return n(n({},a),{table:function(s){var l=a.table(s),f=l.schema,h={},g=[];function y(S,P,E){var R=qo(S),L=h[R]=h[R]||[],x=S==null?0:typeof S=="string"?1:S.length,$=0<P,$=n(n({},E),{name:$?"".concat(R,"(virtual-from:").concat(E.name,")"):E.name,lowLevelIndex:E,isVirtual:$,keyTail:P,keyLength:x,extractKey:js(S),unique:!$&&E.unique});return L.push($),$.isPrimaryKey||g.push($),1<x&&y(x===2?S[0]:S.slice(0,x-1),P+1,E),L.sort(function(M,T){return M.keyTail-T.keyTail}),$}s=y(f.primaryKey.keyPath,0,f.primaryKey),h[":id"]=[s];for(var w=0,C=f.indexes;w<C.length;w++){var D=C[w];y(D.keyPath,0,D)}function O(S){var P,E=S.query.index;return E.isVirtual?n(n({},S),{query:{index:E.lowLevelIndex,range:(P=S.query.range,E=E.keyTail,{type:P.type===1?2:P.type,lower:ca(P.lower,P.lowerOpen?a.MAX_KEY:a.MIN_KEY,E),lowerOpen:!0,upper:ca(P.upper,P.upperOpen?a.MIN_KEY:a.MAX_KEY,E),upperOpen:!0})}}):S}return n(n({},l),{schema:n(n({},f),{primaryKey:s,indexes:g,getIndexByKeyPath:function(S){return(S=h[qo(S)])&&S[0]}}),count:function(S){return l.count(O(S))},query:function(S){return l.query(O(S))},openCursor:function(S){var P=S.query.index,E=P.keyTail,R=P.isVirtual,L=P.keyLength;return R?l.openCursor(O(S)).then(function($){return $&&x($)}):l.openCursor(S);function x($){return Object.create($,{continue:{value:function(M){M!=null?$.continue(ca(M,S.reverse?a.MAX_KEY:a.MIN_KEY,E)):S.unique?$.continue($.key.slice(0,L).concat(S.reverse?a.MIN_KEY:a.MAX_KEY,E)):$.continue()}},continuePrimaryKey:{value:function(M,T){$.continuePrimaryKey(ca(M,a.MAX_KEY,E),T)}},primaryKey:{get:function(){return $.primaryKey}},key:{get:function(){var M=$.key;return L===1?M[0]:M.slice(0,L)}},value:{get:function(){return $.value}}})}}})}})}};function tc(a,s,l,f){return l=l||{},f=f||"",c(a).forEach(function(h){var g,y,w;v(s,h)?(g=a[h],y=s[h],typeof g=="object"&&typeof y=="object"&&g&&y?(w=Re(g))!==Re(y)?l[f+h]=s[h]:w==="Object"?tc(g,y,l,f+h+"."):g!==y&&(l[f+h]=s[h]):g!==y&&(l[f+h]=s[h])):l[f+h]=void 0}),c(s).forEach(function(h){v(a,h)||(l[f+h]=s[h])}),l}function rc(a,s){return s.type==="delete"?s.keys:s.keys||s.values.map(a.extractKey)}var Dm={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return n(n({},a),{table:function(s){var l=a.table(s),f=l.schema.primaryKey;return n(n({},l),{mutate:function(h){var g=ne.trans,y=g.table(s).hook,w=y.deleting,C=y.creating,D=y.updating;switch(h.type){case"add":if(C.fire===Se)break;return g._promise("readwrite",function(){return O(h)},!0);case"put":if(C.fire===Se&&D.fire===Se)break;return g._promise("readwrite",function(){return O(h)},!0);case"delete":if(w.fire===Se)break;return g._promise("readwrite",function(){return O(h)},!0);case"deleteRange":if(w.fire===Se)break;return g._promise("readwrite",function(){return function S(P,E,R){return l.query({trans:P,values:!1,query:{index:f,range:E},limit:R}).then(function(L){var x=L.result;return O({type:"delete",keys:x,trans:P}).then(function($){return 0<$.numFailures?Promise.reject($.failures[0]):x.length<R?{failures:[],numFailures:0,lastResult:void 0}:S(P,n(n({},E),{lower:x[x.length-1],lowerOpen:!0}),R)})})}(h.trans,h.range,1e4)},!0)}return l.mutate(h);function O(S){var P,E,R,L=ne.trans,x=S.keys||rc(f,S);if(!x)throw new Error("Keys missing");return(S=S.type==="add"||S.type==="put"?n(n({},S),{keys:x}):n({},S)).type!=="delete"&&(S.values=o([],S.values)),S.keys&&(S.keys=o([],S.keys)),P=l,R=x,((E=S).type==="add"?Promise.resolve([]):P.getMany({trans:E.trans,keys:R,cache:"immutable"})).then(function($){var M=x.map(function(T,N){var B,z,F,K=$[N],W={onerror:null,onsuccess:null};return S.type==="delete"?w.fire.call(W,T,K,L):S.type==="add"||K===void 0?(B=C.fire.call(W,T,S.values[N],L),T==null&&B!=null&&(S.keys[N]=T=B,f.outbound||Z(S.values[N],f.keyPath,T))):(B=tc(K,S.values[N]),(z=D.fire.call(W,B,T,K,L))&&(F=S.values[N],Object.keys(z).forEach(function(H){v(F,H)?F[H]=z[H]:Z(F,H,z[H])}))),W});return l.mutate(S).then(function(T){for(var N=T.failures,B=T.results,z=T.numFailures,T=T.lastResult,F=0;F<x.length;++F){var K=(B||x)[F],W=M[F];K==null?W.onerror&&W.onerror(N[F]):W.onsuccess&&W.onsuccess(S.type==="put"&&$[F]?S.values[F]:K)}return{failures:N,results:B,numFailures:z,lastResult:T}}).catch(function(T){return M.forEach(function(N){return N.onerror&&N.onerror(T)}),Promise.reject(T)})})}}})}})}};function Al(a,s,l){try{if(!s||s.keys.length<a.length)return null;for(var f=[],h=0,g=0;h<s.keys.length&&g<a.length;++h)ye(s.keys[h],a[g])===0&&(f.push(l?we(s.values[h]):s.values[h]),++g);return f.length===a.length?f:null}catch{return null}}var xm={stack:"dbcore",level:-1,create:function(a){return{table:function(s){var l=a.table(s);return n(n({},l),{getMany:function(f){if(!f.cache)return l.getMany(f);var h=Al(f.keys,f.trans._cache,f.cache==="clone");return h?Q.resolve(h):l.getMany(f).then(function(g){return f.trans._cache={keys:f.keys,values:f.cache==="clone"?we(g):g},g})},mutate:function(f){return f.type!=="add"&&(f.trans._cache=null),l.mutate(f)}})}}}};function Ml(a,s){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function Tl(a,s){switch(a){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var km={stack:"dbcore",level:0,name:"Observability",create:function(a){var s=a.schema.name,l=new nt(a.MIN_KEY,a.MAX_KEY);return n(n({},a),{transaction:function(f,h,g){if(ne.subscr&&h!=="readonly")throw new ie.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(ne.querier));return a.transaction(f,h,g)},table:function(f){var h=a.table(f),g=h.schema,y=g.primaryKey,S=g.indexes,w=y.extractKey,C=y.outbound,D=y.autoIncrement&&S.filter(function(E){return E.compound&&E.keyPath.includes(y.keyPath)}),O=n(n({},h),{mutate:function(E){function R(H){return H="idb://".concat(s,"/").concat(f,"/").concat(H),T[H]||(T[H]=new nt)}var L,x,$,M=E.trans,T=E.mutatedParts||(E.mutatedParts={}),N=R(""),B=R(":dels"),z=E.type,W=E.type==="deleteRange"?[E.range]:E.type==="delete"?[E.keys]:E.values.length<50?[rc(y,E).filter(function(H){return H}),E.values]:[],F=W[0],K=W[1],W=E.trans._cache;return u(F)?(N.addKeys(F),(W=z==="delete"||F.length===K.length?Al(F,W):null)||B.addKeys(F),(W||K)&&(L=R,x=W,$=K,g.indexes.forEach(function(H){var J=L(H.name||"");function le(me){return me!=null?H.extractKey(me):null}function pe(me){return H.multiEntry&&u(me)?me.forEach(function(vt){return J.addKey(vt)}):J.addKey(me)}(x||$).forEach(function(me,ot){var ue=x&&le(x[ot]),ot=$&&le($[ot]);ye(ue,ot)!==0&&(ue!=null&&pe(ue),ot!=null&&pe(ot))})}))):F?(K={from:(K=F.lower)!==null&&K!==void 0?K:a.MIN_KEY,to:(K=F.upper)!==null&&K!==void 0?K:a.MAX_KEY},B.add(K),N.add(K)):(N.add(l),B.add(l),g.indexes.forEach(function(H){return R(H.name).add(l)})),h.mutate(E).then(function(H){return!F||E.type!=="add"&&E.type!=="put"||(N.addKeys(H.results),D&&D.forEach(function(J){for(var le=E.values.map(function(ue){return J.extractKey(ue)}),pe=J.keyPath.findIndex(function(ue){return ue===y.keyPath}),me=0,vt=H.results.length;me<vt;++me)le[me][pe]=H.results[me];R(J.name).addKeys(le)})),M.mutatedParts=aa(M.mutatedParts||{},T),H})}}),S=function(R){var L=R.query,R=L.index,L=L.range;return[R,new nt((R=L.lower)!==null&&R!==void 0?R:a.MIN_KEY,(L=L.upper)!==null&&L!==void 0?L:a.MAX_KEY)]},P={get:function(E){return[y,new nt(E.key)]},getMany:function(E){return[y,new nt().addKeys(E.keys)]},count:S,query:S,openCursor:S};return c(P).forEach(function(E){O[E]=function(R){var L=ne.subscr,x=!!L,$=Ml(ne,h)&&Tl(E,R)?R.obsSet={}:L;if(x){var M=function(K){return K="idb://".concat(s,"/").concat(f,"/").concat(K),$[K]||($[K]=new nt)},T=M(""),N=M(":dels"),L=P[E](R),x=L[0],L=L[1];if((E==="query"&&x.isPrimaryKey&&!R.values?N:M(x.name||"")).add(L),!x.isPrimaryKey){if(E!=="count"){var B=E==="query"&&C&&R.values&&h.query(n(n({},R),{values:!1}));return h[E].apply(this,arguments).then(function(K){if(E==="query"){if(C&&R.values)return B.then(function(le){return le=le.result,T.addKeys(le),K});var W=R.values?K.result.map(w):K.result;(R.values?T:N).addKeys(W)}else if(E==="openCursor"){var H=K,J=R.values;return H&&Object.create(H,{key:{get:function(){return N.addKey(H.primaryKey),H.key}},primaryKey:{get:function(){var le=H.primaryKey;return N.addKey(le),le}},value:{get:function(){return J&&T.addKey(H.primaryKey),H.value}}})}return K})}N.add(l)}}return h[E].apply(this,arguments)}}),O}})}};function Nl(a,s,l){if(l.numFailures===0)return s;if(s.type==="deleteRange")return null;var f=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return l.numFailures===f?null:(s=n({},s),u(s.keys)&&(s.keys=s.keys.filter(function(h,g){return!(g in l.failures)})),"values"in s&&u(s.values)&&(s.values=s.values.filter(function(h,g){return!(g in l.failures)})),s)}function nc(a,s){return l=a,((f=s).lower===void 0||(f.lowerOpen?0<ye(l,f.lower):0<=ye(l,f.lower)))&&(a=a,(s=s).upper===void 0||(s.upperOpen?ye(a,s.upper)<0:ye(a,s.upper)<=0));var l,f}function ql(a,s,P,f,h,g){if(!P||P.length===0)return a;var y=s.query.index,w=y.multiEntry,C=s.query.range,D=f.schema.primaryKey.extractKey,O=y.extractKey,S=(y.lowLevelIndex||y).extractKey,P=P.reduce(function(E,R){var L=E,x=[];if(R.type==="add"||R.type==="put")for(var $=new nt,M=R.values.length-1;0<=M;--M){var T,N=R.values[M],B=D(N);$.hasKey(B)||(T=O(N),(w&&u(T)?T.some(function(H){return nc(H,C)}):nc(T,C))&&($.addKey(B),x.push(N)))}switch(R.type){case"add":var z=new nt().addKeys(s.values?E.map(function(J){return D(J)}):E),L=E.concat(s.values?x.filter(function(J){return J=D(J),!z.hasKey(J)&&(z.addKey(J),!0)}):x.map(function(J){return D(J)}).filter(function(J){return!z.hasKey(J)&&(z.addKey(J),!0)}));break;case"put":var F=new nt().addKeys(R.values.map(function(J){return D(J)}));L=E.filter(function(J){return!F.hasKey(s.values?D(J):J)}).concat(s.values?x:x.map(function(J){return D(J)}));break;case"delete":var K=new nt().addKeys(R.keys);L=E.filter(function(J){return!K.hasKey(s.values?D(J):J)});break;case"deleteRange":var W=R.range;L=E.filter(function(J){return!nc(D(J),W)})}return L},a);return P===a?a:(P.sort(function(E,R){return ye(S(E),S(R))||ye(D(E),D(R))}),s.limit&&s.limit<1/0&&(P.length>s.limit?P.length=s.limit:a.length===s.limit&&P.length<s.limit&&(h.dirty=!0)),g?Object.freeze(P):P)}function Bl(a,s){return ye(a.lower,s.lower)===0&&ye(a.upper,s.upper)===0&&!!a.lowerOpen==!!s.lowerOpen&&!!a.upperOpen==!!s.upperOpen}function Rm(a,s){return function(l,f,h,g){if(l===void 0)return f!==void 0?-1:0;if(f===void 0)return 1;if((f=ye(l,f))===0){if(h&&g)return 0;if(h)return 1;if(g)return-1}return f}(a.lower,s.lower,a.lowerOpen,s.lowerOpen)<=0&&0<=function(l,f,h,g){if(l===void 0)return f!==void 0?1:0;if(f===void 0)return-1;if((f=ye(l,f))===0){if(h&&g)return 0;if(h)return-1;if(g)return 1}return f}(a.upper,s.upper,a.upperOpen,s.upperOpen)}function Om(a,s,l,f){a.subscribers.add(l),f.addEventListener("abort",function(){var h,g;a.subscribers.delete(l),a.subscribers.size===0&&(h=a,g=s,setTimeout(function(){h.subscribers.size===0&&qe(g,h)},3e3))})}var Lm={stack:"dbcore",level:0,name:"Cache",create:function(a){var s=a.schema.name;return n(n({},a),{transaction:function(l,f,h){var g,y,w=a.transaction(l,f,h);return f==="readwrite"&&(y=(g=new AbortController).signal,h=function(C){return function(){if(g.abort(),f==="readwrite"){for(var D=new Set,O=0,S=l;O<S.length;O++){var P=S[O],E=an["idb://".concat(s,"/").concat(P)];if(E){var R=a.table(P),L=E.optimisticOps.filter(function(J){return J.trans===w});if(w._explicit&&C&&w.mutatedParts)for(var x=0,$=Object.values(E.queries.query);x<$.length;x++)for(var M=0,T=(z=$[x]).slice();M<T.length;M++)Ys((F=T[M]).obsSet,w.mutatedParts)&&(qe(z,F),F.subscribers.forEach(function(J){return D.add(J)}));else if(0<L.length){E.optimisticOps=E.optimisticOps.filter(function(J){return J.trans!==w});for(var N=0,B=Object.values(E.queries.query);N<B.length;N++)for(var z,F,K,W=0,H=(z=B[N]).slice();W<H.length;W++)(F=H[W]).res!=null&&w.mutatedParts&&(C&&!F.dirty?(K=Object.isFrozen(F.res),K=ql(F.res,F.req,L,R,F,K),F.dirty?(qe(z,F),F.subscribers.forEach(function(J){return D.add(J)})):K!==F.res&&(F.res=K,F.promise=Q.resolve({result:K}))):(F.dirty&&qe(z,F),F.subscribers.forEach(function(J){return D.add(J)})))}}}D.forEach(function(J){return J()})}}},w.addEventListener("abort",h(!1),{signal:y}),w.addEventListener("error",h(!1),{signal:y}),w.addEventListener("complete",h(!0),{signal:y})),w},table:function(l){var f=a.table(l),h=f.schema.primaryKey;return n(n({},f),{mutate:function(g){var y=ne.trans;if(h.outbound||y.db._options.cache==="disabled"||y.explicit||y.idbtrans.mode!=="readwrite")return f.mutate(g);var w=an["idb://".concat(s,"/").concat(l)];return w?(y=f.mutate(g),g.type!=="add"&&g.type!=="put"||!(50<=g.values.length||rc(h,g).some(function(C){return C==null}))?(w.optimisticOps.push(g),g.mutatedParts&&sa(g.mutatedParts),y.then(function(C){0<C.numFailures&&(qe(w.optimisticOps,g),(C=Nl(0,g,C))&&w.optimisticOps.push(C),g.mutatedParts&&sa(g.mutatedParts))}),y.catch(function(){qe(w.optimisticOps,g),g.mutatedParts&&sa(g.mutatedParts)})):y.then(function(C){var D=Nl(0,n(n({},g),{values:g.values.map(function(O,S){var P;return C.failures[S]?O:(O=(P=h.keyPath)!==null&&P!==void 0&&P.includes(".")?we(O):n({},O),Z(O,h.keyPath,C.results[S]),O)})}),C);w.optimisticOps.push(D),queueMicrotask(function(){return g.mutatedParts&&sa(g.mutatedParts)})}),y):f.mutate(g)},query:function(g){if(!Ml(ne,f)||!Tl("query",g))return f.query(g);var y=((D=ne.trans)===null||D===void 0?void 0:D.db._options.cache)==="immutable",S=ne,w=S.requery,C=S.signal,D=function(R,L,x,$){var M=an["idb://".concat(R,"/").concat(L)];if(!M)return[];if(!(L=M.queries[x]))return[null,!1,M,null];var T=L[($.query?$.query.index.name:null)||""];if(!T)return[null,!1,M,null];switch(x){case"query":var N=T.find(function(B){return B.req.limit===$.limit&&B.req.values===$.values&&Bl(B.req.query.range,$.query.range)});return N?[N,!0,M,T]:[T.find(function(B){return("limit"in B.req?B.req.limit:1/0)>=$.limit&&(!$.values||B.req.values)&&Rm(B.req.query.range,$.query.range)}),!1,M,T];case"count":return N=T.find(function(B){return Bl(B.req.query.range,$.query.range)}),[N,!!N,M,T]}}(s,l,"query",g),O=D[0],S=D[1],P=D[2],E=D[3];return O&&S?O.obsSet=g.obsSet:(S=f.query(g).then(function(R){var L=R.result;if(O&&(O.res=L),y){for(var x=0,$=L.length;x<$;++x)Object.freeze(L[x]);Object.freeze(L)}else R.result=we(L);return R}).catch(function(R){return E&&O&&qe(E,O),Promise.reject(R)}),O={obsSet:g.obsSet,promise:S,subscribers:new Set,type:"query",req:g,dirty:!1},E?E.push(O):(E=[O],(P=P||(an["idb://".concat(s,"/").concat(l)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[g.query.index.name||""]=E)),Om(O,E,w,C),O.promise.then(function(R){return{result:ql(R.result,g,P==null?void 0:P.optimisticOps,f,O,y)}})}})}})}};function ua(a,s){return new Proxy(a,{get:function(l,f,h){return f==="db"?s:Reflect.get(l,f,h)}})}var or=(Fe.prototype.version=function(a){if(isNaN(a)||a<.1)throw new ie.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new ie.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var s=this._versions,l=s.filter(function(f){return f._cfg.version===a})[0];return l||(l=new this.Version(a),s.push(l),s.sort(wm),l.stores({}),this._state.autoSchema=!1,l)},Fe.prototype._whenReady=function(a){var s=this;return this.idbdb&&(this._state.openComplete||ne.letThrough||this._vip)?a():new Q(function(l,f){if(s._state.openComplete)return f(new ie.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void f(new ie.DatabaseClosed);s.open().catch(Se)}s._state.dbReadyPromise.then(l,f)}).then(a)},Fe.prototype.use=function(a){var s=a.stack,l=a.create,f=a.level,h=a.name;return h&&this.unuse({stack:s,name:h}),a=this._middlewares[s]||(this._middlewares[s]=[]),a.push({stack:s,create:l,level:f??10,name:h}),a.sort(function(g,y){return g.level-y.level}),this},Fe.prototype.unuse=function(a){var s=a.stack,l=a.name,f=a.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return f?h.create!==f:!!l&&h.name!==l})),this},Fe.prototype.open=function(){var a=this;return rn(Cr,function(){return Cm(a)})},Fe.prototype._close=function(){var a=this._state,s=qn.indexOf(this);if(0<=s&&qn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new Q(function(l){a.dbReadyResolve=l}),a.openCanceller=new Q(function(l,f){a.cancelOpen=f}))},Fe.prototype.close=function(l){var s=(l===void 0?{disableAutoOpen:!0}:l).disableAutoOpen,l=this._state;s?(l.isBeingOpened&&l.cancelOpen(new ie.DatabaseClosed),this._close(),l.autoOpen=!1,l.dbOpenError=new ie.DatabaseClosed):(this._close(),l.autoOpen=this._options.autoOpen||l.isBeingOpened,l.openComplete=!1,l.dbOpenError=null)},Fe.prototype.delete=function(a){var s=this;a===void 0&&(a={disableAutoOpen:!0});var l=0<arguments.length&&typeof arguments[0]!="object",f=this._state;return new Q(function(h,g){function y(){s.close(a);var w=s._deps.indexedDB.deleteDatabase(s.name);w.onsuccess=Me(function(){var C,D,O;C=s._deps,D=s.name,O=C.indexedDB,C=C.IDBKeyRange,Vs(O)||D===Qi||Ws(O,C).delete(D).catch(Se),h()}),w.onerror=Qt(g),w.onblocked=s._fireOnBlocked}if(l)throw new ie.InvalidArgument("Invalid closeOptions argument to db.delete()");f.isBeingOpened?f.dbReadyPromise.then(y):y()})},Fe.prototype.backendDB=function(){return this.idbdb},Fe.prototype.isOpen=function(){return this.idbdb!==null},Fe.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},Fe.prototype.hasFailed=function(){return this._state.dbOpenError!==null},Fe.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(Fe.prototype,"tables",{get:function(){var a=this;return c(this._allTables).map(function(s){return a._allTables[s]})},enumerable:!1,configurable:!0}),Fe.prototype.transaction=function(){var a=(function(s,l,f){var h=arguments.length;if(h<2)throw new ie.InvalidArgument("Too few arguments");for(var g=new Array(h-1);--h;)g[h-1]=arguments[h];return f=g.pop(),[s,Ee(g),f]}).apply(this,arguments);return this._transaction.apply(this,a)},Fe.prototype._transaction=function(a,s,l){var f=this,h=ne.trans;h&&h.db===this&&a.indexOf("!")===-1||(h=null);var g,y,w=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(y=s.map(function(D){if(D=D instanceof f.Table?D.name:D,typeof D!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return D}),a=="r"||a===As)g=As;else{if(a!="rw"&&a!=Ms)throw new ie.InvalidArgument("Invalid transaction mode: "+a);g=Ms}if(h){if(h.mode===As&&g===Ms){if(!w)throw new ie.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&y.forEach(function(D){if(h&&h.storeNames.indexOf(D)===-1){if(!w)throw new ie.SubTransaction("Table "+D+" not included in parent transaction.");h=null}}),w&&h&&!h.active&&(h=null)}}catch(D){return h?h._promise(null,function(O,S){S(D)}):Be(D)}var C=(function D(O,S,P,E,R){return Q.resolve().then(function(){var L=ne.transless||ne,x=O._createTransaction(S,P,O._dbSchema,E);if(x.explicit=!0,L={trans:x,transless:L},E)x.idbtrans=E.idbtrans;else try{x.create(),x.idbtrans._explicit=!0,O._state.PR1398_maxLoop=3}catch(T){return T.name===Cs.InvalidState&&O.isOpen()&&0<--O._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),O.close({disableAutoOpen:!1}),O.open().then(function(){return D(O,S,P,null,R)})):Be(T)}var $,M=Ae(R);return M&&Nn(),L=Q.follow(function(){var T;($=R.call(x,x))&&(M?(T=Dr.bind(null,null),$.then(T,T)):typeof $.next=="function"&&typeof $.throw=="function"&&($=ec($)))},L),($&&typeof $.then=="function"?Q.resolve($).then(function(T){return x.active?T:Be(new ie.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):L.then(function(){return $})).then(function(T){return E&&x._resolve(),x._completion.then(function(){return T})}).catch(function(T){return x._reject(T),Be(T)})})}).bind(null,this,g,y,h,l);return h?h._promise(g,C,"lock"):ne.trans?rn(ne.transless,function(){return f._whenReady(C)}):this._whenReady(C)},Fe.prototype.table=function(a){if(!v(this._allTables,a))throw new ie.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},Fe);function Fe(a,s){var l=this;this._middlewares={},this.verno=0;var f=Fe.dependencies;this._options=s=n({addons:Fe.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},f=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,g,y,w,C,D={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Se,dbReadyPromise:null,cancelOpen:Se,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};D.dbReadyPromise=new Q(function(S){D.dbReadyResolve=S}),D.openCanceller=new Q(function(S,P){D.cancelOpen=P}),this._state=D,this.name=a,this.on=Po(this,"populate","blocked","versionchange","close",{ready:[Es,Se]}),this.on.ready.subscribe=G(this.on.ready.subscribe,function(S){return function(P,E){Fe.vip(function(){var R,L=l._state;L.openComplete?(L.dbOpenError||Q.resolve().then(P),E&&S(P)):L.onReadyBeingFired?(L.onReadyBeingFired.push(P),E&&S(P)):(S(P),R=l,E||S(function x(){R.on.ready.unsubscribe(P),R.on.ready.unsubscribe(x)}))})}}),this.Collection=(h=this,$o(hm.prototype,function($,x){this.db=h;var E=gl,R=null;if(x)try{E=x()}catch(M){R=M}var L=$._ctx,x=L.table,$=x.hook.reading.fire;this._ctx={table:x,index:L.index,isPrimKey:!L.index||x.schema.primKey.keyPath&&L.index===x.schema.primKey.name,range:E,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:R,or:L.or,valueMapper:$!==xo?$:null}})),this.Table=(g=this,$o(wl.prototype,function(S,P,E){this.db=g,this._tx=E,this.name=S,this.schema=P,this.hook=g._allTables[S]?g._allTables[S].hook:Po(null,{creating:[om,Se],reading:[nm,xo],updating:[am,Se],deleting:[im,Se]})})),this.Transaction=(y=this,$o(gm.prototype,function(S,P,E,R,L){var x=this;this.db=y,this.mode=S,this.storeNames=P,this.schema=E,this.chromeTransactionDurability=R,this.idbtrans=null,this.on=Po(this,"complete","error","abort"),this.parent=L||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Q(function($,M){x._resolve=$,x._reject=M}),this._completion.then(function(){x.active=!1,x.on.complete.fire()},function($){var M=x.active;return x.active=!1,x.on.error.fire($),x.parent?x.parent._reject($):M&&x.idbtrans&&x.idbtrans.abort(),Be($)})})),this.Version=(w=this,$o(Im.prototype,function(S){this.db=w,this._cfg={version:S,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(C=this,$o(El.prototype,function(S,P,E){if(this.db=C,this._ctx={table:S,index:P===":id"?null:P,or:E},this._cmp=this._ascending=ye,this._descending=function(R,L){return ye(L,R)},this._max=function(R,L){return 0<ye(R,L)?R:L},this._min=function(R,L){return ye(R,L)<0?R:L},this._IDBKeyRange=C._deps.IDBKeyRange,!this._IDBKeyRange)throw new ie.MissingAPI})),this.on("versionchange",function(S){0<S.newVersion?console.warn("Another connection wants to upgrade database '".concat(l.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(l.name,"'. Closing db now to resume the delete request.")),l.close({disableAutoOpen:!1})}),this.on("blocked",function(S){!S.newVersion||S.newVersion<S.oldVersion?console.warn("Dexie.delete('".concat(l.name,"') was blocked")):console.warn("Upgrade '".concat(l.name,"' blocked by other connection holding version ").concat(S.oldVersion/10))}),this._maxKey=No(s.IDBKeyRange),this._createTransaction=function(S,P,E,R){return new l.Transaction(S,P,E,l._options.chromeTransactionDurability,R)},this._fireOnBlocked=function(S){l.on("blocked").fire(S),qn.filter(function(P){return P.name===l.name&&P!==l&&!P._state.vcFired}).map(function(P){return P.on("versionchange").fire(S)})},this.use(xm),this.use(Lm),this.use(km),this.use(Em),this.use(Dm);var O=new Proxy(this,{get:function(S,P,E){if(P==="_vip")return!0;if(P==="table")return function(L){return ua(l.table(L),O)};var R=Reflect.get(S,P,E);return R instanceof wl?ua(R,O):P==="tables"?R.map(function(L){return ua(L,O)}):P==="_createTransaction"?function(){return ua(R.apply(this,arguments),O)}:R}});this.vip=O,f.forEach(function(S){return S(l)})}var la,xt=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Pm=(oc.prototype.subscribe=function(a,s,l){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:s,complete:l})},oc.prototype[xt]=function(){return this},oc);function oc(a){this._subscribe=a}try{la={indexedDB:i.indexedDB||i.mozIndexedDB||i.webkitIndexedDB||i.msIndexedDB,IDBKeyRange:i.IDBKeyRange||i.webkitIDBKeyRange}}catch{la={indexedDB:null,IDBKeyRange:null}}function Fl(a){var s,l=!1,f=new Pm(function(h){var g=Ae(a),y,w=!1,C={},D={},O={get closed(){return w},unsubscribe:function(){w||(w=!0,y&&y.abort(),S&&Rr.storagemutated.unsubscribe(E))}};h.start&&h.start(O);var S=!1,P=function(){return $s(R)},E=function(L){aa(C,L),Ys(D,C)&&P()},R=function(){var L,x,$;!w&&la.indexedDB&&(C={},L={},y&&y.abort(),y=new AbortController,$=function(M){var T=Mn();try{g&&Nn();var N=Er(a,M);return N=g?N.finally(Dr):N}finally{T&&Tn()}}(x={subscr:L,signal:y.signal,requery:P,querier:a,trans:null}),Promise.resolve($).then(function(M){l=!0,s=M,w||x.signal.aborted||(C={},function(T){for(var N in T)if(v(T,N))return;return 1}(D=L)||S||(Rr(To,E),S=!0),$s(function(){return!w&&h.next&&h.next(M)}))},function(M){l=!1,["DatabaseClosedError","AbortError"].includes(M==null?void 0:M.name)||w||$s(function(){w||h.error&&h.error(M)})}))};return setTimeout(P,0),O});return f.hasValue=function(){return l},f.getValue=function(){return s},f}var sn=or;function ic(a){var s=Or;try{Or=!0,Rr.storagemutated.fire(a),Zs(a,!0)}finally{Or=s}}b(sn,n(n({},Bi),{delete:function(a){return new sn(a,{addons:[]}).delete()},exists:function(a){return new sn(a,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return s=sn.dependencies,l=s.indexedDB,s=s.IDBKeyRange,(Vs(l)?Promise.resolve(l.databases()).then(function(f){return f.map(function(h){return h.name}).filter(function(h){return h!==Qi})}):Ws(l,s).toCollection().primaryKeys()).then(a)}catch{return Be(new ie.MissingAPI)}var s,l},defineClass:function(){return function(a){d(this,a)}},ignoreTransaction:function(a){return ne.trans?rn(ne.transless,a):a()},vip:Qs,async:function(a){return function(){try{var s=ec(a.apply(this,arguments));return s&&typeof s.then=="function"?s:Q.resolve(s)}catch(l){return Be(l)}}},spawn:function(a,s,l){try{var f=ec(a.apply(l,s||[]));return f&&typeof f.then=="function"?f:Q.resolve(f)}catch(h){return Be(h)}},currentTransaction:{get:function(){return ne.trans||null}},waitFor:function(a,s){return s=Q.resolve(typeof a=="function"?sn.ignoreTransaction(a):a).timeout(s||6e4),ne.trans?ne.trans.waitFor(s):s},Promise:Q,debug:{get:function(){return Vt},set:function(a){ul(a)}},derive:k,extend:d,props:b,override:G,Events:Po,on:Rr,liveQuery:Fl,extendObservabilitySet:aa,getByKeyPath:te,setByKeyPath:Z,delByKeyPath:function(a,s){typeof s=="string"?Z(a,s,void 0):"length"in s&&[].map.call(s,function(l){Z(a,l,void 0)})},shallowClone:ce,deepClone:we,getObjectDiff:tc,cmp:ye,asap:oe,minKey:-1/0,addons:[],connections:qn,errnames:Cs,dependencies:la,cache:an,semVer:"4.0.10",version:"4.0.10".split(".").map(function(a){return parseInt(a)}).reduce(function(a,s,l){return a+s/Math.pow(10,2*l)})})),sn.maxKey=No(sn.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Rr(To,function(a){Or||(a=new CustomEvent(Bs,{detail:a}),Or=!0,dispatchEvent(a),Or=!1)}),addEventListener(Bs,function(a){a=a.detail,Or||ic(a)}));var Un,Or=!1,Ul=function(){};return typeof BroadcastChannel<"u"&&((Ul=function(){(Un=new BroadcastChannel(Bs)).onmessage=function(a){return a.data&&ic(a.data)}})(),typeof Un.unref=="function"&&Un.unref(),Rr(To,function(a){Or||Un.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!or.disableBfCache&&a.persisted){Vt&&console.debug("Dexie: handling persisted pagehide"),Un!=null&&Un.close();for(var s=0,l=qn;s<l.length;s++)l[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!or.disableBfCache&&a.persisted&&(Vt&&console.debug("Dexie: handling persisted pageshow"),Ul(),ic({all:new nt(-1/0,[[]])}))})),Q.rejectionMapper=function(a,s){return!a||a instanceof ve||a instanceof TypeError||a instanceof SyntaxError||!a.name||!cl[a.name]?a:(s=new cl[a.name](s||a.message,a),"stack"in a&&I(s,"stack",{get:function(){return this.inner.stack}}),s)},ul(Vt),n(or,Object.freeze({__proto__:null,Dexie:or,liveQuery:Fl,Entity:vl,cmp:ye,PropModSymbol:nr,PropModification:Ao,replacePrefix:function(a,s){return new Ao({replacePrefix:[a,s]})},add:function(a){return new Ao({add:a})},remove:function(a){return new Ao({remove:a})},default:or,RangeSet:nt,mergeRanges:Fo,rangesOverlap:Ol}),{default:or}),or})}(Oa)),Oa.exports}var x_=D_();const vu=Tm(x_),Hd=Symbol.for("Dexie"),Ja=globalThis[Hd]||(globalThis[Hd]=vu);if(vu.semVer!==Ja.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${vu.semVer} and ${Ja.semVer}`);const{liveQuery:HI,mergeRanges:zI,rangesOverlap:WI,RangeSet:VI,cmp:QI,Entity:GI,PropModSymbol:YI,PropModification:JI,replacePrefix:XI,add:ZI,remove:eC}=Ja;var Xa="docs",k_="changes",zd="attachments",$p="dexie",Wd=new Map,La=new Map;function R_(e,t,r,n){var o="rxdb-dexie-"+e+"--"+n.version+"--"+t,i=Kt(Wd,o,()=>{var c=(async()=>{var u=Ne(r);u.autoOpen=!1;var d=new Ja(o,u);r.onCreate&&await r.onCreate(d,o);var p={[Xa]:P_(n),[k_]:"++sequence, id",[zd]:"id"};return d.version(1).stores(p),await d.open(),{dexieDb:d,dexieTable:d[Xa],dexieAttachmentsTable:d[zd],booleanIndexes:$_(n)}})();return Wd.set(o,i),La.set(i,0),c});return i}async function O_(e){var t=await e,r=La.get(e),n=r-1;n===0?(t.dexieDb.close(),La.delete(e)):La.set(e,n)}var yu="__";function Eo(e){var t=e.split(".");if(t.length>1)return t.map(n=>Eo(n)).join(".");if(e.startsWith("|")){var r=e.substring(1);return yu+r}else return e}function Ap(e){var t=e.split(".");if(t.length>1)return t.map(n=>Ap(n)).join(".");if(e.startsWith(yu)){var r=e.substring(yu.length);return"|"+r}else return e}function L_(e,t){if(!t)return t;var r=Ne(t);return r=bu(r),e.forEach(n=>{var o=Qr(t,n),i=o?"1":"0",c=Eo(n);Af(r,c,i)}),r}function Mp(e,t){return t&&(t=Ne(t),t=wu(t),e.forEach(r=>{var n=Qr(t,r),o=n==="1";Af(t,r,o)}),t)}function bu(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>bu(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{typeof n=="object"&&(n=bu(n)),t[Eo(r)]=n}),t}}function wu(e){if(!e||typeof e=="string"||typeof e=="number"||typeof e=="boolean")return e;if(Array.isArray(e))return e.map(r=>wu(r));if(typeof e=="object"){var t={};return Object.entries(e).forEach(([r,n])=>{(typeof n=="object"||Array.isArray(e))&&(n=wu(n)),t[Ap(r)]=n}),t}}function P_(e){var t=[],r=It(e.primaryKey);t.push([r]),t.push(["_deleted",r]),e.indexes&&e.indexes.forEach(i=>{var c=Ru(i);t.push(c)}),t.push(["_meta.lwt",r]),t.push(["_meta.lwt"]),t=t.map(i=>i.map(c=>Eo(c)));var n=t.map(i=>i.length===1?i[0]:"["+i.join("+")+"]");n=n.filter((i,c,u)=>u.indexOf(i)===c);var o=n.join(", ");return o}async function Vd(e,t){var r=await e,n=await r.dexieTable.bulkGet(t);return n.map(o=>Mp(r.booleanIndexes,o))}function ga(e,t){return e+"||"+t}function $_(e){var t=new Set,r=[];return e.indexes?(e.indexes.forEach(n=>{var o=Ru(n);o.forEach(i=>{if(!t.has(i)){t.add(i);var c=ho(e,i);c.type==="boolean"&&r.push(i)}})}),r.push("_deleted"),$g(r)):r}function Qd(e){return e===eo?-1/0:e}function Gd(e,t,r){if(e.includes(t)){var n=r===Zn||r===!0?"1":"0";return n}else return r}function Tp(e,t,r){if(!r){if(typeof window>"u")throw new Error("IDBKeyRange missing");r=window.IDBKeyRange}var n=t.startKeys.map((c,u)=>{var d=t.index[u];return Gd(e,d,c)}).map(Qd),o=t.endKeys.map((c,u)=>{var d=t.index[u];return Gd(e,d,c)}).map(Qd),i=r.bound(n,o,!t.inclusiveStart,!t.inclusiveEnd);return i}async function Yd(e,t){var r=await e.internals,n=t.query,o=n.skip?n.skip:0,i=n.limit?n.limit:1/0,c=o+i,u=t.queryPlan,d=!1;u.selectorSatisfiedByIndex||(d=Ku(e.schema,t.query));var p=Tp(r.booleanIndexes,u,r.dexieDb._options.IDBKeyRange),m=u.index,v=[];if(await r.dexieDb.transaction("r",r.dexieTable,async _=>{var I=_.idbtrans,k=I.objectStore(Xa),A,q;q="["+m.map(G=>Eo(G)).join("+")+"]",A=k.index(q);var U=A.openCursor(p);await new Promise(G=>{U.onsuccess=function(ae){var oe=ae.target.result;if(oe){var te=Mp(r.booleanIndexes,oe.value);(!d||d(te))&&v.push(te),u.sortSatisfiedByIndex&&v.length===c?G():oe.continue()}else G()}})}),!u.sortSatisfiedByIndex){var b=Qh(e.schema,t.query);v=v.sort(b)}return v=v.slice(o,c),{documents:v}}async function A_(e,t){var r=await e.internals,n=t.queryPlan,o=n.index,i=Tp(r.booleanIndexes,n,r.dexieDb._options.IDBKeyRange),c=-1;return await r.dexieDb.transaction("r",r.dexieTable,async u=>{var d=u.idbtrans,p=d.objectStore(Xa),m,v;v="["+o.map(_=>Eo(_)).join("+")+"]",m=p.index(v);var b=m.count(i);c=await new Promise((_,I)=>{b.onsuccess=function(){_(b.result)},b.onerror=k=>I(k)})}),c}var M_=St(),Cc=!1,T_=function(){function e(r,n,o,i,c,u,d,p){this.changes$=new Pt,this.instanceId=M_++,this.storage=r,this.databaseName=n,this.collectionName=o,this.schema=i,this.internals=c,this.options=u,this.settings=d,this.devMode=p,this.primaryPath=It(this.schema.primaryKey)}var t=e.prototype;return t.bulkWrite=async function(n,o){un(this),!Cc&&!await Tf()&&console.warn(["-------------- RxDB Open Core RxStorage -------------------------------","You are using the free Dexie.js based RxStorage implementation from RxDB https://rxdb.info/rx-storage-dexie.html?console=dexie ","While this is a great option, we want to let you know that there are faster storage solutions available in our premium plugins.","For professional users and production environments, we highly recommend considering these premium options to enhance performance and reliability."," https://rxdb.info/premium/?console=dexie ","If you already purchased premium access you can disable this log by calling the setPremiumFlag() function from rxdb-premium/plugins/shared.","---------------------------------------------------------------------"].join(`
`)),Cc=!0,n.forEach(m=>{if(!m.document._rev||m.previous&&!m.previous._rev)throw ee("SNH",{args:{row:m}})});var i=await this.internals,c={error:[]};this.devMode&&(n=n.map(m=>{var v=Ti(m.document);return{previous:m.previous,document:v}}));var u=n.map(m=>m.document[this.primaryPath]),d;if(await i.dexieDb.transaction("rw",i.dexieTable,i.dexieAttachmentsTable,async()=>{var m=new Map,v=await Vd(this.internals,u);v.forEach(I=>{var k=I;return k&&m.set(k[this.primaryPath],k),k}),d=gb(this,this.primaryPath,m,n,o),c.error=d.errors;var b=[];d.bulkInsertDocs.forEach(I=>{b.push(I.document)}),d.bulkUpdateDocs.forEach(I=>{b.push(I.document)}),b=b.map(I=>L_(i.booleanIndexes,I)),b.length>0&&await i.dexieTable.bulkPut(b);var _=[];d.attachmentsAdd.forEach(I=>{_.push({id:ga(I.documentId,I.attachmentId),data:I.attachmentData.data})}),d.attachmentsUpdate.forEach(I=>{_.push({id:ga(I.documentId,I.attachmentId),data:I.attachmentData.data})}),await i.dexieAttachmentsTable.bulkPut(_),await i.dexieAttachmentsTable.bulkDelete(d.attachmentsRemove.map(I=>ga(I.documentId,I.attachmentId)))}),d=fe(d),d.eventBulk.events.length>0){var p=fe(d.newestRow).document;d.eventBulk.checkpoint={id:p[this.primaryPath],lwt:p._meta.lwt},this.changes$.next(d.eventBulk)}return c},t.findDocumentsById=async function(n,o){un(this);var i=await this.internals,c=[];return await i.dexieDb.transaction("r",i.dexieTable,async()=>{var u=await Vd(this.internals,n);u.forEach(d=>{d&&(!d._deleted||o)&&c.push(d)})}),c},t.query=function(n){return un(this),Yd(this,n)},t.count=async function(n){if(n.queryPlan.selectorSatisfiedByIndex){var o=await A_(this,n);return{count:o,mode:"fast"}}else{var i=await Yd(this,n);return{count:i.documents.length,mode:"slow"}}},t.changeStream=function(){return un(this),this.changes$.asObservable()},t.cleanup=async function(n){un(this);var o=await this.internals;return await o.dexieDb.transaction("rw",o.dexieTable,async()=>{var i=St()-n,c=await o.dexieTable.where("_meta.lwt").below(i).toArray(),u=[];c.forEach(d=>{d._deleted==="1"&&u.push(d[this.primaryPath])}),await o.dexieTable.bulkDelete(u)}),!0},t.getAttachmentData=async function(n,o,i){un(this);var c=await this.internals,u=ga(n,o);return await c.dexieDb.transaction("r",c.dexieAttachmentsTable,async()=>{var d=await c.dexieAttachmentsTable.get(u);if(d)return d.data;throw new Error("attachment missing documentId: "+n+" attachmentId: "+o)})},t.remove=async function(){un(this);var n=await this.internals;return await n.dexieTable.clear(),this.close()},t.close=function(){return this.closed?this.closed:(this.closed=(async()=>{this.changes$.complete(),await O_(this.internals)})(),this.closed)},e}();async function N_(e,t,r){var n=R_(t.databaseName,t.collectionName,r,t.schema),o=new T_(e,t.databaseName,t.collectionName,t.schema,n,t.options,r,t.devMode);return await C_($p,t,o),Promise.resolve(o)}function un(e){if(e.closed)throw new Error("RxStorageInstanceDexie is closed "+e.databaseName+"-"+e.collectionName)}var q_=function(){function e(r){this.name=$p,this.rxdbVersion=Mf,this.settings=r}var t=e.prototype;return t.createStorageInstance=function(n){if(bb(n),n.schema.indexes){var o=n.schema.indexes.flat();o.filter(i=>!i.includes(".")).forEach(i=>{if(!n.schema.required||!n.schema.required.includes(i))throw ee("DXE1",{field:i,schema:n.schema})})}return N_(this,n,this.settings)},e}();function Za(e={}){var t=new q_(e);return t}var B_=["__proto__","constructor","prototype"];function zo(e,t){Object.keys(t).forEach(r=>{B_.includes(r)||(typeof e[r]>"u"?e[r]=t[r]:Yo(t[r])?zo(e[r],t[r]):e[r]=t[r])})}function Yo(e){return e.toString()==="[object Object]"}var bs=function(){function e(r,n){if(this.options={},this._conditions={},this._fields={},this._path=n,r){var o=this;r.selector&&o.find(r.selector),r.limit&&o.limit(r.limit),r.skip&&o.skip(r.skip),r.sort&&r.sort.forEach(i=>o.sort(i))}}var t=e.prototype;return t.where=function(n,o){if(!arguments.length)return this;var i=typeof arguments[0];if(i==="string")return this._path=arguments[0],arguments.length===2&&(this._conditions[this._path]=arguments[1]),this;if(i==="object"&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw Rt("MQ1",{path:arguments[0]})},t.equals=function(n){this._ensurePath("equals");var o=this._path;return this._conditions[o]=n,this},t.eq=function(n){this._ensurePath("eq");var o=this._path;return this._conditions[o]=n,this},t.or=function(n){var o=this._conditions.$or||(this._conditions.$or=[]);return Array.isArray(n)||(n=[n]),o.push.apply(o,n),this},t.nor=function(n){var o=this._conditions.$nor||(this._conditions.$nor=[]);return Array.isArray(n)||(n=[n]),o.push.apply(o,n),this},t.and=function(n){var o=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(n)||(n=[n]),o.push.apply(o,n),this},t.mod=function(n,o){var i,c;arguments.length===1?(this._ensurePath("mod"),i=arguments[0],c=this._path):arguments.length===2&&!Array.isArray(arguments[1])?(this._ensurePath("mod"),i=arguments.slice(),c=this._path):arguments.length===3?(i=arguments.slice(1),c=arguments[0]):(i=arguments[1],c=arguments[0]);var u=this._conditions[c]||(this._conditions[c]={});return u.$mod=i,this},t.exists=function(n,o){var i,c;arguments.length===0?(this._ensurePath("exists"),i=this._path,c=!0):arguments.length===1?typeof arguments[0]=="boolean"?(this._ensurePath("exists"),i=this._path,c=arguments[0]):(i=arguments[0],c=!0):arguments.length===2&&(i=arguments[0],c=arguments[1]);var u=this._conditions[i]||(this._conditions[i]={});return u.$exists=c,this},t.elemMatch=function(n,o){if(arguments[0]===null)throw Rt("MQ2");var i,c,u;if(typeof arguments[0]=="function")this._ensurePath("elemMatch"),c=this._path,i=arguments[0];else if(Yo(arguments[0]))this._ensurePath("elemMatch"),c=this._path,u=arguments[0];else if(typeof arguments[1]=="function")c=arguments[0],i=arguments[1];else if(arguments[1]&&Yo(arguments[1]))c=arguments[0],u=arguments[1];else throw Rt("MQ2");i&&(u=new e,i(u),u=u._conditions);var d=this._conditions[c]||(this._conditions[c]={});return d.$elemMatch=u,this},t.sort=function(n){if(!n)return this;var o,i=typeof n;if(Array.isArray(n)){o=n.length;for(var c=0;c<n.length;++c)U_(this.options,n[c][0],n[c][1]);return this}if(arguments.length===1&&i==="string"){n=n.split(/\s+/),o=n.length;for(var u=0;u<o;++u){var d=n[u];if(d){var p=d[0]==="-"?-1:1;p===-1&&(d=d.substring(1)),Jd(this.options,d,p)}}return this}if(Yo(n)){var m=Object.keys(n);return m.forEach(v=>Jd(this.options,v,n[v])),this}throw Rt("MQ3",{args:arguments})},t.merge=function(n){if(!n)return this;if(!Xd(n))throw Rt("MQ4",{source:n});return n instanceof e?(n._conditions&&zo(this._conditions,n._conditions),n._fields&&(this._fields||(this._fields={}),zo(this._fields,n._fields)),n.options&&(this.options||(this.options={}),zo(this.options,n.options)),n._distinct&&(this._distinct=n._distinct),this):(zo(this._conditions,n),this)},t.find=function(n){return Xd(n)&&this.merge(n),this},t._ensurePath=function(n){if(!this._path)throw ee("MQ5",{method:n})},t.toJSON=function(){var n={selector:this._conditions};return this.options.skip&&(n.skip=this.options.skip),this.options.limit&&(n.limit=this.options.limit),this.options.sort&&(n.sort=F_(this.options.sort)),{query:n,path:this._path}},e}();function F_(e){return Object.entries(e).map(([t,r])=>{var n=r===1?"asc":"desc",o={[t]:n};return o})}var Np=["limit","skip","maxScan","batchSize","comment"];Np.forEach(function(e){bs.prototype[e]=function(t){return this.options[e]=t,this}});var qp=["gt","gte","lt","lte","ne","in","nin","all","regex","size"];qp.forEach(function(e){bs.prototype[e]=function(){var t,r;arguments.length===1?(this._ensurePath(e),r=arguments[0],t=this._path):(r=arguments[1],t=arguments[0]);var n=this._conditions[t]===null||typeof this._conditions[t]=="object"?this._conditions[t]:this._conditions[t]={};if(e==="regex"){if(r instanceof RegExp)throw ee("QU16",{field:t,query:this._conditions});typeof r=="string"?n["$"+e]=r:(n["$"+e]=r.$regex,r.$options&&(n.$options=r.$options))}else n["$"+e]=r;return this}});function Jd(e,t,r){if(Array.isArray(e.sort))throw Rt("MQ6",{opts:e,field:t,value:r});if(r&&r.$meta){var n=e.sort||(e.sort={});n[t]={$meta:r.$meta};return}var o=String(r||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(o))throw Array.isArray(r)&&(r="["+r+"]"),Rt("MQ7",{field:t,value:r});var i=e.sort||(e.sort={}),c=r.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");i[t]=parseInt(c,10)}function U_(e,t,r){if(e.sort=e.sort||[],!Array.isArray(e.sort))throw Rt("MQ8",{opts:e,field:t,value:r});e.sort.push([t,r])}function Xd(e){return e instanceof bs||Yo(e)}function j_(e,t){return new bs(e,t)}var Zd="queryBuilderPath";function K_(e,t,r){var n=j_(lt(e.mangoQuery),e.other[Zd]);n[t](r);var o=n.toJSON();return zn(e.op,o.query,e.collection,{...e.other,[Zd]:o.path})}function Ec(e,t){e[t]=function(r){if(Ie.isDevMode()&&this.op==="findByIds")throw ee("QU17",{collection:this.collection.name,query:this.mangoQuery});return K_(this,t,r)}}var H_={name:"query-builder",rxdb:!0,prototypes:{RxQuery(e){["where","equals","eq","or","nor","and","mod","exists","elemMatch","sort"].forEach(t=>{Ec(e,t)}),Np.forEach(t=>{Ec(e,t)}),qp.forEach(t=>{Ec(e,t)})}}};async function Bp(e){var t=uv(e.collection.schema.jsonSchema).map(n=>e.collection.name+"-"+n),r=await e.database.internalStore.findDocumentsById(t.map(n=>bo(n,In)),!1);if(r.length>1)throw new Error("more than one old collection meta found");return r[0]}function z_(e,t,r){var n=Ne(r._attachments),o=lt(r),i=o._meta;delete o._meta,o._attachments=n;for(var c=t+1,u=Promise.resolve(o),d=function(){var p=c;u=u.then(m=>W_(e,p,m)),c++};c<=e.schema.version;)d();return u.then(p=>p===null?Lu:(p._meta=i,p))}function W_(e,t,r){if(r===null)return Lu;var n=e.migrationStrategies[t](r,e),o=Ug(n);return o}async function Fp(e){if(e.collection.schema.version===0)return yr;var t=await Bp(e);return!!t}var V_=200,Up=new WeakMap;function Q_(e){var t=jp(e.database),r=t.getValue().slice(0);r.push(e),t.next(r)}function jp(e){return Kt(Up,e,()=>new Lr([]))}function G_(e){var t=Up.get(e);t&&t.complete()}var Y_=function(){function e(r,n,o=[r.name,"v",r.schema.version].join("-")){this.started=!1,this.updateStatusHandlers=[],this.updateStatusQueue=jg,this.collection=r,this.migrationStrategies=n,this.statusDocKey=o,this.database=r.database,this.oldCollectionMeta=Bp(this),this.mustMigrate=Fp(this),this.statusDocId=bo(this.statusDocKey,xa),Q_(this),this.$=mb(this.database.internalStore,this.statusDocId).pipe(ke(i=>!!i),He(i=>fe(i).data),Li(Di))}var t=e.prototype;return t.getStatus=function(){return Sn(this.$)},t.startMigration=async function(n=V_){var o=await this.mustMigrate;if(o){if(this.started)throw ee("DM1");this.started=!0;var i=void 0;if(this.database.multiInstance){i=new ys(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var c=S_(i);await c.awaitLeadership()}var u=await this.oldCollectionMeta,d=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:u.data.schema,password:this.database.password,devMode:Ie.isDevMode()}),p=await this.getConnectedStorageInstances(),m=await this.countAllDoucments([d].concat(p.map(v=>v.oldStorage)));await this.updateStatus(v=>(v.count.total=m,v));try{await Promise.all(p.map(async v=>{await qw(this.collection,v.newStorage.collectionName,v.newStorage.schema),await this.migrateStorage(v.oldStorage,v.newStorage,n),await v.newStorage.close()})),await this.migrateStorage(d,this.collection.storageInstance.originalStorageInstance,n)}catch(v){await d.close(),await this.updateStatus(b=>(b.status="ERROR",b.error=Qg(v),b));return}await yi(this.database.internalStore,{previous:u,document:Object.assign({},u,{_deleted:!0})},"rx-migration-remove-collection-meta"),await this.updateStatus(v=>(v.status="DONE",v)),i&&await i.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var o=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var i=await Mi(this.database.internalStore,this.statusDocId),c=lt(i);i||(c={id:this.statusDocId,key:this.statusDocKey,context:xa,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:So(),_rev:jt(),_attachments:{}});var u=fe(c).data;for(var d of o)u=d(u);if(u.count.percent=Math.round(u.count.handled/u.count.total*100),c&&i&&si(c.data,i.data))break;try{await yi(this.database.internalStore,{previous:i,document:fe(c)},xa);break}catch(p){if(!ls(p))throw p}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,o,i){var c=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:Td(n.schema,uu(n.schema)),password:this.database.password,devMode:Ie.isDevMode()}),u=d0(o,Wa,this.database.token,!0),d=c0({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async m=>{m=await Promise.all(m.map(async b=>{var _=b.newDocumentState;if(o.schema.title===Ra&&(_=b.newDocumentState.docData,b.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:b.newDocumentState};var I=await z_(this.collection,n.schema.version,_),k={assumedMasterState:void 0,newDocumentState:o.schema.title===Ra?Object.assign({},b.newDocumentState,{docData:I}):I};return k})),m=m.filter(b=>!!b.newDocumentState);var v=await u.masterWrite(m);return v},masterChangeStream$:new Pt().asObservable()},forkInstance:n,metaInstance:c,pushBatchSize:i,pullBatchSize:0,conflictHandler:Wa,hashFunction:this.database.hashFunction}),p=!1;if(d.events.error.subscribe(m=>p=m),d.events.processed.up.subscribe(()=>{this.updateStatus(m=>(m.count.handled=m.count.handled+1,m))}),await u0(d),await l0(d),await f0(d),await this.updateStatusQueue,p)throw await c.close(),p;await Promise.all([n.remove(),c.remove()])},t.countAllDoucments=async function(n){var o=0;return await Promise.all(n.map(async i=>{var c=ms(i.schema,ro(i.schema,{selector:{}})),u=await i.count(c);o+=u.count})),o},t.getConnectedStorageInstances=async function(){var n=await this.oldCollectionMeta,o=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async i=>{if(i.schema.title!==Ra)throw new Error("unknown migration handling for schema");var c=Td(lt(this.collection.schema.jsonSchema),uu(i.schema));c.version=this.collection.schema.version;var[u,d]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Ie.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:i.schema,password:this.database.password,collectionName:i.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:Ie.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:c,password:this.database.password,collectionName:i.collectionName})]);o.push({oldStorage:u,newStorage:d})}))),o},t.migratePromise=async function(n){this.startMigration(n);var o=await this.mustMigrate;if(!o)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var i=await Promise.race([Sn(this.$.pipe(ke(c=>c.status==="DONE"))),Sn(this.$.pipe(ke(c=>c.status==="ERROR")))]);if(i.status==="ERROR")throw ee("DM4",{collection:this.collection.name,error:i.error});return i},e}(),J_=Xh(),X_=function(e){function t(r,n,o){var i;return i=e.call(this,null,n)||this,i.id=r,i.parent=o,i}return Pu(t,e),t}(J_),Jo={get isLocal(){return!0},get allAttachments$(){throw ee("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=fo(_u,this.parent),r=this.primary;return e.parent.eventBulks$.pipe(ke(n=>!!n.isLocal),He(n=>n.events.find(o=>o.documentId===r)),ke(n=>!!n),He(n=>ch(fe(n))),Pi(t.docCache.getLatestDocumentData(this.primary)),li((n,o)=>n._rev===o._rev),He(n=>t.docCache.getCachedRxDocument(n)),Li(Di))},get $$(){var e=this,t=Dc(e),r=t.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=Dc(e),r=t.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=fo(_u,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw Rt("LD2",{objPath:e});var t=Qr(this._data,e);return t=Ie.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,Ie.isDevMode()){if(e.includes(".item."))throw ee("LD3",{objPath:e});if(e===this.primaryPath)throw ee("LD4")}return this.$.pipe(He(t=>t._data),He(t=>Qr(t,e)),li())},get$$(e){var t=Dc(this),r=t.getReactivityFactory();return r.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await Xo(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async r=>(r.data=await e(r.data,this),r)).then(r=>t.docCache.getCachedRxDocument(r))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([r,n])=>{t[r]=n}),t))},async _saveData(e){var t=await Xo(this.parent),r=this._data;e.id=this.id;var n=[{previous:r,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(o=>{if(o.error[0])throw o.error[0];var i=Nt(this.collection.schema.primaryPath,n,o)[0];e=Ne(e),e._rev=i._rev})},async remove(){var e=await Xo(this.parent),t=Ne(this._data);return t._deleted=!0,yi(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(r=>e.docCache.getCachedRxDocument(r))}},ef=!1,Z_=()=>{if(!ef){ef=!0;var e=gs,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var o=Object.getOwnPropertyDescriptor(Jo,n);if(!o){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(Jo,n,i)}});var r=n=>()=>{throw ee("LD6",{functionName:n})};["populate","update","putAttachment","getAttachment","allAttachments"].forEach(n=>Jo[n]=r(n))}};function eS(e,t){Z_();var r=new X_(e.id,e,t);return Object.setPrototypeOf(r,Jo),r.prototype=Jo,r}function Dc(e){var t=e.parent;return t0(t)?t:t.database}var es=new WeakMap,_u=new WeakMap;function tf(e){var t=e.database?e.database:e,r=e.database?e.name:"",n=(async()=>{var o=await Kp(t.token,t.storage,t.name,r,t.instanceCreationOptions,t.multiInstance);o=Hu(t,o,Hp);var i=new ip("id",t.eventBulks$.pipe(ke(m=>{var v=!1;return(r===""&&!m.collectionName||r!==""&&m.collectionName===r)&&(v=!0),v&&m.isLocal}),He(m=>m.events)),m=>eS(m,e)),c=new Jh(o,"id",()=>{},()=>{}),u=await t.storageToken,d=o.changeStream().subscribe(m=>{for(var v=new Array(m.events.length),b=m.events,_=e.database?e.name:void 0,I=0;I<b.length;I++){var k=b[I];v[I]={documentId:k.documentId,collectionName:_,isLocal:!0,operation:k.operation,documentData:Ie.deepFreezeWhenDevMode(k.documentData),previousDocumentData:Ie.deepFreezeWhenDevMode(k.previousDocumentData)}}var A={id:m.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:u,events:v,databaseToken:t.token,checkpoint:m.checkpoint,context:m.context};t.$emit(A)});e._subs.push(d);var p={database:t,parent:e,storageInstance:o,docCache:i,incrementalWriteQueue:c};return _u.set(e,p),p})();es.set(e,n)}function Xo(e){var t=es.get(e);if(!t){var r=e.database?e.database:e,n=e.database?e.name:"";throw ee("LD8",{database:r.name,collection:n})}return t}function Kp(e,t,r,n,o,i){return t.createStorageInstance({databaseInstanceToken:e,databaseName:r,collectionName:tS(n),schema:Hp,options:o,multiInstance:i,devMode:Ie.isDevMode()})}function rf(e){var t=es.get(e);if(t)return es.delete(e),t.then(r=>r.storageInstance.close())}async function nf(e,t,r){var n=Ei(10),o=await Kp(n,e,t,r,{},!1);await o.remove()}function tS(e){return"plugin-local-documents-"+e}var Hp=ds({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function of(e,t){var r=await Xo(this),n={id:e,data:t,_deleted:!1,_meta:So(),_rev:jt(),_attachments:{}};return yi(r.storageInstance,{document:n},"local-document-insert").then(o=>r.docCache.getCachedRxDocument(o))}function af(e,t){return this.getLocal(e).then(r=>{if(r)return r.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function sf(e){var t=await Xo(this),r=t.docCache,n=r.getLatestDocumentDataIfExists(e);return n?Promise.resolve(r.getCachedRxDocument(n)):Mi(t.storageInstance,e).then(o=>o?t.docCache.getCachedRxDocument(o):null)}function cf(e){return this.$.pipe(Pi(null),wr(async t=>{if(t)return{changeEvent:t};var r=await this.getLocal(e);return{doc:r}}),wr(async t=>{if(t.changeEvent){var r=t.changeEvent;if(!r.isLocal||r.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),ke(t=>t.use),He(t=>t.doc))}var rS={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=of,e.upsertLocal=af,e.getLocal=sf,e.getLocal$=cf},RxDatabase:e=>{e.insertLocal=of,e.upsertLocal=af,e.getLocal=sf,e.getLocal$=cf}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&tf(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&tf(e.collection)}},preCloseRxDatabase:{after:e=>rf(e)},postCloseRxCollection:{after:e=>rf(e)},postRemoveRxDatabase:{after:e=>nf(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>nf(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},nS=new WeakMap,oS={name:"migration-schema",rxdb:!0,init(){ka(rS)},hooks:{preCloseRxDatabase:{after:G_}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return jp(this).pipe(Li(Di))}},RxCollection:e=>{e.getMigrationState=function(){return Kt(nS,this,()=>new Y_(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?yr:Fp(this.getMigrationState())}}}},iS=oS;const ws=e=>dt((t,r,n)=>{let o=0;if(ge(r))for(const i of r)o=o|1<<i;else o=r;return e(t&o,o)}),aS=ws((e,t)=>e==0),sS=ws((e,t)=>e==t),cS=ws((e,t)=>e<t),uS=ws((e,t)=>e>0),lS=Object.freeze(Object.defineProperty({__proto__:null,$all:fb,$and:Lh,$bitsAllClear:aS,$bitsAllSet:sS,$bitsAnyClear:cS,$bitsAnySet:uS,$elemMatch:Hh,$eq:Ah,$exists:Wh,$expr:ub,$gt:Mh,$gte:Th,$in:Nh,$jsonSchema:lb,$lt:qh,$lte:Bh,$mod:jh,$ne:Fh,$nin:Uh,$nor:Ph,$not:$h,$or:ju,$regex:Kh,$size:zh,$type:Vh,$where:db},Symbol.toStringTag,{value:"Module"})),ft={cloneMode:"copy",queryOptions:yh({context:Ln.init().addQueryOps(lS).addExpressionOps(Xy).addExpressionOps(ab)})},nl=(e,t)=>{switch(e){case"deep":return yo(t);case"copy":return go(t)?new Date(t):ge(t)?[...t]:ze(t)?{...t}:hr(t)?new RegExp(t):t;default:return t}},dS=/^[a-z]+[a-zA-Z0-9]*$/;function zp(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),o=e.substring(t+3,r);Ce(o===""||dS.test(o),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const i=e.substring(r+2),[c,u]=i?zp(i):[];return[{selector:e,parent:n,child:o||"$",next:c},[o,...u||[]].filter(Boolean)]}const mt=(e,t,r,n,o)=>{const{parent:i,child:c,next:u}=t;if(!c){let p=!1;return pi(e,i,(v,b)=>p=!!n(v,b)||p,o),p}const d=Zt(e,i);return ge(d)?d.map((p,m)=>r[c]&&!r[c].test({[c]:p})?!1:u?mt(p,u,r,n,o):n(d,m)).some(Boolean):!1};function Et(e,t,r,n){const o=[];for(const[i,c]of Object.entries(e)){const[u,d]=zp(i);if(!d.length)n(c,u,{})&&o.push(u.parent);else{const p={};t.forEach(v=>{Object.keys(v).forEach(b=>{d.forEach(_=>{(b===_||b.startsWith(_+"."))&&(p[_]=p[_]||{},Object.assign(p[_],{[b]:v[b]}))})})});const m={};for(const[v,b]of Object.entries(p))m[v]=new Jr(b,r.queryOptions);n(c,u,m)&&o.push(u.parent)}}return o}const fS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>{const u={$each:[o]};return ze(o)&&zt(o,"$each")&&Object.assign(u,o),mt(e,i,c,(d,p)=>{const m=d[p]||(d[p]=[]);return ph([m,u.$each]).length===u.$each.length?!1:(d[p]=nl(n.cloneMode,_y(m.concat(u.$each))),!0)},{buildGraph:!0})}),hS=new Set(["and","or","xor"]),pS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>{const u=Object.keys(o);return Ce(u.length===1&&hS.has(u[0]),`Invalid bit operator '${u[0]}'. Must be one of 'and', 'or', or 'xor'.`),mt(e,i,c,(d,p)=>{let m=d[p];const v=o[u[0]];if(m!==void 0&&!(Je(m)&&Je(v)))return!1;switch(m=m||0,u[0]){case"and":d[p]=m&v;break;case"or":d[p]=m|v;break;case"xor":d[p]=m^v;break}return d[p]!==m},{buildGraph:!0})}),mS=(e,t,r=[],n=ft)=>{const o=Date.now();return Et(t,r,n,(i,c,u)=>mt(e,c,u,(d,p)=>(d[p]=o,!0),{buildGraph:!0}))},gS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>{if(!i.child){const u=Zt(e,i.parent);Ce(u===void 0||Je(u),"cannot apply $inc to a value of non-numeric type")}return mt(e,i,c,(u,d)=>(u[d]=(u[d]||(u[d]=0))+o,!0),{buildGraph:!0})}),vS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>mt(e,i,c,(u,d)=>u[d]!==void 0&&Tt(u[d],o)>-1?!1:(u[d]=o,!0),{buildGraph:!0})),yS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>mt(e,i,c,(u,d)=>u[d]!==void 0&&Tt(u[d],o)<1?!1:(u[d]=o,!0),{buildGraph:!0})),bS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>mt(e,i,c,(u,d)=>{const p=u[d];return u[d]=u[d]===void 0?0:u[d]*o,u[d]!==p},{buildGraph:!0})),wS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>mt(e,i,c,(u,d)=>{const p=u[d];return Ce(ge(p),`path '${i.selector}' contains an element of non-array type.`),p.length?(o===-1?p.splice(0,1):p.pop(),!0):!1})),Wp=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>{const u=!ze(o)||Object.keys(o).some(Yr),d=new Jr(u?{k:o}:o,n.queryOptions),p=u?m=>d.test({k:m}):m=>d.test(m);return mt(e,i,c,(m,v)=>{const b=m[v],_=new Array;return b.map(k=>{const A=p(k);return A||_.push(k),A}).some(Boolean)?(m[v]=_,!0):!1})}),_S=(e,t,r=[],n=ft)=>{const o={};return Object.entries(t).forEach(([i,c])=>{o[i]={$in:c}}),Wp(e,o,r,n)},SS=Object.freeze(["$each","$slice","$sort","$position"]),IS=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>{const u={$each:[o]};return ze(o)&&SS.some(d=>zt(o,d))&&Object.assign(u,o),mt(e,i,c,(d,p)=>{const m=d[p]||(d[p]=[]),v=m.slice(0,u.$slice||m.length),b=m.length,_=Je(u.$position)?u.$position:m.length;if(m.splice(_,0,...nl(n.cloneMode,u.$each)),u.$sort){const I=ze(u.$sort)?Object.keys(u.$sort||{}).pop():"",k=I?u.$sort[I]:u.$sort,A=I?q=>Zt(q,I):q=>q;m.sort((q,U)=>k*Tt(A(q),A(U)))}return Je(u.$slice)&&(u.$slice<0?m.splice(0,m.length+u.$slice):m.splice(u.$slice)),b!=m.length||!Ut(v,m)},{descendArray:!0,buildGraph:!0})}),Vp=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>mt(e,i,c,(u,d)=>Ut(u[d],o)?!1:(u[d]=nl(n.cloneMode,o),!0),{buildGraph:!0})),CS=(e,t,r=[],n=ft)=>{const o=[],i=Et(t,r,n,(c,u,d)=>mt(e,u,d,(p,m)=>zt(p,m)?(o.push(...Vp(e,{[c]:p[m]},r,n)),delete p[m],!0):!1));return Array.from(new Set(i.concat(o)))},ES=(e,t,r=[],n=ft)=>Et(t,r,n,(o,i,c)=>mt(e,i,c,(u,d)=>zt(u,d)?(ge(u)?u[d]=null:delete u[d],!0):!1)),uf=Object.freeze(Object.defineProperty({__proto__:null,$addToSet:fS,$bit:pS,$currentDate:mS,$inc:gS,$max:vS,$min:yS,$mul:bS,$pop:wS,$pull:Wp,$pullAll:_S,$push:IS,$rename:CS,$set:Vp,$unset:ES},Symbol.toStringTag,{value:"Module"}));function Qp(e){return e=e??ft,(t,r,n=[],o={},i=e)=>{const c=Object.entries(r);Ce(c.length===1,"Update expression must contain only one operator.");const[u,d]=c[0];Ce(zt(uf,u),`Update operator '${u}' is not supported.`);const p=uf[u];return Object.keys(o).length&&!new Jr(o,i.queryOptions).test(t)?[]:p(t,d,n,i)}}Qp();var xc;function Gp(e,t){if(!xc){var r=Qp({cloneMode:"none"});xc=(n,o)=>{var i=lt(n);return r(i,o),i}}return xc(e,t)}function DS(e){return this.incrementalModify(t=>{var r=Gp(t,e);return r})}function xS(e){var t=this._data,r=Gp(t,e);return this._saveData(r,t)}async function kS(e){return Hn(this.asRxQuery,t=>t.update(e))}var RS={name:"update",rxdb:!0,prototypes:{RxDocument:e=>{e.update=xS,e.incrementalUpdate=DS},RxQuery:e=>{e.update=kS}}};const jn={OFF:0,ERROR:1,INFO:2,DEBUG:3};class be{constructor(t,r="debug"){this.module=t,this.level=jn[r.toUpperCase()]}debug(t,r={}){this.level>=jn.DEBUG&&console.debug(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}info(t,r={}){this.level>=jn.INFO&&console.info(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}error(t,r={}){this.level>=jn.ERROR&&console.error(`[DB:${this.module}] ${t}`,{...r,timestamp:new Date().toISOString()})}setLevel(t){this.level=jn[t.toUpperCase()]||jn.OFF}}class Y extends Error{constructor(t,r,n={}){super(r),this.code=t,this.details=n}}async function re(e,t,r=`Operation timed out after ${t}ms`){const n=new Promise((o,i)=>setTimeout(()=>i(new Y("TIMEOUT",r)),t));return Promise.race([e,n])}const OS=new be("Main");let no=null,ts=null,oo=null,rs=null,dn=!1,fn=!1,ns;const LS=new Promise(e=>{ns=e});let $r=null,mn=null;const PS={title:"chat history schema",version:0,description:"Stores chat sessions",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100},tabId:{type:"number"},timestamp:{type:"number"},title:{type:"string",maxLength:100},messages:{type:"array",items:{type:"object",properties:{messageId:{type:"string",maxLength:100},sender:{type:"string"},text:{type:"string"},timestamp:{type:"number"},isLoading:{type:"boolean",default:!1}},required:["messageId","sender","text","timestamp"]}},isStarred:{type:"boolean",default:!1},status:{type:"string",default:"idle"}},required:["id","timestamp","messages"],indexes:[["timestamp"]]},$S={title:"log schema",version:0,description:"Stores application log entries",primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:100,final:!0},timestamp:{type:"number",index:!0},level:{type:"string",enum:["error","warn","info","debug"],index:!0},message:{type:"string"},component:{type:"string",index:!0},extensionSessionId:{type:"string",index:!0},chatSessionId:{type:["string","null"],index:!0,default:null}},required:["id","timestamp","level","component","extensionSessionId","message"]};async function ht(e="chat"){if(!await re(LS,5e3,"Database initialization timeout"))throw new Y("DB_NOT_READY","Main Database systems not initialized");if(e==="chat"){if(!ts)throw new Y("COLLECTION_NOT_READY","Chat history collection not initialized");return ts}else if(e==="log"){if(!rs)throw new Y("COLLECTION_NOT_READY","Logs collection not initialized");return rs}else throw new Y("INVALID_INPUT",`Unknown DB type requested: ${e}`)}async function AS(){const e=new be("Reset");e.info("Resetting databases due to initialization failure");try{no&&(await no.destroy(),e.debug("Main database instance destroyed")),oo&&(await oo.destroy(),e.debug("Log database instance destroyed")),no=null,ts=null,dn=!1,oo=null,rs=null,fn=!1;try{const t=Za("tabagentdb");t&&typeof t.remove=="function"?(await t.remove(),e.info("Removed tabagentdb storage")):e.warn("Could not get main storage or remove method.")}catch(t){e.warn("Could not remove tabagentdb storage (might not exist)",{error:t==null?void 0:t.message})}try{const t=Za("tabagent_logs_db");t&&typeof t.remove=="function"?(await t.remove(),e.info("Removed tabagent_logs_db storage")):e.warn("Could not get log storage or remove method.")}catch(t){e.warn("Could not remove tabagent_logs_db storage (might not exist)",{error:t==null?void 0:t.message})}ns(!1)}catch(t){throw console.error("[DB:Reset] CAUGHT RAW ERROR during reset:",t),e.error("Failed to reset databases",{error:t}),new Y("RESET_FAILED","Could not reset databases",{originalError:t})}}async function Yp(e){var r;const t=new be("Initialize");t.info("Handling initialize request");try{const n=await chrome.storage.local.get(["currentLogSessionId","previousLogSessionId"]);$r=n.currentLogSessionId||null,mn=n.previousLogSessionId||null,$r||t.error("CRITICAL: currentLogSessionId not found in storage during DB init!"),t.info("Retrieved log session IDs",{current:$r,previous:mn})}catch(n){t.error("Failed to retrieve log session IDs from storage",{error:n})}if(dn&&fn){t.info("Both databases already initialized, skipping");return}try{if(ka(H_),ka(iS),ka(RS),dn?t.info("Main database already initialized"):(no=await re($d({name:"tabagentdb",storage:Za()}),1e4),t.debug("Main database instance created",{name:no.name}),ts=(await no.addCollections({chatHistory:{schema:PS}})).chatHistory,t.debug("Chat history collection initialized"),dn=!0),fn?t.info("Log database already initialized"):(oo=await re($d({name:"tabagent_logs_db",storage:Za()}),1e4),t.debug("Log database instance created",{name:oo.name}),rs=(await oo.addCollections({logs:{schema:$S}})).logs,t.debug("Logs collection initialized"),fn=!0),dn&&fn){const n=typeof((r=j)==null?void 0:r.getSubscriptions)=="function"?j.getSubscriptions():{};if([ti.name,Wr.name,lo.name,Bt.name,Tc.name,Xe.name,ri.name,$a.name,Aa.name,ni.name,oi.name].some(d=>!n[d])){const d=[{event:ti.name,handler:zS},{event:Wr.name,handler:WS},{event:lo.name,handler:VS},{event:Bt.name,handler:QS},{event:Tc.name,handler:GS},{event:Xe.name,handler:YS},{event:ri.name,handler:JS},{event:$a.name,handler:XS},{event:Aa.name,handler:ZS},{event:ni.name,handler:eI},{event:oi.name,handler:tI}];d.forEach(({event:p,handler:m})=>j.subscribe(p,m)),t.debug("Chat event bus subscriptions complete",{count:d.length})}else t.debug("Chat event bus subscriptions already exist.");if([Hl.name,zl.name,Wl.name,Vl.name,Ql.name].some(d=>!n[d])){const d=[{event:Hl.name,handler:rI},{event:zl.name,handler:nI},{event:Wl.name,handler:oI},{event:Vl.name,handler:iI},{event:Ql.name,handler:aI}];d.forEach(({event:p,handler:m})=>j.subscribe(p,m)),t.info("Subscribed to Log Database events",{count:d.length})}else t.info("Log Database event subscriptions already exist.");ns(!0),t.info("Initialization complete for both databases"),await j.publish(Qn.name,new Qn({success:!0}))}else t.warn("Initialization partially complete, something went wrong.");dn&&fn&&setTimeout(async()=>{t.info("Running startup log pruning (delayed)..."),t.debug("Current/Previous IDs for pruning",{current:$r,previous:mn});try{const n=$r,o=mn;if(!n)t.warn("Cannot prune logs, currentExtensionSessionId is not set!");else{t.debug("Attempting to get all unique log session IDs...");const i=await Zp();t.debug("Found unique log session IDs in DB",{ids:i});const c=new Set;c.add(n),o&&c.add(o),t.debug("Session IDs to keep",{ids:Array.from(c)});const u=Array.from(i).filter(d=>!c.has(d));if(t.debug("Session IDs to delete",{ids:u}),u.length>0){t.info(`Attempting to clear logs for ${u.length} old session(s).`);const{deletedCount:d}=await em(u);t.info(`Startup pruning removed ${d} logs from old session(s).`)}else t.info("No old log sessions found to prune during startup.")}}catch(n){console.error("[DB:Initialize] Error during startup log pruning:",n)}},100)}catch(n){console.error("[DB:Initialize] Entered CATCH block for init error."),console.error("[DB:Initialize] Raw Error Name:",n==null?void 0:n.name),console.error("[DB:Initialize] Raw Error Message:",n==null?void 0:n.message),console.error("[DB:Initialize] CAUGHT RAW ERROR OBJECT during init:",n);const o=n instanceof Y?n:new Y("INIT_FAILED","Database initialization failed",{originalError:n});t.error("Initialization failed",{error:o,details:n});try{await AS(),t.info("Attempting reinitialization after reset"),await Yp(e);return}catch(i){t.error("Reinitialization after reset failed",{error:i})}dn=!1,fn=!1,ns(!1),await j.publish(Qn.name,new Qn({success:!1,error:o}))}}function Jp(e){if(!e||typeof e!="string")throw new Y("INVALID_INPUT","Chat ID must be a non-empty string");return`${e}-msg-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}function wi(e){return typeof e!="string"?e:e.replace(/[<>]/g,"")}async function MS(e){const t=new be("CreateSession");t.debug("Creating new chat session",{initialMessage:e});const r=await ht();if(!e||!e.text)throw new Y("INVALID_INPUT","Initial message with text is required");const n=Date.now(),o=crypto.randomUUID(),i={...e,text:wi(e.text),messageId:Jp(o),timestamp:e.timestamp||n,sender:e.sender||"user"},c={id:o,tabId:null,timestamp:n,title:wi(i.text.substring(0,30))+"...",messages:[i],isStarred:!1,status:"idle"};t.debug("Inserting session",{sessionId:o});const u=await re(r.insert(c),3e3);return t.info("Session created",{sessionId:o}),await An(o),u}async function Xp(e){const t=new be("GetSession");if(t.debug("Getting session",{sessionId:e}),!e)throw new Y("INVALID_INPUT","Session ID is required");const r=await ht(),n=await re(r.findOne(e).exec(),3e3);return n?(t.debug("Session retrieved",{sessionId:e}),n):(t.info("Session not found",{sessionId:e}),null)}async function TS(e,t){const r=new be("AddMessage");if(r.debug("Adding message",{chatId:e}),!e||!t||!t.text)throw new Y("INVALID_INPUT","Chat ID and message with text are required");const n=await ht(),o=await re(n.findOne(e).exec(),3e3);if(!o)throw new Y("NOT_FOUND",`Chat session ${e} not found`);const i={...t,text:wi(t.text),messageId:t.messageId||Jp(e),timestamp:t.timestamp||Date.now(),isLoading:t.isLoading??!1},c=await re(o.incrementalPatch({messages:[...o.messages,i]}),3e3);return r.info("Message added",{chatId:e,messageId:i.messageId}),{updatedDoc:c,newMessageId:i.messageId}}async function NS(e,t,r){const n=new be("UpdateMessage");if(n.debug("Updating message",{chatId:e,messageId:t}),!e||!t||!r||!r.text)throw new Y("INVALID_INPUT","Chat ID, message ID, and updates with text are required");const o=await ht(),i=await re(o.findOne(e).exec(),3e3);if(!i)throw new Y("NOT_FOUND",`Chat session ${e} not found`);let c=!1;const u=await re(i.incrementalModify(d=>{const p=d.messages.findIndex(v=>v.messageId===t);if(p===-1)return d;c=!0;const m=d.messages[p];return d.messages[p]={...m,...r,text:wi(r.text),messageId:m.messageId},d}),3e3);if(!c)throw new Y("NOT_FOUND",`Message ${t} not found in chat ${e}`);return n.info("Message updated",{chatId:e,messageId:t}),await An(e),u}async function qS(e,t){const r=new be("DeleteMessage");if(r.debug("Deleting message",{sessionId:e,messageId:t}),!e||!t)throw new Y("INVALID_INPUT","Session ID and message ID are required");const n=await ht(),o=await re(n.findOne(e).exec(),3e3);if(!o)throw new Y("NOT_FOUND",`Session ${e} not found`);const i=o.messages.length,c=o.messages.filter(d=>d.messageId!==t);if(c.length===i)return r.info("Message not found",{sessionId:e,messageId:t}),{updatedDoc:o,deleted:!1};const u=await re(o.incrementalPatch({messages:c}),3e3);return r.info("Message deleted",{sessionId:e,messageId:t}),await An(e),{updatedDoc:u,deleted:!0}}async function BS(e,t){const r=new be("UpdateStatus");if(r.debug("Updating status",{sessionId:e,newStatus:t}),!e||!["idle","processing","complete","error"].includes(t))throw new Y("INVALID_INPUT",`Invalid session ID or status: ${t}`);const o=await ht(),i=await re(o.findOne(e).exec(),3e3);if(!i)throw new Y("NOT_FOUND",`Session ${e} not found`);const c=await re(i.incrementalPatch({status:t}),3e3);return r.info("Status updated",{sessionId:e,newStatus:t}),await An(e),c}async function FS(e){const t=new be("ToggleStar");if(t.debug("Toggling starred status",{itemId:e}),!e)throw new Y("INVALID_INPUT","Item ID is required");const r=await ht(),n=await re(r.findOne(e).exec(),3e3);if(!n)throw new Y("NOT_FOUND",`Item ${e} not found`);const o=n.get("isStarred")||!1,i=await re(n.incrementalPatch({isStarred:!o}),3e3);return t.info("Starred status toggled",{itemId:e,isStarred:!o}),await An(e),i}async function US(e){const t=new be("DeleteHistory");if(t.debug("Deleting history item",{itemId:e}),!e)throw new Y("INVALID_INPUT","Item ID is required");const r=await ht(),n=await re(r.findOne(e).exec(),3e3);return n?(await re(n.remove(),3e3),t.info("Item deleted",{itemId:e}),await An(e),!0):(t.info("Item not found",{itemId:e}),!1)}async function jS(e,t){const r=new be("RenameHistory");if(r.debug("Renaming history item",{itemId:e,newTitle:t}),!e||!t)throw new Y("INVALID_INPUT","Item ID and new title are required");const n=await ht(),o=await re(n.findOne(e).exec(),3e3);if(!o)throw new Y("NOT_FOUND",`Item ${e} not found`);const i=await re(o.incrementalPatch({title:wi(t)}),3e3);return r.info("Item renamed",{itemId:e,newTitle:t}),await An(e),i}async function KS(){const e=new be("GetAllSessions");e.debug("Getting all sessions");const t=await ht(),n=(await re(t.find().sort({timestamp:"desc"}).exec(),5e3)).map(o=>o.toJSON());return e.info("Retrieved sessions",{count:n.length}),n}async function HS(){const e=new be("GetStarredSessions");e.debug("Getting starred sessions");const t=await ht(),r=await re(t.find({selector:{isStarred:!0}}).sort({timestamp:"desc"}).exec(),5e3);return e.info("Retrieved starred sessions",{count:r.length}),r}async function An(e,t="update"){const r=new be("SessionUpdate");r.debug(`Attempting to publish session update for ${e}, type: ${t}`);try{await ht();const n=await Xp(e);if(!n){r.error("Session not found after update, cannot publish notification",{sessionId:e});return}const o=n.toJSON?n.toJSON():n;r.info(`Publishing session update notification for ${e}`),await j.publish(ei.name,new ei(e,o,t)),r.debug("Session update published",{sessionId:e,updateType:t})}catch(n){r.error("Failed to publish session update",{sessionId:e,error:n})}}async function zS(e){var n;const t=new be("CreateSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling session creation",{requestId:r});try{if(!(e!=null&&e.requestId)||!((n=e==null?void 0:e.payload)!=null&&n.initialMessage)||!e.payload.initialMessage.text)throw new Y("INVALID_INPUT","Missing requestId, initialMessage, or message text");const o=await re(MS(e.payload.initialMessage),5e3);if(!(o!=null&&o.id))throw new Y("INVALID_DOCUMENT","Invalid session document returned");await re(Promise.all([j.publish(ct.name,new ct(o.id,o.messages)),j.publish(qr.name,new qr(o.id,o.status))]),3e3);const i=new Pc(r,!0,o.id);console.log(`[DB:${t.module}] PRE-PUBLISH Check (Success Path): ReqID ${r}, Response Success: ${i==null?void 0:i.success}, Response Type: ${i==null?void 0:i.type}`),await re(j.publish(i.type,i),3e3),t.info("Session created successfully",{requestId:r,sessionId:o.id})}catch(o){const i=o instanceof Y?o:new Y("UNKNOWN","Failed to create session",{originalError:o}),c=new Pc(r,!1,null,i);console.log(`[DB:${t.module}] PRE-PUBLISH Check (Error Path): ReqID ${r}, Response Success: ${c==null?void 0:c.success}, Response Type: ${c==null?void 0:c.type}`);try{await re(j.publish(c.type,c),3e3)}catch(u){t.error("FATAL: Failed even to publish error response!",{requestId:r,publishError:u})}t.error("Session creation failed",{requestId:r,error:i})}}async function WS(e){var n;const t=new be("GetSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new Y("INVALID_INPUT","Session ID is required");const o=await re(Xp(e.payload.sessionId),5e3),i=new Ac(r,!0,o?o.toJSON():null);await re(j.publish(i.type,i),3e3),t.info("Session retrieved",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const i=o instanceof Y?o:new Y("UNKNOWN","Failed to get session",{originalError:o}),c=new Ac(r,!1,null,i);await re(j.publish(c.type,c),3e3),t.error("Get session failed",{requestId:r,error:i})}}async function VS(e){var n,o;const t=new be("AddMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling add message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.messageObject)||!e.payload.messageObject.text)throw new Y("INVALID_INPUT","Session ID and message with text are required");const{updatedDoc:i,newMessageId:c}=await re(TS(e.payload.sessionId,e.payload.messageObject),5e3),u=i.messages.map(p=>p.toJSON?p.toJSON():p);await re(j.publish(ct.name,new ct(i.id,u)),3e3);const d=new $c(r,!0,c);await re(j.publish(d.type,d),3e3),t.info("Message added",{requestId:r,sessionId:e.payload.sessionId,messageId:c})}catch(i){const c=i instanceof Y?i:new Y("UNKNOWN","Failed to add message",{originalError:i}),u=new $c(r,!1,null,c);await re(j.publish(u.type,u),3e3),t.error("Add message failed",{requestId:r,error:c})}}async function QS(e){var n,o,i;const t=new be("UpdateMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling update message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.messageId)||!((i=e==null?void 0:e.payload)!=null&&i.updates)||!e.payload.updates.text)throw new Y("INVALID_INPUT","Session ID, message ID, and updates with text are required");const c=await re(NS(e.payload.sessionId,e.payload.messageId,e.payload.updates),5e3);await re(j.publish(ct.name,new ct(c.id,c.messages)),3e3);const u=new Mc(r,!0);await re(j.publish(u.type,u),3e3),t.info("Message updated",{requestId:r,sessionId:e.payload.sessionId,messageId:e.payload.messageId})}catch(c){const u=c instanceof Y?c:new Y("UNKNOWN","Failed to update message",{originalError:c}),d=new Mc(r,!1,u);await re(j.publish(d.type,d),3e3),t.error("Update message failed",{requestId:r,error:u})}}async function GS(e){var n,o;const t=new be("DeleteMessageHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling delete message",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.messageId))throw new Y("INVALID_INPUT","Session ID and message ID are required");const{updatedDoc:i,deleted:c}=await re(qS(e.payload.sessionId,e.payload.messageId),5e3);c&&await re(j.publish(ct.name,new ct(i.id,i.messages)),3e3);const u=new Nc(r,!0);await re(j.publish(u.type,u),3e3),t.info("Message deleted",{requestId:r,sessionId:e.payload.sessionId,messageId:e.payload.messageId})}catch(i){const c=i instanceof Y?i:new Y("UNKNOWN","Failed to delete message",{originalError:i}),u=new Nc(r,!1,c);await re(j.publish(u.type,u),3e3),t.error("Delete message failed",{requestId:r,error:c})}}async function YS(e){var n,o;const t=new be("UpdateStatusHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling update status",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.status))throw new Y("INVALID_INPUT","Session ID and status are required");const i=await re(BS(e.payload.sessionId,e.payload.status),5e3);await re(j.publish(qr.name,new qr(i.id,i.status)),3e3);const c=new qc(r,!0);await re(j.publish(c.type,c),3e3),t.info("Status updated",{requestId:r,sessionId:e.payload.sessionId,status:e.payload.status})}catch(i){const c=i instanceof Y?i:new Y("UNKNOWN","Failed to update status",{originalError:i}),u=new qc(r,!1,c);await re(j.publish(u.type,u),3e3),t.error("Update status failed",{requestId:r,error:c});try{await re(j.publish(qr.name,new qr(e.payload.sessionId,"error")),3e3)}catch(d){t.error("Failed to publish error status notification",{requestId:r,error:d})}}}async function JS(e){var n;const t=new be("ToggleStarHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling toggle star",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new Y("INVALID_INPUT","Session ID is required");const o=await re(FS(e.payload.sessionId),5e3),i=new Bc(r,!0,o.toJSON());await re(j.publish(i.type,i),3e3),t.info("Star toggled",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const i=o instanceof Y?o:new Y("UNKNOWN","Failed to toggle star",{originalError:o}),c=new Bc(r,!1,null,i);await re(j.publish(c.type,c),3e3),t.error("Toggle star failed",{requestId:r,error:i})}}async function XS(e){const t=new be("GetAllSessionsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get all sessions",{requestId:r});try{const o=(await re(KS(),5e3)).sort((c,u)=>u.timestamp-c.timestamp);t.debug("Using plain sessions directly",{count:o.length});const i=new Fc(r,!0,o);await re(j.publish(i.type,i),3e3),t.info("Sessions retrieved",{requestId:r,count:o.length})}catch(n){const o=n instanceof Y?n:new Y("UNKNOWN","Failed to get all sessions",{originalError:n}),i=new Fc(r,!1,null,o);await re(j.publish(i.type,i),3e3),t.error("Get all sessions failed",{requestId:r,error:o})}}async function ZS(e){const t=new be("GetStarredSessionsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling get starred sessions",{requestId:r});try{const o=(await re(HS(),5e3)).map(c=>({sessionId:c.id,name:c.title,lastUpdated:c.timestamp,isStarred:c.isStarred})).sort((c,u)=>u.lastUpdated-c.lastUpdated);t.debug("Retrieved starred sessions",{count:o.length});const i=new Uc(r,!0,o);await re(j.publish(i.type,i),3e3),t.info("Starred sessions retrieved",{requestId:r,count:o.length})}catch(n){const o=n instanceof Y?n:new Y("UNKNOWN","Failed to get starred sessions",{originalError:n}),i=new Uc(r,!1,null,o);await re(j.publish(i.type,i),3e3),t.error("Get starred sessions failed",{requestId:r,error:o})}}async function eI(e){var n;const t=new be("DeleteSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling delete session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId))throw new Y("INVALID_INPUT","Session ID is required");const o=await re(US(e.payload.sessionId),5e3),i=new jc(r,!0);await re(j.publish(i.type,i),3e3),t.info("Session deleted",{requestId:r,sessionId:e.payload.sessionId})}catch(o){const i=o instanceof Y?o:new Y("UNKNOWN","Failed to delete session",{originalError:o}),c=new jc(r,!1,i);await re(j.publish(c.type,c),3e3),t.error("Delete session failed",{requestId:r,error:i})}}async function tI(e){var n,o;const t=new be("RenameSessionHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();t.info("Handling rename session",{requestId:r});try{if(!((n=e==null?void 0:e.payload)!=null&&n.sessionId)||!((o=e==null?void 0:e.payload)!=null&&o.newName))throw new Y("INVALID_INPUT","Session ID and new name are required");const i=await re(jS(e.payload.sessionId,e.payload.newName),5e3),c=new Kc(r,!0);await re(j.publish(c.type,c),3e3),t.info("Session renamed",{requestId:r,sessionId:e.payload.sessionId})}catch(i){const c=i instanceof Y?i:new Y("UNKNOWN","Failed to rename session",{originalError:i}),u=new Kc(r,!1,c);await re(j.publish(u.type,u),3e3),t.error("Rename session failed",{requestId:r,error:c})}}async function rI(e){var r;const t=new be("AddLogHandler");try{if(!((r=e==null?void 0:e.payload)!=null&&r.logEntryData))throw new Y("INVALID_INPUT","Missing logEntryData in payload");const n=await ht("log");await re(n.insert(e.payload.logEntryData),3e3),t.debug("Log entry added successfully",{logId:e.payload.logEntryData.id})}catch(n){t.error("Failed to handle add log request",{requestId:e==null?void 0:e.requestId,error:n})}}async function nI(e){var n;const t=new be("GetLogsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();try{if(!((n=e==null?void 0:e.payload)!=null&&n.filters))throw new Y("INVALID_INPUT","Missing filters in payload");const o=await getLogsInternal(e.payload.filters),i=new Gl(r,!0,o);await j.publish(i.type,i),t.info("Log retrieval successful",{requestId:r,count:o.length})}catch(o){const i=o instanceof Y?o:new Y("UNKNOWN","Failed to get logs",{originalError:o}),c=new Gl(r,!1,null,i);await j.publish(c.type,c),t.error("Get logs failed",{requestId:r,error:i})}}async function oI(e){var n;const t=new be("GetUniqueLogValuesHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();try{if(!((n=e==null?void 0:e.payload)!=null&&n.fieldName))throw new Y("INVALID_INPUT","Missing fieldName in payload");const o=await getUniqueLogValuesInternal(e.payload.fieldName),i=new Yl(r,!0,o);await j.publish(i.type,i),t.info("Unique value retrieval successful",{requestId:r,field:e.payload.fieldName,count:o.length})}catch(o){const i=o instanceof Y?o:new Y("UNKNOWN","Failed to get unique log values",{originalError:o}),c=new Yl(r,!1,null,i);await j.publish(c.type,c),t.error("Get unique log values failed",{requestId:r,error:i})}}async function iI(e){const t=new be("ClearLogsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();try{t.info("ClearLogs request received. Performing pruning of non-current/last sessions.");const n=await Zp(),o=new Set;$r&&o.add($r),mn&&o.add(mn);const i=Array.from(n).filter(u=>!o.has(u));if(i.length>0){const{deletedCount:u}=await em(i);t.info(`ClearLogs request resulted in pruning ${u} logs from old sessions.`)}else t.info("ClearLogs request found no old sessions to prune.");const c=new Jl(r,!0);await j.publish(c.type,c)}catch(n){const o=n instanceof Y?n:new Y("UNKNOWN","Failed to clear logs",{originalError:n}),i=new Jl(r,!1,o);await j.publish(i.type,i),t.error("Clear logs failed",{requestId:r,error:o})}}async function aI(e){const t=new be("GetCurrentAndLastIdsHandler"),r=(e==null?void 0:e.requestId)||crypto.randomUUID();try{const n={currentLogSessionId:$r,previousLogSessionId:mn},o=new Xl(r,!0,n);await j.publish(o.type,o),t.info("Current/Last session ID retrieval successful",{requestId:r})}catch(n){const o=new Y("UNKNOWN","Failed to get current/last log session IDs",{originalError:n}),i=new Xl(r,!1,null,o);await j.publish(i.type,i),t.error("Get current/last log session IDs failed",{requestId:r,error:o})}}j.subscribe(Hc.name,Yp);OS.info("Subscribed to DbInitializeRequest");async function Zp(){const e=new be("GetUniqueLogSessionIds");e.debug("Starting retrieval of unique session IDs...");const t=await ht("log");e.debug("Log collection ensured ready.");try{e.debug("Executing find().select(extensionSessionId).exec()...");const r=await t.find().exec();e.debug(`Found ${r.length} log documents.`);const n=new Set(r.map(o=>o.get("extensionSessionId")));return e.debug("Unique session IDs calculated",{count:n.size}),n}catch(r){throw e.error("Error during find().select().exec() for unique session IDs",{error:r}),new Y("DB_QUERY_FAILED","Failed to retrieve unique log session IDs",{originalError:r})}}async function em(e){const t=new be("ClearLogs");t.info("ClearLogs request received. Performing pruning of non-current/last sessions.");const r=await ht("log");t.debug("Log collection ensured ready.");const n=await r.find().exec();t.debug(`Found ${n.length} log documents.`);const o=n.filter(c=>{const u=c.get("extensionSessionId");return u&&!e.includes(u)});t.debug(`Filtered results count: ${o.length}`);const i=o.length;return await re(r.bulkRemove(o),3e3),t.info(`ClearLogs request resulted in pruning ${i} logs from old sessions.`),{deletedCount:i}}let Do=!1,Ur=null,mr=null,Wt=null,Yt=[],En="",lf=!1;async function sI(e){if(console.log(`[LibraryController] Star clicked: ${e}`),!!Wt)try{await Wt(new ri(e)),$e("Star toggled","success")}catch(t){console.error("[LibraryController] Error toggling star:",t),$e(`Failed to toggle star: ${t.message}`,"error")}}async function cI(e){if(console.log(`[LibraryController] Delete clicked: ${e}`),!!Wt&&confirm("Are you sure you want to delete this chat history item? This cannot be undone."))try{await Wt(new ni(e)),$e("Chat deleted","success")}catch(t){console.error("[LibraryController] Error deleting chat:",t),$e(`Failed to delete chat: ${t.message}`,"error")}}async function uI(e,t){if(console.log(`[LibraryController] Rename submitted: ${e} to "${t}"`),!!Wt)try{await Wt(new oi(e,t)),$e("Rename successful","success")}catch(r){console.error("[LibraryController] Error submitting rename:",r),$e(`Failed to rename chat: ${r.message}`,"error")}}async function lI(e){Wt?Rf(e,Wt,$e):(console.error("[LibraryController] Cannot download: requestDbAndWaitFunc not available."),$e("Download failed: Internal setup error.","error"))}async function dI(e){console.log(`[LibraryController] Load clicked: ${e}`);try{await chrome.storage.local.set({lastSessionId:e}),Ma("page-home")}catch(t){console.error("[LibraryController] Error setting storage or navigating:",t),$e("Failed to load chat.","error"),await chrome.storage.local.remove("lastSessionId")}}function fI(e){console.log(`[LibraryController] Share clicked: ${e}`),$e("Share functionality not yet implemented.","info")}function hI(e,t){console.log(`[LibraryController] Preview clicked: ${e}`),$e("Preview functionality not yet implemented.","info"),t&&(t.innerHTML="Preview loading...",t.classList.toggle("hidden"))}function pI(e){!Do||(e==null?void 0:e.pageId)!=="page-library"||(console.log("[LibraryController] Library page activated."),lf||(mr=document.getElementById("library-search"),mr?(mr.addEventListener("input",vI),lf=!0,console.log("[LibraryController] Search input listener attached.")):console.warn("[LibraryController] Library search input (#library-search) still not found even when page is active.")),mI())}async function mI(){if(!Do||!Ur||!Wt){console.error("[LibraryController] Cannot fetch/render - not initialized or missing elements/functions.");return}console.log("[LibraryController] Fetching starred items..."),Ur.innerHTML='<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">Loading starred items...</p>',En=(mr==null?void 0:mr.value.trim())||"";try{const e=await Wt(new Aa);Yt=Array.isArray(e)?e:(e==null?void 0:e.sessions)||[],console.log(`[LibraryController] Received ${Yt.length} starred items.`),ol(En)}catch(e){console.error("[LibraryController] Error fetching starred items:",e),Ur.innerHTML='<div class="p-4 text-red-500">Error loading starred items.</div>'}}function gI(e){if(!Do||!e||!e.sessionId||!e.payload){console.warn("[LibraryController] Invalid session update notification received.",e);return}const t=e.payload.session,r=e.sessionId;if(!t){console.warn(`[LibraryController] Session update notification for ${r} missing session data in payload.session.`,e);return}console.log(`[LibraryController] Received session update for ${r}. New starred status: ${t.isStarred}`);const n=Yt.findIndex(i=>i.sessionId===r);if(t.isStarred)if(n===-1){console.log(`[LibraryController] Session ${r} is newly starred. Adding to list.`);const i={sessionId:r,name:t.title||"Untitled",lastUpdated:t.timestamp||Date.now(),isStarred:!0};Yt.push(i)}else console.log(`[LibraryController] Session ${r} was already starred. Updating data.`),Yt[n]={...Yt[n],name:t.title||Yt[n].name,lastUpdated:t.timestamp||Yt[n].lastUpdated,isStarred:!0};else n!==-1?(console.log(`[LibraryController] Session ${r} is no longer starred. Removing from list.`),Yt.splice(n,1)):console.log(`[LibraryController] Session ${r} is not starred and was not in the list.`);const o=document.getElementById("page-library");o&&!o.classList.contains("hidden")?(console.log("[LibraryController] Library page is active, re-rendering list with filter."),En=(mr==null?void 0:mr.value.trim())||"",ol(En)):console.log("[LibraryController] Library page not active, internal list updated passively.")}function ol(e=""){if(!Do||!Ur)return;console.log(`[LibraryController] Rendering with filter "${e}"`);let t=[...Yt];if(e){const r=e.toLowerCase();t=t.filter(n=>(n.name||"").toLowerCase().includes(r))}if(t.sort((r,n)=>n.lastUpdated-r.lastUpdated),Ur.innerHTML="",t.length===0){const r=e?`<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items match "${e}".</p>`:'<p class="p-4 text-center text-gray-500 dark:text-gray-400 italic">No starred items yet.</p>';Ur.innerHTML=r}else t.forEach(r=>{const n={entry:{id:r.sessionId,name:r.name,title:r.name,timestamp:r.lastUpdated,isStarred:r.isStarred,messages:[]},onLoadClick:dI,onStarClick:sI,onDeleteClick:cI,onRenameSubmit:uI,onDownloadClick:lI,onShareClick:fI,onPreviewClick:hI},o=kf(n);o&&Ur.appendChild(o)});console.log(`[LibraryController] Rendered ${t.length} items.`)}const vI=Iu(e=>{Do&&(En=e.target.value.trim(),console.log(`[LibraryController] Search input changed: "${En}"`),ol(En))},300);function yI(e,t){return console.log("[LibraryController] Initializing..."),!e||!e.listContainer||!t?(console.error("[LibraryController] Initialization failed: Missing required elements (listContainer) or request function.",{elements:e,requestFunc:t}),null):(Ur=e.listContainer,Wt=t,console.log("[LibraryController] Elements and request function assigned."),j.subscribe("navigation:pageChanged",pI),console.log("[LibraryController] Subscribed to navigation:pageChanged."),j.subscribe(ei.name,gI),console.log("[LibraryController] Subscribed to DbSessionUpdatedNotification."),Do=!0,console.log("[LibraryController] Initialization successful. Library will render when activated."),{})}let df=!1;function bI(){if(df){console.log("[DiscoverController] Already initialized.");return}return console.log("[DiscoverController] Initializing..."),df=!0,console.log("[DiscoverController] Initialized successfully."),{}}let ff=!1;const hf=e=>{if(!e)return;const t=document.documentElement.classList.contains("dark");e.textContent=t?"Switch to Light Mode":"Switch to Dark Mode"};function wI(){const e=document.getElementById("page-settings");if(!e){console.warn("[SettingsController] Could not find #page-settings container.");return}let t=e.querySelector("#theme-toggle-button");if(t)console.log("[SettingsController] Theme toggle button already exists.");else{console.log("[SettingsController] Creating theme toggle button."),t=document.createElement("button"),t.id="theme-toggle-button",t.className="p-2 border rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 mt-4",t.onclick=()=>{const n=document.documentElement,o=n.classList.contains("dark");console.log(`[SettingsToggle] Before toggle - isDark: ${o}`),o?(n.classList.remove("dark"),localStorage.setItem("theme","light"),console.log("[SettingsToggle] Removed dark class, set localStorage to light")):(n.classList.add("dark"),localStorage.setItem("theme","dark"),console.log("[SettingsToggle] Added dark class, set localStorage to dark")),hf(t)};const r=e.querySelector("p");r?r.insertAdjacentElement("afterend",t):e.appendChild(t)}hf(t)}function va(e,t){const r=document.getElementById(e),n=document.getElementById(t);r&&n?(n.textContent=r.value,r.addEventListener("input",o=>{n.textContent=o.target.value}),console.log(`[SettingsController] Setup slider ${e} with value display ${t}`)):(r||console.warn(`[SettingsController] Slider element not found: #${e}`),n||console.warn(`[SettingsController] Value span element not found: #${t}`))}function _I(){if(ff){console.log("[SettingsController] Already initialized.");return}console.log("[SettingsController] Initializing..."),wI(),va("setting-temperature","setting-temperature-value"),va("setting-repeat-penalty","setting-repeat-penalty-value"),va("setting-top-p","setting-top-p-value"),va("setting-min-p","setting-min-p-value");const e=document.getElementById("viewLogsButton");return e?(e.addEventListener("click",()=>{console.log("[SettingsController] View Logs button clicked. Opening log viewer popup...");try{chrome.windows.create({url:"sidepanel.html?view=logs",type:"popup",width:800,height:600})}catch(t){console.error("[SettingsController] Error opening log viewer popup:",t)}}),console.log("[SettingsController] Added listener to View Logs button.")):console.warn("[SettingsController] View Logs button (viewLogsButton) not found."),ff=!0,console.log("[SettingsController] Initialized successfully."),{}}let pf=!1;function SI(){if(pf){console.log("[SpacesController] Already initialized.");return}return console.log("[SpacesController] Initializing..."),pf=!0,console.log("[SpacesController] Initialized successfully."),{}}const il="application/vnd.google-apps.folder";let ir,Dn,ya,et,ba,gn,$t,Su,Vn,vn,Hr=!1,Xt="root",At=[{id:"root",name:"Root"}],wo={},Mt={},Wo=!1,gr="",jo=null,mf=null,kc=null,os=$e,Rc=null;function II(){if(console.log("Attempting to show Drive modal..."),!Hr){if(!Dn){console.error("DriveViewerModal element not found.");return}console.log("DriveController: Showing Drive Viewer modal."),Xt="root",At=[{id:"root",name:"Root"}],Mt={},wo={},gr="",$t&&($t.value=""),Is(),Ss(),console.log("Fetching root content and making modal visible."),_s("root"),Dn.classList.remove("hidden"),Hr=!0}}function wa(){Hr&&Dn&&(console.log("DriveController: Hiding Drive Viewer modal."),Dn.classList.add("hidden"),Hr=!1,et&&(et.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>'))}function CI(e){return e===il?'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>':'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>'}function al(e){if(console.log(`[DriveController:Render] renderDriveViewerItems called with ${(e==null?void 0:e.length)??0} items.`),!et)return;et.innerHTML="";const t=gr.toLowerCase(),r=gr?e.filter(n=>n.name.toLowerCase().includes(t)):e;if(!r||r.length===0){et.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 p-4">${gr?"No results found.":"Folder is empty."}</div>`;return}r.forEach(n=>{const o=n.mimeType===il,i=document.createElement("div");i.className="drive-viewer-item flex items-center p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer",i.dataset.id=n.id,i.dataset.name=n.name,i.dataset.mimeType=n.mimeType,i.dataset.iconLink=n.iconLink||"";const c=document.createElement("div");c.className="flex-shrink-0 w-6 h-6 mr-3 flex items-center justify-center",n.iconLink?c.innerHTML=`<img src="${n.iconLink}" alt="${o?"Folder":"File"}" class="w-5 h-5">`:c.innerHTML=CI(n.mimeType);const u=document.createElement("span");u.className="flex-grow truncate",u.textContent=n.name,u.title=n.name,i.appendChild(c),i.appendChild(u),Mt[n.id]&&i.classList.add("selected"),i.addEventListener("click",EI),et.appendChild(i)})}function _s(e){if(!(!et||Wo)){if(Wo=!0,console.log(`DriveController: Fetching Drive content for folder: ${e}`),DI(),LI(),et.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Loading...</div>',wo[e]){console.log(`DriveController: Using cached content for folder: ${e}`),al(wo[e]),Wo=!1;return}chrome.runtime.sendMessage({type:"getDriveFileList",folderId:e},t=>{chrome.runtime.lastError?(console.error("DriveController: Error sending getDriveFileList message:",chrome.runtime.lastError.message),os(`Error fetching folder content: ${chrome.runtime.lastError.message}`,"error"),et&&(et.innerHTML='<div class="text-center text-red-500 p-4">Error sending request.</div>'),Wo=!1):console.log(`DriveController: Sent getDriveFileList request for ${e}. Waiting for response...`)})}}function EI(e){e.stopPropagation();const t=e.currentTarget,r=t.dataset.id,n=t.dataset.name,o=t.dataset.mimeType,i=t.dataset.iconLink;if(!r||!o){console.error("DriveController: Clicked Drive item missing ID or mimeType.");return}o===il?(console.log(`DriveController: Navigating into folder: ${n} (${r})`),Xt=r,At.push({id:r,name:n}),gr="",$t&&($t.value=""),_s(r)):(console.log(`DriveController: Toggling selection for file: ${n} (${r})`),kI(r,t,{id:r,name:n,mimeType:o,iconLink:i}))}function DI(){Vn&&(Vn.innerHTML="",At.forEach((e,t)=>{const r=document.createElement(t===At.length-1?"span":"button");if(r.textContent=e.name,r.dataset.id=e.id,r.dataset.index=t,t<At.length-1){r.className="text-blue-600 hover:underline dark:text-blue-400 cursor-pointer",r.addEventListener("click",xI);const n=document.createElement("span");n.textContent=" / ",n.className="mx-1 text-gray-400",Vn.appendChild(r),Vn.appendChild(n)}else r.className="font-semibold",Vn.appendChild(r)}))}function xI(e){const t=parseInt(e.currentTarget.dataset.index,10),r=e.currentTarget.dataset.id;if(isNaN(t)||!r){console.error("DriveController: Invalid breadcrumb data.");return}r!==Xt&&(console.log(`DriveController: Breadcrumb click - Navigating to index ${t} (${r})`),At=At.slice(0,t+1),Xt=r,gr="",$t&&($t.value=""),_s(r))}function kI(e,t,r){Mt[e]?(delete Mt[e],t==null||t.classList.remove("selected")):(Mt[e]=r,t==null||t.classList.add("selected")),Ss(),Is()}function Ss(){if(!Su)return;const e=Object.keys(Mt),t=Su;if(!t){console.error("Selected area container not found");return}const r=t.querySelector(".flex-wrap")||t;r.innerHTML="",e.length===0?t.classList.add("hidden"):(t.classList.remove("hidden"),e.forEach(n=>{const o=Mt[n],i=document.createElement("span");i.className="selected-file-item";const c=o.iconLink?`<img src="${o.iconLink}" alt="" class="w-3 h-3 mr-1.5">`:"",u=`<button class="selected-file-remove" data-id="${n}">&times;</button>`;i.innerHTML=`${c}${o.name} ${u}`,r.appendChild(i);const d=i.querySelector(".selected-file-remove");d==null||d.addEventListener("click",RI)}))}function RI(e){const t=e.currentTarget.dataset.id;if(t&&Mt[t]){delete Mt[t],Ss(),Is();const r=et==null?void 0:et.querySelector(`.drive-viewer-item[data-id="${t}"]`);r==null||r.classList.remove("selected")}}function Is(){if(!gn)return;const e=Object.keys(Mt).length;gn.disabled=e===0,gn.textContent=`Insert (${e})`}let Oc=null;function gf(e){gr=e.target.value.trim(),console.log(`DriveController: Filtering Drive items by term: "${gr}"`),wo[Xt]?al(wo[Xt]):et.innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 p-4">Folder not loaded or empty.</div>'}function OI(){if(At.length<=1)return;const e=At[At.length-2];At.pop(),Xt=e.id,console.log(`DriveController: Back button click - Navigating to ${e.name} (${e.id})`),gr="",$t&&($t.value=""),_s(e.id)}function LI(){vn&&(At.length>1?vn.classList.remove("hidden"):vn.classList.add("hidden"))}function PI(e,t,r){if(console.log(`[DriveController:MsgListener] Received message type: ${e==null?void 0:e.type}`,e),e.type==="driveFileListResponse"){if(console.log(`DriveController: Handling driveFileListResponse for folder: ${e.folderId}`),Wo=!1,console.log(`[DriveController:MsgListener] Check: isDriveOpen=${Hr}, message.folderId=${e.folderId}, currentFolderId=${Xt}`),!Hr||e.folderId!==Xt)return console.warn(`DriveController: Ignoring driveFileListResponse for folder ${e.folderId}. Current: ${Xt}, IsOpen: ${Hr}`),!1;if(e.success&&e.files)console.log(`[DriveController:MsgListener] Success! Caching and calling renderDriveViewerItems for ${e.files.length} files.`),wo[e.folderId]=e.files,al(e.files),console.log("[DriveController:MsgListener] renderDriveViewerItems completed.");else{const n=e.error||"Unknown error fetching files.";console.error(`DriveController: Drive file list error for ${e.folderId}: ${n}`),os(`Error fetching folder content: ${n}`,"error"),et&&(et.innerHTML=`<div class="text-center text-red-500 p-4">Error loading content: ${n}</div>`)}return!1}return!1}function $I(e){console.log("Initializing DriveController..."),jo=e.requestDbAndWaitFunc,mf=e.getActiveChatSessionId,kc=e.setActiveChatSessionId,e.showNotification&&(os=e.showNotification),Rc=e.debounce;const t=e.eventBus;if(!t){console.error("DriveController requires eventBus dependency!");return}Rc?Oc=Rc(gf,300):(console.error("DriveController requires a debounce function dependency."),Oc=gf),ir=document.getElementById("drive-button"),Dn=document.getElementById("drive-viewer-modal"),ya=document.getElementById("drive-viewer-close"),et=document.getElementById("drive-viewer-list"),ba=document.getElementById("drive-viewer-cancel"),gn=document.getElementById("drive-viewer-insert"),$t=document.getElementById("drive-viewer-search"),Su=document.getElementById("drive-viewer-selected-area"),Vn=document.getElementById("drive-viewer-breadcrumbs"),vn=document.getElementById("drive-viewer-back");const r=n=>{console.log("Drive button clicked!"),n.stopPropagation(),II()};ir==null||ir.removeEventListener("click",r),ir==null||ir.addEventListener("click",r),ya==null||ya.addEventListener("click",wa),ba==null||ba.addEventListener("click",wa),gn==null||gn.addEventListener("click",async()=>{const n=Object.values(Mt);if(n.length===0)return;let o=mf(),i=!1;console.log(`DriveController: Inserting ${n.length} Drive files. Current session: ${o}`);const u=`ðŸ“Ž Attached Drive files: ${n.map(p=>p.name).join(", ")}`,d={type:"drive_attachments",files:n.map(p=>({id:p.id,name:p.name,mimeType:p.mimeType,iconLink:p.iconLink}))};try{if(o){const p={sender:"system",text:u,timestamp:Date.now(),isLoading:!1,metadata:d};if(!jo)throw new Error("requestDbAndWaitFunc function not provided.");const m=new lo(o,p);await jo(m)}else{i=!0;const p={sender:"system",text:u,timestamp:Date.now(),isLoading:!1,metadata:d};if(!jo)throw new Error("requestDbAndWaitFunc function not provided.");const m=new ti(p),v=await jo(m);if(console.log("[DriveController] Received createSessionResponse:",JSON.stringify(v)),o=v==null?void 0:v.newSessionId,console.log("[DriveController] Extracted currentSessionId:",o),!o)throw new Error("Failed to create session or get sessionId from response.");kc?kc(o):console.warn("setActiveChatSessionIdDep not provided to DriveController."),console.log(`DriveController: New session ${o} created.`)}Mt={},Ss(),Is(),wa()}catch(p){console.error("DriveController: Error adding Drive attachment message:",p),os(`Failed to add Drive attachment: ${p.message}`,"error")}}),$t==null||$t.addEventListener("input",Oc),vn==null||vn.addEventListener("click",OI),document.addEventListener("click",n=>{Hr&&Dn&&!Dn.contains(n.target)&&ir&&!ir.contains(n.target)&&wa()}),t.subscribe("drive:fileListReceived",PI),console.log("DriveController Initialization Complete.")}let AI=null,is=null,_a=!1,Sa=null,Ar=null,Ia=null,tm=!1;const Lc=new Map;function Yn(e,t=5e3){return new Promise((r,n)=>{const{requestId:o,type:i}=e,c=e.constructor.responseEventName;if(!c){const p=`[requestDbAndWait] Cannot determine response event type for request: ${i}`;console.error(p),n(new Error(p));return}const u=p=>{console.log(`[requestDbAndWait] Received event for ${c}, ReqID ${p==null?void 0:p.requestId}, Waiting for ${o}`),console.log("[requestDbAndWait] RAW Received Event Object:",p),p&&p.requestId===o&&(console.log(`[requestDbAndWait] MATCH FOUND for ReqID ${o}. Event Payload:`,p),clearTimeout(d),j.unsubscribe(c,u),Lc.delete(o),p.error===null||typeof p.error>"u"?(console.log(`[requestDbAndWait] Success assumed (no error property) for ReqID ${o}. Resolving promise.`),r(p.data||p.payload)):(console.error(`[requestDbAndWait] Error property found for ReqID ${o}. responseEvent.error was: ${p.error}. Rejecting promise.`),n(new Error(p.error||`DB operation ${i} failed`))))},d=setTimeout(()=>{console.error(`[Sidepanel] DB request timed out for ${i} (Req ID: ${o})`),j.unsubscribe(c,u),Lc.delete(o),n(new Error(`DB request timed out for ${i}`))},t);Lc.set(o,{handler:u,timeoutId:d}),j.subscribe(c,u),j.publish(e.type,e)})}function Pa(){return is}async function zr(e){console.log(`[Sidepanel] Setting active session ID to: ${e}`),is=e,e?await chrome.storage.local.set({lastSessionId:e}):await chrome.storage.local.remove("lastSessionId"),jm(e),Df(e)}document.addEventListener("DOMContentLoaded",async()=>{var o,i,c;console.log("[Sidepanel] DOM Content Loaded.");const e=new URLSearchParams(window.location.search);if(e.get("view")==="logs"){console.log("[Sidepanel] Initializing in Log Viewer Mode."),document.body.classList.add("log-viewer-mode"),(o=document.getElementById("header"))==null||o.classList.add("hidden"),(i=document.getElementById("bottom-nav"))==null||i.classList.add("hidden"),document.querySelectorAll("#main-content > .page-container:not(#page-log-viewer)").forEach(d=>d.classList.add("hidden"));const u=document.getElementById("page-log-viewer");if(u)u.classList.remove("hidden");else{console.error("CRITICAL: #page-log-viewer element not found!"),document.body.innerHTML="<p style='color:red; padding: 1em;'>Error: Log viewer UI component failed to load.</p>";return}try{await(await yf(()=>import("./assets/LogViewerController-BZ1bQVHQ.js"),[])).initializeLogViewerController(),console.log("[Sidepanel] Log Viewer Controller initialized.")}catch(d){console.error("Failed to load or initialize LogViewerController:",d),u&&(u.innerHTML=`<div style='color:red; padding: 1em;'>Error initializing log viewer: ${d.message}</div>`)}return}console.log("[Sidepanel] Initializing in Standard Mode."),(c=document.getElementById("page-log-viewer"))==null||c.classList.add("hidden");let r=!1;const n=new Promise((u,d)=>{const m=setTimeout(()=>{r||(console.error("[Sidepanel] DB Initialization timed out!"),d(new Error("Database initialization timed out.")))},1e4),v=b=>{var _;if(r=!0,clearTimeout(m),j.unsubscribe(Qn.name,v),b&&b.payload&&b.payload.success)console.log("[Sidepanel] Received DB Initialization Complete notification (Success)."),u(!0);else{const I=((_=b==null?void 0:b.payload)==null?void 0:_.error)||"Unknown DB initialization error";console.error(`[Sidepanel] Received DB Initialization Complete notification (Failure): ${I}`),d(new Error(`Database initialization failed: ${I}`))}};j.subscribe(Qn.name,v),console.log("[Sidepanel] Subscribed to DbInitializationCompleteNotification. Publishing DbInitializeRequest..."),j.publish(Hc.name,new Hc)});try{const{chatBody:u,newChatButton:d,chatInputElement:p,sendButton:m,fileInput:v}=Ef({onNewChat:NI,onSessionClick:qI,onAttachFile:lg});console.log("[Sidepanel] UI Controller Initialized.");const b=document.getElementById("chat-body");b||console.error("[Sidepanel] CRITICAL: chatBodyForRenderer is null right before calling initializeRenderer!"),Um(b,Yn),console.log("[Sidepanel] Chat Renderer Initialized."),Bm(),console.log("[Sidepanel] Navigation Initialized."),j.subscribe("navigation:pageChanged",FI),cg({uiController:tg,getActiveSessionIdFunc:Pa}),console.log("[Sidepanel] File Handler Initialized.");const _=document.getElementById("file-input");_?_.addEventListener("change",ug):console.warn("[Sidepanel] File input element (re-fetched) not found before adding listener.");const I=await Wc();Ar=I==null?void 0:I.id,AI=I,console.log(`[Sidepanel] Current Tab ID: ${Ar}`),rg({getActiveSessionIdFunc:Pa,onSessionCreatedCallback:TI,getCurrentTabIdFunc:()=>Ar}),console.log("[Sidepanel] Message Orchestrator Initialized."),chrome.runtime.onMessage.addListener(MI),console.log("[Sidepanel] Background message listener added.");const k=document.getElementById("history-popup"),A=document.getElementById("history-list"),q=document.getElementById("history-search"),U=document.getElementById("close-history"),G=document.getElementById("history-button"),ae=document.getElementById("detach-button");k&&A&&q&&U?(Ia=xg({popupContainer:k,listContainer:A,searchInput:q,closeButton:U},Yn),Ia||console.error("[Sidepanel] History Popup Controller initialization failed.")):console.warn("[Sidepanel] Could not find all required elements for History Popup Controller."),G&&Ia?G.addEventListener("click",()=>{Ia.show()}):console.warn("[Sidepanel] History button or controller not available for listener."),ae?ae.addEventListener("click",BI):console.warn("[Sidepanel] Detach button not found.");const oe=document.getElementById("starred-list");oe?(yI({listContainer:oe},Yn),console.log("[Sidepanel] Library Controller Initialized.")):console.warn("[Sidepanel] Could not find #starred-list element for Library Controller."),j.subscribe("ui:requestModelLoad",Z=>{const ce=Z==null?void 0:Z.modelId;if(!ce){console.error("[Sidepanel] Received 'ui:requestModelLoad' but missing modelId."),j.publish("worker:error","No model ID specified for loading.");return}console.log(`[Sidepanel] Received 'ui:requestModelLoad' for ${ce}. Sending 'loadModel' to background.`),chrome.runtime.sendMessage({type:"loadModel",payload:{modelId:ce}}).catch(he=>{console.error(`[Sidepanel] Error sending 'loadModel' message for ${ce}:`,he),j.publish("worker:error",`Failed to send load request: ${he.message}`)})}),bI(),console.log("[Sidepanel] Discover Controller Initialized call attempted."),_I(),console.log("[Sidepanel] Settings Controller Initialized call attempted."),SI(),console.log("[Sidepanel] Spaces Controller Initialized call attempted."),$I({requestDbAndWaitFunc:Yn,getActiveChatSessionId:Pa,setActiveChatSessionId:zr,showNotification:$e,debounce:Iu}),console.log("[Sidepanel] Drive Controller Initialized."),console.log("[Sidepanel] Waiting for DB initialization to complete..."),tm=await n,console.log("[Sidepanel] DB initialization confirmed complete.");const te=e.get("context");if(Sa=te==="popup"?e.get("originalTabId"):null,_a=te==="popup",console.log(`[Sidepanel] Context: ${_a?"Popup":"Sidepanel"}${_a?", Original Tab: "+Sa:""}`),_a&&Sa){const Z=`detachedSessionId_${Sa}`,he=(await chrome.storage.local.get(Z))[Z];he?(console.log(`[Sidepanel-Popup] Found detached session ID: ${he}. Loading...`),await io(he)):(console.log(`[Sidepanel-Popup] No detached session ID found for key ${Z}. Starting fresh.`),await zr(null))}else{const{lastSessionId:Z}=await chrome.storage.local.get(["lastSessionId"]);Z?(console.log(`[Sidepanel] Loading last active session: ${Z}`),await io(Z)):(console.log("[Sidepanel] No last session ID found, starting fresh."),await zr(null))}console.log("[Sidepanel] Initialization complete (after DB ready).")}catch(u){console.error("[Sidepanel] Initialization failed:",u),ut(`Initialization failed: ${u.message}. Please try reloading.`);const d=document.getElementById("chat-body");d&&(d.innerHTML=`<div class="p-4 text-red-500">Critical Error: ${u.message}. Please reload the extension.</div>`)}});function MI(e,t,r){if(console.log("[Sidepanel] Received message from background:",e),e.type==="response"){const n={chatId:e.chatId,messageId:e.messageId,text:e.text};j.publish("background:responseReceived",n)}else if(e.type==="error"){const n={chatId:e.chatId,messageId:e.messageId,error:e.error};j.publish("background:errorReceived",n)}else e.type==="STAGE_SCRAPE_RESULT"?j.publish("background:scrapeStageResult",e.payload):e.type==="DIRECT_SCRAPE_RESULT"?j.publish("background:scrapeResultReceived",e.payload):e.type==="uiLoadingStatusUpdate"?(console.log("[Sidepanel] Forwarding uiLoadingStatusUpdate to eventBus."),j.publish("ui:loadingStatusUpdate",e.payload)):console.warn("[Sidepanel] Received unknown message type from background:",e.type,e)}async function TI(e){console.log(`[Sidepanel] Orchestrator reported new session created: ${e}`),await zr(e),console.log(`[Sidepanel] Explicitly fetching messages for new session ${e}`);try{const t=new Wr(e),r=await Yn(t);r&&r.messages?(j.publish(ct.name,new ct(e,r.messages)),console.log(`[Sidepanel] Manually triggered message render for new session ${e}`)):console.warn(`[Sidepanel] No messages found in session data for new session ${e}. Response data:`,r)}catch(t){console.error(`[Sidepanel] Failed to fetch messages for new session ${e}:`,t),ut(`Failed to load initial messages for new chat: ${t.message}`)}}async function NI(){console.log("[Sidepanel] New Chat button clicked."),await zr(null),cs(),xf()}async function qI(e){const t=e.currentTarget.dataset.sessionId;t&&t!==is?(console.log(`[Sidepanel] Session list item clicked: ${t}`),await io(t)):t===is?(console.log(`[Sidepanel] Clicked already active session: ${t}`),ss()):console.warn("[Sidepanel] Session list click event missing sessionId:",e.currentTarget)}async function io(e){if(!e){console.log("[Sidepanel] No session ID to load, setting renderer to null."),await zr(null);return}console.log(`[Sidepanel] Loading session data for: ${e}`);let t=null;try{const r=new Wr(e);t=await Yn(r),console.log(`[Sidepanel] Session data successfully loaded for ${e}.`),await zr(e),t&&t.messages?(console.log(`[Sidepanel] Manually triggering message render for loaded session ${e}.`),j.publish(ct.name,new ct(e,t.messages))):(console.warn(`[Sidepanel] No messages found in loaded session data for ${e}. Displaying empty chat.`),j.publish(ct.name,new ct(e,{messages:[]})))}catch(r){console.error(`[Sidepanel] Failed to load session ${e}:`,r),ut(`Failed to load chat: ${r.message}`),await zr(null)}}async function BI(){if(!Ar){console.error("Cannot detach: Missing tab ID"),ut("Cannot detach: Missing tab ID");return}const e=Pa();try{const t=await chrome.runtime.sendMessage({type:"getPopupForTab",tabId:Ar});if(t&&t.popupId){await chrome.windows.update(t.popupId,{focused:!0});return}const r=`detachedSessionId_${Ar}`;await chrome.storage.local.set({[r]:e}),console.log(`Sidepanel: Saved session ID ${e} for detach key ${r}.`);const n=await chrome.windows.create({url:chrome.runtime.getURL(`sidepanel.html?context=popup&originalTabId=${Ar}`),type:"popup",width:400,height:600});if(n!=null&&n.id)await chrome.runtime.sendMessage({type:"popupCreated",tabId:Ar,popupId:n.id});else throw new Error("Failed to create popup window.")}catch(t){console.error("Error during detach:",t),ut(`Error detaching chat: ${t.message}`)}}async function FI(e){if(!(!e||!e.pageId)){if(console.log(`[Sidepanel] Navigation changed to: ${e.pageId}`),!tm){console.log("[Sidepanel] DB not ready yet, skipping session load on initial navigation event.");return}if(e.pageId==="page-home"){console.log("[Sidepanel] Navigated to home page, checking for specific session load signal...");try{const{lastSessionId:t}=await chrome.storage.local.get(["lastSessionId"]);t?(console.log(`[Sidepanel] Found load signal: ${t}. Loading session and clearing signal.`),await io(t),await chrome.storage.local.remove("lastSessionId")):(console.log("[Sidepanel] No load signal found. Resetting to welcome state."),await io(null))}catch(t){console.error("[Sidepanel] Error checking/loading session based on signal:",t),ut("Failed to load session state."),await io(null)}}}}
//# sourceMappingURL=sidepanel.js.map
